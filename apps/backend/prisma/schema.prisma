generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Organization represents a tenant in the multi-tenant system.
/// All business data is scoped to an organization via Row-Level Security.
model Organization {
  id                         String                           @id @default(uuid())
  name                       String
  slug                       String                           @unique
  settings                   Json                             @default("{}")
  defaultLanguage            String                           @default("en") @map("default_language")
  isActive                   Boolean                          @default(true) @map("is_active")
  createdAt                  DateTime                         @default(now()) @map("created_at")
  updatedAt                  DateTime                         @updatedAt @map("updated_at")
  AiMessage                  AiMessage[]
  attachments                Attachment[]
  auditLogs                  AuditLog[]
  businessUnits              BusinessUnit[]
  campaignAssignments        CampaignAssignment[]
  campaignWaves              CampaignWave[]
  campaigns                  Campaign[]
  caseCaseAssociations       CaseCaseAssociation[]
  caseMessages               CaseMessage[]
  cases                      Case[]
  categories                 Category[]
  categoryTemplateMappings   CategoryTemplateMapping[]
  clientDirectives           ClientDirective[]
  clientQaConfig             ClientQaConfig?
  conflictAlerts             ConflictAlert[]
  conflictExclusions         ConflictExclusion[]
  customPropertyDefinitions  CustomPropertyDefinition[]
  dashboardWidgets           DashboardWidget[]
  dashboards                 Dashboard[]
  demoAccounts               DemoAccount[]
  DemoArchivedChange         DemoArchivedChange[]
  demoUserSessions           DemoUserSession[]
  departments                Department[]
  digestQueue                DigestQueue[]
  disclosureDrafts           DisclosureDraft[]
  disclosureFormTemplates    DisclosureFormTemplate[]
  divisions                  Division[]
  emailTemplates             EmailTemplate[]
  employeeComplianceProfiles EmployeeComplianceProfile[]
  employees                  Employee[]
  exportJobs                 ExportJob[]
  featureAdoptions           FeatureAdoption[]
  formDefinitions            FormDefinition[]
  formSubmissions            FormSubmission[]
  GoLiveGate                 GoLiveGate[]
  GoLiveSignoff              GoLiveSignoff[]
  hotlineNumbers             HotlineNumber[]
  ImpersonationAuditLog      ImpersonationAuditLog[]
  impersonationSessions      ImpersonationSession[]
  implementationProjects     ImplementationProject[]
  interactions               Interaction[]
  interviewTemplates         InterviewTemplate[]
  checklistProgress          InvestigationChecklistProgress[]
  investigationInterviews    InvestigationInterview[]
  investigationTemplates     InvestigationTemplate[]
  investigations             Investigation[]
  locations                  Location[]
  migrationFieldTemplates    MigrationFieldTemplate[]
  migrationJobs              MigrationJob[]
  MigrationRecord            MigrationRecord[]
  milestoneItems             MilestoneItem[]
  milestones                 Milestone[]
  NotificationDelivery       NotificationDelivery[]
  notificationPreferences    NotificationPreference[]
  notifications              Notification[]
  orgBlackoutDates           OrgBlackoutDate[]
  orgNotificationSettings    OrgNotificationSettings?
  personCaseAssociations     PersonCaseAssociation[]
  personPersonAssociations   PersonPersonAssociation[]
  personRiuAssociations      PersonRiuAssociation[]
  persons                    Person[]
  policies                   Policy[]
  policyCaseAssociations     PolicyCaseAssociation[]
  policyVersionTranslations  PolicyVersionTranslation[]
  policyVersions             PolicyVersion[]
  QuizAttempt                QuizAttempt[]
  ReadinessItem              ReadinessItem[]
  remediationPlans           RemediationPlan[]
  remediationTemplates       RemediationTemplate[]
  reportExecutions           ReportExecution[]
  reportFieldTags            ReportFieldTag[]
  reportTemplates            ReportTemplate[]
  rius                       RiskIntelligenceUnit[]
  RiuCaseAssociation         RiuCaseAssociation[]
  savedViews                 SavedView[]
  ScheduledExportRun         ScheduledExportRun[]
  scheduledExports           ScheduledExport[]
  segments                   Segment[]
  sessions                   Session[]
  subjects                   Subject[]
  teams                      Team[]
  tenantBranding             TenantBranding?
  tenantDomains              TenantDomain[]
  healthScores               TenantHealthScore[]
  tenantSsoConfig            TenantSsoConfig?
  thresholdRules             ThresholdRule[]
  usageMetrics               UsageMetric[]
  userDashboardConfigs       UserDashboardConfig[]
  userDataTables             UserDataTable[]
  users                      User[]
  workflowInstances          WorkflowInstance[]
  workflowTemplates          WorkflowTemplate[]

  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

/// User represents an authenticated user within an organization.
/// Users are scoped to a single organization (no cross-tenant access).
model User {
  id                                String                     @id @default(uuid())
  organizationId                    String                     @map("organization_id")
  email                             String
  passwordHash                      String?                    @map("password_hash")
  firstName                         String                     @map("first_name")
  lastName                          String                     @map("last_name")
  role                              UserRole                   @default(EMPLOYEE)
  isActive                          Boolean                    @default(true) @map("is_active")
  emailVerifiedAt                   DateTime?                  @map("email_verified_at")
  lastLoginAt                       DateTime?                  @map("last_login_at")
  ssoProvider                       String?                    @map("sso_provider")
  ssoId                             String?                    @map("sso_id")
  mfaEnabled                        Boolean                    @default(false) @map("mfa_enabled")
  mfaSecret                         String?                    @map("mfa_secret")
  mfaVerifiedAt                     DateTime?                  @map("mfa_verified_at")
  mfaRecoveryCodes                  String[]                   @default([]) @map("mfa_recovery_codes")
  createdAt                         DateTime                   @default(now()) @map("created_at")
  updatedAt                         DateTime                   @updatedAt @map("updated_at")
  attachmentsUploaded               Attachment[]               @relation("AttachmentUploadedBy")
  auditLogsActed                    AuditLog[]
  caseMessagesCreated               CaseMessage[]              @relation("CaseMessageCreatedBy")
  caseMessagesRead                  CaseMessage[]              @relation("CaseMessageReadBy")
  casesClassificationChangedBy      Case[]                     @relation("CaseClassificationChangedBy")
  casesCreated                      Case[]                     @relation("CaseCreatedBy")
  casesIntakeOperator               Case[]                     @relation("CaseIntakeOperator")
  casesMergedBy                     Case[]                     @relation("CaseMergedBy")
  casesOutcomeBy                    Case[]                     @relation("CaseOutcomeBy")
  casesPipelineStageBy              Case[]                     @relation("CasePipelineStageBy")
  casesProxySubmitter               Case[]                     @relation("CaseProxySubmitter")
  casesReleased                     Case[]                     @relation("CaseReleasedBy")
  casesUpdated                      Case[]                     @relation("CaseUpdatedBy")
  conflictAlertsDismissed           ConflictAlert[]            @relation("ConflictAlertDismissedBy")
  conflictExclusionsCreated         ConflictExclusion[]        @relation("ExclusionCreatedBy")
  dashboardsCreated                 Dashboard[]                @relation("DashboardCreatedBy")
  prospectDemoAccounts              DemoAccount?               @relation("ProspectUser")
  salesRepDemoAccounts              DemoAccount[]              @relation("SalesRepUser")
  demoUserSessions                  DemoUserSession[]
  digestQueue                       DigestQueue[]              @relation("DigestQueueUser")
  disclosureFormTemplatesCreated    DisclosureFormTemplate[]   @relation("FormTemplateCreator")
  exportJobsCreated                 ExportJob[]
  interactionsConducted             Interaction[]              @relation("InteractionConductedBy")
  interactionsQaReviewed            Interaction[]              @relation("InteractionQaReviewedBy")
  investigationNotesAuthored        InvestigationNote[]        @relation("InvestigationNoteAuthor")
  investigationsAssignedBy          Investigation[]            @relation("InvestigationAssignedBy")
  investigationsClosedBy            Investigation[]            @relation("InvestigationClosedBy")
  investigationsClosureApprovedBy   Investigation[]            @relation("InvestigationClosureApprovedBy")
  investigationsCreatedBy           Investigation[]            @relation("InvestigationCreatedBy")
  investigationsPrimaryInvestigator Investigation[]            @relation("InvestigationPrimaryInvestigator")
  investigationsUpdatedBy           Investigation[]            @relation("InvestigationUpdatedBy")
  migrationJobsCreated              MigrationJob[]             @relation("MigrationJobCreatedBy")
  milestonesCreated                 Milestone[]                @relation("MilestoneCreatedBy")
  milestonesOwned                   Milestone[]                @relation("MilestoneOwner")
  backupForPreferences              NotificationPreference[]   @relation("BackupUser")
  notificationPreference            NotificationPreference?
  notifications                     Notification[]
  policiesCreated                   Policy[]                   @relation("PolicyCreatedBy")
  policiesDraftUpdated              Policy[]                   @relation("PolicyDraftUpdatedBy")
  policiesOwned                     Policy[]                   @relation("PolicyOwner")
  policyCaseAssociationsCreated     PolicyCaseAssociation[]    @relation("PolicyCaseAssociationCreatedBy")
  policyTranslationsReviewed        PolicyVersionTranslation[] @relation("PolicyTranslationReviewer")
  policyVersionsPublished           PolicyVersion[]            @relation("PolicyVersionPublishedBy")
  riusCreated                       RiskIntelligenceUnit[]     @relation("RiuCreatedBy")
  riuCaseAssociationsCreated        RiuCaseAssociation[]       @relation("RiuCaseAssociationCreatedBy")
  scheduledExportsCreated           ScheduledExport[]
  sessions                          Session[]
  subjectsCreated                   Subject[]                  @relation("SubjectCreatedBy")
  thresholdRulesCreated             ThresholdRule[]
  userDashboardConfigs              UserDashboardConfig[]
  userDataTablesCreated             UserDataTable[]            @relation("UserDataTableCreatedBy")
  organization                      Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, role])
  @@index([organizationId, isActive])
  @@index([ssoProvider, ssoId])
  @@map("users")
}

/// Session represents an active user session (for refresh token rotation).
/// Sessions are scoped to organization for RLS compliance.
model Session {
  id                String       @id @default(uuid())
  organizationId    String       @map("organization_id")
  userId            String       @map("user_id")
  userAgent         String?      @map("user_agent")
  ipAddress         String?      @map("ip_address")
  expiresAt         DateTime     @map("expires_at")
  revokedAt         DateTime?    @map("revoked_at")
  previousSessionId String?      @map("previous_session_id")
  createdAt         DateTime     @default(now()) @map("created_at")
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("sessions")
}

/// TenantDomain maps email domains to organizations for SSO tenant routing.
/// Domains must be verified via DNS TXT record before SSO can be enabled.
/// Each organization can have multiple domains, with one marked as primary.
model TenantDomain {
  id                 String       @id @default(uuid())
  organizationId     String       @map("organization_id")
  domain             String       @unique
  verified           Boolean      @default(false)
  verifiedAt         DateTime?    @map("verified_at")
  verificationToken  String       @map("verification_token")
  verificationMethod String       @default("DNS_TXT") @map("verification_method")
  isPrimary          Boolean      @default(false) @map("is_primary")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([domain])
  @@map("tenant_domains")
}

/// TenantSsoConfig stores per-tenant SSO provider configuration.
/// One config per organization (unique constraint on organizationId).
/// Supports Azure AD, Google, and generic SAML providers.
model TenantSsoConfig {
  id                     String       @id @default(uuid())
  organizationId         String       @unique @map("organization_id")
  ssoProvider            String?      @map("sso_provider")
  ssoEnabled             Boolean      @default(false) @map("sso_enabled")
  jitProvisioningEnabled Boolean      @default(true) @map("jit_provisioning_enabled")
  defaultRole            UserRole     @default(EMPLOYEE) @map("default_role")
  azureTenantId          String?      @map("azure_tenant_id")
  samlIdpEntityId        String?      @map("saml_idp_entity_id")
  samlIdpEntryPoint      String?      @map("saml_idp_entry_point")
  samlIdpCertificate     String?      @map("saml_idp_certificate")
  samlSpEntityId         String?      @map("saml_sp_entity_id")
  mfaRequired            Boolean      @default(false) @map("mfa_required")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("tenant_sso_configs")
}

/// Case represents a compliance report or request for information.
/// This is the primary container for all case-related data.
model Case {
  id                        String                   @id @default(uuid())
  referenceNumber           String                   @unique @map("reference_number")
  organizationId            String                   @map("organization_id")
  status                    CaseStatus               @default(NEW)
  statusRationale           String?                  @map("status_rationale")
  pipelineId                String?                  @map("pipeline_id")
  pipelineStage             String?                  @map("pipeline_stage")
  pipelineStageAt           DateTime?                @map("pipeline_stage_at")
  pipelineStageById         String?                  @map("pipeline_stage_by_id")
  classificationNotes       String?                  @map("classification_notes")
  classificationChangedAt   DateTime?                @map("classification_changed_at")
  classificationChangedById String?                  @map("classification_changed_by_id")
  outcome                   CaseOutcome?
  outcomeNotes              String?                  @map("outcome_notes")
  outcomeAt                 DateTime?                @map("outcome_at")
  outcomeById               String?                  @map("outcome_by_id")
  mergedIntoCaseId          String?                  @map("merged_into_case_id")
  mergedAt                  DateTime?                @map("merged_at")
  mergedById                String?                  @map("merged_by_id")
  mergedReason              String?                  @map("merged_reason")
  isMerged                  Boolean                  @default(false) @map("is_merged")
  sourceChannel             SourceChannel            @map("source_channel")
  caseType                  CaseType                 @default(REPORT) @map("case_type")
  intakeTimestamp           DateTime                 @default(now()) @map("intake_timestamp")
  intakeOperatorId          String?                  @map("intake_operator_id")
  firstTimeCaller           Boolean?                 @map("first_time_caller")
  awarenessSource           String?                  @map("awareness_source")
  interpreterUsed           Boolean?                 @map("interpreter_used")
  reporterType              ReporterType             @default(ANONYMOUS) @map("reporter_type")
  reporterAnonymous         Boolean                  @default(true) @map("reporter_anonymous")
  reporterName              String?                  @map("reporter_name")
  reporterEmail             String?                  @map("reporter_email")
  reporterPhone             String?                  @map("reporter_phone")
  reporterRelationship      ReporterRelationship?    @map("reporter_relationship")
  anonymousAccessCode       String?                  @map("anonymous_access_code")
  proxySubmitterId          String?                  @map("proxy_submitter_id")
  locationName              String?                  @map("location_name")
  locationAddress           String?                  @map("location_address")
  locationCity              String?                  @map("location_city")
  locationState             String?                  @map("location_state")
  locationZip               String?                  @map("location_zip")
  locationCountry           String?                  @map("location_country")
  locationManual            Boolean?                 @map("location_manual")
  details                   String
  summary                   String?
  addendum                  String?
  originalLanguage          String?                  @map("original_language")
  translatedDetails         String?                  @map("translated_details")
  translationLanguage       String?                  @map("translation_language")
  primaryCategoryId         String?                  @map("primary_category_id")
  secondaryCategoryId       String?                  @map("secondary_category_id")
  severity                  Severity                 @default(MEDIUM)
  severityReason            String?                  @map("severity_reason")
  tags                      String[]                 @default([])
  aiSummary                 String?                  @map("ai_summary")
  aiSummaryGeneratedAt      DateTime?                @map("ai_summary_generated_at")
  aiModelVersion            String?                  @map("ai_model_version")
  aiCategorySuggestion      String?                  @map("ai_category_suggestion")
  aiSeveritySuggestion      Severity?                @map("ai_severity_suggestion")
  aiConfidenceScore         Int?                     @map("ai_confidence_score")
  customFields              Json?                    @map("custom_fields")
  customQuestions           Json?                    @map("custom_questions")
  sourceSystem              String?                  @map("source_system")
  sourceRecordId            String?                  @map("source_record_id")
  migratedAt                DateTime?                @map("migrated_at")
  parentCaseId              String?                  @map("parent_case_id")
  isSplit                   Boolean                  @default(false) @map("is_split")
  releasedAt                DateTime?                @map("released_at")
  releasedById              String?                  @map("released_by_id")
  qaNotes                   String?                  @map("qa_notes")
  demoUserSessionId         String?                  @map("demo_user_session_id")
  isBaseData                Boolean                  @default(false) @map("is_base_data")
  createdAt                 DateTime                 @default(now()) @map("created_at")
  updatedAt                 DateTime                 @updatedAt @map("updated_at")
  createdById               String                   @map("created_by_id")
  updatedById               String                   @map("updated_by_id")
  /// @db.Unsupported("tsvector")
  searchVector              Unsupported("tsvector")? @map("search_vector")
  caseAssociationsFrom      CaseCaseAssociation[]    @relation("CaseAssociationSource")
  caseAssociationsTo        CaseCaseAssociation[]    @relation("CaseAssociationTarget")
  messages                  CaseMessage[]
  classificationChangedBy   User?                    @relation("CaseClassificationChangedBy", fields: [classificationChangedById], references: [id])
  createdBy                 User                     @relation("CaseCreatedBy", fields: [createdById], references: [id])
  demoUserSession           DemoUserSession?         @relation("DemoSessionCases", fields: [demoUserSessionId], references: [id])
  intakeOperator            User?                    @relation("CaseIntakeOperator", fields: [intakeOperatorId], references: [id])
  mergedBy                  User?                    @relation("CaseMergedBy", fields: [mergedById], references: [id])
  mergedIntoCase            Case?                    @relation("CaseMerge", fields: [mergedIntoCaseId], references: [id])
  mergedCases               Case[]                   @relation("CaseMerge")
  organization              Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  outcomeBy                 User?                    @relation("CaseOutcomeBy", fields: [outcomeById], references: [id])
  parentCase                Case?                    @relation("CaseSplits", fields: [parentCaseId], references: [id])
  splitCases                Case[]                   @relation("CaseSplits")
  pipelineStageBy           User?                    @relation("CasePipelineStageBy", fields: [pipelineStageById], references: [id])
  primaryCategory           Category?                @relation("CasePrimaryCategory", fields: [primaryCategoryId], references: [id])
  proxySubmitter            User?                    @relation("CaseProxySubmitter", fields: [proxySubmitterId], references: [id])
  releasedBy                User?                    @relation("CaseReleasedBy", fields: [releasedById], references: [id])
  secondaryCategory         Category?                @relation("CaseSecondaryCategory", fields: [secondaryCategoryId], references: [id])
  updatedBy                 User                     @relation("CaseUpdatedBy", fields: [updatedById], references: [id])
  escalatedConflicts        ConflictAlert[]
  interactions              Interaction[]
  investigations            Investigation[]
  personAssociations        PersonCaseAssociation[]
  policyAssociations        PolicyCaseAssociation[]
  remediationPlans          RemediationPlan[]
  riuAssociations           RiuCaseAssociation[]
  subjects                  Subject[]
  thresholdTriggers         ThresholdTriggerLog[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, severity])
  @@index([organizationId, primaryCategoryId])
  @@index([referenceNumber])
  @@index([organizationId, pipelineStage])
  @@index([organizationId, outcome])
  @@index([organizationId, isMerged])
  @@index([mergedIntoCaseId])
  @@map("cases")
}

/// AuditLog provides unified activity tracking across all entities.
/// This is an append-only table - records are never updated or deleted.
/// Used for compliance audit trails and AI context building.
///
/// PARTITIONING: Partition by created_at in production (monthly partitions)
/// recommended partition command:
/// CREATE TABLE audit_logs_y2026m01 PARTITION OF audit_logs
/// FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
///
/// RETENTION: 7 years per compliance requirements (HIPAA, SOX)
/// ARCHIVAL: Old partitions can be moved to cold storage after 2 years
model AuditLog {
  id                String              @id @default(uuid())
  organizationId    String              @map("organization_id")
  entityType        AuditEntityType     @map("entity_type")
  entityId          String              @map("entity_id")
  action            String
  actionCategory    AuditActionCategory @map("action_category")
  actionDescription String              @map("action_description")
  actorUserId       String?             @map("actor_user_id")
  actorType         ActorType           @map("actor_type")
  actorName         String?             @map("actor_name")
  changes           Json?
  context           Json?
  ipAddress         String?             @map("ip_address")
  userAgent         String?             @map("user_agent")
  requestId         String?             @map("request_id")
  createdAt         DateTime            @default(now()) @map("created_at")
  actorUser         User?               @relation(fields: [actorUserId], references: [id])
  organization      Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, createdAt])
  @@index([organizationId, entityType, entityId, createdAt])
  @@index([organizationId, actorUserId, createdAt])
  @@index([organizationId, actionCategory, createdAt])
  @@map("audit_logs")
}

/// Investigation represents a formal investigation linked to a Case.
/// Cases can have multiple investigations (e.g., HR and Legal investigating same report).
/// organizationId is denormalized from Case for RLS efficiency.
model Investigation {
  id                    String                          @id @default(uuid())
  caseId                String                          @map("case_id")
  organizationId        String                          @map("organization_id")
  investigationNumber   Int                             @map("investigation_number")
  categoryId            String?                         @map("category_id")
  investigationType     InvestigationType               @default(FULL) @map("investigation_type")
  department            InvestigationDepartment?        @map("department")
  assignedTo            String[]                        @default([]) @map("assigned_to")
  primaryInvestigatorId String?                         @map("primary_investigator_id")
  assignedAt            DateTime?                       @map("assigned_at")
  assignedById          String?                         @map("assigned_by_id")
  assignmentHistory     Json?                           @map("assignment_history")
  status                InvestigationStatus             @default(NEW)
  statusRationale       String?                         @map("status_rationale")
  statusChangedAt       DateTime?                       @map("status_changed_at")
  dueDate               DateTime?                       @map("due_date")
  slaStatus             SlaStatus                       @default(ON_TRACK) @map("sla_status")
  findingsSummary       String?                         @map("findings_summary")
  findingsDetail        String?                         @map("findings_detail")
  outcome               InvestigationOutcome?           @map("outcome")
  rootCause             String?                         @map("root_cause")
  lessonsLearned        String?                         @map("lessons_learned")
  findingsDate          DateTime?                       @map("findings_date")
  closedAt              DateTime?                       @map("closed_at")
  closedById            String?                         @map("closed_by_id")
  closureApprovedById   String?                         @map("closure_approved_by_id")
  closureApprovedAt     DateTime?                       @map("closure_approved_at")
  closureNotes          String?                         @map("closure_notes")
  templateId            String?                         @map("template_id")
  templateResponses     Json?                           @map("template_responses")
  templateCompleted     Boolean                         @default(false) @map("template_completed")
  sourceSystem          String?                         @map("source_system")
  sourceRecordId        String?                         @map("source_record_id")
  migratedAt            DateTime?                       @map("migrated_at")
  demoUserSessionId     String?                         @map("demo_user_session_id")
  isBaseData            Boolean                         @default(false) @map("is_base_data")
  createdAt             DateTime                        @default(now()) @map("created_at")
  updatedAt             DateTime                        @updatedAt @map("updated_at")
  createdById           String                          @map("created_by_id")
  updatedById           String                          @map("updated_by_id")
  checklistProgress     InvestigationChecklistProgress?
  interviews            InvestigationInterview[]
  notes                 InvestigationNote[]
  assignedBy            User?                           @relation("InvestigationAssignedBy", fields: [assignedById], references: [id])
  case                  Case                            @relation(fields: [caseId], references: [id], onDelete: Cascade)
  closedBy              User?                           @relation("InvestigationClosedBy", fields: [closedById], references: [id])
  closureApprovedBy     User?                           @relation("InvestigationClosureApprovedBy", fields: [closureApprovedById], references: [id])
  createdBy             User                            @relation("InvestigationCreatedBy", fields: [createdById], references: [id])
  demoUserSession       DemoUserSession?                @relation("DemoSessionInvestigations", fields: [demoUserSessionId], references: [id])
  organization          Organization                    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  primaryInvestigator   User?                           @relation("InvestigationPrimaryInvestigator", fields: [primaryInvestigatorId], references: [id])
  updatedBy             User                            @relation("InvestigationUpdatedBy", fields: [updatedById], references: [id])

  @@unique([caseId, investigationNumber])
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, status])
  @@index([organizationId, primaryInvestigatorId])
  @@index([organizationId, dueDate])
  @@index([organizationId, slaStatus])
  @@map("investigations")
}

/// InvestigationNote stores rich-text notes on investigations.
/// Notes can be general, interview records, evidence documentation, findings, recommendations, or follow-ups.
/// organizationId is denormalized from Investigation for RLS efficiency.
model InvestigationNote {
  id                   String         @id @default(uuid())
  investigationId      String         @map("investigation_id")
  organizationId       String         @map("organization_id")
  content              String         @db.VarChar(50000)
  contentPlainText     String?        @map("content_plain_text")
  noteType             NoteType       @default(GENERAL) @map("note_type")
  visibility           NoteVisibility @default(TEAM)
  authorId             String         @map("author_id")
  authorName           String         @map("author_name")
  isEdited             Boolean        @default(false) @map("is_edited")
  editedAt             DateTime?      @map("edited_at")
  editCount            Int            @default(0) @map("edit_count")
  attachments          Json           @default("[]")
  aiSummary            String?        @map("ai_summary")
  aiSummaryGeneratedAt DateTime?      @map("ai_summary_generated_at")
  aiModelVersion       String?        @map("ai_model_version")
  sourceSystem         String?        @map("source_system")
  sourceRecordId       String?        @map("source_record_id")
  migratedAt           DateTime?      @map("migrated_at")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")
  author               User           @relation("InvestigationNoteAuthor", fields: [authorId], references: [id])
  investigation        Investigation  @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  @@index([organizationId, investigationId])
  @@index([organizationId, authorId])
  @@index([createdAt])
  @@map("investigation_notes")
}

/// InvestigationInterview records structured interviews during investigations.
/// Supports Person-linked, external (freeform), and anonymous interviewees.
/// Template questions enable consistent documentation across investigations.
model InvestigationInterview {
  id                      String          @id @default(uuid())
  organizationId          String          @map("organization_id")
  investigationId         String          @map("investigation_id")
  intervieweeType         IntervieweeType @map("interviewee_type")
  intervieweePersonId     String?         @map("interviewee_person_id")
  intervieweeName         String?         @map("interviewee_name")
  intervieweeTitle        String?         @map("interviewee_title")
  intervieweeEmail        String?         @map("interviewee_email")
  intervieweePhone        String?         @map("interviewee_phone")
  status                  InterviewStatus @default(SCHEDULED)
  scheduledAt             DateTime?       @map("scheduled_at")
  startedAt               DateTime?       @map("started_at")
  completedAt             DateTime?       @map("completed_at")
  duration                Int?
  location                String?
  conductedById           String          @map("conducted_by_id")
  secondaryInterviewerIds String[]        @default([]) @map("secondary_interviewer_ids")
  purpose                 String?
  notes                   String?
  summary                 String?
  keyFindings             String?         @map("key_findings")
  templateId              String?         @map("template_id")
  questions               Json?
  checklistItemId         String?         @map("checklist_item_id")
  hasRecording            Boolean         @default(false) @map("has_recording")
  recordingUrl            String?         @map("recording_url")
  transcriptUrl           String?         @map("transcript_url")
  consentObtained         Boolean         @default(false) @map("consent_obtained")
  consentNotes            String?         @map("consent_notes")
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  createdById             String          @map("created_by_id")
  investigation           Investigation   @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  organization            Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, investigationId])
  @@index([organizationId, intervieweePersonId])
  @@index([organizationId, status])
  @@map("investigation_interviews")
}

/// InterviewTemplate stores reusable question sets for structured interviews.
/// Can be scoped to specific categories for category-specific interview workflows.
model InterviewTemplate {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  description    String?
  categoryId     String?      @map("category_id")
  questions      Json
  isActive       Boolean      @default(true) @map("is_active")
  isSystem       Boolean      @default(false) @map("is_system")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  createdById    String       @map("created_by_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, categoryId])
  @@map("interview_templates")
}

/// Attachment stores file metadata for uploads across multiple entity types.
/// Uses polymorphic pattern (entityType + entityId) to link to Cases, Investigations, or Notes.
/// Actual file content stored in Azure Blob Storage; this table stores metadata only.
model Attachment {
  id             String               @id @default(uuid())
  organizationId String               @map("organization_id")
  entityType     AttachmentEntityType @map("entity_type")
  entityId       String               @map("entity_id")
  fileName       String               @map("file_name")
  fileKey        String               @map("file_key")
  mimeType       String               @map("mime_type")
  fileSize       Int                  @map("file_size")
  description    String?
  isEvidence     Boolean              @default(false) @map("is_evidence")
  uploadedById   String               @map("uploaded_by_id")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy     User                 @relation("AttachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([organizationId])
  @@index([entityType, entityId])
  @@index([organizationId, entityType, entityId])
  @@index([uploadedById])
  @@map("attachments")
}

/// Category provides unified taxonomy for classification across modules.
/// Used for Cases, RIUs, Disclosures, and Policies.
/// Supports hierarchical structure via self-referential parent relationship.
model Category {
  id                    String                    @id @default(uuid())
  organizationId        String                    @map("organization_id")
  name                  String
  code                  String?
  description           String?
  parentCategoryId      String?                   @map("parent_category_id")
  level                 Int                       @default(0)
  path                  String?
  module                CategoryModule
  conceptKey            String?                   @map("concept_key")
  severityDefault       Severity?                 @map("severity_default")
  requiresInvestigation Boolean                   @default(true) @map("requires_investigation")
  escalationRequired    Boolean                   @default(false) @map("escalation_required")
  slaDays               Int?                      @map("sla_days")
  defaultAssigneeId     String?                   @map("default_assignee_id")
  routingRules          Json?                     @map("routing_rules")
  moduleConfig          Json?                     @map("module_config")
  icon                  String?
  color                 String?
  sortOrder             Int                       @default(0) @map("sort_order")
  isActive              Boolean                   @default(true) @map("is_active")
  isSystem              Boolean                   @default(false) @map("is_system")
  createdAt             DateTime                  @default(now()) @map("created_at")
  updatedAt             DateTime                  @updatedAt @map("updated_at")
  casesPrimary          Case[]                    @relation("CasePrimaryCategory")
  casesSecondary        Case[]                    @relation("CaseSecondaryCategory")
  organization          Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentCategory        Category?                 @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories       Category[]                @relation("CategoryHierarchy")
  templateMappings      CategoryTemplateMapping[]
  directives            ClientDirective[]
  rius                  RiskIntelligenceUnit[]

  @@unique([organizationId, module, code])
  @@index([organizationId])
  @@index([organizationId, module])
  @@index([organizationId, parentCategoryId])
  @@index([organizationId, conceptKey])
  @@index([organizationId, isActive])
  @@map("categories")
}

/// RiskIntelligenceUnit represents an immutable intake record - something that happened.
/// This is the "Contact" parallel to HubSpot's architecture.
/// RIUs are IMMUTABLE after creation - corrections go on the Case, not the RIU.
/// NO updatedAt field - emphasizes immutability of intake content.
model RiskIntelligenceUnit {
  id                   String                  @id @default(uuid())
  organizationId       String                  @map("organization_id")
  referenceNumber      String                  @unique @map("reference_number")
  type                 RiuType
  sourceChannel        RiuSourceChannel        @map("source_channel")
  details              String
  summary              String?
  reporterType         RiuReporterType         @map("reporter_type")
  anonymousAccessCode  String?                 @map("anonymous_access_code")
  reporterName         String?                 @map("reporter_name")
  reporterEmail        String?                 @map("reporter_email")
  reporterPhone        String?                 @map("reporter_phone")
  categoryId           String?                 @map("category_id")
  severity             Severity                @default(MEDIUM)
  locationName         String?                 @map("location_name")
  locationAddress      String?                 @map("location_address")
  locationCity         String?                 @map("location_city")
  locationState        String?                 @map("location_state")
  locationZip          String?                 @map("location_zip")
  locationCountry      String?                 @map("location_country")
  campaignId           String?                 @map("campaign_id")
  campaignAssignmentId String?                 @map("campaign_assignment_id")
  customFields         Json?                   @map("custom_fields")
  formResponses        Json?                   @map("form_responses")
  sourceSystem         String?                 @map("source_system")
  sourceRecordId       String?                 @map("source_record_id")
  migratedAt           DateTime?               @map("migrated_at")
  createdAt            DateTime                @default(now()) @map("created_at")
  createdById          String                  @map("created_by_id")
  status               RiuStatus               @default(PENDING_QA)
  statusChangedAt      DateTime?               @map("status_changed_at")
  statusChangedById    String?                 @map("status_changed_by_id")
  languageDetected     String?                 @map("language_detected")
  languageConfirmed    String?                 @map("language_confirmed")
  languageEffective    String?                 @map("language_effective")
  aiSummary            String?                 @map("ai_summary")
  aiRiskScore          Decimal?                @map("ai_risk_score") @db.Decimal(3, 2)
  aiTranslation        String?                 @map("ai_translation")
  aiLanguageDetected   String?                 @map("ai_language_detected")
  aiModelVersion       String?                 @map("ai_model_version")
  aiGeneratedAt        DateTime?               @map("ai_generated_at")
  aiConfidenceScore    Int?                    @map("ai_confidence_score")
  demoUserSessionId    String?                 @map("demo_user_session_id")
  isBaseData           Boolean                 @default(false) @map("is_base_data")
  interactions         Interaction[]
  personAssociations   PersonRiuAssociation[]
  campaign             Campaign?               @relation("CampaignRius", fields: [campaignId], references: [id])
  category             Category?               @relation(fields: [categoryId], references: [id])
  createdBy            User                    @relation("RiuCreatedBy", fields: [createdById], references: [id])
  demoUserSession      DemoUserSession?        @relation("DemoSessionRius", fields: [demoUserSessionId], references: [id])
  organization         Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  caseAssociations     RiuCaseAssociation[]
  disclosureExtension  RiuDisclosureExtension?
  hotlineExtension     RiuHotlineExtension?
  webFormExtension     RiuWebFormExtension?

  @@index([organizationId])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, sourceChannel])
  @@index([organizationId, createdAt])
  @@index([organizationId, categoryId])
  @@index([organizationId, severity])
  @@index([anonymousAccessCode])
  @@index([organizationId, campaignId])
  @@map("risk_intelligence_units")
}

/// Hotline-specific fields for RIU type = HOTLINE_REPORT
/// Extension table pattern: base RIU + type-specific data for database-level constraints
model RiuHotlineExtension {
  id                  String               @id @default(uuid())
  riuId               String               @unique @map("riu_id")
  organizationId      String               @map("organization_id")
  callDuration        Int?                 @map("call_duration")
  interpreterUsed     Boolean              @default(false) @map("interpreter_used")
  interpreterLanguage String?              @map("interpreter_language")
  callerDemeanor      String?              @map("caller_demeanor")
  transferredFrom     String?              @map("transferred_from")
  recordingUrl        String?              @map("recording_url")
  callbackRequested   Boolean              @default(false) @map("callback_requested")
  callbackNumber      String?              @map("callback_number")
  operatorNotes       String?              @map("operator_notes")
  qaStatus            RiuQaStatus          @default(PENDING) @map("qa_status")
  qaReviewerId        String?              @map("qa_reviewer_id")
  qaReviewedAt        DateTime?            @map("qa_reviewed_at")
  qaNotes             String?              @map("qa_notes")
  qaRejectionReason   String?              @map("qa_rejection_reason")
  createdAt           DateTime             @default(now()) @map("created_at")
  riu                 RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([qaStatus])
  @@map("riu_hotline_extensions")
}

/// Disclosure-specific fields for RIU type = DISCLOSURE_RESPONSE
/// Tracks value thresholds and conflict detection for compliance review
model RiuDisclosureExtension {
  id                   String                  @id @default(uuid())
  riuId                String                  @unique @map("riu_id")
  organizationId       String                  @map("organization_id")
  disclosureType       DisclosureType          @map("disclosure_type")
  disclosureSubtype    String?                 @map("disclosure_subtype")
  disclosureValue      Decimal?                @map("disclosure_value") @db.Decimal(12, 2)
  disclosureCurrency   String?                 @map("disclosure_currency")
  estimatedAnnualValue Decimal?                @map("estimated_annual_value") @db.Decimal(12, 2)
  thresholdTriggered   Boolean                 @default(false) @map("threshold_triggered")
  thresholdAmount      Decimal?                @map("threshold_amount") @db.Decimal(12, 2)
  conflictDetected     Boolean                 @default(false) @map("conflict_detected")
  conflictReason       String?                 @map("conflict_reason")
  relatedPersonId      String?                 @map("related_person_id")
  relatedPersonName    String?                 @map("related_person_name")
  relatedCompany       String?                 @map("related_company")
  relationshipType     String?                 @map("relationship_type")
  effectiveDate        DateTime?               @map("effective_date")
  expirationDate       DateTime?               @map("expiration_date")
  formTemplateId       String?                 @map("form_template_id")
  formVersion          Int?                    @map("form_version")
  createdAt            DateTime                @default(now()) @map("created_at")
  conflictAlerts       ConflictAlert[]
  formTemplate         DisclosureFormTemplate? @relation(fields: [formTemplateId], references: [id])
  riu                  RiskIntelligenceUnit    @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([disclosureType])
  @@index([thresholdTriggered])
  @@index([conflictDetected])
  @@index([formTemplateId])
  @@map("riu_disclosure_extensions")
}

/// Draft storage for disclosure submissions (RS.24 - save/resume functionality)
/// Allows employees to save partial form progress and resume later
model DisclosureDraft {
  id                   String                  @id @default(uuid())
  organizationId       String                  @map("organization_id")
  employeeId           String                  @map("employee_id")
  assignmentId         String?                 @map("assignment_id")
  formTemplateId       String?                 @map("form_template_id")
  disclosureType       DisclosureType?         @map("disclosure_type")
  formData             Json                    @map("form_data")
  completionPercentage Int                     @default(0) @map("completion_percentage")
  currentSection       String?                 @map("current_section")
  createdAt            DateTime                @default(now()) @map("created_at")
  updatedAt            DateTime                @updatedAt @map("updated_at")
  campaignAssignment   CampaignAssignment?     @relation(fields: [assignmentId], references: [id])
  employee             Employee                @relation(fields: [employeeId], references: [id])
  formTemplate         DisclosureFormTemplate? @relation(fields: [formTemplateId], references: [id])
  organization         Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, employeeId, assignmentId])
  @@index([organizationId])
  @@index([employeeId])
  @@map("disclosure_drafts")
}

/// Web form-specific fields for RIU type = WEB_FORM_SUBMISSION
/// Tracks form version, submission metadata, and validation state
model RiuWebFormExtension {
  id                    String               @id @default(uuid())
  riuId                 String               @unique @map("riu_id")
  organizationId        String               @map("organization_id")
  formDefinitionId      String               @map("form_definition_id")
  formDefinitionVersion Int                  @map("form_definition_version")
  formName              String?              @map("form_name")
  submissionSource      String?              @map("submission_source")
  submitterIpAddress    String?              @map("submitter_ip_address")
  submitterUserAgent    String?              @map("submitter_user_agent")
  submissionDuration    Int?                 @map("submission_duration")
  validationPassed      Boolean              @default(true) @map("validation_passed")
  validationErrors      Json?                @map("validation_errors")
  attachmentCount       Int                  @default(0) @map("attachment_count")
  totalAttachmentSize   Int                  @default(0) @map("total_attachment_size")
  createdAt             DateTime             @default(now()) @map("created_at")
  riu                   RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([formDefinitionId])
  @@map("riu_web_form_extensions")
}

/// RiuCaseAssociation links Risk Intelligence Units to Cases (many-to-many).
/// Multiple RIUs can be associated with a single Case (related reports).
/// A single RIU typically has one primary Case but could be linked to multiple Cases.
model RiuCaseAssociation {
  id              String               @id @default(uuid())
  organizationId  String               @map("organization_id")
  riuId           String               @map("riu_id")
  caseId          String               @map("case_id")
  associationType RiuAssociationType   @default(PRIMARY) @map("association_type")
  notes           String?
  createdAt       DateTime             @default(now()) @map("created_at")
  createdById     String               @map("created_by_id")
  case            Case                 @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy       User                 @relation("RiuCaseAssociationCreatedBy", fields: [createdById], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  riu             RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@unique([riuId, caseId])
  @@index([organizationId])
  @@index([riuId])
  @@index([caseId])
  @@index([associationType])
  @@map("riu_case_associations")
}

/// Subject represents people named in Cases for cross-case pattern detection.
/// Can link to Employee records (HRIS) or store external names for non-employees.
/// Used to identify repeat subjects across multiple cases.
model Subject {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  caseId         String       @map("case_id")
  employeeId     String?      @map("employee_id")
  externalName   String?      @map("external_name")
  email          String?
  phone          String?
  role           SubjectRole
  relationship   String?
  department     String?
  location       String?
  jobTitle       String?      @map("job_title")
  managerName    String?      @map("manager_name")
  hrisSnapshot   Json?        @map("hris_snapshot")
  notes          String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  createdById    String       @map("created_by_id")
  case           Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy      User         @relation("SubjectCreatedBy", fields: [createdById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, employeeId])
  @@index([organizationId, role])
  @@map("subjects")
}

/// CaseMessage provides two-way anonymous communication between reporters and investigators.
/// Ethico acts as a relay protecting reporter identity (Chinese Wall model).
/// Reporter contact info is stored on RIU but hidden from Case users.
model CaseMessage {
  id             String                 @id @default(uuid())
  organizationId String                 @map("organization_id")
  caseId         String                 @map("case_id")
  direction      MessageDirection
  senderType     MessageSenderType      @map("sender_type")
  content        String
  subject        String?
  isRead         Boolean                @default(false) @map("is_read")
  readAt         DateTime?              @map("read_at")
  readById       String?                @map("read_by_id")
  deliveryStatus MessageDeliveryStatus? @map("delivery_status")
  deliveredAt    DateTime?              @map("delivered_at")
  createdAt      DateTime               @default(now()) @map("created_at")
  createdById    String?                @map("created_by_id")
  case           Case                   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy      User?                  @relation("CaseMessageCreatedBy", fields: [createdById], references: [id])
  organization   Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  readBy         User?                  @relation("CaseMessageReadBy", fields: [readById], references: [id])

  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, caseId, createdAt])
  @@index([organizationId, isRead])
  @@map("case_messages")
}

/// Interaction records follow-up contacts and status checks on Cases.
/// Distinct from CaseMessage - Interactions are internal notes about contacts,
/// while CaseMessages are the actual two-way communication content.
model Interaction {
  id                String                @id @default(uuid())
  organizationId    String                @map("organization_id")
  caseId            String                @map("case_id")
  riuId             String?               @map("riu_id")
  interactionType   InteractionType       @map("interaction_type")
  channel           InteractionChannel
  summary           String
  notes             String?
  addendum          String?
  newInfoAdded      Boolean               @default(false) @map("new_info_added")
  fieldsUpdated     Json?                 @map("fields_updated")
  additionalDetails String?               @map("additional_details")
  qaRequired        Boolean               @default(false) @map("qa_required")
  qaStatus          InteractionQaStatus?  @map("qa_status")
  qaReviewedById    String?               @map("qa_reviewed_by_id")
  qaReviewedAt      DateTime?             @map("qa_reviewed_at")
  conductedById     String                @map("conducted_by_id")
  conductedAt       DateTime              @map("conducted_at")
  createdAt         DateTime              @default(now()) @map("created_at")
  case              Case                  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  conductedBy       User                  @relation("InteractionConductedBy", fields: [conductedById], references: [id])
  organization      Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  qaReviewedBy      User?                 @relation("InteractionQaReviewedBy", fields: [qaReviewedById], references: [id])
  riu               RiskIntelligenceUnit? @relation(fields: [riuId], references: [id])

  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, caseId, conductedAt])
  @@index([organizationId, interactionType])
  @@map("interactions")
}

/// WorkflowTemplate defines a reusable workflow pipeline.
/// Templates are versioned - version increments on publish.
/// entityType determines which entities this workflow applies to.
model WorkflowTemplate {
  id               String             @id @default(uuid())
  organizationId   String             @map("organization_id")
  name             String
  description      String?
  entityType       WorkflowEntityType @map("entity_type")
  version          Int                @default(1)
  isActive         Boolean            @default(true) @map("is_active")
  isDefault        Boolean            @default(false) @map("is_default")
  stages           Json
  transitions      Json
  initialStage     String             @map("initial_stage")
  defaultSlaDays   Int?               @map("default_sla_days")
  slaConfig        Json?              @map("sla_config")
  sourceTemplateId String?            @map("source_template_id")
  tags             String[]           @default([])
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  createdById      String?            @map("created_by_id")
  instances        WorkflowInstance[]
  organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name, version])
  @@index([organizationId])
  @@index([organizationId, entityType])
  @@index([organizationId, isActive])
  @@map("workflow_templates")
}

/// WorkflowInstance tracks an entity's progress through a workflow.
/// Links to the specific template VERSION to ensure in-flight stability.
model WorkflowInstance {
  id              String                 @id @default(uuid())
  organizationId  String                 @map("organization_id")
  templateId      String                 @map("template_id")
  templateVersion Int                    @map("template_version")
  entityType      WorkflowEntityType     @map("entity_type")
  entityId        String                 @map("entity_id")
  currentStage    String                 @map("current_stage")
  currentStep     String?                @map("current_step")
  status          WorkflowInstanceStatus @default(ACTIVE)
  stepStates      Json                   @default("{}") @map("step_states")
  dueDate         DateTime?              @map("due_date")
  slaStatus       SlaStatus              @default(ON_TRACK) @map("sla_status")
  slaBreachedAt   DateTime?              @map("sla_breached_at")
  completedAt     DateTime?              @map("completed_at")
  outcome         String?
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  startedById     String?                @map("started_by_id")
  organization    Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template        WorkflowTemplate       @relation(fields: [templateId], references: [id])

  @@unique([entityType, entityId])
  @@index([organizationId])
  @@index([organizationId, entityType])
  @@index([organizationId, status])
  @@index([organizationId, currentStage])
  @@index([organizationId, slaStatus])
  @@map("workflow_instances")
}

/// FormDefinition stores JSON Schema definitions for dynamic forms.
/// Used for intake forms, disclosure forms, workflow tasks, surveys.
/// Definitions are versioned - version increments on publish.
model FormDefinition {
  id               String           @id @default(uuid())
  organizationId   String           @map("organization_id")
  name             String
  description      String?
  formType         FormType         @map("form_type")
  version          Int              @default(1)
  isActive         Boolean          @default(true) @map("is_active")
  isPublished      Boolean          @default(false) @map("is_published")
  schema           Json
  uiSchema         Json?            @map("ui_schema")
  defaultValues    Json?            @map("default_values")
  allowAnonymous   Boolean          @default(false) @map("allow_anonymous")
  requiresApproval Boolean          @default(false) @map("requires_approval")
  notifyOnSubmit   String[]         @default([]) @map("notify_on_submit")
  categoryId       String?          @map("category_id")
  tags             String[]         @default([])
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  createdById      String?          @map("created_by_id")
  publishedAt      DateTime?        @map("published_at")
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submissions      FormSubmission[]

  @@unique([organizationId, name, version])
  @@index([organizationId])
  @@index([organizationId, formType])
  @@index([organizationId, isActive])
  @@map("form_definitions")
}

/// FormSubmission stores completed form submissions.
/// Links to FormDefinition by version for historical accuracy.
model FormSubmission {
  id                    String               @id @default(uuid())
  organizationId        String               @map("organization_id")
  formDefinitionId      String               @map("form_definition_id")
  formDefinitionVersion Int                  @map("form_definition_version")
  data                  Json
  status                FormSubmissionStatus @default(SUBMITTED)
  validationErrors      Json?                @map("validation_errors")
  entityType            String?              @map("entity_type")
  entityId              String?              @map("entity_id")
  submittedById         String?              @map("submitted_by_id")
  submittedAt           DateTime             @default(now()) @map("submitted_at")
  submitterIp           String?              @map("submitter_ip")
  submitterAgent        String?              @map("submitter_agent")
  anonymousAccessCode   String?              @map("anonymous_access_code")
  createdAt             DateTime             @default(now()) @map("created_at")
  updatedAt             DateTime             @updatedAt @map("updated_at")
  formDefinition        FormDefinition       @relation(fields: [formDefinitionId], references: [id])
  organization          Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, formDefinitionId])
  @@index([organizationId, entityType, entityId])
  @@index([anonymousAccessCode])
  @@map("form_submissions")
}

/// ReportTemplate defines reusable report configurations.
/// Templates specify data source, columns, filters, and aggregations.
model ReportTemplate {
  id             String            @id @default(uuid())
  organizationId String?           @map("organization_id")
  name           String
  description    String?
  category       String?
  isSystem       Boolean           @default(false) @map("is_system")
  isPublic       Boolean           @default(false) @map("is_public")
  dataSource     ReportDataSource  @map("data_source")
  columns        Json
  filters        Json?
  aggregations   Json?
  sortBy         String?           @map("sort_by")
  sortOrder      String?           @map("sort_order")
  chartType      String?           @map("chart_type")
  chartConfig    Json?             @map("chart_config")
  allowedRoles   String[]          @default([]) @map("allowed_roles")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  createdById    String?           @map("created_by_id")
  executions     ReportExecution[]
  organization   Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([dataSource])
  @@index([isSystem])
  @@map("report_templates")
}

/// ReportExecution tracks report generation history.
/// Used for async report generation and download links.
model ReportExecution {
  id             String                @id @default(uuid())
  organizationId String                @map("organization_id")
  templateId     String                @map("template_id")
  status         ReportExecutionStatus @default(PENDING)
  filters        Json?
  parameters     Json?
  rowCount       Int?                  @map("row_count")
  fileKey        String?               @map("file_key")
  fileUrl        String?               @map("file_url")
  expiresAt      DateTime?             @map("expires_at")
  startedAt      DateTime?             @map("started_at")
  completedAt    DateTime?             @map("completed_at")
  errorMessage   String?               @map("error_message")
  createdAt      DateTime              @default(now()) @map("created_at")
  requestedById  String                @map("requested_by_id")
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template       ReportTemplate        @relation(fields: [templateId], references: [id])

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([templateId])
  @@map("report_executions")
}

/// DemoAccount tracks prospect account provisioning for sales demonstrations.
/// Sales reps provision time-limited prospect accounts for customer demos.
/// All prospect access is attributed to the originating sales rep.
model DemoAccount {
  id              String            @id @default(uuid())
  organizationId  String            @map("organization_id")
  prospectUserId  String            @unique @map("prospect_user_id")
  prospectEmail   String            @map("prospect_email")
  prospectName    String?           @map("prospect_name")
  prospectCompany String?           @map("prospect_company")
  salesRepUserId  String            @map("sales_rep_user_id")
  expiresAt       DateTime          @map("expires_at")
  expiredAt       DateTime?         @map("expired_at")
  status          DemoAccountStatus @default(ACTIVE)
  lastAccessAt    DateTime?         @map("last_access_at")
  accessCount     Int               @default(0) @map("access_count")
  notes           String?
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  prospectUser    User              @relation("ProspectUser", fields: [prospectUserId], references: [id])
  salesRepUser    User              @relation("SalesRepUser", fields: [salesRepUserId], references: [id])

  @@index([organizationId])
  @@index([salesRepUserId])
  @@index([status, expiresAt])
  @@map("demo_accounts")
}

/// Location represents a physical office or work site.
/// Real cities with fictional addresses for demo realism.
model Location {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  code           String
  name           String
  addressLine1   String       @map("address_line_1")
  addressLine2   String?      @map("address_line_2")
  city           String
  stateProvince  String?      @map("state_province")
  postalCode     String?      @map("postal_code")
  country        String
  countryName    String       @map("country_name")
  region         String
  timezone       String
  isHeadquarters Boolean      @default(false) @map("is_headquarters")
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  employees      Employee[]
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teams          Team[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, region])
  @@index([organizationId, country])
  @@map("locations")
}

/// Division represents a major business segment.
/// Acme Co. has 4 divisions: Healthcare (50%), Tech, Retail, Energy
model Division {
  id              String         @id @default(uuid())
  organizationId  String         @map("organization_id")
  code            String
  name            String
  description     String?
  headEmployeeId  String?        @map("head_employee_id")
  employeeWeight  Int            @default(25) @map("employee_weight")
  defaultWorkMode WorkMode       @default(HYBRID) @map("default_work_mode")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  businessUnits   BusinessUnit[]
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("divisions")
}

/// BusinessUnit is a sub-segment within a Division.
/// Example: Within Healthcare -> "Hospital Services", "Pharma", "Medical Devices"
model BusinessUnit {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  divisionId     String       @map("division_id")
  code           String
  name           String
  description    String?
  headEmployeeId String?      @map("head_employee_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  division       Division     @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  departments    Department[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([divisionId])
  @@map("business_units")
}

/// Department is a functional area within a Business Unit.
/// Example: Within Hospital Services -> "Nursing", "Administration", "Clinical"
model Department {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  businessUnitId String       @map("business_unit_id")
  code           String
  name           String
  description    String?
  headEmployeeId String?      @map("head_employee_id")
  hrbpEmployeeId String?      @map("hrbp_employee_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  businessUnit   BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teams          Team[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([businessUnitId])
  @@map("departments")
}

/// Team is the smallest organizational unit.
/// Example: Within Nursing -> "ICU Team", "ER Team", "Pediatrics Team"
model Team {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  departmentId   String       @map("department_id")
  code           String
  name           String
  description    String?
  leadEmployeeId String?      @map("lead_employee_id")
  locationId     String?      @map("location_id")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  employees      Employee[]
  department     Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  location       Location?    @relation(fields: [locationId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([departmentId])
  @@map("teams")
}

/// Employee represents HRIS-synced employee data.
/// 20,000 employees with full reporting chains.
/// Distinct from User - an Employee may or may not have a User account.
model Employee {
  id                  String                     @id @default(uuid())
  organizationId      String                     @map("organization_id")
  hrisEmployeeId      String                     @map("hris_employee_id")
  firstName           String                     @map("first_name")
  lastName            String                     @map("last_name")
  preferredName       String?                    @map("preferred_name")
  email               String
  phone               String?
  jobTitle            String                     @map("job_title")
  jobLevel            JobLevel                   @default(IC) @map("job_level")
  divisionId          String?                    @map("division_id")
  businessUnitId      String?                    @map("business_unit_id")
  departmentId        String?                    @map("department_id")
  teamId              String?                    @map("team_id")
  locationId          String?                    @map("location_id")
  department          String?
  departmentCode      String?                    @map("department_code")
  location            String?
  locationCode        String?                    @map("location_code")
  costCenter          String?                    @map("cost_center")
  managerId           String?                    @map("manager_id")
  managerName         String?                    @map("manager_name")
  workMode            WorkMode                   @default(HYBRID) @map("work_mode")
  primaryLanguage     String                     @default("en") @map("primary_language")
  complianceRole      ComplianceRole?            @map("compliance_role")
  employmentStatus    EmploymentStatus           @default(ACTIVE) @map("employment_status")
  employmentType      EmploymentType             @default(FULL_TIME) @map("employment_type")
  hireDate            DateTime?                  @map("hire_date")
  terminationDate     DateTime?                  @map("termination_date")
  isNamedPersona      Boolean                    @default(false) @map("is_named_persona")
  personaRole         String?                    @map("persona_role")
  sourceSystem        String                     @default("MANUAL") @map("source_system")
  syncedAt            DateTime                   @default(now()) @map("synced_at")
  lastSyncStatus      String?                    @map("last_sync_status")
  rawHrisData         Json?                      @map("raw_hris_data")
  createdAt           DateTime                   @default(now()) @map("created_at")
  updatedAt           DateTime                   @updatedAt @map("updated_at")
  campaignAssignments CampaignAssignment[]
  disclosureDrafts    DisclosureDraft[]
  complianceProfile   EmployeeComplianceProfile?
  locationAssignment  Location?                  @relation(fields: [locationId], references: [id])
  manager             Employee?                  @relation("EmployeeManager", fields: [managerId], references: [id])
  reports             Employee[]                 @relation("EmployeeManager")
  organization        Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  teamAssignment      Team?                      @relation(fields: [teamId], references: [id])
  personRecords       Person[]

  @@unique([organizationId, hrisEmployeeId])
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, divisionId])
  @@index([organizationId, departmentId])
  @@index([organizationId, teamId])
  @@index([organizationId, locationId])
  @@index([organizationId, employmentStatus])
  @@index([organizationId, managerId])
  @@index([organizationId, jobLevel])
  @@index([organizationId, complianceRole])
  @@map("employees")
}

/// EmployeeComplianceProfile tracks employee response patterns for campaigns.
/// Used for repeat non-responder detection and compliance scoring (RS.51).
model EmployeeComplianceProfile {
  id                      String       @id @default(uuid())
  organizationId          String       @map("organization_id")
  employeeId              String       @unique @map("employee_id")
  campaignsAssigned       Int          @default(0) @map("campaigns_assigned")
  campaignsCompleted      Int          @default(0) @map("campaigns_completed")
  campaignsMissedDeadline Int          @default(0) @map("campaigns_missed_deadline")
  averageResponseDays     Float?       @map("average_response_days")
  isRepeatNonResponder    Boolean      @default(false) @map("is_repeat_non_responder")
  lastCampaignCompletedAt DateTime?    @map("last_campaign_completed_at")
  createdAt               DateTime     @default(now()) @map("created_at")
  updatedAt               DateTime     @updatedAt @map("updated_at")
  employee                Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([isRepeatNonResponder])
  @@map("employee_compliance_profiles")
}

/// Person represents any individual associated with compliance matters.
/// This is the foundation for people-based pattern detection.
/// Employees, external contacts, and anonymous reporters all become Person records.
/// Person is the "Contact" parallel to HubSpot's architecture.
model Person {
  id                     String                    @id @default(uuid())
  organizationId         String                    @map("organization_id")
  type                   PersonType
  source                 PersonSource
  firstName              String?                   @map("first_name")
  lastName               String?                   @map("last_name")
  email                  String?
  phone                  String?
  employeeId             String?                   @map("employee_id")
  businessUnitId         String?                   @map("business_unit_id")
  businessUnitName       String?                   @map("business_unit_name")
  jobTitle               String?                   @map("job_title")
  employmentStatus       String?                   @map("employment_status")
  locationId             String?                   @map("location_id")
  locationName           String?                   @map("location_name")
  managerId              String?                   @map("manager_id")
  managerName            String?                   @map("manager_name")
  company                String?
  title                  String?
  relationship           String?
  anonymityTier          AnonymityTier             @default(OPEN) @map("anonymity_tier")
  status                 PersonStatus              @default(ACTIVE)
  mergedIntoPrimaryId    String?                   @map("merged_into_primary_id")
  mergedAt               DateTime?                 @map("merged_at")
  mergedById             String?                   @map("merged_by_id")
  notes                  String?
  createdAt              DateTime                  @default(now()) @map("created_at")
  updatedAt              DateTime                  @updatedAt @map("updated_at")
  createdById            String?                   @map("created_by_id")
  updatedById            String?                   @map("updated_by_id")
  conflictExclusions     ConflictExclusion[]
  caseAssociations       PersonCaseAssociation[]
  personRelationshipsAsA PersonPersonAssociation[] @relation("PersonARelation")
  personRelationshipsAsB PersonPersonAssociation[] @relation("PersonBRelation")
  riuAssociations        PersonRiuAssociation[]
  employee               Employee?                 @relation(fields: [employeeId], references: [id])
  manager                Person?                   @relation("PersonManager", fields: [managerId], references: [id])
  directReports          Person[]                  @relation("PersonManager")
  mergedIntoPrimary      Person?                   @relation("PersonMerge", fields: [mergedIntoPrimaryId], references: [id])
  mergedPersons          Person[]                  @relation("PersonMerge")
  organization           Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, employeeId])
  @@index([organizationId, managerId])
  @@index([organizationId, businessUnitId])
  @@map("persons")
}

/// Tracks a demo user's session and their isolated changes.
/// Each user has exactly one session per organization.
/// Base data has demoUserSessionId: null and isBaseData: true.
/// User changes have demoUserSessionId: {id} and isBaseData: false.
model DemoUserSession {
  id              String                 @id @default(uuid())
  organizationId  String                 @map("organization_id")
  userId          String                 @map("user_id")
  /// When this session was created
  createdAt       DateTime               @default(now()) @map("created_at")
  /// Last activity in this session
  lastActivityAt  DateTime               @default(now()) @map("last_activity_at")
  cases           Case[]                 @relation("DemoSessionCases")
  archivedChanges DemoArchivedChange[]
  organization    Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  investigations  Investigation[]        @relation("DemoSessionInvestigations")
  rius            RiskIntelligenceUnit[] @relation("DemoSessionRius")

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([lastActivityAt])
  @@map("demo_user_sessions")
}

/// Archives user changes during reset for 24-hour undo window.
/// After reset, changes are stored here temporarily before permanent deletion.
model DemoArchivedChange {
  id                String          @id @default(uuid())
  organizationId    String          @map("organization_id")
  demoUserSessionId String          @map("demo_user_session_id")
  /// The type of entity archived
  entityType        String          @map("entity_type")
  /// The original entity ID
  entityId          String          @map("entity_id")
  /// Complete JSON snapshot of the entity
  entityData        Json            @map("entity_data")
  /// When the change was archived (for 24-hour expiry)
  archivedAt        DateTime        @default(now()) @map("archived_at")
  /// When this archive expires and can be cleaned up
  expiresAt         DateTime        @map("expires_at")
  /// Whether this has been restored
  restoredAt        DateTime?       @map("restored_at")
  demoUserSession   DemoUserSession @relation(fields: [demoUserSessionId], references: [id], onDelete: Cascade)
  organization      Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([demoUserSessionId])
  @@index([archivedAt])
  @@index([expiresAt])
  @@index([entityType, entityId])
  @@map("demo_archived_changes")
}

/// Segment defines a reusable audience filter for campaigns.
/// Segments use JSON criteria that are converted to Prisma where clauses.
/// Segments can be shared across multiple campaigns.
model Segment {
  id                    String       @id @default(uuid())
  organizationId        String       @map("organization_id")
  name                  String
  description           String?
  criteria              Json
  estimatedAudienceSize Int?         @map("estimated_audience_size")
  audienceSizeUpdatedAt DateTime?    @map("audience_size_updated_at")
  isActive              Boolean      @default(true) @map("is_active")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  createdById           String?      @map("created_by_id")
  updatedById           String?      @map("updated_by_id")
  campaigns             Campaign[]
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("segments")
}

/// Campaign represents an outbound compliance request (disclosures, attestations, surveys).
/// HubSpot Sequence equivalent - sends requests to a targeted audience.
/// Campaign launch creates CampaignAssignment for each target employee.
model Campaign {
  id                       String                  @id @default(uuid())
  organizationId           String                  @map("organization_id")
  name                     String
  description              String?
  type                     CampaignType
  version                  Int                     @default(1)
  language                 String                  @default("en")
  parentCampaignId         String?                 @map("parent_campaign_id")
  parentVersionAtCreation  Int?                    @map("parent_version_at_creation")
  status                   CampaignStatus          @default(DRAFT)
  statusNote               String?                 @map("status_note")
  audienceMode             AudienceMode            @map("audience_mode")
  segmentId                String?                 @map("segment_id")
  manualIds                String[]                @default([]) @map("manual_ids")
  launchAt                 DateTime?               @map("launch_at")
  launchedAt               DateTime?               @map("launched_at")
  launchedById             String?                 @map("launched_by_id")
  dueDate                  DateTime                @map("due_date")
  expiresAt                DateTime?               @map("expires_at")
  rolloutStrategy          CampaignRolloutStrategy @default(IMMEDIATE) @map("rollout_strategy")
  rolloutConfig            Json?                   @map("rollout_config")
  formDefinitionId         String?                 @map("form_definition_id")
  disclosureFormTemplateId String?                 @map("disclosure_form_template_id")
  policyId                 String?                 @map("policy_id")
  policyVersionId          String?                 @map("policy_version_id")
  attestationType          AttestationType?        @map("attestation_type")
  quizConfig               Json?                   @map("quiz_config")
  forceScroll              Boolean                 @default(false) @map("force_scroll")
  signatureRequired        Boolean                 @default(false) @map("signature_required")
  autoCreateCaseOnRefusal  Boolean                 @default(true) @map("auto_create_case_on_refusal")
  reminderDays             Int[]                   @default([7, 3, 1]) @map("reminder_days")
  lastReminderSentAt       DateTime?               @map("last_reminder_sent_at")
  escalationAfterDays      Int?                    @map("escalation_after_days")
  escalateToUserId         String?                 @map("escalate_to_user_id")
  reminderConfig           Json?                   @map("reminder_config")
  autoCreateCase           Boolean                 @default(false) @map("auto_create_case")
  caseCreationThreshold    Json?                   @map("case_creation_threshold")
  totalAssignments         Int                     @default(0) @map("total_assignments")
  completedAssignments     Int                     @default(0) @map("completed_assignments")
  overdueAssignments       Int                     @default(0) @map("overdue_assignments")
  completionPercentage     Int                     @default(0) @map("completion_percentage")
  createdAt                DateTime                @default(now()) @map("created_at")
  updatedAt                DateTime                @updatedAt @map("updated_at")
  createdById              String?                 @map("created_by_id")
  updatedById              String?                 @map("updated_by_id")
  assignments              CampaignAssignment[]
  waves                    CampaignWave[]
  disclosureFormTemplate   DisclosureFormTemplate? @relation("CampaignFormTemplate", fields: [disclosureFormTemplateId], references: [id])
  organization             Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentCampaign           Campaign?               @relation("CampaignTranslations", fields: [parentCampaignId], references: [id])
  translations             Campaign[]              @relation("CampaignTranslations")
  policy                   Policy?                 @relation("PolicyCampaigns", fields: [policyId], references: [id])
  policyVersion            PolicyVersion?          @relation("PolicyVersionCampaigns", fields: [policyVersionId], references: [id])
  segment                  Segment?                @relation(fields: [segmentId], references: [id])
  rius                     RiskIntelligenceUnit[]  @relation("CampaignRius")

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, dueDate])
  @@index([organizationId, launchAt])
  @@index([parentCampaignId])
  @@map("campaigns")
}

/// CampaignAssignment tracks an individual employee's assignment within a campaign.
/// Created when campaign is launched, one per target employee.
/// Snapshots employee data at creation for historical accuracy.
model CampaignAssignment {
  id                 String            @id @default(uuid())
  organizationId     String            @map("organization_id")
  campaignId         String            @map("campaign_id")
  employeeId         String            @map("employee_id")
  waveId             String?           @map("wave_id")
  status             AssignmentStatus  @default(PENDING)
  assignedAt         DateTime          @default(now()) @map("assigned_at")
  notifiedAt         DateTime?         @map("notified_at")
  startedAt          DateTime?         @map("started_at")
  completedAt        DateTime?         @map("completed_at")
  dueDate            DateTime          @map("due_date")
  reminderCount      Int               @default(0) @map("reminder_count")
  lastReminderSentAt DateTime?         @map("last_reminder_sent_at")
  managerNotifiedAt  DateTime?         @map("manager_notified_at")
  riuId              String?           @map("riu_id")
  formSubmissionId   String?           @map("form_submission_id")
  attestedAt         DateTime?         @map("attested_at")
  attestationType    AttestationType?  @map("attestation_type")
  quizScore          Int?              @map("quiz_score")
  quizAttempts       Int?              @default(0) @map("quiz_attempts")
  signatureData      String?           @map("signature_data")
  refusedAt          DateTime?         @map("refused_at")
  refusalReason      String?           @map("refusal_reason")
  employeeSnapshot   Json              @map("employee_snapshot")
  notes              String?
  skippedBy          String?           @map("skipped_by")
  skipReason         String?           @map("skip_reason")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  campaign           Campaign          @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  employee           Employee          @relation(fields: [employeeId], references: [id])
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  wave               CampaignWave?     @relation(fields: [waveId], references: [id])
  disclosureDrafts   DisclosureDraft[]

  @@unique([campaignId, employeeId])
  @@index([organizationId])
  @@index([organizationId, campaignId])
  @@index([organizationId, employeeId])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@index([waveId])
  @@map("campaign_assignments")
}

/// CampaignWave represents a single wave in a staggered campaign rollout.
/// Waves allow distributing assignments over time to avoid overwhelming the system
/// and to enable pilot testing before full rollout.
model CampaignWave {
  id                 String               @id @default(uuid())
  organizationId     String               @map("organization_id")
  campaignId         String               @map("campaign_id")
  waveNumber         Int                  @map("wave_number")
  scheduledAt        DateTime             @map("scheduled_at")
  launchedAt         DateTime?            @map("launched_at")
  audiencePercentage Int?                 @map("audience_percentage")
  employeeIds        String[]             @default([]) @map("employee_ids")
  status             CampaignWaveStatus   @default(PENDING)
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  assignments        CampaignAssignment[]
  campaign           Campaign             @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  organization       Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([campaignId, waveNumber])
  @@index([organizationId])
  @@index([organizationId, campaignId])
  @@index([organizationId, status])
  @@index([scheduledAt])
  @@map("campaign_waves")
}

/// OrgBlackoutDate defines periods when campaign sends are blocked.
/// Supports organization-wide blackouts and location-specific restrictions.
/// Recurring blackouts (e.g., annual holidays) can be configured.
model OrgBlackoutDate {
  id               String       @id @default(uuid())
  organizationId   String       @map("organization_id")
  name             String
  description      String?
  startDate        DateTime     @map("start_date")
  endDate          DateTime     @map("end_date")
  affectsLocations String[]     @default([]) @map("affects_locations")
  isRecurring      Boolean      @default(false) @map("is_recurring")
  recurringPattern String?      @map("recurring_pattern")
  isActive         Boolean      @default(true) @map("is_active")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")
  createdById      String?      @map("created_by_id")
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([organizationId, startDate, endDate])
  @@map("org_blackout_dates")
}

/// PersonCaseAssociation links Person to Case with role labels per ASSOC-02.
/// First-class entity following HubSpot V4 Associations pattern.
///
/// Evidentiary associations (REPORTER, SUBJECT, WITNESS):
/// - Use evidentiaryStatus field (ACTIVE, CLEARED, SUBSTANTIATED, WITHDRAWN)
/// - Never "end" - they are permanent records with changing outcomes
/// - Status changes tracked with timestamp, user, and reason
///
/// Role associations (ASSIGNED_INVESTIGATOR, LEGAL_COUNSEL, etc.):
/// - Use validity periods (startedAt, endedAt)
/// - Can end when person leaves the role
model PersonCaseAssociation {
  id                    String             @id @default(uuid())
  organizationId        String             @map("organization_id")
  personId              String             @map("person_id")
  caseId                String             @map("case_id")
  label                 PersonCaseLabel
  evidentiaryStatus     EvidentiaryStatus? @map("evidentiary_status")
  evidentiaryStatusAt   DateTime?          @map("evidentiary_status_at")
  evidentiaryStatusById String?            @map("evidentiary_status_by_id")
  evidentiaryReason     String?            @map("evidentiary_reason")
  startedAt             DateTime           @default(now()) @map("started_at")
  endedAt               DateTime?          @map("ended_at")
  endedReason           String?            @map("ended_reason")
  notes                 String?
  createdAt             DateTime           @default(now()) @map("created_at")
  createdById           String             @map("created_by_id")
  case                  Case               @relation(fields: [caseId], references: [id], onDelete: Cascade)
  organization          Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person                Person             @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personId, caseId, label])
  @@index([organizationId])
  @@index([organizationId, personId])
  @@index([organizationId, caseId])
  @@index([organizationId, label])
  @@index([organizationId, evidentiaryStatus])
  @@map("person_case_associations")
}

/// PersonRiuAssociation links Person to RIU per ASSOC-01.
/// Tracks who is mentioned in an RIU (reporter, subject, witness).
/// RIUs are immutable, so these associations are created at intake.
model PersonRiuAssociation {
  id             String               @id @default(uuid())
  organizationId String               @map("organization_id")
  personId       String               @map("person_id")
  riuId          String               @map("riu_id")
  label          PersonRiuLabel
  notes          String?
  mentionContext String?              @map("mention_context")
  createdAt      DateTime             @default(now()) @map("created_at")
  createdById    String               @map("created_by_id")
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person         Person               @relation(fields: [personId], references: [id], onDelete: Cascade)
  riu            RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personId, riuId, label])
  @@index([organizationId])
  @@index([organizationId, personId])
  @@index([organizationId, riuId])
  @@map("person_riu_associations")
}

/// CaseCaseAssociation links Case to Case per CONTEXT.md decision.
/// Supports hierarchy (parent/child), splits, escalations, merges.
/// Direction matters: sourceCase -> targetCase with specific label.
model CaseCaseAssociation {
  id             String        @id @default(uuid())
  organizationId String        @map("organization_id")
  sourceCaseId   String        @map("source_case_id")
  targetCaseId   String        @map("target_case_id")
  label          CaseCaseLabel
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  createdById    String        @map("created_by_id")
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceCase     Case          @relation("CaseAssociationSource", fields: [sourceCaseId], references: [id], onDelete: Cascade)
  targetCase     Case          @relation("CaseAssociationTarget", fields: [targetCaseId], references: [id], onDelete: Cascade)

  @@unique([organizationId, sourceCaseId, targetCaseId, label])
  @@index([organizationId])
  @@index([organizationId, sourceCaseId])
  @@index([organizationId, targetCaseId])
  @@map("case_case_associations")
}

/// PersonPersonAssociation tracks relationships between people.
/// Sources: HRIS (manager_of), Disclosure (spouse, business_partner), Investigation.
/// Used for COI detection and relationship mapping.
///
/// For symmetric relationships (spouse, friend), personAId < personBId alphabetically.
/// For asymmetric relationships (manager_of), isDirectional=true with aToB/bToA descriptors.
model PersonPersonAssociation {
  id             String             @id @default(uuid())
  organizationId String             @map("organization_id")
  personAId      String             @map("person_a_id")
  personBId      String             @map("person_b_id")
  label          PersonPersonLabel
  source         PersonPersonSource
  isDirectional  Boolean            @default(false) @map("is_directional")
  aToB           String?            @map("a_to_b")
  bToA           String?            @map("b_to_a")
  effectiveFrom  DateTime           @default(now()) @map("effective_from")
  effectiveUntil DateTime?          @map("effective_until")
  notes          String?
  createdAt      DateTime           @default(now()) @map("created_at")
  createdById    String             @map("created_by_id")
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  personA        Person             @relation("PersonARelation", fields: [personAId], references: [id], onDelete: Cascade)
  personB        Person             @relation("PersonBRelation", fields: [personBId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personAId, personBId, label])
  @@index([organizationId])
  @@index([organizationId, personAId])
  @@index([organizationId, personBId])
  @@index([organizationId, label])
  @@map("person_person_associations")
}

/// AiConversation tracks a conversation session with the AI.
/// Conversations are scoped to organization, user, and optionally an entity.
model AiConversation {
  id                String               @id @default(uuid())
  organizationId    String               @map("organization_id")
  userId            String               @map("user_id")
  entityType        String?              @map("entity_type")
  entityId          String?              @map("entity_id")
  title             String?
  status            AiConversationStatus @default(ACTIVE)
  agentType         String?              @map("agent_type")
  createdAt         DateTime             @default(now()) @map("created_at")
  updatedAt         DateTime             @updatedAt @map("updated_at")
  pausedAt          DateTime?            @map("paused_at")
  archivedAt        DateTime?            @map("archived_at")
  lastMessageAt     DateTime?            @map("last_message_at")
  totalInputTokens  Int                  @default(0) @map("total_input_tokens")
  totalOutputTokens Int                  @default(0) @map("total_output_tokens")
  messages          AiMessage[]

  @@index([organizationId, userId, status])
  @@index([organizationId, entityType, entityId])
  @@index([userId, status])
  @@index([status, lastMessageAt])
  @@map("ai_conversations")
}

/// AiMessage represents a single message in a conversation.
/// Stores both user and assistant messages with optional tool use data.
model AiMessage {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  conversationId String         @map("conversation_id")
  role           String
  content        String
  toolCalls      Json?          @map("tool_calls")
  toolResults    Json?          @map("tool_results")
  inputTokens    Int?           @map("input_tokens")
  outputTokens   Int?           @map("output_tokens")
  model          String?
  createdAt      DateTime       @default(now()) @map("created_at")
  conversation   AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

/// AiContextFile stores CLAUDE.md-like context files for organizations and users.
/// Platform context is stored in code; org/user context is stored in database.
/// Context files enable organization-specific brand voice, terminology, and custom rules.
model AiContextFile {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  userId         String?  @map("user_id")
  name           String
  content        String
  description    String?
  scope          String   @default("org")
  teamId         String?  @map("team_id")
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId, name])
  @@index([organizationId, scope, isActive])
  @@index([userId, isActive])
  @@map("ai_context_files")
}

/// AiUsage tracks token consumption per organization for billing and analytics.
/// Each record represents a single AI API call with its token counts.
model AiUsage {
  id               String   @id @default(uuid())
  organizationId   String   @map("organization_id")
  userId           String?  @map("user_id")
  inputTokens      Int      @map("input_tokens")
  outputTokens     Int      @map("output_tokens")
  cacheReadTokens  Int      @default(0) @map("cache_read_tokens")
  cacheWriteTokens Int      @default(0) @map("cache_write_tokens")
  model            String
  provider         String   @default("claude")
  featureType      String?  @map("feature_type")
  entityType       String?  @map("entity_type")
  entityId         String?  @map("entity_id")
  durationMs       Int?     @map("duration_ms")
  timestamp        DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([organizationId, featureType])
  @@index([userId, timestamp])
  @@map("ai_usage")
}

/// PromptTemplate stores versioned prompt templates.
/// Allows A/B testing, rollback, and organization-specific overrides.
model PromptTemplate {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id")
  name           String
  version        Int      @default(1)
  content        String
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  variables      Json?
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, name, version])
  @@index([organizationId, name, isActive])
  @@index([name, isActive])
  @@map("prompt_templates")
}

/// AiRateLimit stores per-organization rate limit configuration.
/// Allows customizing limits per customer tier.
model AiRateLimit {
  id                String   @id @default(uuid())
  organizationId    String   @unique @map("organization_id")
  requestsPerMinute Int      @default(60) @map("requests_per_minute")
  tokensPerMinute   Int      @default(100000) @map("tokens_per_minute")
  requestsPerDay    Int      @default(10000) @map("requests_per_day")
  tokensPerDay      Int      @default(5000000) @map("tokens_per_day")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("ai_rate_limits")
}

/// AiQueryHistory logs natural language queries for analytics and auditing.
/// Used to track AI query patterns, improve suggestions, and debug issues.
model AiQueryHistory {
  id                String   @id @default(uuid())
  organizationId    String   @map("organization_id")
  userId            String   @map("user_id")
  query             String
  parsedQuery       Json
  visualizationType String   @map("visualization_type")
  resultSummary     String?  @map("result_summary")
  processingTimeMs  Int      @map("processing_time_ms")
  inputTokens       Int?     @map("input_tokens")
  outputTokens      Int?     @map("output_tokens")
  createdAt         DateTime @default(now()) @map("created_at")

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@map("ai_query_history")
}

/// AiAction records AI-initiated mutations for audit and undo capability.
/// Actions have configurable undo windows based on their severity.
model AiAction {
  id                String         @id @default(uuid())
  organizationId    String         @map("organization_id")
  conversationId    String?        @map("conversation_id")
  userId            String         @map("user_id")
  actionType        String         @map("action_type")
  entityType        String         @map("entity_type")
  entityId          String         @map("entity_id")
  input             Json
  result            Json?
  previousState     Json?          @map("previous_state")
  status            AiActionStatus @default(PENDING)
  error             String?
  undoWindowSeconds Int?           @map("undo_window_seconds")
  undoExpiresAt     DateTime?      @map("undo_expires_at")
  createdAt         DateTime       @default(now()) @map("created_at")
  executedAt        DateTime?      @map("executed_at")
  completedAt       DateTime?      @map("completed_at")
  undoneAt          DateTime?      @map("undone_at")
  undoneByUserId    String?        @map("undone_by_user_id")

  @@index([organizationId, entityType, entityId])
  @@index([organizationId, userId])
  @@index([conversationId])
  @@index([status, undoExpiresAt])
  @@map("ai_actions")
}

/// CustomPropertyDefinition defines tenant-configurable fields for Cases, Investigations, and Persons.
/// Properties allow organizations to capture industry-specific or compliance-specific data.
model CustomPropertyDefinition {
  id              String                   @id @default(uuid())
  organizationId  String                   @map("organization_id")
  entityType      CustomPropertyEntityType @map("entity_type")
  name            String
  key             String
  description     String?
  dataType        PropertyDataType         @map("data_type")
  isRequired      Boolean                  @default(false) @map("is_required")
  defaultValue    Json?                    @map("default_value")
  options         Json?
  validationRules Json?                    @map("validation_rules")
  displayOrder    Int                      @default(0) @map("display_order")
  groupName       String?                  @map("group_name")
  isVisible       Boolean                  @default(true) @map("is_visible")
  helpText        String?                  @map("help_text")
  placeholder     String?
  width           String?
  isActive        Boolean                  @default(true) @map("is_active")
  createdAt       DateTime                 @default(now()) @map("created_at")
  updatedAt       DateTime                 @updatedAt @map("updated_at")
  createdById     String                   @map("created_by_id")
  organization    Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, entityType, key])
  @@index([organizationId, entityType])
  @@index([organizationId, entityType, isActive])
  @@map("custom_property_definitions")
}

/// RemediationPlan tracks post-investigation remediation activities.
/// Plans continue independently after case closure for complete audit trail.
/// Each plan is linked to a case and optionally to a specific finding.
model RemediationPlan {
  id                 String            @id @default(uuid())
  organizationId     String            @map("organization_id")
  caseId             String            @map("case_id")
  findingId          String?           @map("finding_id")
  findingDescription String?           @map("finding_description")
  title              String
  description        String?
  templateId         String?           @map("template_id")
  templateVersion    Int?              @map("template_version")
  status             RemediationStatus @default(DRAFT)
  dueDate            DateTime?         @map("due_date")
  completedAt        DateTime?         @map("completed_at")
  completedById      String?           @map("completed_by_id")
  totalSteps         Int               @default(0) @map("total_steps")
  completedSteps     Int               @default(0) @map("completed_steps")
  overdueSteps       Int               @default(0) @map("overdue_steps")
  ownerId            String            @map("owner_id")
  createdAt          DateTime          @default(now()) @map("created_at")
  updatedAt          DateTime          @updatedAt @map("updated_at")
  createdById        String            @map("created_by_id")
  case               Case              @relation(fields: [caseId], references: [id], onDelete: Cascade)
  organization       Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  steps              RemediationStep[]

  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, status])
  @@index([organizationId, ownerId])
  @@index([organizationId, dueDate])
  @@map("remediation_plans")
}

/// RemediationStep represents individual tasks within a remediation plan.
/// Steps can be assigned to internal users OR external contacts via email.
/// Dependencies form a DAG (directed acyclic graph) for ordering.
model RemediationStep {
  id                 String          @id @default(uuid())
  planId             String          @map("plan_id")
  organizationId     String          @map("organization_id")
  order              Int
  title              String
  description        String?
  dueDate            DateTime?       @map("due_date")
  assigneeUserId     String?         @map("assignee_user_id")
  assigneeEmail      String?         @map("assignee_email")
  assigneeName       String?         @map("assignee_name")
  status             StepStatus      @default(PENDING)
  requiresCoApproval Boolean         @default(false) @map("requires_co_approval")
  completedAt        DateTime?       @map("completed_at")
  completedById      String?         @map("completed_by_id")
  completionNotes    String?         @map("completion_notes")
  completionEvidence Json?           @map("completion_evidence")
  approvedById       String?         @map("approved_by_id")
  approvedAt         DateTime?       @map("approved_at")
  approvalNotes      String?         @map("approval_notes")
  dependsOnStepIds   String[]        @default([]) @map("depends_on_step_ids")
  reminderSentAt     DateTime?       @map("reminder_sent_at")
  escalatedAt        DateTime?       @map("escalated_at")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  plan               RemediationPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([organizationId])
  @@index([organizationId, assigneeUserId])
  @@index([organizationId, status, dueDate])
  @@map("remediation_steps")
}

/// RemediationTemplate provides reusable remediation plans.
/// Templates store step configurations that are applied when creating new plans.
model RemediationTemplate {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  name           String
  description    String?
  categoryId     String?      @map("category_id")
  steps          Json
  isActive       Boolean      @default(true) @map("is_active")
  isSystem       Boolean      @default(false) @map("is_system")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  createdById    String       @map("created_by_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, categoryId])
  @@map("remediation_templates")
}

/// SavedView persists user-created filtered views for quick access.
/// Users can save filter combinations, column layouts, and sort preferences.
/// Views can be personal or shared with the organization.
model SavedView {
  id                String         @id @default(uuid())
  organizationId    String         @map("organization_id")
  createdById       String         @map("created_by_id")
  isShared          Boolean        @default(false) @map("is_shared")
  sharedWithTeamId  String?        @map("shared_with_team_id")
  name              String
  description       String?
  entityType        ViewEntityType @map("entity_type")
  filters           Json
  sortBy            String?        @map("sort_by")
  sortOrder         String?        @map("sort_order")
  columns           Json?
  isDefault         Boolean        @default(false) @map("is_default")
  isPinned          Boolean        @default(false) @map("is_pinned")
  displayOrder      Int            @default(0) @map("display_order")
  color             String?
  lastUsedAt        DateTime?      @map("last_used_at")
  useCount          Int            @default(0) @map("use_count")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  boardGroupBy      String?        @map("board_group_by")
  frozenColumnCount Int            @default(0) @map("frozen_column_count")
  recordCount       Int?           @map("record_count")
  recordCountAt     DateTime?      @map("record_count_at")
  viewMode          String         @default("table") @map("view_mode")
  organization      Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, createdById, entityType, name])
  @@index([organizationId, createdById])
  @@index([organizationId, entityType])
  @@index([organizationId, isShared])
  @@map("saved_views")
}

/// InvestigationTemplate defines reusable investigation checklists.
/// Templates standardize investigation processes while allowing customization.
/// Supports versioning (version-on-publish pattern) and export/import for sharing.
model InvestigationTemplate {
  id                 String                           @id @default(uuid())
  organizationId     String                           @map("organization_id")
  name               String
  description        String?
  categoryId         String?                          @map("category_id")
  tier               TemplateTier                     @default(PERSONAL)
  createdById        String                           @map("created_by_id")
  sharedWithTeamId   String?                          @map("shared_with_team_id")
  version            Int                              @default(1)
  isActive           Boolean                          @default(true) @map("is_active")
  isArchived         Boolean                          @default(false) @map("is_archived")
  isDefault          Boolean                          @default(false) @map("is_default")
  sections           Json
  suggestedDurations Json?                            @map("suggested_durations")
  conditionalRules   Json?                            @map("conditional_rules")
  isSystemTemplate   Boolean                          @default(false) @map("is_system_template")
  sourceTemplateId   String?                          @map("source_template_id")
  usageCount         Int                              @default(0) @map("usage_count")
  createdAt          DateTime                         @default(now()) @map("created_at")
  updatedAt          DateTime                         @updatedAt @map("updated_at")
  categoryMappings   CategoryTemplateMapping[]
  checklistInstances InvestigationChecklistProgress[]
  organization       Organization                     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name, version])
  @@index([organizationId, tier])
  @@index([organizationId, categoryId])
  @@index([organizationId, isActive, isArchived])
  @@map("investigation_templates")
}

/// CategoryTemplateMapping links categories to investigation templates.
/// Enables auto-assignment of templates based on case/investigation category.
/// Multiple templates can map to a category with different requirement levels.
model CategoryTemplateMapping {
  id             String                @id @default(uuid())
  organizationId String                @map("organization_id")
  categoryId     String                @map("category_id")
  templateId     String                @map("template_id")
  requirement    TemplateRequirement   @default(RECOMMENDED)
  priority       Int                   @default(0)
  isActive       Boolean               @default(true) @map("is_active")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  createdById    String                @map("created_by_id")
  category       Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template       InvestigationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([organizationId, categoryId, templateId])
  @@index([organizationId, categoryId])
  @@map("category_template_mappings")
}

/// InvestigationChecklistProgress tracks per-investigation completion of checklist items.
/// Each investigation can have one checklist progress record, capturing the template version
/// at creation time (immutable) and all item/section states.
/// Supports custom items added by investigators and skipped items with reasons.
model InvestigationChecklistProgress {
  id              String                @id @default(uuid())
  investigationId String                @unique @map("investigation_id")
  organizationId  String                @map("organization_id")
  templateId      String                @map("template_id")
  templateVersion Int                   @map("template_version")
  itemStates      Json                  @map("item_states")
  sectionStates   Json                  @map("section_states")
  customItems     Json?                 @map("custom_items")
  skippedItems    Json?                 @map("skipped_items")
  itemOrder       Json?                 @map("item_order")
  totalItems      Int                   @map("total_items")
  completedItems  Int                   @default(0) @map("completed_items")
  skippedCount    Int                   @default(0) @map("skipped_count")
  customCount     Int                   @default(0) @map("custom_count")
  progressPercent Int                   @default(0) @map("progress_percent")
  startedAt       DateTime?             @map("started_at")
  completedAt     DateTime?             @map("completed_at")
  lastActivityAt  DateTime?             @map("last_activity_at")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  investigation   Investigation         @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template        InvestigationTemplate @relation(fields: [templateId], references: [id])

  @@index([organizationId])
  @@index([organizationId, templateId])
  @@map("investigation_checklist_progress")
}

/// Notification represents a single notification record sent to a user.
/// Notifications can be delivered via email or in-app channels.
/// Scoped to organization for RLS compliance.
model Notification {
  id             String                @id @default(uuid())
  organizationId String                @map("organization_id")
  userId         String                @map("user_id")
  channel        NotificationChannel
  type           NotificationType
  status         NotificationStatus    @default(QUEUED)
  title          String
  body           String?
  entityType     String?               @map("entity_type")
  entityId       String?               @map("entity_id")
  templateId     String?               @map("template_id")
  isRead         Boolean               @default(false) @map("is_read")
  readAt         DateTime?             @map("read_at")
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  delivery       NotificationDelivery?
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, userId])
  @@index([organizationId, userId, isRead])
  @@index([organizationId, userId, createdAt])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@map("notifications")
}

/// NotificationDelivery tracks email delivery status for notifications.
/// One-to-one with Notification when channel is EMAIL.
model NotificationDelivery {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  notificationId String         @unique @map("notification_id")
  messageId      String?        @map("message_id")
  status         DeliveryStatus @default(PENDING)
  attempts       Int            @default(0)
  lastAttemptAt  DateTime?      @map("last_attempt_at")
  errorMessage   String?        @map("error_message")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  notification   Notification   @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([status])
  @@index([messageId])
  @@map("notification_deliveries")
}

/// NotificationPreference stores user-level notification preferences.
/// Each user has one preference record per organization.
/// Preferences JSON stores per-category settings: { categoryName: { email: bool, inApp: bool } }
model NotificationPreference {
  id              String       @id @default(uuid())
  organizationId  String       @map("organization_id")
  userId          String       @unique @map("user_id")
  preferences     Json         @default("{}")
  quietHoursStart String?      @map("quiet_hours_start")
  quietHoursEnd   String?      @map("quiet_hours_end")
  timezone        String       @default("UTC")
  backupUserId    String?      @map("backup_user_id")
  oooUntil        DateTime?    @map("ooo_until")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  backupUser      User?        @relation("BackupUser", fields: [backupUserId], references: [id])
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@map("notification_preferences")
}

/// OrgNotificationSettings stores organization-level notification configuration.
/// One record per organization defining enforced categories and defaults.
model OrgNotificationSettings {
  id                     String       @id @default(uuid())
  organizationId         String       @unique @map("organization_id")
  enforcedCategories     String[]     @default([]) @map("enforced_categories")
  defaultQuietHoursStart String?      @map("default_quiet_hours_start")
  defaultQuietHoursEnd   String?      @map("default_quiet_hours_end")
  digestTime             String       @default("17:00") @map("digest_time")
  createdAt              DateTime     @default(now()) @map("created_at")
  updatedAt              DateTime     @updatedAt @map("updated_at")
  organization           Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("org_notification_settings")
}

/// EmailTemplate stores versioned MJML email templates.
/// Allows organization-specific overrides with version history.
model EmailTemplate {
  id              String       @id @default(uuid())
  organizationId  String       @map("organization_id")
  name            String
  version         Int          @default(1)
  mjmlContent     String       @map("mjml_content")
  subjectTemplate String       @map("subject_template")
  description     String?
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name, version])
  @@index([organizationId, name, isActive])
  @@index([name, isActive])
  @@map("email_templates")
}

/// DigestQueue stores pending notifications for daily digest compilation.
/// Processed by DigestService (07-06) to batch low-priority notifications.
model DigestQueue {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  type           String
  entityType     String?      @map("entity_type")
  entityId       String?      @map("entity_id")
  metadata       Json         @default("{}")
  processed      Boolean      @default(false)
  processedAt    DateTime?    @map("processed_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation("DigestQueueUser", fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId, userId, processed])
  @@index([processed, createdAt])
  @@map("digest_queue")
}

/// HotlineNumber maps phone numbers to organizations for operator lookup.
/// When a call comes in, operators can identify the client by phone number.
/// Phone numbers are stored in E.164 format (e.g., "+18005551234").
model HotlineNumber {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  phoneNumber    String       @unique @map("phone_number")
  displayName    String?      @map("display_name")
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([phoneNumber])
  @@map("hotline_numbers")
}

/// ClientQaConfig stores per-organization QA review configuration.
/// Determines how incoming reports are routed for quality assurance.
model ClientQaConfig {
  id                 String       @id @default(uuid())
  organizationId     String       @unique @map("organization_id")
  defaultMode        QaMode       @default(ALL) @map("default_mode")
  samplePercentage   Int?         @map("sample_percentage")
  highRiskCategories String[]     @default([]) @map("high_risk_categories")
  keywordTriggers    String[]     @default([]) @map("keyword_triggers")
  categoryOverrides  Json         @default("{}") @map("category_overrides")
  createdAt          DateTime     @default(now()) @map("created_at")
  updatedAt          DateTime     @updatedAt @map("updated_at")
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("client_qa_configs")
}

/// ClientDirective stores client-specific scripts that operators read during calls.
/// Directives can be opening statements, category-specific guidance, or closing scripts.
/// Organizations configure these to ensure operators follow legal/compliance requirements.
/// Example: "HIPAA Disclosure Warning" read verbatim during healthcare-related calls.
model ClientDirective {
  id             String         @id @default(uuid())
  organizationId String         @map("organization_id")
  stage          DirectiveStage
  categoryId     String?        @map("category_id")
  title          String
  content        String
  isReadAloud    Boolean        @default(false) @map("is_read_aloud")
  order          Int            @default(0)
  isActive       Boolean        @default(true) @map("is_active")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @updatedAt @map("updated_at")
  category       Category?      @relation(fields: [categoryId], references: [id])
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, stage])
  @@index([organizationId, categoryId])
  @@index([organizationId, isActive])
  @@map("client_directives")
}

/// TenantBranding stores per-tenant portal customization settings.
/// Enables white-label branding for Ethics Portal and other customer-facing portals.
///
/// For TEMPLATE mode:
/// - Only logoUrl, primaryColor, and theme are used
/// - Colors are derived from primaryColor
///
/// For FULL_WHITE_LABEL mode:
/// - Full colorPalette with 12 HSL tokens
/// - Custom typography (fontFamily, headingFontFamily)
/// - Custom domain support
model TenantBranding {
  id              String       @id @default(uuid())
  organizationId  String       @unique @map("organization_id")
  mode            BrandingMode @default(TEMPLATE)
  logoUrl         String?      @map("logo_url")
  primaryColor    String?      @map("primary_color")
  theme           ThemeMode    @default(LIGHT)
  colorPalette    Json?        @map("color_palette")
  typography      Json?
  customDomain    String?      @unique @map("custom_domain")
  footerText      String?      @map("footer_text")
  welcomeVideoUrl String?      @map("welcome_video_url")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([customDomain])
  @@map("tenant_branding")
}

/// ThresholdRule defines auto-case creation rules for disclosure thresholds (RS.35-RS.38).
/// Enables compliance officers to configure policy-driven automation with multi-dimensional
/// rolling window aggregates. Rules can trigger different actions based on disclosure values.
model ThresholdRule {
  id              String                @id @default(uuid())
  organizationId  String                @map("organization_id")
  name            String
  description     String?
  disclosureTypes DisclosureType[]
  conditions      Json
  aggregateConfig Json?                 @map("aggregate_config")
  action          ThresholdAction
  actionConfig    Json?                 @map("action_config")
  applyMode       ThresholdApplyMode    @default(FORWARD_ONLY) @map("apply_mode")
  priority        Int                   @default(0)
  isActive        Boolean               @default(true) @map("is_active")
  createdById     String                @map("created_by_id")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  createdBy       User                  @relation(fields: [createdById], references: [id])
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  triggers        ThresholdTriggerLog[]

  @@index([organizationId, isActive])
  @@index([organizationId, disclosureTypes])
  @@map("threshold_rules")
}

/// ThresholdTriggerLog records when threshold rules fire for audit and analytics.
/// Tracks the disclosure that triggered the rule, evaluated values, and action taken.
model ThresholdTriggerLog {
  id                 String          @id @default(uuid())
  organizationId     String          @map("organization_id")
  ruleId             String          @map("rule_id")
  disclosureId       String          @map("disclosure_id")
  personId           String          @map("person_id")
  evaluatedValue     Decimal         @map("evaluated_value") @db.Decimal(12, 2)
  thresholdValue     Decimal         @map("threshold_value") @db.Decimal(12, 2)
  aggregateBreakdown Json?           @map("aggregate_breakdown")
  actionTaken        ThresholdAction @map("action_taken")
  caseId             String?         @map("case_id")
  triggeredAt        DateTime        @default(now()) @map("triggered_at")
  case               Case?           @relation(fields: [caseId], references: [id])
  rule               ThresholdRule   @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@index([organizationId, ruleId])
  @@index([organizationId, personId])
  @@index([organizationId, triggeredAt])
  @@map("threshold_trigger_logs")
}

/// ConflictAlert stores detected potential conflicts on disclosures.
/// Created automatically during disclosure submission when matching rules trigger.
/// RS.41-RS.43: Cross-system conflict detection with contextual presentation.
model ConflictAlert {
  id                String                 @id @default(uuid())
  organizationId    String                 @map("organization_id")
  disclosureId      String                 @map("disclosure_id")
  conflictType      ConflictType           @map("conflict_type")
  severity          ConflictSeverity
  status            ConflictStatus         @default(OPEN)
  summary           String
  matchedEntity     String                 @map("matched_entity")
  matchConfidence   Float                  @map("match_confidence")
  matchDetails      Json                   @map("match_details")
  severityFactors   Json?                  @map("severity_factors")
  dismissedCategory String?                @map("dismissed_category")
  dismissedReason   String?                @map("dismissed_reason")
  dismissedBy       String?                @map("dismissed_by")
  dismissedAt       DateTime?              @map("dismissed_at")
  escalatedToCaseId String?                @map("escalated_to_case_id")
  exclusionId       String?                @map("exclusion_id")
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  disclosure        RiuDisclosureExtension @relation(fields: [disclosureId], references: [riuId], onDelete: Cascade)
  dismissedByUser   User?                  @relation("ConflictAlertDismissedBy", fields: [dismissedBy], references: [id])
  escalatedCase     Case?                  @relation(fields: [escalatedToCaseId], references: [id])
  exclusion         ConflictExclusion?     @relation(fields: [exclusionId], references: [id])
  organization      Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([disclosureId])
  @@index([matchedEntity])
  @@map("conflict_alerts")
}

/// DisclosureFormTemplate extends FormDefinition for disclosure-specific needs.
/// Supports compliance-specific field types, versioning, and translations.
/// RS.22-RS.29: Form schema engine with nested repeaters and calculated fields.
/// RS.32: Versioning with published snapshots.
/// RS.33: Translation support via parent-child model.
model DisclosureFormTemplate {
  id               String                   @id @default(uuid())
  organizationId   String                   @map("organization_id")
  name             String
  description      String?
  disclosureType   DisclosureFormType       @map("disclosure_type")
  version          Int                      @default(1)
  status           FormTemplateStatus       @default(DRAFT)
  publishedAt      DateTime?                @map("published_at")
  publishedBy      String?                  @map("published_by")
  parentTemplateId String?                  @map("parent_template_id")
  language         String                   @default("en")
  fields           Json
  sections         Json
  validationRules  Json?                    @map("validation_rules")
  calculatedFields Json?                    @map("calculated_fields")
  uiSchema         Json?                    @map("ui_schema")
  isSystem         Boolean                  @default(false) @map("is_system")
  createdById      String                   @map("created_by_id")
  createdAt        DateTime                 @default(now()) @map("created_at")
  updatedAt        DateTime                 @updatedAt @map("updated_at")
  campaigns        Campaign[]               @relation("CampaignFormTemplate")
  disclosureDrafts DisclosureDraft[]
  createdBy        User                     @relation("FormTemplateCreator", fields: [createdById], references: [id])
  organization     Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentTemplate   DisclosureFormTemplate?  @relation("FormTranslations", fields: [parentTemplateId], references: [id])
  translations     DisclosureFormTemplate[] @relation("FormTranslations")
  disclosures      RiuDisclosureExtension[]

  @@unique([organizationId, name, version])
  @@index([organizationId, disclosureType])
  @@index([organizationId, status])
  @@index([parentTemplateId])
  @@map("disclosure_form_templates")
}

/// ConflictExclusion suppresses future false positive conflict alerts.
/// RS.44: Categorized dismissals with exclusion list management.
model ConflictExclusion {
  id                 String          @id @default(uuid())
  organizationId     String          @map("organization_id")
  personId           String          @map("person_id")
  matchedEntity      String          @map("matched_entity")
  conflictType       ConflictType    @map("conflict_type")
  createdFromAlertId String?         @map("created_from_alert_id")
  reason             String
  notes              String?
  scope              ExclusionScope  @default(PERMANENT)
  expiresAt          DateTime?       @map("expires_at")
  isActive           Boolean         @default(true) @map("is_active")
  createdBy          String          @map("created_by")
  createdAt          DateTime        @default(now()) @map("created_at")
  updatedAt          DateTime        @updatedAt @map("updated_at")
  alerts             ConflictAlert[]
  createdByUser      User            @relation("ExclusionCreatedBy", fields: [createdBy], references: [id])
  organization       Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person             Person          @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personId, matchedEntity, conflictType])
  @@index([organizationId, isActive])
  @@index([personId])
  @@map("conflict_exclusions")
}

/// UserDataTable stores user-created custom data tables.
/// RS.48: Dual-path table creation (manual builder + AI-generated) with
/// save destinations and scheduled delivery.
///
/// Tables can be:
/// - Created via manual builder UI with column/filter selection
/// - Generated via AI from natural language prompts
/// - Imported from external sources
///
/// Tables support:
/// - Multi-source data queries
/// - Aggregations and grouping
/// - Pinning to dashboards
/// - Scheduled email delivery (CSV, Excel, PDF)
/// - Sharing with teams or organization-wide
model UserDataTable {
  id               String              @id @default(uuid())
  organizationId   String              @map("organization_id")
  name             String
  description      String?
  createdVia       TableCreationMethod @default(BUILDER) @map("created_via")
  aiPrompt         String?             @map("ai_prompt")
  createdById      String              @map("created_by_id")
  dataSources      String[]            @default([]) @map("data_sources")
  columns          Json
  filters          Json                @default("[]")
  groupBy          String[]            @default([]) @map("group_by")
  aggregates       Json?               @default("[]")
  sortBy           Json?               @default("[]") @map("sort_by")
  destinations     Json                @default("[]")
  visibility       TableVisibility     @default(PRIVATE)
  sharedWithTeams  String[]            @default([]) @map("shared_with_teams")
  sharedWithUsers  String[]            @default([]) @map("shared_with_users")
  scheduleConfig   Json?               @map("schedule_config")
  nextScheduledRun DateTime?           @map("next_scheduled_run")
  lastExecutedAt   DateTime?           @map("last_executed_at")
  cachedResults    Json?               @map("cached_results")
  cacheExpiresAt   DateTime?           @map("cache_expires_at")
  deletedAt        DateTime?           @map("deleted_at")
  createdAt        DateTime            @default(now()) @map("created_at")
  updatedAt        DateTime            @updatedAt @map("updated_at")
  createdBy        User                @relation("UserDataTableCreatedBy", fields: [createdById], references: [id])
  organization     Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, createdById])
  @@index([organizationId, visibility])
  @@index([nextScheduledRun])
  @@index([deletedAt])
  @@map("user_data_tables")
}

/// Policy represents a corporate policy document with draft/published lifecycle.
/// Policies have versions - each publish creates an immutable PolicyVersion snapshot.
/// draft content is mutable until published; published versions are immutable.
model Policy {
  id               String                  @id @default(uuid())
  organizationId   String                  @map("organization_id")
  title            String
  slug             String
  policyType       PolicyType              @map("policy_type")
  category         String?
  status           PolicyStatus            @default(DRAFT)
  currentVersion   Int                     @default(0) @map("current_version")
  draftContent     String?                 @map("draft_content")
  draftUpdatedAt   DateTime?               @map("draft_updated_at")
  draftUpdatedById String?                 @map("draft_updated_by_id")
  ownerId          String                  @map("owner_id")
  effectiveDate    DateTime?               @map("effective_date")
  reviewDate       DateTime?               @map("review_date")
  retiredAt        DateTime?               @map("retired_at")
  createdAt        DateTime                @default(now()) @map("created_at")
  updatedAt        DateTime                @updatedAt @map("updated_at")
  createdById      String                  @map("created_by_id")
  campaigns        Campaign[]              @relation("PolicyCampaigns")
  createdBy        User                    @relation("PolicyCreatedBy", fields: [createdById], references: [id])
  draftUpdatedBy   User?                   @relation("PolicyDraftUpdatedBy", fields: [draftUpdatedById], references: [id])
  organization     Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner            User                    @relation("PolicyOwner", fields: [ownerId], references: [id])
  caseAssociations PolicyCaseAssociation[]
  versions         PolicyVersion[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, policyType])
  @@index([organizationId, ownerId])
  @@index([organizationId, reviewDate])
  @@map("policies")
}

/// PolicyVersion stores immutable published snapshots of a policy.
/// Each time a policy is published, a new version is created.
/// Content is immutable - corrections require a new version.
model PolicyVersion {
  id               String                     @id @default(uuid())
  organizationId   String                     @map("organization_id")
  policyId         String                     @map("policy_id")
  version          Int
  versionLabel     String?                    @map("version_label")
  content          String
  plainText        String                     @map("plain_text")
  summary          String?
  changeNotes      String?                    @map("change_notes")
  publishedAt      DateTime                   @map("published_at")
  publishedById    String                     @map("published_by_id")
  effectiveDate    DateTime                   @map("effective_date")
  isLatest         Boolean                    @default(true) @map("is_latest")
  campaigns        Campaign[]                 @relation("PolicyVersionCampaigns")
  caseAssociations PolicyCaseAssociation[]
  translations     PolicyVersionTranslation[]
  organization     Organization               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  policy           Policy                     @relation(fields: [policyId], references: [id], onDelete: Cascade)
  publishedBy      User                       @relation("PolicyVersionPublishedBy", fields: [publishedById], references: [id])

  @@unique([policyId, version])
  @@index([organizationId])
  @@index([organizationId, policyId])
  @@index([organizationId, isLatest])
  @@index([organizationId, publishedAt])
  @@map("policy_versions")
}

/// PolicyVersionTranslation stores translated content for a specific policy version.
/// Translations can be AI-generated, human-translated, or imported.
/// Tracks review status and staleness when source content changes.
model PolicyVersionTranslation {
  id              String                  @id @default(uuid())
  organizationId  String                  @map("organization_id")
  policyVersionId String                  @map("policy_version_id")
  languageCode    String                  @map("language_code")
  languageName    String                  @map("language_name")
  title           String
  content         String
  plainText       String                  @map("plain_text")
  translatedBy    TranslationSource       @default(AI) @map("translated_by")
  aiModel         String?                 @map("ai_model")
  reviewStatus    TranslationReviewStatus @default(PENDING_REVIEW) @map("review_status")
  reviewedAt      DateTime?               @map("reviewed_at")
  reviewedById    String?                 @map("reviewed_by_id")
  reviewNotes     String?                 @map("review_notes")
  isStale         Boolean                 @default(false) @map("is_stale")
  createdAt       DateTime                @default(now()) @map("created_at")
  updatedAt       DateTime                @updatedAt @map("updated_at")
  organization    Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  policyVersion   PolicyVersion           @relation(fields: [policyVersionId], references: [id], onDelete: Cascade)
  reviewedBy      User?                   @relation("PolicyTranslationReviewer", fields: [reviewedById], references: [id])

  @@unique([policyVersionId, languageCode])
  @@index([organizationId])
  @@index([organizationId, languageCode])
  @@index([organizationId, reviewStatus])
  @@index([organizationId, isStale])
  @@map("policy_version_translations")
}

/// PolicyCaseAssociation links policies to cases for violation tracking.
/// A case can reference multiple policies; a policy can be linked to multiple cases.
/// Supports different link types: violation (policy was violated), reference (case mentions policy),
/// or governing (policy governs the situation).
model PolicyCaseAssociation {
  id              String             @id @default(uuid())
  organizationId  String             @map("organization_id")
  policyId        String             @map("policy_id")
  policyVersionId String?            @map("policy_version_id")
  caseId          String             @map("case_id")
  linkType        PolicyCaseLinkType @map("link_type")
  linkReason      String?            @map("link_reason")
  violationDate   DateTime?          @map("violation_date")
  createdAt       DateTime           @default(now()) @map("created_at")
  createdById     String             @map("created_by_id")
  case            Case               @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy       User               @relation("PolicyCaseAssociationCreatedBy", fields: [createdById], references: [id])
  organization    Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  policy          Policy             @relation(fields: [policyId], references: [id], onDelete: Cascade)
  policyVersion   PolicyVersion?     @relation(fields: [policyVersionId], references: [id])

  @@unique([policyId, caseId])
  @@index([organizationId])
  @@index([organizationId, policyId])
  @@index([organizationId, caseId])
  @@index([organizationId, linkType])
  @@map("policy_case_associations")
}

/// MigrationJob tracks a single data import operation from competitor systems.
/// Supports validation, field mapping, preview, import, and 7-day rollback.
model MigrationJob {
  id                     String              @id @default(uuid())
  organizationId         String              @map("organization_id")
  sourceType             MigrationSourceType @map("source_type")
  fileName               String              @map("file_name")
  fileUrl                String              @map("file_url")
  fileSizeBytes          Int                 @map("file_size_bytes")
  status                 MigrationJobStatus  @default(PENDING)
  progress               Int                 @default(0)
  currentStep            String?             @map("current_step")
  totalRows              Int?                @map("total_rows")
  validRows              Int?                @map("valid_rows")
  errorRows              Int?                @map("error_rows")
  importedRows           Int                 @default(0) @map("imported_rows")
  fieldMappings          Json?               @map("field_mappings")
  validationErrors       Json?               @map("validation_errors")
  previewData            Json?               @map("preview_data")
  rollbackAvailableUntil DateTime?           @map("rollback_available_until")
  rolledBackAt           DateTime?           @map("rolled_back_at")
  rolledBackById         String?             @map("rolled_back_by_id")
  errorMessage           String?             @map("error_message")
  errorDetails           Json?               @map("error_details")
  createdAt              DateTime            @default(now()) @map("created_at")
  completedAt            DateTime?           @map("completed_at")
  createdById            String              @map("created_by_id")
  createdBy              User                @relation("MigrationJobCreatedBy", fields: [createdById], references: [id])
  organization           Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  migrationRecords       MigrationRecord[]

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@map("migration_jobs")
}

/// MigrationFieldTemplate stores reusable field mapping configurations.
/// Templates are scoped by organization and source type for reuse across imports.
model MigrationFieldTemplate {
  id             String              @id @default(uuid())
  organizationId String              @map("organization_id")
  name           String
  sourceType     MigrationSourceType @map("source_type")
  mappings       Json
  createdAt      DateTime            @default(now()) @map("created_at")
  updatedAt      DateTime            @updatedAt @map("updated_at")
  createdById    String              @map("created_by_id")
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, sourceType, name])
  @@index([organizationId, sourceType])
  @@map("migration_field_templates")
}

/// MigrationRecord tracks individual records created during import for rollback.
/// Links imported entities back to their migration job and source row.
model MigrationRecord {
  id                  String       @id @default(uuid())
  organizationId      String       @map("organization_id")
  migrationJobId      String       @map("migration_job_id")
  entityType          String       @map("entity_type")
  entityId            String       @map("entity_id")
  sourceRowNumber     Int          @map("source_row_number")
  sourceData          Json         @map("source_data")
  createdAt           DateTime     @default(now()) @map("created_at")
  modifiedAfterImport Boolean      @default(false) @map("modified_after_import")
  migrationJob        MigrationJob @relation(fields: [migrationJobId], references: [id], onDelete: Cascade)
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([migrationJobId])
  @@index([entityType, entityId])
  @@map("migration_records")
}

/// ReportFieldTag allows admins to configure which custom fields appear as named columns
/// in flat file exports. Up to 20 tag slots per organization.
/// This enables non-technical admins to promote custom fields or form responses
/// to fixed columns for board reporting and BI tools.
model ReportFieldTag {
  id               String           @id @default(uuid())
  organizationId   String           @map("organization_id")
  sourceEntityType ExportSourceType @map("source_entity_type")
  sourceFieldPath  String           @map("source_field_path")
  templateId       String?          @map("template_id")
  tagSlot          Int              @map("tag_slot")
  columnName       String           @map("column_name")
  displayLabel     String           @map("display_label")
  dataType         ExportDataType   @map("data_type")
  formatPattern    String?          @map("format_pattern")
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  createdById      String           @map("created_by_id")
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, tagSlot])
  @@unique([organizationId, sourceEntityType, sourceFieldPath, templateId])
  @@index([organizationId])
  @@map("report_field_tags")
}

/// ExportJob tracks async flat file export jobs.
/// Large exports run in background via BullMQ and upload to Azure Blob.
/// Files auto-expire after 7 days.
model ExportJob {
  id             String          @id @default(uuid())
  organizationId String          @map("organization_id")
  exportType     ExportType      @map("export_type")
  format         ExportFormat
  filters        Json
  columns        Json
  status         ExportJobStatus @default(PENDING)
  progress       Int             @default(0)
  totalRows      Int?            @map("total_rows")
  processedRows  Int             @default(0) @map("processed_rows")
  fileUrl        String?         @map("file_url")
  fileSizeBytes  Int?            @map("file_size_bytes")
  expiresAt      DateTime?       @map("expires_at")
  errorMessage   String?         @map("error_message")
  errorDetails   Json?           @map("error_details")
  createdAt      DateTime        @default(now()) @map("created_at")
  completedAt    DateTime?       @map("completed_at")
  createdById    String          @map("created_by_id")
  createdBy      User            @relation(fields: [createdById], references: [id])
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([createdById])
  @@map("export_jobs")
}

/// Dashboard represents a template or user-created dashboard configuration.
/// Dashboards contain widgets and can be system-provided or user-created.
/// Layouts are stored in react-grid-layout format for responsive display.
model Dashboard {
  id             String                @id @default(uuid())
  organizationId String                @map("organization_id")
  name           String
  description    String?
  dashboardType  DashboardType         @map("dashboard_type")
  isSystem       Boolean               @default(false) @map("is_system")
  isDefault      Boolean               @default(false) @map("is_default")
  layouts        Json
  createdAt      DateTime              @default(now()) @map("created_at")
  updatedAt      DateTime              @updatedAt @map("updated_at")
  createdById    String                @map("created_by_id")
  widgets        DashboardWidget[]
  createdBy      User                  @relation("DashboardCreatedBy", fields: [createdById], references: [id])
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userConfigs    UserDashboardConfig[]

  @@unique([organizationId, name])
  @@index([organizationId, dashboardType])
  @@index([organizationId, isDefault])
  @@map("dashboards")
}

/// DashboardWidget defines a single widget within a dashboard.
/// Widgets specify data source, visualization type, and positioning.
model DashboardWidget {
  id                    String       @id @default(uuid())
  dashboardId           String       @map("dashboard_id")
  widgetType            WidgetType   @map("widget_type")
  title                 String
  dataSource            String?      @map("data_source")
  queryConfig           Json?        @map("query_config")
  layoutItem            Json         @map("layout_item")
  chartType             ChartType?   @map("chart_type")
  displayConfig         Json?        @map("display_config")
  useDashboardDateRange Boolean      @default(true) @map("use_dashboard_date_range")
  dateRangeOverride     Json?        @map("date_range_override")
  refreshInterval       Int?         @map("refresh_interval")
  createdAt             DateTime     @default(now()) @map("created_at")
  updatedAt             DateTime     @updatedAt @map("updated_at")
  organizationId        String       @map("organization_id")
  dashboard             Dashboard    @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([dashboardId])
  @@index([organizationId])
  @@map("dashboard_widgets")
}

/// UserDashboardConfig stores user-specific dashboard preferences.
/// Allows users to customize layouts, set home dashboards, and configure refresh intervals.
model UserDashboardConfig {
  id              String          @id @default(uuid())
  organizationId  String          @map("organization_id")
  userId          String          @map("user_id")
  dashboardId     String          @map("dashboard_id")
  isHome          Boolean         @default(false) @map("is_home")
  layoutOverrides Json?           @map("layout_overrides")
  widgetOverrides Json?           @map("widget_overrides")
  refreshInterval Int             @default(5) @map("refresh_interval")
  dateRangePreset DateRangePreset @default(LAST_30_DAYS) @map("date_range_preset")
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  dashboard       Dashboard       @relation(fields: [dashboardId], references: [id], onDelete: Cascade)
  organization    Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, dashboardId])
  @@index([userId, isHome])
  @@index([organizationId, userId])
  @@map("user_dashboard_configs")
}

/// ScheduledExport stores recurring export configurations.
/// Enables compliance officers to schedule periodic report delivery.
model ScheduledExport {
  id              String               @id @default(uuid())
  organizationId  String               @map("organization_id")
  name            String
  description     String?
  exportType      ExportType           @map("export_type")
  format          ExportFormat
  filters         Json
  columnConfig    Json                 @map("column_config")
  scheduleType    ScheduleType         @map("schedule_type")
  scheduleConfig  Json                 @map("schedule_config")
  timezone        String               @default("America/New_York")
  deliveryMethod  DeliveryMethod       @map("delivery_method")
  recipients      String[]
  storageLocation String?              @map("storage_location")
  isActive        Boolean              @default(true) @map("is_active")
  lastRunAt       DateTime?            @map("last_run_at")
  lastRunStatus   ScheduleRunStatus?   @map("last_run_status")
  nextRunAt       DateTime?            @map("next_run_at")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  createdById     String               @map("created_by_id")
  runs            ScheduledExportRun[]
  createdBy       User                 @relation(fields: [createdById], references: [id])
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, isActive])
  @@index([nextRunAt])
  @@map("scheduled_exports")
}

/// ScheduledExportRun records the execution history of scheduled exports.
/// Tracks success/failure, file output, and delivery status per recipient.
model ScheduledExportRun {
  id                String            @id @default(uuid())
  organizationId    String            @map("organization_id")
  scheduledExportId String            @map("scheduled_export_id")
  startedAt         DateTime          @default(now()) @map("started_at")
  completedAt       DateTime?         @map("completed_at")
  status            ScheduleRunStatus
  fileUrl           String?           @map("file_url")
  fileSizeBytes     Int?              @map("file_size_bytes")
  rowCount          Int?              @map("row_count")
  deliveredTo       String[]          @map("delivered_to")
  deliveryStatus    Json?             @map("delivery_status")
  errorMessage      String?           @map("error_message")
  errorDetails      Json?             @map("error_details")
  organization      Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  scheduledExport   ScheduledExport   @relation(fields: [scheduledExportId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([scheduledExportId, startedAt])
  @@map("scheduled_export_runs")
}

/// Milestone tracks key compliance deliverables with target dates.
/// Links to cases, investigations, and campaigns for progress calculation.
model Milestone {
  id               String            @id @default(uuid())
  organizationId   String            @map("organization_id")
  name             String
  description      String?
  category         MilestoneCategory
  targetDate       DateTime          @map("target_date")
  completedAt      DateTime?         @map("completed_at")
  status           MilestoneStatus   @default(NOT_STARTED)
  totalItems       Int               @default(0) @map("total_items")
  completedItems   Int               @default(0) @map("completed_items")
  progressPercent  Int               @default(0) @map("progress_percent")
  ownerId          String?           @map("owner_id")
  notes            String?
  lastStatusUpdate String?           @map("last_status_update")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  createdById      String            @map("created_by_id")
  items            MilestoneItem[]
  createdBy        User              @relation("MilestoneCreatedBy", fields: [createdById], references: [id])
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  owner            User?             @relation("MilestoneOwner", fields: [ownerId], references: [id])

  @@index([organizationId, status])
  @@index([organizationId, targetDate])
  @@index([ownerId])
  @@map("milestones")
}

/// MilestoneItem links milestones to other entities (cases, investigations, campaigns).
/// Supports custom text items for non-entity deliverables.
model MilestoneItem {
  id             String            @id @default(uuid())
  organizationId String            @map("organization_id")
  milestoneId    String            @map("milestone_id")
  entityType     MilestoneItemType @map("entity_type")
  entityId       String?           @map("entity_id")
  customTitle    String?           @map("custom_title")
  isCompleted    Boolean           @default(false) @map("is_completed")
  completedAt    DateTime?         @map("completed_at")
  dueDate        DateTime?         @map("due_date")
  weight         Int               @default(1)
  sortOrder      Int               @default(0) @map("sort_order")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")
  milestone      Milestone         @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([milestoneId])
  @@index([entityType, entityId])
  @@index([organizationId])
  @@map("milestone_items")
}

/// ImplementationProject tracks client onboarding from discovery to go-live.
/// Supports both SMB Quick Start and Enterprise Full implementation templates.
model ImplementationProject {
  id                   String                   @id @default(uuid())
  clientOrganizationId String                   @map("client_organization_id")
  type                 ImplementationType
  status               ProjectStatus            @default(NOT_STARTED)
  currentPhase         ImplementationPhase      @default(DISCOVERY) @map("current_phase")
  leadImplementerId    String                   @map("lead_implementer_id")
  assignedUserIds      String[]                 @default([]) @map("assigned_user_ids")
  kickoffDate          DateTime?                @map("kickoff_date")
  targetGoLiveDate     DateTime?                @map("target_go_live_date")
  actualGoLiveDate     DateTime?                @map("actual_go_live_date")
  healthScore          Int                      @default(100) @map("health_score")
  clientVisibleNotes   String?                  @map("client_visible_notes")
  createdAt            DateTime                 @default(now()) @map("created_at")
  updatedAt            DateTime                 @updatedAt @map("updated_at")
  goLiveGates          GoLiveGate[]
  goLiveSignoff        GoLiveSignoff?
  activities           ImplementationActivity[]
  blockers             ImplementationBlocker[]
  organization         Organization             @relation(fields: [clientOrganizationId], references: [id], onDelete: Cascade)
  tasks                ImplementationTask[]
  readinessItems       ReadinessItem[]

  @@index([clientOrganizationId])
  @@index([leadImplementerId])
  @@index([status])
  @@index([currentPhase])
  @@map("implementation_projects")
}

/// ImplementationTask belongs to phases with status, assignment, due dates.
/// Tasks are created from templates when a project is initiated.
model ImplementationTask {
  id            String                @id @default(uuid())
  projectId     String                @map("project_id")
  phase         ImplementationPhase
  name          String
  description   String?
  status        ImplTaskStatus        @default(PENDING)
  isRequired    Boolean               @default(true) @map("is_required")
  assignedToId  String?               @map("assigned_to_id")
  dueDate       DateTime?             @map("due_date")
  completedAt   DateTime?             @map("completed_at")
  completedById String?               @map("completed_by_id")
  sortOrder     Int                   @default(0) @map("sort_order")
  notes         String?
  createdAt     DateTime              @default(now()) @map("created_at")
  updatedAt     DateTime              @updatedAt @map("updated_at")
  project       ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([phase])
  @@index([status])
  @@index([assignedToId])
  @@map("implementation_tasks")
}

/// ImplementationBlocker tracks issues with auto-escalation timing.
/// Category-based escalation: Internal 3 days, Client/Vendor 5 days.
model ImplementationBlocker {
  id                    String                @id @default(uuid())
  projectId             String                @map("project_id")
  taskId                String?               @map("task_id")
  title                 String
  description           String?
  category              BlockerCategory
  status                BlockerStatus         @default(OPEN)
  createdAt             DateTime              @default(now()) @map("created_at")
  snoozeUntil           DateTime?             @map("snooze_until")
  snoozeReason          String?               @map("snooze_reason")
  escalatedToManagerAt  DateTime?             @map("escalated_to_manager_at")
  escalatedToDirectorAt DateTime?             @map("escalated_to_director_at")
  resolvedAt            DateTime?             @map("resolved_at")
  resolvedById          String?               @map("resolved_by_id")
  resolutionNotes       String?               @map("resolution_notes")
  updatedAt             DateTime              @updatedAt @map("updated_at")
  project               ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([createdAt])
  @@index([category])
  @@map("implementation_blockers")
}

/// ImplementationActivity captures emails, meetings, decisions with proper fields.
/// Supports native email from portal per CONTEXT.md.
model ImplementationActivity {
  id                String                @id @default(uuid())
  projectId         String                @map("project_id")
  type              ImplActivityType
  subject           String?
  content           String?
  attendees         String[]              @default([])
  meetingDate       DateTime?             @map("meeting_date")
  decisionRationale String?               @map("decision_rationale")
  emailTo           String[]              @default([]) @map("email_to")
  emailCc           String[]              @default([]) @map("email_cc")
  emailMessageId    String?               @map("email_message_id")
  isAutoLogged      Boolean               @default(false) @map("is_auto_logged")
  createdById       String                @map("created_by_id")
  createdAt         DateTime              @default(now()) @map("created_at")
  project           ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([type])
  @@index([createdAt])
  @@index([createdById])
  @@map("implementation_activities")
}

/// InternalUser represents an authenticated Ethico internal staff member.
/// CRITICAL: This is completely separate from tenant User model.
/// - User: Tenant-scoped, customer employees
/// - InternalUser: NOT tenant-scoped, Ethico staff with cross-tenant access
///
/// This separation is required for SOC 2 compliance.
model InternalUser {
  id                    String                 @id @default(uuid())
  email                 String                 @unique
  name                  String
  role                  InternalRole
  azureAdId             String?                @unique @map("azure_ad_id")
  isActive              Boolean                @default(true) @map("is_active")
  lastLoginAt           DateTime?              @map("last_login_at")
  createdAt             DateTime               @default(now()) @map("created_at")
  updatedAt             DateTime               @updatedAt @map("updated_at")
  impersonationSessions ImpersonationSession[]

  @@map("internal_users")
}

/// ImpersonationSession tracks cross-tenant access by internal staff.
/// Every operation on tenant data by internal staff MUST occur within
/// an active session with required reason/justification.
///
/// Security features:
/// - Time-bounded (max 4 hours per session)
/// - Reason required for audit compliance
/// - Optional ticket reference for support tracking
/// - All actions logged to ImpersonationAuditLog
model ImpersonationSession {
  id                   String                  @id @default(uuid())
  organizationId       String                  @map("organization_id")
  operatorUserId       String                  @map("operator_user_id")
  operatorRole         InternalRole            @map("operator_role")
  targetOrganizationId String                  @map("target_organization_id")
  reason               String
  ticketId             String?                 @map("ticket_id")
  startedAt            DateTime                @default(now()) @map("started_at")
  endedAt              DateTime?               @map("ended_at")
  expiresAt            DateTime                @map("expires_at")
  ipAddress            String?                 @map("ip_address")
  userAgent            String?                 @map("user_agent")
  auditLogs            ImpersonationAuditLog[]
  operator             InternalUser            @relation(fields: [operatorUserId], references: [id])
  organization         Organization            @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([operatorUserId])
  @@index([targetOrganizationId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

/// ImpersonationAuditLog captures every action performed during an
/// impersonation session for complete audit trail.
///
/// Per SOC 2 requirements, logs: Who, What, When, Where, Why, Before/After
/// - Who: via sessionId -> operator
/// - What: action, entityType, entityId
/// - When: createdAt
/// - Where: session.ipAddress, session.userAgent
/// - Why: session.reason, session.ticketId
/// - Before/After: details JSON for mutations
model ImpersonationAuditLog {
  id             String               @id @default(uuid())
  organizationId String               @map("organization_id")
  sessionId      String               @map("session_id")
  action         String
  entityType     String?              @map("entity_type")
  entityId       String?              @map("entity_id")
  details        Json?
  createdAt      DateTime             @default(now()) @map("created_at")
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  session        ImpersonationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([sessionId])
  @@index([action])
  @@index([createdAt])
  @@map("impersonation_audit_logs")
}

/// GoLiveGate tracks hard gates (blocking requirements) per project.
/// Hard gates are: auth_configured, admin_trained, terms_signed, contact_designated
model GoLiveGate {
  id                 String                @id @default(uuid())
  organizationId     String                @map("organization_id")
  projectId          String                @map("project_id")
  gateId             String                @map("gate_id")
  status             GateStatus            @default(PENDING)
  checkedAt          DateTime?             @map("checked_at")
  checkedById        String?               @map("checked_by_id")
  waiverReason       String?               @map("waiver_reason")
  waiverApprovedById String?               @map("waiver_approved_by_id")
  waiverApprovedAt   DateTime?             @map("waiver_approved_at")
  notes              String?
  createdAt          DateTime              @default(now()) @map("created_at")
  updatedAt          DateTime              @updatedAt @map("updated_at")
  organization       Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project            ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, gateId])
  @@index([organizationId])
  @@index([projectId])
  @@map("go_live_gates")
}

/// ReadinessItem tracks weighted readiness checklist items per project.
/// Items contribute to overall readiness score (recommended 85%+).
model ReadinessItem {
  id              String                @id @default(uuid())
  organizationId  String                @map("organization_id")
  projectId       String                @map("project_id")
  itemId          String                @map("item_id")
  isComplete      Boolean               @default(false) @map("is_complete")
  completedAt     DateTime?             @map("completed_at")
  completedById   String?               @map("completed_by_id")
  percentComplete Int                   @default(0) @map("percent_complete")
  notes           String?
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")
  organization    Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project         ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, itemId])
  @@index([organizationId])
  @@index([projectId])
  @@map("readiness_items")
}

/// GoLiveSignoff captures client acknowledgment to proceed below threshold.
/// Required when readiness score < 85% (RECOMMENDED_SCORE).
model GoLiveSignoff {
  id                      String                @id @default(uuid())
  organizationId          String                @map("organization_id")
  projectId               String                @unique @map("project_id")
  type                    SignoffType
  readinessScoreAtSignoff Int                   @map("readiness_score_at_signoff")
  gatesPassedAtSignoff    Int                   @map("gates_passed_at_signoff")
  gatesTotalAtSignoff     Int                   @map("gates_total_at_signoff")
  acknowledgedRisks       String[]              @default([]) @map("acknowledged_risks")
  signoffStatement        String                @map("signoff_statement")
  clientSignerName        String?               @map("client_signer_name")
  clientSignerEmail       String?               @map("client_signer_email")
  clientSignedAt          DateTime?             @map("client_signed_at")
  internalApproverName    String?               @map("internal_approver_name")
  internalApproverId      String?               @map("internal_approver_id")
  internalApprovedAt      DateTime?             @map("internal_approved_at")
  createdAt               DateTime              @default(now()) @map("created_at")
  organization            Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  project                 ImplementationProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("go_live_signoffs")
}

/// CertificationTrack represents a modular training track.
/// Per CONTEXT.md: Platform Fundamentals is required, specialty tracks optional.
model CertificationTrack {
  id                 String              @id @default(uuid())
  name               String
  slug               String              @unique
  description        String?
  type               TrackType
  level              CertificationLevel
  isRequired         Boolean             @default(false) @map("is_required")
  version            String              @default("1.0")
  versionMajor       Int                 @default(1) @map("version_major")
  estimatedMinutes   Int                 @default(30) @map("estimated_minutes")
  sortOrder          Int                 @default(0) @map("sort_order")
  isActive           Boolean             @default(true) @map("is_active")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  courses            Course[]
  userCertifications UserCertification[]

  @@index([type])
  @@index([level])
  @@index([isActive])
  @@map("certification_tracks")
}

/// Course represents a single learning unit within a certification track.
/// Per CONTEXT.md: Short courses with video/text content.
model Course {
  id               String             @id @default(uuid())
  trackId          String             @map("track_id")
  title            String
  description      String?
  type             CourseType
  contentUrl       String?            @map("content_url")
  contentHtml      String?            @map("content_html")
  estimatedMinutes Int                @default(10) @map("estimated_minutes")
  sortOrder        Int                @default(0) @map("sort_order")
  isActive         Boolean            @default(true) @map("is_active")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  track            CertificationTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  quiz             Quiz?

  @@index([trackId])
  @@index([isActive])
  @@map("courses")
}

/// Quiz represents the assessment for a course.
/// Per CONTEXT.md: 80% to pass.
model Quiz {
  id           String        @id @default(uuid())
  courseId     String        @unique @map("course_id")
  title        String
  passingScore Float         @default(0.80) @map("passing_score")
  questions    Json
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  attempts     QuizAttempt[]
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("quizzes")
}

/// QuizAttempt tracks a user's attempt at completing a quiz.
model QuizAttempt {
  id             String        @id @default(uuid())
  organizationId String?       @map("organization_id")
  quizId         String        @map("quiz_id")
  userId         String?       @map("user_id")
  internalUserId String?       @map("internal_user_id")
  startedAt      DateTime      @default(now()) @map("started_at")
  completedAt    DateTime?     @map("completed_at")
  status         QuizStatus    @default(IN_PROGRESS)
  score          Float?
  answers        Json?
  createdAt      DateTime      @default(now()) @map("created_at")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quiz           Quiz          @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([quizId])
  @@index([userId])
  @@index([internalUserId])
  @@index([status])
  @@map("quiz_attempts")
}

/// UserCertification tracks a user's progress and completion status for a certification track.
model UserCertification {
  id               String             @id @default(uuid())
  trackId          String             @map("track_id")
  userId           String?            @map("user_id")
  internalUserId   String?            @map("internal_user_id")
  startedAt        DateTime           @default(now()) @map("started_at")
  completedAt      DateTime?          @map("completed_at")
  completedVersion String?            @map("completed_version")
  certificateId    String?            @map("certificate_id")
  expiresAt        DateTime?          @map("expires_at")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  certificate      Certificate?       @relation(fields: [certificateId], references: [id])
  track            CertificationTrack @relation(fields: [trackId], references: [id])

  @@unique([trackId, userId])
  @@unique([trackId, internalUserId])
  @@index([userId])
  @@index([internalUserId])
  @@index([completedAt])
  @@index([expiresAt])
  @@map("user_certifications")
}

/// Certificate represents an issued certification document.
/// Per CONTEXT.md: PDF certificates with expiration tracking.
model Certificate {
  id                 String              @id @default(uuid())
  certificateNumber  String              @unique @map("certificate_number")
  recipientName      String              @map("recipient_name")
  trackName          String              @map("track_name")
  trackVersion       String              @map("track_version")
  issuedAt           DateTime            @default(now()) @map("issued_at")
  expiresAt          DateTime?           @map("expires_at")
  status             CertificateStatus   @default(ACTIVE)
  pdfUrl             String?             @map("pdf_url")
  organizationId     String?             @map("organization_id")
  organizationName   String?             @map("organization_name")
  createdAt          DateTime            @default(now()) @map("created_at")
  userCertifications UserCertification[]

  @@index([status])
  @@index([organizationId])
  @@index([issuedAt])
  @@map("certificates")
}

/// TenantHealthScore stores blended health scores per tenant.
/// Component scores weighted per CONTEXT.md:
/// - Login: 20%, Case Resolution: 25%, Campaign Completion: 25%
/// - Feature Adoption: 15%, Support Tickets: 15%
model TenantHealthScore {
  id                      String       @id @default(uuid())
  organizationId          String       @map("organization_id")
  calculatedAt            DateTime     @default(now()) @map("calculated_at")
  loginScore              Int          @map("login_score")
  caseResolutionScore     Int          @map("case_resolution_score")
  campaignCompletionScore Int          @map("campaign_completion_score")
  featureAdoptionScore    Int          @map("feature_adoption_score")
  supportTicketScore      Int          @map("support_ticket_score")
  overallScore            Int          @map("overall_score")
  trend                   HealthTrend
  riskLevel               RiskLevel    @map("risk_level")
  previousScore           Int?         @map("previous_score")
  alertLevel              AlertLevel   @default(DASHBOARD_ONLY) @map("alert_level")
  organization            Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([calculatedAt])
  @@index([riskLevel])
  @@map("tenant_health_scores")
}

/// UsageMetric stores daily usage statistics for health calculation.
/// Aggregated by tenant per day for efficient trend analysis.
model UsageMetric {
  id                   String       @id @default(uuid())
  organizationId       String       @map("organization_id")
  metricDate           DateTime     @map("metric_date") @db.Date
  activeUsers          Int          @map("active_users")
  totalUsers           Int          @map("total_users")
  casesCreated         Int          @map("cases_created")
  casesClosed          Int          @map("cases_closed")
  casesOnTime          Int          @map("cases_on_time")
  casesOverdue         Int          @map("cases_overdue")
  campaignsActive      Int          @default(0) @map("campaigns_active")
  assignmentsTotal     Int          @default(0) @map("assignments_total")
  assignmentsCompleted Int          @default(0) @map("assignments_completed")
  supportTickets       Int          @default(0) @map("support_tickets")
  createdAt            DateTime     @default(now()) @map("created_at")
  organization         Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, metricDate])
  @@index([organizationId])
  @@index([metricDate])
  @@map("usage_metrics")
}

/// FeatureAdoption tracks which platform features a tenant has used.
/// Used for health score calculation and CSM outreach prioritization.
model FeatureAdoption {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  featureKey     String       @map("feature_key")
  firstUsedAt    DateTime     @map("first_used_at")
  lastUsedAt     DateTime     @map("last_used_at")
  usageCount     Int          @default(1) @map("usage_count")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureKey])
  @@index([organizationId])
  @@index([featureKey])
  @@map("feature_adoptions")
}

/// PeerBenchmark stores nightly cached aggregates for peer comparison.
/// Calculated via background job, not on-demand queries.
/// Privacy: Only shown when peerCount >= 5 (per CONTEXT.md).
model PeerBenchmark {
  id             String   @id @default(uuid())
  metricName     String   @map("metric_name")
  calculatedAt   DateTime @default(now()) @map("calculated_at")
  industrySector String?  @map("industry_sector")
  employeeMin    Int?     @map("employee_min")
  employeeMax    Int?     @map("employee_max")
  peerCount      Int      @map("peer_count")
  p25            Float
  median         Float
  p75            Float
  mean           Float
  minValue       Float    @map("min_value")
  maxValue       Float    @map("max_value")

  @@unique([metricName, industrySector, employeeMin, employeeMax, calculatedAt])
  @@index([metricName])
  @@index([calculatedAt])
  @@map("peer_benchmarks")
}

enum UserRole {
  SYSTEM_ADMIN
  COMPLIANCE_OFFICER
  TRIAGE_LEAD
  INVESTIGATOR
  POLICY_AUTHOR
  POLICY_REVIEWER
  DEPARTMENT_ADMIN
  MANAGER
  EMPLOYEE
  OPERATOR

  @@map("user_role")
}

enum CaseStatus {
  NEW
  OPEN
  CLOSED

  @@map("case_status")
}

enum SourceChannel {
  HOTLINE
  WEB_FORM
  PROXY
  DIRECT_ENTRY
  CHATBOT

  @@map("source_channel")
}

enum CaseType {
  REPORT
  RFI

  @@map("case_type")
}

enum ReporterType {
  ANONYMOUS
  IDENTIFIED
  PROXY

  @@map("reporter_type")
}

enum ReporterRelationship {
  EMPLOYEE
  FORMER_EMPLOYEE
  VENDOR
  CONTRACTOR
  CUSTOMER
  WITNESS
  OTHER

  @@map("reporter_relationship")
}

enum Severity {
  HIGH
  MEDIUM
  LOW

  @@map("severity")
}

enum CaseOutcome {
  SUBSTANTIATED
  UNSUBSTANTIATED
  INCONCLUSIVE
  POLICY_VIOLATION
  NO_VIOLATION

  @@map("case_outcome")
}

enum AuditEntityType {
  CASE
  RIU
  INVESTIGATION
  DISCLOSURE
  POLICY
  ATTESTATION
  WORKFLOW
  USER
  EMPLOYEE
  ORGANIZATION
  CATEGORY
  FORM
  CHATBOT_CONVERSATION
  REPORT
  DASHBOARD
  INTEGRATION
  ATTACHMENT
  SUBJECT
  CASE_MESSAGE
  INTERACTION
  DEMO_ACCOUNT
  PERSON
  SEGMENT
  CAMPAIGN
  CAMPAIGN_ASSIGNMENT
  REMEDIATION_PLAN
  REMEDIATION_STEP
  NOTIFICATION
  USER_DATA_TABLE
  POLICY_VERSION
  POLICY_TRANSLATION
  MILESTONE
  MILESTONE_ITEM

  @@map("audit_entity_type")
}

enum AuditActionCategory {
  CREATE
  UPDATE
  DELETE
  ACCESS
  SYSTEM
  SECURITY
  AI

  @@map("audit_action_category")
}

enum ActorType {
  USER
  SYSTEM
  AI
  INTEGRATION
  ANONYMOUS

  @@map("actor_type")
}

enum InvestigationStatus {
  NEW
  ASSIGNED
  INVESTIGATING
  PENDING_REVIEW
  CLOSED
  ON_HOLD

  @@map("investigation_status")
}

enum InvestigationType {
  FULL
  LIMITED
  INQUIRY

  @@map("investigation_type")
}

enum InvestigationDepartment {
  HR
  LEGAL
  SAFETY
  COMPLIANCE
  OTHER

  @@map("investigation_department")
}

enum InvestigationOutcome {
  SUBSTANTIATED
  UNSUBSTANTIATED
  INCONCLUSIVE
  POLICY_VIOLATION
  NO_VIOLATION
  INSUFFICIENT_EVIDENCE

  @@map("investigation_outcome")
}

enum SlaStatus {
  ON_TRACK
  WARNING
  OVERDUE

  @@map("sla_status")
}

enum NoteType {
  GENERAL
  INTERVIEW
  EVIDENCE
  FINDING
  RECOMMENDATION
  FOLLOW_UP

  @@map("note_type")
}

enum NoteVisibility {
  PRIVATE
  TEAM
  ALL

  @@map("note_visibility")
}

/// InterviewStatus tracks the lifecycle of an investigation interview.
enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("interview_status")
}

/// IntervieweeType classifies how the interviewee is identified.
enum IntervieweeType {
  PERSON
  EXTERNAL
  ANONYMOUS

  @@map("interviewee_type")
}

enum AttachmentEntityType {
  CASE
  INVESTIGATION
  INVESTIGATION_NOTE

  @@map("attachment_entity_type")
}

enum CategoryModule {
  CASE
  DISCLOSURE
  POLICY
  ALL

  @@map("category_module")
}

enum RiuType {
  HOTLINE_REPORT
  WEB_FORM_SUBMISSION
  DISCLOSURE_RESPONSE
  ATTESTATION_RESPONSE
  CHATBOT_TRANSCRIPT
  INCIDENT_FORM
  PROXY_REPORT
  SURVEY_RESPONSE

  @@map("riu_type")
}

enum RiuSourceChannel {
  PHONE
  WEB_FORM
  CHATBOT
  EMAIL
  PROXY
  DIRECT_ENTRY
  CAMPAIGN

  @@map("riu_source_channel")
}

enum RiuReporterType {
  ANONYMOUS
  CONFIDENTIAL
  IDENTIFIED

  @@map("riu_reporter_type")
}

enum RiuStatus {
  PENDING_QA
  IN_QA
  QA_REJECTED
  RELEASED
  LINKED
  CLOSED
  RECEIVED
  COMPLETED

  @@map("riu_status")
}

/// QA status for hotline RIU quality assurance workflow
enum RiuQaStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  NEEDS_REVISION

  @@map("riu_qa_status")
}

/// Types of disclosures that can be submitted
enum DisclosureType {
  COI
  GIFT
  OUTSIDE_EMPLOYMENT
  POLITICAL
  CHARITABLE
  TRAVEL

  @@map("disclosure_type")
}

enum RiuAssociationType {
  PRIMARY
  RELATED
  MERGED_FROM

  @@map("riu_association_type")
}

enum SubjectRole {
  REPORTER
  ACCUSED
  WITNESS
  VICTIM
  OTHER

  @@map("subject_role")
}

enum MessageDirection {
  INBOUND
  OUTBOUND

  @@map("message_direction")
}

enum MessageSenderType {
  REPORTER
  INVESTIGATOR
  SYSTEM

  @@map("message_sender_type")
}

enum MessageDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED

  @@map("message_delivery_status")
}

enum InteractionType {
  STATUS_CHECK
  ADDITIONAL_INFO
  FOLLOW_UP_QUESTION
  INTERVIEW
  CALLBACK

  @@map("interaction_type")
}

enum InteractionChannel {
  PHONE
  EMAIL
  PORTAL
  IN_PERSON
  VIDEO

  @@map("interaction_channel")
}

enum InteractionQaStatus {
  PENDING
  APPROVED
  NEEDS_REVISION
  RELEASED

  @@map("interaction_qa_status")
}

enum WorkflowEntityType {
  CASE
  INVESTIGATION
  DISCLOSURE
  POLICY
  CAMPAIGN

  @@map("workflow_entity_type")
}

enum WorkflowInstanceStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED

  @@map("workflow_instance_status")
}

enum FormType {
  INTAKE
  DISCLOSURE
  ATTESTATION
  SURVEY
  WORKFLOW_TASK
  CUSTOM

  @@map("form_type")
}

enum FormSubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PROCESSED

  @@map("form_submission_status")
}

enum ReportDataSource {
  CASES
  RIUS
  INVESTIGATIONS
  DISCLOSURES
  POLICIES
  AUDIT_LOGS
  USERS
  CAMPAIGNS

  @@map("report_data_source")
}

enum ReportExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED

  @@map("report_execution_status")
}

enum DemoAccountStatus {
  ACTIVE
  EXPIRED
  REVOKED

  @@map("demo_account_status")
}

/// PersonType classifies the type of person record.
/// EMPLOYEE links to HRIS data, EXTERNAL_CONTACT for non-employees,
/// ANONYMOUS_PLACEHOLDER is a singleton per org for anonymous pattern detection.
enum PersonType {
  EMPLOYEE
  EXTERNAL_CONTACT
  ANONYMOUS_PLACEHOLDER

  @@map("person_type")
}

/// PersonSource tracks how the person record was created.
enum PersonSource {
  HRIS_SYNC
  MANUAL
  INTAKE_CREATED

  @@map("person_source")
}

/// AnonymityTier controls identity visibility on person records.
/// Used for reporters who want different levels of identity protection.
enum AnonymityTier {
  ANONYMOUS
  CONFIDENTIAL
  OPEN

  @@map("anonymity_tier")
}

/// PersonStatus tracks the lifecycle of a person record.
enum PersonStatus {
  ACTIVE
  INACTIVE
  MERGED

  @@map("person_status")
}

enum JobLevel {
  IC
  MANAGER
  DIRECTOR
  VP
  SVP
  C_SUITE

  @@map("job_level")
}

enum WorkMode {
  ONSITE
  REMOTE
  HYBRID

  @@map("work_mode")
}

enum ComplianceRole {
  CCO
  INVESTIGATOR
  HRBP
  LEGAL_COUNSEL
  ETHICS_COMMITTEE

  @@map("compliance_role")
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED

  @@map("employment_status")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  TEMPORARY
  INTERN

  @@map("employment_type")
}

/// CampaignType defines what kind of outbound request this campaign sends.
enum CampaignType {
  DISCLOSURE
  ATTESTATION
  SURVEY

  @@map("campaign_type")
}

/// AttestationType defines how employees attest to a policy.
enum AttestationType {
  CHECKBOX
  SIGNATURE
  QUIZ

  @@map("attestation_type")
}

/// CampaignStatus tracks the lifecycle of a campaign.
enum CampaignStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED

  @@map("campaign_status")
}

/// AudienceMode determines how campaign targets are selected.
enum AudienceMode {
  SEGMENT
  MANUAL
  ALL

  @@map("audience_mode")
}

/// AssignmentStatus tracks individual employee assignment progress.
enum AssignmentStatus {
  PENDING
  NOTIFIED
  IN_PROGRESS
  COMPLETED
  OVERDUE
  SKIPPED
  EXPIRED

  @@map("assignment_status")
}

/// CampaignWaveStatus tracks the lifecycle of a wave within a staggered campaign.
enum CampaignWaveStatus {
  PENDING
  LAUNCHED
  CANCELLED

  @@map("campaign_wave_status")
}

/// CampaignRolloutStrategy determines how assignments are distributed over time.
enum CampaignRolloutStrategy {
  IMMEDIATE
  STAGGERED
  PILOT_FIRST

  @@map("campaign_rollout_strategy")
}

/// Labels for Person-to-Case associations per ASSOC-02.
/// Evidentiary labels (REPORTER, SUBJECT, WITNESS) use status field.
/// Role labels (ASSIGNED_INVESTIGATOR, etc.) use validity periods.
enum PersonCaseLabel {
  REPORTER
  SUBJECT
  WITNESS
  ASSIGNED_INVESTIGATOR
  APPROVER
  STAKEHOLDER
  MANAGER_OF_SUBJECT
  REVIEWER
  LEGAL_COUNSEL

  @@map("person_case_label")
}

/// Labels for Person-to-RIU associations per ASSOC-01.
/// Tracks who is mentioned in an RIU intake record.
enum PersonRiuLabel {
  REPORTER
  SUBJECT_MENTIONED
  WITNESS_MENTIONED

  @@map("person_riu_label")
}

/// Labels for Case-to-Case associations per CONTEXT.md decision.
/// Supports hierarchy (parent/child), splits, escalations, merges.
enum CaseCaseLabel {
  PARENT
  CHILD
  SPLIT_FROM
  SPLIT_TO
  RELATED
  ESCALATED_TO
  SUPERSEDES
  FOLLOW_UP_TO
  MERGED_INTO

  @@map("case_case_label")
}

/// Labels for Person-to-Person relationships.
/// Sources: HRIS (manager_of), Disclosure (spouse, business_partner), Investigation.
/// Used for COI detection.
enum PersonPersonLabel {
  MANAGER_OF
  REPORTS_TO
  SPOUSE
  DOMESTIC_PARTNER
  FAMILY_MEMBER
  FORMER_COLLEAGUE
  BUSINESS_PARTNER
  CLOSE_PERSONAL_FRIEND

  @@map("person_person_label")
}

/// Status for evidentiary associations (subject, witness, reporter).
/// Per CONTEXT.md: Evidentiary associations use STATUS, not validity periods.
/// "Person X was the subject of Case Y" is permanently true - only outcome changes.
enum EvidentiaryStatus {
  ACTIVE
  CLEARED
  SUBSTANTIATED
  WITHDRAWN

  @@map("evidentiary_status")
}

/// Source of Person-Person relationship knowledge.
enum PersonPersonSource {
  HRIS
  DISCLOSURE
  INVESTIGATION
  MANUAL

  @@map("person_person_source")
}

/// Conversation status tracks the lifecycle
enum AiConversationStatus {
  ACTIVE
  PAUSED
  ARCHIVED

  @@map("ai_conversation_status")
}

/// AiActionStatus tracks the lifecycle of AI-initiated actions.
enum AiActionStatus {
  PENDING
  EXECUTING
  COMPLETED
  FAILED
  UNDONE

  @@map("ai_action_status")
}

/// CustomPropertyEntityType defines which entities can have custom properties.
enum CustomPropertyEntityType {
  CASE
  INVESTIGATION
  PERSON
  RIU

  @@map("custom_property_entity_type")
}

/// PropertyDataType defines the data types supported for custom properties.
enum PropertyDataType {
  TEXT
  NUMBER
  DATE
  DATETIME
  SELECT
  MULTI_SELECT
  BOOLEAN
  URL
  EMAIL
  PHONE

  @@map("property_data_type")
}

/// RemediationStatus tracks the lifecycle of a remediation plan.
enum RemediationStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED

  @@map("remediation_status")
}

/// StepStatus tracks individual remediation step progress.
enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED

  @@map("step_status")
}

/// ViewEntityType defines which entity lists can have saved views.
enum ViewEntityType {
  CASES
  RIUS
  INVESTIGATIONS
  PERSONS
  CAMPAIGNS
  REMEDIATION_PLANS
  POLICIES
  DISCLOSURES
  INTAKE_FORMS

  @@map("view_entity_type")
}

/// TemplateTier defines the visibility/scope of investigation templates.
/// OFFICIAL templates are admin-created and org-wide.
/// TEAM templates are shared with specific teams.
/// PERSONAL templates are creator-only, typically saved from cases.
enum TemplateTier {
  OFFICIAL
  TEAM
  PERSONAL

  @@map("template_tier")
}

/// TemplateRequirement defines how strictly a template should be applied
/// when creating an investigation for a mapped category.
enum TemplateRequirement {
  REQUIRED
  RECOMMENDED
  OPTIONAL

  @@map("template_requirement")
}

enum NotificationChannel {
  EMAIL
  IN_APP

  @@map("notification_channel")
}

enum NotificationType {
  ASSIGNMENT
  DEADLINE
  APPROVAL
  MENTION
  INTERVIEW
  STATUS_UPDATE
  COMMENT
  COMPLETION
  ESCALATION
  DIGEST

  @@map("notification_type")
}

enum NotificationStatus {
  QUEUED
  SENT
  DELIVERED
  FAILED
  READ
  ARCHIVED

  @@map("notification_status")
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  BOUNCED
  FAILED
  DEFERRED

  @@map("delivery_status")
}

/// QaMode defines how QA review is applied to incoming reports.
enum QaMode {
  ALL
  RISK_BASED
  SAMPLE
  NONE

  @@map("qa_mode")
}

/// DirectiveStage represents when a directive should be displayed during a call.
/// OPENING: Read at the start of the call before any intake
/// INTAKE: General guidance during the intake process
/// CATEGORY_SPECIFIC: Displayed when a specific category is selected
/// CLOSING: Read at the end of the call
enum DirectiveStage {
  OPENING
  INTAKE
  CATEGORY_SPECIFIC
  CLOSING

  @@map("directive_stage")
}

/// BrandingMode determines the level of customization available to a tenant.
/// TEMPLATE: Basic customization (logo, primary color, theme mode)
/// FULL_WHITE_LABEL: Complete customization (12-token color palette, typography)
enum BrandingMode {
  TEMPLATE
  FULL_WHITE_LABEL

  @@map("branding_mode")
}

/// ThemeMode determines the default color scheme for the portal.
enum ThemeMode {
  LIGHT
  DARK
  SYSTEM

  @@map("theme_mode")
}

/// ThresholdAction defines what happens when a threshold rule is triggered.
enum ThresholdAction {
  FLAG_REVIEW
  CREATE_CASE
  REQUIRE_APPROVAL
  NOTIFY

  @@map("threshold_action")
}

/// ThresholdApplyMode defines how retroactive evaluation is handled.
enum ThresholdApplyMode {
  FORWARD_ONLY
  RETROACTIVE
  RETROACTIVE_DATE

  @@map("threshold_apply_mode")
}

/// ConflictType defines the category of detected conflict.
/// RS.41: Six-way conflict detection across systems
enum ConflictType {
  VENDOR_MATCH
  APPROVAL_AUTHORITY
  PRIOR_CASE_HISTORY
  HRIS_MATCH
  GIFT_AGGREGATE
  RELATIONSHIP_PATTERN
  SELF_DEALING

  @@map("conflict_type")
}

/// ConflictSeverity indicates the risk level of the detected conflict.
enum ConflictSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("conflict_severity")
}

/// ConflictStatus tracks the lifecycle of a conflict alert.
enum ConflictStatus {
  OPEN
  DISMISSED
  ESCALATED
  RESOLVED

  @@map("conflict_status")
}

/// ExclusionScope defines the validity period of a conflict exclusion.
enum ExclusionScope {
  PERMANENT
  TIME_LIMITED
  ONE_TIME

  @@map("exclusion_scope")
}

/// Disclosure form types - compliance-specific form categories.
enum DisclosureFormType {
  COI
  GIFT
  OUTSIDE_EMPLOYMENT
  ATTESTATION
  POLITICAL
  CHARITABLE
  TRAVEL
  CUSTOM

  @@map("disclosure_form_type")
}

/// Status for form template versioning workflow.
enum FormTemplateStatus {
  DRAFT
  PUBLISHED
  ARCHIVED

  @@map("form_template_status")
}

/// TableCreationMethod defines how a user table was created.
enum TableCreationMethod {
  BUILDER
  AI_GENERATED
  IMPORT

  @@map("table_creation_method")
}

/// TableVisibility controls who can see a user-created table.
enum TableVisibility {
  PRIVATE
  TEAM
  ORG

  @@map("table_visibility")
}

enum PolicyType {
  CODE_OF_CONDUCT
  ANTI_HARASSMENT
  ANTI_BRIBERY
  DATA_PRIVACY
  INFORMATION_SECURITY
  GIFT_ENTERTAINMENT
  CONFLICTS_OF_INTEREST
  TRAVEL_EXPENSE
  WHISTLEBLOWER
  SOCIAL_MEDIA
  ACCEPTABLE_USE
  OTHER

  @@map("policy_type")
}

enum PolicyStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  RETIRED

  @@map("policy_status")
}

enum TranslationSource {
  AI
  HUMAN
  IMPORT

  @@map("translation_source")
}

enum TranslationReviewStatus {
  PENDING_REVIEW
  APPROVED
  NEEDS_REVISION
  PUBLISHED

  @@map("translation_review_status")
}

enum PolicyCaseLinkType {
  VIOLATION
  REFERENCE
  GOVERNING

  @@map("policy_case_link_type")
}

/// MigrationSourceType defines supported data sources for import.
enum MigrationSourceType {
  NAVEX
  EQS
  LEGACY_ETHICO
  GENERIC_CSV
  ONETRUST
  STAR

  @@map("migration_source_type")
}

/// MigrationJobStatus tracks the lifecycle of a migration job.
enum MigrationJobStatus {
  PENDING
  VALIDATING
  MAPPING
  PREVIEW
  IMPORTING
  COMPLETED
  FAILED
  ROLLED_BACK

  @@map("migration_job_status")
}

/// ExportSourceType defines which entity types can have fields tagged for export.
enum ExportSourceType {
  CASE
  INVESTIGATION
  DISCLOSURE
  INTERVIEW_RESPONSE
  RIU

  @@map("export_source_type")
}

/// ExportDataType defines the data type for formatting exported values.
enum ExportDataType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  CURRENCY
  PERCENTAGE

  @@map("export_data_type")
}

/// ExportType defines the scope of an export job.
enum ExportType {
  FLAT_FILE
  CASES_ONLY
  INVESTIGATIONS_ONLY
  DISCLOSURES_ONLY
  CUSTOM

  @@map("export_type")
}

/// ExportFormat defines the output format for export files.
enum ExportFormat {
  CSV
  XLSX
  JSON
  PDF

  @@map("export_format")
}

/// ExportJobStatus tracks the lifecycle of an export job.
enum ExportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED

  @@map("export_job_status")
}

/// DashboardType defines the role-based dashboard template types.
/// Each role has a pre-configured default dashboard.
enum DashboardType {
  CCO
  INVESTIGATOR
  CAMPAIGN_MANAGER
  CUSTOM

  @@map("dashboard_type")
}

/// WidgetType defines the available widget visualization types.
enum WidgetType {
  KPI_CARD
  LINE_CHART
  BAR_CHART
  PIE_CHART
  DONUT_CHART
  AREA_CHART
  STACKED_BAR
  TABLE
  LIST
  HEATMAP
  FUNNEL
  GAUGE
  SPARKLINE
  QUICK_ACTIONS

  @@map("widget_type")
}

/// ChartType defines the specific chart rendering types.
enum ChartType {
  LINE
  BAR
  PIE
  DONUT
  AREA
  STACKED_BAR
  HEATMAP
  FUNNEL
  SCATTER
  GAUGE

  @@map("chart_type")
}

/// DateRangePreset defines the available date range options for dashboards.
enum DateRangePreset {
  TODAY
  LAST_7_DAYS
  LAST_30_DAYS
  LAST_90_DAYS
  LAST_12_MONTHS
  YEAR_TO_DATE
  CUSTOM

  @@map("date_range_preset")
}

/// ScheduleType defines the recurrence pattern for scheduled exports.
enum ScheduleType {
  DAILY
  WEEKLY
  MONTHLY

  @@map("schedule_type")
}

/// DeliveryMethod defines how exported files are delivered.
enum DeliveryMethod {
  EMAIL
  STORAGE

  @@map("delivery_method")
}

/// ScheduleRunStatus tracks the outcome of a scheduled export run.
enum ScheduleRunStatus {
  SUCCESS
  FAILED
  SKIPPED

  @@map("schedule_run_status")
}

/// MilestoneCategory classifies the type of compliance milestone.
enum MilestoneCategory {
  AUDIT
  INVESTIGATION
  CAMPAIGN
  PROJECT
  TRAINING
  REMEDIATION
  OTHER

  @@map("milestone_category")
}

/// MilestoneStatus tracks the progress of a milestone.
enum MilestoneStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  COMPLETED
  CANCELLED

  @@map("milestone_status")
}

/// MilestoneItemType defines the type of entity linked to a milestone.
enum MilestoneItemType {
  CASE
  INVESTIGATION
  CAMPAIGN
  TASK
  CUSTOM

  @@map("milestone_item_type")
}

/// Implementation type determines which checklist template to use
enum ImplementationType {
  SMB_QUICK_START
  ENTERPRISE_FULL
  HEALTHCARE_HIPAA
  FINANCIAL_SOX
  GENERAL_BUSINESS

  @@map("implementation_type")
}

/// Phases for Enterprise implementation
enum ImplementationPhase {
  DISCOVERY
  CONFIGURATION
  DATA_MIGRATION
  UAT
  GO_LIVE
  OPTIMIZATION

  @@map("implementation_phase")
}

/// Implementation project status
enum ProjectStatus {
  NOT_STARTED
  IN_PROGRESS
  AT_RISK
  ON_HOLD
  COMPLETED
  CANCELLED

  @@map("project_status")
}

/// Implementation task status
enum ImplTaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  SKIPPED

  @@map("impl_task_status")
}

/// Blocker category determines escalation timing per CONTEXT.md
enum BlockerCategory {
  INTERNAL
  CLIENT_SIDE
  VENDOR

  @@map("blocker_category")
}

/// Blocker status
enum BlockerStatus {
  OPEN
  SNOOZED
  RESOLVED

  @@map("blocker_status")
}

/// Activity type for implementation logging
enum ImplActivityType {
  EMAIL_SENT
  EMAIL_RECEIVED
  MEETING
  DECISION
  PHASE_TRANSITION
  NOTE
  TASK_COMPLETED
  BLOCKER_CREATED
  BLOCKER_RESOLVED

  @@map("impl_activity_type")
}

/// InternalRole defines permission levels for internal Ethico staff.
/// These roles are SEPARATE from tenant UserRole and used exclusively
/// for the Internal Operations Portal.
enum InternalRole {
  SUPPORT_L1
  SUPPORT_L2
  SUPPORT_L3
  IMPLEMENTATION
  HOTLINE_OPS
  CLIENT_SUCCESS
  ADMIN

  @@map("internal_role")
}

/// GateStatus tracks the state of a hard gate.
enum GateStatus {
  PENDING
  PASSED
  FAILED
  WAIVED

  @@map("gate_status")
}

/// SignoffType indicates who signed off on below-threshold go-live.
enum SignoffType {
  CLIENT
  INTERNAL

  @@map("signoff_type")
}

/// CertificationLevel defines the difficulty/progression level of a certification track.
enum CertificationLevel {
  FOUNDATION
  INTERMEDIATE
  ADVANCED

  @@map("certification_level")
}

/// TrackType defines the specific certification track categories.
enum TrackType {
  PLATFORM_FUNDAMENTALS
  CASE_MANAGEMENT
  CAMPAIGNS_DISCLOSURES
  POLICY_MANAGEMENT
  ANALYTICS_REPORTING
  ADMIN_CONFIGURATION

  @@map("track_type")
}

/// CourseType defines the content format of a course.
enum CourseType {
  VIDEO
  TEXT
  INTERACTIVE

  @@map("course_type")
}

/// QuizStatus tracks the state of a quiz attempt.
enum QuizStatus {
  NOT_STARTED
  IN_PROGRESS
  PASSED
  FAILED

  @@map("quiz_status")
}

/// CertificateStatus tracks the lifecycle of an issued certificate.
enum CertificateStatus {
  ACTIVE
  EXPIRED
  REVOKED

  @@map("certificate_status")
}

/// Risk level classification for tenant health.
/// Used for traffic light indicators and alert prioritization.
enum RiskLevel {
  LOW
  MEDIUM
  HIGH

  @@map("risk_level")
}

/// Health score trend direction.
/// Calculated from delta between current and previous score.
enum HealthTrend {
  IMPROVING
  STABLE
  DECLINING

  @@map("health_trend")
}

/// Alert level configuration per account.
/// Different customers may require different alerting thresholds.
enum AlertLevel {
  NONE
  DASHBOARD_ONLY
  PROACTIVE

  @@map("alert_level")
}
