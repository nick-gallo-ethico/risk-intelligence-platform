// ===========================================
// Ethico Risk Intelligence Platform
// Prisma Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Core Entities
// ===========================================

/// Organization represents a tenant in the multi-tenant system.
/// All business data is scoped to an organization via Row-Level Security.
model Organization {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  settings   Json     @default("{}")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  users      User[]
  sessions   Session[]
  cases      Case[]

  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

/// User represents an authenticated user within an organization.
/// Users are scoped to a single organization (no cross-tenant access).
model User {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  email          String
  passwordHash   String?   @map("password_hash")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  role           UserRole  @default(EMPLOYEE)
  isActive       Boolean   @default(true) @map("is_active")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions            Session[]
  casesCreated        Case[]       @relation("CaseCreatedBy")
  casesUpdated        Case[]       @relation("CaseUpdatedBy")
  casesIntakeOperator Case[]       @relation("CaseIntakeOperator")
  casesReleased       Case[]       @relation("CaseReleasedBy")
  casesProxySubmitter Case[]       @relation("CaseProxySubmitter")

  // Unique constraint: email must be unique within an organization
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, role])
  @@index([organizationId, isActive])
  @@map("users")
}

/// Session represents an active user session (for refresh token rotation).
/// Sessions are scoped to organization for RLS compliance.
model Session {
  id                String    @id @default(uuid())
  organizationId    String    @map("organization_id")
  userId            String    @map("user_id")
  userAgent         String?   @map("user_agent")
  ipAddress         String?   @map("ip_address")
  expiresAt         DateTime  @map("expires_at")
  revokedAt         DateTime? @map("revoked_at")
  previousSessionId String?   @map("previous_session_id")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  SYSTEM_ADMIN
  COMPLIANCE_OFFICER
  TRIAGE_LEAD
  INVESTIGATOR
  POLICY_AUTHOR
  POLICY_REVIEWER
  DEPARTMENT_ADMIN
  MANAGER
  EMPLOYEE

  @@map("user_role")
}

enum CaseStatus {
  NEW
  OPEN
  CLOSED

  @@map("case_status")
}

enum SourceChannel {
  HOTLINE
  WEB_FORM
  PROXY
  DIRECT_ENTRY
  CHATBOT

  @@map("source_channel")
}

enum CaseType {
  REPORT
  RFI

  @@map("case_type")
}

enum ReporterType {
  ANONYMOUS
  IDENTIFIED
  PROXY

  @@map("reporter_type")
}

enum ReporterRelationship {
  EMPLOYEE
  FORMER_EMPLOYEE
  VENDOR
  CONTRACTOR
  CUSTOMER
  WITNESS
  OTHER

  @@map("reporter_relationship")
}

enum Severity {
  HIGH
  MEDIUM
  LOW

  @@map("severity")
}

// ===========================================
// Case Management Entities
// ===========================================

/// Case represents a compliance report or request for information.
/// This is the primary container for all case-related data.
model Case {
  id              String   @id @default(uuid())
  referenceNumber String   @unique @map("reference_number")
  organizationId  String   @map("organization_id")

  // Status
  status          CaseStatus @default(NEW)
  statusRationale String?    @map("status_rationale")

  // Intake Information
  sourceChannel   SourceChannel @map("source_channel")
  caseType        CaseType      @default(REPORT) @map("case_type")
  intakeTimestamp DateTime      @default(now()) @map("intake_timestamp")
  intakeOperatorId String?      @map("intake_operator_id")
  firstTimeCaller Boolean?      @map("first_time_caller")
  awarenessSource String?       @map("awareness_source")
  interpreterUsed Boolean?      @map("interpreter_used")

  // Reporter Information
  reporterType         ReporterType @default(ANONYMOUS) @map("reporter_type")
  reporterAnonymous    Boolean      @default(true) @map("reporter_anonymous")
  reporterName         String?      @map("reporter_name") // Encrypted
  reporterEmail        String?      @map("reporter_email") // Encrypted
  reporterPhone        String?      @map("reporter_phone") // Encrypted
  reporterRelationship ReporterRelationship? @map("reporter_relationship")
  anonymousAccessCode  String?      @map("anonymous_access_code")
  proxySubmitterId     String?      @map("proxy_submitter_id")

  // Location Information
  locationName    String?  @map("location_name")
  locationAddress String?  @map("location_address")
  locationCity    String?  @map("location_city")
  locationState   String?  @map("location_state")
  locationZip     String?  @map("location_zip")
  locationCountry String?  @map("location_country")
  locationManual  Boolean? @map("location_manual")

  // Report Content
  details           String  // Full narrative (rich text)
  summary           String? // Manual summary
  addendum          String? // Operator notes
  originalLanguage  String? @map("original_language")
  translatedDetails String? @map("translated_details")
  translationLanguage String? @map("translation_language")

  // Classification
  primaryCategoryId   String?  @map("primary_category_id")
  secondaryCategoryId String?  @map("secondary_category_id")
  severity            Severity @default(MEDIUM)
  severityReason      String?  @map("severity_reason")
  tags                String[] @default([])

  // AI Enrichment
  aiSummary             String?   @map("ai_summary")
  aiSummaryGeneratedAt  DateTime? @map("ai_summary_generated_at")
  aiModelVersion        String?   @map("ai_model_version")
  aiCategorySuggestion  String?   @map("ai_category_suggestion")
  aiSeveritySuggestion  Severity? @map("ai_severity_suggestion")
  aiConfidenceScore     Int?      @map("ai_confidence_score")

  // Custom Data (JSONB)
  customFields    Json? @map("custom_fields")
  customQuestions Json? @map("custom_questions")

  // Migration Support
  sourceSystem   String?   @map("source_system")
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Metadata
  parentCaseId String?   @map("parent_case_id")
  isSplit      Boolean   @default(false) @map("is_split")
  releasedAt   DateTime? @map("released_at")
  releasedById String?   @map("released_by_id")
  qaNotes      String?   @map("qa_notes")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")
  updatedById String   @map("updated_by_id")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User         @relation("CaseCreatedBy", fields: [createdById], references: [id])
  updatedBy      User         @relation("CaseUpdatedBy", fields: [updatedById], references: [id])
  intakeOperator User?        @relation("CaseIntakeOperator", fields: [intakeOperatorId], references: [id])
  releasedBy     User?        @relation("CaseReleasedBy", fields: [releasedById], references: [id])
  proxySubmitter User?        @relation("CaseProxySubmitter", fields: [proxySubmitterId], references: [id])
  parentCase     Case?        @relation("CaseSplits", fields: [parentCaseId], references: [id])
  splitCases     Case[]       @relation("CaseSplits")

  // Indexes for performance
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, severity])
  @@index([referenceNumber])
  @@map("cases")
}
