// ===========================================
// Ethico Risk Intelligence Platform
// Prisma Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Core Entities
// ===========================================

/// Organization represents a tenant in the multi-tenant system.
/// All business data is scoped to an organization via Row-Level Security.
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  settings  Json     @default("{}")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users             User[]
  sessions          Session[]
  cases             Case[]
  investigations    Investigation[]
  auditLogs         AuditLog[]
  attachments       Attachment[]
  categories        Category[]
  rius              RiskIntelligenceUnit[]
  subjects          Subject[]
  caseMessages      CaseMessage[]
  interactions      Interaction[]
  workflowTemplates WorkflowTemplate[]
  workflowInstances WorkflowInstance[]
  formDefinitions   FormDefinition[]
  formSubmissions   FormSubmission[]
  reportTemplates   ReportTemplate[]
  reportExecutions  ReportExecution[]
  demoAccounts      DemoAccount[]
  locations         Location[]
  divisions         Division[]
  businessUnits     BusinessUnit[]
  departments       Department[]
  teams             Team[]
  employees         Employee[]
  persons           Person[]

  // SSO relations
  tenantDomains   TenantDomain[]
  tenantSsoConfig TenantSsoConfig?

  // Demo reset relations
  demoUserSessions DemoUserSession[]

  // Campaign relations
  segments            Segment[]
  campaigns           Campaign[]
  campaignAssignments CampaignAssignment[]

  // Association relations
  personCaseAssociations   PersonCaseAssociation[]
  personRiuAssociations    PersonRiuAssociation[]
  caseCaseAssociations     CaseCaseAssociation[]
  personPersonAssociations PersonPersonAssociation[]

  // Custom properties
  customPropertyDefinitions CustomPropertyDefinition[]

  // Investigation interview relations
  investigationInterviews InvestigationInterview[]
  interviewTemplates      InterviewTemplate[]

  // Remediation relations
  remediationPlans     RemediationPlan[]
  remediationTemplates RemediationTemplate[]

  // Saved views
  savedViews SavedView[]

  // Investigation template relations
  investigationTemplates       InvestigationTemplate[]
  categoryTemplateMappings     CategoryTemplateMapping[]
  checklistProgress            InvestigationChecklistProgress[]

  // Notification relations
  notifications            Notification[]
  notificationPreferences  NotificationPreference[]
  orgNotificationSettings  OrgNotificationSettings?

  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

/// User represents an authenticated user within an organization.
/// Users are scoped to a single organization (no cross-tenant access).
model User {
  id              String    @id @default(uuid())
  organizationId  String    @map("organization_id")
  email           String
  passwordHash    String?   @map("password_hash")
  firstName       String    @map("first_name")
  lastName        String    @map("last_name")
  role            UserRole  @default(EMPLOYEE)
  isActive        Boolean   @default(true) @map("is_active")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt     DateTime? @map("last_login_at")

  // SSO fields
  ssoProvider String? @map("sso_provider") // 'azure-ad', 'google', 'saml'
  ssoId       String? @map("sso_id") // Provider-specific unique ID (oid for Azure, sub for Google, nameID for SAML)

  // MFA fields
  mfaEnabled       Boolean   @default(false) @map("mfa_enabled")
  mfaSecret        String?   @map("mfa_secret") // TOTP secret (encrypted at rest)
  mfaVerifiedAt    DateTime? @map("mfa_verified_at")
  mfaRecoveryCodes String[]  @default([]) @map("mfa_recovery_codes") // Hashed recovery codes

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization                 Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions                     Session[]
  casesCreated                 Case[]       @relation("CaseCreatedBy")
  casesUpdated                 Case[]       @relation("CaseUpdatedBy")
  casesIntakeOperator          Case[]       @relation("CaseIntakeOperator")
  casesReleased                Case[]       @relation("CaseReleasedBy")
  casesProxySubmitter          Case[]       @relation("CaseProxySubmitter")
  casesPipelineStageBy         Case[]       @relation("CasePipelineStageBy")
  casesClassificationChangedBy Case[]       @relation("CaseClassificationChangedBy")
  casesOutcomeBy               Case[]       @relation("CaseOutcomeBy")
  casesMergedBy                Case[]       @relation("CaseMergedBy")
  auditLogsActed               AuditLog[] // Audit logs where this user was the actor

  // Investigation relations
  investigationsPrimaryInvestigator Investigation[] @relation("InvestigationPrimaryInvestigator")
  investigationsAssignedBy          Investigation[] @relation("InvestigationAssignedBy")
  investigationsClosedBy            Investigation[] @relation("InvestigationClosedBy")
  investigationsClosureApprovedBy   Investigation[] @relation("InvestigationClosureApprovedBy")
  investigationsCreatedBy           Investigation[] @relation("InvestigationCreatedBy")
  investigationsUpdatedBy           Investigation[] @relation("InvestigationUpdatedBy")

  // Investigation note relations
  investigationNotesAuthored InvestigationNote[] @relation("InvestigationNoteAuthor")

  // Attachment relations
  attachmentsUploaded Attachment[] @relation("AttachmentUploadedBy")

  // RIU relations
  riusCreated RiskIntelligenceUnit[] @relation("RiuCreatedBy")

  // RIU-Case Association relations
  riuCaseAssociationsCreated RiuCaseAssociation[] @relation("RiuCaseAssociationCreatedBy")

  // Subject relations
  subjectsCreated Subject[] @relation("SubjectCreatedBy")

  // Case Message relations
  caseMessagesCreated CaseMessage[] @relation("CaseMessageCreatedBy")
  caseMessagesRead    CaseMessage[] @relation("CaseMessageReadBy")

  // Interaction relations
  interactionsConducted  Interaction[] @relation("InteractionConductedBy")
  interactionsQaReviewed Interaction[] @relation("InteractionQaReviewedBy")

  // Demo account relations (for sales rep provisioning)
  prospectDemoAccounts DemoAccount[] @relation("ProspectUser")
  salesRepDemoAccounts DemoAccount[] @relation("SalesRepUser")

  // Demo reset relations
  demoUserSessions DemoUserSession[]

  // Notification relations
  notifications             Notification[]
  notificationPreference    NotificationPreference?
  backupForPreferences      NotificationPreference[] @relation("BackupUser")

  // Unique constraint: email must be unique within an organization
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, role])
  @@index([organizationId, isActive])
  @@index([ssoProvider, ssoId]) // SSO lookup index
  @@map("users")
}

/// Session represents an active user session (for refresh token rotation).
/// Sessions are scoped to organization for RLS compliance.
model Session {
  id                String    @id @default(uuid())
  organizationId    String    @map("organization_id")
  userId            String    @map("user_id")
  userAgent         String?   @map("user_agent")
  ipAddress         String?   @map("ip_address")
  expiresAt         DateTime  @map("expires_at")
  revokedAt         DateTime? @map("revoked_at")
  previousSessionId String?   @map("previous_session_id")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// SSO and Domain Verification Entities
// ===========================================

/// TenantDomain maps email domains to organizations for SSO tenant routing.
/// Domains must be verified via DNS TXT record before SSO can be enabled.
/// Each organization can have multiple domains, with one marked as primary.
model TenantDomain {
  id                 String    @id @default(uuid())
  organizationId     String    @map("organization_id")
  domain             String    @unique // e.g., "acme.com"
  verified           Boolean   @default(false)
  verifiedAt         DateTime? @map("verified_at")
  verificationToken  String    @map("verification_token") // Random token for DNS TXT record
  verificationMethod String    @default("DNS_TXT") @map("verification_method") // DNS_TXT, META_TAG, FILE
  isPrimary          Boolean   @default(false) @map("is_primary")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([domain])
  @@map("tenant_domains")
}

/// TenantSsoConfig stores per-tenant SSO provider configuration.
/// One config per organization (unique constraint on organizationId).
/// Supports Azure AD, Google, and generic SAML providers.
model TenantSsoConfig {
  id                     String   @id @default(uuid())
  organizationId         String   @unique @map("organization_id")
  ssoProvider            String?  @map("sso_provider") // 'azure-ad', 'google', 'saml'
  ssoEnabled             Boolean  @default(false) @map("sso_enabled")
  jitProvisioningEnabled Boolean  @default(true) @map("jit_provisioning_enabled") // Just-in-time user provisioning
  defaultRole            UserRole @default(EMPLOYEE) @map("default_role") // Role for JIT-provisioned users

  // Azure AD specific
  azureTenantId String? @map("azure_tenant_id")

  // SAML specific
  samlIdpEntityId    String? @map("saml_idp_entity_id")
  samlIdpEntryPoint  String? @map("saml_idp_entry_point")
  samlIdpCertificate String? @map("saml_idp_certificate") @db.Text // PEM format certificate
  samlSpEntityId     String? @map("saml_sp_entity_id")

  // MFA settings
  mfaRequired Boolean @default(false) @map("mfa_required")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("tenant_sso_configs")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  SYSTEM_ADMIN
  COMPLIANCE_OFFICER
  TRIAGE_LEAD
  INVESTIGATOR
  POLICY_AUTHOR
  POLICY_REVIEWER
  DEPARTMENT_ADMIN
  MANAGER
  EMPLOYEE

  @@map("user_role")
}

enum CaseStatus {
  NEW
  OPEN
  CLOSED

  @@map("case_status")
}

enum SourceChannel {
  HOTLINE
  WEB_FORM
  PROXY
  DIRECT_ENTRY
  CHATBOT

  @@map("source_channel")
}

enum CaseType {
  REPORT
  RFI

  @@map("case_type")
}

enum ReporterType {
  ANONYMOUS
  IDENTIFIED
  PROXY

  @@map("reporter_type")
}

enum ReporterRelationship {
  EMPLOYEE
  FORMER_EMPLOYEE
  VENDOR
  CONTRACTOR
  CUSTOMER
  WITNESS
  OTHER

  @@map("reporter_relationship")
}

enum Severity {
  HIGH
  MEDIUM
  LOW

  @@map("severity")
}

enum CaseOutcome {
  SUBSTANTIATED
  UNSUBSTANTIATED
  INCONCLUSIVE
  POLICY_VIOLATION
  NO_VIOLATION

  @@map("case_outcome")
}

// ===========================================
// Case Management Entities
// ===========================================

/// Case represents a compliance report or request for information.
/// This is the primary container for all case-related data.
model Case {
  id              String @id @default(uuid())
  referenceNumber String @unique @map("reference_number")
  organizationId  String @map("organization_id")

  // Status
  status          CaseStatus @default(NEW)
  statusRationale String?    @map("status_rationale")

  // Pipeline (configurable workflow stages per tenant)
  pipelineId        String?   @map("pipeline_id") // Reference to pipeline config (future)
  pipelineStage     String?   @map("pipeline_stage") // Current stage name
  pipelineStageAt   DateTime? @map("pipeline_stage_at") // When entered current stage
  pipelineStageById String?   @map("pipeline_stage_by_id") // Who moved to current stage

  // Classification Tracking (corrections to RIU classification)
  classificationNotes       String?   @map("classification_notes") // Why classification differs from RIU
  classificationChangedAt   DateTime? @map("classification_changed_at")
  classificationChangedById String?   @map("classification_changed_by_id")

  // Outcome
  outcome      CaseOutcome? // Final outcome of case
  outcomeNotes String?      @map("outcome_notes") // Explanation of outcome determination
  outcomeAt    DateTime?    @map("outcome_at") // When outcome was set
  outcomeById  String?      @map("outcome_by_id") // Who set the outcome

  // Merge Support (tombstone pattern for merged cases)
  mergedIntoCaseId String?   @map("merged_into_case_id") // Points to primary case if merged
  mergedAt         DateTime? @map("merged_at")
  mergedById       String?   @map("merged_by_id")
  mergedReason     String?   @map("merged_reason") // Why cases were merged
  isMerged         Boolean   @default(false) @map("is_merged") // True = tombstone record

  // Intake Information
  sourceChannel    SourceChannel @map("source_channel")
  caseType         CaseType      @default(REPORT) @map("case_type")
  intakeTimestamp  DateTime      @default(now()) @map("intake_timestamp")
  intakeOperatorId String?       @map("intake_operator_id")
  firstTimeCaller  Boolean?      @map("first_time_caller")
  awarenessSource  String?       @map("awareness_source")
  interpreterUsed  Boolean?      @map("interpreter_used")

  // Reporter Information
  reporterType         ReporterType          @default(ANONYMOUS) @map("reporter_type")
  reporterAnonymous    Boolean               @default(true) @map("reporter_anonymous")
  reporterName         String?               @map("reporter_name") // Encrypted
  reporterEmail        String?               @map("reporter_email") // Encrypted
  reporterPhone        String?               @map("reporter_phone") // Encrypted
  reporterRelationship ReporterRelationship? @map("reporter_relationship")
  anonymousAccessCode  String?               @map("anonymous_access_code")
  proxySubmitterId     String?               @map("proxy_submitter_id")

  // Location Information
  locationName    String?  @map("location_name")
  locationAddress String?  @map("location_address")
  locationCity    String?  @map("location_city")
  locationState   String?  @map("location_state")
  locationZip     String?  @map("location_zip")
  locationCountry String?  @map("location_country")
  locationManual  Boolean? @map("location_manual")

  // Report Content
  details             String // Full narrative (rich text)
  summary             String? // Manual summary
  addendum            String? // Operator notes
  originalLanguage    String? @map("original_language")
  translatedDetails   String? @map("translated_details")
  translationLanguage String? @map("translation_language")

  // Classification
  primaryCategoryId   String?  @map("primary_category_id")
  secondaryCategoryId String?  @map("secondary_category_id")
  severity            Severity @default(MEDIUM)
  severityReason      String?  @map("severity_reason")
  tags                String[] @default([])

  // AI Enrichment
  aiSummary            String?   @map("ai_summary")
  aiSummaryGeneratedAt DateTime? @map("ai_summary_generated_at")
  aiModelVersion       String?   @map("ai_model_version")
  aiCategorySuggestion String?   @map("ai_category_suggestion")
  aiSeveritySuggestion Severity? @map("ai_severity_suggestion")
  aiConfidenceScore    Int?      @map("ai_confidence_score")

  // Custom Data (JSONB)
  customFields    Json? @map("custom_fields")
  customQuestions Json? @map("custom_questions")

  // Migration Support
  sourceSystem   String?   @map("source_system")
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Metadata
  parentCaseId String?   @map("parent_case_id")
  isSplit      Boolean   @default(false) @map("is_split")
  releasedAt   DateTime? @map("released_at")
  releasedById String?   @map("released_by_id")
  qaNotes      String?   @map("qa_notes")

  // Demo Reset Support
  demoUserSessionId String? @map("demo_user_session_id")
  isBaseData        Boolean @default(false) @map("is_base_data") // true = immutable base data

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")
  updatedById String   @map("updated_by_id")

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User             @relation("CaseCreatedBy", fields: [createdById], references: [id])
  updatedBy       User             @relation("CaseUpdatedBy", fields: [updatedById], references: [id])
  intakeOperator  User?            @relation("CaseIntakeOperator", fields: [intakeOperatorId], references: [id])
  releasedBy      User?            @relation("CaseReleasedBy", fields: [releasedById], references: [id])
  proxySubmitter  User?            @relation("CaseProxySubmitter", fields: [proxySubmitterId], references: [id])
  parentCase      Case?            @relation("CaseSplits", fields: [parentCaseId], references: [id])
  splitCases      Case[]           @relation("CaseSplits")
  demoUserSession DemoUserSession? @relation("DemoSessionCases", fields: [demoUserSessionId], references: [id])
  investigations  Investigation[] // Cases can have multiple investigations

  // Pipeline relations
  pipelineStageBy User? @relation("CasePipelineStageBy", fields: [pipelineStageById], references: [id])

  // Classification tracking relations
  classificationChangedBy User? @relation("CaseClassificationChangedBy", fields: [classificationChangedById], references: [id])

  // Outcome relations
  outcomeBy User? @relation("CaseOutcomeBy", fields: [outcomeById], references: [id])

  // Merge relations (self-referential)
  mergedIntoCase Case?  @relation("CaseMerge", fields: [mergedIntoCaseId], references: [id])
  mergedCases    Case[] @relation("CaseMerge") // Cases that were merged into this one
  mergedBy       User?  @relation("CaseMergedBy", fields: [mergedById], references: [id])

  // Category relations
  primaryCategory   Category? @relation("CasePrimaryCategory", fields: [primaryCategoryId], references: [id])
  secondaryCategory Category? @relation("CaseSecondaryCategory", fields: [secondaryCategoryId], references: [id])

  // RIU associations (many-to-many via join table)
  riuAssociations RiuCaseAssociation[]

  // Subjects (people involved in the case)
  subjects Subject[]

  // Communication
  messages CaseMessage[]

  // Follow-up interactions
  interactions Interaction[]

  // First-class association relations (HubSpot V4 pattern)
  personAssociations   PersonCaseAssociation[]
  caseAssociationsFrom CaseCaseAssociation[]   @relation("CaseAssociationSource")
  caseAssociationsTo   CaseCaseAssociation[]   @relation("CaseAssociationTarget")

  // Full-text search vector (auto-populated by database trigger)
  /// @db.Unsupported("tsvector")
  searchVector Unsupported("tsvector")? @map("search_vector")

  // Remediation plans
  remediationPlans RemediationPlan[]

  // Indexes for performance
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, severity])
  @@index([referenceNumber])
  // Pipeline, outcome, and merge indexes
  @@index([organizationId, pipelineStage])
  @@index([organizationId, outcome])
  @@index([organizationId, isMerged])
  @@index([mergedIntoCaseId])
  @@map("cases")
}

// ===========================================
// Audit Log (Unified Activity Tracking)
// ===========================================

/// AuditLog provides unified activity tracking across all entities.
/// This is an append-only table - records are never updated or deleted.
/// Used for compliance audit trails and AI context building.
///
/// PARTITIONING: Partition by created_at in production (monthly partitions)
/// recommended partition command:
///   CREATE TABLE audit_logs_y2026m01 PARTITION OF audit_logs
///   FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
///
/// RETENTION: 7 years per compliance requirements (HIPAA, SOX)
/// ARCHIVAL: Old partitions can be moved to cold storage after 2 years
model AuditLog {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Entity Reference (polymorphic)
  entityType AuditEntityType @map("entity_type")
  entityId   String          @map("entity_id")

  // Action
  action            String // e.g., 'created', 'updated', 'status_changed'
  actionCategory    AuditActionCategory @map("action_category")
  actionDescription String              @map("action_description") // Natural language: "John assigned case to Sarah"

  // Actor
  actorUserId String?   @map("actor_user_id") // Null for system/AI actions
  actorType   ActorType @map("actor_type")
  actorName   String?   @map("actor_name") // Denormalized for display

  // Change Details
  changes Json? // { field: { old, new } }
  context Json? // Additional context for AI

  // Request Metadata
  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")
  requestId String? @map("request_id") // Correlation ID

  // Timestamp (immutable - NO updatedAt for append-only)
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorUser    User?        @relation(fields: [actorUserId], references: [id])

  // Indexes for query patterns
  @@index([organizationId, createdAt])
  @@index([organizationId, entityType, entityId, createdAt])
  @@index([organizationId, actorUserId, createdAt])
  @@index([organizationId, actionCategory, createdAt])
  @@map("audit_logs")
}

// ===========================================
// Audit Log Enums
// ===========================================

enum AuditEntityType {
  CASE
  RIU
  INVESTIGATION
  DISCLOSURE
  POLICY
  ATTESTATION
  WORKFLOW
  USER
  EMPLOYEE
  ORGANIZATION
  CATEGORY
  FORM
  CHATBOT_CONVERSATION
  REPORT
  DASHBOARD
  INTEGRATION
  ATTACHMENT
  SUBJECT
  CASE_MESSAGE
  INTERACTION
  DEMO_ACCOUNT
  PERSON
  SEGMENT
  CAMPAIGN
  CAMPAIGN_ASSIGNMENT
  REMEDIATION_PLAN
  REMEDIATION_STEP

  @@map("audit_entity_type")
}

enum AuditActionCategory {
  CREATE
  UPDATE
  DELETE
  ACCESS // View, download, export
  SYSTEM // Automated actions
  SECURITY // Auth events
  AI // AI-generated actions

  @@map("audit_action_category")
}

enum ActorType {
  USER // Human user
  SYSTEM // Automated process
  AI // AI-generated action
  INTEGRATION // External system
  ANONYMOUS // Anonymous reporter action

  @@map("actor_type")
}

// ===========================================
// Investigation Enums
// ===========================================

enum InvestigationStatus {
  NEW
  ASSIGNED
  INVESTIGATING
  PENDING_REVIEW
  CLOSED
  ON_HOLD

  @@map("investigation_status")
}

enum InvestigationType {
  FULL
  LIMITED
  INQUIRY

  @@map("investigation_type")
}

enum InvestigationDepartment {
  HR
  LEGAL
  SAFETY
  COMPLIANCE
  OTHER

  @@map("investigation_department")
}

enum InvestigationOutcome {
  SUBSTANTIATED
  UNSUBSTANTIATED
  INCONCLUSIVE
  POLICY_VIOLATION
  NO_VIOLATION
  INSUFFICIENT_EVIDENCE

  @@map("investigation_outcome")
}

enum SlaStatus {
  ON_TRACK
  WARNING
  OVERDUE

  @@map("sla_status")
}

// ===========================================
// Investigation Note Enums
// ===========================================

enum NoteType {
  GENERAL
  INTERVIEW
  EVIDENCE
  FINDING
  RECOMMENDATION
  FOLLOW_UP

  @@map("note_type")
}

enum NoteVisibility {
  PRIVATE // Author only
  TEAM // Assigned investigators
  ALL // All org users with case access

  @@map("note_visibility")
}

// ===========================================
// Investigation Interview Enums
// ===========================================

/// InterviewStatus tracks the lifecycle of an investigation interview.
enum InterviewStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED

  @@map("interview_status")
}

/// IntervieweeType classifies how the interviewee is identified.
enum IntervieweeType {
  PERSON // Linked to Person record
  EXTERNAL // Freeform name (not in system)
  ANONYMOUS // Anonymous participant

  @@map("interviewee_type")
}

// ===========================================
// Attachment Enums
// ===========================================

enum AttachmentEntityType {
  CASE
  INVESTIGATION
  INVESTIGATION_NOTE

  @@map("attachment_entity_type")
}

// ===========================================
// Investigation Entity
// ===========================================

/// Investigation represents a formal investigation linked to a Case.
/// Cases can have multiple investigations (e.g., HR and Legal investigating same report).
/// organizationId is denormalized from Case for RLS efficiency.
model Investigation {
  id                  String @id @default(uuid())
  caseId              String @map("case_id")
  organizationId      String @map("organization_id") // Denormalized for RLS
  investigationNumber Int    @map("investigation_number") // 1, 2, 3... within case

  // Classification
  categoryId        String?                  @map("category_id")
  investigationType InvestigationType        @default(FULL) @map("investigation_type")
  department        InvestigationDepartment? @map("department")

  // Assignment
  assignedTo            String[]  @default([]) @map("assigned_to") // Array of user IDs
  primaryInvestigatorId String?   @map("primary_investigator_id")
  assignedAt            DateTime? @map("assigned_at")
  assignedById          String?   @map("assigned_by_id")
  assignmentHistory     Json?     @map("assignment_history") // Track assignment changes

  // Workflow
  status          InvestigationStatus @default(NEW)
  statusRationale String?             @map("status_rationale") // AI-first: why status changed
  statusChangedAt DateTime?           @map("status_changed_at")
  dueDate         DateTime?           @map("due_date")
  slaStatus       SlaStatus           @default(ON_TRACK) @map("sla_status")

  // Findings
  findingsSummary String?               @map("findings_summary")
  findingsDetail  String?               @map("findings_detail")
  outcome         InvestigationOutcome? @map("outcome")
  rootCause       String?               @map("root_cause")
  lessonsLearned  String?               @map("lessons_learned")
  findingsDate    DateTime?             @map("findings_date")

  // Closure
  closedAt            DateTime? @map("closed_at")
  closedById          String?   @map("closed_by_id")
  closureApprovedById String?   @map("closure_approved_by_id")
  closureApprovedAt   DateTime? @map("closure_approved_at")
  closureNotes        String?   @map("closure_notes")

  // Template
  templateId        String? @map("template_id")
  templateResponses Json?   @map("template_responses") // Checklist answers
  templateCompleted Boolean @default(false) @map("template_completed")

  // Migration Support
  sourceSystem   String?   @map("source_system")
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Demo Reset Support
  demoUserSessionId String? @map("demo_user_session_id")
  isBaseData        Boolean @default(false) @map("is_base_data") // true = immutable base data

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")
  updatedById String   @map("updated_by_id")

  // Relations
  case                Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  organization        Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  primaryInvestigator User?            @relation("InvestigationPrimaryInvestigator", fields: [primaryInvestigatorId], references: [id])
  assignedBy          User?            @relation("InvestigationAssignedBy", fields: [assignedById], references: [id])
  closedBy            User?            @relation("InvestigationClosedBy", fields: [closedById], references: [id])
  closureApprovedBy   User?            @relation("InvestigationClosureApprovedBy", fields: [closureApprovedById], references: [id])
  createdBy           User             @relation("InvestigationCreatedBy", fields: [createdById], references: [id])
  updatedBy           User             @relation("InvestigationUpdatedBy", fields: [updatedById], references: [id])
  demoUserSession     DemoUserSession? @relation("DemoSessionInvestigations", fields: [demoUserSessionId], references: [id])

  // Child entities
  notes             InvestigationNote[]
  interviews        InvestigationInterview[]
  checklistProgress InvestigationChecklistProgress?

  @@unique([caseId, investigationNumber])
  // Indexes for query patterns
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, status])
  @@index([organizationId, primaryInvestigatorId])
  @@index([organizationId, dueDate])
  @@index([organizationId, slaStatus])
  @@map("investigations")
}

// ===========================================
// Investigation Note Entity
// ===========================================

/// InvestigationNote stores rich-text notes on investigations.
/// Notes can be general, interview records, evidence documentation, findings, recommendations, or follow-ups.
/// organizationId is denormalized from Investigation for RLS efficiency.
model InvestigationNote {
  id              String @id @default(uuid())
  investigationId String @map("investigation_id")
  organizationId  String @map("organization_id") // Denormalized from Investigation for RLS

  // Content
  content          String   @db.VarChar(50000) // Rich text (HTML/markdown)
  contentPlainText String?  @map("content_plain_text") // Auto-generated in service layer for search
  noteType         NoteType @default(GENERAL) @map("note_type")

  // Visibility
  visibility NoteVisibility @default(TEAM)

  // Author
  authorId   String @map("author_id")
  authorName String @map("author_name") // Denormalized for display performance

  // Edit Tracking
  isEdited  Boolean   @default(false) @map("is_edited")
  editedAt  DateTime? @map("edited_at")
  editCount Int       @default(0) @map("edit_count")

  // Attachments (JSON array: [{ id, filename, url, size, mimeType }])
  attachments Json @default("[]")

  // AI Enrichment
  aiSummary            String?   @map("ai_summary")
  aiSummaryGeneratedAt DateTime? @map("ai_summary_generated_at")
  aiModelVersion       String?   @map("ai_model_version")

  // Migration Support
  sourceSystem   String?   @map("source_system") // e.g., 'NAVEX', 'EQS', 'MANUAL'
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  investigation Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  author        User          @relation("InvestigationNoteAuthor", fields: [authorId], references: [id])

  // Indexes for query patterns
  @@index([organizationId, investigationId]) // Primary query pattern
  @@index([organizationId, authorId]) // Author filtering
  @@index([createdAt]) // Timeline sorting
  @@map("investigation_notes")
}

// ===========================================
// Investigation Interview Entity
// ===========================================

/// InvestigationInterview records structured interviews during investigations.
/// Supports Person-linked, external (freeform), and anonymous interviewees.
/// Template questions enable consistent documentation across investigations.
model InvestigationInterview {
  id              String @id @default(uuid())
  organizationId  String @map("organization_id")
  investigationId String @map("investigation_id")

  // Interviewee (either link to Person OR freeform)
  intervieweeType     IntervieweeType @map("interviewee_type")
  intervieweePersonId String?         @map("interviewee_person_id")
  intervieweeName     String?         @map("interviewee_name") // For EXTERNAL type
  intervieweeTitle    String?         @map("interviewee_title")
  intervieweeEmail    String?         @map("interviewee_email")
  intervieweePhone    String?         @map("interviewee_phone")

  // Interview metadata
  status      InterviewStatus @default(SCHEDULED)
  scheduledAt DateTime?       @map("scheduled_at")
  startedAt   DateTime?       @map("started_at")
  completedAt DateTime?       @map("completed_at")
  duration    Int? // Duration in minutes
  location    String? // Physical location or "Video Call"

  // Interviewer(s)
  conductedById           String   @map("conducted_by_id")
  secondaryInterviewerIds String[] @default([]) @map("secondary_interviewer_ids")

  // Content
  purpose     String? // Purpose/scope of interview
  notes       String? @db.Text // Rich text notes
  summary     String? // Brief summary
  keyFindings String? @map("key_findings") // Important findings

  // Template Questions (JSON)
  templateId String? @map("template_id") // Reference to interview template
  questions  Json? // Array of { questionId, question, response, isRequired }

  // Checklist linking (can link to specific checklist item as evidence)
  checklistItemId String? @map("checklist_item_id")

  // Recording
  hasRecording  Boolean @default(false) @map("has_recording")
  recordingUrl  String? @map("recording_url")
  transcriptUrl String? @map("transcript_url")

  // Consent
  consentObtained Boolean @default(false) @map("consent_obtained")
  consentNotes    String? @map("consent_notes")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization  Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  investigation Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([organizationId, investigationId])
  @@index([organizationId, intervieweePersonId])
  @@index([organizationId, status])
  @@map("investigation_interviews")
}

// ===========================================
// Interview Template Entity
// ===========================================

/// InterviewTemplate stores reusable question sets for structured interviews.
/// Can be scoped to specific categories for category-specific interview workflows.
model InterviewTemplate {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  name        String
  description String?
  categoryId  String? @map("category_id") // For category-specific templates

  // Questions (JSON array)
  questions Json // Array of { id, question, isRequired, guidance, order }

  isActive Boolean @default(true) @map("is_active")
  isSystem Boolean @default(false) @map("is_system")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, categoryId])
  @@map("interview_templates")
}

// ===========================================
// Attachment Entity (File Storage)
// ===========================================

/// Attachment stores file metadata for uploads across multiple entity types.
/// Uses polymorphic pattern (entityType + entityId) to link to Cases, Investigations, or Notes.
/// Actual file content stored in Azure Blob Storage; this table stores metadata only.
model Attachment {
  id             String @id @default(uuid())
  organizationId String @map("organization_id") // Denormalized for RLS

  // Polymorphic reference to parent entity
  entityType AttachmentEntityType @map("entity_type")
  entityId   String               @map("entity_id")

  // File metadata
  fileName String @map("file_name") // Original filename
  fileKey  String @map("file_key") // Storage key/path in blob storage
  mimeType String @map("mime_type") // MIME type (e.g., "application/pdf")
  fileSize Int    @map("file_size") // Size in bytes

  // Optional metadata
  description String? // User-provided description
  isEvidence  Boolean @default(false) @map("is_evidence") // Flag for investigation evidence

  // Audit
  uploadedById String   @map("uploaded_by_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  uploadedBy   User         @relation("AttachmentUploadedBy", fields: [uploadedById], references: [id])

  // Indexes for query patterns
  @@index([organizationId]) // RLS performance
  @@index([entityType, entityId]) // Lookup attachments for an entity
  @@index([organizationId, entityType, entityId]) // Combined filter with tenant
  @@index([uploadedById]) // User's uploads
  @@map("attachments")
}

// ===========================================
// Category Entity (Hierarchical Taxonomy)
// ===========================================

/// Category provides unified taxonomy for classification across modules.
/// Used for Cases, RIUs, Disclosures, and Policies.
/// Supports hierarchical structure via self-referential parent relationship.
model Category {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  code        String? // Short code (e.g., "HAR" for Harassment)
  description String?

  // Hierarchy
  parentCategoryId String? @map("parent_category_id")
  level            Int     @default(0) // 0 = top level
  path             String? // Materialized path: "/root/child/grandchild"

  // Classification
  module     CategoryModule // Which module(s) use this category
  conceptKey String?        @map("concept_key") // Cross-module correlation key

  // Behavior
  severityDefault       Severity? @map("severity_default") // Default severity for this category
  requiresInvestigation Boolean   @default(true) @map("requires_investigation")
  escalationRequired    Boolean   @default(false) @map("escalation_required")
  slaDays               Int?      @map("sla_days") // Target resolution time

  // Routing
  defaultAssigneeId String? @map("default_assignee_id")
  routingRules      Json?   @map("routing_rules") // Complex routing configuration

  // Module-Specific Config
  moduleConfig Json? @map("module_config")

  // Display
  icon      String?
  color     String? // Hex color
  sortOrder Int     @default(0) @map("sort_order")

  // Status
  isActive Boolean @default(true) @map("is_active")
  isSystem Boolean @default(false) @map("is_system") // System-managed, not editable

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  parentCategory  Category?    @relation("CategoryHierarchy", fields: [parentCategoryId], references: [id])
  childCategories Category[]   @relation("CategoryHierarchy")

  // Case relations
  casesPrimary   Case[] @relation("CasePrimaryCategory")
  casesSecondary Case[] @relation("CaseSecondaryCategory")

  // RIU relations
  rius RiskIntelligenceUnit[]

  // Investigation template mappings
  templateMappings CategoryTemplateMapping[]

  // Unique constraints
  @@unique([organizationId, module, code])
  // Indexes
  @@index([organizationId])
  @@index([organizationId, module])
  @@index([organizationId, parentCategoryId])
  @@index([organizationId, conceptKey])
  @@index([organizationId, isActive])
  @@map("categories")
}

enum CategoryModule {
  CASE
  DISCLOSURE
  POLICY
  ALL

  @@map("category_module")
}

// ===========================================
// Risk Intelligence Unit (RIU) Entity
// ===========================================

/// RiskIntelligenceUnit represents an immutable intake record - something that happened.
/// This is the "Contact" parallel to HubSpot's architecture.
/// RIUs are IMMUTABLE after creation - corrections go on the Case, not the RIU.
/// NO updatedAt field - emphasizes immutability of intake content.
model RiskIntelligenceUnit {
  id              String @id @default(uuid())
  organizationId  String @map("organization_id")
  referenceNumber String @unique @map("reference_number") // RIU-2024-001

  // === IMMUTABLE FIELDS (set at creation, never modified) ===

  // Type Classification
  type          RiuType // hotline_report, web_form_submission, etc.
  sourceChannel RiuSourceChannel @map("source_channel") // phone, web_form, chatbot, etc.

  // Core Content
  details String // Reporter's narrative (rich text)
  summary String? // Brief summary

  // Reporter Information
  reporterType        RiuReporterType @map("reporter_type") // anonymous, confidential, identified
  anonymousAccessCode String?         @map("anonymous_access_code") // For anonymous status checks
  reporterName        String?         @map("reporter_name") // Encrypted if identified
  reporterEmail       String?         @map("reporter_email") // Encrypted if identified
  reporterPhone       String?         @map("reporter_phone") // Encrypted if identified

  // Classification (as captured at intake - corrections go on Case)
  categoryId String?  @map("category_id")
  severity   Severity @default(MEDIUM)

  // Location Information
  locationName    String? @map("location_name")
  locationAddress String? @map("location_address")
  locationCity    String? @map("location_city")
  locationState   String? @map("location_state")
  locationZip     String? @map("location_zip")
  locationCountry String? @map("location_country")

  // Campaign linkage (for disclosure/attestation responses)
  campaignId           String? @map("campaign_id")
  campaignAssignmentId String? @map("campaign_assignment_id") // Links to specific assignment

  // Custom Data (JSONB)
  customFields  Json? @map("custom_fields")
  formResponses Json? @map("form_responses") // Structured form data

  // Migration Support (immutable - captured at import time)
  sourceSystem   String?   @map("source_system") // 'NAVEX', 'EQS', 'MANUAL'
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Audit (NO updatedAt - emphasizes immutability)
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // === MUTABLE FIELDS (can change after creation) ===

  // Status Workflow
  status            RiuStatus @default(PENDING_QA)
  statusChangedAt   DateTime? @map("status_changed_at")
  statusChangedById String?   @map("status_changed_by_id")

  // Language Handling (per CONTEXT.md decision)
  languageDetected  String? @map("language_detected") // Auto-detected from content
  languageConfirmed String? @map("language_confirmed") // Manual override by user
  languageEffective String? @map("language_effective") // confirmed ?? detected ?? 'en'

  // === AI ENRICHMENT (can be regenerated) ===
  aiSummary          String?   @map("ai_summary")
  aiRiskScore        Decimal?  @map("ai_risk_score") @db.Decimal(3, 2) // 0.00 to 1.00
  aiTranslation      String?   @map("ai_translation")
  aiLanguageDetected String?   @map("ai_language_detected")
  aiModelVersion     String?   @map("ai_model_version")
  aiGeneratedAt      DateTime? @map("ai_generated_at")
  aiConfidenceScore  Int?      @map("ai_confidence_score") // 0-100

  // === DEMO SUPPORT ===
  demoUserSessionId String? @map("demo_user_session_id")
  isBaseData        Boolean @default(false) @map("is_base_data") // true = immutable base data

  // Relations
  organization    Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy       User             @relation("RiuCreatedBy", fields: [createdById], references: [id])
  category        Category?        @relation(fields: [categoryId], references: [id])
  demoUserSession DemoUserSession? @relation("DemoSessionRius", fields: [demoUserSessionId], references: [id])

  // Campaign relation (for campaign responses)
  campaign Campaign? @relation("CampaignRius", fields: [campaignId], references: [id])

  // Case associations
  caseAssociations RiuCaseAssociation[]

  // Interactions (follow-up contacts)
  interactions Interaction[]

  // First-class Person-RIU associations (HubSpot V4 pattern)
  personAssociations PersonRiuAssociation[]

  // Type-specific extensions (1:1 relations)
  hotlineExtension    RiuHotlineExtension?
  disclosureExtension RiuDisclosureExtension?
  webFormExtension    RiuWebFormExtension?

  // Indexes
  @@index([organizationId])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, sourceChannel])
  @@index([organizationId, createdAt])
  @@index([organizationId, categoryId])
  @@index([organizationId, severity])
  @@index([anonymousAccessCode])
  @@index([organizationId, campaignId])
  @@map("risk_intelligence_units")
}

enum RiuType {
  HOTLINE_REPORT
  WEB_FORM_SUBMISSION
  DISCLOSURE_RESPONSE
  ATTESTATION_RESPONSE
  CHATBOT_TRANSCRIPT
  INCIDENT_FORM
  PROXY_REPORT
  SURVEY_RESPONSE

  @@map("riu_type")
}

enum RiuSourceChannel {
  PHONE
  WEB_FORM
  CHATBOT
  EMAIL
  PROXY
  DIRECT_ENTRY
  CAMPAIGN

  @@map("riu_source_channel")
}

enum RiuReporterType {
  ANONYMOUS
  CONFIDENTIAL
  IDENTIFIED

  @@map("riu_reporter_type")
}

enum RiuStatus {
  // QA workflow states
  PENDING_QA // Awaiting QA review (hotline reports)
  IN_QA // Currently being reviewed by QA
  QA_REJECTED // QA found issues, needs rework

  // Post-QA states
  RELEASED // QA approved, ready for Case creation
  LINKED // Associated with one or more Cases
  CLOSED // RIU closed without creating Case (valid per HubSpot pattern)

  // Campaign/web form responses (no QA needed)
  RECEIVED // Web form - no QA needed
  COMPLETED // Campaign response completed

  @@map("riu_status")
}

// ===========================================
// RIU Extension Enums
// ===========================================

/// QA status for hotline RIU quality assurance workflow
enum RiuQaStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  NEEDS_REVISION

  @@map("riu_qa_status")
}

/// Types of disclosures that can be submitted
enum DisclosureType {
  COI // Conflict of Interest
  GIFT // Gifts & Entertainment
  OUTSIDE_EMPLOYMENT // Outside business activities
  POLITICAL // Political contributions
  CHARITABLE // Charitable donations
  TRAVEL // Travel & hospitality

  @@map("disclosure_type")
}

// ===========================================
// RIU Extension Tables
// ===========================================

/// Hotline-specific fields for RIU type = HOTLINE_REPORT
/// Extension table pattern: base RIU + type-specific data for database-level constraints
model RiuHotlineExtension {
  id             String @id @default(uuid())
  riuId          String @unique @map("riu_id")
  organizationId String @map("organization_id")

  // Call metadata
  callDuration        Int?    @map("call_duration") // seconds
  interpreterUsed     Boolean @default(false) @map("interpreter_used")
  interpreterLanguage String? @map("interpreter_language")
  callerDemeanor      String? @map("caller_demeanor") // calm, distressed, angry, fearful
  transferredFrom     String? @map("transferred_from") // phone number if transferred
  recordingUrl        String? @map("recording_url")
  callbackRequested   Boolean @default(false) @map("callback_requested")
  callbackNumber      String? @map("callback_number")

  // Operator notes
  operatorNotes String? @map("operator_notes")

  // QA workflow
  qaStatus          RiuQaStatus @default(PENDING) @map("qa_status")
  qaReviewerId      String?     @map("qa_reviewer_id")
  qaReviewedAt      DateTime?   @map("qa_reviewed_at")
  qaNotes           String?     @map("qa_notes")
  qaRejectionReason String?     @map("qa_rejection_reason")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  riu RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([qaStatus])
  @@map("riu_hotline_extensions")
}

/// Disclosure-specific fields for RIU type = DISCLOSURE_RESPONSE
/// Tracks value thresholds and conflict detection for compliance review
model RiuDisclosureExtension {
  id             String @id @default(uuid())
  riuId          String @unique @map("riu_id")
  organizationId String @map("organization_id")

  // Disclosure classification
  disclosureType    DisclosureType @map("disclosure_type")
  disclosureSubtype String?        @map("disclosure_subtype") // e.g., "vendor relationship"

  // Value tracking
  disclosureValue      Decimal? @map("disclosure_value") @db.Decimal(12, 2)
  disclosureCurrency   String?  @map("disclosure_currency") // ISO 4217
  estimatedAnnualValue Decimal? @map("estimated_annual_value") @db.Decimal(12, 2)

  // Threshold and conflict detection
  thresholdTriggered Boolean  @default(false) @map("threshold_triggered")
  thresholdAmount    Decimal? @map("threshold_amount") @db.Decimal(12, 2)
  conflictDetected   Boolean  @default(false) @map("conflict_detected")
  conflictReason     String?  @map("conflict_reason")

  // Related party (who the disclosure involves)
  relatedPersonId   String? @map("related_person_id")
  relatedPersonName String? @map("related_person_name")
  relatedCompany    String? @map("related_company")
  relationshipType  String? @map("relationship_type") // spouse, family, business_partner

  // Dates
  effectiveDate  DateTime? @map("effective_date")
  expirationDate DateTime? @map("expiration_date")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  riu RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([disclosureType])
  @@index([thresholdTriggered])
  @@index([conflictDetected])
  @@map("riu_disclosure_extensions")
}

/// Web form-specific fields for RIU type = WEB_FORM_SUBMISSION
/// Tracks form version, submission metadata, and validation state
model RiuWebFormExtension {
  id             String @id @default(uuid())
  riuId          String @unique @map("riu_id")
  organizationId String @map("organization_id")

  // Form metadata
  formDefinitionId      String  @map("form_definition_id")
  formDefinitionVersion Int     @map("form_definition_version")
  formName              String? @map("form_name")

  // Submission metadata
  submissionSource   String? @map("submission_source") // portal, embed, api
  submitterIpAddress String? @map("submitter_ip_address")
  submitterUserAgent String? @map("submitter_user_agent")
  submissionDuration Int?    @map("submission_duration") // seconds from start to submit

  // Validation
  validationPassed Boolean @default(true) @map("validation_passed")
  validationErrors Json?   @map("validation_errors")

  // Attachments summary
  attachmentCount     Int @default(0) @map("attachment_count")
  totalAttachmentSize Int @default(0) @map("total_attachment_size") // bytes

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  riu RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([formDefinitionId])
  @@map("riu_web_form_extensions")
}

// ===========================================
// RIU-Case Association Entity
// ===========================================

/// RiuCaseAssociation links Risk Intelligence Units to Cases (many-to-many).
/// Multiple RIUs can be associated with a single Case (related reports).
/// A single RIU typically has one primary Case but could be linked to multiple Cases.
model RiuCaseAssociation {
  id     String @id @default(uuid())
  riuId  String @map("riu_id")
  caseId String @map("case_id")

  // Association Type
  associationType RiuAssociationType @default(PRIMARY) @map("association_type")

  // Notes
  notes String? // Why this association was made

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // Relations
  riu       RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)
  case      Case                 @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy User                 @relation("RiuCaseAssociationCreatedBy", fields: [createdById], references: [id])

  // Unique constraint: one association per RIU-Case pair
  @@unique([riuId, caseId])
  // Indexes
  @@index([riuId])
  @@index([caseId])
  @@index([associationType])
  @@map("riu_case_associations")
}

enum RiuAssociationType {
  PRIMARY // First RIU that created the Case
  RELATED // Subsequently linked RIU
  MERGED_FROM // RIU came from a merged Case

  @@map("riu_association_type")
}

// ===========================================
// Subject Entity (People Involved in Cases)
// ===========================================

/// Subject represents people named in Cases for cross-case pattern detection.
/// Can link to Employee records (HRIS) or store external names for non-employees.
/// Used to identify repeat subjects across multiple cases.
model Subject {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  caseId         String @map("case_id")

  // Identity - either link to Employee OR manual entry
  employeeId   String? @map("employee_id") // FK to HRIS Employee if linked
  externalName String? @map("external_name") // For non-employees
  email        String?
  phone        String?

  // Role in Case
  role SubjectRole // reporter, accused, witness, victim, other

  // Context
  relationship String? // 'employee', 'vendor', 'contractor', etc.
  department   String?
  location     String?
  jobTitle     String? @map("job_title")
  managerName  String? @map("manager_name")

  // HRIS Snapshot (captured at time of case creation for historical accuracy)
  hrisSnapshot Json? @map("hris_snapshot")

  // Notes
  notes String? // Context about subject's involvement

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy    User         @relation("SubjectCreatedBy", fields: [createdById], references: [id])

  // Indexes for cross-case pattern detection
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, employeeId])
  @@index([organizationId, role])
  @@map("subjects")
}

enum SubjectRole {
  REPORTER
  ACCUSED
  WITNESS
  VICTIM
  OTHER

  @@map("subject_role")
}

// ===========================================
// Case Message Entity (Anonymous Communication)
// ===========================================

/// CaseMessage provides two-way anonymous communication between reporters and investigators.
/// Ethico acts as a relay protecting reporter identity (Chinese Wall model).
/// Reporter contact info is stored on RIU but hidden from Case users.
model CaseMessage {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  caseId         String @map("case_id")

  // Direction and Sender
  direction  MessageDirection // inbound (from reporter), outbound (to reporter)
  senderType MessageSenderType @map("sender_type") // reporter, investigator, system

  // Content
  content String // Message body (rich text)
  subject String? // Optional subject line

  // Read Status
  isRead   Boolean   @default(false) @map("is_read")
  readAt   DateTime? @map("read_at")
  readById String?   @map("read_by_id")

  // Delivery Status (for outbound messages)
  deliveryStatus MessageDeliveryStatus? @map("delivery_status")
  deliveredAt    DateTime?              @map("delivered_at")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String?  @map("created_by_id") // Null for reporter messages

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("CaseMessageCreatedBy", fields: [createdById], references: [id])
  readBy       User?        @relation("CaseMessageReadBy", fields: [readById], references: [id])

  // Indexes
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, caseId, createdAt])
  @@index([organizationId, isRead])
  @@map("case_messages")
}

enum MessageDirection {
  INBOUND // From reporter to investigators
  OUTBOUND // From investigators to reporter

  @@map("message_direction")
}

enum MessageSenderType {
  REPORTER // Anonymous or identified reporter
  INVESTIGATOR // Case investigator or assignee
  SYSTEM // Automated system message

  @@map("message_sender_type")
}

enum MessageDeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED

  @@map("message_delivery_status")
}

// ===========================================
// Interaction Entity (Follow-up Contacts)
// ===========================================

/// Interaction records follow-up contacts and status checks on Cases.
/// Distinct from CaseMessage - Interactions are internal notes about contacts,
/// while CaseMessages are the actual two-way communication content.
model Interaction {
  id             String  @id @default(uuid())
  organizationId String  @map("organization_id")
  caseId         String  @map("case_id")
  riuId          String? @map("riu_id") // Links to follow-up RIU if new info creates one

  // Type and Channel
  interactionType InteractionType    @map("interaction_type")
  channel         InteractionChannel

  // Content
  summary  String // Brief summary of interaction
  notes    String? // Detailed notes (rich text)
  addendum String? // Operator notes on caller demeanor, etc.

  // New Information Tracking
  newInfoAdded      Boolean @default(false) @map("new_info_added")
  fieldsUpdated     Json?   @map("fields_updated") // Which case fields were updated
  additionalDetails String? @map("additional_details") // Appended narrative

  // QA (for hotline follow-ups)
  qaRequired     Boolean              @default(false) @map("qa_required")
  qaStatus       InteractionQaStatus? @map("qa_status")
  qaReviewedById String?              @map("qa_reviewed_by_id")
  qaReviewedAt   DateTime?            @map("qa_reviewed_at")

  // Who conducted the interaction
  conductedById String   @map("conducted_by_id")
  conductedAt   DateTime @map("conducted_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         Case                  @relation(fields: [caseId], references: [id], onDelete: Cascade)
  riu          RiskIntelligenceUnit? @relation(fields: [riuId], references: [id])
  conductedBy  User                  @relation("InteractionConductedBy", fields: [conductedById], references: [id])
  qaReviewedBy User?                 @relation("InteractionQaReviewedBy", fields: [qaReviewedById], references: [id])

  // Indexes
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, caseId, conductedAt])
  @@index([organizationId, interactionType])
  @@map("interactions")
}

enum InteractionType {
  STATUS_CHECK // Reporter checking on case status
  ADDITIONAL_INFO // Reporter providing new information
  FOLLOW_UP_QUESTION // Investigator reaching out with questions
  INTERVIEW // Formal interview conducted
  CALLBACK // Scheduled callback completed

  @@map("interaction_type")
}

enum InteractionChannel {
  PHONE
  EMAIL
  PORTAL
  IN_PERSON
  VIDEO

  @@map("interaction_channel")
}

enum InteractionQaStatus {
  PENDING
  APPROVED
  NEEDS_REVISION
  RELEASED

  @@map("interaction_qa_status")
}

// ===========================================
// Workflow Engine Entities
// ===========================================

/// WorkflowTemplate defines a reusable workflow pipeline.
/// Templates are versioned - version increments on publish.
/// entityType determines which entities this workflow applies to.
model WorkflowTemplate {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  description String?
  entityType  WorkflowEntityType @map("entity_type") // CASE, INVESTIGATION, DISCLOSURE, etc.
  version     Int                @default(1)
  isActive    Boolean            @default(true) @map("is_active")
  isDefault   Boolean            @default(false) @map("is_default") // Default workflow for this entity type

  // Configuration (JSON)
  stages       Json // Array of WorkflowStage definitions
  transitions  Json // Array of allowed transitions
  initialStage String @map("initial_stage") // Stage ID to start at

  // SLA Configuration
  defaultSlaDays Int?  @map("default_sla_days")
  slaConfig      Json? @map("sla_config") // Stage-level SLA overrides

  // Metadata
  sourceTemplateId String?  @map("source_template_id") // If cloned from Ethico library
  tags             String[] @default([])

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")

  // Relations
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  instances    WorkflowInstance[]

  @@unique([organizationId, name, version])
  @@index([organizationId])
  @@index([organizationId, entityType])
  @@index([organizationId, isActive])
  @@map("workflow_templates")
}

/// WorkflowInstance tracks an entity's progress through a workflow.
/// Links to the specific template VERSION to ensure in-flight stability.
model WorkflowInstance {
  id              String @id @default(uuid())
  organizationId  String @map("organization_id")
  templateId      String @map("template_id")
  templateVersion Int    @map("template_version")

  // Entity Reference (polymorphic)
  entityType WorkflowEntityType @map("entity_type")
  entityId   String             @map("entity_id")

  // Current State
  currentStage String                 @map("current_stage")
  currentStep  String?                @map("current_step")
  status       WorkflowInstanceStatus @default(ACTIVE)
  stepStates   Json                   @default("{}") @map("step_states") // { stepId: { status, completedAt, assignee } }

  // SLA Tracking
  dueDate       DateTime? @map("due_date")
  slaStatus     SlaStatus @default(ON_TRACK) @map("sla_status")
  slaBreachedAt DateTime? @map("sla_breached_at")

  // Completion
  completedAt DateTime? @map("completed_at")
  outcome     String? // Final outcome (if workflow has outcomes)

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  startedById String?  @map("started_by_id")

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     WorkflowTemplate @relation(fields: [templateId], references: [id])

  @@unique([entityType, entityId]) // One active workflow per entity
  @@index([organizationId])
  @@index([organizationId, entityType])
  @@index([organizationId, status])
  @@index([organizationId, currentStage])
  @@index([organizationId, slaStatus])
  @@map("workflow_instances")
}

enum WorkflowEntityType {
  CASE
  INVESTIGATION
  DISCLOSURE
  POLICY
  CAMPAIGN

  @@map("workflow_entity_type")
}

enum WorkflowInstanceStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED

  @@map("workflow_instance_status")
}

// ===========================================
// Form Engine Entities
// ===========================================

/// FormDefinition stores JSON Schema definitions for dynamic forms.
/// Used for intake forms, disclosure forms, workflow tasks, surveys.
/// Definitions are versioned - version increments on publish.
model FormDefinition {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  description String?
  formType    FormType @map("form_type")
  version     Int      @default(1)
  isActive    Boolean  @default(true) @map("is_active")
  isPublished Boolean  @default(false) @map("is_published")

  // JSON Schema
  schema        Json // JSON Schema definition
  uiSchema      Json? @map("ui_schema") // UI hints (ordering, widgets, conditionals)
  defaultValues Json? @map("default_values")

  // Behavior
  allowAnonymous   Boolean  @default(false) @map("allow_anonymous")
  requiresApproval Boolean  @default(false) @map("requires_approval")
  notifyOnSubmit   String[] @default([]) @map("notify_on_submit") // User IDs

  // Category linkage (optional)
  categoryId String? @map("category_id")

  // Metadata
  tags String[] @default([])

  // Audit
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  createdById String?   @map("created_by_id")
  publishedAt DateTime? @map("published_at")

  // Relations
  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submissions  FormSubmission[]

  @@unique([organizationId, name, version])
  @@index([organizationId])
  @@index([organizationId, formType])
  @@index([organizationId, isActive])
  @@map("form_definitions")
}

enum FormType {
  INTAKE // Anonymous/identified report intake
  DISCLOSURE // COI, gifts, outside employment
  ATTESTATION // Policy acknowledgment
  SURVEY // Compliance surveys
  WORKFLOW_TASK // Embedded workflow step form
  CUSTOM // General purpose

  @@map("form_type")
}

/// FormSubmission stores completed form submissions.
/// Links to FormDefinition by version for historical accuracy.
model FormSubmission {
  id                    String @id @default(uuid())
  organizationId        String @map("organization_id")
  formDefinitionId      String @map("form_definition_id")
  formDefinitionVersion Int    @map("form_definition_version")

  // Submission Data
  data             Json // Submitted form data
  status           FormSubmissionStatus @default(SUBMITTED)
  validationErrors Json?                @map("validation_errors")

  // Entity linkage (optional - links to what this form is for)
  entityType String? @map("entity_type") // 'CASE', 'RIU', 'CAMPAIGN_ASSIGNMENT'
  entityId   String? @map("entity_id")

  // Submitter
  submittedById  String?  @map("submitted_by_id") // Null for anonymous
  submittedAt    DateTime @default(now()) @map("submitted_at")
  submitterIp    String?  @map("submitter_ip")
  submitterAgent String?  @map("submitter_agent")

  // Anonymous support
  anonymousAccessCode String? @map("anonymous_access_code")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  formDefinition FormDefinition @relation(fields: [formDefinitionId], references: [id])

  @@index([organizationId])
  @@index([organizationId, formDefinitionId])
  @@index([organizationId, entityType, entityId])
  @@index([anonymousAccessCode])
  @@map("form_submissions")
}

enum FormSubmissionStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  PROCESSED

  @@map("form_submission_status")
}

// ===========================================
// Reporting Entities
// ===========================================

/// ReportTemplate defines reusable report configurations.
/// Templates specify data source, columns, filters, and aggregations.
model ReportTemplate {
  id             String  @id @default(uuid())
  organizationId String? @map("organization_id") // Null for system templates

  // Identity
  name        String
  description String?
  category    String? // 'compliance', 'operational', 'board', etc.
  isSystem    Boolean @default(false) @map("is_system") // Ethico-provided
  isPublic    Boolean @default(false) @map("is_public") // Visible to all users

  // Configuration
  dataSource   ReportDataSource @map("data_source") // CASES, RIUS, INVESTIGATIONS, etc.
  columns      Json // Array of column definitions
  filters      Json? // Default filters
  aggregations Json? // Sum, count, avg, group by
  sortBy       String?          @map("sort_by")
  sortOrder    String?          @map("sort_order")

  // Display
  chartType   String? @map("chart_type") // 'bar', 'pie', 'line', 'table'
  chartConfig Json?   @map("chart_config")

  // Access
  allowedRoles String[] @default([]) @map("allowed_roles")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")

  // Relations
  organization Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  executions   ReportExecution[]

  @@index([organizationId])
  @@index([dataSource])
  @@index([isSystem])
  @@map("report_templates")
}

enum ReportDataSource {
  CASES
  RIUS
  INVESTIGATIONS
  DISCLOSURES
  POLICIES
  AUDIT_LOGS
  USERS
  CAMPAIGNS

  @@map("report_data_source")
}

/// ReportExecution tracks report generation history.
/// Used for async report generation and download links.
model ReportExecution {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  templateId     String @map("template_id")

  // Execution details
  status     ReportExecutionStatus @default(PENDING)
  filters    Json? // Filters used for this execution
  parameters Json? // Additional parameters

  // Results
  rowCount  Int?      @map("row_count")
  fileKey   String?   @map("file_key") // Storage key for exported file
  fileUrl   String?   @map("file_url") // Signed URL (temporary)
  expiresAt DateTime? @map("expires_at")

  // Timing
  startedAt    DateTime? @map("started_at")
  completedAt  DateTime? @map("completed_at")
  errorMessage String?   @map("error_message")

  // Audit
  createdAt     DateTime @default(now()) @map("created_at")
  requestedById String   @map("requested_by_id")

  // Relations
  organization Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  template     ReportTemplate @relation(fields: [templateId], references: [id])

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([templateId])
  @@map("report_executions")
}

enum ReportExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED

  @@map("report_execution_status")
}

// ===========================================
// Demo Account Entity (Sales Rep Provisioning)
// ===========================================

/// DemoAccount tracks prospect account provisioning for sales demonstrations.
/// Sales reps provision time-limited prospect accounts for customer demos.
/// All prospect access is attributed to the originating sales rep.
model DemoAccount {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Prospect user details
  prospectUserId  String  @unique @map("prospect_user_id")
  prospectEmail   String  @map("prospect_email")
  prospectName    String? @map("prospect_name")
  prospectCompany String? @map("prospect_company")

  // Attribution to sales rep
  salesRepUserId String @map("sales_rep_user_id")

  // Expiry configuration
  expiresAt DateTime  @map("expires_at")
  expiredAt DateTime? @map("expired_at") // When actually expired (null if still active)

  // Status tracking
  status       DemoAccountStatus @default(ACTIVE)
  lastAccessAt DateTime?         @map("last_access_at")
  accessCount  Int               @default(0) @map("access_count")

  // Metadata
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  prospectUser User         @relation("ProspectUser", fields: [prospectUserId], references: [id])
  salesRepUser User         @relation("SalesRepUser", fields: [salesRepUserId], references: [id])

  @@index([organizationId])
  @@index([salesRepUserId])
  @@index([status, expiresAt])
  @@map("demo_accounts")
}

enum DemoAccountStatus {
  ACTIVE
  EXPIRED
  REVOKED

  @@map("demo_account_status")
}

// ===========================================
// Location Entity (Global Offices)
// ===========================================

/// Location represents a physical office or work site.
/// Real cities with fictional addresses for demo realism.
model Location {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Location Identity
  code String // e.g., "NYC-HQ", "LON-01", "TKY-01"
  name String // e.g., "New York Headquarters"

  // Address
  addressLine1  String  @map("address_line_1") // Fictional address
  addressLine2  String? @map("address_line_2")
  city          String // Real city name
  stateProvince String? @map("state_province")
  postalCode    String? @map("postal_code")
  country       String // ISO country code
  countryName   String  @map("country_name")

  // Geographic Classification
  region   String // "US", "EMEA", "APAC"
  timezone String // e.g., "America/New_York"

  // Metadata
  isHeadquarters Boolean @default(false) @map("is_headquarters")
  isActive       Boolean @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employees    Employee[]
  teams        Team[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, region])
  @@index([organizationId, country])
  @@map("locations")
}

// ===========================================
// Division Entity (Top Level - 4 Divisions)
// ===========================================

/// Division represents a major business segment.
/// Acme Co. has 4 divisions: Healthcare (50%), Tech, Retail, Energy
model Division {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  code        String // e.g., "HLTH", "TECH", "RETL", "ENRG"
  name        String // e.g., "Healthcare Division"
  description String?

  // Division Head (named persona)
  headEmployeeId String? @map("head_employee_id")

  // Distribution weight for employee generation
  employeeWeight Int @default(25) @map("employee_weight") // Percentage of total

  // Work mode defaults
  defaultWorkMode WorkMode @default(HYBRID) @map("default_work_mode")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization  Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessUnits BusinessUnit[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@map("divisions")
}

// ===========================================
// Business Unit Entity (Level 2)
// ===========================================

/// BusinessUnit is a sub-segment within a Division.
/// Example: Within Healthcare -> "Hospital Services", "Pharma", "Medical Devices"
model BusinessUnit {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  divisionId     String @map("division_id")

  code        String // e.g., "HOSP", "PHRM"
  name        String // e.g., "Hospital Services"
  description String?

  // BU Head
  headEmployeeId String? @map("head_employee_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  division     Division     @relation(fields: [divisionId], references: [id], onDelete: Cascade)
  departments  Department[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([divisionId])
  @@map("business_units")
}

// ===========================================
// Department Entity (Level 3)
// ===========================================

/// Department is a functional area within a Business Unit.
/// Example: Within Hospital Services -> "Nursing", "Administration", "Clinical"
model Department {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  businessUnitId String @map("business_unit_id")

  code        String // e.g., "NURS", "ADMN"
  name        String // e.g., "Nursing"
  description String?

  // Department Head (Director level)
  headEmployeeId String? @map("head_employee_id")

  // HRBP Assignment (for case routing)
  hrbpEmployeeId String? @map("hrbp_employee_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  businessUnit BusinessUnit @relation(fields: [businessUnitId], references: [id], onDelete: Cascade)
  teams        Team[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([businessUnitId])
  @@map("departments")
}

// ===========================================
// Team Entity (Level 4 - Lowest)
// ===========================================

/// Team is the smallest organizational unit.
/// Example: Within Nursing -> "ICU Team", "ER Team", "Pediatrics Team"
model Team {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  departmentId   String @map("department_id")

  code        String // e.g., "ICU", "ER"
  name        String // e.g., "ICU Team"
  description String?

  // Team Lead (Manager level)
  leadEmployeeId String? @map("lead_employee_id")

  // Primary location for this team
  locationId String? @map("location_id")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department   @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  location     Location?    @relation(fields: [locationId], references: [id])
  employees    Employee[]

  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([departmentId])
  @@map("teams")
}

// ===========================================
// Employee Entity (HRIS Sync)
// ===========================================

/// Employee represents HRIS-synced employee data.
/// 20,000 employees with full reporting chains.
/// Distinct from User - an Employee may or may not have a User account.
model Employee {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // HRIS Identity
  hrisEmployeeId String  @map("hris_employee_id") // External HRIS ID
  firstName      String  @map("first_name")
  lastName       String  @map("last_name")
  preferredName  String? @map("preferred_name") // For named personas
  email          String
  phone          String?

  // Position
  jobTitle String   @map("job_title")
  jobLevel JobLevel @default(IC) @map("job_level")

  // Organizational Placement
  divisionId     String? @map("division_id")
  businessUnitId String? @map("business_unit_id")
  departmentId   String? @map("department_id")
  teamId         String? @map("team_id")
  locationId     String? @map("location_id")

  // Legacy fields for backward compatibility
  department     String? // Denormalized department name
  departmentCode String? @map("department_code")
  location       String? // Denormalized location name
  locationCode   String? @map("location_code")
  costCenter     String? @map("cost_center")

  // Hierarchy
  managerId   String? @map("manager_id") // Self-reference to manager Employee
  managerName String? @map("manager_name") // Denormalized for display

  // Work Arrangement
  workMode WorkMode @default(HYBRID) @map("work_mode")

  // Language (for multi-language workforce)
  primaryLanguage String @default("en") @map("primary_language") // ISO 639-1 code

  // Compliance Role (for case routing)
  complianceRole ComplianceRole? @map("compliance_role")

  // Employment
  employmentStatus EmploymentStatus @default(ACTIVE) @map("employment_status")
  employmentType   EmploymentType   @default(FULL_TIME) @map("employment_type")
  hireDate         DateTime?        @map("hire_date")
  terminationDate  DateTime?        @map("termination_date")

  // Named Persona Flag (for executives with memorable names)
  isNamedPersona Boolean @default(false) @map("is_named_persona")
  personaRole    String? @map("persona_role") // e.g., "CCO", "Division VP Healthcare"

  // Sync Metadata
  sourceSystem   String   @default("MANUAL") @map("source_system")
  syncedAt       DateTime @default(now()) @map("synced_at")
  lastSyncStatus String?  @map("last_sync_status")
  rawHrisData    Json?    @map("raw_hris_data")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization       Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  manager            Employee?    @relation("EmployeeManager", fields: [managerId], references: [id])
  reports            Employee[]   @relation("EmployeeManager")
  teamAssignment     Team?        @relation(fields: [teamId], references: [id])
  locationAssignment Location?    @relation(fields: [locationId], references: [id])
  personRecords      Person[] // Person records linked to this Employee

  // Campaign assignment relations
  campaignAssignments CampaignAssignment[]

  @@unique([organizationId, hrisEmployeeId])
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, divisionId])
  @@index([organizationId, departmentId])
  @@index([organizationId, teamId])
  @@index([organizationId, locationId])
  @@index([organizationId, employmentStatus])
  @@index([organizationId, managerId])
  @@index([organizationId, jobLevel])
  @@index([organizationId, complianceRole])
  @@map("employees")
}

// ===========================================
// Person Entity (HubSpot Contact Equivalent)
// ===========================================

/// PersonType classifies the type of person record.
/// EMPLOYEE links to HRIS data, EXTERNAL_CONTACT for non-employees,
/// ANONYMOUS_PLACEHOLDER is a singleton per org for anonymous pattern detection.
enum PersonType {
  EMPLOYEE // Linked to HRIS Employee record
  EXTERNAL_CONTACT // Vendor, contractor, customer, etc.
  ANONYMOUS_PLACEHOLDER // Special record for anonymous reports

  @@map("person_type")
}

/// PersonSource tracks how the person record was created.
enum PersonSource {
  HRIS_SYNC // Created/updated from HRIS integration
  MANUAL // Manually created by user
  INTAKE_CREATED // Auto-created during RIU intake

  @@map("person_source")
}

/// AnonymityTier controls identity visibility on person records.
/// Used for reporters who want different levels of identity protection.
enum AnonymityTier {
  ANONYMOUS // No identifying info shared
  CONFIDENTIAL // Identity known to limited roles
  OPEN // Identity visible to case team

  @@map("anonymity_tier")
}

/// PersonStatus tracks the lifecycle of a person record.
enum PersonStatus {
  ACTIVE
  INACTIVE
  MERGED // Merged into another person record

  @@map("person_status")
}

/// Person represents any individual associated with compliance matters.
/// This is the foundation for people-based pattern detection.
/// Employees, external contacts, and anonymous reporters all become Person records.
/// Person is the "Contact" parallel to HubSpot's architecture.
model Person {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Classification
  type   PersonType
  source PersonSource

  // Identity (optional for anonymous)
  firstName String? @map("first_name")
  lastName  String? @map("last_name")
  email     String?
  phone     String?

  // Link to Employee (when type = EMPLOYEE)
  employeeId String? @map("employee_id")

  // Denormalized Employee fields (copied when Person created from Employee)
  // These fields are denormalized for filtering and display without joining to Employee table
  businessUnitId   String? @map("business_unit_id")
  businessUnitName String? @map("business_unit_name")
  jobTitle         String? @map("job_title")
  employmentStatus String? @map("employment_status")
  locationId       String? @map("location_id")
  locationName     String? @map("location_name")

  // Manager hierarchy (self-referential for org chart navigation)
  managerId   String? @map("manager_id") // FK to another Person
  managerName String? @map("manager_name") // Denormalized for display

  // External contact details (when type = EXTERNAL_CONTACT)
  company      String? // Company/organization name
  title        String? // Job title
  relationship String? // Vendor, contractor, customer, etc.

  // Anonymity
  anonymityTier AnonymityTier @default(OPEN) @map("anonymity_tier")

  // Status and merge tracking
  status              PersonStatus @default(ACTIVE)
  mergedIntoPrimaryId String?      @map("merged_into_primary_id")
  mergedAt            DateTime?    @map("merged_at")
  mergedById          String?      @map("merged_by_id")

  // Notes
  notes String? // Additional context about this person

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")
  updatedById String?  @map("updated_by_id")

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  employee          Employee?    @relation(fields: [employeeId], references: [id])
  mergedIntoPrimary Person?      @relation("PersonMerge", fields: [mergedIntoPrimaryId], references: [id])
  mergedPersons     Person[]     @relation("PersonMerge")

  // Manager self-reference for org chart navigation
  manager       Person?  @relation("PersonManager", fields: [managerId], references: [id])
  directReports Person[] @relation("PersonManager")

  // Association relations
  caseAssociations       PersonCaseAssociation[]
  riuAssociations        PersonRiuAssociation[]
  personRelationshipsAsA PersonPersonAssociation[] @relation("PersonARelation")
  personRelationshipsAsB PersonPersonAssociation[] @relation("PersonBRelation")

  // Unique constraint: email must be unique within an organization when not null
  // Note: PostgreSQL allows multiple NULLs for unique constraints
  @@unique([organizationId, email])
  // Indexes for query patterns
  @@index([organizationId])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@index([organizationId, employeeId])
  @@index([organizationId, managerId])
  @@index([organizationId, businessUnitId])
  @@map("persons")
}

// ===========================================
// Enums for Organization Structure
// ===========================================

enum JobLevel {
  IC // Individual Contributor
  MANAGER // First-line manager
  DIRECTOR // Department head
  VP // Division/BU head
  SVP // Senior VP
  C_SUITE // C-level executive

  @@map("job_level")
}

enum WorkMode {
  ONSITE // Full-time office
  REMOTE // Full-time remote
  HYBRID // Mix of onsite/remote

  @@map("work_mode")
}

enum ComplianceRole {
  CCO // Chief Compliance Officer
  INVESTIGATOR // Compliance Investigator
  HRBP // HR Business Partner (case routing)
  LEGAL_COUNSEL // Legal team member
  ETHICS_COMMITTEE // Ethics committee member

  @@map("compliance_role")
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED

  @@map("employment_status")
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACTOR
  TEMPORARY
  INTERN

  @@map("employment_type")
}

// ===========================================
// Demo Reset System Entities
// ===========================================

/// Tracks a demo user's session and their isolated changes.
/// Each user has exactly one session per organization.
/// Base data has demoUserSessionId: null and isBaseData: true.
/// User changes have demoUserSessionId: {id} and isBaseData: false.
model DemoUserSession {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  userId         String @map("user_id")

  /// When this session was created
  createdAt      DateTime @default(now()) @map("created_at")
  /// Last activity in this session
  lastActivityAt DateTime @default(now()) @map("last_activity_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  /// User's isolated changes (copy-on-write records)
  cases          Case[]                 @relation("DemoSessionCases")
  investigations Investigation[]        @relation("DemoSessionInvestigations")
  rius           RiskIntelligenceUnit[] @relation("DemoSessionRius")

  /// Archived changes for undo
  archivedChanges DemoArchivedChange[]

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([lastActivityAt])
  @@map("demo_user_sessions")
}

/// Archives user changes during reset for 24-hour undo window.
/// After reset, changes are stored here temporarily before permanent deletion.
model DemoArchivedChange {
  id                String @id @default(uuid())
  demoUserSessionId String @map("demo_user_session_id")

  /// The type of entity archived
  entityType String @map("entity_type") // 'Case', 'Investigation', 'RIU', etc.
  /// The original entity ID
  entityId   String @map("entity_id")
  /// Complete JSON snapshot of the entity
  entityData Json   @map("entity_data")

  /// When the change was archived (for 24-hour expiry)
  archivedAt DateTime @default(now()) @map("archived_at")
  /// When this archive expires and can be cleaned up
  expiresAt  DateTime @map("expires_at")

  /// Whether this has been restored
  restoredAt DateTime? @map("restored_at")

  demoUserSession DemoUserSession @relation(fields: [demoUserSessionId], references: [id], onDelete: Cascade)

  @@index([demoUserSessionId])
  @@index([archivedAt])
  @@index([expiresAt])
  @@index([entityType, entityId])
  @@map("demo_archived_changes")
}

// ===========================================
// Campaign Entities (Outbound Compliance)
// ===========================================

/// CampaignType defines what kind of outbound request this campaign sends.
enum CampaignType {
  DISCLOSURE // Request for COI, gifts, outside employment disclosures
  ATTESTATION // Policy acknowledgment or certification
  SURVEY // Compliance survey or assessment

  @@map("campaign_type")
}

/// CampaignStatus tracks the lifecycle of a campaign.
enum CampaignStatus {
  DRAFT // Being designed, not yet launched
  SCHEDULED // Scheduled for future launch
  ACTIVE // Currently running, assignments being sent
  PAUSED // Temporarily paused
  COMPLETED // All assignments completed or expired
  CANCELLED // Cancelled before completion

  @@map("campaign_status")
}

/// AudienceMode determines how campaign targets are selected.
enum AudienceMode {
  SEGMENT // Uses segment criteria for dynamic targeting
  MANUAL // Manually selected employees
  ALL // All active employees

  @@map("audience_mode")
}

/// AssignmentStatus tracks individual employee assignment progress.
enum AssignmentStatus {
  PENDING // Assignment created, not yet notified
  NOTIFIED // Initial notification sent
  IN_PROGRESS // Employee has started but not completed
  COMPLETED // Successfully completed
  OVERDUE // Past due date, not completed
  SKIPPED // Skipped (exempted by admin)
  EXPIRED // Campaign ended before completion

  @@map("assignment_status")
}

/// Segment defines a reusable audience filter for campaigns.
/// Segments use JSON criteria that are converted to Prisma where clauses.
/// Segments can be shared across multiple campaigns.
model Segment {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  description String?

  // Criteria (JSON format for query builder)
  // Structure: { logic: 'AND'|'OR', conditions: [...] }
  // Condition: { field: string, operator: string, value: any }
  criteria Json

  // Cache for audience size (updated on save)
  estimatedAudienceSize Int?      @map("estimated_audience_size")
  audienceSizeUpdatedAt DateTime? @map("audience_size_updated_at")

  // Status
  isActive Boolean @default(true) @map("is_active")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")
  updatedById String?  @map("updated_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaigns    Campaign[]

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@map("segments")
}

/// Campaign represents an outbound compliance request (disclosures, attestations, surveys).
/// HubSpot Sequence equivalent - sends requests to a targeted audience.
/// Campaign launch creates CampaignAssignment for each target employee.
model Campaign {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  description String?
  type        CampaignType

  // Status and lifecycle
  status     CampaignStatus @default(DRAFT)
  statusNote String?        @map("status_note")

  // Audience targeting
  audienceMode AudienceMode @map("audience_mode")
  segmentId    String?      @map("segment_id") // When audienceMode = SEGMENT
  manualIds    String[]     @default([]) @map("manual_ids") // When audienceMode = MANUAL

  // Scheduling
  launchAt     DateTime? @map("launch_at") // When to start sending
  launchedAt   DateTime? @map("launched_at") // When actually launched
  launchedById String?   @map("launched_by_id")
  dueDate      DateTime  @map("due_date") // Deadline for completion
  expiresAt    DateTime? @map("expires_at") // When campaign auto-closes

  // Form linkage
  formDefinitionId String? @map("form_definition_id")

  // Reminders
  reminderDays        Int[]     @default([7, 3, 1]) @map("reminder_days") // Days before due to remind
  lastReminderSentAt  DateTime? @map("last_reminder_sent_at")
  escalationAfterDays Int?      @map("escalation_after_days") // Days overdue before escalation
  escalateToUserId    String?   @map("escalate_to_user_id")

  // Auto-case rules (when response should trigger case creation)
  autoCreateCase        Boolean @default(false) @map("auto_create_case")
  caseCreationThreshold Json?   @map("case_creation_threshold") // { field: 'value', operator: '>', threshold: X }

  // Statistics (denormalized for performance)
  totalAssignments     Int @default(0) @map("total_assignments")
  completedAssignments Int @default(0) @map("completed_assignments")
  overdueAssignments   Int @default(0) @map("overdue_assignments")
  completionPercentage Int @default(0) @map("completion_percentage") // 0-100

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String?  @map("created_by_id")
  updatedById String?  @map("updated_by_id")

  // Relations
  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  segment      Segment?               @relation(fields: [segmentId], references: [id])
  assignments  CampaignAssignment[]
  rius         RiskIntelligenceUnit[] @relation("CampaignRius")

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, type])
  @@index([organizationId, dueDate])
  @@map("campaigns")
}

/// CampaignAssignment tracks an individual employee's assignment within a campaign.
/// Created when campaign is launched, one per target employee.
/// Snapshots employee data at creation for historical accuracy.
model CampaignAssignment {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  campaignId     String @map("campaign_id")
  employeeId     String @map("employee_id")

  // Status tracking
  status AssignmentStatus @default(PENDING)

  // Timeline
  assignedAt  DateTime  @default(now()) @map("assigned_at")
  notifiedAt  DateTime? @map("notified_at")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  dueDate     DateTime  @map("due_date") // Copied from campaign at assignment time

  // Notifications
  reminderCount      Int       @default(0) @map("reminder_count")
  lastReminderSentAt DateTime? @map("last_reminder_sent_at")

  // Response linkage
  riuId            String? @map("riu_id") // Links to RIU created by response
  formSubmissionId String? @map("form_submission_id")

  // Employee snapshot (captured at assignment time for audit trail)
  // This ensures historical accuracy even if employee data changes
  employeeSnapshot Json @map("employee_snapshot")
  // Snapshot contains: { firstName, lastName, email, jobTitle, department, businessUnit, location, manager }

  // Admin notes
  notes      String?
  skippedBy  String? @map("skipped_by")
  skipReason String? @map("skip_reason")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  employee     Employee     @relation(fields: [employeeId], references: [id])

  // Unique constraint: one assignment per employee per campaign
  @@unique([campaignId, employeeId])
  @@index([organizationId])
  @@index([organizationId, campaignId])
  @@index([organizationId, employeeId])
  @@index([organizationId, status])
  @@index([organizationId, dueDate])
  @@map("campaign_assignments")
}

// ===========================================
// Association Entity Enums
// ===========================================

/// Labels for Person-to-Case associations per ASSOC-02.
/// Evidentiary labels (REPORTER, SUBJECT, WITNESS) use status field.
/// Role labels (ASSIGNED_INVESTIGATOR, etc.) use validity periods.
enum PersonCaseLabel {
  // Evidentiary associations (use EvidentiaryStatus)
  REPORTER
  SUBJECT
  WITNESS

  // Role associations (use validity periods)
  ASSIGNED_INVESTIGATOR
  APPROVER
  STAKEHOLDER
  MANAGER_OF_SUBJECT
  REVIEWER
  LEGAL_COUNSEL

  @@map("person_case_label")
}

/// Labels for Person-to-RIU associations per ASSOC-01.
/// Tracks who is mentioned in an RIU intake record.
enum PersonRiuLabel {
  REPORTER
  SUBJECT_MENTIONED
  WITNESS_MENTIONED

  @@map("person_riu_label")
}

/// Labels for Case-to-Case associations per CONTEXT.md decision.
/// Supports hierarchy (parent/child), splits, escalations, merges.
enum CaseCaseLabel {
  PARENT
  CHILD
  SPLIT_FROM
  SPLIT_TO
  RELATED
  ESCALATED_TO
  SUPERSEDES
  FOLLOW_UP_TO
  MERGED_INTO

  @@map("case_case_label")
}

/// Labels for Person-to-Person relationships.
/// Sources: HRIS (manager_of), Disclosure (spouse, business_partner), Investigation.
/// Used for COI detection.
enum PersonPersonLabel {
  MANAGER_OF
  REPORTS_TO
  SPOUSE
  DOMESTIC_PARTNER
  FAMILY_MEMBER
  FORMER_COLLEAGUE
  BUSINESS_PARTNER
  CLOSE_PERSONAL_FRIEND

  @@map("person_person_label")
}

/// Status for evidentiary associations (subject, witness, reporter).
/// Per CONTEXT.md: Evidentiary associations use STATUS, not validity periods.
/// "Person X was the subject of Case Y" is permanently true - only outcome changes.
enum EvidentiaryStatus {
  ACTIVE // Investigation ongoing
  CLEARED // Not substantiated
  SUBSTANTIATED // Investigation confirmed
  WITHDRAWN // Reporter withdrew

  @@map("evidentiary_status")
}

/// Source of Person-Person relationship knowledge.
enum PersonPersonSource {
  HRIS // From HRIS manager hierarchy sync
  DISCLOSURE // From disclosure form (spouse, business_partner)
  INVESTIGATION // Discovered during investigation
  MANUAL // Manually entered by user

  @@map("person_person_source")
}

// ===========================================
// Person-Case Association Entity
// ===========================================

/// PersonCaseAssociation links Person to Case with role labels per ASSOC-02.
/// First-class entity following HubSpot V4 Associations pattern.
///
/// Evidentiary associations (REPORTER, SUBJECT, WITNESS):
///   - Use evidentiaryStatus field (ACTIVE, CLEARED, SUBSTANTIATED, WITHDRAWN)
///   - Never "end" - they are permanent records with changing outcomes
///   - Status changes tracked with timestamp, user, and reason
///
/// Role associations (ASSIGNED_INVESTIGATOR, LEGAL_COUNSEL, etc.):
///   - Use validity periods (startedAt, endedAt)
///   - Can end when person leaves the role
model PersonCaseAssociation {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  personId       String @map("person_id")
  caseId         String @map("case_id")

  // Role label
  label PersonCaseLabel

  // === EVIDENTIARY STATUS (for REPORTER, SUBJECT, WITNESS) ===
  // Per CONTEXT.md: evidentiary associations use status, not validity periods
  evidentiaryStatus     EvidentiaryStatus? @map("evidentiary_status")
  evidentiaryStatusAt   DateTime?          @map("evidentiary_status_at")
  evidentiaryStatusById String?            @map("evidentiary_status_by_id")
  evidentiaryReason     String?            @map("evidentiary_reason")

  // === VALIDITY PERIOD (for role associations like ASSIGNED_INVESTIGATOR) ===
  // Role associations can end when person leaves the role
  startedAt   DateTime  @default(now()) @map("started_at")
  endedAt     DateTime? @map("ended_at")
  endedReason String?   @map("ended_reason")

  // Notes
  notes String?

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person       Person       @relation(fields: [personId], references: [id], onDelete: Cascade)
  case         Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personId, caseId, label])
  @@index([organizationId])
  @@index([organizationId, personId])
  @@index([organizationId, caseId])
  @@index([organizationId, label])
  @@index([organizationId, evidentiaryStatus])
  @@map("person_case_associations")
}

// ===========================================
// Person-RIU Association Entity
// ===========================================

/// PersonRiuAssociation links Person to RIU per ASSOC-01.
/// Tracks who is mentioned in an RIU (reporter, subject, witness).
/// RIUs are immutable, so these associations are created at intake.
model PersonRiuAssociation {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  personId       String @map("person_id")
  riuId          String @map("riu_id")

  // Role label
  label PersonRiuLabel

  // Notes (how they were identified in the RIU)
  notes          String?
  mentionContext String? @map("mention_context") // Quote from RIU where person was mentioned

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  person       Person               @relation(fields: [personId], references: [id], onDelete: Cascade)
  riu          RiskIntelligenceUnit @relation(fields: [riuId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personId, riuId, label])
  @@index([organizationId])
  @@index([organizationId, personId])
  @@index([organizationId, riuId])
  @@map("person_riu_associations")
}

// ===========================================
// Case-Case Association Entity
// ===========================================

/// CaseCaseAssociation links Case to Case per CONTEXT.md decision.
/// Supports hierarchy (parent/child), splits, escalations, merges.
/// Direction matters: sourceCase -> targetCase with specific label.
model CaseCaseAssociation {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  sourceCaseId   String @map("source_case_id") // "From" case
  targetCaseId   String @map("target_case_id") // "To" case

  // Directional label (source -> target)
  label CaseCaseLabel

  // Notes
  notes String?

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sourceCase   Case         @relation("CaseAssociationSource", fields: [sourceCaseId], references: [id], onDelete: Cascade)
  targetCase   Case         @relation("CaseAssociationTarget", fields: [targetCaseId], references: [id], onDelete: Cascade)

  @@unique([organizationId, sourceCaseId, targetCaseId, label])
  @@index([organizationId])
  @@index([organizationId, sourceCaseId])
  @@index([organizationId, targetCaseId])
  @@map("case_case_associations")
}

// ===========================================
// Person-Person Association Entity
// ===========================================

/// PersonPersonAssociation tracks relationships between people.
/// Sources: HRIS (manager_of), Disclosure (spouse, business_partner), Investigation.
/// Used for COI detection and relationship mapping.
///
/// For symmetric relationships (spouse, friend), personAId < personBId alphabetically.
/// For asymmetric relationships (manager_of), isDirectional=true with aToB/bToA descriptors.
model PersonPersonAssociation {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  personAId      String @map("person_a_id")
  personBId      String @map("person_b_id")

  // Relationship label
  label PersonPersonLabel

  // Source of relationship knowledge
  source PersonPersonSource

  // Directional flag (for asymmetric relationships like manager_of)
  isDirectional Boolean @default(false) @map("is_directional")
  aToB          String? @map("a_to_b") // A's relationship to B (e.g., "manager_of")
  bToA          String? @map("b_to_a") // B's relationship to A (e.g., "reports_to")

  // Validity
  effectiveFrom  DateTime  @default(now()) @map("effective_from")
  effectiveUntil DateTime? @map("effective_until")

  // Notes
  notes String?

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  personA      Person       @relation("PersonARelation", fields: [personAId], references: [id], onDelete: Cascade)
  personB      Person       @relation("PersonBRelation", fields: [personBId], references: [id], onDelete: Cascade)

  @@unique([organizationId, personAId, personBId, label])
  @@index([organizationId])
  @@index([organizationId, personAId])
  @@index([organizationId, personBId])
  @@index([organizationId, label])
  @@map("person_person_associations")
}

// ===========================================
// AI Conversation Tracking
// ===========================================

/// Conversation status tracks the lifecycle
enum AiConversationStatus {
  ACTIVE
  PAUSED
  ARCHIVED

  @@map("ai_conversation_status")
}

/// AiConversation tracks a conversation session with the AI.
/// Conversations are scoped to organization, user, and optionally an entity.
model AiConversation {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  userId         String @map("user_id")

  // Entity context (optional - can have org-wide conversations)
  entityType String? @map("entity_type") // 'case', 'investigation', 'campaign'
  entityId   String? @map("entity_id")

  // Conversation metadata
  title  String? // AI-generated or user-provided
  status AiConversationStatus @default(ACTIVE)

  // Agent type used for this conversation
  agentType String? @map("agent_type") // 'investigation', 'case', 'compliance-manager'

  // Timestamps
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  pausedAt      DateTime? @map("paused_at")
  archivedAt    DateTime? @map("archived_at")
  lastMessageAt DateTime? @map("last_message_at")

  // Token tracking for this conversation
  totalInputTokens  Int @default(0) @map("total_input_tokens")
  totalOutputTokens Int @default(0) @map("total_output_tokens")

  // Relations
  messages AiMessage[]

  @@index([organizationId, userId, status])
  @@index([organizationId, entityType, entityId])
  @@index([userId, status])
  @@index([status, lastMessageAt])
  @@map("ai_conversations")
}

/// AiMessage represents a single message in a conversation.
/// Stores both user and assistant messages with optional tool use data.
model AiMessage {
  id             String @id @default(uuid())
  conversationId String @map("conversation_id")

  // Message content
  role    String // 'user', 'assistant'
  content String @db.Text

  // Tool use tracking (for assistant messages)
  toolCalls   Json? @map("tool_calls") // Array of {id, name, input}
  toolResults Json? @map("tool_results") // Array of {toolUseId, result}

  // Token counts for this message
  inputTokens  Int? @map("input_tokens")
  outputTokens Int? @map("output_tokens")

  // Metadata
  model     String? // Model used for this response
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  conversation AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([conversationId, createdAt])
  @@map("ai_messages")
}

// ===========================================
// AI Context Files
// ===========================================

/// AiContextFile stores CLAUDE.md-like context files for organizations and users.
/// Platform context is stored in code; org/user context is stored in database.
/// Context files enable organization-specific brand voice, terminology, and custom rules.
model AiContextFile {
  id             String  @id @default(uuid())
  organizationId String? @map("organization_id") // null = platform level (but stored in code)
  userId         String? @map("user_id") // null = org-level, set = user-level

  // Context file content
  name        String // Display name
  content     String  @db.Text // Markdown content (like CLAUDE.md)
  description String?

  // Scope
  scope  String  @default("org") // 'org', 'team', 'user'
  teamId String? @map("team_id") // For team-scoped context

  // Metadata
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, userId, name])
  @@index([organizationId, scope, isActive])
  @@index([userId, isActive])
  @@map("ai_context_files")
}

// ===========================================
// AI Usage Tracking
// ===========================================

/// AiUsage tracks token consumption per organization for billing and analytics.
/// Each record represents a single AI API call with its token counts.
model AiUsage {
  id             String  @id @default(uuid())
  organizationId String  @map("organization_id")
  userId         String? @map("user_id") // User who triggered the AI call

  // Token counts
  inputTokens      Int @map("input_tokens")
  outputTokens     Int @map("output_tokens")
  cacheReadTokens  Int @default(0) @map("cache_read_tokens")
  cacheWriteTokens Int @default(0) @map("cache_write_tokens")

  // Request metadata
  model       String // Model used (e.g., 'claude-sonnet-4-5')
  provider    String  @default("claude") // Provider name
  featureType String? @map("feature_type") // e.g., 'summary', 'note-cleanup', 'chat'
  entityType  String? @map("entity_type") // Entity context (case, investigation)
  entityId    String? @map("entity_id")

  // Timing
  durationMs Int?     @map("duration_ms") // Request duration in milliseconds
  timestamp  DateTime @default(now())

  @@index([organizationId, timestamp])
  @@index([organizationId, featureType])
  @@index([userId, timestamp])
  @@map("ai_usage")
}

/// PromptTemplate stores versioned prompt templates.
/// Allows A/B testing, rollback, and organization-specific overrides.
model PromptTemplate {
  id             String   @id @default(uuid())
  organizationId String?  @map("organization_id") // null = platform default
  name           String // e.g., 'system/investigation-agent', 'skills/summarize'
  version        Int      @default(1)
  content        String   @db.Text // Handlebars template content
  description    String?
  isActive       Boolean  @default(true) @map("is_active")
  variables      Json? // Schema for expected variables
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@unique([organizationId, name, version])
  @@index([organizationId, name, isActive])
  @@index([name, isActive])
  @@map("prompt_templates")
}

/// AiRateLimit stores per-organization rate limit configuration.
/// Allows customizing limits per customer tier.
model AiRateLimit {
  id             String @id @default(uuid())
  organizationId String @unique @map("organization_id")

  requestsPerMinute Int @default(60) @map("requests_per_minute")
  tokensPerMinute   Int @default(100000) @map("tokens_per_minute")
  requestsPerDay    Int @default(10000) @map("requests_per_day")
  tokensPerDay      Int @default(5000000) @map("tokens_per_day")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ai_rate_limits")
}

// ===========================================
// AI Action System
// ===========================================

/// AiActionStatus tracks the lifecycle of AI-initiated actions.
enum AiActionStatus {
  PENDING
  EXECUTING
  COMPLETED
  FAILED
  UNDONE

  @@map("ai_action_status")
}

/// AiAction records AI-initiated mutations for audit and undo capability.
/// Actions have configurable undo windows based on their severity.
model AiAction {
  id             String  @id @default(uuid())
  organizationId String  @map("organization_id")
  conversationId String? @map("conversation_id") // Links to AI conversation
  userId         String  @map("user_id") // User who triggered the action

  // Action details
  actionType String @map("action_type") // e.g., 'add-note', 'change-status'
  entityType String @map("entity_type") // Target entity type
  entityId   String @map("entity_id") // Target entity ID

  // Input and result
  input         Json // Action input parameters
  result        Json? // Action result (for undo)
  previousState Json? @map("previous_state") // State before action (for undo)

  // Status tracking
  status AiActionStatus @default(PENDING)
  error  String? // Error message if failed

  // Undo configuration
  undoWindowSeconds Int?      @map("undo_window_seconds") // 0 = non-undoable
  undoExpiresAt     DateTime? @map("undo_expires_at")

  // Timestamps
  createdAt      DateTime  @default(now()) @map("created_at")
  executedAt     DateTime? @map("executed_at")
  completedAt    DateTime? @map("completed_at")
  undoneAt       DateTime? @map("undone_at")
  undoneByUserId String?   @map("undone_by_user_id")

  @@index([organizationId, entityType, entityId])
  @@index([organizationId, userId])
  @@index([conversationId])
  @@index([status, undoExpiresAt])
  @@map("ai_actions")
}

// ===========================================
// Custom Properties System
// ===========================================

/// CustomPropertyEntityType defines which entities can have custom properties.
enum CustomPropertyEntityType {
  CASE
  INVESTIGATION
  PERSON
  RIU

  @@map("custom_property_entity_type")
}

/// PropertyDataType defines the data types supported for custom properties.
enum PropertyDataType {
  TEXT
  NUMBER
  DATE
  DATETIME
  SELECT
  MULTI_SELECT
  BOOLEAN
  URL
  EMAIL
  PHONE

  @@map("property_data_type")
}

/// CustomPropertyDefinition defines tenant-configurable fields for Cases, Investigations, and Persons.
/// Properties allow organizations to capture industry-specific or compliance-specific data.
model CustomPropertyDefinition {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Target entity
  entityType CustomPropertyEntityType @map("entity_type")

  // Property definition
  name        String
  key         String // Unique key within entity type, used in customFields JSON
  description String?

  // Type and validation
  dataType     PropertyDataType @map("data_type")
  isRequired   Boolean          @default(false) @map("is_required")
  defaultValue Json?            @map("default_value")

  // Options for SELECT/MULTI_SELECT
  options Json? // Array of { value: string, label: string, color?: string }

  // Validation rules
  validationRules Json? @map("validation_rules")
  // For TEXT: { minLength?, maxLength?, pattern? }
  // For NUMBER: { min?, max?, decimals? }
  // For DATE: { minDate?, maxDate?, allowFuture?, allowPast? }

  // Display configuration
  displayOrder Int     @default(0) @map("display_order")
  groupName    String? @map("group_name") // For grouping related properties
  isVisible    Boolean @default(true) @map("is_visible")
  helpText     String? @map("help_text")

  // UI hints
  placeholder String?
  width       String? // 'full', 'half', 'third'

  // Status
  isActive Boolean @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, entityType, key])
  @@index([organizationId, entityType])
  @@index([organizationId, entityType, isActive])
  @@map("custom_property_definitions")
}

// ===========================================
// Remediation Management
// ===========================================

/// RemediationStatus tracks the lifecycle of a remediation plan.
enum RemediationStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED

  @@map("remediation_status")
}

/// StepStatus tracks individual remediation step progress.
enum StepStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
  BLOCKED

  @@map("step_status")
}

/// RemediationPlan tracks post-investigation remediation activities.
/// Plans continue independently after case closure for complete audit trail.
/// Each plan is linked to a case and optionally to a specific finding.
model RemediationPlan {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  caseId         String @map("case_id")

  // Link to specific finding (not just case)
  findingId          String? @map("finding_id")
  findingDescription String? @map("finding_description")

  // Plan details
  title       String
  description String?

  // Template (optional)
  templateId      String? @map("template_id")
  templateVersion Int?    @map("template_version")

  // Status
  status        RemediationStatus @default(DRAFT)
  dueDate       DateTime?         @map("due_date")
  completedAt   DateTime?         @map("completed_at")
  completedById String?           @map("completed_by_id")

  // Summary (denormalized for queries)
  totalSteps     Int @default(0) @map("total_steps")
  completedSteps Int @default(0) @map("completed_steps")
  overdueSteps   Int @default(0) @map("overdue_steps")

  // Owner
  ownerId String @map("owner_id")

  // Timestamps
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  case         Case              @relation(fields: [caseId], references: [id], onDelete: Cascade)
  steps        RemediationStep[]

  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, status])
  @@index([organizationId, ownerId])
  @@index([organizationId, dueDate])
  @@map("remediation_plans")
}

/// RemediationStep represents individual tasks within a remediation plan.
/// Steps can be assigned to internal users OR external contacts via email.
/// Dependencies form a DAG (directed acyclic graph) for ordering.
model RemediationStep {
  id             String @id @default(uuid())
  planId         String @map("plan_id")
  organizationId String @map("organization_id")

  // Step details
  order       Int
  title       String
  description String?
  dueDate     DateTime? @map("due_date")

  // Assignment (user OR external contact)
  assigneeUserId String? @map("assignee_user_id")
  assigneeEmail  String? @map("assignee_email") // For non-users
  assigneeName   String? @map("assignee_name")

  // Completion
  status             StepStatus @default(PENDING)
  requiresCoApproval Boolean    @default(false) @map("requires_co_approval")
  completedAt        DateTime?  @map("completed_at")
  completedById      String?    @map("completed_by_id")
  completionNotes    String?    @map("completion_notes") @db.Text
  completionEvidence Json?      @map("completion_evidence") // Attachment IDs, links

  // Approval (if requiresCoApproval)
  approvedById  String?   @map("approved_by_id")
  approvedAt    DateTime? @map("approved_at")
  approvalNotes String?   @map("approval_notes")

  // Dependencies (other step IDs that must complete first)
  dependsOnStepIds String[] @default([]) @map("depends_on_step_ids")

  // Notifications
  reminderSentAt DateTime? @map("reminder_sent_at")
  escalatedAt    DateTime? @map("escalated_at")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  plan RemediationPlan @relation(fields: [planId], references: [id], onDelete: Cascade)

  @@index([planId])
  @@index([organizationId])
  @@index([organizationId, assigneeUserId])
  @@index([organizationId, status, dueDate])
  @@map("remediation_steps")
}

/// RemediationTemplate provides reusable remediation plans.
/// Templates store step configurations that are applied when creating new plans.
model RemediationTemplate {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  name        String
  description String?
  categoryId  String? @map("category_id")

  // Steps template (JSON)
  steps Json // Array of { order, title, description, roleSlug, requiresCoApproval, dueDaysOffset }

  isActive Boolean @default(true) @map("is_active")
  isSystem Boolean @default(false) @map("is_system")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, categoryId])
  @@map("remediation_templates")
}

// ===========================================
// Saved Views System
// ===========================================

/// ViewEntityType defines which entity lists can have saved views.
enum ViewEntityType {
  CASES
  RIUS
  INVESTIGATIONS
  PERSONS
  CAMPAIGNS
  REMEDIATION_PLANS

  @@map("view_entity_type")
}

/// SavedView persists user-created filtered views for quick access.
/// Users can save filter combinations, column layouts, and sort preferences.
/// Views can be personal or shared with the organization.
model SavedView {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Ownership
  createdById      String  @map("created_by_id")
  isShared         Boolean @default(false) @map("is_shared")
  sharedWithTeamId String? @map("shared_with_team_id")

  // View definition
  name        String
  description String?
  entityType  ViewEntityType @map("entity_type")

  // Filter configuration (JSON)
  filters   Json // Filter criteria
  sortBy    String? @map("sort_by")
  sortOrder String? @map("sort_order") // 'asc' or 'desc'
  columns   Json? // Column visibility and order

  // User preferences
  isDefault    Boolean @default(false) @map("is_default")
  isPinned     Boolean @default(false) @map("is_pinned")
  displayOrder Int     @default(0) @map("display_order")
  color        String? // Optional color for visual distinction

  // Usage tracking
  lastUsedAt DateTime? @map("last_used_at")
  useCount   Int       @default(0) @map("use_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, createdById, entityType, name])
  @@index([organizationId, createdById])
  @@index([organizationId, entityType])
  @@index([organizationId, isShared])
  @@map("saved_views")
}

// ===========================================
// Investigation Template System
// ===========================================

/// TemplateTier defines the visibility/scope of investigation templates.
/// OFFICIAL templates are admin-created and org-wide.
/// TEAM templates are shared with specific teams.
/// PERSONAL templates are creator-only, typically saved from cases.
enum TemplateTier {
  OFFICIAL // Admin-created, org-wide
  TEAM // Shared with specific team
  PERSONAL // Creator-only, save-as from cases

  @@map("template_tier")
}

/// InvestigationTemplate defines reusable investigation checklists.
/// Templates standardize investigation processes while allowing customization.
/// Supports versioning (version-on-publish pattern) and export/import for sharing.
model InvestigationTemplate {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Identity
  name        String
  description String?
  categoryId  String? @map("category_id") // Optional category binding

  // Template tier
  tier             TemplateTier @default(PERSONAL)
  createdById      String       @map("created_by_id")
  sharedWithTeamId String?      @map("shared_with_team_id")

  // Versioning (same pattern as WorkflowTemplate)
  version    Int     @default(1)
  isActive   Boolean @default(true) @map("is_active")
  isArchived Boolean @default(false) @map("is_archived")
  isDefault  Boolean @default(false) @map("is_default")

  // Schema (JSON)
  sections           Json // Array of ChecklistSection
  suggestedDurations Json? @map("suggested_durations")
  conditionalRules   Json? @map("conditional_rules")

  // Import/Export
  isSystemTemplate Boolean @default(false) @map("is_system_template")
  sourceTemplateId String? @map("source_template_id")

  // Analytics tracking
  usageCount Int @default(0) @map("usage_count")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Category mappings for auto-assignment
  categoryMappings   CategoryTemplateMapping[]
  checklistInstances InvestigationChecklistProgress[]

  @@unique([organizationId, name, version])
  @@index([organizationId, tier])
  @@index([organizationId, categoryId])
  @@index([organizationId, isActive, isArchived])
  @@map("investigation_templates")
}

// ===========================================
// Category-Template Mapping
// ===========================================

/// TemplateRequirement defines how strictly a template should be applied
/// when creating an investigation for a mapped category.
enum TemplateRequirement {
  REQUIRED // Investigation cannot proceed without template
  RECOMMENDED // Auto-applies but can be removed
  OPTIONAL // Investigator chooses

  @@map("template_requirement")
}

/// CategoryTemplateMapping links categories to investigation templates.
/// Enables auto-assignment of templates based on case/investigation category.
/// Multiple templates can map to a category with different requirement levels.
model CategoryTemplateMapping {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")

  // Category link
  categoryId String @map("category_id")

  // Template link
  templateId String @map("template_id")

  // Requirement level
  requirement TemplateRequirement @default(RECOMMENDED)

  // Priority (for multiple mappings per category, lower = higher priority)
  priority Int @default(0)

  isActive Boolean @default(true) @map("is_active")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  category     Category              @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  template     InvestigationTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([organizationId, categoryId, templateId])
  @@index([organizationId, categoryId])
  @@map("category_template_mappings")
}

// ===========================================
// Investigation Checklist Progress Entity
// ===========================================

/// InvestigationChecklistProgress tracks per-investigation completion of checklist items.
/// Each investigation can have one checklist progress record, capturing the template version
/// at creation time (immutable) and all item/section states.
/// Supports custom items added by investigators and skipped items with reasons.
model InvestigationChecklistProgress {
  id              String @id @default(uuid())
  investigationId String @unique @map("investigation_id")
  organizationId  String @map("organization_id")
  templateId      String @map("template_id")
  templateVersion Int    @map("template_version")

  // Current state (JSON)
  itemStates    Json @map("item_states") // { [itemId]: ChecklistItemState }
  sectionStates Json @map("section_states") // { [sectionId]: SectionState }

  // Customizations (investigator changes)
  customItems  Json? @map("custom_items") // Items added by investigator
  skippedItems Json? @map("skipped_items") // Items marked N/A with reason
  itemOrder    Json? @map("item_order") // Custom ordering

  // Summary metrics (denormalized for queries)
  totalItems      Int @map("total_items")
  completedItems  Int @default(0) @map("completed_items")
  skippedCount    Int @default(0) @map("skipped_count")
  customCount     Int @default(0) @map("custom_count")

  // Progress percentage (0-100)
  progressPercent Int @default(0) @map("progress_percent")

  // Timestamps
  startedAt      DateTime? @map("started_at")
  completedAt    DateTime? @map("completed_at")
  lastActivityAt DateTime? @map("last_activity_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization  Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  investigation Investigation         @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  template      InvestigationTemplate @relation(fields: [templateId], references: [id])

  @@index([organizationId])
  @@index([organizationId, templateId])
  @@map("investigation_checklist_progress")
}

// ===========================================
// Notification System Entities
// ===========================================

/// Notification represents a single notification record sent to a user.
/// Notifications can be delivered via email or in-app channels.
/// Scoped to organization for RLS compliance.
model Notification {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  userId         String @map("user_id")

  // Channel and type
  channel NotificationChannel
  type    NotificationType

  // Status tracking
  status NotificationStatus @default(QUEUED)

  // Content
  title String
  body  String?

  // Navigation context (what entity this relates to)
  entityType String? @map("entity_type") // 'case', 'investigation', 'campaign', etc.
  entityId   String? @map("entity_id")

  // Email-specific
  templateId String? @map("template_id") // Which email template was used

  // Read tracking (for in-app)
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  delivery     NotificationDelivery?

  @@index([organizationId])
  @@index([organizationId, userId])
  @@index([organizationId, userId, isRead])
  @@index([organizationId, userId, createdAt])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@map("notifications")
}

/// NotificationDelivery tracks email delivery status for notifications.
/// One-to-one with Notification when channel is EMAIL.
model NotificationDelivery {
  id             String @id @default(uuid())
  notificationId String @unique @map("notification_id")

  // Provider tracking
  messageId String? @map("message_id") // ID from email provider (SendGrid, SES, etc.)

  // Delivery status
  status DeliveryStatus @default(PENDING)

  // Retry tracking
  attempts      Int       @default(0)
  lastAttemptAt DateTime? @map("last_attempt_at")

  // Error details
  errorMessage String? @map("error_message")

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  notification Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([messageId])
  @@map("notification_deliveries")
}

/// NotificationPreference stores user-level notification preferences.
/// Each user has one preference record per organization.
/// Preferences JSON stores per-category settings: { categoryName: { email: bool, inApp: bool } }
model NotificationPreference {
  id             String @id @default(uuid())
  organizationId String @map("organization_id")
  userId         String @unique @map("user_id") // One preference per user

  // Preference settings (JSON structure)
  // { "ASSIGNMENT": { "email": true, "inApp": true }, "DEADLINE": { "email": true, "inApp": true }, ... }
  preferences Json @default("{}")

  // Quiet hours (no non-urgent notifications)
  quietHoursStart String? @map("quiet_hours_start") // HH:MM format (24hr)
  quietHoursEnd   String? @map("quiet_hours_end") // HH:MM format (24hr)
  timezone        String  @default("UTC")

  // Out-of-office handling
  backupUserId String?   @map("backup_user_id") // Receives urgent notifications while user is OOO
  oooUntil     DateTime? @map("ooo_until") // OOO status active until this date

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  backupUser   User?        @relation("BackupUser", fields: [backupUserId], references: [id])

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@map("notification_preferences")
}

/// OrgNotificationSettings stores organization-level notification configuration.
/// One record per organization defining enforced categories and defaults.
model OrgNotificationSettings {
  id             String @id @default(uuid())
  organizationId String @unique @map("organization_id")

  // Enforced categories (users cannot disable these)
  // Examples: ["ASSIGNMENT", "DEADLINE", "ESCALATION"]
  enforcedCategories String[] @default([]) @map("enforced_categories")

  // Default quiet hours for organization
  defaultQuietHoursStart String? @map("default_quiet_hours_start") // HH:MM format
  defaultQuietHoursEnd   String? @map("default_quiet_hours_end") // HH:MM format

  // Digest configuration
  digestTime String @default("17:00") @map("digest_time") // When to send daily digest (HH:MM)

  // Audit
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("org_notification_settings")
}

// ===========================================
// Notification Enums
// ===========================================

enum NotificationChannel {
  EMAIL
  IN_APP

  @@map("notification_channel")
}

enum NotificationType {
  ASSIGNMENT // Task/case assigned to user
  DEADLINE // SLA warning, approaching due date
  APPROVAL // Approval request or decision
  MENTION // @mentioned in comment/note
  INTERVIEW // Interview scheduled/reminder
  STATUS_UPDATE // Entity status changed
  COMMENT // New comment on watched entity
  COMPLETION // Task/investigation/remediation completed
  ESCALATION // SLA breach escalation
  DIGEST // Daily summary digest

  @@map("notification_type")
}

enum NotificationStatus {
  QUEUED // Created, pending delivery
  SENT // Handed off to delivery provider
  DELIVERED // Confirmed delivered
  FAILED // Delivery failed after retries
  READ // User has read (in-app only)
  ARCHIVED // User archived/dismissed

  @@map("notification_status")
}

enum DeliveryStatus {
  PENDING // Not yet attempted
  SENT // Sent to provider
  DELIVERED // Confirmed delivered
  BOUNCED // Email bounced
  FAILED // Permanent failure
  DEFERRED // Temporary failure, will retry

  @@map("delivery_status")
}
