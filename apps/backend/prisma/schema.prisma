// ===========================================
// Ethico Risk Intelligence Platform
// Prisma Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================
// Core Entities
// ===========================================

/// Organization represents a tenant in the multi-tenant system.
/// All business data is scoped to an organization via Row-Level Security.
model Organization {
  id         String   @id @default(uuid())
  name       String
  slug       String   @unique
  settings   Json     @default("{}")
  isActive   Boolean  @default(true) @map("is_active")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  users          User[]
  sessions       Session[]
  cases          Case[]
  investigations Investigation[]
  auditLogs      AuditLog[]

  @@index([slug])
  @@index([isActive])
  @@map("organizations")
}

/// User represents an authenticated user within an organization.
/// Users are scoped to a single organization (no cross-tenant access).
model User {
  id             String    @id @default(uuid())
  organizationId String    @map("organization_id")
  email          String
  passwordHash   String?   @map("password_hash")
  firstName      String    @map("first_name")
  lastName       String    @map("last_name")
  role           UserRole  @default(EMPLOYEE)
  isActive       Boolean   @default(true) @map("is_active")
  emailVerifiedAt DateTime? @map("email_verified_at")
  lastLoginAt    DateTime? @map("last_login_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessions            Session[]
  casesCreated        Case[]       @relation("CaseCreatedBy")
  casesUpdated        Case[]       @relation("CaseUpdatedBy")
  casesIntakeOperator Case[]       @relation("CaseIntakeOperator")
  casesReleased       Case[]       @relation("CaseReleasedBy")
  casesProxySubmitter Case[]       @relation("CaseProxySubmitter")
  auditLogsActed      AuditLog[]   // Audit logs where this user was the actor

  // Investigation relations
  investigationsPrimaryInvestigator Investigation[] @relation("InvestigationPrimaryInvestigator")
  investigationsAssignedBy          Investigation[] @relation("InvestigationAssignedBy")
  investigationsClosedBy            Investigation[] @relation("InvestigationClosedBy")
  investigationsClosureApprovedBy   Investigation[] @relation("InvestigationClosureApprovedBy")
  investigationsCreatedBy           Investigation[] @relation("InvestigationCreatedBy")
  investigationsUpdatedBy           Investigation[] @relation("InvestigationUpdatedBy")

  // Investigation note relations
  investigationNotesAuthored        InvestigationNote[] @relation("InvestigationNoteAuthor")

  // Unique constraint: email must be unique within an organization
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, role])
  @@index([organizationId, isActive])
  @@map("users")
}

/// Session represents an active user session (for refresh token rotation).
/// Sessions are scoped to organization for RLS compliance.
model Session {
  id                String    @id @default(uuid())
  organizationId    String    @map("organization_id")
  userId            String    @map("user_id")
  userAgent         String?   @map("user_agent")
  ipAddress         String?   @map("ip_address")
  expiresAt         DateTime  @map("expires_at")
  revokedAt         DateTime? @map("revoked_at")
  previousSessionId String?   @map("previous_session_id")
  createdAt         DateTime  @default(now()) @map("created_at")

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([revokedAt])
  @@index([expiresAt])
  @@map("sessions")
}

// ===========================================
// Enums
// ===========================================

enum UserRole {
  SYSTEM_ADMIN
  COMPLIANCE_OFFICER
  TRIAGE_LEAD
  INVESTIGATOR
  POLICY_AUTHOR
  POLICY_REVIEWER
  DEPARTMENT_ADMIN
  MANAGER
  EMPLOYEE

  @@map("user_role")
}

enum CaseStatus {
  NEW
  OPEN
  CLOSED

  @@map("case_status")
}

enum SourceChannel {
  HOTLINE
  WEB_FORM
  PROXY
  DIRECT_ENTRY
  CHATBOT

  @@map("source_channel")
}

enum CaseType {
  REPORT
  RFI

  @@map("case_type")
}

enum ReporterType {
  ANONYMOUS
  IDENTIFIED
  PROXY

  @@map("reporter_type")
}

enum ReporterRelationship {
  EMPLOYEE
  FORMER_EMPLOYEE
  VENDOR
  CONTRACTOR
  CUSTOMER
  WITNESS
  OTHER

  @@map("reporter_relationship")
}

enum Severity {
  HIGH
  MEDIUM
  LOW

  @@map("severity")
}

// ===========================================
// Case Management Entities
// ===========================================

/// Case represents a compliance report or request for information.
/// This is the primary container for all case-related data.
model Case {
  id              String   @id @default(uuid())
  referenceNumber String   @unique @map("reference_number")
  organizationId  String   @map("organization_id")

  // Status
  status          CaseStatus @default(NEW)
  statusRationale String?    @map("status_rationale")

  // Intake Information
  sourceChannel   SourceChannel @map("source_channel")
  caseType        CaseType      @default(REPORT) @map("case_type")
  intakeTimestamp DateTime      @default(now()) @map("intake_timestamp")
  intakeOperatorId String?      @map("intake_operator_id")
  firstTimeCaller Boolean?      @map("first_time_caller")
  awarenessSource String?       @map("awareness_source")
  interpreterUsed Boolean?      @map("interpreter_used")

  // Reporter Information
  reporterType         ReporterType @default(ANONYMOUS) @map("reporter_type")
  reporterAnonymous    Boolean      @default(true) @map("reporter_anonymous")
  reporterName         String?      @map("reporter_name") // Encrypted
  reporterEmail        String?      @map("reporter_email") // Encrypted
  reporterPhone        String?      @map("reporter_phone") // Encrypted
  reporterRelationship ReporterRelationship? @map("reporter_relationship")
  anonymousAccessCode  String?      @map("anonymous_access_code")
  proxySubmitterId     String?      @map("proxy_submitter_id")

  // Location Information
  locationName    String?  @map("location_name")
  locationAddress String?  @map("location_address")
  locationCity    String?  @map("location_city")
  locationState   String?  @map("location_state")
  locationZip     String?  @map("location_zip")
  locationCountry String?  @map("location_country")
  locationManual  Boolean? @map("location_manual")

  // Report Content
  details           String  // Full narrative (rich text)
  summary           String? // Manual summary
  addendum          String? // Operator notes
  originalLanguage  String? @map("original_language")
  translatedDetails String? @map("translated_details")
  translationLanguage String? @map("translation_language")

  // Classification
  primaryCategoryId   String?  @map("primary_category_id")
  secondaryCategoryId String?  @map("secondary_category_id")
  severity            Severity @default(MEDIUM)
  severityReason      String?  @map("severity_reason")
  tags                String[] @default([])

  // AI Enrichment
  aiSummary             String?   @map("ai_summary")
  aiSummaryGeneratedAt  DateTime? @map("ai_summary_generated_at")
  aiModelVersion        String?   @map("ai_model_version")
  aiCategorySuggestion  String?   @map("ai_category_suggestion")
  aiSeveritySuggestion  Severity? @map("ai_severity_suggestion")
  aiConfidenceScore     Int?      @map("ai_confidence_score")

  // Custom Data (JSONB)
  customFields    Json? @map("custom_fields")
  customQuestions Json? @map("custom_questions")

  // Migration Support
  sourceSystem   String?   @map("source_system")
  sourceRecordId String?   @map("source_record_id")
  migratedAt     DateTime? @map("migrated_at")

  // Metadata
  parentCaseId String?   @map("parent_case_id")
  isSplit      Boolean   @default(false) @map("is_split")
  releasedAt   DateTime? @map("released_at")
  releasedById String?   @map("released_by_id")
  qaNotes      String?   @map("qa_notes")

  // Audit
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdById String   @map("created_by_id")
  updatedById String   @map("updated_by_id")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy      User         @relation("CaseCreatedBy", fields: [createdById], references: [id])
  updatedBy      User         @relation("CaseUpdatedBy", fields: [updatedById], references: [id])
  intakeOperator User?        @relation("CaseIntakeOperator", fields: [intakeOperatorId], references: [id])
  releasedBy     User?        @relation("CaseReleasedBy", fields: [releasedById], references: [id])
  proxySubmitter User?        @relation("CaseProxySubmitter", fields: [proxySubmitterId], references: [id])
  parentCase     Case?        @relation("CaseSplits", fields: [parentCaseId], references: [id])
  splitCases     Case[]       @relation("CaseSplits")
  investigations Investigation[] // Cases can have multiple investigations

  // Indexes for performance
  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([organizationId, severity])
  @@index([referenceNumber])
  @@map("cases")
}

// ===========================================
// Audit Log (Unified Activity Tracking)
// ===========================================

/// AuditLog provides unified activity tracking across all entities.
/// This is an append-only table - records are never updated or deleted.
/// Used for compliance audit trails and AI context building.
model AuditLog {
  id             String   @id @default(uuid())
  organizationId String   @map("organization_id")

  // Entity Reference (polymorphic)
  entityType     AuditEntityType @map("entity_type")
  entityId       String          @map("entity_id")

  // Action
  action            String                // e.g., 'created', 'updated', 'status_changed'
  actionCategory    AuditActionCategory   @map("action_category")
  actionDescription String                @map("action_description") // Natural language: "John assigned case to Sarah"

  // Actor
  actorUserId    String?    @map("actor_user_id") // Null for system/AI actions
  actorType      ActorType  @map("actor_type")
  actorName      String?    @map("actor_name")    // Denormalized for display

  // Change Details
  changes        Json?      // { field: { old, new } }
  context        Json?      // Additional context for AI

  // Request Metadata
  ipAddress      String?    @map("ip_address")
  userAgent      String?    @map("user_agent")
  requestId      String?    @map("request_id")    // Correlation ID

  // Timestamp (immutable - NO updatedAt for append-only)
  createdAt      DateTime   @default(now()) @map("created_at")

  // Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  actorUser      User?        @relation(fields: [actorUserId], references: [id])

  // Indexes for query patterns
  @@index([organizationId, createdAt])
  @@index([organizationId, entityType, entityId, createdAt])
  @@index([organizationId, actorUserId, createdAt])
  @@index([organizationId, actionCategory, createdAt])
  @@map("audit_logs")
}

// ===========================================
// Audit Log Enums
// ===========================================

enum AuditEntityType {
  CASE
  INVESTIGATION
  DISCLOSURE
  POLICY
  ATTESTATION
  WORKFLOW
  USER
  EMPLOYEE
  ORGANIZATION
  CATEGORY
  FORM
  CHATBOT_CONVERSATION
  REPORT
  DASHBOARD
  INTEGRATION

  @@map("audit_entity_type")
}

enum AuditActionCategory {
  CREATE
  UPDATE
  DELETE
  ACCESS     // View, download, export
  SYSTEM     // Automated actions
  SECURITY   // Auth events
  AI         // AI-generated actions

  @@map("audit_action_category")
}

enum ActorType {
  USER         // Human user
  SYSTEM       // Automated process
  AI           // AI-generated action
  INTEGRATION  // External system
  ANONYMOUS    // Anonymous reporter action

  @@map("actor_type")
}

// ===========================================
// Investigation Enums
// ===========================================

enum InvestigationStatus {
  NEW
  ASSIGNED
  INVESTIGATING
  PENDING_REVIEW
  CLOSED
  ON_HOLD

  @@map("investigation_status")
}

enum InvestigationType {
  FULL
  LIMITED
  INQUIRY

  @@map("investigation_type")
}

enum InvestigationDepartment {
  HR
  LEGAL
  SAFETY
  COMPLIANCE
  OTHER

  @@map("investigation_department")
}

enum InvestigationOutcome {
  SUBSTANTIATED
  UNSUBSTANTIATED
  INCONCLUSIVE
  POLICY_VIOLATION
  NO_VIOLATION
  INSUFFICIENT_EVIDENCE

  @@map("investigation_outcome")
}

enum SlaStatus {
  ON_TRACK
  WARNING
  OVERDUE

  @@map("sla_status")
}

// ===========================================
// Investigation Note Enums
// ===========================================

enum NoteType {
  GENERAL
  INTERVIEW
  EVIDENCE
  FINDING
  RECOMMENDATION
  FOLLOW_UP

  @@map("note_type")
}

enum NoteVisibility {
  PRIVATE  // Author only
  TEAM     // Assigned investigators
  ALL      // All org users with case access

  @@map("note_visibility")
}

// ===========================================
// Investigation Entity
// ===========================================

/// Investigation represents a formal investigation linked to a Case.
/// Cases can have multiple investigations (e.g., HR and Legal investigating same report).
/// organizationId is denormalized from Case for RLS efficiency.
model Investigation {
  id                    String   @id @default(uuid())
  caseId                String   @map("case_id")
  organizationId        String   @map("organization_id") // Denormalized for RLS
  investigationNumber   Int      @map("investigation_number") // 1, 2, 3... within case

  // Classification
  categoryId            String?  @map("category_id")
  investigationType     InvestigationType @default(FULL) @map("investigation_type")
  department            InvestigationDepartment? @map("department")

  // Assignment
  assignedTo            String[] @default([]) @map("assigned_to") // Array of user IDs
  primaryInvestigatorId String?  @map("primary_investigator_id")
  assignedAt            DateTime? @map("assigned_at")
  assignedById          String?  @map("assigned_by_id")
  assignmentHistory     Json?    @map("assignment_history") // Track assignment changes

  // Workflow
  status                InvestigationStatus @default(NEW)
  statusRationale       String?  @map("status_rationale") // AI-first: why status changed
  statusChangedAt       DateTime? @map("status_changed_at")
  dueDate               DateTime? @map("due_date")
  slaStatus             SlaStatus @default(ON_TRACK) @map("sla_status")

  // Findings
  findingsSummary       String?  @map("findings_summary")
  findingsDetail        String?  @map("findings_detail")
  outcome               InvestigationOutcome? @map("outcome")
  rootCause             String?  @map("root_cause")
  lessonsLearned        String?  @map("lessons_learned")
  findingsDate          DateTime? @map("findings_date")

  // Closure
  closedAt              DateTime? @map("closed_at")
  closedById            String?  @map("closed_by_id")
  closureApprovedById   String?  @map("closure_approved_by_id")
  closureApprovedAt     DateTime? @map("closure_approved_at")
  closureNotes          String?  @map("closure_notes")

  // Template
  templateId            String?  @map("template_id")
  templateResponses     Json?    @map("template_responses") // Checklist answers
  templateCompleted     Boolean  @default(false) @map("template_completed")

  // Migration Support
  sourceSystem          String?  @map("source_system")
  sourceRecordId        String?  @map("source_record_id")
  migratedAt            DateTime? @map("migrated_at")

  // Audit
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdById           String   @map("created_by_id")
  updatedById           String   @map("updated_by_id")

  // Relations
  case                  Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  organization          Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  primaryInvestigator   User?        @relation("InvestigationPrimaryInvestigator", fields: [primaryInvestigatorId], references: [id])
  assignedBy            User?        @relation("InvestigationAssignedBy", fields: [assignedById], references: [id])
  closedBy              User?        @relation("InvestigationClosedBy", fields: [closedById], references: [id])
  closureApprovedBy     User?        @relation("InvestigationClosureApprovedBy", fields: [closureApprovedById], references: [id])
  createdBy             User         @relation("InvestigationCreatedBy", fields: [createdById], references: [id])
  updatedBy             User         @relation("InvestigationUpdatedBy", fields: [updatedById], references: [id])

  // Child entities
  notes                 InvestigationNote[]

  // Indexes for query patterns
  @@index([organizationId])
  @@index([organizationId, caseId])
  @@index([organizationId, status])
  @@index([organizationId, primaryInvestigatorId])
  @@index([organizationId, dueDate])
  @@index([organizationId, slaStatus])
  @@unique([caseId, investigationNumber])
  @@map("investigations")
}

// ===========================================
// Investigation Note Entity
// ===========================================

/// InvestigationNote stores rich-text notes on investigations.
/// Notes can be general, interview records, evidence documentation, findings, recommendations, or follow-ups.
/// organizationId is denormalized from Investigation for RLS efficiency.
model InvestigationNote {
  id               String   @id @default(uuid())
  investigationId  String   @map("investigation_id")
  organizationId   String   @map("organization_id") // Denormalized from Investigation for RLS

  // Content
  content          String   @db.VarChar(50000) // Rich text (HTML/markdown)
  contentPlainText String?  @map("content_plain_text") // Auto-generated in service layer for search
  noteType         NoteType @default(GENERAL) @map("note_type")

  // Visibility
  visibility       NoteVisibility @default(TEAM)

  // Author
  authorId         String   @map("author_id")
  authorName       String   @map("author_name") // Denormalized for display performance

  // Edit Tracking
  isEdited         Boolean  @default(false) @map("is_edited")
  editedAt         DateTime? @map("edited_at")
  editCount        Int      @default(0) @map("edit_count")

  // Attachments (JSON array: [{ id, filename, url, size, mimeType }])
  attachments      Json     @default("[]")

  // AI Enrichment
  aiSummary             String?   @map("ai_summary")
  aiSummaryGeneratedAt  DateTime? @map("ai_summary_generated_at")
  aiModelVersion        String?   @map("ai_model_version")

  // Migration Support
  sourceSystem     String?   @map("source_system") // e.g., 'NAVEX', 'EQS', 'MANUAL'
  sourceRecordId   String?   @map("source_record_id")
  migratedAt       DateTime? @map("migrated_at")

  // Audit
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Relations
  investigation    Investigation @relation(fields: [investigationId], references: [id], onDelete: Cascade)
  author           User          @relation("InvestigationNoteAuthor", fields: [authorId], references: [id])

  // Indexes for query patterns
  @@index([organizationId, investigationId]) // Primary query pattern
  @@index([organizationId, authorId])        // Author filtering
  @@index([createdAt])                       // Timeline sorting
  @@map("investigation_notes")
}
