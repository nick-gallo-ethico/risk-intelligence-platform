# Phase 11.1: Frontend Navigation and UI Fixes - Research

**Researched:** 2026-02-05
**Domain:** Next.js App Router + shadcn/ui Navigation Patterns
**Confidence:** HIGH

## Summary

This research covers implementing an icon rail sidebar with flyout menus, mobile bottom navigation, and fixing the case detail tabs (Messages, Files, Remediation) to display real data. The project already has a solid foundation with Next.js 14, shadcn/ui components (Radix primitives), Tailwind CSS, @tanstack/react-query, and Lucide icons.

The primary approach uses the official **shadcn/ui Sidebar component** which provides composable primitives for building collapsible sidebars with icon-rail mode support. The component handles both desktop (persistent sidebar) and mobile (Sheet-based slide-out) navigation patterns out of the box.

For the case tabs, backend APIs already exist for messaging (`/case-messages/:caseId`), remediation (`/remediation/plans/by-case/:caseId`), and attachments (`/attachments?entityType=CASE&entityId=:caseId`). The frontend just needs API client functions and proper data-fetching implementations.

**Primary recommendation:** Install shadcn/ui sidebar component via CLI, create an authenticated layout wrapper with icon-rail collapsible sidebar, and wire up the case tabs to existing backend APIs.

## Standard Stack

The established libraries/tools for this domain:

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| shadcn/ui sidebar | latest | Sidebar component primitives | Official shadcn/ui component with Radix primitives, handles mobile/desktop, collapsible variants |
| lucide-react | ^0.312.0 | Icons | Already in use, comprehensive icon set with consistent style |
| @radix-ui/react-dialog | ^1.1.15 | Sheet for mobile nav | Already installed, used by shadcn/ui Sheet component |
| @dnd-kit/sortable | ^10.0.0 | Drag-reorder remediation steps | Already in use for other features |
| @tanstack/react-query | ^5.90.20 | Data fetching | Already in use, provides caching, loading states, error handling |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| tailwindcss-animate | ^1.0.7 | Animations | Already installed, use for sidebar transitions |
| class-variance-authority | ^0.7.0 | Variant styling | Already in use, for sidebar variant props |
| clsx + tailwind-merge | installed | Class merging | Already in use via cn() utility |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| shadcn/ui sidebar | Custom sidebar | Custom requires more code, shadcn/ui is battle-tested and composable |
| Bottom tab bar custom | react-navigation | react-navigation is for React Native; custom is appropriate for web |

**Installation:**
```bash
# Install shadcn/ui sidebar component (run in apps/frontend)
npx shadcn@latest add sidebar
```

## Architecture Patterns

### Recommended Project Structure
```
src/
├── app/
│   ├── (authenticated)/       # Route group for authenticated pages
│   │   ├── layout.tsx         # NEW: Contains SidebarProvider + AppSidebar
│   │   ├── dashboard/         # Move from app/dashboard
│   │   ├── cases/             # Move from app/cases
│   │   ├── investigations/    # Move from app/investigations
│   │   ├── policies/          # Already exists
│   │   ├── campaigns/         # NEW: Campaigns list page
│   │   ├── analytics/         # NEW: Analytics page
│   │   └── settings/          # Already exists
│   ├── (public)/              # Route group for public pages
│   │   ├── login/
│   │   └── ethics/
│   └── layout.tsx             # Root layout (minimal)
├── components/
│   ├── layout/                # NEW: Layout components
│   │   ├── app-sidebar.tsx    # Main sidebar component
│   │   ├── nav-main.tsx       # Main navigation items
│   │   ├── nav-admin.tsx      # Admin section items
│   │   ├── ai-panel.tsx       # AI chat slide-over
│   │   └── mobile-nav.tsx     # Mobile bottom bar + drawer
│   ├── cases/
│   │   ├── messages-tab.tsx   # NEW: Messages tab content
│   │   ├── files-tab.tsx      # NEW: Files tab content
│   │   └── remediation-tab.tsx # NEW: Remediation tab content
│   └── ui/
│       └── sidebar.tsx        # NEW: shadcn/ui sidebar primitives
```

### Pattern 1: shadcn/ui Sidebar with Icon Rail
**What:** Composable sidebar with collapsible="icon" variant for icon-rail mode
**When to use:** Main authenticated layout navigation
**Example:**
```typescript
// Source: https://ui.shadcn.com/docs/components/sidebar

// app/(authenticated)/layout.tsx
import { SidebarProvider, SidebarTrigger } from "@/components/ui/sidebar"
import { AppSidebar } from "@/components/layout/app-sidebar"
import { cookies } from "next/headers"

export default async function AuthenticatedLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const cookieStore = await cookies()
  const defaultOpen = cookieStore.get("sidebar:state")?.value === "true"

  return (
    <SidebarProvider defaultOpen={defaultOpen}>
      <AppSidebar />
      <main className="flex-1 overflow-auto">
        <SidebarTrigger />
        {children}
      </main>
    </SidebarProvider>
  )
}

// components/layout/app-sidebar.tsx
import {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarHeader,
  SidebarRail,
  useSidebar,
} from "@/components/ui/sidebar"

export function AppSidebar() {
  return (
    <Sidebar collapsible="icon">
      <SidebarHeader>
        {/* Logo - shows icon when collapsed */}
      </SidebarHeader>
      <SidebarContent>
        <NavMain items={navigationItems} />
        <NavAdmin items={adminItems} />
      </SidebarContent>
      <SidebarFooter>
        {/* AI Button, Collapse toggle */}
      </SidebarFooter>
      <SidebarRail />
    </Sidebar>
  )
}
```

### Pattern 2: Flyout Menu Pattern
**What:** Hover/click to reveal submenu from collapsed sidebar
**When to use:** When sidebar is in icon-rail mode
**Example:**
```typescript
// Source: shadcn/ui sidebar documentation

import {
  SidebarMenu,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSub,
  SidebarMenuSubItem,
  SidebarMenuSubButton,
} from "@/components/ui/sidebar"
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@/components/ui/collapsible"

function NavSection({ item }: { item: NavItem }) {
  return (
    <Collapsible asChild defaultOpen={item.isActive}>
      <SidebarMenuItem>
        <CollapsibleTrigger asChild>
          <SidebarMenuButton tooltip={item.title}>
            <item.icon />
            <span>{item.title}</span>
          </SidebarMenuButton>
        </CollapsibleTrigger>
        <CollapsibleContent>
          <SidebarMenuSub>
            {item.items?.map((subItem) => (
              <SidebarMenuSubItem key={subItem.title}>
                <SidebarMenuSubButton asChild>
                  <Link href={subItem.url}>{subItem.title}</Link>
                </SidebarMenuSubButton>
              </SidebarMenuSubItem>
            ))}
          </SidebarMenuSub>
        </CollapsibleContent>
      </SidebarMenuItem>
    </Collapsible>
  )
}
```

### Pattern 3: Mobile Bottom Navigation
**What:** Fixed bottom bar with primary actions, hamburger for overflow
**When to use:** Screen width < 768px (md breakpoint)
**Example:**
```typescript
// components/layout/mobile-nav.tsx
'use client';

import { usePathname } from 'next/navigation';
import Link from 'next/link';
import { Home, Briefcase, FileText, BarChart3, Menu } from 'lucide-react';
import { Sheet, SheetContent, SheetTrigger } from '@/components/ui/sheet';
import { cn } from '@/lib/utils';

const bottomNavItems = [
  { href: '/dashboard', icon: Home, label: 'Home' },
  { href: '/cases', icon: Briefcase, label: 'Cases' },
  { href: '/policies', icon: FileText, label: 'Policies' },
  { href: '/analytics', icon: BarChart3, label: 'Analytics' },
];

export function MobileBottomNav() {
  const pathname = usePathname();

  return (
    <nav className="fixed bottom-0 inset-x-0 bg-background border-t md:hidden z-50">
      <div className="flex items-center justify-around h-16">
        {bottomNavItems.map((item) => (
          <Link
            key={item.href}
            href={item.href}
            className={cn(
              'flex flex-col items-center justify-center flex-1 py-2',
              pathname.startsWith(item.href)
                ? 'text-primary'
                : 'text-muted-foreground'
            )}
          >
            <item.icon className="h-5 w-5" />
            <span className="text-xs mt-1">{item.label}</span>
          </Link>
        ))}
        <Sheet>
          <SheetTrigger className="flex flex-col items-center justify-center flex-1 py-2 text-muted-foreground">
            <Menu className="h-5 w-5" />
            <span className="text-xs mt-1">More</span>
          </SheetTrigger>
          <SheetContent side="left">
            {/* Full navigation menu */}
          </SheetContent>
        </Sheet>
      </div>
    </nav>
  )
}
```

### Pattern 4: Case Tab Data Fetching
**What:** React Query hooks for fetching tab data
**When to use:** Messages, Files, Remediation tabs
**Example:**
```typescript
// hooks/use-case-messages.ts
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api';

interface Message {
  id: string;
  direction: 'inbound' | 'outbound';
  content: string;
  subject?: string;
  createdAt: string;
  isRead: boolean;
  senderType: string;
}

export function useCaseMessages(caseId: string) {
  return useQuery({
    queryKey: ['case-messages', caseId],
    queryFn: async () => {
      const response = await apiClient.get<{ messages: Message[]; totalCount: number }>(
        `/case-messages/${caseId}`
      );
      return response;
    },
    enabled: !!caseId,
  });
}
```

### Pattern 5: Drag-Reorder Remediation Steps
**What:** dnd-kit sortable for step reordering
**When to use:** Remediation tab step list
**Example:**
```typescript
// Source: https://docs.dndkit.com/presets/sortable
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';

function SortableStep({ step }: { step: RemediationStep }) {
  const { attributes, listeners, setNodeRef, transform, transition } = useSortable({
    id: step.id,
  });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div ref={setNodeRef} style={style} {...attributes}>
      <div className="flex items-center gap-2 p-3 border rounded-lg">
        <button {...listeners} className="cursor-grab">
          <GripVertical className="h-4 w-4 text-muted-foreground" />
        </button>
        {/* Step content */}
      </div>
    </div>
  );
}
```

### Anti-Patterns to Avoid
- **Inline navigation in every page:** Each page currently has its own header with navigation. Extract to shared layout.
- **Prop drilling for sidebar state:** Use the useSidebar hook from SidebarProvider context instead.
- **Manual responsive handling:** Let shadcn/ui sidebar handle mobile detection via isMobile.
- **Fetching data without React Query:** All tab data should use useQuery for consistent caching and loading states.
- **Custom drag-drop implementation:** Use dnd-kit which is already installed and handles accessibility.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Collapsible sidebar | Custom toggle logic | shadcn/ui Sidebar with collapsible="icon" | Handles keyboard shortcuts, state persistence, mobile adaptation |
| Mobile navigation | Custom bottom bar + drawer | shadcn/ui Sheet + fixed nav | Sheet already handles slide animations, backdrop |
| Sidebar state persistence | localStorage directly | SidebarProvider + cookies | SSR-compatible, hydration-safe |
| Drag reorder | Custom drag handlers | @dnd-kit/sortable | Accessibility, keyboard support, touch support |
| Loading states | Custom loading flags | React Query isLoading/isFetching | Consistent across all queries, automatic |
| Empty states | Ad-hoc placeholders | Consistent EmptyState component | Reusable pattern per CONTEXT.md |

**Key insight:** The shadcn/ui sidebar handles the complex icon-rail + flyout pattern, including keyboard shortcuts (Cmd/Ctrl+B), state persistence via cookies, and automatic mobile Sheet conversion. Building this from scratch would take significantly longer.

## Common Pitfalls

### Pitfall 1: Sidebar State Hydration Mismatch
**What goes wrong:** SSR renders expanded, client renders collapsed, causing hydration error
**Why it happens:** localStorage-based state isn't available on server
**How to avoid:** Use cookies for sidebar state (SidebarProvider uses `sidebar:state` cookie)
**Warning signs:** Console errors about hydration mismatch, flickering sidebar on load

### Pitfall 2: Missing Role-Based Navigation Filtering
**What goes wrong:** Admin menu shows for all users, or crashes for non-admin
**Why it happens:** Navigation items rendered before role check
**How to avoid:** Filter navigation items based on user.role before rendering
**Warning signs:** Seeing admin options when logged in as EMPLOYEE role

### Pitfall 3: Stale Tab Data After Mutations
**What goes wrong:** Sending a message doesn't show in Messages tab
**Why it happens:** React Query cache not invalidated after mutation
**How to avoid:** Use queryClient.invalidateQueries in onSuccess callbacks
**Warning signs:** Need to refresh page to see updated data

### Pitfall 4: Mobile Navigation Z-Index Conflicts
**What goes wrong:** Sidebar overlaps with modals or toasts
**Why it happens:** z-index values not coordinated
**How to avoid:** Use consistent z-index scale: bottom-nav=50, sidebar=40, modals=50, toasts=60
**Warning signs:** Elements appearing behind/above incorrectly

### Pitfall 5: Deep Linking to Tabs Breaks
**What goes wrong:** /cases/123?tab=messages doesn't work after navigation restructure
**Why it happens:** Tab state managed in URL but not read on mount
**How to avoid:** Continue using searchParams for tab state (already implemented in case-tabs.tsx)
**Warning signs:** Sharing URLs doesn't open correct tab

### Pitfall 6: Flyout Menu Doesn't Close
**What goes wrong:** Flyout stays open when clicking elsewhere
**Why it happens:** Missing onOpenChange handlers or click-outside detection
**How to avoid:** Use shadcn/ui Collapsible which handles this automatically
**Warning signs:** Multiple flyouts open simultaneously

## Code Examples

Verified patterns from official sources:

### useSidebar Hook Usage
```typescript
// Source: https://ui.shadcn.com/docs/components/sidebar
import { useSidebar } from "@/components/ui/sidebar"

function SidebarCollapseButton() {
  const { toggleSidebar, state } = useSidebar()

  return (
    <button onClick={toggleSidebar} aria-label="Toggle sidebar">
      {state === 'expanded' ? <PanelLeftClose /> : <PanelLeft />}
    </button>
  )
}
```

### API Client for Messages
```typescript
// lib/messages-api.ts
import { apiClient } from './api';

export interface CaseMessage {
  id: string;
  direction: 'inbound' | 'outbound';
  content: string;
  subject?: string;
  createdAt: string;
  isRead: boolean;
  readAt?: string;
  senderType: string;
}

export const messagesApi = {
  getForCase: (caseId: string) =>
    apiClient.get<{ messages: CaseMessage[]; totalCount: number }>(
      `/case-messages/${caseId}`
    ),

  send: (caseId: string, content: string, subject?: string) =>
    apiClient.post<CaseMessage>(`/case-messages/${caseId}/send`, {
      content,
      subject,
    }),

  getUnreadCount: (caseId: string) =>
    apiClient.get<{ inbound: number; outbound: number }>(
      `/case-messages/${caseId}/unread-count`
    ),
};
```

### Remediation API Client
```typescript
// lib/remediation-api.ts
import { apiClient } from './api';

export interface RemediationPlan {
  id: string;
  caseId: string;
  title: string;
  description?: string;
  status: 'DRAFT' | 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
  steps: RemediationStep[];
  createdAt: string;
}

export interface RemediationStep {
  id: string;
  planId: string;
  title: string;
  description?: string;
  status: 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'SKIPPED';
  order: number;
  assigneeId?: string;
  assigneeName?: string;
  dueDate?: string;
  completedAt?: string;
}

export const remediationApi = {
  getByCase: (caseId: string) =>
    apiClient.get<RemediationPlan[]>(`/remediation/plans/by-case/${caseId}`),

  reorderSteps: (planId: string, stepOrders: { id: string; order: number }[]) =>
    apiClient.put(`/remediation/plans/${planId}/steps/reorder`, stepOrders),
};
```

### Empty State Component
```typescript
// components/common/empty-state.tsx
import { LucideIcon } from 'lucide-react';
import { Button } from '@/components/ui/button';

interface EmptyStateProps {
  icon: LucideIcon;
  title: string;
  description: string;
  actionLabel?: string;
  onAction?: () => void;
}

export function EmptyState({
  icon: Icon,
  title,
  description,
  actionLabel,
  onAction,
}: EmptyStateProps) {
  return (
    <div className="flex flex-col items-center justify-center py-12 text-center">
      <Icon className="h-12 w-12 text-muted-foreground/50 mb-4" />
      <h4 className="text-sm font-medium text-foreground mb-1">{title}</h4>
      <p className="text-sm text-muted-foreground max-w-sm mb-4">{description}</p>
      {actionLabel && onAction && (
        <Button onClick={onAction} size="sm">
          {actionLabel}
        </Button>
      )}
    </div>
  );
}
```

### Skeleton Shimmer Effect
```typescript
// Already have Skeleton component, add shimmer animation
// In globals.css or tailwind config
@keyframes shimmer {
  0% { background-position: -200% 0; }
  100% { background-position: 200% 0; }
}

.animate-shimmer {
  animation: shimmer 1.5s infinite;
  background: linear-gradient(
    90deg,
    hsl(var(--muted)) 25%,
    hsl(var(--muted-foreground) / 0.1) 50%,
    hsl(var(--muted)) 75%
  );
  background-size: 200% 100%;
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Hamburger menu everywhere | Bottom tab bar + icon rail | 2024-2025 | 40% faster task completion (Airbnb study) |
| Custom sidebar components | shadcn/ui Sidebar primitives | Oct 2024 | Official component with full accessibility |
| react-dnd | @dnd-kit | 2023 | Better TypeScript, smaller bundle, better accessibility |
| Manual loading states | React Query v5 | 2024 | Automatic suspense integration, better caching |

**Deprecated/outdated:**
- **Material-UI (MUI):** Project uses shadcn/ui per project standards - do NOT use MUI
- **react-beautiful-dnd:** Deprecated in favor of @dnd-kit
- **Pages Router layouts:** Project uses App Router - use route groups and layout.tsx

## Open Questions

Things that couldn't be fully resolved:

1. **Exact breakpoint for mobile nav switch**
   - What we know: Tailwind md breakpoint is 768px
   - What's unclear: Whether sidebar needs 768px or custom breakpoint
   - Recommendation: Start with md (768px), adjust based on sidebar width requirements

2. **AI Panel context-aware quick actions**
   - What we know: Panel should show context-based actions at top
   - What's unclear: Exact actions per page type, how to determine context
   - Recommendation: Start with route-based context (e.g., case detail page shows case-related actions)

3. **Campaign list saved views**
   - What we know: savedViews service exists for cases
   - What's unclear: Whether to reuse or create campaign-specific views
   - Recommendation: Reuse SavedViewSelector with entityType='CAMPAIGNS'

## Sources

### Primary (HIGH confidence)
- [shadcn/ui Sidebar Documentation](https://ui.shadcn.com/docs/components/sidebar) - Full API, variants, useSidebar hook
- [Next.js App Router Layouts](https://nextjs.org/docs/app/building-your-application/routing/layouts-and-templates) - Layout patterns
- [@dnd-kit Sortable Documentation](https://docs.dndkit.com/presets/sortable) - Drag reorder implementation
- Existing codebase: `apps/backend/src/modules/messaging/messaging.controller.ts` - Messages API
- Existing codebase: `apps/backend/src/modules/remediation/remediation.controller.ts` - Remediation API
- Existing codebase: `apps/frontend/src/lib/attachments-api.ts` - Files API

### Secondary (MEDIUM confidence)
- [shadcn/ui Sidebar Blocks](https://ui.shadcn.com/blocks/sidebar) - Building block examples
- [Mobile Navigation Design Patterns 2026](https://phone-simulator.com/blog/mobile-navigation-patterns-in-2026) - Bottom tab bar best practices

### Tertiary (LOW confidence)
- Medium articles on sidebar architecture - General patterns, not official

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All libraries already in use or official shadcn/ui
- Architecture: HIGH - Follows Next.js App Router conventions and existing patterns
- Pitfalls: HIGH - Based on common React/Next.js issues and codebase analysis
- API integration: HIGH - Backend APIs verified to exist with correct endpoints

**Research date:** 2026-02-05
**Valid until:** 2026-03-05 (30 days - stable domain)
