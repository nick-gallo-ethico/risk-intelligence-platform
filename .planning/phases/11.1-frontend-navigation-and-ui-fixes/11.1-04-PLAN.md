---
phase: 11.1-frontend-navigation-and-ui-fixes
plan: 04
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - apps/frontend/src/lib/remediation-api.ts
  - apps/frontend/src/hooks/use-case-remediation.ts
  - apps/frontend/src/types/remediation.ts
  - apps/frontend/src/components/cases/remediation-tab.tsx
  - apps/frontend/src/components/cases/remediation-step-card.tsx
  - apps/frontend/src/components/cases/case-tabs.tsx
autonomous: true

must_haves:
  truths:
    - "Remediation tab shows list of remediation plans for the case"
    - "Each plan shows steps with status, assignee, due date"
    - "Steps can be reordered via drag-and-drop"
    - "New remediation plan can be created from tab"
  artifacts:
    - path: "apps/frontend/src/lib/remediation-api.ts"
      provides: "Remediation plans API client"
      exports: ["remediationApi"]
    - path: "apps/frontend/src/components/cases/remediation-tab.tsx"
      provides: "Remediation tab component with real data"
      min_lines: 100
    - path: "apps/frontend/src/components/cases/remediation-step-card.tsx"
      provides: "Draggable step card component"
      min_lines: 40
  key_links:
    - from: "apps/frontend/src/components/cases/remediation-tab.tsx"
      to: "/api/v1/remediation"
      via: "React Query hook"
      pattern: "useCaseRemediation"
    - from: "apps/frontend/src/components/cases/remediation-step-card.tsx"
      to: "@dnd-kit/sortable"
      via: "useSortable hook"
      pattern: "useSortable"
---

<objective>
Wire the Remediation tab on case detail page to fetch and display real remediation plans with drag-reorder capability.

Purpose: Remediation tab currently shows placeholder; users need to see actual remediation plans and steps.
Output: Working Remediation tab with plan list, step cards, status badges, and drag-reorder.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-CONTEXT.md
@.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-RESEARCH.md
@apps/frontend/src/components/cases/case-tabs.tsx
@apps/backend/src/modules/remediation/remediation.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Remediation API Client and Types</name>
  <files>
    apps/frontend/src/types/remediation.ts
    apps/frontend/src/lib/remediation-api.ts
    apps/frontend/src/hooks/use-case-remediation.ts
  </files>
  <action>
1. Create types/remediation.ts:
   ```typescript
   export type RemediationPlanStatus = 'DRAFT' | 'ACTIVE' | 'COMPLETED' | 'CANCELLED';
   export type RemediationStepStatus = 'PENDING' | 'IN_PROGRESS' | 'COMPLETED' | 'SKIPPED' | 'AWAITING_APPROVAL';

   export interface RemediationStep {
     id: string;
     planId: string;
     title: string;
     description?: string;
     status: RemediationStepStatus;
     order: number;
     assigneeId?: string;
     assigneeName?: string;
     assigneeEmail?: string;
     externalAssigneeName?: string;
     externalAssigneeEmail?: string;
     dueDate?: string;
     completedAt?: string;
     completedById?: string;
     notes?: string;
     requiresApproval?: boolean;
     dependsOn?: string[];
   }

   export interface RemediationPlan {
     id: string;
     caseId: string;
     investigationId?: string;
     title: string;
     description?: string;
     status: RemediationPlanStatus;
     steps: RemediationStep[];
     totalSteps: number;
     completedSteps: number;
     overdueSteps: number;
     createdAt: string;
     updatedAt: string;
     createdById: string;
   }
   ```

2. Create remediation-api.ts:
   - Import apiClient from ./api
   - Endpoints:
     - getByCase(caseId): GET /remediation/plans/by-case/:caseId -> RemediationPlan[]
     - getById(planId): GET /remediation/plans/:planId -> RemediationPlan
     - create(dto): POST /remediation/plans
     - updatePlan(planId, dto): PUT /remediation/plans/:planId
     - activatePlan(planId): POST /remediation/plans/:planId/activate
     - reorderSteps(planId, stepOrders): PUT /remediation/plans/:planId/steps/reorder
     - completeStep(stepId, dto): POST /remediation/steps/:stepId/complete
     - skipStep(stepId, reason): POST /remediation/steps/:stepId/skip

3. Create use-case-remediation.ts hook:
   - useCaseRemediation(caseId): useQuery for fetching plans by case
   - useReorderSteps(planId): useMutation for reorder, invalidates plan query
   - useCompleteStep(): useMutation for completing step
   - All queries enabled only when IDs provided
  </action>
  <verify>
- `grep "getByCase" apps/frontend/src/lib/remediation-api.ts` shows endpoint
- `grep "useQuery" apps/frontend/src/hooks/use-case-remediation.ts` shows React Query
- TypeScript compiles: `cd apps/frontend && npx tsc --noEmit`
  </verify>
  <done>
- remediationApi exports all CRUD operations
- useCaseRemediation hook provides plans data with loading/error states
- useReorderSteps hook provides mutation with cache invalidation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Draggable Remediation Step Card</name>
  <files>
    apps/frontend/src/components/cases/remediation-step-card.tsx
  </files>
  <action>
1. Create remediation-step-card.tsx:
   - Props: step (RemediationStep), onComplete?, onSkip?, isDragging?
   - Use useSortable from @dnd-kit/sortable for drag handle
   - Layout:
     - Drag handle (GripVertical icon) on left
     - Status badge (color-coded: PENDING=gray, IN_PROGRESS=blue, COMPLETED=green, SKIPPED=amber, AWAITING_APPROVAL=purple)
     - Title (font-medium)
     - Description (text-sm text-muted-foreground, truncated)
     - Assignee with Avatar (or "Unassigned")
     - Due date with calendar icon (red if overdue, amber if due soon)
     - Action buttons: Complete, Skip (dropdown menu)
   - Card styling: border, rounded-lg, p-3, hover:border-primary/50
   - When isDragging: opacity-50, shadow-lg
   - Apply transform from useSortable
  </action>
  <verify>
- `grep "useSortable" apps/frontend/src/components/cases/remediation-step-card.tsx` shows dnd-kit usage
- `grep "GripVertical" apps/frontend/src/components/cases/remediation-step-card.tsx` shows drag handle
- Component renders step information correctly
  </verify>
  <done>
- RemediationStepCard renders step with all details
- Status badge color-coded
- Drag handle present and styled
- Due date shows overdue/upcoming styling
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Remediation Tab with Drag-Reorder</name>
  <files>
    apps/frontend/src/components/cases/remediation-tab.tsx
    apps/frontend/src/components/cases/case-tabs.tsx
  </files>
  <action>
1. Create remediation-tab.tsx:
   - Props: caseId
   - Use useCaseRemediation(caseId) hook
   - Loading state: Skeleton loaders
   - Empty state: EmptyState with ClipboardCheck icon, "No remediation plans", "Create a plan to track corrective actions", action "Create Plan"
   - Plans display:
     - If multiple plans, show accordion/collapsible for each
     - Plan header: title, status badge, progress (X/Y steps completed)
     - Plan actions: Activate (if DRAFT), View Details
   - Steps list within each plan:
     - DndContext with closestCenter collision detection
     - SortableContext with verticalListSortingStrategy
     - Map steps to RemediationStepCard
     - Handle onDragEnd: call useReorderSteps mutation
   - "+ Add Step" button at bottom of step list
   - "Create Plan" button in header if plans exist

2. Implement drag-reorder:
   ```typescript
   const handleDragEnd = (event: DragEndEvent) => {
     const { active, over } = event;
     if (over && active.id !== over.id) {
       const oldIndex = steps.findIndex(s => s.id === active.id);
       const newIndex = steps.findIndex(s => s.id === over.id);
       const newSteps = arrayMove(steps, oldIndex, newIndex);
       const stepOrders = newSteps.map((s, i) => ({ id: s.id, order: i }));
       reorderMutation.mutate(stepOrders);
     }
   };
   ```

3. Update case-tabs.tsx:
   - Import new RemediationTab component
   - Replace placeholder RemediationTab function with real component
   - Pass caseId to RemediationTab
  </action>
  <verify>
- Navigate to case detail, click Remediation tab
- If plans exist, they display with steps
- Drag a step and verify it reorders
- If no plans, empty state shown with create button
  </verify>
  <done>
- Remediation tab fetches and displays real plans
- Steps shown with status badges, assignees, due dates
- Drag-reorder works and persists to backend
- Empty state with create action
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to a case detail page
2. Click Remediation tab:
   - See remediation plans if any exist
   - See empty state if no plans
   - See steps within each plan with status badges
3. Test drag-reorder:
   - Drag a step to new position
   - Verify order updates
4. Run: `cd apps/frontend && npm run lint`
5. Run: `cd apps/frontend && npx tsc --noEmit`
</verification>

<success_criteria>
- Remediation tab displays real plans from API
- Each plan shows steps with status, assignee, due date
- Steps can be reordered via drag-and-drop
- Reorder persists to backend
- Empty state renders when no plans
- No TypeScript or ESLint errors
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-04-SUMMARY.md`
</output>
