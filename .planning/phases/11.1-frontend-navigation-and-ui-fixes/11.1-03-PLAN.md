---
phase: 11.1-frontend-navigation-and-ui-fixes
plan: 03
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - apps/frontend/src/lib/messages-api.ts
  - apps/frontend/src/hooks/use-case-messages.ts
  - apps/frontend/src/hooks/use-case-files.ts
  - apps/frontend/src/components/cases/messages-tab.tsx
  - apps/frontend/src/components/cases/files-tab.tsx
  - apps/frontend/src/components/cases/case-tabs.tsx
  - apps/frontend/src/components/common/empty-state.tsx
autonomous: true

must_haves:
  truths:
    - "Messages tab shows chronological list of case communications"
    - "Messages tab allows sending new messages with PII warning"
    - "Files tab shows grid of attachments with thumbnails"
    - "Files tab allows uploading new files"
    - "Empty states shown when no data"
  artifacts:
    - path: "apps/frontend/src/lib/messages-api.ts"
      provides: "Case messages API client"
      exports: ["messagesApi"]
    - path: "apps/frontend/src/components/cases/messages-tab.tsx"
      provides: "Messages tab component with real data"
      min_lines: 80
    - path: "apps/frontend/src/components/cases/files-tab.tsx"
      provides: "Files tab component with grid view"
      min_lines: 60
  key_links:
    - from: "apps/frontend/src/components/cases/messages-tab.tsx"
      to: "/api/v1/case-messages"
      via: "React Query hook"
      pattern: "useCaseMessages"
    - from: "apps/frontend/src/components/cases/files-tab.tsx"
      to: "attachmentsApi"
      via: "React Query hook"
      pattern: "useCaseFiles"
---

<objective>
Wire the Messages and Files tabs on case detail page to fetch and display real data from backend APIs.

Purpose: Case detail tabs currently show placeholders; users need to see actual messages and files.
Output: Working Messages tab with chronological thread, Files tab with grid view and upload.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-CONTEXT.md
@.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-RESEARCH.md
@apps/frontend/src/components/cases/case-tabs.tsx
@apps/frontend/src/lib/attachments-api.ts
@apps/backend/src/modules/messaging/messaging.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Messages API Client and Hook</name>
  <files>
    apps/frontend/src/lib/messages-api.ts
    apps/frontend/src/hooks/use-case-messages.ts
    apps/frontend/src/types/message.ts
  </files>
  <action>
1. Create types/message.ts:
   ```typescript
   export interface CaseMessage {
     id: string;
     direction: 'inbound' | 'outbound';
     content: string;
     subject?: string;
     createdAt: string;
     isRead: boolean;
     readAt?: string;
     senderType: string;
   }

   export interface MessagesListResponse {
     messages: CaseMessage[];
     totalCount: number;
   }

   export interface UnreadCountResponse {
     inbound: number;
     outbound: number;
   }

   export interface PiiCheckResult {
     hasPii: boolean;
     warnings: string[];
   }
   ```

2. Create messages-api.ts:
   - Import apiClient from ./api
   - Endpoints:
     - getForCase(caseId): GET /case-messages/:caseId -> MessagesListResponse
     - send(caseId, content, subject?, skipPiiCheck?, acknowledgedPiiWarnings?): POST /case-messages/:caseId/send
     - getUnreadCount(caseId): GET /case-messages/:caseId/unread-count -> UnreadCountResponse
     - checkPii(content): POST /case-messages/check-pii -> PiiCheckResult

3. Create use-case-messages.ts hook:
   - useCaseMessages(caseId): useQuery for fetching messages
   - useSendMessage(caseId): useMutation for sending, invalidates messages query on success
   - useUnreadCount(caseId): useQuery for unread count
   - All queries enabled only when caseId is provided
  </action>
  <verify>
- `grep "getForCase" apps/frontend/src/lib/messages-api.ts` shows endpoint
- `grep "useQuery" apps/frontend/src/hooks/use-case-messages.ts` shows React Query usage
- TypeScript compiles: `cd apps/frontend && npx tsc --noEmit`
  </verify>
  <done>
- messagesApi exports all CRUD operations
- useCaseMessages hook provides messages data with loading/error states
- useSendMessage hook provides mutation with cache invalidation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Reusable Empty State Component</name>
  <files>
    apps/frontend/src/components/common/empty-state.tsx
  </files>
  <action>
1. Create empty-state.tsx (HubSpot-style):
   ```typescript
   interface EmptyStateProps {
     icon: LucideIcon;
     title: string;
     description: string;
     actionLabel?: string;
     onAction?: () => void;
   }
   ```
   - Centered layout with vertical stack
   - Icon: h-12 w-12, text-muted-foreground/50
   - Title: text-sm font-medium
   - Description: text-sm text-muted-foreground, max-w-sm
   - Optional action button (Button size="sm")
   - Padding: py-12

2. Export from components/common/index.ts (create if needed)
  </action>
  <verify>
- `grep "EmptyStateProps" apps/frontend/src/components/common/empty-state.tsx` shows interface
- Component can be imported and renders correctly
  </verify>
  <done>
- EmptyState component renders centered icon, title, description, optional action
- Matches HubSpot-style simple empty states per CONTEXT.md
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Messages Tab with Real Data</name>
  <files>
    apps/frontend/src/components/cases/messages-tab.tsx
    apps/frontend/src/components/cases/case-tabs.tsx
  </files>
  <action>
1. Create messages-tab.tsx as separate component:
   - Props: caseId, reporterAnonymous (from caseData)
   - Use useCaseMessages(caseId) hook
   - Loading state: Skeleton loaders for messages
   - Empty state: EmptyState with MessageSquare icon, "No messages yet", "Start a conversation with the reporter"
   - Message list:
     - Chronological order (oldest first for chat-like experience)
     - Inbound messages: left-aligned, gray background
     - Outbound messages: right-aligned, blue background
     - Each message shows: content, timestamp, read status
   - Send message form at bottom:
     - Textarea for content
     - Optional subject field
     - Send button (disabled when empty or sending)
     - useSendMessage mutation
   - If reporterAnonymous: show Badge "Anonymous reporter"

2. Update case-tabs.tsx:
   - Import new MessagesTab component
   - Replace placeholder MessagesTab function with real component
   - Pass caseId and reporterAnonymous to MessagesTab
   - Update counts.messages from API (or pass through from parent)
  </action>
  <verify>
- Navigate to case detail, click Messages tab
- If messages exist, they display in chronological order
- If no messages, empty state shown
- Send message works (test with send mutation)
  </verify>
  <done>
- Messages tab fetches and displays real messages
- Message thread shows direction (inbound/outbound)
- Send message form works with PII awareness
- Empty state shown when no messages
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement Files Tab with Grid View</name>
  <files>
    apps/frontend/src/hooks/use-case-files.ts
    apps/frontend/src/components/cases/files-tab.tsx
    apps/frontend/src/components/cases/case-tabs.tsx
  </files>
  <action>
1. Create use-case-files.ts hook:
   - useCaseFiles(caseId): useQuery calling attachmentsApi.getForEntity('CASE', caseId)
   - Enabled only when caseId provided

2. Create files-tab.tsx:
   - Props: caseId
   - Use useCaseFiles(caseId) hook
   - Loading state: Grid of Skeleton cards
   - Empty state: EmptyState with Paperclip icon, "No files attached", "Upload documents and evidence", action button "Upload File"
   - Grid view (default):
     - 3 columns on desktop, 2 on tablet, 1 on mobile
     - Each file card: thumbnail (or icon for non-images), filename, size, upload date
     - Click to preview/download
     - Hover to show delete button (if user has permission)
   - View toggle: Grid/List (optional, start with grid only)
   - Upload button in top right
   - Use existing FileUpload component for upload dialog

3. Update case-tabs.tsx:
   - Import new FilesTab component
   - Replace placeholder FilesTab function with real component
   - Pass caseId to FilesTab
  </action>
  <verify>
- Navigate to case detail, click Files tab
- If files exist, they display in grid
- If no files, empty state shown with upload button
- Upload button triggers file upload
  </verify>
  <done>
- Files tab fetches and displays real attachments
- Grid view with thumbnails for images, icons for other files
- Upload functionality via existing FileUpload component
- Empty state with action button
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to a case detail page
2. Click Messages tab:
   - See messages if any exist
   - See empty state if no messages
   - Try sending a message (may get error if backend not running - that's OK)
3. Click Files tab:
   - See files if any attached
   - See empty state if no files
   - Upload button visible
4. Run: `cd apps/frontend && npm run lint`
5. Run: `cd apps/frontend && npx tsc --noEmit`
</verification>

<success_criteria>
- Messages tab displays real messages from API
- Messages show direction styling (inbound/outbound)
- Send message form present and functional
- Files tab displays real attachments in grid
- File cards show thumbnails/icons, names, sizes
- Empty states render for both tabs when no data
- No TypeScript or ESLint errors
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-frontend-navigation-and-ui-fixes/11.1-03-SUMMARY.md`
</output>
