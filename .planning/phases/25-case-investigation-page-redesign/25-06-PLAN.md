---
phase: 25-case-investigation-page-redesign
plan: 06
type: execute
wave: 5
depends_on: ["25-04", "25-05"]
files_modified:
  - apps/frontend/src/components/investigations/parent-case-card.tsx
  - apps/frontend/src/components/investigations/investigation-evidence-card.tsx
  - apps/frontend/src/components/cases/connected-people-card.tsx
  - apps/frontend/src/app/(authenticated)/investigations/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Investigation right sidebar has Connected People card"
    - "Investigation right sidebar has Parent Case card with case link"
    - "Investigation right sidebar has Evidence card with file count"
    - "Investigation right sidebar has AI Assistant button"
  artifacts:
    - path: "apps/frontend/src/components/investigations/parent-case-card.tsx"
      provides: "Parent case association card"
      exports: ["ParentCaseCard"]
      min_lines: 50
    - path: "apps/frontend/src/components/investigations/investigation-evidence-card.tsx"
      provides: "Evidence files association card"
      exports: ["InvestigationEvidenceCard"]
      min_lines: 60
  key_links:
    - from: "apps/frontend/src/app/(authenticated)/investigations/[id]/page.tsx"
      to: "apps/frontend/src/components/investigations/parent-case-card.tsx"
      via: "import"
      pattern: "import.*ParentCaseCard"
---

<objective>
Complete the investigation detail page by adding the right sidebar with association cards (Connected People, Parent Case, Evidence) and AI Assistant button, adapting the ConnectedPeopleCard to work with investigations.

Purpose: The right sidebar answers "who/what is connected?" - investigators need quick access to people involved, the parent case, evidence files, and AI assistance.
Output: Complete investigation three-column layout with functional right sidebar.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/CASE-INVESTIGATION-PAGE-REDESIGN.md

# Key source files

@apps/frontend/src/app/(authenticated)/investigations/[id]/page.tsx
@apps/frontend/src/components/ui/association-card.tsx
@apps/frontend/src/components/cases/connected-people-card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParentCaseCard component</name>
  <files>apps/frontend/src/components/investigations/parent-case-card.tsx</files>
  <action>
Create a card showing the parent case that the investigation belongs to:

```typescript
"use client";

import { FileText, ExternalLink } from "lucide-react";
import { AssociationCard } from "@/components/ui/association-card";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";

interface ParentCase {
  id: string;
  referenceNumber: string;
  status: string;
  severity: string;
  summary: string | null;
  categoryName: string | null;
  createdAt: string;
}

interface ParentCaseCardProps {
  caseData: ParentCase | null | undefined;
}

const STATUS_COLORS: Record<string, string> = {
  NEW: "bg-blue-100 text-blue-800",
  OPEN: "bg-yellow-100 text-yellow-800",
  CLOSED: "bg-gray-100 text-gray-800",
};

const SEVERITY_COLORS: Record<string, string> = {
  LOW: "bg-green-100 text-green-800",
  MEDIUM: "bg-yellow-100 text-yellow-800",
  HIGH: "bg-orange-100 text-orange-800",
};

export function ParentCaseCard({ caseData }: ParentCaseCardProps) {
  if (!caseData) {
    return (
      <AssociationCard
        title="Parent Case"
        count={0}
        icon={FileText}
        collapsible={false}
      >
        <p className="text-sm text-gray-500 py-2">No parent case linked</p>
      </AssociationCard>
    );
  }

  return (
    <AssociationCard
      title="Parent Case"
      count={1}
      icon={FileText}
      viewAllHref={`/cases/${caseData.id}`}
      viewAllLabel="View case"
      collapsible={false}
    >
      <Link
        href={`/cases/${caseData.id}`}
        className="block p-3 rounded-lg border hover:bg-gray-50 transition-colors"
      >
        {/* Reference number and status */}
        <div className="flex items-center justify-between mb-2">
          <div className="flex items-center gap-2">
            <FileText className="h-4 w-4 text-gray-400" />
            <span className="font-medium text-gray-900">
              {caseData.referenceNumber}
            </span>
          </div>
          <Badge className={STATUS_COLORS[caseData.status] || "bg-gray-100"}>
            {caseData.status}
          </Badge>
        </div>

        {/* Category */}
        {caseData.categoryName && (
          <p className="text-sm text-gray-600 mb-2">{caseData.categoryName}</p>
        )}

        {/* Summary */}
        {caseData.summary && (
          <p className="text-sm text-gray-500 line-clamp-2 mb-2">
            {caseData.summary}
          </p>
        )}

        {/* Severity and date */}
        <div className="flex items-center justify-between text-xs text-gray-500">
          <div className="flex items-center gap-2">
            <span>Severity:</span>
            <Badge
              variant="outline"
              className={`text-xs ${SEVERITY_COLORS[caseData.severity] || ""}`}
            >
              {caseData.severity}
            </Badge>
          </div>
          <span>
            Created: {new Date(caseData.createdAt).toLocaleDateString()}
          </span>
        </div>

        {/* View link indicator */}
        <div className="flex items-center justify-end mt-2 text-blue-600">
          <span className="text-xs mr-1">View case</span>
          <ExternalLink className="h-3 w-3" />
        </div>
      </Link>
    </AssociationCard>
  );
}
```

  </action>
  <verify>
    - ParentCaseCard displays parent case reference number, status, severity
    - Card shows category name and summary excerpt
    - Clicking card navigates to case detail page
    - "View case" link in footer
    - Handles null/undefined caseData gracefully
  </verify>
  <done>ParentCaseCard component created</done>
</task>

<task type="auto">
  <name>Task 2: Create InvestigationEvidenceCard component</name>
  <files>apps/frontend/src/components/investigations/investigation-evidence-card.tsx</files>
  <action>
Create a quick-glance evidence card for the right sidebar:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import { File, FileText, FileImage, Plus } from "lucide-react";
import { AssociationCard } from "@/components/ui/association-card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { apiClient } from "@/lib/api";

interface EvidenceFile {
  id: string;
  filename: string;
  originalFilename: string;
  mimeType: string;
  fileType: "EVIDENCE" | "SUPPORTING_DOCUMENT" | "TRANSCRIPT" | "PHOTO" | "OTHER";
  createdAt: string;
}

interface InvestigationEvidenceCardProps {
  investigationId: string;
  onAddEvidence?: () => void;
  onViewAll?: () => void;
}

const FILE_TYPE_COLORS: Record<string, string> = {
  EVIDENCE: "bg-red-100 text-red-800",
  SUPPORTING_DOCUMENT: "bg-blue-100 text-blue-800",
  TRANSCRIPT: "bg-purple-100 text-purple-800",
  PHOTO: "bg-green-100 text-green-800",
  OTHER: "bg-gray-100 text-gray-800",
};

function getFileIcon(mimeType: string) {
  if (mimeType.startsWith("image/")) return FileImage;
  if (mimeType.includes("pdf")) return FileText;
  return File;
}

export function InvestigationEvidenceCard({
  investigationId,
  onAddEvidence,
  onViewAll,
}: InvestigationEvidenceCardProps) {
  const [files, setFiles] = useState<EvidenceFile[]>([]);
  const [loading, setLoading] = useState(true);
  const [totalCount, setTotalCount] = useState(0);

  const fetchFiles = useCallback(async () => {
    setLoading(true);
    try {
      const response = await apiClient.get<EvidenceFile[]>(
        `/investigations/${investigationId}/files?limit=3`
      );
      setFiles(response || []);
      // If we got files, assume there might be more
      setTotalCount(response?.length || 0);
    } catch (err) {
      console.error("Failed to fetch evidence:", err);
      setFiles([]);
      setTotalCount(0);
    } finally {
      setLoading(false);
    }
  }, [investigationId]);

  useEffect(() => {
    fetchFiles();
  }, [fetchFiles]);

  if (loading) {
    return (
      <AssociationCard
        title="Evidence"
        count={0}
        icon={File}
        collapsible={false}
      >
        <div className="space-y-2">
          <Skeleton className="h-10 w-full" />
          <Skeleton className="h-10 w-full" />
        </div>
      </AssociationCard>
    );
  }

  return (
    <AssociationCard
      title="Evidence"
      count={totalCount}
      icon={File}
      onAdd={onAddEvidence}
      onSettings={() => {}}
      viewAllHref="#files"
      viewAllLabel="View all files"
    >
      {files.length === 0 ? (
        <p className="text-sm text-gray-500 py-2">No evidence uploaded</p>
      ) : (
        <div className="space-y-2">
          {files.map((file) => {
            const Icon = getFileIcon(file.mimeType);
            return (
              <div
                key={file.id}
                className="flex items-start gap-2 p-2 rounded border hover:bg-gray-50"
              >
                <Icon className="h-4 w-4 text-gray-400 mt-0.5" />
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-gray-900 truncate">
                    {file.originalFilename}
                  </p>
                  <div className="flex items-center gap-2 mt-1">
                    <Badge
                      className={`text-xs ${FILE_TYPE_COLORS[file.fileType]}`}
                    >
                      {file.fileType.replace("_", " ")}
                    </Badge>
                    <span className="text-xs text-gray-400">
                      {new Date(file.createdAt).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              </div>
            );
          })}
        </div>
      )}
    </AssociationCard>
  );
}
```

  </action>
  <verify>
    - InvestigationEvidenceCard fetches files from API
    - Card shows up to 3 files with type badges
    - Files show appropriate icons based on mime type
    - "+ Add" button triggers onAddEvidence
    - "View all files" link navigates to Files tab
    - Empty state shows "No evidence uploaded"
  </verify>
  <done>InvestigationEvidenceCard component created</done>
</task>

<task type="auto">
  <name>Task 3: Adapt ConnectedPeopleCard and wire right sidebar</name>
  <files>
    apps/frontend/src/components/cases/connected-people-card.tsx
    apps/frontend/src/app/(authenticated)/investigations/[id]/page.tsx
  </files>
  <action>
1. Modify ConnectedPeopleCard to accept either caseId OR investigationId:

At the top of connected-people-card.tsx, update the interface:

```typescript
interface ConnectedPeopleCardProps {
  caseId?: string;
  investigationId?: string;
  organizationId?: string;
}
```

In the fetch function, handle both cases:

```typescript
const fetchPeople = useCallback(async () => {
  setLoading(true);
  setError(null);

  try {
    let response: PersonCaseAssociation[];

    if (caseId) {
      response = await apiClient.get<PersonCaseAssociation[]>(
        `/cases/${caseId}/persons`,
      );
    } else if (investigationId) {
      // For investigations, fetch people from the parent case
      // or from a dedicated investigation-persons endpoint
      try {
        response = await apiClient.get<PersonCaseAssociation[]>(
          `/investigations/${investigationId}/persons`,
        );
      } catch {
        // Fallback: try to get from case if investigation endpoint doesn't exist
        response = [];
      }
    } else {
      response = [];
    }

    setPeople(response || []);
  } catch (err) {
    console.error("Failed to fetch people:", err);
    setError("Failed to load connected people");
    setPeople([]);
  } finally {
    setLoading(false);
  }
}, [caseId, investigationId]);
```

Update the useEffect dependency array to include investigationId:

```typescript
useEffect(() => {
  fetchPeople();
}, [fetchPeople]);
```

2. In the investigation page.tsx, wire up the right sidebar by replacing the placeholder:

```tsx
{
  /* Right Column - Associations */
}
<div className="space-y-4">
  <ConnectedPeopleCard
    investigationId={investigation.id}
    organizationId={investigation.organizationId}
  />
  <ParentCaseCard caseData={investigation.case} />
  <InvestigationEvidenceCard
    investigationId={investigation.id}
    onAddEvidence={() => setEvidenceModalOpen(true)}
  />

  {/* AI Assistant Button */}
  <Button
    variant="outline"
    className="w-full justify-start gap-2"
    onClick={() => setAiPanelOpen(true)}
  >
    <Sparkles className="h-4 w-4" />
    Ask AI Assistant
  </Button>
</div>;
```

3. Import all the new components at the top of the page:

```typescript
import { ParentCaseCard } from "@/components/investigations/parent-case-card";
import { InvestigationEvidenceCard } from "@/components/investigations/investigation-evidence-card";
import { ConnectedPeopleCard } from "@/components/cases/connected-people-card";
import { Sparkles } from "lucide-react";
```

4. Add AI panel state and component (reuse AiChatPanel from cases):

```typescript
const [aiPanelOpen, setAiPanelOpen] = useState(false);
```

Add the AI panel sheet at the end of the component:

```tsx
<AiChatPanel
  open={aiPanelOpen}
  onOpenChange={setAiPanelOpen}
  entityType="investigation"
  entityId={investigation.id}
/>
```

Import AiChatPanel:

```typescript
import { AiChatPanel } from "@/components/cases/ai-chat-panel";
```

5. Ensure the Investigation type includes the case relation with the fields ParentCaseCard needs:

```typescript
// In types/investigation.ts, ensure case includes:
case?: {
  id: string;
  referenceNumber: string;
  status: string;
  severity: string;
  summary: string | null;
  categoryName: string | null;
  createdAt: string;
};
```

  </action>
  <verify>
    - ConnectedPeopleCard works with investigationId prop
    - Right sidebar shows cards in order: People, Parent Case, Evidence, AI button
    - ParentCaseCard displays parent case info and links to case
    - InvestigationEvidenceCard shows evidence files
    - AI Assistant button opens AiChatPanel
    - All cards use consistent AssociationCard styling
  </verify>
  <done>Right sidebar complete with all association cards and AI button</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Case & Investigation Page Redesign following HubSpot three-column pattern:

**Case Detail Page:**

- Activities tab is default (not Overview)
- Activity timeline has search, upcoming section, date grouping, user filters
- Quick actions use horizontal icon+label grid with Call action
- Properties panel has chevron toggles and gear icons
- Right sidebar has 5 association cards (People, RIUs, Cases, Policies, Documents)

**Investigation Detail Page:**

- Three-column layout matching case detail
- Header with breadcrumb, badges, pipeline progress
- Left sidebar with summary card, quick actions, properties panel
- Center column with Activities as default tab
- Real Interviews and Files tabs (not placeholders)
- Right sidebar with People, Parent Case, Evidence cards
- AI Assistant integration
  </what-built>
  <how-to-verify>
  **Case Detail Page:**

1. Navigate to any case detail page (e.g., /cases/{id})
2. Verify Activities tab is selected by default
3. Verify activity timeline shows search bar at top
4. Verify quick actions are horizontal icon grid (Note, Email, Call, Interview, Document, Task)
5. Click Call - should open LogCallModal
6. Verify right sidebar shows 5 cards with count badges and gear icons

**Investigation Detail Page:**

1. Navigate to any investigation detail page (e.g., /investigations/{id})
2. Verify three-column layout renders
3. Verify breadcrumb: Cases > {caseRef} > Investigation #N
4. Verify Activities tab is selected by default
5. Verify left sidebar has summary card, quick actions, properties panel
6. Click Interviews tab - should show real interview list (or empty state)
7. Click Files tab - should show real file list with grid/list toggle
8. Verify right sidebar has People, Parent Case, Evidence cards
9. Click "Ask AI Assistant" - should open AI panel

**Responsive:**

1. Resize browser to mobile width
2. Verify columns stack vertically
   </how-to-verify>
   <resume-signal>Type "approved" if all checks pass, or describe specific issues found</resume-signal>
   </task>

</tasks>

<verification>
1. Investigation right sidebar has Connected People card
2. Investigation right sidebar has Parent Case card with clickable link
3. Investigation right sidebar has Evidence card with file count and type badges
4. Investigation right sidebar has AI Assistant button
5. Cards are in order: People, Parent Case, Evidence, AI button
6. ConnectedPeopleCard works with both caseId and investigationId props
7. AI panel opens and is scoped to investigation context
8. All components render correctly on mobile
9. TypeScript compilation passes: `npm run typecheck`
</verification>

<success_criteria>

- Investigation detail page has complete three-column layout
- Right sidebar shows all association cards with consistent styling
- AI Assistant button opens investigation-scoped AI panel
- ConnectedPeopleCard adapter works for both case and investigation
- Human verification confirms both case and investigation pages work correctly
- All 10 success criteria from the spec are met
  </success_criteria>

<output>
After completion, create `.planning/phases/25-case-investigation-page-redesign/25-06-SUMMARY.md`
</output>
