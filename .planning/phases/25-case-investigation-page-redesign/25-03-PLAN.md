---
phase: 25-case-investigation-page-redesign
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - apps/frontend/src/components/ui/association-card.tsx
  - apps/frontend/src/components/cases/connected-people-card.tsx
  - apps/frontend/src/components/cases/connected-documents-card.tsx
  - apps/frontend/src/components/cases/related-cases-card.tsx
  - apps/frontend/src/components/cases/related-policies-card.tsx
  - apps/frontend/src/components/cases/linked-rius-card.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Association cards have count badges in headers"
    - "Association cards have gear icons for future customization"
    - "Association cards have 'View all associated X' links at bottom"
    - "Right sidebar shows cards in order: People, RIUs, Related Cases, Related Policies, Documents"
  artifacts:
    - path: "apps/frontend/src/components/ui/association-card.tsx"
      provides: "Reusable association card wrapper component"
      exports: ["AssociationCard"]
      min_lines: 50
    - path: "apps/frontend/src/components/cases/related-cases-card.tsx"
      provides: "Related cases association card"
      exports: ["RelatedCasesCard"]
    - path: "apps/frontend/src/components/cases/related-policies-card.tsx"
      provides: "Related policies association card"
      exports: ["RelatedPoliciesCard"]
    - path: "apps/frontend/src/components/cases/linked-rius-card.tsx"
      provides: "Linked RIUs association card"
      exports: ["LinkedRiusCard"]
  key_links:
    - from: "apps/frontend/src/components/cases/connected-people-card.tsx"
      to: "apps/frontend/src/components/ui/association-card.tsx"
      via: "import"
      pattern: "import.*AssociationCard"
---

<objective>
Create reusable AssociationCard wrapper component and new association cards (Related Cases, Related Policies, Linked RIUs), refactor existing cards (ConnectedPeople, ConnectedDocuments) to use the wrapper, and add all cards to the case detail right sidebar.

Purpose: HubSpot's right sidebar shows all associated records with consistent formatting - count badges, add buttons, gear icons, and "View all" links. This pattern enables quick access to related data.
Output: AssociationCard component, 3 new cards, 2 refactored cards, complete right sidebar.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/CASE-INVESTIGATION-PAGE-REDESIGN.md

# Key source files

@apps/frontend/src/components/cases/connected-people-card.tsx
@apps/frontend/src/components/cases/connected-documents-card.tsx
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssociationCard wrapper component</name>
  <files>apps/frontend/src/components/ui/association-card.tsx</files>
  <action>
Create a reusable wrapper component that all right-sidebar association cards will use:

```typescript
"use client";

import { useState, ReactNode } from "react";
import { LucideIcon, Plus, Settings2, ChevronRight, Search } from "lucide-react";
import { Card, CardContent, CardFooter, CardHeader } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Input } from "@/components/ui/input";
import { cn } from "@/lib/utils";
import Link from "next/link";

export interface AssociationCardProps {
  /** Title for the card header (e.g., "Connected People") */
  title: string;
  /** Count of associated items */
  count: number;
  /** Icon to display in header */
  icon: LucideIcon;
  /** Handler for + Add button (omit to hide button) */
  onAdd?: () => void;
  /** Handler for gear icon (omit to hide icon) */
  onSettings?: () => void;
  /** URL for "View all associated X" link */
  viewAllHref?: string;
  /** Label for "View all" link (e.g., "View all associated People") */
  viewAllLabel?: string;
  /** Show search input when count exceeds this threshold */
  searchThreshold?: number;
  /** Placeholder for search input */
  searchPlaceholder?: string;
  /** Current search query (controlled) */
  searchQuery?: string;
  /** Handler for search query changes */
  onSearchChange?: (query: string) => void;
  /** Card content */
  children: ReactNode;
  /** Additional class names */
  className?: string;
  /** If true, card is collapsible (default true) */
  collapsible?: boolean;
  /** Initial collapsed state (default false) */
  defaultCollapsed?: boolean;
}

/**
 * HubSpot-style association card wrapper for right sidebar.
 *
 * Provides consistent header with:
 * - Icon + Title + Count badge
 * - + Add button (optional)
 * - Gear settings icon (optional)
 * - Search input for large lists
 * - "View all" link footer
 * - Collapsible content
 */
export function AssociationCard({
  title,
  count,
  icon: Icon,
  onAdd,
  onSettings,
  viewAllHref,
  viewAllLabel,
  searchThreshold = 5,
  searchPlaceholder = "Search...",
  searchQuery,
  onSearchChange,
  children,
  className,
  collapsible = true,
  defaultCollapsed = false,
}: AssociationCardProps) {
  const [collapsed, setCollapsed] = useState(defaultCollapsed);
  const showSearch = count > searchThreshold && onSearchChange;

  return (
    <Card className={cn("shadow-sm", className)}>
      <CardHeader className="py-3 px-4">
        <div className="flex items-center justify-between">
          {/* Left: Icon + Title + Count */}
          <button
            onClick={() => collapsible && setCollapsed(!collapsed)}
            className={cn(
              "flex items-center gap-2",
              collapsible && "cursor-pointer hover:opacity-80"
            )}
            disabled={!collapsible}
          >
            {collapsible && (
              <ChevronRight
                className={cn(
                  "h-4 w-4 text-gray-500 transition-transform duration-200",
                  !collapsed && "rotate-90"
                )}
              />
            )}
            <Icon className="h-4 w-4 text-gray-600" />
            <span className="text-sm font-semibold text-gray-900">{title}</span>
            <Badge variant="secondary" className="h-5 px-1.5 text-xs">
              {count}
            </Badge>
          </button>

          {/* Right: Add + Settings */}
          <div className="flex items-center gap-1">
            {onAdd && (
              <Button
                variant="ghost"
                size="sm"
                className="h-7 w-7 p-0"
                onClick={onAdd}
              >
                <Plus className="h-4 w-4" />
                <span className="sr-only">Add</span>
              </Button>
            )}
            {onSettings && (
              <Button
                variant="ghost"
                size="sm"
                className="h-7 w-7 p-0"
                onClick={onSettings}
              >
                <Settings2 className="h-4 w-4 text-gray-400" />
                <span className="sr-only">Settings</span>
              </Button>
            )}
          </div>
        </div>

        {/* Search input */}
        {showSearch && !collapsed && (
          <div className="mt-2 relative">
            <Search className="absolute left-2 top-1/2 -translate-y-1/2 h-3 w-3 text-gray-400" />
            <Input
              placeholder={searchPlaceholder}
              value={searchQuery}
              onChange={(e) => onSearchChange?.(e.target.value)}
              className="h-8 pl-7 text-sm"
            />
          </div>
        )}
      </CardHeader>

      {!collapsed && (
        <>
          <CardContent className="py-2 px-4">{children}</CardContent>

          {viewAllHref && viewAllLabel && (
            <CardFooter className="py-2 px-4 border-t">
              <Link
                href={viewAllHref}
                className="text-sm text-blue-600 hover:text-blue-800 hover:underline flex items-center gap-1"
              >
                {viewAllLabel}
                <ChevronRight className="h-3 w-3" />
              </Link>
            </CardFooter>
          )}
        </>
      )}
    </Card>
  );
}
```

  </action>
  <verify>
    - File exists at apps/frontend/src/components/ui/association-card.tsx
    - Component exports AssociationCard
    - Has header with icon, title, count badge, add button, gear icon
    - Has optional search input
    - Has collapsible content with chevron toggle
    - Has "View all" link in footer
  </verify>
  <done>AssociationCard wrapper component created with all HubSpot-style features</done>
</task>

<task type="auto">
  <name>Task 2: Create new association cards (Related Cases, Policies, RIUs)</name>
  <files>
    apps/frontend/src/components/cases/related-cases-card.tsx
    apps/frontend/src/components/cases/related-policies-card.tsx
    apps/frontend/src/components/cases/linked-rius-card.tsx
  </files>
  <action>
1. Create RelatedCasesCard:

```typescript
"use client";

import { useState, useEffect } from "react";
import { FileText, Link2 } from "lucide-react";
import { AssociationCard } from "@/components/ui/association-card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { apiClient } from "@/lib/api";
import Link from "next/link";

interface RelatedCase {
  id: string;
  caseId: string;
  relatedCaseId: string;
  relationshipType: "RELATED" | "MERGED_FROM" | "DUPLICATE" | "PARENT" | "CHILD";
  relatedCase: {
    id: string;
    referenceNumber: string;
    status: string;
    summary: string | null;
  };
}

interface RelatedCasesCardProps {
  caseId: string;
}

const STATUS_COLORS: Record<string, string> = {
  NEW: "bg-blue-100 text-blue-800",
  OPEN: "bg-yellow-100 text-yellow-800",
  CLOSED: "bg-gray-100 text-gray-800",
};

export function RelatedCasesCard({ caseId }: RelatedCasesCardProps) {
  const [relatedCases, setRelatedCases] = useState<RelatedCase[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchRelatedCases = async () => {
      try {
        // Try to fetch related cases (endpoint may not exist yet)
        const response = await apiClient.get<RelatedCase[]>(`/cases/${caseId}/related-cases`);
        setRelatedCases(response || []);
      } catch (error) {
        console.error("Failed to fetch related cases:", error);
        setRelatedCases([]);
      } finally {
        setLoading(false);
      }
    };
    fetchRelatedCases();
  }, [caseId]);

  if (loading) {
    return (
      <AssociationCard
        title="Related Cases"
        count={0}
        icon={Link2}
        collapsible={false}
      >
        <Skeleton className="h-16 w-full" />
      </AssociationCard>
    );
  }

  return (
    <AssociationCard
      title="Related Cases"
      count={relatedCases.length}
      icon={Link2}
      onAdd={() => {/* TODO: Open link case modal */}}
      onSettings={() => {}}
      viewAllHref={`/cases?relatedTo=${caseId}`}
      viewAllLabel="View all associated Cases"
    >
      {relatedCases.length === 0 ? (
        <p className="text-sm text-gray-500 py-2">No related cases</p>
      ) : (
        <div className="space-y-2">
          {relatedCases.slice(0, 5).map((rc) => (
            <Link
              key={rc.id}
              href={`/cases/${rc.relatedCase.id}`}
              className="block p-2 rounded-md hover:bg-gray-50 border"
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <FileText className="h-4 w-4 text-gray-400" />
                  <span className="text-sm font-medium">
                    {rc.relatedCase.referenceNumber}
                  </span>
                </div>
                <Badge className={STATUS_COLORS[rc.relatedCase.status] || "bg-gray-100"}>
                  {rc.relatedCase.status}
                </Badge>
              </div>
              {rc.relatedCase.summary && (
                <p className="text-xs text-gray-500 mt-1 line-clamp-1">
                  {rc.relatedCase.summary}
                </p>
              )}
              <p className="text-xs text-gray-400 mt-1">
                Association: {rc.relationshipType.replace("_", " ")}
              </p>
            </Link>
          ))}
        </div>
      )}
    </AssociationCard>
  );
}
```

2. Create RelatedPoliciesCard:

```typescript
"use client";

import { useState, useEffect } from "react";
import { FileText, BookOpen } from "lucide-react";
import { AssociationCard } from "@/components/ui/association-card";
import { Badge } from "@/components/ui/badge";
import { Skeleton } from "@/components/ui/skeleton";
import { apiClient } from "@/lib/api";
import Link from "next/link";

interface PolicyCaseLink {
  id: string;
  policyId: string;
  caseId: string;
  linkType: "VIOLATION" | "REFERENCE" | "GOVERNING";
  policy: {
    id: string;
    title: string;
    version: string;
    status: string;
    department: string | null;
  };
}

interface RelatedPoliciesCardProps {
  caseId: string;
}

export function RelatedPoliciesCard({ caseId }: RelatedPoliciesCardProps) {
  const [policies, setPolicies] = useState<PolicyCaseLink[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchPolicies = async () => {
      try {
        const response = await apiClient.get<PolicyCaseLink[]>(`/cases/${caseId}/policies`);
        setPolicies(response || []);
      } catch (error) {
        console.error("Failed to fetch related policies:", error);
        setPolicies([]);
      } finally {
        setLoading(false);
      }
    };
    fetchPolicies();
  }, [caseId]);

  if (loading) {
    return (
      <AssociationCard
        title="Related Policies"
        count={0}
        icon={BookOpen}
        collapsible={false}
      >
        <Skeleton className="h-16 w-full" />
      </AssociationCard>
    );
  }

  return (
    <AssociationCard
      title="Related Policies"
      count={policies.length}
      icon={BookOpen}
      onAdd={() => {/* TODO: Open link policy modal */}}
      onSettings={() => {}}
      viewAllHref={`/policies?caseId=${caseId}`}
      viewAllLabel="View all associated Policies"
    >
      {policies.length === 0 ? (
        <p className="text-sm text-gray-500 py-2">No related policies</p>
      ) : (
        <div className="space-y-2">
          {policies.slice(0, 5).map((pl) => (
            <Link
              key={pl.id}
              href={`/policies/${pl.policy.id}`}
              className="block p-2 rounded-md hover:bg-gray-50 border"
            >
              <div className="flex items-start gap-2">
                <FileText className="h-4 w-4 text-gray-400 mt-0.5" />
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium text-gray-900 truncate">
                    {pl.policy.title}
                  </p>
                  <p className="text-xs text-gray-500">
                    v{pl.policy.version} · {pl.policy.status} · {pl.policy.department || "General"}
                  </p>
                  <Badge variant="outline" className="mt-1 text-xs">
                    {pl.linkType}
                  </Badge>
                </div>
              </div>
            </Link>
          ))}
        </div>
      )}
    </AssociationCard>
  );
}
```

3. Create LinkedRiusCard:

```typescript
"use client";

import { Phone, FileInput, Star } from "lucide-react";
import { AssociationCard } from "@/components/ui/association-card";
import { Badge } from "@/components/ui/badge";
import Link from "next/link";
import type { RiuAssociation } from "@/types/case";

interface LinkedRiusCardProps {
  riuAssociations: RiuAssociation[];
}

const RIU_TYPE_ICONS: Record<string, typeof Phone> = {
  HOTLINE_REPORT: Phone,
  WEB_FORM_SUBMISSION: FileInput,
};

const RIU_TYPE_LABELS: Record<string, string> = {
  HOTLINE_REPORT: "Hotline Report",
  WEB_FORM_SUBMISSION: "Web Form",
  DISCLOSURE_RESPONSE: "Disclosure",
  ATTESTATION_RESPONSE: "Attestation",
};

export function LinkedRiusCard({ riuAssociations }: LinkedRiusCardProps) {
  return (
    <AssociationCard
      title="Intake Records"
      count={riuAssociations.length}
      icon={FileInput}
      onAdd={() => {/* TODO: Link RIU modal */}}
      onSettings={() => {}}
      viewAllHref="#" // RIUs are shown inline, no separate page
      viewAllLabel="View all associated Records"
    >
      {riuAssociations.length === 0 ? (
        <p className="text-sm text-gray-500 py-2">No intake records linked</p>
      ) : (
        <div className="space-y-2">
          {riuAssociations.map((assoc) => {
            const Icon = RIU_TYPE_ICONS[assoc.riu.type] || FileInput;
            const isPrimary = assoc.associationType === "PRIMARY";

            return (
              <Link
                key={assoc.id}
                href={`/rius/${assoc.riuId}`}
                className={`block p-2 rounded-md hover:bg-gray-50 border ${
                  isPrimary ? "border-blue-200 bg-blue-50/50" : ""
                }`}
              >
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Icon className="h-4 w-4 text-gray-400" />
                    <span className="text-sm font-medium">
                      {assoc.riu.referenceNumber}
                    </span>
                    {isPrimary && (
                      <Star className="h-3 w-3 text-blue-500 fill-blue-500" />
                    )}
                  </div>
                  <Badge variant={isPrimary ? "default" : "secondary"} className="text-xs">
                    {assoc.associationType}
                  </Badge>
                </div>
                <p className="text-xs text-gray-500 mt-1">
                  {RIU_TYPE_LABELS[assoc.riu.type] || assoc.riu.type} ·{" "}
                  {new Date(assoc.riu.createdAt).toLocaleDateString()}
                </p>
                {assoc.riu.reporterAnonymous && (
                  <p className="text-xs text-gray-400 mt-0.5">
                    Reporter: Anonymous
                  </p>
                )}
              </Link>
            );
          })}
        </div>
      )}
    </AssociationCard>
  );
}
```

  </action>
  <verify>
    - RelatedCasesCard fetches and displays related cases with status badges
    - RelatedPoliciesCard fetches and displays linked policies with version/status
    - LinkedRiusCard displays RIU associations with PRIMARY highlighted (blue border, star icon)
    - All cards use AssociationCard wrapper
    - All cards have "View all" links
  </verify>
  <done>Three new association cards created using AssociationCard wrapper</done>
</task>

<task type="auto">
  <name>Task 3: Refactor existing cards and wire all cards to page</name>
  <files>
    apps/frontend/src/components/cases/connected-people-card.tsx
    apps/frontend/src/components/cases/connected-documents-card.tsx
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
1. Refactor ConnectedPeopleCard to use AssociationCard wrapper:

- Read the existing component
- Wrap the content in AssociationCard, passing:
  - title="Connected People"
  - count={total count of people}
  - icon={Users}
  - onAdd={handler for AddPersonModal}
  - onSettings={() => {}}
  - viewAllHref={`/cases/${caseId}/people`}
  - viewAllLabel="View all associated People"
  - searchThreshold={5}
  - searchQuery and onSearchChange for filtering (add state)

- Add search filtering to filter people by name
- Keep the existing person grouping by label (SUBJECT, REPORTER, etc.)
- Add email display with copy icon for non-anonymous people

2. Refactor ConnectedDocumentsCard similarly:

- Wrap in AssociationCard
- Pass appropriate props
- Add count badge, gear icon, view all link

3. In page.tsx, import all new cards and arrange in right column:

```tsx
{
  /* Right Column */
}
<div className="space-y-4">
  <ConnectedPeopleCard
    caseId={caseId}
    organizationId={caseData?.organizationId}
  />
  <LinkedRiusCard riuAssociations={caseData?.riuAssociations || []} />
  <RelatedCasesCard caseId={caseId} />
  <RelatedPoliciesCard caseId={caseId} />
  <ConnectedDocumentsCard caseId={caseId} />

  {/* AI Assistant Button */}
  <Button
    variant="outline"
    className="w-full justify-start gap-2"
    onClick={() => setAiPanelOpen(true)}
  >
    <Sparkles className="h-4 w-4" />
    Ask AI Assistant
  </Button>
</div>;
```

Import the new card components at the top of the file.
</action>
<verify> - ConnectedPeopleCard uses AssociationCard wrapper - ConnectedPeopleCard has search input for >5 people - ConnectedDocumentsCard uses AssociationCard wrapper - Right sidebar shows cards in order: People, RIUs, Related Cases, Related Policies, Documents - All cards have consistent header styling (icon, title, count, add, gear) - All cards have "View all" links - AI Assistant button at bottom of right sidebar
</verify>
<done>All association cards refactored/created and wired to case detail page</done>
</task>

</tasks>

<verification>
1. Right sidebar shows 5 association cards plus AI button
2. Card order: Connected People, Intake Records, Related Cases, Related Policies, Connected Documents, AI button
3. Each card has: icon, title, count badge, + Add button, gear icon
4. Each card has collapsible content with chevron toggle
5. Each card has "View all associated X" link at bottom
6. Connected People card has search for >5 people
7. Linked RIUs card highlights PRIMARY association with blue border and star
8. TypeScript compilation passes: `npm run typecheck`
</verification>

<success_criteria>

- AssociationCard component is reusable with all HubSpot-style features
- All 5 association cards use the wrapper consistently
- Right sidebar is properly ordered per spec
- Cards fetch data appropriately (graceful fallback if endpoints don't exist)
- Visual hierarchy is clear with count badges and icons
- "View all" links navigate to appropriate filtered views
  </success_criteria>

<output>
After completion, create `.planning/phases/25-case-investigation-page-redesign/25-03-SUMMARY.md`
</output>
