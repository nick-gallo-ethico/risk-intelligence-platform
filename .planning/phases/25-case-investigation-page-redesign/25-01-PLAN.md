---
phase: 25-case-investigation-page-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/components/cases/case-tabs.tsx
  - apps/frontend/src/components/cases/case-activity-timeline.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Activities tab is the default visible tab when opening a case"
    - "Activity timeline shows search bar at top for filtering by keyword"
    - "Activity timeline has Upcoming section pinned above history for tasks/SLA due"
    - "Activity timeline groups entries by date labels (Today, Yesterday, This Week, etc.)"
    - "User can filter activities by user or team"
  artifacts:
    - path: "apps/frontend/src/components/cases/case-tabs.tsx"
      provides: "Reordered tabs with Activities first"
      contains: 'defaultTab = "activity"'
    - path: "apps/frontend/src/components/cases/case-activity-timeline.tsx"
      provides: "Enhanced timeline with search, upcoming, date groups"
      contains: "Upcoming"
  key_links:
    - from: "apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx"
      to: "CaseTabs"
      via: "defaultTab prop"
      pattern: "defaultTab.*activity"
    - from: "apps/frontend/src/components/cases/case-activity-timeline.tsx"
      to: "/activity/CASE/"
      via: "API fetch"
      pattern: "apiClient.get.*activity"
---

<objective>
Reorder case tabs to make Activities the default view and enhance the activity timeline with HubSpot-style features: search bar, upcoming section (tasks/SLA pinned at top), date-grouped history with descriptive labels (Today, Yesterday, This Week), and user/team filters.

Purpose: HubSpot's Activities tab is default because investigators check "what happened recently" first. The enhanced timeline answers "what's coming up?" and "what happened?" at a glance.
Output: Modified CaseTabs with Activities first, enhanced CaseActivityTimeline with search/upcoming/filters.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docs/CASE-INVESTIGATION-PAGE-REDESIGN.md

# Key source files

@apps/frontend/src/components/cases/case-tabs.tsx
@apps/frontend/src/components/cases/case-activity-timeline.tsx
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reorder tabs and set Activities as default</name>
  <files>
    apps/frontend/src/components/cases/case-tabs.tsx
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
1. In case-tabs.tsx, reorder the TABS array to put "activity" first:
   ```typescript
   const TABS = [
     { id: "activity", label: "Activities", icon: Activity },
     { id: "overview", label: "Overview", icon: FileText },
     { id: "summary", label: "Summary", icon: ScrollText },
     { id: "investigations", label: "Investigations", icon: Search },
     { id: "messages", label: "Messages", icon: MessageSquare },
     { id: "files", label: "Files", icon: Paperclip },
     { id: "remediation", label: "Remediation", icon: ClipboardCheck },
   ] as const;
   ```

2. Change the default in CaseTabsProps:

   ```typescript
   defaultTab?: TabId;  // Keep type same
   ```

   And update the destructuring default:

   ```typescript
   defaultTab = "activity",  // Change from "overview"
   ```

3. In OverviewTab, REMOVE the "Recent Activity" section at the bottom (lines ~485-507). This is redundant since Activities is now default. Remove the entire section block including the Button that navigates to activity tab.

4. In page.tsx, if there's an explicit defaultTab="overview" prop being passed to CaseTabs, remove it or change to defaultTab="activity". If no prop is passed, the new default will apply automatically.
   </action>
   <verify> - Open a case detail page in browser - Activities tab should be selected by default (not Overview) - Tab order should be: Activities, Overview, Summary, Investigations, Messages, Files, Remediation - Overview tab should NOT have "Recent Activity" section at bottom
   </verify>
   <done>Activities is the default tab, tabs are reordered, redundant Recent Activity link removed from Overview</done>
   </task>

<task type="auto">
  <name>Task 2: Add search bar and upcoming section to activity timeline</name>
  <files>apps/frontend/src/components/cases/case-activity-timeline.tsx</files>
  <action>
1. Add search state at top of component:
   ```typescript
   const [searchQuery, setSearchQuery] = useState("");
   ```

2. Add upcoming items computation (tasks due, SLA deadlines). Create a useMemo that filters activities for future-dated items:

   ```typescript
   const upcomingItems = useMemo(() => {
     const now = new Date();
     return activities
       .filter((a) => {
         // Check if activity has a due date in the future
         // Task activities or SLA-related activities
         if (a.action === "task_created" || a.action === "task_assigned") {
           const dueDate = a.changes?.dueDate?.new || a.context?.dueDate;
           if (dueDate && new Date(dueDate as string) > now) return true;
         }
         if (a.action === "sla_warning" || a.action === "sla_updated") {
           const slaDate = a.context?.slaDueAt;
           if (slaDate && new Date(slaDate as string) > now) return true;
         }
         return false;
       })
       .sort((a, b) => {
         // Sort by due date ascending (soonest first)
         const dateA = a.context?.dueDate || a.context?.slaDueAt || a.createdAt;
         const dateB = b.context?.dueDate || b.context?.slaDueAt || b.createdAt;
         return (
           new Date(dateA as string).getTime() -
           new Date(dateB as string).getTime()
         );
       });
   }, [activities]);
   ```

3. Update filteredActivities to also filter by searchQuery:

   ```typescript
   const filteredActivities = useMemo(() => {
     let filtered = activities;

     // Filter by type
     if (activeFilter !== "all") {
       filtered = filtered.filter((activity) => {
         switch (activeFilter) {
           case "notes":
             return activity.action === "commented";
           case "status":
             return activity.action === "status_changed";
           case "files":
             return activity.action === "file_uploaded";
           default:
             return true;
         }
       });
     }

     // Filter by search query
     if (searchQuery.trim()) {
       const query = searchQuery.toLowerCase();
       filtered = filtered.filter(
         (a) =>
           a.actionDescription?.toLowerCase().includes(query) ||
           a.actorName?.toLowerCase().includes(query),
       );
     }

     return filtered;
   }, [activities, activeFilter, searchQuery]);
   ```

4. Add search bar UI at the top of the timeline (above filters):

   ```tsx
   <div className="p-4 border-b">
     <div className="relative">
       <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
       <Input
         placeholder="Search activities..."
         value={searchQuery}
         onChange={(e) => setSearchQuery(e.target.value)}
         className="pl-9"
       />
     </div>
   </div>
   ```

   Import Search from lucide-react and Input from @/components/ui/input.

5. Add Upcoming section above the date-grouped timeline (render only if upcomingItems.length > 0):
   ```tsx
   {
     upcomingItems.length > 0 && (
       <div className="border-b pb-4 mb-4">
         <h3 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3 flex items-center gap-2">
           <Clock className="h-4 w-4" />
           Upcoming
         </h3>
         <div className="space-y-2">
           {upcomingItems.map((item) => (
             <ActivityEntry
               key={`upcoming-${item.id}`}
               activity={item}
               showUpcomingStyle
             />
           ))}
         </div>
       </div>
     );
   }
   ```
   Import Clock from lucide-react. Add showUpcomingStyle prop to ActivityEntry (optional styling prop).
   </action>
   <verify> - Activity timeline shows search input at top - Typing in search filters activities by description or actor name - If there are tasks or SLA items with future due dates, they appear in "Upcoming" section - Upcoming section has clock icon and uppercase label
   </verify>
   <done>Search bar filters activities, Upcoming section shows future tasks/SLA items</done>
   </task>

<task type="auto">
  <name>Task 3: Enhance date grouping labels and add user/team filters</name>
  <files>
    apps/frontend/src/components/cases/case-activity-timeline.tsx
    apps/frontend/src/lib/date-utils.ts
  </files>
  <action>
1. In date-utils.ts, enhance or create the groupByDate function to return descriptive labels:
   ```typescript
   export function getDateGroupLabel(date: Date): string {
     const now = new Date();
     const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
     const yesterday = new Date(today);
     yesterday.setDate(yesterday.getDate() - 1);
     const thisWeekStart = new Date(today);
     thisWeekStart.setDate(thisWeekStart.getDate() - today.getDay());
     const lastWeekStart = new Date(thisWeekStart);
     lastWeekStart.setDate(lastWeekStart.getDate() - 7);

     const targetDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

     if (targetDate.getTime() === today.getTime()) return "Today";
     if (targetDate.getTime() === yesterday.getTime()) return "Yesterday";
     if (targetDate >= thisWeekStart) return "This Week";
     if (targetDate >= lastWeekStart) return "Last Week";

     // Otherwise return month/year
     return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

}

export function groupActivitiesByDate<T extends { createdAt: string }>(
items: T[]
): { label: string; items: T[] }[] {
const groups = new Map<string, T[]>();

     // Sort by date descending first
     const sorted = [...items].sort((a, b) =>
       new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
     );

     for (const item of sorted) {
       const label = getDateGroupLabel(new Date(item.createdAt));
       const existing = groups.get(label) || [];
       existing.push(item);
       groups.set(label, existing);
     }

     return Array.from(groups.entries()).map(([label, items]) => ({ label, items }));

}

````

2. In case-activity-timeline.tsx, add user filter state and dropdown:
```typescript
const [userFilter, setUserFilter] = useState<string>("all");

// Extract unique users from activities
const uniqueUsers = useMemo(() => {
  const users = new Map<string, string>();
  activities.forEach(a => {
    if (a.actorUserId && a.actorName) {
      users.set(a.actorUserId, a.actorName);
    }
  });
  return Array.from(users.entries()).map(([id, name]) => ({ id, name }));
}, [activities]);
````

3. Add user filter to the filter row (next to ActivityFilters):

   ```tsx
   <div className="flex items-center gap-2">
     <ActivityFilters ... />
     <Select value={userFilter} onValueChange={setUserFilter}>
       <SelectTrigger className="w-[160px]">
         <SelectValue placeholder="All users" />
       </SelectTrigger>
       <SelectContent>
         <SelectItem value="all">All users</SelectItem>
         {uniqueUsers.map(user => (
           <SelectItem key={user.id} value={user.id}>{user.name}</SelectItem>
         ))}
       </SelectContent>
     </Select>
   </div>
   ```

   Import Select, SelectTrigger, SelectValue, SelectContent, SelectItem from @/components/ui/select.

4. Include userFilter in filteredActivities:

   ```typescript
   // After type and search filtering
   if (userFilter !== "all") {
     filtered = filtered.filter((a) => a.actorUserId === userFilter);
   }
   ```

5. Add filter count indicator below the filter row:

   ```tsx
   <div className="text-xs text-gray-500 px-4 pb-2">
     Showing {filteredActivities.length} of {activities.length} activities
   </div>
   ```

6. Use groupActivitiesByDate in the render:

   ```typescript
   const groupedActivities = useMemo(
     () => groupActivitiesByDate(filteredActivities),
     [filteredActivities],
   );
   ```

   Then render:

   ```tsx
   {
     groupedActivities.map((group) => (
       <div key={group.label} className="mb-6">
         <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">
           {group.label}
         </h4>
         <div className="space-y-3">
           {group.items.map((activity) => (
             <ActivityEntry key={activity.id} activity={activity} />
           ))}
         </div>
       </div>
     ));
   }
   ```

     </action>
     <verify>
       - Date groups show descriptive labels: "Today", "Yesterday", "This Week", "Last Week", or "January 2026" etc.
       - User dropdown appears next to filter tabs
       - Selecting a user filters to only their activities
       - Filter count shows "Showing X of Y activities"
     </verify>
     <done>Date groups use descriptive labels, user filter dropdown works, filter count displayed</done>
   </task>

</tasks>

<verification>
1. Open any case detail page - Activities tab should be selected by default
2. Tab bar order: Activities, Overview, Summary, Investigations, Messages, Files, Remediation
3. Activity timeline shows search bar at top
4. Activity timeline shows "Upcoming" section if there are future-dated tasks/SLA
5. Activity timeline groups by descriptive date labels (Today, Yesterday, etc.)
6. User filter dropdown filters activities by actor
7. Filter count shows "Showing X of Y activities"
8. Overview tab does NOT have "Recent Activity" section
9. TypeScript compilation passes: `npm run typecheck`
</verification>

<success_criteria>

- Activities tab is the default (URL without ?tab= shows activity tab content)
- Search filters activities by description text in real-time
- Upcoming section visible when future tasks/SLA exist
- Date groups use human-readable labels instead of raw dates
- User filter dropdown functional
- Filter count indicator accurate
- All changes are responsive on mobile
  </success_criteria>

<output>
After completion, create `.planning/phases/25-case-investigation-page-redesign/25-01-SUMMARY.md`
</output>
