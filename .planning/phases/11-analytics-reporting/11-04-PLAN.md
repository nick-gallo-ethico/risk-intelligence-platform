---
phase: 11-analytics-reporting
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/analytics/migration/migration.module.ts
  - apps/backend/src/modules/analytics/migration/migration.service.ts
  - apps/backend/src/modules/analytics/migration/dto/migration.dto.ts
  - apps/backend/src/modules/analytics/migration/entities/migration.entity.ts
autonomous: true

must_haves:
  truths:
    - "Migration jobs can be created to import historical data"
    - "Field mappings can be configured and previewed before import"
    - "Rollback is available for 7 days after import"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "MigrationJob, MigrationFieldMapping models"
      contains: "model MigrationJob"
    - path: "apps/backend/src/modules/analytics/migration/migration.service.ts"
      provides: "Migration job management service"
      min_lines: 150
  key_links:
    - from: "migration.service.ts"
      to: "prisma.migrationJob"
      via: "job tracking"
      pattern: "prisma\\.migrationJob"
---

<objective>
Build the migration infrastructure for importing data from competitor systems.

Purpose: Enable one-time data migration from NAVEX, EQS, and CSV files (MIG-01, MIG-05, MIG-06, MIG-07).
Output: MigrationJob, MigrationFieldMapping models and MigrationService
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-analytics-reporting/11-CONTEXT.md
@.planning/phases/11-analytics-reporting/11-RESEARCH.md
@apps/backend/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Migration Prisma models</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add migration infrastructure models:

```prisma
// Migration job tracking
model MigrationJob {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  // Source configuration
  sourceType      MigrationSourceType   // NAVEX, EQS, LEGACY_ETHICO, GENERIC_CSV
  fileName        String
  fileUrl         String                // Azure Blob URL
  fileSizeBytes   Int

  // Status tracking
  status          MigrationJobStatus    // PENDING, VALIDATING, MAPPING, PREVIEW, IMPORTING, COMPLETED, FAILED, ROLLED_BACK
  progress        Int @default(0)       // 0-100 percentage
  currentStep     String?               // "Validating rows", "Creating cases", etc.

  // Counts
  totalRows       Int?
  validRows       Int?
  errorRows       Int?
  importedRows    Int @default(0)

  // Field mappings (snapshot at import time)
  fieldMappings   Json?                 // Array of MigrationFieldMapping

  // Validation results
  validationErrors Json?                // Array of { row, field, error }
  previewData     Json?                 // Sample transformed rows

  // Rollback
  rollbackAvailableUntil DateTime?      // 7 days after completion
  rolledBackAt    DateTime?
  rolledBackById  String?

  // Audit
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  createdById     String
  createdBy       User @relation(fields: [createdById], references: [id])

  // Error details
  errorMessage    String?
  errorDetails    Json?

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
}

enum MigrationSourceType {
  NAVEX
  EQS
  LEGACY_ETHICO
  GENERIC_CSV
  ONETRUST
  STAR
}

enum MigrationJobStatus {
  PENDING           // File uploaded, not yet validated
  VALIDATING        // Checking file format
  MAPPING           // Field mapping in progress
  PREVIEW           // Preview generated, awaiting confirmation
  IMPORTING         // Import in progress
  COMPLETED         // Import finished successfully
  FAILED            // Import failed
  ROLLED_BACK       // Import was rolled back
}

// Saved field mapping templates
model MigrationFieldTemplate {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  name            String
  sourceType      MigrationSourceType
  mappings        Json                  // Array of field mappings

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String

  @@unique([organizationId, sourceType, name])
  @@index([organizationId, sourceType])
}

// Track imported records for rollback
model MigrationRecord {
  id              String   @id @default(uuid())
  migrationJobId  String
  migrationJob    MigrationJob @relation(fields: [migrationJobId], references: [id], onDelete: Cascade)

  // What was created
  entityType      String                // 'Case', 'RIU', 'Person', etc.
  entityId        String

  // Original data
  sourceRowNumber Int
  sourceData      Json                  // Original row data

  // Status
  createdAt       DateTime @default(now())
  modifiedAfterImport Boolean @default(false)  // Prevents rollback

  @@index([migrationJobId])
  @@index([entityType, entityId])
}
```

Run `npx prisma format` and `npx prisma generate`.
  </action>
  <verify>npx prisma format && npx prisma generate succeeds</verify>
  <done>MigrationJob, MigrationFieldTemplate, MigrationRecord models exist in schema</done>
</task>

<task type="auto">
  <name>Task 2: Create Migration DTOs and entities</name>
  <files>
    apps/backend/src/modules/analytics/migration/dto/migration.dto.ts
    apps/backend/src/modules/analytics/migration/entities/migration.entity.ts
  </files>
  <action>
1. Create DTOs in `dto/migration.dto.ts`:

```typescript
export class CreateMigrationJobDto {
  @IsEnum(MigrationSourceType)
  sourceType: MigrationSourceType;

  @IsString()
  fileName: string;

  @IsString()
  fileUrl: string;

  @IsInt()
  @Min(0)
  fileSizeBytes: number;
}

export class FieldMappingDto {
  @IsString()
  sourceField: string;

  @IsString()
  targetField: string;

  @IsEnum(TargetEntityType)
  targetEntity: TargetEntityType;

  @IsOptional()
  @IsString()
  transformFunction?: string;  // 'uppercase', 'parseDate', 'mapCategory', etc.

  @IsOptional()
  defaultValue?: unknown;

  @IsBoolean()
  isRequired: boolean;
}

export enum TargetEntityType {
  CASE = 'Case',
  RIU = 'RIU',
  PERSON = 'Person',
  INVESTIGATION = 'Investigation',
}

export class SaveFieldMappingsDto {
  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => FieldMappingDto)
  mappings: FieldMappingDto[];

  @IsOptional()
  @IsBoolean()
  saveAsTemplate?: boolean;

  @IsOptional()
  @IsString()
  templateName?: string;
}

export class StartImportDto {
  @IsBoolean()
  confirmed: boolean;
}

export class RollbackDto {
  @IsString()
  @MinLength(10)
  confirmText: string;  // Must be "ROLLBACK"
}

export class MigrationJobResponseDto {
  jobId: string;
  status: MigrationJobStatus;
  sourceType: MigrationSourceType;
  fileName: string;
  progress: number;
  currentStep?: string;
  totalRows?: number;
  validRows?: number;
  errorRows?: number;
  importedRows: number;
  previewData?: PreviewRow[];
  validationErrors?: ValidationError[];
  rollbackAvailableUntil?: Date;
  createdAt: Date;
  completedAt?: Date;
}

export interface PreviewRow {
  rowNumber: number;
  sourceData: Record<string, unknown>;
  transformedData: {
    case?: Partial<Case>;
    riu?: Partial<Riu>;
    person?: Partial<Person>;
  };
  issues?: string[];
}
```

2. Create entity types in `entities/migration.entity.ts`:
- FieldMapping interface
- TransformFunction type
- ValidationError interface
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Migration DTOs and entity types created with validation</done>
</task>

<task type="auto">
  <name>Task 3: Implement MigrationService</name>
  <files>apps/backend/src/modules/analytics/migration/migration.service.ts</files>
  <action>
Create MigrationService:

```typescript
@Injectable()
export class MigrationService {
  constructor(
    private prisma: PrismaService,
    private storage: StorageService,
    private auditService: AuditService,
  ) {}

  // Job management
  async createJob(orgId: string, userId: string, dto: CreateMigrationJobDto): Promise<MigrationJob>
  async getJob(orgId: string, jobId: string): Promise<MigrationJob>
  async listJobs(orgId: string, query: PaginationDto): Promise<PaginatedResult<MigrationJob>>

  // Format detection
  async detectFormat(jobId: string): Promise<{
    sourceType: MigrationSourceType;
    detectedFields: string[];
    sampleRows: Record<string, unknown>[];
  }>

  // Field mapping
  async getSuggestedMappings(jobId: string): Promise<FieldMappingDto[]>
  async saveMappings(orgId: string, jobId: string, dto: SaveFieldMappingsDto): Promise<void>
  async loadTemplateMapping(orgId: string, sourceType: MigrationSourceType): Promise<FieldMappingDto[]>

  // Validation & Preview
  async validate(jobId: string): Promise<{
    validRows: number;
    errorRows: number;
    errors: ValidationError[];
  }>
  async generatePreview(jobId: string, limit?: number): Promise<PreviewRow[]>

  // Import execution
  async startImport(orgId: string, jobId: string): Promise<void>
  async cancelImport(orgId: string, jobId: string): Promise<void>

  // Rollback
  async canRollback(jobId: string): Promise<{ canRollback: boolean; reason?: string; modifiedCount?: number }>
  async rollback(orgId: string, userId: string, jobId: string): Promise<{
    rolledBackCount: number;
    skippedCount: number;
    skippedReasons: string[];
  }>

  // Field mapping helpers
  private suggestMapping(sourceField: string, sourceType: MigrationSourceType): FieldMappingDto | null
  private applyTransform(value: unknown, transform: string): unknown
}
```

Field mapping suggestions based on source type:
- NAVEX: case_number→caseNumber, incident_type→categoryName, etc.
- EQS: report_id→referenceNumber, created_date→createdAt, etc.
- GENERIC_CSV: Fuzzy match on field names

Rollback rules:
- Only available for 7 days
- Skip records that have been modified after import (modifiedAfterImport flag)
- Mark migration as ROLLED_BACK status
  </action>
  <verify>npm run lint passes for the service file</verify>
  <done>MigrationService implements job management, validation, preview, import, and rollback</done>
</task>

</tasks>

<verification>
```bash
cd apps/backend
npx prisma format
npx prisma generate
npm run lint -- --fix
npm run typecheck
```
</verification>

<success_criteria>
- MigrationJob, MigrationFieldTemplate, MigrationRecord models in schema
- Migration DTOs with validation for all operations
- MigrationService implements full migration lifecycle
- Format detection suggests mappings based on source type
- Rollback available for 7 days, respects modified records
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-reporting/11-04-SUMMARY.md`
</output>
