---
phase: 11-analytics-reporting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/analytics/exports/flat-file.service.ts
  - apps/backend/src/modules/analytics/exports/dto/export.dto.ts
  - apps/backend/src/modules/analytics/exports/entities/export.entity.ts
autonomous: true

must_haves:
  truths:
    - "Export jobs can be created and tracked asynchronously"
    - "Tagged fields allow admins to promote custom fields to named columns"
    - "Export configurations support multiple formats (CSV, XLSX, JSON)"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "ExportJob, ReportFieldTag models"
      contains: "model ExportJob"
    - path: "apps/backend/src/modules/analytics/exports/flat-file.service.ts"
      provides: "Flat file export service with tagged fields"
      min_lines: 150
  key_links:
    - from: "flat-file.service.ts"
      to: "prisma.exportJob"
      via: "job tracking"
      pattern: "prisma\\.exportJob"
---

<objective>
Build the flat file export infrastructure - models and service for async export job management with tagged fields.

Purpose: Enable compliance teams to export denormalized data with admin-configured special columns (FLAT-01).
Output: ExportJob, ReportFieldTag models and FlatFileService
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-analytics-reporting/11-CONTEXT.md
@01-SHARED-INFRASTRUCTURE/TECH-SPEC-FLAT-FILE-EXPORT.md
@apps/backend/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Export Prisma models</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add export infrastructure models per TECH-SPEC-FLAT-FILE-EXPORT.md:

```prisma
// Admin-configured field tags for flat export
model ReportFieldTag {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  // What field is tagged
  sourceEntityType  ExportSourceType  // CASE, INVESTIGATION, DISCLOSURE, INTERVIEW_RESPONSE, RIU
  sourceFieldPath   String            // "customFields.totalDollarAmount" or "responses.q5"
  templateId        String?           // Optional: limit to specific form template

  // Export config
  tagSlot           Int               // 1-20, determines column position
  columnName        String            // "total_dollar_amount"
  displayLabel      String            // "Total Dollar Amount"

  // Formatting
  dataType          ExportDataType    // TEXT, NUMBER, DATE, BOOLEAN, CURRENCY, PERCENTAGE
  formatPattern     String?           // "$#,##0.00" for currency, "YYYY-MM-DD" for date

  // Metadata
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdById       String

  @@unique([organizationId, tagSlot])
  @@unique([organizationId, sourceEntityType, sourceFieldPath, templateId])
  @@index([organizationId])
}

enum ExportSourceType {
  CASE
  INVESTIGATION
  DISCLOSURE
  INTERVIEW_RESPONSE
  RIU
}

enum ExportDataType {
  TEXT
  NUMBER
  DATE
  BOOLEAN
  CURRENCY
  PERCENTAGE
}

// Export job tracking
model ExportJob {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  // Job config
  exportType      ExportType        // FLAT_FILE, CASES_ONLY, DISCLOSURES_ONLY
  format          ExportFormat      // CSV, XLSX, JSON
  filters         Json              // Query filters applied
  columns         Json              // Column configuration snapshot

  // Status
  status          ExportJobStatus   // PENDING, PROCESSING, COMPLETED, FAILED, CANCELLED
  progress        Int @default(0)   // 0-100 percentage
  totalRows       Int?
  processedRows   Int @default(0)

  // Output
  fileUrl         String?           // Azure Blob URL when complete
  fileSizeBytes   Int?
  expiresAt       DateTime?         // Auto-delete after 7 days

  // Error handling
  errorMessage    String?
  errorDetails    Json?

  // Audit
  createdAt       DateTime @default(now())
  completedAt     DateTime?
  createdById     String
  createdBy       User @relation(fields: [createdById], references: [id])

  @@index([organizationId, status])
  @@index([organizationId, createdAt])
  @@index([createdById])
}

enum ExportType {
  FLAT_FILE           // Everything denormalized
  CASES_ONLY          // Just case columns
  INVESTIGATIONS_ONLY // Just investigation columns
  DISCLOSURES_ONLY    // Just disclosure columns
  CUSTOM              // User-selected columns
}

enum ExportFormat {
  CSV
  XLSX
  JSON
}

enum ExportJobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
```

Run `npx prisma format` and `npx prisma generate`.
  </action>
  <verify>npx prisma format && npx prisma generate succeeds</verify>
  <done>ExportJob and ReportFieldTag models exist in schema with enums</done>
</task>

<task type="auto">
  <name>Task 2: Create Export DTOs and entities</name>
  <files>
    apps/backend/src/modules/analytics/exports/dto/export.dto.ts
    apps/backend/src/modules/analytics/exports/entities/export.entity.ts
  </files>
  <action>
1. Create DTOs in `dto/export.dto.ts`:

```typescript
// Tag management
export class CreateTagDto {
  @IsEnum(ExportSourceType)
  sourceEntityType: ExportSourceType;

  @IsString()
  @MaxLength(100)
  sourceFieldPath: string;

  @IsOptional()
  @IsUUID()
  templateId?: string;

  @IsInt()
  @Min(1)
  @Max(20)
  tagSlot: number;

  @IsString()
  @Matches(/^[a-z][a-z0-9_]*$/)
  @MaxLength(50)
  columnName: string;

  @IsString()
  @MaxLength(100)
  displayLabel: string;

  @IsEnum(ExportDataType)
  dataType: ExportDataType;

  @IsOptional()
  @IsString()
  formatPattern?: string;
}

export class UpdateTagDto extends PartialType(CreateTagDto) {}

// Export job creation
export class CreateExportJobDto {
  @IsEnum(ExportType)
  exportType: ExportType;

  @IsEnum(ExportFormat)
  format: ExportFormat;

  // Filters
  @IsOptional()
  @ValidateNested()
  @Type(() => DateRangeDto)
  dateRange?: DateRangeDto;

  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  statuses?: string[];

  @IsOptional()
  @IsArray()
  @IsUUID('4', { each: true })
  categories?: string[];

  @IsOptional()
  @IsArray()
  @IsUUID('4', { each: true })
  businessUnits?: string[];

  @IsOptional()
  @IsArray()
  @IsUUID('4', { each: true })
  locations?: string[];

  // Column config
  @IsOptional()
  @IsBoolean()
  includeInvestigations?: boolean = true;

  @IsOptional()
  @IsInt()
  @Min(1)
  @Max(10)
  maxInvestigations?: number = 3;

  @IsOptional()
  @IsBoolean()
  includeTaggedFields?: boolean = true;

  @IsOptional()
  @IsBoolean()
  includeOverflow?: boolean = false;
}

export class DateRangeDto {
  @IsDateString()
  start: string;

  @IsDateString()
  end: string;
}

export class ExportJobResponseDto {
  jobId: string;
  status: ExportJobStatus;
  progress: number;
  totalRows?: number;
  format: ExportFormat;
  fileSizeBytes?: number;
  downloadUrl?: string;
  expiresAt?: Date;
  createdAt: Date;
  completedAt?: Date;
  errorMessage?: string;
}
```

2. Create entity types in `entities/export.entity.ts`:
- ExportColumn interface for column definitions
- TaggedFieldConfig interface
- ColumnMapping interface for denormalization
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Export DTOs with validation and entity types created</done>
</task>

<task type="auto">
  <name>Task 3: Implement FlatFileService</name>
  <files>apps/backend/src/modules/analytics/exports/flat-file.service.ts</files>
  <action>
Create FlatFileService with:

```typescript
@Injectable()
export class FlatFileService {
  constructor(
    private prisma: PrismaService,
    private auditService: AuditService,
  ) {}

  // Tag management
  async configureTag(orgId: string, userId: string, dto: CreateTagDto): Promise<ReportFieldTag>
  async getTaggedFields(orgId: string): Promise<ReportFieldTag[]>
  async removeTag(orgId: string, slot: number): Promise<void>
  async previewTag(orgId: string, caseId: string): Promise<TagPreview[]>

  // Export job management
  async createExportJob(orgId: string, userId: string, dto: CreateExportJobDto): Promise<ExportJob>
  async getExportJob(orgId: string, jobId: string): Promise<ExportJob>
  async cancelExportJob(orgId: string, jobId: string): Promise<void>
  async listExportJobs(orgId: string, userId: string, query: PaginationDto): Promise<PaginatedResult<ExportJob>>

  // Column builders
  getCoreColumns(): ColumnDefinition[]
  getInvestigationColumns(maxInvestigations: number): ColumnDefinition[]
  getTaggedColumns(tags: ReportFieldTag[]): ColumnDefinition[]

  // Value resolution
  async resolveTaggedFieldValue(
    tag: ReportFieldTag,
    entity: CaseWithRelations,
  ): Promise<string | number | boolean | null>

  // Formatting
  formatValue(value: unknown, dataType: ExportDataType, pattern?: string): string
}
```

Core columns per TECH-SPEC (40 columns):
- case_id, case_number, case_status, case_priority
- case_created_at, case_closed_at, case_days_open, case_sla_breached
- category_name, category_code, subcategory_name
- source_channel, is_anonymous, reporter_relationship
- assigned_to_name, assigned_to_email
- business_unit_name, business_unit_code
- location_name, location_country, location_region
- outcome, outcome_reason
- has_remediation, remediation_status
- riu_count, investigation_count, subject_count, attachment_count

Investigation columns (repeated for inv_1, inv_2, inv_3):
- inv_{N}_id, inv_{N}_type, inv_{N}_status, inv_{N}_outcome
- inv_{N}_started_at, inv_{N}_completed_at, inv_{N}_days_to_complete
- inv_{N}_investigator_name, inv_{N}_interview_count, inv_{N}_finding_summary
  </action>
  <verify>npm run lint passes for the service file</verify>
  <done>FlatFileService implements tag management, job creation, and column builders</done>
</task>

</tasks>

<verification>
```bash
cd apps/backend
npx prisma format
npx prisma generate
npm run lint -- --fix
npm run typecheck
```
</verification>

<success_criteria>
- ExportJob and ReportFieldTag models in Prisma schema
- Export DTOs with class-validator decorators
- FlatFileService implements tag CRUD and job management
- Core columns, investigation columns, tagged columns defined
- Value formatting supports CURRENCY, DATE, PERCENTAGE types
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-reporting/11-03-SUMMARY.md`
</output>
