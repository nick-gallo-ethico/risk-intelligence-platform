---
phase: 11-analytics-reporting
plan: 14
type: execute
wave: 4
depends_on: ["11-13"]
files_modified:
  - apps/frontend/src/components/projects/GanttChart.tsx
  - apps/frontend/src/components/projects/MilestoneTimeline.tsx
  - apps/frontend/src/hooks/use-milestones.ts
  - apps/frontend/src/lib/gantt-utils.ts
autonomous: true

must_haves:
  truths:
    - "Gantt chart displays milestones on a timeline"
    - "Progress bars show completion percentage per milestone"
    - "Users can zoom timeline to week, month, or quarter views"
  artifacts:
    - path: "apps/frontend/src/components/projects/GanttChart.tsx"
      provides: "Interactive Gantt chart component"
      min_lines: 150
    - path: "apps/frontend/src/lib/gantt-utils.ts"
      provides: "Timeline calculation utilities"
      min_lines: 80
  key_links:
    - from: "GanttChart.tsx"
      to: "use-milestones"
      via: "milestone data"
      pattern: "useMilestones"
---

<objective>
Build Gantt chart visualization for project milestone tracking.

Purpose: Enable compliance officers to visualize milestone timelines and progress (PROJ-06).
Output: GanttChart component with timeline zoom, progress bars, and dependency lines
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-analytics-reporting/11-CONTEXT.md
@.planning/phases/11-analytics-reporting/11-13-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gantt utility functions</name>
  <files>apps/frontend/src/lib/gantt-utils.ts</files>
  <action>
Create timeline calculation utilities:

```typescript
import {
  startOfWeek,
  endOfWeek,
  startOfMonth,
  endOfMonth,
  startOfQuarter,
  endOfQuarter,
  eachDayOfInterval,
  eachWeekOfInterval,
  eachMonthOfInterval,
  differenceInDays,
  format,
  isWithinInterval,
  min,
  max,
  addDays,
  subDays,
} from 'date-fns';

export type TimelineZoom = 'week' | 'month' | 'quarter';

export interface TimelineColumn {
  date: Date;
  label: string;
  isToday: boolean;
  isWeekend: boolean;
}

export interface MilestoneBar {
  id: string;
  name: string;
  startDate: Date;
  endDate: Date;
  progress: number;
  status: 'NOT_STARTED' | 'IN_PROGRESS' | 'AT_RISK' | 'COMPLETED' | 'CANCELLED';
  left: number;  // Percentage
  width: number; // Percentage
  row: number;
}

export interface TimelineRange {
  start: Date;
  end: Date;
  columns: TimelineColumn[];
}

/**
 * Calculate timeline range based on milestones and zoom level.
 */
export function calculateTimelineRange(
  milestones: { targetDate: Date; createdAt: Date }[],
  zoom: TimelineZoom,
  paddingDays: number = 14,
): TimelineRange {
  if (milestones.length === 0) {
    const now = new Date();
    return createTimelineForRange(subDays(now, 30), addDays(now, 60), zoom);
  }

  const dates = milestones.flatMap(m => [m.targetDate, m.createdAt]);
  const minDate = min(dates);
  const maxDate = max(dates);

  const start = subDays(minDate, paddingDays);
  const end = addDays(maxDate, paddingDays);

  return createTimelineForRange(start, end, zoom);
}

function createTimelineForRange(start: Date, end: Date, zoom: TimelineZoom): TimelineRange {
  let columns: TimelineColumn[];
  const today = new Date();

  switch (zoom) {
    case 'week': {
      // Daily columns for week view
      const days = eachDayOfInterval({ start, end });
      columns = days.map(date => ({
        date,
        label: format(date, 'EEE d'),
        isToday: format(date, 'yyyy-MM-dd') === format(today, 'yyyy-MM-dd'),
        isWeekend: date.getDay() === 0 || date.getDay() === 6,
      }));
      break;
    }

    case 'month': {
      // Weekly columns for month view
      const weeks = eachWeekOfInterval({ start, end });
      columns = weeks.map(date => ({
        date,
        label: format(date, 'MMM d'),
        isToday: isWithinInterval(today, { start: date, end: endOfWeek(date) }),
        isWeekend: false,
      }));
      break;
    }

    case 'quarter': {
      // Monthly columns for quarter view
      const months = eachMonthOfInterval({ start, end });
      columns = months.map(date => ({
        date,
        label: format(date, 'MMM yyyy'),
        isToday: format(date, 'yyyy-MM') === format(today, 'yyyy-MM'),
        isWeekend: false,
      }));
      break;
    }
  }

  return { start, end, columns };
}

/**
 * Calculate bar position and width for a milestone.
 */
export function calculateMilestoneBar(
  milestone: {
    id: string;
    name: string;
    createdAt: Date;
    targetDate: Date;
    progressPercent: number;
    status: string;
  },
  timeline: TimelineRange,
  row: number,
): MilestoneBar {
  const totalDays = differenceInDays(timeline.end, timeline.start);

  // Start from creation date, end at target date
  const startOffset = differenceInDays(milestone.createdAt, timeline.start);
  const endOffset = differenceInDays(milestone.targetDate, timeline.start);

  const left = Math.max(0, (startOffset / totalDays) * 100);
  const right = Math.min(100, (endOffset / totalDays) * 100);
  const width = Math.max(2, right - left); // Minimum 2% width for visibility

  return {
    id: milestone.id,
    name: milestone.name,
    startDate: milestone.createdAt,
    endDate: milestone.targetDate,
    progress: milestone.progressPercent,
    status: milestone.status as MilestoneBar['status'],
    left,
    width,
    row,
  };
}

/**
 * Get color for milestone status.
 */
export function getStatusColor(status: MilestoneBar['status']): string {
  switch (status) {
    case 'COMPLETED':
      return '#22c55e'; // green-500
    case 'IN_PROGRESS':
      return '#3b82f6'; // blue-500
    case 'AT_RISK':
      return '#f59e0b'; // amber-500
    case 'CANCELLED':
      return '#6b7280'; // gray-500
    default:
      return '#94a3b8'; // slate-400
  }
}

/**
 * Get lighter color for milestone background.
 */
export function getStatusBgColor(status: MilestoneBar['status']): string {
  switch (status) {
    case 'COMPLETED':
      return '#dcfce7'; // green-100
    case 'IN_PROGRESS':
      return '#dbeafe'; // blue-100
    case 'AT_RISK':
      return '#fef3c7'; // amber-100
    case 'CANCELLED':
      return '#f3f4f6'; // gray-100
    default:
      return '#f1f5f9'; // slate-100
  }
}

/**
 * Format date range for tooltip.
 */
export function formatDateRange(start: Date, end: Date): string {
  const startStr = format(start, 'MMM d, yyyy');
  const endStr = format(end, 'MMM d, yyyy');
  return `${startStr} - ${endStr}`;
}

/**
 * Calculate today line position.
 */
export function getTodayPosition(timeline: TimelineRange): number | null {
  const today = new Date();
  if (!isWithinInterval(today, { start: timeline.start, end: timeline.end })) {
    return null;
  }
  const totalDays = differenceInDays(timeline.end, timeline.start);
  const todayOffset = differenceInDays(today, timeline.start);
  return (todayOffset / totalDays) * 100;
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Gantt utility functions created for timeline calculations</done>
</task>

<task type="auto">
  <name>Task 2: Create useMilestones hook</name>
  <files>apps/frontend/src/hooks/use-milestones.ts</files>
  <action>
Create React Query hook for milestones:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { api } from '@/lib/api';
import type {
  MilestoneResponseDto,
  CreateMilestoneDto,
  UpdateMilestoneDto,
  MilestoneQueryDto,
} from '@/types/milestone';

const MILESTONES_KEY = 'milestones';

interface UseMilestonesOptions extends MilestoneQueryDto {}

export function useMilestones(options: UseMilestonesOptions = {}) {
  return useQuery({
    queryKey: [MILESTONES_KEY, options],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (options.status) params.set('status', options.status);
      if (options.category) params.set('category', options.category);
      if (options.ownerId) params.set('ownerId', options.ownerId);
      if (options.targetDateFrom) params.set('targetDateFrom', options.targetDateFrom.toISOString());
      if (options.targetDateTo) params.set('targetDateTo', options.targetDateTo.toISOString());
      if (options.offset) params.set('offset', String(options.offset));
      if (options.limit) params.set('limit', String(options.limit));

      const response = await api.get<{
        items: MilestoneResponseDto[];
        total: number;
      }>(`/api/v1/milestones?${params}`);
      return response.data;
    },
  });
}

export function useMilestone(milestoneId: string | undefined) {
  return useQuery({
    queryKey: [MILESTONES_KEY, milestoneId],
    queryFn: async () => {
      if (!milestoneId) return null;
      const response = await api.get<MilestoneResponseDto>(`/api/v1/milestones/${milestoneId}`);
      return response.data;
    },
    enabled: !!milestoneId,
  });
}

export function useCreateMilestone() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (dto: CreateMilestoneDto) => {
      const response = await api.post<MilestoneResponseDto>('/api/v1/milestones', dto);
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY] });
    },
  });
}

export function useUpdateMilestone() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({ id, dto }: { id: string; dto: UpdateMilestoneDto }) => {
      const response = await api.patch<MilestoneResponseDto>(`/api/v1/milestones/${id}`, dto);
      return response.data;
    },
    onSuccess: (_, { id }) => {
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY] });
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY, id] });
    },
  });
}

export function useDeleteMilestone() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async (id: string) => {
      await api.delete(`/api/v1/milestones/${id}`);
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY] });
    },
  });
}

export function useAddMilestoneItem() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({
      milestoneId,
      dto,
    }: {
      milestoneId: string;
      dto: { entityType: string; entityId?: string; customTitle?: string };
    }) => {
      const response = await api.post(`/api/v1/milestones/${milestoneId}/items`, dto);
      return response.data;
    },
    onSuccess: (_, { milestoneId }) => {
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY, milestoneId] });
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY] });
    },
  });
}

export function useUpdateMilestoneItem() {
  const queryClient = useQueryClient();

  return useMutation({
    mutationFn: async ({
      milestoneId,
      itemId,
      dto,
    }: {
      milestoneId: string;
      itemId: string;
      dto: { isCompleted?: boolean; customTitle?: string };
    }) => {
      const response = await api.patch(`/api/v1/milestones/${milestoneId}/items/${itemId}`, dto);
      return response.data;
    },
    onSuccess: (_, { milestoneId }) => {
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY, milestoneId] });
      queryClient.invalidateQueries({ queryKey: [MILESTONES_KEY] });
    },
  });
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>useMilestones hook with CRUD operations created</done>
</task>

<task type="auto">
  <name>Task 3: Implement GanttChart component</name>
  <files>apps/frontend/src/components/projects/GanttChart.tsx</files>
  <action>
Create interactive Gantt chart component:

```typescript
'use client';

import { useState, useMemo, useCallback } from 'react';
import { cn } from '@/lib/utils';
import {
  TimelineZoom,
  calculateTimelineRange,
  calculateMilestoneBar,
  getStatusColor,
  getStatusBgColor,
  getTodayPosition,
  formatDateRange,
  MilestoneBar,
} from '@/lib/gantt-utils';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { Button } from '@/components/ui/button';
import { ZoomIn, ZoomOut, Calendar } from 'lucide-react';
import type { MilestoneResponseDto } from '@/types/milestone';

interface GanttChartProps {
  milestones: MilestoneResponseDto[];
  onMilestoneClick?: (milestone: MilestoneResponseDto) => void;
  className?: string;
}

const ROW_HEIGHT = 40;
const HEADER_HEIGHT = 60;

export function GanttChart({
  milestones,
  onMilestoneClick,
  className,
}: GanttChartProps) {
  const [zoom, setZoom] = useState<TimelineZoom>('month');

  // Calculate timeline range
  const timeline = useMemo(() => {
    const milestoneDates = milestones.map(m => ({
      targetDate: new Date(m.targetDate),
      createdAt: new Date(m.createdAt),
    }));
    return calculateTimelineRange(milestoneDates, zoom);
  }, [milestones, zoom]);

  // Calculate bars
  const bars = useMemo(() => {
    return milestones.map((m, index) =>
      calculateMilestoneBar(
        {
          id: m.id,
          name: m.name,
          createdAt: new Date(m.createdAt),
          targetDate: new Date(m.targetDate),
          progressPercent: m.progressPercent,
          status: m.status,
        },
        timeline,
        index,
      ),
    );
  }, [milestones, timeline]);

  // Today line position
  const todayPosition = useMemo(() => getTodayPosition(timeline), [timeline]);

  const handleZoomIn = useCallback(() => {
    setZoom(prev => {
      if (prev === 'quarter') return 'month';
      if (prev === 'month') return 'week';
      return prev;
    });
  }, []);

  const handleZoomOut = useCallback(() => {
    setZoom(prev => {
      if (prev === 'week') return 'month';
      if (prev === 'month') return 'quarter';
      return prev;
    });
  }, []);

  const totalHeight = HEADER_HEIGHT + milestones.length * ROW_HEIGHT + 20;

  return (
    <div className={cn('relative overflow-auto border rounded-lg bg-white', className)}>
      {/* Toolbar */}
      <div className="sticky top-0 left-0 z-20 flex items-center gap-2 p-2 border-b bg-slate-50">
        <Button
          variant="outline"
          size="sm"
          onClick={handleZoomIn}
          disabled={zoom === 'week'}
        >
          <ZoomIn className="h-4 w-4" />
        </Button>
        <Button
          variant="outline"
          size="sm"
          onClick={handleZoomOut}
          disabled={zoom === 'quarter'}
        >
          <ZoomOut className="h-4 w-4" />
        </Button>
        <span className="text-sm text-muted-foreground">
          View: {zoom === 'week' ? 'Daily' : zoom === 'month' ? 'Weekly' : 'Monthly'}
        </span>
      </div>

      {/* Chart container */}
      <div
        className="relative"
        style={{ height: totalHeight, minWidth: timeline.columns.length * (zoom === 'week' ? 40 : zoom === 'month' ? 80 : 120) }}
      >
        {/* Timeline header */}
        <div
          className="sticky top-[41px] z-10 flex border-b bg-slate-100"
          style={{ height: HEADER_HEIGHT }}
        >
          {timeline.columns.map((col, i) => (
            <div
              key={i}
              className={cn(
                'flex-shrink-0 flex items-end justify-center pb-2 border-r text-xs font-medium',
                col.isToday && 'bg-blue-50',
                col.isWeekend && 'bg-slate-50',
              )}
              style={{ width: zoom === 'week' ? 40 : zoom === 'month' ? 80 : 120 }}
            >
              {col.label}
            </div>
          ))}
        </div>

        {/* Grid lines */}
        <div className="absolute top-[60px] left-0 right-0 bottom-0">
          {timeline.columns.map((col, i) => (
            <div
              key={i}
              className={cn(
                'absolute top-0 bottom-0 border-r border-slate-100',
                col.isToday && 'bg-blue-50/30',
                col.isWeekend && 'bg-slate-50/50',
              )}
              style={{
                left: `${(i / timeline.columns.length) * 100}%`,
                width: `${100 / timeline.columns.length}%`,
              }}
            />
          ))}
        </div>

        {/* Today line */}
        {todayPosition !== null && (
          <div
            className="absolute top-[60px] bottom-0 w-0.5 bg-red-500 z-10"
            style={{ left: `${todayPosition}%` }}
          >
            <div className="absolute -top-4 -left-3 px-1 py-0.5 text-xs bg-red-500 text-white rounded">
              Today
            </div>
          </div>
        )}

        {/* Milestone bars */}
        <TooltipProvider>
          <div className="absolute top-[60px] left-0 right-0">
            {bars.map((bar, index) => {
              const milestone = milestones[index];
              return (
                <Tooltip key={bar.id}>
                  <TooltipTrigger asChild>
                    <div
                      className="absolute h-6 my-2 rounded cursor-pointer transition-transform hover:scale-y-110"
                      style={{
                        top: bar.row * ROW_HEIGHT,
                        left: `${bar.left}%`,
                        width: `${bar.width}%`,
                        backgroundColor: getStatusBgColor(bar.status),
                        border: `1px solid ${getStatusColor(bar.status)}`,
                      }}
                      onClick={() => onMilestoneClick?.(milestone)}
                    >
                      {/* Progress fill */}
                      <div
                        className="absolute top-0 left-0 h-full rounded-l"
                        style={{
                          width: `${bar.progress}%`,
                          backgroundColor: getStatusColor(bar.status),
                          opacity: 0.4,
                        }}
                      />
                      {/* Label */}
                      <span className="absolute inset-0 flex items-center px-2 text-xs font-medium truncate">
                        {bar.name}
                      </span>
                    </div>
                  </TooltipTrigger>
                  <TooltipContent>
                    <div className="space-y-1">
                      <p className="font-medium">{bar.name}</p>
                      <p className="text-xs text-muted-foreground">
                        {formatDateRange(bar.startDate, bar.endDate)}
                      </p>
                      <p className="text-xs">
                        Progress: {bar.progress}% ({milestone.completedItems}/{milestone.totalItems} items)
                      </p>
                      <p className="text-xs capitalize">
                        Status: {bar.status.toLowerCase().replace('_', ' ')}
                      </p>
                    </div>
                  </TooltipContent>
                </Tooltip>
              );
            })}
          </div>
        </TooltipProvider>
      </div>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>GanttChart component with zoom, progress bars, and tooltips created</done>
</task>

<task type="auto">
  <name>Task 4: Create MilestoneTimeline component</name>
  <files>apps/frontend/src/components/projects/MilestoneTimeline.tsx</files>
  <action>
Create timeline list view component:

```typescript
'use client';

import { cn } from '@/lib/utils';
import { format, differenceInDays, isPast } from 'date-fns';
import { CheckCircle2, Circle, AlertTriangle, Clock, XCircle } from 'lucide-react';
import { Progress } from '@/components/ui/progress';
import { Badge } from '@/components/ui/badge';
import type { MilestoneResponseDto } from '@/types/milestone';

interface MilestoneTimelineProps {
  milestones: MilestoneResponseDto[];
  onMilestoneClick?: (milestone: MilestoneResponseDto) => void;
  className?: string;
}

const statusConfig = {
  NOT_STARTED: {
    icon: Circle,
    color: 'text-slate-400',
    bgColor: 'bg-slate-100',
    label: 'Not Started',
  },
  IN_PROGRESS: {
    icon: Clock,
    color: 'text-blue-500',
    bgColor: 'bg-blue-100',
    label: 'In Progress',
  },
  AT_RISK: {
    icon: AlertTriangle,
    color: 'text-amber-500',
    bgColor: 'bg-amber-100',
    label: 'At Risk',
  },
  COMPLETED: {
    icon: CheckCircle2,
    color: 'text-green-500',
    bgColor: 'bg-green-100',
    label: 'Completed',
  },
  CANCELLED: {
    icon: XCircle,
    color: 'text-gray-500',
    bgColor: 'bg-gray-100',
    label: 'Cancelled',
  },
};

export function MilestoneTimeline({
  milestones,
  onMilestoneClick,
  className,
}: MilestoneTimelineProps) {
  // Sort by target date
  const sortedMilestones = [...milestones].sort(
    (a, b) => new Date(a.targetDate).getTime() - new Date(b.targetDate).getTime(),
  );

  return (
    <div className={cn('relative', className)}>
      {/* Timeline line */}
      <div className="absolute left-5 top-0 bottom-0 w-0.5 bg-slate-200" />

      <div className="space-y-4">
        {sortedMilestones.map((milestone) => {
          const config = statusConfig[milestone.status];
          const Icon = config.icon;
          const targetDate = new Date(milestone.targetDate);
          const daysUntil = differenceInDays(targetDate, new Date());
          const isOverdue = isPast(targetDate) && milestone.status !== 'COMPLETED';

          return (
            <div
              key={milestone.id}
              className={cn(
                'relative pl-12 cursor-pointer group',
                'transition-colors hover:bg-slate-50 rounded-lg p-3 -ml-3',
              )}
              onClick={() => onMilestoneClick?.(milestone)}
            >
              {/* Status icon */}
              <div
                className={cn(
                  'absolute left-2 top-4 w-7 h-7 rounded-full flex items-center justify-center',
                  config.bgColor,
                )}
              >
                <Icon className={cn('h-4 w-4', config.color)} />
              </div>

              {/* Content */}
              <div className="space-y-2">
                <div className="flex items-start justify-between gap-4">
                  <div>
                    <h4 className="font-medium group-hover:text-primary">
                      {milestone.name}
                    </h4>
                    {milestone.description && (
                      <p className="text-sm text-muted-foreground line-clamp-1">
                        {milestone.description}
                      </p>
                    )}
                  </div>
                  <div className="flex items-center gap-2 flex-shrink-0">
                    <Badge variant={isOverdue ? 'destructive' : 'secondary'}>
                      {isOverdue
                        ? `${Math.abs(daysUntil)} days overdue`
                        : daysUntil === 0
                          ? 'Due today'
                          : `${daysUntil} days left`}
                    </Badge>
                    <Badge variant="outline" className={config.color}>
                      {config.label}
                    </Badge>
                  </div>
                </div>

                <div className="flex items-center gap-4">
                  <div className="flex-1">
                    <Progress value={milestone.progressPercent} className="h-2" />
                  </div>
                  <span className="text-sm text-muted-foreground w-20 text-right">
                    {milestone.progressPercent}% ({milestone.completedItems}/{milestone.totalItems})
                  </span>
                </div>

                <div className="flex items-center gap-4 text-xs text-muted-foreground">
                  <span>Target: {format(targetDate, 'MMM d, yyyy')}</span>
                  {milestone.owner && (
                    <span>Owner: {milestone.owner.name}</span>
                  )}
                  <span className="capitalize">
                    Category: {milestone.category.toLowerCase()}
                  </span>
                </div>
              </div>
            </div>
          );
        })}

        {sortedMilestones.length === 0 && (
          <div className="text-center py-8 text-muted-foreground">
            No milestones found. Create one to start tracking progress.
          </div>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>MilestoneTimeline list view component created</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run lint -- --fix
npm run typecheck
```
</verification>

<success_criteria>
- GanttChart displays milestones on timeline with proper positioning
- Progress bars show completion percentage with status colors
- Zoom controls switch between week/month/quarter views
- Today line marks current date on chart
- MilestoneTimeline provides alternative list view
- Tooltips show milestone details on hover
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-reporting/11-14-SUMMARY.md`
</output>
