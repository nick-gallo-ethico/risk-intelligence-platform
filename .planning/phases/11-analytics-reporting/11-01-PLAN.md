---
phase: 11-analytics-reporting
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/analytics/analytics.module.ts
  - apps/backend/src/modules/analytics/dashboard/dto/dashboard.dto.ts
  - apps/backend/src/modules/analytics/dashboard/dashboard-config.service.ts
  - apps/backend/src/modules/analytics/dashboard/entities/dashboard-config.entity.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard configurations can be saved and retrieved per user"
    - "Users can have multiple dashboards with one designated as home"
    - "Dashboard layouts store responsive breakpoints for all screen sizes"
  artifacts:
    - path: "apps/backend/src/modules/analytics/analytics.module.ts"
      provides: "AnalyticsModule aggregating dashboard, my-work, export services"
      exports: ["AnalyticsModule"]
    - path: "apps/backend/src/modules/analytics/dashboard/dashboard-config.service.ts"
      provides: "CRUD for user dashboard configurations"
      min_lines: 100
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Dashboard, DashboardWidget, UserDashboardConfig models"
      contains: "model Dashboard"
  key_links:
    - from: "dashboard-config.service.ts"
      to: "prisma.dashboard"
      via: "database operations"
      pattern: "prisma\\.dashboard\\."
---

<objective>
Build the dashboard configuration infrastructure - Prisma models and services for storing user dashboard layouts.

Purpose: Enable users to save personalized dashboard configurations with widget arrangements that persist across sessions.
Output: Dashboard, DashboardWidget, UserDashboardConfig models and DashboardConfigService
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-analytics-reporting/11-CONTEXT.md
@.planning/phases/11-analytics-reporting/11-RESEARCH.md
@apps/backend/prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Dashboard Prisma models</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add Dashboard infrastructure models:

```prisma
// Dashboard template (admin-managed or system default)
model Dashboard {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])

  name            String
  description     String?
  dashboardType   DashboardType  // CCO, INVESTIGATOR, CAMPAIGN_MANAGER, CUSTOM
  isSystem        Boolean  @default(false)  // System-provided templates
  isDefault       Boolean  @default(false)  // Default for dashboard type

  // Layout configuration (react-grid-layout format)
  layouts         Json     // { lg: Layout[], md: Layout[], sm: Layout[], xs: Layout[] }

  // Metadata
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdById     String

  widgets         DashboardWidget[]
  userConfigs     UserDashboardConfig[]

  @@unique([organizationId, name])
  @@index([organizationId, dashboardType])
  @@index([organizationId, isDefault])
}

enum DashboardType {
  CCO
  INVESTIGATOR
  CAMPAIGN_MANAGER
  CUSTOM
}

// Widget definition within a dashboard
model DashboardWidget {
  id              String   @id @default(uuid())
  dashboardId     String
  dashboard       Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  widgetType      WidgetType
  title           String

  // Data configuration
  dataSource      String?   // "cases", "rius", "campaigns", etc.
  queryConfig     Json?     // Filters, aggregation, grouping

  // Layout item (react-grid-layout format)
  layoutItem      Json      // { i: string, x, y, w, h, minW?, minH? }

  // Display options
  chartType       ChartType?
  displayConfig   Json?     // Colors, labels, formatting

  // Date range
  useDashboardDateRange Boolean @default(true)
  dateRangeOverride     Json?   // { preset: "LAST_30_DAYS" } or { start, end }

  // Refresh
  refreshInterval Int?      // Override dashboard interval (minutes)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([dashboardId])
}

enum WidgetType {
  KPI_CARD
  LINE_CHART
  BAR_CHART
  PIE_CHART
  DONUT_CHART
  AREA_CHART
  STACKED_BAR
  TABLE
  LIST
  HEATMAP
  FUNNEL
  GAUGE
  SPARKLINE
  QUICK_ACTIONS
}

enum ChartType {
  LINE
  BAR
  PIE
  DONUT
  AREA
  STACKED_BAR
  HEATMAP
  FUNNEL
  SCATTER
  GAUGE
}

// User's dashboard preferences
model UserDashboardConfig {
  id              String   @id @default(uuid())
  organizationId  String
  userId          String
  user            User     @relation(fields: [userId], references: [id])

  dashboardId     String
  dashboard       Dashboard @relation(fields: [dashboardId], references: [id], onDelete: Cascade)

  // User customizations
  isHome          Boolean  @default(false)  // User's home dashboard
  layoutOverrides Json?    // User's layout adjustments
  widgetOverrides Json?    // Per-widget user config

  // Preferences
  refreshInterval Int      @default(5)  // Minutes (1-30)
  dateRangePreset DateRangePreset @default(LAST_30_DAYS)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, dashboardId])
  @@index([userId, isHome])
  @@index([organizationId, userId])
}

enum DateRangePreset {
  TODAY
  LAST_7_DAYS
  LAST_30_DAYS
  LAST_90_DAYS
  LAST_12_MONTHS
  YEAR_TO_DATE
  CUSTOM
}
```

Run `npx prisma format` and `npx prisma generate`.
  </action>
  <verify>npx prisma format && npx prisma generate succeeds without errors</verify>
  <done>Dashboard, DashboardWidget, UserDashboardConfig models exist in schema with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create AnalyticsModule structure and DTOs</name>
  <files>
    apps/backend/src/modules/analytics/analytics.module.ts
    apps/backend/src/modules/analytics/dashboard/dto/dashboard.dto.ts
    apps/backend/src/modules/analytics/dashboard/entities/dashboard-config.entity.ts
  </files>
  <action>
Create the module structure:

1. Create `apps/backend/src/modules/analytics/analytics.module.ts`:
```typescript
import { Module } from '@nestjs/common';
import { DashboardConfigService } from './dashboard/dashboard-config.service';
import { DashboardController } from './dashboard/dashboard.controller';

@Module({
  imports: [],
  controllers: [DashboardController],
  providers: [DashboardConfigService],
  exports: [DashboardConfigService],
})
export class AnalyticsModule {}
```

2. Create DTOs in `dashboard/dto/dashboard.dto.ts`:
- CreateDashboardDto: name, description?, dashboardType, layouts, widgets[]
- UpdateDashboardDto: Partial of create
- CreateWidgetDto: widgetType, title, dataSource?, queryConfig?, layoutItem, chartType?, etc.
- UpdateWidgetDto: Partial of create
- DashboardLayoutDto: layouts object with lg, md, sm, xs arrays
- DateRangeDto: preset or { start, end }
- DashboardQueryDto: pagination, type filter

Use class-validator decorators for validation.

3. Create entity types in `entities/dashboard-config.entity.ts`:
- Export interfaces matching Prisma types for type safety
- Include LayoutItem interface matching react-grid-layout format
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>AnalyticsModule, DTOs, and entity types exist with proper validation</done>
</task>

<task type="auto">
  <name>Task 3: Implement DashboardConfigService</name>
  <files>apps/backend/src/modules/analytics/dashboard/dashboard-config.service.ts</files>
  <action>
Create DashboardConfigService with:

1. **Dashboard CRUD:**
   - `createDashboard(orgId, userId, dto)`: Create new dashboard with widgets
   - `getDashboard(orgId, id)`: Get single dashboard with widgets
   - `updateDashboard(orgId, id, dto)`: Update dashboard and widgets
   - `deleteDashboard(orgId, id)`: Soft delete dashboard
   - `listDashboards(orgId, query)`: List dashboards with pagination

2. **User Config:**
   - `getUserConfig(orgId, userId, dashboardId)`: Get user's config for dashboard
   - `saveUserConfig(orgId, userId, dashboardId, config)`: Save layout overrides
   - `setHomeDashboard(orgId, userId, dashboardId)`: Set as home (unset others)
   - `getUserDashboards(orgId, userId)`: List user's configured dashboards

3. **Default Dashboards:**
   - `getDefaultDashboard(orgId, type)`: Get default for dashboard type
   - `ensureDefaultDashboards(orgId)`: Create system defaults if not exist

4. **Widget Management:**
   - `addWidget(orgId, dashboardId, dto)`: Add widget to dashboard
   - `updateWidget(orgId, dashboardId, widgetId, dto)`: Update widget config
   - `removeWidget(orgId, dashboardId, widgetId)`: Remove widget

Emit events for audit: `dashboard.created`, `dashboard.updated`, `dashboard.widget.added`
  </action>
  <verify>npm run lint passes for the service file</verify>
  <done>DashboardConfigService implements full CRUD for dashboards, widgets, and user configurations</done>
</task>

</tasks>

<verification>
```bash
cd apps/backend
npx prisma format
npx prisma generate
npm run lint -- --fix
npm run typecheck
```
</verification>

<success_criteria>
- Dashboard, DashboardWidget, UserDashboardConfig models in Prisma schema
- AnalyticsModule with DashboardConfigService
- DTOs with class-validator decorators
- Service methods for dashboard CRUD, user config, and widget management
- Events emitted for audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/11-analytics-reporting/11-01-SUMMARY.md`
</output>
