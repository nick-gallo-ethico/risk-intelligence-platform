---
phase: 25.1-case-detail-page-vision-revision
plan: 02
subsystem: ui
tags:
  [react, shadcn, pipeline, stage-bar, tooltip, alert-dialog, tanstack-query]

# Dependency graph
requires:
  - phase: 25.1-01
    provides: PipelineStage type, record-detail directory structure
provides:
  - PipelineStageBar component for pipeline visualization
  - usePipeline hook for stage management
  - Click-to-advance with confirmation dialog pattern
affects: [25.1-case-detail-page-vision-revision, case-detail-page]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Sticky pipeline bar at top of center column"
    - "Click-to-advance with AlertDialog confirmation"
    - "Stage history tooltip pattern"
    - "Days-in-stage chip pattern"

key-files:
  created:
    - apps/frontend/src/components/record-detail/PipelineStageBar.tsx
  modified:
    - apps/frontend/src/hooks/usePipeline.ts
    - apps/backend/src/common/services/activity.service.ts

key-decisions:
  - "Stage circles use dynamic color from stage.color for current stage"
  - "Completed stages always show green with checkmark"
  - "Future stages show outline only, with hover state if transition allowed"
  - "Toast notifications via sonner for transition feedback"

patterns-established:
  - "PipelineStageBar: Reusable for any entity with pipeline stages"
  - "Stage transition requires canTransitionTo validation before showing dialog"
  - "Days display: 'Today', '1 day', 'N days' format"

# Metrics
duration: 25min
completed: 2026-02-13
---

# Phase 25.1 Plan 02: Pipeline Stage Bar Summary

**Sticky horizontal pipeline bar with visual stage states, click-to-advance confirmation dialog, and days-in-stage chip**

## Performance

- **Duration:** 25 min
- **Started:** 2026-02-13T23:10:41Z
- **Completed:** 2026-02-13T23:35:00Z
- **Tasks:** 2
- **Files modified:** 3

## Accomplishments

- PipelineStageBar component with position:sticky layout
- Visual distinction: completed (green + checkmark), current (colored + pulse), future (outlined)
- Click any stage opens AlertDialog with optional rationale textarea
- Hover tooltips show stage description, entry date, time in stage
- "In stage for N days" Badge chip below current stage

## Task Commits

Each task was committed atomically:

1. **Task 1: Create usePipeline hook** - `2e5fce3` (feat) - Already committed as part of Plan 01 parallel execution
2. **Task 2: Create PipelineStageBar component** - `fbb6516` (feat)

## Files Created/Modified

- `apps/frontend/src/components/record-detail/PipelineStageBar.tsx` - Sticky pipeline visualization with stage circles, connecting lines, tooltips, and confirmation dialog
- `apps/frontend/src/hooks/usePipeline.ts` - Hook for stage state management (already created in Plan 01)
- `apps/backend/src/common/services/activity.service.ts` - Added pinActivity and getStatusHistory methods (Rule 3 blocking fix)

## Decisions Made

- Stage circles are 32x32px with number inside for future stages
- Current stage uses pulsing ring animation with stage color
- Connecting lines: green for completed, gray for future
- Days chip shows "Today" for 0 days, "1 day" for 1, "N days" for N > 1
- Toast notifications via sonner for immediate feedback

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added pinActivity and getStatusHistory to ActivityService**

- **Found during:** Task 2 commit (pre-commit hook typecheck)
- **Issue:** CasesController called ActivityService.pinActivity and ActivityService.getStatusHistory which didn't exist
- **Fix:** Added both methods to ActivityService with proper tenant isolation
- **Files modified:** apps/backend/src/common/services/activity.service.ts
- **Verification:** npm run typecheck passes
- **Committed in:** fbb6516 (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Auto-fix was necessary to unblock commit. Methods implement expected behavior for activity pinning and status history retrieval.

## Issues Encountered

- Task 1 (usePipeline hook) was already committed as part of parallel Plan 01 execution. No duplicate work needed - verified hook exists and meets requirements.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- PipelineStageBar ready for integration into RecordDetailLayout
- Component is standalone and reusable for any entity type with pipeline stages
- usePipeline hook provides all state management needed for the component

---

_Phase: 25.1-case-detail-page-vision-revision_
_Completed: 2026-02-13_
