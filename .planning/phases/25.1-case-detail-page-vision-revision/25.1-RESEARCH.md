# Phase 25.1: Case Detail Page Vision Revision - Research

**Researched:** 2026-02-13
**Domain:** Frontend UI architecture - HubSpot-style record detail page rebuild
**Confidence:** HIGH (codebase examined, spec fully read, all components catalogued)

## Summary

Phase 25.1 requires a **major rebuild** of the Case Detail Page to match the HubSpot-style specification documented in `.planning/hubspot-view-system-spec.md` (Sections 12-23). The current implementation is a functional but incomplete three-column layout that Phase 25 incrementally improved. It does NOT match the owner's vision in several critical ways: no sticky pipeline stage bar, no Actions dropdown, flat properties panel instead of collapsible cards, Activities tab defaults first instead of Overview, tabs include a separate Summary tab that should be merged into Overview, no config-driven architecture, and the pipeline stages are hardcoded rather than tenant-configurable.

The spec is **extremely detailed** (1250+ lines, Sections 12-23) covering every element of the page: layout dimensions, column widths, scrolling behavior, responsive breakpoints, every field in every card, every modal, every filter, activity timeline patterns, per-activity actions (pin, comment, edit, delete), data models, API endpoints, and a component architecture reference.

**Primary recommendation:** Rebuild the page from the outside in -- start with the three-column layout + sticky pipeline bar + tab bar, then populate left sidebar cards, then Overview tab content, then Activities tab with HubSpot filters, then remaining tabs. Use a config-driven `CASES_DETAIL_CONFIG` object pattern so Investigation and other record types can reuse components.

---

## Current State Analysis

### Existing Components Inventory (63 files in `apps/frontend/src/components/cases/`)

**Page & Layout:**
| File | Purpose | Phase 25.1 Disposition |
|------|---------|----------------------|
| `[id]/page.tsx` (479 lines) | Main case detail page, three-column layout, all modal state | **MAJOR REFACTOR** - restructure around config-driven layout |
| `case-detail-layout.tsx` (239 lines) | Dead code - original layout with CaseActivityTimeline as center | **DELETE** - replaced by page.tsx |
| `case-tabs.tsx` (511 lines) | Tab component with 7 tabs, includes inline OverviewTab | **MAJOR REFACTOR** - change to 6 tabs, Overview as default, remove Summary, add pipeline bar |
| `case-detail-header.tsx` (416 lines) | Breadcrumb + reference + badges + pipeline progress + action buttons | **REFACTOR** - extract Actions dropdown, move action buttons into left sidebar |
| `case-info-summary.tsx` (247 lines) | Left column compact summary (ref#, status, severity, pipeline, days open) | **REFACTOR** - becomes the Case Header (top of left sidebar) per spec section 14.1 |

**Left Sidebar Components:**
| File | Purpose | Phase 25.1 Disposition |
|------|---------|----------------------|
| `case-properties-panel.tsx` (382 lines) | Flat list of editable fields in 6 sections (Status, Intake, Reporter, Location, Metadata, Attachments) | **MAJOR REFACTOR** - split into 3 collapsible cards: About This Case, Intake Information, Classification |
| `property-section.tsx` (82 lines) | Collapsible card wrapper using shadcn Collapsible | **REUSE** - foundation for collapsible property cards |
| `editable-field.tsx` (234 lines) | Inline edit for text/select/tags fields | **REUSE** as-is - matches spec's inline editing pattern |
| `action-button-row.tsx` (74 lines) | Quick action grid (Note, Email, Call, Interview, Document, Task) | **REUSE** with minor adjustments - already uses QuickActionGrid |

**Center Column - Tab Content:**
| File | Purpose | Phase 25.1 Disposition |
|------|---------|----------------------|
| `case-activity-timeline.tsx` (530 lines) | Activity timeline with filters, search, user dropdown, date grouping, upcoming section | **MAJOR REFACTOR** - add HubSpot-exact type checkboxes, pinning, per-activity actions |
| `activity-filters.tsx` (71 lines) | Tab-style filter (All/Notes/Status/Files) | **REPLACE** - needs checkbox-style filters per HubSpot pattern, many more types |
| `activity-entry.tsx` | Individual activity card | **REFACTOR** - add pin, comment, edit, copy link, delete actions |
| `summary-tab.tsx` (113 lines) | AI/manual summary + case details | **MERGE** into Overview tab - spec says Summary removed, content goes to Overview |
| `case-investigations-panel.tsx` | Investigations list | **REFACTOR** - add create, link existing, expandable cards with inline editing |
| `investigation-card.tsx` | Individual investigation card | **REFACTOR** - add expanded state with Details, Findings, Notes sections |
| `create-investigation-dialog.tsx` | Investigation creation modal | **REUSE** |
| `messages-tab.tsx` | Messages/communications tab | **REVIEW** - ensure reporter thread + email correspondence layout matches spec |
| `files-tab.tsx` | File management tab | **REVIEW** - ensure drag-drop, search, sort, tagging matches spec |
| `remediation-tab.tsx` | Remediation plan management | **REVIEW** - ensure progress bar, corrective actions, monitoring period matches spec |
| `remediation-step-card.tsx` | Individual remediation step | **REVIEW** |

**Right Sidebar Components:**
| File | Purpose | Phase 25.1 Disposition |
|------|---------|----------------------|
| `case-workflow-panel.tsx` (31 lines) | Wraps WorkflowStatusCard for cases | **REUSE** |
| `connected-people-card.tsx` (444 lines) | People with groups, labels, search, AssociationCard wrapper | **REUSE** as-is |
| `linked-rius-card.tsx` (83 lines) | Linked RIU intake records with AssociationCard wrapper | **REUSE** as-is |
| `related-cases-card.tsx` | Related cases association card | **REUSE** as-is |
| `related-policies-card.tsx` | Related policies association card | **REUSE** as-is |
| `connected-documents-card.tsx` | Documents association card | **REUSE** as-is |
| `ai-chat-panel.tsx` | AI assistant slide-over panel | **REUSE** as-is |

**Modals (all REUSE as-is):**
| File | Purpose |
|------|---------|
| `assign-modal.tsx` | Assign investigators |
| `status-change-modal.tsx` | Change case status |
| `merge-modal.tsx` | Merge cases |
| `add-note-modal.tsx` | Add note |
| `email-log-modal.tsx` | Log/compose email |
| `log-interview-modal.tsx` | Log interview |
| `attach-document-modal.tsx` | Attach document |
| `create-task-modal.tsx` | Create task |
| `log-call-modal.tsx` | Log call |
| `add-person-modal.tsx` | Add person association |

**Shared Components (REUSE):**
| File | Purpose |
|------|---------|
| `components/shared/quick-action-grid.tsx` | HubSpot-style icon+label grid with overflow dropdown |
| `components/ui/association-card.tsx` | HubSpot-style right sidebar card wrapper (collapsible, search, add, settings) |
| `components/workflows/workflow-progress-indicator.tsx` | Horizontal stage pipeline with circles and connectors |

---

## Detailed Gap Analysis: Spec vs Current State

### 1. Three-Column Layout (Spec Section 12)

| Spec Requirement                     | Current State                           | Gap                               |
| ------------------------------------ | --------------------------------------- | --------------------------------- |
| Left sidebar: 300px fixed            | Left sidebar: 300px fixed in grid       | **MATCH**                         |
| Center column: flexible              | Center column: 1fr in grid              | **MATCH**                         |
| Right sidebar: 300px fixed           | Right sidebar: 300px fixed in grid      | **MATCH**                         |
| Each column scrolls independently    | Left & right have overflow-y-auto       | **MATCH**                         |
| Responsive: drawers on tablet/mobile | Hidden on <lg, no drawer implementation | **GAP** - need slide-over drawers |
| Pipeline bar sticky at top of center | No pipeline bar in center column        | **MAJOR GAP**                     |

### 2. Breadcrumb Navigation (Spec Section 13)

| Spec Requirement                                       | Current State                                | Gap       |
| ------------------------------------------------------ | -------------------------------------------- | --------- |
| `<- Cases / CASE-2026-00142` above three-column layout | Breadcrumb in CaseDetailHeader above columns | **MATCH** |
| Copy icon next to reference number                     | Copy button exists in header                 | **MATCH** |

### 3. Left Sidebar (Spec Section 14)

| Spec Requirement                                                                                                | Current State                                                                                                                                      | Gap                                                                                                                                                                                                                                                 |
| --------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **14.1 Case Header** - ref#, status badge, severity badge, category, open date, case age, assigned to           | CaseInfoSummary has ref#, status, severity, pipeline stage, days open, created, SLA. Missing: category display, case age text, assigned-to avatars | **MINOR GAP** - enhance CaseInfoSummary                                                                                                                                                                                                             |
| **14.2 Actions Dropdown** - Assign, Change Status, Merge, Follow, View Properties, View History, Export, Delete | Action buttons (Assign, Status, Merge) are in the header (top of page), not left sidebar. No Follow, View Properties, View History, Export, Delete | **MAJOR GAP** - create ActionsDropdown component in left sidebar                                                                                                                                                                                    |
| **14.3 Quick Action Buttons** - Note, Email, Task, Document, Interview, More                                    | ActionButtonRow exists with Note, Email, Call, Interview, Document, Task using QuickActionGrid                                                     | **MINOR GAP** - reorder to match spec (Note, Email, Task, Document, Interview, More)                                                                                                                                                                |
| **14.4 About This Case** collapsible card with inline-editable fields                                           | CasePropertiesPanel has flat sections. PropertySection is collapsible.                                                                             | **MAJOR GAP** - restructure into "About This Case" card with spec fields (Status, Severity, Priority, Case Type, Source, Open Date, Target Close, SLA Due, Owner, Department)                                                                       |
| **14.5 Intake Information** collapsible card                                                                    | Reporter and Location sections exist in properties panel                                                                                           | **MAJOR GAP** - restructure into "Intake Information" card with all spec fields (Reporter Type, Name, Email, Phone, Access Code, Incident Date/Location/City/State/Country, Description, Persons Involved, Witnesses, Supporting Details, Addendum) |
| **14.6 Classification** collapsible card with dependent dropdowns                                               | Tags editable field exists; no category/subcategory dropdowns                                                                                      | **MAJOR GAP** - create Classification card with Primary Category dropdown, dependent Subcategory dropdown, Tags, Risk Level, Regulatory Framework                                                                                                   |
| **Admin Settings gear (all cards)** - field customization                                                       | PropertySection has a Settings2 gear icon (non-functional placeholder)                                                                             | **GAP** - need admin-only field customization panel                                                                                                                                                                                                 |

### 4. Center Column - Pipeline Stage Bar (Spec Section 15.1)

| Spec Requirement                                                                | Current State                                                                                                                          | Gap                                                                       |
| ------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| Sticky horizontal progress bar at top of center column                          | No pipeline bar in center column. Existing pipeline is in: (a) OverviewTab as numbered circles, (b) CaseDetailHeader as a progress bar | **MAJOR GAP** - create PipelineStageBar component                         |
| Shows: New -> Assigned -> Active -> Review -> Closed -> Remediation -> Archived | Hardcoded: "New, Triage, Investigation, Review, Closed" (case-tabs.tsx) or "INTAKE, TRIAGE, INVESTIGATION, REVIEW, CLOSURE" (header)   | **MAJOR GAP** - stages must match spec default and be tenant-configurable |
| Click-to-advance with confirmation dialog                                       | No click interaction on pipeline                                                                                                       | **MAJOR GAP**                                                             |
| "In stage for: N days" chip                                                     | Not implemented                                                                                                                        | **GAP**                                                                   |
| Hover tooltip (description, date entered, time in stage)                        | Not implemented                                                                                                                        | **GAP**                                                                   |
| Tenant-configurable stages                                                      | Hardcoded stages in frontend                                                                                                           | **MAJOR GAP** - need API integration with `/api/pipelines`                |

### 5. Center Column - Tab Bar (Spec Section 15.2)

| Spec Requirement                                                           | Current State                                                                                 | Gap                                                                      |
| -------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| 6 tabs: Overview, Activities, Investigations, Messages, Files, Remediation | 7 tabs: Activities (default), Overview, Summary, Investigations, Messages, Files, Remediation | **GAP** - remove Summary tab, merge into Overview, make Overview default |
| Overview is default tab                                                    | Activities is default tab                                                                     | **GAP**                                                                  |
| Tab state NOT in URL                                                       | Tab state IS in URL (searchParams)                                                            | **GAP** - remove URL sync                                                |
| No icons on tab triggers (just text labels)                                | Icons on each tab trigger                                                                     | **MINOR GAP** - remove icons for cleaner look                            |

### 6. Overview Tab (Spec Section 16.1)

| Spec Requirement                                                                      | Current State                                                | Gap                                                                 |
| ------------------------------------------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------------- |
| **A. Data Highlights Card** - 4-6 key property values in grid                         | Not implemented                                              | **NEW** component needed                                            |
| **B. Editable Case Summary** with AI generation                                       | SummaryTab has read-only display of AI/manual summary        | **MAJOR GAP** - needs inline editing, AI generate/regenerate button |
| **C. Case Details (Collapsible)** - comprehensive property list, collapsed by default | OverviewTab has case details section (always visible, brief) | **GAP** - make collapsible, add more fields                         |
| **D. Status Change Timeline** - vertical timeline with dots, dates, users, rationale  | Not implemented on Overview                                  | **NEW** component needed                                            |
| **E. Recent Activities** - 3 most recent with "View all" link                         | Not implemented on Overview                                  | **NEW** component needed                                            |
| **F. Upcoming Tasks** - 3 nearest tasks with checkboxes                               | Not implemented on Overview                                  | **NEW** component needed                                            |
| Lifecycle pipeline visualization                                                      | OverviewTab has numbered circles pipeline                    | **REMOVE** from Overview - pipeline is now sticky bar above tabs    |

### 7. Activities Tab (Spec Section 16.2)

| Spec Requirement                                                                                         | Current State                                                                                                                              | Gap                                                                 |
| -------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------- |
| **Filter bar**: "Filter activity (N/M)", All users dropdown, All teams dropdown, Search, Type checkboxes | Partial: search bar, 4 filter tabs (All/Notes/Status/Files), user dropdown. Missing: activity count (N/M), teams dropdown, type checkboxes | **MAJOR GAP** - rebuild filter bar with checkbox-style type filters |
| **Activity types**: Note, Email, Call, Task, Interview, Document, Status Change, System Event (8 types)  | Only 3 filter types (notes, status, files)                                                                                                 | **MAJOR GAP** - support all 8+ activity types                       |
| **Per-activity actions**: Pin, Comment, Edit, Copy link, Delete (hover-reveal)                           | No per-activity actions                                                                                                                    | **MAJOR GAP**                                                       |
| **Pinned activities section** above chronological                                                        | Not implemented                                                                                                                            | **MAJOR GAP**                                                       |
| **Date grouping** with "Upcoming" section                                                                | Date grouping exists; Upcoming section exists for tasks/SLA                                                                                | **PARTIAL MATCH**                                                   |
| **Expand/collapse** for long content                                                                     | Not implemented                                                                                                                            | **GAP**                                                             |

### 8. Right Sidebar (Spec Section 17)

| Spec Requirement                                                                           | Current State                                                           | Gap                                                |
| ------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------- | -------------------------------------------------- |
| 9 cards: Workflow, People, RIUs, Cases, Policies, Documents, Tasks, Remediation Status, AI | 6 cards: Workflow, People, RIUs, Cases, Policies, Documents + AI button | **GAP** - need Tasks card, Remediation Status card |
| Tasks card - open/completed tasks with checkboxes                                          | Not implemented                                                         | **NEW** component needed                           |
| Remediation Status card - progress bar, next action                                        | Not implemented                                                         | **NEW** component needed                           |

### 9. Config-Driven Architecture (Spec Section 21)

| Spec Requirement                                                   | Current State                                              | Gap                                                               |
| ------------------------------------------------------------------ | ---------------------------------------------------------- | ----------------------------------------------------------------- |
| `CASES_DETAIL_CONFIG` object defining tabs, cards, fields, actions | Hardcoded in page.tsx and case-tabs.tsx                    | **MAJOR GAP** - need config object and RecordDetailLayout wrapper |
| `RecordDetailLayout` reusable three-column wrapper                 | Not implemented (dead case-detail-layout.tsx is different) | **NEW** component needed                                          |
| Hooks: useCaseDetail, useActivities, usePipeline, etc.             | Basic fetchCase in page.tsx, fetchActivities in timeline   | **GAP** - extract into proper hooks                               |

### 10. Data Model Gaps

| Spec Requirement                                           | Current State                                                    | Gap                                                           |
| ---------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------------------------------- |
| `CaseStatus`: enum includes pipeline stages                | `CaseStatus = "NEW" \| "OPEN" \| "CLOSED"` (3 values)            | **MAJOR GAP** - status vs pipeline stage separation           |
| `pipelineStage`: separate field, tenant-configurable       | `pipelineStage?: string` exists but stages hardcoded on frontend | **GAP** - need PipelineConfig API                             |
| `Severity`: includes CRITICAL                              | `Severity = "LOW" \| "MEDIUM" \| "HIGH"` (no CRITICAL)           | **GAP** - add CRITICAL                                        |
| `CaseActivity` model with isPinned, comments, visibility   | `Activity` type has no pinning, comments, or visibility          | **MAJOR GAP** - extend Activity type                          |
| `PipelineConfig` and `PipelineStage` interfaces            | Not implemented in frontend types                                | **NEW** types needed                                          |
| `RecordCardConfig` and `CardField` for admin customization | Not implemented                                                  | **NEW** types needed (future: admin config)                   |
| `CaseCategory` with subcategories                          | `CaseCategory` exists but no subcategory structure               | **GAP** - exists as `useTenantCategories` with tree structure |

---

## Architecture Patterns

### Recommended Project Structure

Based on the spec's Section 21 component architecture:

```
components/
├── record-detail/                    # NEW - shared record detail components
│   ├── RecordDetailLayout.tsx        # Three-column layout wrapper with config
│   ├── PipelineStageBar.tsx          # Sticky pipeline visualization
│   ├── TabBar.tsx                    # Tab navigation (can reuse shadcn Tabs)
│   ├── ActionsDropdown.tsx           # "Actions ▼" menu
│   ├── RecordHeader.tsx              # Left sidebar header (ref#, badges, etc.)
│   ├── CollapsiblePropertyCard.tsx   # Card with inline-editable fields
│   ├── DataHighlightsCard.tsx        # 4-6 key values grid
│   ├── EditableSummary.tsx           # Rich text summary with AI
│   ├── StatusHistoryTimeline.tsx     # Vertical status change timeline
│   └── CollapsibleSection.tsx        # Generic expand/collapse
├── cases/                            # Existing - case-specific components
│   ├── ... (existing modals, tabs, etc.)
│   └── ... (refactored components)
config/
└── casesDetailConfig.ts              # NEW - CASES_DETAIL_CONFIG object
hooks/
├── useCaseDetail.ts                  # NEW - case data fetching/mutation
├── useActivities.ts                  # NEW - activity CRUD, filtering, pinning
├── usePipeline.ts                    # NEW - pipeline stage management
└── useRecordCards.ts                 # NEW - card configuration
```

### Pattern 1: Config-Driven Module Architecture

The spec prescribes a config object that drives the entire page layout:

```typescript
// config/casesDetailConfig.ts
export const CASES_DETAIL_CONFIG: RecordDetailConfig = {
  moduleType: "cases",
  pipeline: { enabled: true, configEndpoint: "/api/pipelines" },
  tabs: [
    {
      id: "overview",
      label: "Overview",
      component: OverviewTab,
      isDefault: true,
    },
    { id: "activities", label: "Activities", component: ActivitiesTab },
    // ... etc
  ],
  leftSidebar: {
    cards: [
      {
        id: "about",
        type: "about",
        label: "About This Case",
        collapsedByDefault: false,
      },
      {
        id: "intake",
        type: "intake",
        label: "Intake Information",
        collapsedByDefault: true,
      },
      {
        id: "classification",
        type: "classification",
        label: "Classification",
        collapsedByDefault: false,
      },
    ],
  },
  rightSidebar: {
    cards: [
      /* ... */
    ],
  },
  quickActions: ["note", "email", "task", "document", "interview"],
  actionsMenu: [
    "assign",
    "change_status",
    "merge",
    "follow",
    "view_properties",
    "view_history",
    "export",
    "delete",
  ],
};
```

### Pattern 2: Sticky Pipeline Bar

```typescript
// Position: sticky at top of center column
<div className="sticky top-0 z-10 bg-white border-b">
  <PipelineStageBar
    stages={pipelineConfig.stages}
    currentStage={caseData.pipelineStage}
    onStageClick={handleStageTransition}
  />
</div>
```

### Pattern 3: Collapsible Left Sidebar Cards

Reuse existing `PropertySection` component (already implements shadcn Collapsible) but adapt to spec's card pattern. Each card uses `EditableField` for inline editing.

### Anti-Patterns to Avoid

- **Monolithic page component:** Current page.tsx manages 9+ modal states. Extract into a modal manager hook or context.
- **Hardcoded pipeline stages:** Current stages are strings in JSX. Must come from API / config.
- **Tab state in URL:** Spec explicitly says no URL state for tabs. Remove searchParams usage.
- **Separate Summary tab:** Spec merged Summary into Overview. Don't keep both.

---

## Don't Hand-Roll

| Problem                | Don't Build                 | Use Instead                                                | Why                                   |
| ---------------------- | --------------------------- | ---------------------------------------------------------- | ------------------------------------- |
| Collapsible sections   | Custom expand/collapse      | `PropertySection` (existing) wrapping shadcn `Collapsible` | Already tested, matches pattern       |
| Association cards      | Custom card for each entity | `AssociationCard` (existing)                               | Consistent HubSpot pattern            |
| Quick action grid      | Custom button layout        | `QuickActionGrid` (existing)                               | Handles overflow dropdown             |
| Pipeline visualization | New pipeline component      | Adapt `WorkflowProgressIndicator` (existing)               | Has stage circles, connectors, labels |
| Inline editing         | New edit components         | `EditableField` (existing)                                 | Supports text, select, tags           |
| Category tree          | Custom tree selector        | `useTenantCategories` hook + adapt `CategorySelector`      | Tree building, caching built in       |
| Activity date grouping | Custom date grouping        | `groupByDate` from `@/lib/date-utils`                      | Already tested                        |

---

## Common Pitfalls

### Pitfall 1: Not Making Pipeline Stages Truly Configurable

**What goes wrong:** Hardcoding stage names/colors means every tenant gets the same stages. The spec REQUIRES tenant configurability.
**Why it happens:** Tempting to start with hardcoded defaults and "add API later."
**How to avoid:** Build the PipelineStageBar to accept stages as props from day one. Use a default constant but always render from data, never from JSX.
**Warning signs:** Stage names appear as string literals in components.

### Pitfall 2: Trying to Build Everything at Once

**What goes wrong:** The spec is 1250+ lines. Attempting to implement all of it in one pass leads to regressions and tangled state.
**How to avoid:** Build in layers: layout first, then populate each section. Verify each layer works before adding the next.

### Pitfall 3: Breaking Existing Modal Functionality

**What goes wrong:** During the restructure, existing modals (Assign, Status Change, Merge, Add Note, etc.) stop working.
**How to avoid:** Keep all modal state management working throughout. Move modals to the new page structure carefully, testing each one.

### Pitfall 4: Forgetting Activity Tab Type Expansion

**What goes wrong:** The spec defines 8+ activity types (note, email, call, task, interview, document_upload, status_change, assignment_change, system_event) but current filters only support 4.
**How to avoid:** Update `ActivityFilterType` and filter logic BEFORE building the new filter UI.

### Pitfall 5: Status vs Pipeline Stage Confusion

**What goes wrong:** The current `CaseStatus` enum (NEW/OPEN/CLOSED) conflates with pipeline stages. The spec separates them: pipeline stages are the lifecycle progression (New -> Assigned -> Active -> Review -> Closed -> Remediation -> Archived), while status is a simpler open/closed concept.
**How to avoid:** The `pipelineStage` field on Case already exists. Use it for the pipeline bar. Don't try to map CaseStatus to pipeline stages.

---

## Backend API Assessment

### Existing Backend Endpoints (from `cases.controller.ts` and `cases-api.ts`)

| Endpoint                   | Exists? | Notes                                               |
| -------------------------- | ------- | --------------------------------------------------- |
| `GET /cases/:id`           | Yes     | Returns full case with associations                 |
| `PATCH /cases/:id`         | Yes     | Update case properties                              |
| `PATCH /cases/:id/status`  | Yes     | Change status                                       |
| `POST /cases/:id/assign`   | Likely  | (AssignModal uses it)                               |
| `POST /cases/:id/merge`    | Yes     | CaseMergeService exists                             |
| `GET /activity/CASE/:id`   | Yes     | Activity timeline endpoint                          |
| `GET /cases/:id/persons`   | Yes     | Connected people                                    |
| `GET /cases/:id/activity`  | Yes     | Fallback activity endpoint                          |
| `case-pipeline.service.ts` | Yes     | `moveToStage`, `setOutcome`, `updateClassification` |

### Backend Endpoints Needed (from spec Section 20)

| Endpoint                                              | Status                                                     | Priority  |
| ----------------------------------------------------- | ---------------------------------------------------------- | --------- |
| `GET /api/pipelines`                                  | **NEEDED** - PipelineConfig API for tenant stages          | HIGH      |
| `PUT /api/cases/:id/activities/:activityId/pin`       | **NEEDED** - Pin/unpin activity                            | MEDIUM    |
| `POST /api/cases/:id/activities/:activityId/comments` | **NEEDED** - Activity comments                             | MEDIUM    |
| `GET /api/categories`                                 | **EXISTS** - `useTenantCategories` fetches from public API | Available |
| `GET /api/record-cards`                               | **DEFERRED** - Admin card config (future)                  | LOW       |
| `GET /api/cases/:id/status-history`                   | **NEEDED** - Status change timeline                        | MEDIUM    |
| Messages endpoints                                    | **CHECK** - May exist via messaging module                 | MEDIUM    |
| Remediation endpoints                                 | **EXISTS** - Full remediation module exists                | Available |

### Pipeline API Critical Path

The `case-pipeline.service.ts` backend service already has `moveToStage` which accepts a free-form stage string. The frontend just needs a way to fetch available stages per tenant. Options:

1. **Quick path:** Define default stages as a frontend constant, call `moveToStage` with stage name. Backend already supports this.
2. **Full path:** Create a `GET /api/pipelines` endpoint that returns `PipelineConfig` with stages per tenant. This is the correct long-term approach.

**Recommendation:** Start with frontend constant for default stages (matching spec's 7 stages), but build PipelineStageBar to accept stages as props so backend integration is trivial later.

---

## Complexity Estimate and Plan Count

### Estimated Plans: 8-10

| Plan # | Scope                                                                                                                                              | Complexity | Est. Hours |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------------- | ---------- | ---------- |
| 1      | **Layout & Config Foundation** - Create `CASES_DETAIL_CONFIG`, `RecordDetailLayout`, restructure page.tsx, delete dead code                        | HIGH       | 3-4h       |
| 2      | **Sticky Pipeline Stage Bar** - PipelineStageBar component with click-to-advance, confirmation dialog, "in stage for N days", default stages       | HIGH       | 3-4h       |
| 3      | **Left Sidebar Restructure** - Case Header, Actions dropdown, restructure properties into 3 collapsible cards (About, Intake, Classification)      | HIGH       | 3-4h       |
| 4      | **Classification Card & Categories** - Dependent category/subcategory dropdowns, risk level, regulatory framework, tags                            | MEDIUM     | 2-3h       |
| 5      | **Overview Tab Rebuild** - Data Highlights, Editable Summary with AI, Collapsible Case Details, Status Timeline, Recent Activities, Upcoming Tasks | HIGH       | 3-4h       |
| 6      | **Activities Tab HubSpot Pattern** - Checkbox type filters, user/team filters, search, pinning, per-activity actions (pin/comment/edit/delete)     | HIGH       | 3-4h       |
| 7      | **Tab Cleanup & Messages/Files** - Fix tab config (6 tabs, Overview default, no URL state), review Messages and Files tabs against spec            | MEDIUM     | 2-3h       |
| 8      | **Right Sidebar Additions** - Tasks card, Remediation Status card, ensure all 9 cards present                                                      | MEDIUM     | 2-3h       |
| 9      | **Responsive & Polish** - Tablet/mobile drawers, keyboard shortcuts, loading/error/empty states, collapsible state persistence                     | MEDIUM     | 2-3h       |
| 10     | **Backend API Integration** - Pipeline config endpoint, activity pinning, status history, wire up any missing endpoints                            | MEDIUM     | 2-3h       |

**Total estimated: 25-35 hours across 8-10 plans**

---

## Key Decisions Already Made (from Context)

These are locked decisions from prior conversation -- research supports them, do not revisit:

1. **Actions dropdown placement:** Left sidebar, below case header (HubSpot-style)
2. **Tab order:** Overview (default), Activities, Investigations, Messages, Files, Remediation (6 total)
3. **Summary tab REMOVED:** Content merged into Overview tab
4. **Left sidebar cards:** 3 collapsible cards (About This Case, Intake Information, Classification)
5. **Pipeline stages default:** New > Assigned > Active > Review > Closed > Remediation > Archived
6. **Pipeline stages configurable per tenant**
7. **Categories:** Dropdown + dependent sub-dropdown (tenant-configurable)
8. **Right sidebar:** Keep existing cards + add Tasks and Remediation Status
9. **Activities tab:** Exact HubSpot pattern with type checkboxes, user/team filter, search, pinning
10. **No URL state for tabs**
11. **Messages tab:** Official communications only (reporter messages, platform emails, forwarded emails) -- NOT team chat
12. **Overview tab content:** lifecycle stages, key metrics, editable summary, collapsible case details, status timeline, recent activities, upcoming tasks
13. **Admin-only left sidebar field customization** (gear icon, future implementation)

---

## Components That Can Be REUSED (No/Minor Changes)

1. `PropertySection` - collapsible card wrapper
2. `EditableField` - inline editing (text, select, tags)
3. `QuickActionGrid` - quick action buttons grid
4. `AssociationCard` - right sidebar card wrapper
5. `WorkflowProgressIndicator` - pipeline visualization (adapt for PipelineStageBar)
6. All 10 modals (AssignModal, StatusChangeModal, MergeModal, AddNoteModal, EmailLogModal, LogInterviewModal, AttachDocumentModal, CreateTaskModal, LogCallModal, AddPersonModal)
7. All 5 right sidebar cards (ConnectedPeopleCard, LinkedRiusCard, RelatedCasesCard, RelatedPoliciesCard, ConnectedDocumentsCard)
8. `CaseWorkflowPanel` - workflow status card wrapper
9. `AiChatPanel` - AI assistant slide-over
10. `useTenantCategories` hook - category tree fetching

## Components That Need MAJOR REFACTORING

1. `page.tsx` (case detail page) - restructure around config-driven layout
2. `case-tabs.tsx` - change tabs, remove Summary, make Overview default, remove URL state
3. `case-properties-panel.tsx` - split into 3 collapsible cards
4. `case-activity-timeline.tsx` - add HubSpot filter pattern, pinning, per-activity actions
5. `activity-filters.tsx` - replace tab-style with checkbox-style
6. `case-detail-header.tsx` - simplify to breadcrumb only, move actions to left sidebar

## Components That Need to Be CREATED NEW

1. `RecordDetailLayout.tsx` - config-driven three-column layout
2. `PipelineStageBar.tsx` - sticky pipeline visualization with interactions
3. `ActionsDropdown.tsx` - Actions menu for left sidebar
4. `DataHighlightsCard.tsx` - 4-6 key property values grid
5. `EditableSummary.tsx` - rich text summary with AI generate
6. `StatusHistoryTimeline.tsx` - vertical status change timeline
7. `TasksCard.tsx` - right sidebar tasks card
8. `RemediationStatusCard.tsx` - right sidebar remediation progress card
9. `casesDetailConfig.ts` - config object
10. `useCaseDetail.ts` hook - case data management
11. `useActivities.ts` hook - activity CRUD, filtering, pinning
12. `usePipeline.ts` hook - pipeline stage management

## Dead Code to REMOVE

1. `case-detail-layout.tsx` (239 lines) - replaced by page.tsx, confirmed dead code
2. `case-header.tsx` - if it exists as a separate file from `case-detail-header.tsx`, check if dead

---

## State of the Art

| Old Approach (Phase 25)                | New Approach (Phase 25.1)                      | Impact                            |
| -------------------------------------- | ---------------------------------------------- | --------------------------------- |
| Monolithic page.tsx managing all state | Config-driven `RecordDetailLayout` + hooks     | Reusable across record types      |
| Hardcoded pipeline stages in JSX       | Dynamic stages from config/API                 | Tenant-configurable               |
| Tab-style activity filters (4 types)   | Checkbox-style filters (8+ types) with pinning | Matches HubSpot pattern           |
| Flat properties panel                  | 3 collapsible cards with inline editing        | Better information architecture   |
| Actions in top header bar              | Actions dropdown in left sidebar               | HubSpot pattern, less top clutter |
| Summary as separate tab                | Summary merged into Overview                   | Fewer tabs, better default view   |
| URL-synced tab state                   | No URL state                                   | Spec requirement                  |

---

## Open Questions

1. **Pipeline Configuration API:** Backend `case-pipeline.service.ts` supports free-form stage strings. Should we create a formal `GET /api/pipelines` endpoint now, or use frontend constants and add the API later?
   - **Recommendation:** Use frontend constants for now. Build PipelineStageBar to accept stages as props. Add API in a separate plan when admin settings are built.

2. **Activity Pinning Backend:** The spec requires `PUT /api/cases/:id/activities/:activityId/pin`. This likely needs a new `isPinned` field on the AuditLog/Activity model.
   - **Recommendation:** Add `isPinned` to activity model as part of the Activities tab plan. If backend changes are blocked, implement pinning as client-side state (localStorage) first.

3. **Status History Endpoint:** The Overview tab needs a status change timeline. Is this data available from the existing activity/audit log, or does it need a dedicated endpoint?
   - **Recommendation:** Filter existing activity data for `status_changed` actions. No new endpoint needed if activity data includes rationale.

4. **Admin Field Customization:** The spec mentions admin-configurable card fields. Should this be implemented in Phase 25.1?
   - **Recommendation:** NO. Add the gear icon (already exists in PropertySection) but make it non-functional. Defer admin customization to a future phase. The gear icon serves as a placeholder.

5. **Keyboard Shortcuts:** Spec mentions N for new note, Esc for close modals. Priority?
   - **Recommendation:** LOW priority. Implement Esc for modals (likely already works). Defer tab-specific shortcuts.

---

## Sources

### Primary (HIGH confidence)

- `.planning/hubspot-view-system-spec.md` (Sections 12-23) - Authoritative spec for the page
- All source files examined in `apps/frontend/src/components/cases/` (63 files)
- `apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx` - Current implementation
- `apps/frontend/src/types/case.ts` and `apps/frontend/src/types/activity.ts` - Type definitions
- `apps/backend/src/modules/cases/` - Backend endpoints and services
- `apps/frontend/src/types/workflow.ts` - Workflow type system

### Secondary (MEDIUM confidence)

- HubSpot documentation references in spec Section 23 (not fetched, but spec is authoritative)
- Phase 25 completion state inferred from existing code

## Metadata

**Confidence breakdown:**

- Current state analysis: HIGH - Read every component file
- Gap analysis: HIGH - Compared spec line-by-line with code
- Architecture patterns: HIGH - Based on spec Section 21 prescriptions
- Complexity estimate: MEDIUM - Estimates based on component counts and complexity
- Backend assessment: MEDIUM - Read controller and pipeline service, inferred rest

**Research date:** 2026-02-13
**Valid until:** 2026-03-13 (stable domain, spec is locked)
