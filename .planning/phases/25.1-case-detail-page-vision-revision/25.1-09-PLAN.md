---
phase: 25.1-case-detail-page-vision-revision
plan: 09
type: execute
wave: 4
depends_on: [01, 03, 05, 06, 07, 08]
files_modified:
  - apps/frontend/src/components/record-detail/RecordDetailLayout.tsx
  - apps/frontend/src/components/record-detail/MobileSidebarDrawer.tsx
  - apps/frontend/src/hooks/useCollapsibleState.ts
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/loading.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/error.tsx
autonomous: true

must_haves:
  truths:
    - "Three-column layout collapses to single column with drawer toggles below 1280px"
    - "Tablet (768-1279px): left and right sidebars become slide-over drawers with toggle buttons"
    - "Mobile (<768px): single column with toggle between panels"
    - "Loading state shows skeleton placeholders for all three columns"
    - "Error state shows error message with retry button"
    - "Collapsible card state (About, Intake, Classification) persists via localStorage"
  artifacts:
    - path: "apps/frontend/src/components/record-detail/MobileSidebarDrawer.tsx"
      provides: "Slide-over drawer for tablet/mobile sidebar access"
      contains: "MobileSidebarDrawer"
    - path: "apps/frontend/src/hooks/useCollapsibleState.ts"
      provides: "localStorage-backed collapsible state persistence"
      contains: "useCollapsibleState"
    - path: "apps/frontend/src/app/(authenticated)/cases/[id]/loading.tsx"
      provides: "Skeleton loading state for case detail page"
      contains: "Loading"
  key_links:
    - from: "apps/frontend/src/components/record-detail/RecordDetailLayout.tsx"
      to: "MobileSidebarDrawer"
      via: "responsive drawer rendering"
      pattern: "MobileSidebarDrawer"
    - from: "apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx"
      to: "useCollapsibleState"
      via: "hook usage for left sidebar cards"
      pattern: "useCollapsibleState"
---

<objective>
Add responsive behavior (tablet/mobile drawers), loading/error states, and collapsible state persistence to the Case Detail Page.

Purpose: The three-column layout must degrade gracefully on smaller screens. Users on tablets should access sidebars via slide-over drawers. Loading and error states prevent blank screens. Collapsible card state persistence avoids annoying resets when navigating away and back.
Output: MobileSidebarDrawer.tsx, responsive RecordDetailLayout, loading.tsx, error.tsx, useCollapsibleState hook.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25.1-case-detail-page-vision-revision/25.1-RESEARCH.md

# Key source files

@apps/frontend/src/components/record-detail/RecordDetailLayout.tsx
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
@apps/frontend/src/components/cases/property-section.tsx
@.planning/hubspot-view-system-spec.md (Section 12 — Responsive behavior)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add responsive behavior to RecordDetailLayout</name>
  <files>
    apps/frontend/src/components/record-detail/RecordDetailLayout.tsx
    apps/frontend/src/components/record-detail/MobileSidebarDrawer.tsx
  </files>
  <action>
1. **Create MobileSidebarDrawer** at `apps/frontend/src/components/record-detail/MobileSidebarDrawer.tsx`:

```typescript
interface MobileSidebarDrawerProps {
  isOpen: boolean;
  onClose: () => void;
  side: "left" | "right";
  title?: string;
  children: React.ReactNode;
}
```

Implementation:

- Use shadcn Sheet component (already available) configured for left or right side
- The Sheet opens as a slide-over drawer, 320px wide
- Overlay darkens the background
- Close button (X) in top-right of drawer
- Content scrolls independently within the drawer
- Drawer closes on overlay click or close button

2. **Update RecordDetailLayout** to support responsive breakpoints:

a. Add state for drawer open/close: `leftDrawerOpen`, `rightDrawerOpen`
b. Use a media query hook (or `useMediaQuery` from existing utils, or a simple `useEffect` with `window.matchMedia`):

- `isDesktop`: `min-width: 1280px`
- `isTablet`: `768px - 1279px`
- `isMobile`: `< 768px`

c. **Desktop (>=1280px):** Current three-column grid layout. No change.

d. **Tablet (768-1279px):**

- Center column takes full width
- Left sidebar content rendered inside `<MobileSidebarDrawer side="left">`
- Right sidebar content rendered inside `<MobileSidebarDrawer side="right">`
- Two small toggle buttons (floating or sticky) for opening each drawer:
  - Left: hamburger-like icon in top-left of center column
  - Right: panel icon in top-right of center column
- Buttons positioned at the top of the center column, before the pipeline bar

e. **Mobile (<768px):**

- Same as tablet behavior but drawers are full-width (100vw)
- Only one drawer can be open at a time

f. Keep the `config` prop usage — responsive behavior is internal to the layout component.

3. Add transition animations:
   - Drawers slide in/out (Sheet already handles this via Radix UI)
   - Toggle buttons have subtle hover effect

IMPORTANT: The three-column grid CSS should use responsive Tailwind classes:

```
// Desktop: three columns
// Tablet/Mobile: single column (center only)
className="flex-1 grid grid-cols-1 xl:grid-cols-[300px_1fr_300px] min-h-0"
```

On non-desktop, hide the direct left/right sidebar divs (they render inside drawers instead).
</action>
<verify> - Desktop (>=1280px): three-column layout unchanged - Tablet (768-1279px): center column fills width, toggle buttons visible, drawers open/close - Mobile (<768px): single column, full-width drawers - Drawers show correct sidebar content - Toggle buttons are accessible and have clear icons - TypeScript compiles
</verify>
<done>RecordDetailLayout responsive with drawer-based sidebars on tablet/mobile</done>
</task>

<task type="auto">
  <name>Task 2: Add loading/error states and collapsible persistence</name>
  <files>
    apps/frontend/src/app/(authenticated)/cases/[id]/loading.tsx
    apps/frontend/src/app/(authenticated)/cases/[id]/error.tsx
    apps/frontend/src/hooks/useCollapsibleState.ts
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
1. **Create loading.tsx** (Next.js loading state):

```typescript
export default function CaseDetailLoading() {
  return (
    <div className="flex flex-col h-full">
      {/* Breadcrumb skeleton */}
      <div className="flex-shrink-0 border-b bg-white px-4 py-2">
        <Skeleton className="h-5 w-64" />
      </div>

      {/* Three-column skeleton */}
      <div className="flex-1 grid grid-cols-1 xl:grid-cols-[300px_1fr_300px] min-h-0">
        {/* Left sidebar skeleton */}
        <div className="hidden xl:block border-r bg-white p-4 space-y-4">
          <Skeleton className="h-24 w-full" /> {/* Header */}
          <Skeleton className="h-10 w-full" /> {/* Quick actions */}
          <Skeleton className="h-40 w-full" /> {/* About card */}
          <Skeleton className="h-32 w-full" /> {/* Intake card */}
        </div>

        {/* Center column skeleton */}
        <div className="bg-gray-50 p-4 space-y-4">
          <Skeleton className="h-12 w-full" /> {/* Pipeline bar */}
          <Skeleton className="h-10 w-full" /> {/* Tab bar */}
          <Skeleton className="h-64 w-full" /> {/* Tab content */}
        </div>

        {/* Right sidebar skeleton */}
        <div className="hidden xl:block border-l bg-white p-4 space-y-4">
          <Skeleton className="h-20 w-full" /> {/* Workflow */}
          <Skeleton className="h-32 w-full" /> {/* People */}
          <Skeleton className="h-24 w-full" /> {/* RIUs */}
        </div>
      </div>
    </div>
  );
}
```

Use shadcn Skeleton component for all placeholder shapes.

2. **Create error.tsx** (Next.js error boundary):

```typescript
'use client';

interface ErrorProps {
  error: Error & { digest?: string };
  reset: () => void;
}

export default function CaseDetailError({ error, reset }: ErrorProps) {
  return (
    <div className="flex flex-col items-center justify-center h-full p-8">
      <AlertCircle className="h-12 w-12 text-destructive mb-4" />
      <h2 className="text-xl font-semibold mb-2">Failed to load case</h2>
      <p className="text-muted-foreground mb-4 text-center max-w-md">
        {error.message || 'An unexpected error occurred while loading the case details.'}
      </p>
      <div className="flex gap-3">
        <Button onClick={reset}>Try Again</Button>
        <Button variant="outline" onClick={() => window.history.back()}>
          Go Back
        </Button>
      </div>
    </div>
  );
}
```

3. **Create useCollapsibleState hook** at `apps/frontend/src/hooks/useCollapsibleState.ts`:

```typescript
/**
 * Persists collapsible card open/closed state in localStorage.
 * Key format: `collapsible-{caseId}-{cardId}`
 *
 * Returns [isOpen, setIsOpen] similar to useState.
 * Initializes from localStorage, falls back to defaultOpen.
 */
export function useCollapsibleState(
  storageKey: string,
  defaultOpen: boolean = true,
): [boolean, (open: boolean) => void] {
  // Read initial value from localStorage
  // On set, write to localStorage
  // Use useState internally
}
```

Implementation:

- On mount, read from `localStorage.getItem(storageKey)`
- If value exists, parse as boolean. Otherwise use `defaultOpen`.
- On setIsOpen, update both state and localStorage.
- Handle SSR gracefully (typeof window check).

4. **Wire useCollapsibleState into page.tsx** for the 3 left sidebar property cards:

In page.tsx (or wherever CollapsiblePropertyCard is rendered for About, Intake, Classification):

```typescript
const [aboutOpen, setAboutOpen] = useCollapsibleState(
  `collapsible-${caseId}-about`,
  true,
);
const [intakeOpen, setIntakeOpen] = useCollapsibleState(
  `collapsible-${caseId}-intake`,
  false,
);
const [classificationOpen, setClassificationOpen] = useCollapsibleState(
  `collapsible-${caseId}-classification`,
  true,
);
```

Pass these as `isOpen` / `onOpenChange` to each CollapsiblePropertyCard.
</action>
<verify> - loading.tsx renders skeleton layout during page load - error.tsx shows error message with retry and go-back buttons - Collapsing "Intake Information" card, navigating away, navigating back — card stays collapsed - Collapsing "About This Case" persists independently from Intake - `npm run typecheck` passes
</verify>
<done>Loading skeleton, error boundary, and collapsible state persistence added</done>
</task>

</tasks>

<verification>
1. Desktop (>=1280px): three-column layout renders as before
2. Tablet (768-1279px): sidebars collapse to drawers with toggle buttons
3. Mobile (<768px): single column with full-width drawer access
4. Loading state shows skeleton while case data fetches
5. Error state shows actionable error with retry
6. Collapsible card states persist across page navigations (localStorage)
7. `npm run typecheck` passes
</verification>

<success_criteria>

- Responsive behavior matches spec Section 12 breakpoints
- Loading/error states prevent blank screens
- Collapsible persistence eliminates state-reset annoyance
- No regression in desktop three-column layout
- Empty states are handled by respective tab plans (05, 06, 07, 08), not this plan
  </success_criteria>

<output>
After completion, create `.planning/phases/25.1-case-detail-page-vision-revision/25.1-09-SUMMARY.md`
</output>
