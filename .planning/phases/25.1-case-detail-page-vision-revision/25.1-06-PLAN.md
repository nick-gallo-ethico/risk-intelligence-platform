---
phase: 25.1-case-detail-page-vision-revision
plan: 06
type: execute
wave: 2
depends_on: [01]
files_modified:
  - apps/frontend/src/components/cases/case-activity-timeline.tsx
  - apps/frontend/src/components/cases/activity-filters.tsx
  - apps/frontend/src/components/cases/activity-entry.tsx
  - apps/frontend/src/hooks/useActivities.ts
  - apps/frontend/src/types/activity.ts
autonomous: true

must_haves:
  truths:
    - "Activity filter bar shows type checkboxes (8 types) with check/uncheck"
    - "Filter bar shows 'Filter activity (N/M)' count, user dropdown, team dropdown, search bar"
    - "Pinned activities section appears above chronological timeline"
    - "Per-activity actions (Pin, Comment, Edit, Copy link, Delete) appear on hover"
    - "Long activity content is truncated with 'Show full' expand link"
  artifacts:
    - path: "apps/frontend/src/components/cases/activity-filters.tsx"
      provides: "Checkbox-style type filters replacing tab-style"
      contains: "ActivityTypeCheckboxes"
    - path: "apps/frontend/src/hooks/useActivities.ts"
      provides: "Activity CRUD, filtering, pinning hook"
      contains: "useActivities"
  key_links:
    - from: "apps/frontend/src/components/cases/case-activity-timeline.tsx"
      to: "apps/frontend/src/hooks/useActivities.ts"
      via: "hook usage"
      pattern: "useActivities"
    - from: "apps/frontend/src/components/cases/case-activity-timeline.tsx"
      to: "apps/frontend/src/components/cases/activity-filters.tsx"
      via: "filter component render"
      pattern: "ActivityTypeCheckboxes"
---

<objective>
Rebuild the Activities tab to follow the exact HubSpot activity timeline pattern: checkbox-style type filters (8 types), user/team filter dropdowns, search bar, pinned activities section, per-activity hover actions (pin/comment/edit/copy/delete), and content expand/collapse.

Purpose: The Activities tab is where investigators spend most of their time — reviewing and adding case activities. The HubSpot pattern makes filtering fast (checkbox toggle vs tab switch) and pinning keeps important activities visible.
Output: Rebuilt activity-filters.tsx with checkboxes, enhanced activity-entry.tsx with hover actions, useActivities hook, pinned section.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25.1-case-detail-page-vision-revision/25.1-RESEARCH.md

# Key source files

@apps/frontend/src/components/cases/case-activity-timeline.tsx
@apps/frontend/src/components/cases/activity-filters.tsx
@apps/frontend/src/components/cases/activity-entry.tsx
@apps/frontend/src/types/activity.ts
@.planning/hubspot-view-system-spec.md (Section 16.2 — Activities Tab)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useActivities hook and rebuild activity filters</name>
  <files>
    apps/frontend/src/hooks/useActivities.ts
    apps/frontend/src/components/cases/activity-filters.tsx
    apps/frontend/src/types/activity.ts
  </files>
  <action>
1. **Extend activity types** in `types/activity.ts`:
   - Add `isPinned?: boolean` to the Activity type
   - Add `comments?: Array<{ id: string; text: string; author: string; createdAt: string }>`
   - Ensure ActivityAction type includes all 8+ types: `note | email | call | task | interview | document_upload | status_change | assignment_change | system_event` (plus any existing types like `commented`, `file_uploaded` etc.)
   - Add `visibility?: 'internal' | 'shared'` field

2. **Create `useActivities` hook** at `apps/frontend/src/hooks/useActivities.ts`:

```typescript
interface UseActivitiesOptions {
  entityType: string;
  entityId: string;
}

interface UseActivitiesReturn {
  activities: Activity[];
  filteredActivities: Activity[];
  pinnedActivities: Activity[];
  isLoading: boolean;
  // Filters
  activeTypes: Set<string>;
  toggleType: (type: string) => void;
  selectAllTypes: () => void;
  deselectAllTypes: () => void;
  userFilter: string;
  setUserFilter: (userId: string) => void;
  searchQuery: string;
  setSearchQuery: (q: string) => void;
  // Activity count
  visibleCount: number;
  totalCount: number;
  // Actions
  pinActivity: (activityId: string) => void;
  unpinActivity: (activityId: string) => void;
  deleteActivity: (activityId: string) => void;
  // Unique users for filter dropdown
  uniqueUsers: Array<{ id: string; name: string }>;
}
```

The hook:

- Fetches activities from `/activity/{entityType}/{entityId}`
- Manages filter state: activeTypes (Set of type strings, all checked by default), userFilter, searchQuery
- Computes filteredActivities by applying type filter, user filter, and search filter
- Separates pinnedActivities from chronological (isPinned === true above, rest below)
- Pin/unpin: For now, use local state (localStorage-backed). If PUT /cases/:id/activities/:activityId/pin endpoint exists, use it. Otherwise, store pinned IDs in localStorage key `pinned-activities-{entityId}`.
- Delete: Call DELETE on activity endpoint or mark as deleted locally.

3. **Replace activity-filters.tsx** — change from tab-style to checkbox-style:

```typescript
interface ActivityTypeCheckboxesProps {
  types: Array<{ id: string; label: string; icon: React.ReactNode }>;
  activeTypes: Set<string>;
  onToggle: (type: string) => void;
  onSelectAll: () => void;
  onDeselectAll: () => void;
}
```

Render a row of checkboxes, one per activity type:

```
☑ Notes  ☑ Emails  ☑ Calls  ☑ Tasks  ☑ Interviews
☑ Documents  ☑ Status Changes  ☑ System Events
```

Use shadcn Checkbox component. Each checkbox has the type label next to it. Wrap in a flex-wrap container. Clicking a checkbox calls onToggle.

The 8 activity types with icons (from lucide-react):

- Notes (FileText), Emails (Mail), Calls (Phone), Tasks (CheckSquare), Interviews (Mic), Documents (FileUp), Status Changes (ArrowRightLeft), System Events (Settings)
  </action>
  <verify> - useActivities hook fetches and manages activity state - Checkbox filters toggle individual activity types - Filter state correctly filters activities - Pinned activities tracked separately - TypeScript compiles
  </verify>
  <done>useActivities hook created, activity-filters.tsx rebuilt with 8 checkbox-style type filters</done>
  </task>

<task type="auto">
  <name>Task 2: Rebuild activity timeline with pinning, hover actions, expand/collapse</name>
  <files>
    apps/frontend/src/components/cases/case-activity-timeline.tsx
    apps/frontend/src/components/cases/activity-entry.tsx
  </files>
  <action>
1. **Rebuild case-activity-timeline.tsx** to use useActivities hook:

Top of the Activities tab (filter bar layout per spec):

```
┌─────────────────────────────────────────────────────────┐
│  Filter activity (17/28) ▼    All users ▼    All teams ▼│
│  [Search activities...]                                  │
│  ☑ Notes  ☑ Emails  ☑ Calls  ☑ Tasks  ☑ Interviews     │
│  ☑ Documents  ☑ Status Changes  ☑ System Events         │
└─────────────────────────────────────────────────────────┘
```

Layout:
a. **Filter bar header row**: "Filter activity ({visibleCount}/{totalCount})" label, "All users" Select dropdown (using uniqueUsers from hook), "All teams" dropdown (placeholder for now).
b. **Search bar**: Text input with Search icon.
c. **Type checkboxes**: ActivityTypeCheckboxes component.
d. **Pinned section** (if pinnedActivities.length > 0): Heading "Pinned" with pin icon, then render pinned activities.
e. **Chronological section**: Date-grouped activities using existing groupActivitiesByDate. Keep the "Upcoming" section for future-dated items (tasks, SLA).

2. **Enhance activity-entry.tsx** with per-activity actions:

Add hover-reveal action bar to each activity entry:

- **Pin / Unpin** (Pin icon): Toggle pin state
- **Comment** (MessageSquare icon): Opens inline comment input below the activity (or toast "Coming soon" for MVP)
- **Edit** (Pencil icon): Only for creator or admin. Opens inline edit mode for activity content.
- **Copy link** (Link icon): Copies a shareable link to this activity to clipboard. Toast "Link copied".
- **Delete** (Trash2 icon): Only for creator or admin. Confirmation dialog before delete.

Action bar: horizontal row of small icon buttons, visible only on hover (use group/group-hover Tailwind pattern).

3. **Content expand/collapse**: For activity content longer than 3 lines (~200 chars), truncate with "Show full ▼" link. Clicking expands to show full content. Clicking "Show less ▲" collapses.

Use existing activity rendering logic from case-activity-timeline.tsx but restructure to use the useActivities hook for state management instead of inline state.

IMPORTANT: Keep existing ActivityEntry rendering (icons, date grouping, type-based formatting). Only ADD the hover actions and expand/collapse behavior. Do not break existing timeline appearance.

4. **Empty state**: If the case has no activities at all, show an empty state below the filter bar: "No activities yet" heading with muted descriptive text "Use the quick actions to log notes, emails, calls, or other case activity." and a subtle icon (e.g., ClipboardList from lucide-react). The filter bar should still render above the empty state.
   </action>
   <verify> - Activity timeline renders with filter bar at top showing count, user dropdown, search, type checkboxes - Checking/unchecking a type filters activities in real-time - Pinned section appears above chronological when pinned activities exist - Hovering an activity reveals action buttons (pin, comment, edit, copy, delete) - Pin action moves activity to pinned section - Long content truncated with expand/collapse toggle - Clicking "Copy link" shows toast - `npm run typecheck` passes
   </verify>
   <done>Activities tab fully rebuilt with HubSpot pattern: checkbox filters, pinning, hover actions, expand/collapse</done>
   </task>

</tasks>

<verification>
1. Activities tab filter bar: count indicator, user filter, search, 8 type checkboxes
2. Toggling type checkboxes filters activities immediately
3. User filter dropdown filters by actor
4. Search filters by content text
5. Pinned activities section above chronological
6. Hover reveals per-activity actions
7. Expand/collapse for long content
8. Date grouping with descriptive labels preserved
9. Upcoming section still present for future tasks/SLA
10. `npm run typecheck` passes
</verification>

<success_criteria>

- Activities tab matches HubSpot pattern precisely
- All 8 activity types filterable via checkboxes
- Pinning works (at minimum client-side with localStorage)
- Per-activity actions visible on hover
- Content expand/collapse for long entries
- No regression in existing activity display
  </success_criteria>

<output>
After completion, create `.planning/phases/25.1-case-detail-page-vision-revision/25.1-06-SUMMARY.md`
</output>
