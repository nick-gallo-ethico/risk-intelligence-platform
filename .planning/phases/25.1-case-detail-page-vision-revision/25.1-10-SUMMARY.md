---
phase: 25.1-case-detail-page-vision-revision
plan: 10
subsystem: api
tags: [nestjs, pipeline, activity, react-query, api-client]

# Dependency graph
requires:
  - phase: 01-foundation
    provides: NestJS module structure, Prisma ORM, activity service
  - phase: 25.1-02
    provides: usePipeline hook with hardcoded stages
provides:
  - Pipeline configuration REST API with default 7-stage case pipeline
  - Activity pinning endpoint for persisting pinned activities
  - Status history endpoint for case status timeline
  - Frontend pipeline API client with React Query integration
affects: [25.1-02, 25.1-06, case-detail-page]

# Tech tracking
tech-stack:
  added: []
  patterns: [api-first-fallback, tenant-scoped-pipeline-config]

key-files:
  created:
    - apps/backend/src/modules/cases/pipeline.controller.ts
    - apps/backend/src/modules/cases/pipeline.service.ts
    - apps/backend/src/modules/cases/dto/pipeline.dto.ts
    - apps/frontend/src/services/pipeline.ts
  modified:
    - apps/backend/src/modules/cases/cases.module.ts
    - apps/backend/src/modules/cases/cases.controller.ts
    - apps/backend/src/common/services/activity.service.ts
    - apps/frontend/src/hooks/usePipeline.ts

key-decisions:
  - "Return default pipeline when no tenant config exists (future: persisted overrides)"
  - "Store isPinned in activity context JSON field (no schema migration)"
  - "usePipeline hook fetches from API with 5-minute stale time, falls back to hardcoded DEFAULT_CASE_PIPELINE"

patterns-established:
  - "API-first-fallback: Frontend fetches from API but gracefully degrades to hardcoded defaults"
  - "Context JSON for extensions: Store additional activity metadata in context JSON field"

# Metrics
duration: 12min
completed: 2026-02-13
---

# Phase 25.1 Plan 10: Pipeline Configuration API Summary

**Pipeline configuration API with default 7-stage workflow, activity pinning via context JSON, and frontend React Query integration with fallback defaults**

## Performance

- **Duration:** 12 min
- **Started:** 2026-02-13T23:15:00Z
- **Completed:** 2026-02-13T23:27:00Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Created Pipeline REST API serving default 7-stage case pipeline (New -> Archived)
- Added activity pinning endpoint persisting to context JSON field
- Added status history endpoint querying audit log for status_changed actions
- Enhanced usePipeline hook to fetch pipeline config from API with graceful fallback

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Pipeline Configuration API** - `db7005c` (feat)
   - PipelineController, PipelineService, PipelineDto
   - 7-stage DEFAULT_CASE_STAGES constant
   - GET /pipelines, GET /pipelines/:id, PUT /pipelines/:id endpoints

2. **Task 2: Activity pinning and frontend wiring** - `fbb6516` (feat)
   - Added as Rule 3 blocking fix during Plan 02 execution
   - pinActivity and getStatusHistory methods in ActivityService
   - PUT /cases/:id/activities/:activityId/pin endpoint
   - GET /cases/:id/status-history endpoint
   - Frontend pipeline.ts service with API client functions
   - usePipeline hook enhanced with React Query fetching

## Files Created/Modified

**Created:**

- `apps/backend/src/modules/cases/pipeline.controller.ts` - REST controller for pipeline configuration
- `apps/backend/src/modules/cases/pipeline.service.ts` - Service with DEFAULT_CASE_STAGES and CRUD methods
- `apps/backend/src/modules/cases/dto/pipeline.dto.ts` - DTOs for pipeline stages and config
- `apps/frontend/src/services/pipeline.ts` - API client with fetchPipelines, pinActivity, fetchStatusHistory

**Modified:**

- `apps/backend/src/modules/cases/cases.module.ts` - Added PipelineController and PipelineService
- `apps/backend/src/modules/cases/cases.controller.ts` - Added pin and status-history endpoints
- `apps/backend/src/common/services/activity.service.ts` - Added pinActivity and getStatusHistory methods
- `apps/frontend/src/hooks/usePipeline.ts` - Added React Query fetch with DEFAULT_CASE_PIPELINE fallback

## Decisions Made

1. **Default pipeline via constant:** No Prisma PipelineConfig model exists, so service returns DEFAULT_CASE_STAGES constant. Future: persist tenant overrides in database.

2. **Activity pinning via context JSON:** Used existing AuditLog.context JSON field to store isPinned flag rather than adding new column. Minimal schema impact.

3. **Status history from audit log:** Query status_changed actions from AuditLog rather than duplicating status history in separate table.

4. **5-minute React Query stale time:** Pipeline config rarely changes, cache aggressively to reduce API calls.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Added pinActivity/getStatusHistory during Plan 02**

- **Found during:** Task 2 compilation
- **Issue:** CasesController referenced ActivityService methods that didn't exist
- **Fix:** Added pinActivity and getStatusHistory methods to ActivityService
- **Files modified:** apps/backend/src/common/services/activity.service.ts
- **Verification:** TypeScript compilation passes
- **Committed in:** fbb6516 (as part of Plan 02 commit)

---

**Total deviations:** 1 auto-fixed (1 blocking)
**Impact on plan:** Task 2 backend changes were committed with Plan 02 as a blocking fix. No scope creep.

## Issues Encountered

- Task 2 changes were pre-committed as part of Plan 25.1-02 execution (Rule 3 blocking fix). Verified changes exist and TypeScript compiles correctly.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Pipeline API ready for frontend consumption
- usePipeline hook now fetches from API with graceful fallback
- Activity pinning persists server-side
- Status history timeline has real data source
- Ready for visual verification checkpoint

---

_Phase: 25.1-case-detail-page-vision-revision_
_Completed: 2026-02-13_
