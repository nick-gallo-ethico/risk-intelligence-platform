---
phase: 05-ai-infrastructure
plan: 09
type: execute
wave: 3
depends_on: ["05-06", "05-07"]
files_modified:
  - apps/backend/src/modules/ai/agents/base.agent.ts
  - apps/backend/src/modules/ai/agents/investigation.agent.ts
  - apps/backend/src/modules/ai/agents/case.agent.ts
  - apps/backend/src/modules/ai/agents/compliance-manager.agent.ts
  - apps/backend/src/modules/ai/agents/agent.registry.ts
  - apps/backend/src/modules/ai/agents/index.ts
  - apps/backend/src/modules/ai/ai.module.ts
autonomous: true

must_haves:
  truths:
    - "Scoped agents have different skills based on context"
    - "Investigation Agent has investigation-specific capabilities"
    - "Case Agent has case-specific capabilities"
    - "Agents use context hierarchy for system prompts"
  artifacts:
    - path: "apps/backend/src/modules/ai/agents/base.agent.ts"
      provides: "Base agent with common functionality"
      exports: ["BaseAgent"]
      min_lines: 80
    - path: "apps/backend/src/modules/ai/agents/agent.registry.ts"
      provides: "Agent type registration and lookup"
      exports: ["AgentRegistry"]
    - path: "apps/backend/src/modules/ai/agents/investigation.agent.ts"
      provides: "Investigation-scoped agent"
      exports: ["InvestigationAgent"]
  key_links:
    - from: "apps/backend/src/modules/ai/agents/base.agent.ts"
      to: "apps/backend/src/modules/ai/services/context-loader.service.ts"
      via: "loads context"
      pattern: "contextLoader|loadContext"
    - from: "apps/backend/src/modules/ai/agents/base.agent.ts"
      to: "apps/backend/src/modules/ai/skills/skill.registry.ts"
      via: "gets available skills"
      pattern: "skillRegistry|getAvailableSkills"
---

<objective>
Create the scoped agent system (AI-14). Agents are context-aware AI assistants specialized for different entity types (Investigation, Case) and roles (Compliance Manager). Each agent has access to appropriate skills based on its scope.

Purpose: Per CONTEXT.md, agents are both entity-scoped AND role-scoped. Different agents have different capabilities - Investigation Agent can draft interview questions, Case Agent can suggest related cases.

Output: BaseAgent class with specialized InvestigationAgent, CaseAgent, and ComplianceManagerAgent implementations.
</objective>

<execution_context>
@C:\Users\cu0718\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\cu0718\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ai-infrastructure/05-RESEARCH.md
@.planning/phases/05-ai-infrastructure/05-CONTEXT.md (agent architecture decisions)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create base agent and agent registry</name>
  <files>
    apps/backend/src/modules/ai/agents/base.agent.ts
    apps/backend/src/modules/ai/agents/agent.registry.ts
    apps/backend/src/modules/ai/agents/index.ts
  </files>
  <action>
1. Create `apps/backend/src/modules/ai/agents/base.agent.ts`:
```typescript
import { Logger } from '@nestjs/common';
import { ProviderRegistryService } from '../services/provider-registry.service';
import { ContextLoaderService } from '../services/context-loader.service';
import { ConversationService } from '../services/conversation.service';
import { SkillRegistry } from '../skills/skill.registry';
import { AiRateLimiterService } from '../services/rate-limiter.service';
import { AIContext, LoadContextDto } from '../dto/context.dto';
import { SkillDefinition, SkillContext } from '../skills/skill.types';
import { AIStreamEvent } from '../interfaces/ai-provider.interface';

export interface AgentConfig {
  id: string;
  name: string;
  description: string;
  entityTypes: string[]; // Entity types this agent handles
  requiredRole?: string; // Role required to use this agent
  defaultSkills: string[]; // Skill IDs available by default
  systemPromptTemplate: string; // Template name for system prompt
}

export interface AgentContext {
  organizationId: string;
  userId: string;
  userRole: string;
  permissions: string[];
  entityType?: string;
  entityId?: string;
  teamId?: string;
}

export interface AgentMessage {
  role: 'user' | 'assistant';
  content: string;
}

export abstract class BaseAgent {
  protected readonly logger: Logger;
  protected aiContext: AIContext | null = null;
  protected conversationId: string | null = null;

  constructor(
    protected readonly config: AgentConfig,
    protected readonly providerRegistry: ProviderRegistryService,
    protected readonly contextLoader: ContextLoaderService,
    protected readonly conversationService: ConversationService,
    protected readonly skillRegistry: SkillRegistry,
    protected readonly rateLimiter: AiRateLimiterService,
  ) {
    this.logger = new Logger(config.name);
  }

  get id(): string {
    return this.config.id;
  }

  get name(): string {
    return this.config.name;
  }

  get entityTypes(): string[] {
    return this.config.entityTypes;
  }

  /**
   * Initialize agent with context.
   */
  async initialize(context: AgentContext): Promise<void> {
    // Load AI context
    this.aiContext = await this.contextLoader.loadContext({
      organizationId: context.organizationId,
      userId: context.userId,
      teamId: context.teamId,
      entityType: context.entityType,
      entityId: context.entityId,
    });

    // Get or create conversation
    const conversation = await this.conversationService.getOrCreate({
      organizationId: context.organizationId,
      userId: context.userId,
      entityType: context.entityType,
      entityId: context.entityId,
      agentType: this.config.id,
    });

    this.conversationId = conversation.id;

    this.logger.debug(`Initialized ${this.name} for ${context.entityType}:${context.entityId}`);
  }

  /**
   * Get available skills for this agent in the current context.
   */
  getAvailableSkills(context: AgentContext): SkillDefinition[] {
    const allSkills = this.skillRegistry.getAvailableSkills({
      organizationId: context.organizationId,
      userId: context.userId,
      teamId: context.teamId,
      entityType: context.entityType,
      userPermissions: context.permissions,
    });

    // Filter to skills appropriate for this agent
    return allSkills.filter(skill =>
      this.config.defaultSkills.includes(skill.id) ||
      this.getAdditionalSkills().includes(skill.id)
    );
  }

  /**
   * Build system prompt for this agent.
   */
  async buildSystemPrompt(context: AgentContext): Promise<string> {
    if (!this.aiContext) {
      await this.initialize(context);
    }

    return this.contextLoader.buildSystemPrompt(
      this.aiContext!,
      this.config.systemPromptTemplate,
    );
  }

  /**
   * Chat with the agent (streaming).
   */
  async *chat(
    message: string,
    context: AgentContext,
  ): AsyncGenerator<AIStreamEvent> {
    if (!this.aiContext || !this.conversationId) {
      await this.initialize(context);
    }

    // Check rate limit
    const estimatedTokens = Math.ceil(message.length / 4) + 500;
    const rateLimitResult = await this.rateLimiter.checkAndConsume({
      organizationId: context.organizationId,
      estimatedTokens,
    });

    if (!rateLimitResult.allowed) {
      yield {
        type: 'error',
        error: `Rate limit exceeded. Please wait ${Math.ceil((rateLimitResult.retryAfterMs || 0) / 1000)} seconds.`,
      };
      return;
    }

    // Save user message
    await this.conversationService.addMessage({
      conversationId: this.conversationId!,
      role: 'user',
      content: message,
    });

    // Get conversation history
    const history = await this.conversationService.getMessages(this.conversationId!, 20);

    // Build system prompt
    const systemPrompt = await this.buildSystemPrompt(context);

    // Get available skills as tools
    const skills = this.getAvailableSkills(context);
    const tools = this.skillRegistry.toClaudeTools(skills);

    // Get provider and stream
    const provider = this.providerRegistry.getDefaultProvider();

    let fullContent = '';
    const startTime = Date.now();

    try {
      const stream = provider.streamMessage({
        system: systemPrompt,
        messages: [
          ...history.map(m => ({
            role: m.role as 'user' | 'assistant',
            content: m.content,
          })),
          { role: 'user' as const, content: message },
        ],
        tools: tools.length > 0 ? tools : undefined,
      });

      for await (const event of stream) {
        if (event.type === 'text_delta' && event.text) {
          fullContent += event.text;
          yield event;
        } else if (event.type === 'tool_use' && event.toolCall) {
          yield event;

          // Execute skill
          const skillContext: SkillContext = {
            organizationId: context.organizationId,
            userId: context.userId,
            entityType: context.entityType,
            entityId: context.entityId,
            permissions: context.permissions,
          };

          const result = await this.skillRegistry.executeSkill(
            event.toolCall.name,
            event.toolCall.input,
            skillContext,
          );

          // Note: In production, would need to continue conversation with tool result
          this.logger.debug(`Skill ${event.toolCall.name} result: ${result.success}`);
        } else if (event.type === 'usage' && event.usage) {
          await this.rateLimiter.recordUsage({
            organizationId: context.organizationId,
            userId: context.userId,
            inputTokens: event.usage.inputTokens,
            outputTokens: event.usage.outputTokens,
            model: provider.defaultModel,
            featureType: `agent:${this.config.id}`,
            entityType: context.entityType,
            entityId: context.entityId,
            durationMs: Date.now() - startTime,
          });
        } else {
          yield event;
        }
      }

      // Save assistant message
      if (fullContent) {
        await this.conversationService.addMessage({
          conversationId: this.conversationId!,
          role: 'assistant',
          content: fullContent,
        });
      }
    } catch (error) {
      this.logger.error(`Chat error: ${error.message}`);
      yield { type: 'error', error: error.message };
    }
  }

  /**
   * Get suggested prompts for this agent context.
   */
  abstract getSuggestedPrompts(context: AgentContext): string[];

  /**
   * Get additional skills specific to this agent type.
   */
  protected abstract getAdditionalSkills(): string[];
}
```

2. Create `apps/backend/src/modules/ai/agents/agent.registry.ts`:
```typescript
import { Injectable, Logger, OnModuleInit } from '@nestjs/common';
import { ProviderRegistryService } from '../services/provider-registry.service';
import { ContextLoaderService } from '../services/context-loader.service';
import { ConversationService } from '../services/conversation.service';
import { SkillRegistry } from '../skills/skill.registry';
import { AiRateLimiterService } from '../services/rate-limiter.service';
import { BaseAgent, AgentContext } from './base.agent';
import { InvestigationAgent } from './investigation.agent';
import { CaseAgent } from './case.agent';
import { ComplianceManagerAgent } from './compliance-manager.agent';

@Injectable()
export class AgentRegistry implements OnModuleInit {
  private readonly logger = new Logger(AgentRegistry.name);
  private readonly agents = new Map<string, new (...args: any[]) => BaseAgent>();
  private readonly agentInstances = new Map<string, BaseAgent>();

  constructor(
    private readonly providerRegistry: ProviderRegistryService,
    private readonly contextLoader: ContextLoaderService,
    private readonly conversationService: ConversationService,
    private readonly skillRegistry: SkillRegistry,
    private readonly rateLimiter: AiRateLimiterService,
  ) {}

  onModuleInit() {
    // Register agent types
    this.registerAgentType('investigation', InvestigationAgent);
    this.registerAgentType('case', CaseAgent);
    this.registerAgentType('compliance-manager', ComplianceManagerAgent);

    this.logger.log(`Registered ${this.agents.size} agent types`);
  }

  /**
   * Register an agent type.
   */
  registerAgentType(id: string, agentClass: new (...args: any[]) => BaseAgent): void {
    this.agents.set(id, agentClass);
  }

  /**
   * Get an agent instance for the given context.
   * Creates a new instance or returns existing one based on context key.
   */
  getAgent(agentType: string, context: AgentContext): BaseAgent {
    const AgentClass = this.agents.get(agentType);
    if (!AgentClass) {
      throw new Error(`Agent type not found: ${agentType}`);
    }

    // Create unique key for this context
    const contextKey = `${agentType}:${context.organizationId}:${context.userId}:${context.entityType}:${context.entityId}`;

    // Check for existing instance
    let agent = this.agentInstances.get(contextKey);
    if (agent) {
      return agent;
    }

    // Create new instance
    agent = new AgentClass(
      this.providerRegistry,
      this.contextLoader,
      this.conversationService,
      this.skillRegistry,
      this.rateLimiter,
    );

    this.agentInstances.set(contextKey, agent);

    return agent;
  }

  /**
   * Get the appropriate agent type for an entity.
   */
  getAgentTypeForEntity(entityType: string): string | null {
    switch (entityType) {
      case 'investigation':
        return 'investigation';
      case 'case':
        return 'case';
      case 'campaign':
        return 'compliance-manager';
      default:
        return 'compliance-manager'; // Default to org-wide agent
    }
  }

  /**
   * List available agent types.
   */
  listAgentTypes(): string[] {
    return Array.from(this.agents.keys());
  }

  /**
   * Clear agent instances (useful for testing or context reset).
   */
  clearInstances(): void {
    this.agentInstances.clear();
  }
}
```

3. Create `apps/backend/src/modules/ai/agents/index.ts`:
```typescript
export * from './base.agent';
export * from './agent.registry';
export * from './investigation.agent';
export * from './case.agent';
export * from './compliance-manager.agent';
```
  </action>
  <verify>
Files created.
Types compile correctly.
  </verify>
  <done>
Base agent and registry created with context management.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create specialized agents</name>
  <files>
    apps/backend/src/modules/ai/agents/investigation.agent.ts
    apps/backend/src/modules/ai/agents/case.agent.ts
    apps/backend/src/modules/ai/agents/compliance-manager.agent.ts
  </files>
  <action>
1. Create `apps/backend/src/modules/ai/agents/investigation.agent.ts`:
```typescript
import { BaseAgent, AgentConfig, AgentContext } from './base.agent';
import { ProviderRegistryService } from '../services/provider-registry.service';
import { ContextLoaderService } from '../services/context-loader.service';
import { ConversationService } from '../services/conversation.service';
import { SkillRegistry } from '../skills/skill.registry';
import { AiRateLimiterService } from '../services/rate-limiter.service';

const INVESTIGATION_AGENT_CONFIG: AgentConfig = {
  id: 'investigation',
  name: 'Investigation Agent',
  description: 'AI assistant specialized for investigation workflows - interviews, evidence analysis, and findings documentation.',
  entityTypes: ['investigation'],
  requiredRole: 'INVESTIGATOR',
  defaultSkills: [
    'note-cleanup',
    'summarize',
    'risk-score',
    'translate',
  ],
  systemPromptTemplate: 'investigation-agent',
};

export class InvestigationAgent extends BaseAgent {
  constructor(
    providerRegistry: ProviderRegistryService,
    contextLoader: ContextLoaderService,
    conversationService: ConversationService,
    skillRegistry: SkillRegistry,
    rateLimiter: AiRateLimiterService,
  ) {
    super(
      INVESTIGATION_AGENT_CONFIG,
      providerRegistry,
      contextLoader,
      conversationService,
      skillRegistry,
      rateLimiter,
    );
  }

  getSuggestedPrompts(context: AgentContext): string[] {
    return [
      'Summarize this investigation',
      'Clean up my interview notes',
      'What questions should I ask the subject?',
      'Generate a risk assessment',
      'Draft the findings section',
      'Are there similar cases to this investigation?',
    ];
  }

  protected getAdditionalSkills(): string[] {
    // Investigation-specific skills (to be added in future)
    return [
      // 'draft-interview-questions',
      // 'analyze-evidence',
      // 'find-similar-cases',
    ];
  }
}
```

2. Create `apps/backend/src/modules/ai/agents/case.agent.ts`:
```typescript
import { BaseAgent, AgentConfig, AgentContext } from './base.agent';
import { ProviderRegistryService } from '../services/provider-registry.service';
import { ContextLoaderService } from '../services/context-loader.service';
import { ConversationService } from '../services/conversation.service';
import { SkillRegistry } from '../skills/skill.registry';
import { AiRateLimiterService } from '../services/rate-limiter.service';

const CASE_AGENT_CONFIG: AgentConfig = {
  id: 'case',
  name: 'Case Agent',
  description: 'AI assistant for case management - triage, categorization, linking reports, and case summaries.',
  entityTypes: ['case'],
  defaultSkills: [
    'note-cleanup',
    'summarize',
    'category-suggest',
    'risk-score',
    'translate',
  ],
  systemPromptTemplate: 'case-agent',
};

export class CaseAgent extends BaseAgent {
  constructor(
    providerRegistry: ProviderRegistryService,
    contextLoader: ContextLoaderService,
    conversationService: ConversationService,
    skillRegistry: SkillRegistry,
    rateLimiter: AiRateLimiterService,
  ) {
    super(
      CASE_AGENT_CONFIG,
      providerRegistry,
      contextLoader,
      conversationService,
      skillRegistry,
      rateLimiter,
    );
  }

  getSuggestedPrompts(context: AgentContext): string[] {
    return [
      'Summarize this case',
      'Suggest a category for this report',
      'Are there related cases to link?',
      'What is the risk level?',
      'Clean up the intake notes',
      'Draft a response to the reporter',
    ];
  }

  protected getAdditionalSkills(): string[] {
    // Case-specific skills (to be added in future)
    return [
      // 'find-related-cases',
      // 'draft-reporter-response',
      // 'suggest-assignment',
    ];
  }
}
```

3. Create `apps/backend/src/modules/ai/agents/compliance-manager.agent.ts`:
```typescript
import { BaseAgent, AgentConfig, AgentContext } from './base.agent';
import { ProviderRegistryService } from '../services/provider-registry.service';
import { ContextLoaderService } from '../services/context-loader.service';
import { ConversationService } from '../services/conversation.service';
import { SkillRegistry } from '../skills/skill.registry';
import { AiRateLimiterService } from '../services/rate-limiter.service';

const COMPLIANCE_MANAGER_AGENT_CONFIG: AgentConfig = {
  id: 'compliance-manager',
  name: 'Compliance Manager Agent',
  description: 'Organization-wide AI assistant for compliance officers - trends, reporting, policy questions, and program management.',
  entityTypes: ['campaign', 'policy', 'report'],
  requiredRole: 'COMPLIANCE_OFFICER',
  defaultSkills: [
    'note-cleanup',
    'summarize',
    'category-suggest',
    'risk-score',
    'translate',
  ],
  systemPromptTemplate: 'base', // Falls back to base until specific template exists
};

export class ComplianceManagerAgent extends BaseAgent {
  constructor(
    providerRegistry: ProviderRegistryService,
    contextLoader: ContextLoaderService,
    conversationService: ConversationService,
    skillRegistry: SkillRegistry,
    rateLimiter: AiRateLimiterService,
  ) {
    super(
      COMPLIANCE_MANAGER_AGENT_CONFIG,
      providerRegistry,
      contextLoader,
      conversationService,
      skillRegistry,
      rateLimiter,
    );
  }

  getSuggestedPrompts(context: AgentContext): string[] {
    return [
      'Show me trends in the last quarter',
      'What are the most common case types?',
      'Draft a board report summary',
      'Which departments have the most open cases?',
      'What campaigns are due this month?',
      'Summarize policy compliance status',
    ];
  }

  protected getAdditionalSkills(): string[] {
    // Org-wide skills (to be added in future)
    return [
      // 'generate-trend-report',
      // 'natural-language-query',
      // 'draft-board-report',
    ];
  }
}
```
  </action>
  <verify>
Files created.
All agents extend BaseAgent.
  </verify>
  <done>
Three specialized agents created: Investigation, Case, ComplianceManager.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire up agent registry in module</name>
  <files>
    apps/backend/src/modules/ai/ai.module.ts
    apps/backend/src/modules/ai/index.ts
  </files>
  <action>
1. Update `apps/backend/src/modules/ai/ai.module.ts`:
```typescript
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { CacheModule } from '@nestjs/cache-manager';
import { PrismaModule } from '../prisma/prisma.module';
import { AiClientService } from './services/ai-client.service';
import { ProviderRegistryService } from './services/provider-registry.service';
import { AiRateLimiterService } from './services/rate-limiter.service';
import { PromptService } from './services/prompt.service';
import { ConversationService } from './services/conversation.service';
import { ContextLoaderService } from './services/context-loader.service';
import { SkillRegistry } from './skills/skill.registry';
import { AgentRegistry } from './agents/agent.registry';
import { ClaudeProvider } from './providers/claude.provider';

@Module({
  imports: [
    ConfigModule,
    PrismaModule,
    CacheModule.register({
      ttl: 300000,
    }),
  ],
  providers: [
    ClaudeProvider,
    ProviderRegistryService,
    AiClientService,
    AiRateLimiterService,
    PromptService,
    ConversationService,
    ContextLoaderService,
    SkillRegistry,
    AgentRegistry,
  ],
  exports: [
    AiClientService,
    ProviderRegistryService,
    AiRateLimiterService,
    PromptService,
    ConversationService,
    ContextLoaderService,
    SkillRegistry,
    AgentRegistry,
    ClaudeProvider,
  ],
})
export class AiModule {}
```

2. Update `apps/backend/src/modules/ai/index.ts`:
```typescript
export * from './ai.module';
export * from './services/ai-client.service';
export * from './services/provider-registry.service';
export * from './services/rate-limiter.service';
export * from './services/prompt.service';
export * from './services/conversation.service';
export * from './services/context-loader.service';
export * from './skills';
export * from './agents';
export * from './providers';
export * from './interfaces';
export * from './dto';
```
  </action>
  <verify>
`npm run build` succeeds.
AgentRegistry is exported from AiModule.
  </verify>
  <done>
Agent system integrated into AI module.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. `npm run build` passes
2. AgentRegistry has 3 agent types registered
3. Each agent has unique suggested prompts
4. Agents initialize with context and create conversations
5. Agent chat streams responses
</verification>

<success_criteria>
- Three scoped agents: Investigation, Case, ComplianceManager
- Agents load context from hierarchy
- Agents have access to appropriate skills
- Agent suggested prompts are context-aware
- Conversation history maintained per agent context
</success_criteria>

<output>
After completion, create `.planning/phases/05-ai-infrastructure/05-09-SUMMARY.md`
</output>
