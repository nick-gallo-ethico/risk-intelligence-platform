---
phase: 15-case-detail-page-overhaul
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - apps/frontend/src/components/cases/case-tabs.tsx
  - apps/frontend/src/components/cases/case-activity-timeline.tsx
  - apps/frontend/src/components/cases/summary-tab.tsx
autonomous: true

must_haves:
  truths:
    - "Center column tabs include: Overview, Activities, Summary, Investigations, Messages, Files, Remediation"
    - "Activities tab shows descending feed of ALL interactions with correct data from backend"
    - "Activity feed fetches from correct API path /activity/CASE/:id (not /activity/entity/CASE/:id)"
    - "Summary tab displays case summary text and full details/write-up"
    - "Overview tab shows lifecycle info with recent and upcoming activities"
    - "All tabs switch correctly via URL-synced navigation"
  artifacts:
    - path: "apps/frontend/src/components/cases/case-tabs.tsx"
      provides: "Updated tab list with Summary tab, reordered tabs"
      contains: "summary"
    - path: "apps/frontend/src/components/cases/case-activity-timeline.tsx"
      provides: "Fixed API endpoint for activity feed"
      contains: "/activity/CASE/"
    - path: "apps/frontend/src/components/cases/summary-tab.tsx"
      provides: "Summary tab component with AI/manual summary and full write-up"
      contains: "SummaryTab"
  key_links:
    - from: "case-tabs.tsx"
      to: "summary-tab.tsx"
      via: "import and render in TabsContent"
      pattern: "SummaryTab"
    - from: "case-activity-timeline.tsx"
      to: "/activity/CASE/"
      via: "apiClient.get fetch call"
      pattern: "/activity/CASE/"
---

<objective>
Fix the activity feed API path, enhance the center column tabs with new Summary tab, and improve the Overview tab to show lifecycle information.

Purpose: The center column is where investigators spend most of their time. The Activity feed currently calls the wrong API endpoint (returns fake data). The Summary tab is a new requirement for AI/manual case summaries. The Overview tab needs lifecycle context.

Output: Fixed activity timeline, new Summary tab component, updated tab configuration in CaseTabs.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/components/cases/case-tabs.tsx
@apps/frontend/src/components/cases/case-activity-timeline.tsx
@apps/frontend/src/components/cases/activity-entry.tsx
@apps/frontend/src/components/cases/activity-filters.tsx
@.planning/phases/15-case-detail-page-overhaul/15-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix activity feed API path and enhance CaseActivityTimeline</name>
  <files>
    apps/frontend/src/components/cases/case-activity-timeline.tsx
  </files>
  <action>
    The activity timeline currently calls `/activity/entity/CASE/${caseData.id}` but the backend ActivityTimelineController serves at `/activity/CASE/${entityId}` (no "entity" in the path). There is also a fallback endpoint at `/cases/:id/activity` via CasesController.

    1. Fix the API endpoint path in the useEffect fetch:
       - Change: `/activity/entity/CASE/${caseData.id}`
       - To: `/activity/CASE/${caseData.id}`
       - Keep the fallback behavior but update the fallback to use `/cases/${caseData.id}/activity` as secondary attempt

    2. The response shape from ActivityTimelineController may differ from what the component expects. The ActivityTimelineService.getTimeline() returns `{ entries: Activity[], hasMore: boolean, nextCursor?: string }`. Adjust the response parsing:
       - Check if response has `.entries` array (ActivityTimelineController) or `.data` array (CasesController activity endpoint)
       - Handle both response shapes for backward compatibility

    3. Add query parameters to the API call:
       - `?includeRelated=true` to get investigation activities included
       - `?limit=50` for reasonable page size

    4. REMOVE or improve the fake fallback activity entry. Currently when the API fails, the component creates a fake "Case created" entry. This masks bugs. Instead:
       - On API error, show an error message with retry button
       - Only create a minimal fallback entry if the error is specifically a 404 (endpoint not found)

    5. Ensure the activity filter (activeFilter state) works correctly with the fetched data. The filter should be applied client-side on the fetched activities array.

    DO NOT change the ActivityEntry or ActivityFilters components â€” those stay as-is.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify the API path is `/activity/CASE/` (not `/activity/entity/CASE/`).
  </verify>
  <done>
    CaseActivityTimeline fetches from correct API path `/activity/CASE/:id` with `includeRelated=true`. Fake fallback removed. Error state shows retry button. Activity filter applies client-side.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SummaryTab and update CaseTabs configuration</name>
  <files>
    apps/frontend/src/components/cases/summary-tab.tsx
    apps/frontend/src/components/cases/case-tabs.tsx
  </files>
  <action>
    1. Create `summary-tab.tsx`:
       - Props: `{ caseData: Case }`
       - Layout has two sections:

       **Section 1: Case Summary** (top)
       - Header: "Summary" with a Badge showing "AI Generated" or "Manual" based on whether caseData.aiSummary exists
       - Display `caseData.summary` or `caseData.aiSummary` text in a styled card
       - If no summary exists, show placeholder: "No summary available. Use the AI panel to generate one."
       - Style: bg-blue-50/50 border rounded-lg p-4, text in readable font size

       **Section 2: Full Write-Up / Details** (below)
       - Header: "Case Details"
       - Display `caseData.details` in a whitespace-pre-wrap paragraph
       - If no details, show placeholder text
       - Style: bg-white border rounded-lg p-4

       - Component should be 'use client'
       - Check the Case type definition to see what summary/details fields exist. Use whatever fields are available (likely `summary`, `details`, `aiSummary` or similar).

    2. Update `case-tabs.tsx` TABS configuration:
       - Change the tab order to: Overview, Activities, Summary, Investigations, Messages, Files, Remediation
       - Add Summary tab: `{ id: 'summary', label: 'Summary', icon: FileText }` (use BookOpen or ScrollText icon from Lucide to distinguish from Overview's FileText)
       - Import SummaryTab component

    3. Add TabsContent for Summary tab in CaseTabs:
       ```tsx
       <TabsContent value="summary" className="h-full m-0 p-0 data-[state=inactive]:hidden">
         <div className="h-full overflow-y-auto">
           <SummaryTab caseData={caseData} />
         </div>
       </TabsContent>
       ```

    4. Enhance the Overview tab (OverviewTab function in case-tabs.tsx):
       - Keep the existing LinkedRiuList, Case Details, and Key Dates sections
       - Add a "Lifecycle" section above Case Details showing:
         - Current pipeline stage with visual progress indicator (dots or steps)
         - Status badge
         - Assigned investigators (if available on caseData)
       - Add a "Recent Activity" section below Key Dates:
         - Show text: "View full activity in the Activities tab" with a button/link that switches to the activities tab
       - Keep the OverviewTab function inside case-tabs.tsx (don't extract to separate file)

    DO NOT change the existing tab content for Investigations, Messages, Files, Remediation.
    DO NOT modify the URL-synced tab navigation logic.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify case-tabs.tsx TABS array has 7 items including 'summary'. Verify summary-tab.tsx exists and exports SummaryTab.
  </verify>
  <done>
    SummaryTab component renders case summary and details. CaseTabs has 7 tabs: Overview, Activities, Summary, Investigations, Messages, Files, Remediation. Overview tab enhanced with lifecycle section. All tabs switch correctly.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/frontend && npx tsc --noEmit` passes
2. CaseActivityTimeline uses `/activity/CASE/${id}` API path (not `/activity/entity/CASE/${id}`)
3. SummaryTab component exists with summary + details sections
4. CaseTabs TABS array has 7 entries including 'summary'
5. TabsContent for 'summary' renders SummaryTab
6. Overview tab has lifecycle section
7. All 7 tabs render their respective content when selected
</verification>

<success_criteria>

- Activity feed calls correct backend API and displays real data (not fake fallback)
- Summary tab shows case summary and full details/write-up
- Tab list has 7 tabs in correct order
- All tabs switch correctly with URL sync preserved
- Overview shows lifecycle context (pipeline stage, status, assigned investigators)
  </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-03-SUMMARY.md`
</output>
