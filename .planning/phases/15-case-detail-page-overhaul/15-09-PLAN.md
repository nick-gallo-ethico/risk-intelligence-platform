---
phase: 15-case-detail-page-overhaul
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/rius/rius.controller.ts
  - apps/backend/src/modules/rius/rius.service.ts
  - apps/frontend/src/components/cases/linked-riu-form-answers.tsx
  - apps/frontend/src/components/cases/case-tabs.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can view hotline intake Q&A organized by section"
    - "User can view disclosure details in intake section"
    - "User can collapse/expand sections for readability"
  artifacts:
    - path: "apps/frontend/src/components/cases/linked-riu-form-answers.tsx"
      provides: "RIU intake form answers display component"
      min_lines: 100
    - path: "apps/backend/src/modules/rius/rius.controller.ts"
      provides: "GET :id/form-data endpoint"
      contains: "getFormData"
  key_links:
    - from: "linked-riu-form-answers.tsx"
      to: "/rius/:id/form-data"
      via: "fetch API call"
      pattern: "rius.*form-data"
---

<objective>
Display RIU-specific intake form answers organized by section in the case detail page.

Purpose: Close Gap 1 from Phase 15 verification - the left column shows case properties but not the original RIU intake form questions and answers.

Output: Backend endpoint for RIU form data and frontend component displaying Q&A by section.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-case-detail-page-overhaul/15-VERIFICATION.md

# RIU data model

@apps/backend/prisma/schema.prisma (RiskIntelligenceUnit model)

# Existing RIU display

@apps/frontend/src/components/cases/linked-riu-list.tsx
@apps/frontend/src/types/case.ts (RiuAssociation type)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RIU form data endpoint</name>
  <files>
apps/backend/src/modules/rius/rius.controller.ts
apps/backend/src/modules/rius/rius.service.ts
  </files>
  <action>
Add a new endpoint GET /rius/:id/form-data that returns the RIU's intake form data structured by section.

For RIUs, the form data is stored in:

- `details` field: The main narrative/description
- `customFields` JSON: Additional fields captured during intake
- Type-specific extension tables: HotlineRiu, WebFormRiu, DisclosureRiu

Create a structured response that organizes intake data by logical sections:

```typescript
interface RiuFormDataResponse {
  riuId: string;
  riuType: string;
  sections: FormSection[];
}

interface FormSection {
  id: string;
  title: string;
  fields: FormField[];
}

interface FormField {
  label: string;
  value: string | string[] | null;
  type: "text" | "textarea" | "select" | "multiselect" | "date" | "boolean";
}
```

Section structure by RIU type:

**HOTLINE_REPORT:**

- "Report Information": referenceNumber, createdAt, sourceChannel, status
- "Reporter Details": reporterType, anonymous info, contact (if identified)
- "Incident Details": details (narrative), incidentDate, incidentLocation
- "Classification": category, severity
- "Processing": qaStatus (from HotlineRiu), operatorNotes

**WEB_FORM_SUBMISSION:**

- "Submission Information": referenceNumber, createdAt, sourceChannel
- "Reporter Details": reporterType, contact info
- "Report Details": details, form-specific fields from customFields
- "Classification": category, severity

**DISCLOSURE_RESPONSE:**

- "Disclosure Information": referenceNumber, createdAt, disclosureType
- "Disclosure Details": details, monetary values, entity names from customFields
- "Classification": category, severity

In rius.service.ts add:

```typescript
async getFormData(organizationId: string, riuId: string): Promise<RiuFormDataResponse> {
  const riu = await this.prisma.riskIntelligenceUnit.findFirst({
    where: { id: riuId, organizationId },
    include: {
      category: true,
      hotlineExtension: true,
      webFormExtension: true,
      disclosureExtension: true,
    },
  });

  if (!riu) throw new NotFoundException('RIU not found');

  return this.structureFormData(riu);
}

private structureFormData(riu: RiuWithExtensions): RiuFormDataResponse {
  // Build sections based on riu.type
  // Extract fields from extension tables
  // Parse customFields JSON
  // Return structured response
}
```

In rius.controller.ts add:

```typescript
@Get(':id/form-data')
@ApiOperation({ summary: 'Get RIU form data organized by section' })
async getFormData(
  @TenantId() organizationId: string,
  @Param('id', ParseUUIDPipe) id: string,
): Promise<RiuFormDataResponse> {
  return this.riusService.getFormData(organizationId, id);
}
```

  </action>
  <verify>
Endpoint exists: grep for "form-data" in rius.controller.ts
TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
  </verify>
  <done>GET /rius/:id/form-data returns structured form data organized by sections</done>
</task>

<task type="auto">
  <name>Task 2: Create LinkedRiuFormAnswers frontend component</name>
  <files>apps/frontend/src/components/cases/linked-riu-form-answers.tsx</files>
  <action>
Create a LinkedRiuFormAnswers component that fetches and displays RIU intake form data.

Features:

- Fetches form data from GET /rius/:id/form-data
- Displays sections with collapsible headers (using Collapsible from shadcn/ui)
- Shows field labels and values in a clean layout
- Handles loading and error states
- Different field types rendered appropriately (textarea as multiline, dates formatted, booleans as Yes/No)

Props:

```typescript
interface LinkedRiuFormAnswersProps {
  riuId: string;
  riuType: string;
  isLoading?: boolean;
}
```

Component structure:

```tsx
export function LinkedRiuFormAnswers({ riuId, riuType }: Props) {
  const [formData, setFormData] = useState<RiuFormDataResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [expandedSections, setExpandedSections] = useState<Set<string>>(
    new Set(["section-0"]),
  );

  useEffect(() => {
    fetchFormData();
  }, [riuId]);

  const fetchFormData = async () => {
    try {
      const response = await apiClient.get(`/rius/${riuId}/form-data`);
      setFormData(response.data);
    } catch (err) {
      setError("Failed to load intake details");
    } finally {
      setLoading(false);
    }
  };

  // Render sections with Collapsible
  return (
    <div className="space-y-2">
      {formData?.sections.map((section, idx) => (
        <Collapsible
          key={section.id}
          open={expandedSections.has(section.id)}
          onOpenChange={(open) => toggleSection(section.id, open)}
        >
          <CollapsibleTrigger className="flex justify-between w-full p-2 bg-gray-50 rounded">
            <span className="font-medium text-sm">{section.title}</span>
            <ChevronDown className="h-4 w-4" />
          </CollapsibleTrigger>
          <CollapsibleContent className="p-2">
            {section.fields.map((field) => (
              <div key={field.label} className="py-1">
                <dt className="text-xs text-gray-500">{field.label}</dt>
                <dd className="text-sm">{renderFieldValue(field)}</dd>
              </div>
            ))}
          </CollapsibleContent>
        </Collapsible>
      ))}
    </div>
  );
}
```

Use existing shadcn/ui components: Collapsible, CollapsibleTrigger, CollapsibleContent, Skeleton.
</action>
<verify>
File exists and exports LinkedRiuFormAnswers.
TypeScript compiles: `cd apps/frontend && npx tsc --noEmit`
</verify>
<done>LinkedRiuFormAnswers component fetches and displays RIU intake data organized by collapsible sections</done>
</task>

<task type="auto">
  <name>Task 3: Integrate component into case detail Overview tab</name>
  <files>apps/frontend/src/components/cases/case-tabs.tsx</files>
  <action>
Add LinkedRiuFormAnswers to the Overview tab of case-tabs.tsx.

In the Overview tab content, after the case summary/lifecycle section, add:

1. Import the component:

```typescript
import { LinkedRiuFormAnswers } from "./linked-riu-form-answers";
```

2. In the Overview tab, find the primary RIU from riuAssociations and display its form answers:

```tsx
// In Overview tab content, after case overview section
{
  /* RIU Intake Details */
}
{
  caseData?.riuAssociations && caseData.riuAssociations.length > 0 && (
    <div className="mt-6">
      <h3 className="text-sm font-semibold text-gray-700 mb-3">
        Original Intake Details
      </h3>
      {(() => {
        const primaryRiu =
          caseData.riuAssociations.find(
            (a) => a.associationType === "PRIMARY",
          ) || caseData.riuAssociations[0];

        return (
          <LinkedRiuFormAnswers
            riuId={primaryRiu.riuId}
            riuType={primaryRiu.riu.type}
          />
        );
      })()}
    </div>
  );
}
```

Place this in a logical location - after the case summary but before or alongside the Linked Reports section.
</action>
<verify>
grep for "LinkedRiuFormAnswers" in case-tabs.tsx shows import and usage.
TypeScript compiles: `cd apps/frontend && npx tsc --noEmit`
</verify>
<done>Overview tab displays RIU intake form answers organized by section</done>
</task>

</tasks>

<verification>
Run after all tasks:
```bash
cd apps/backend && npx tsc --noEmit
cd apps/frontend && npx tsc --noEmit
grep -r "form-data" apps/backend/src/modules/rius/rius.controller.ts
grep -r "LinkedRiuFormAnswers" apps/frontend/src/components/cases/case-tabs.tsx
```
</verification>

<success_criteria>

1. GET /rius/:id/form-data endpoint returns structured form data by section
2. LinkedRiuFormAnswers component renders intake Q&A with collapsible sections
3. Overview tab in case detail shows original intake details
4. Different RIU types display appropriate fields (hotline vs web form vs disclosure)
   </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-09-SUMMARY.md`
</output>
