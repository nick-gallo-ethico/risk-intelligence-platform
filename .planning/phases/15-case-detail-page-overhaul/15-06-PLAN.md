---
phase: 15-case-detail-page-overhaul
plan: 06
type: execute
wave: 4
depends_on: ["15-05"]
files_modified:
  - apps/frontend/src/components/cases/ai-chat-panel.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "AI button in right column slides out a Sheet panel over the right column"
    - "AI panel connects to WebSocket /ai namespace for streaming chat"
    - "User can type questions and see AI responses streamed in real time"
    - "AI panel shows suggested prompts when empty"
    - "AI can execute actions (status changes, add notes) that reflect in the case"
    - "Sheet closes cleanly and disconnects WebSocket on close"
  artifacts:
    - path: "apps/frontend/src/components/cases/ai-chat-panel.tsx"
      provides: "AI chat panel with WebSocket streaming"
      contains: "AiChatPanel"
    - path: "apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx"
      provides: "Sheet wrapper for AI panel"
      contains: "Sheet"
  key_links:
    - from: "page.tsx"
      to: "ai-chat-panel.tsx"
      via: "import and render inside Sheet"
      pattern: "AiChatPanel"
    - from: "ai-chat-panel.tsx"
      to: "WebSocket /ai"
      via: "socket.io-client connection"
      pattern: 'io.*\/ai'
    - from: "ai-chat-panel.tsx"
      to: "/ai/agents/:type/suggestions"
      via: "REST call for suggested prompts"
      pattern: "/ai/agents/"
---

<objective>
Build the AI slide-out chat panel that overlays the right column using shadcn/ui Sheet, connected to the existing WebSocket /ai namespace for streaming chat responses.

Purpose: The AI panel is a core differentiator — investigators can ask questions about case data and have the AI execute actions (update status, add notes) directly. This plan builds the frontend panel; the backend AI gateway already exists (Phase 5).

Output: AiChatPanel component with WebSocket streaming, and Sheet integration in page.tsx.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
@apps/frontend/src/components/ui/sheet.tsx
@apps/backend/src/modules/ai/ai.gateway.ts
@apps/backend/src/modules/ai/ai.controller.ts
@.planning/phases/15-case-detail-page-overhaul/15-RESEARCH.md
@.planning/phases/15-case-detail-page-overhaul/15-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AiChatPanel component with WebSocket streaming</name>
  <files>
    apps/frontend/src/components/cases/ai-chat-panel.tsx
  </files>
  <action>
    Create the AI chat panel that connects to the WebSocket /ai namespace. This is a self-contained chat interface component.

    **Component structure:**
    - Props: `{ entityType: string; entityId: string; onActionComplete?: () => void }`
    - State: messages array, input text, streaming boolean, socket ref, error state

    **WebSocket connection:**
    - On mount, connect to WebSocket at `/ai` namespace using socket.io-client:
      ```typescript
      import { io, Socket } from 'socket.io-client';

      const socket = io(`${process.env.NEXT_PUBLIC_API_URL || ''}/ai`, {
        auth: { token: getAuthToken() },
        transports: ['websocket', 'polling'],
      });
      ```
    - Get auth token from localStorage or auth context (check how other WebSocket connections work in the codebase, e.g., notifications gateway)
    - Listen for events from the AI gateway:
      - `text_delta` - Append text chunk to current assistant message
      - `message_complete` - Mark streaming as done
      - `tool_use` - Show tool use indicator (e.g., "Updating case status...")
      - `error` - Show error message
      - `action_executed` - Call onActionComplete to refresh case data
    - On unmount (or Sheet close), disconnect socket cleanly

    **Sending messages:**
    - Emit `chat` event with: `{ message: input, entityType, entityId }`
    - Add user message to messages array
    - Add empty assistant message and set streaming=true
    - Clear input

    **UI layout:**
    - Header: "AI Assistant" with Sparkles icon, close hint
    - Messages area: Scrollable div, messages rendered as chat bubbles
      - User messages: right-aligned, blue background
      - Assistant messages: left-aligned, gray background
      - Streaming message shows blinking cursor at end
      - Tool use messages: centered, muted italic text (e.g., "Updating case status...")
    - Suggested prompts (when no messages yet):
      - Fetch from `apiClient.get('/ai/agents/case/suggestions')` or hardcode sensible defaults:
        - "Summarize this case"
        - "What are the key risk factors?"
        - "Suggest next steps"
        - "Draft an investigation plan"
      - Show as clickable chips/buttons that fill the input
    - Input area: Fixed at bottom with Textarea + Send button
      - Send on Enter (Shift+Enter for newline)
      - Disable send while streaming
      - Show stop button while streaming (emits 'stop' event to socket)

    **Error handling:**
    - If WebSocket fails to connect, show "AI service unavailable" with retry button
    - If individual message fails, show error inline in chat
    - If auth token missing, show "Please log in to use AI assistant"

    **Styling:**
    - Full height flex column layout
    - Messages area flex-1 with overflow-y-auto
    - Input area sticky at bottom with border-t
    - Use existing shadcn/ui components: Button, Textarea, Badge
    - Import Sparkles, Send, Square (for stop), Loader2 (for spinner) from lucide-react

    IMPORTANT: The AI panel must work even if the AI backend is not running — it should show a clear error state, not crash. Phase 16 fixes AI backend issues; this plan just builds the UI shell and WebSocket connection.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify the component exports AiChatPanel and imports socket.io-client.
  </verify>
  <done>
    AiChatPanel connects to WebSocket /ai namespace, streams AI responses, shows suggested prompts, handles tool use indicators, and has error states for when AI is unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AI panel as Sheet overlay in page.tsx</name>
  <files>
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
    Wire the AiChatPanel into page.tsx using shadcn/ui Sheet component.

    1. Import Sheet components:
       ```typescript
       import { Sheet, SheetContent, SheetHeader, SheetTitle } from '@/components/ui/sheet';
       import { AiChatPanel } from '@/components/cases/ai-chat-panel';
       ```

    2. The `aiPanelOpen` state should already exist from Plan 05. If not, add it:
       ```typescript
       const [aiPanelOpen, setAiPanelOpen] = useState(false);
       ```

    3. Add the Sheet at the end of the JSX (after the modals from Plan 04, before closing div):
       ```tsx
       {caseData && (
         <Sheet open={aiPanelOpen} onOpenChange={setAiPanelOpen}>
           <SheetContent side="right" className="w-[400px] sm:w-[480px] p-0">
             <AiChatPanel
               entityType="case"
               entityId={caseData.id}
               onActionComplete={fetchCase}
             />
           </SheetContent>
         </Sheet>
       )}
       ```

    4. The right column AI trigger button (from Plan 05) should already set `setAiPanelOpen(true)`. Verify this is the case.

    5. The Sheet slides in from the right, overlaying the right column. The width should be 400-480px to cover/slightly exceed the 300px right column.

    6. Use `p-0` on SheetContent to let AiChatPanel manage its own padding (full-bleed chat layout).

    7. When onActionComplete fires (AI executed an action like status change), call fetchCase() to refresh the case data. This ensures the page reflects AI-made changes immediately.

    DO NOT modify the Sheet component itself (apps/frontend/src/components/ui/sheet.tsx).
    DO NOT add keyboard shortcuts for AI panel in this plan.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify page.tsx imports Sheet and AiChatPanel. Verify the Sheet is rendered with side="right".
  </verify>
  <done>
    AI panel slides out from right side as Sheet overlay. Clicking "Ask AI Assistant" button opens it. Panel connects to WebSocket and shows chat interface. Closing Sheet disconnects cleanly. AI actions refresh case data.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/frontend && npx tsc --noEmit` passes
2. AiChatPanel component exists with WebSocket connection logic
3. Sheet component wraps AiChatPanel in page.tsx with side="right"
4. AI trigger button in right column opens the Sheet
5. Chat messages render as user/assistant bubbles
6. Suggested prompts shown when chat is empty
7. Stop button visible during streaming
8. Error state shown when AI service unavailable
9. Sheet closes cleanly (WebSocket disconnects)
</verification>

<success_criteria>

- AI panel slides out over right column when triggered
- WebSocket connects to /ai namespace with auth token
- User can send messages and see streaming AI responses
- Tool use indicators appear when AI executes actions
- AI actions trigger case data refresh
- Graceful degradation when AI service unavailable
- Sheet closes and WebSocket disconnects properly
  </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-06-SUMMARY.md`
</output>
