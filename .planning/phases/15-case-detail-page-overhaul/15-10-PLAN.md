---
phase: 15-case-detail-page-overhaul
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/ai/actions/actions/add-case-note.action.ts
  - apps/backend/src/modules/ai/actions/action.catalog.ts
  - apps/backend/src/modules/ai/actions/index.ts
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "User asks AI to add a note and sees the note appear in the Activity tab"
    - "User asks AI to change case status and sees the status badge update"
    - "User can see AI-initiated actions attributed to AI in the activity feed"
  artifacts:
    - path: "apps/backend/src/modules/ai/actions/actions/add-case-note.action.ts"
      provides: "AI action for adding notes to cases"
      min_lines: 50
  key_links:
    - from: "action.catalog.ts"
      to: "add-case-note.action.ts"
      via: "registerAction"
      pattern: "createAddCaseNoteAction"
---

<objective>
Add AI case note capability and verify AI action execution end-to-end.

Purpose: Close Gap 3 from Phase 15 verification - the existing add-note action only supports investigations (not cases). The change-status action supports cases but needs human verification.

Output: New add-case-note AI action and human verification checkpoint.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-case-detail-page-overhaul/15-VERIFICATION.md

# Existing AI action patterns

@apps/backend/src/modules/ai/actions/actions/add-note.action.ts
@apps/backend/src/modules/ai/actions/actions/change-status.action.ts
@apps/backend/src/modules/ai/actions/action.catalog.ts

# Phase 5 AI Infrastructure Dependency Note:

# This plan extends AI actions infrastructure established in Phase 5. The AI module,

# ActionCatalog, WebSocket streaming, and AI chat panel are all Phase 5 artifacts.

# Phase 15 depends on Phase 5 globally per ROADMAP - this plan adds case-specific actions.

</context>

<tasks>

<task type="auto">
  <name>Task 1: Create add-case-note AI action</name>
  <files>
apps/backend/src/modules/ai/actions/actions/add-case-note.action.ts
apps/backend/src/modules/ai/actions/action.catalog.ts
apps/backend/src/modules/ai/actions/index.ts
  </files>
  <action>
Create an add-case-note action that allows AI to add notes directly to cases (not just investigations).

Since cases don't have a dedicated CaseNote model, we'll log notes as Activity entries with action type "note_added".

1. Create apps/backend/src/modules/ai/actions/actions/add-case-note.action.ts:

```typescript
import { z } from "zod";
import {
  ActionDefinition,
  ActionCategory,
  ActionContext,
  UNDO_WINDOWS,
} from "../action.types";
import { PrismaService } from "../../../prisma/prisma.service";

export const addCaseNoteInputSchema = z.object({
  content: z.string().min(1).max(50000),
  noteType: z
    .enum(["GENERAL", "FOLLOW_UP", "FINDING", "RECOMMENDATION"])
    .optional()
    .default("GENERAL"),
});

export type AddCaseNoteInput = z.infer<typeof addCaseNoteInputSchema>;

export function createAddCaseNoteAction(
  prisma: PrismaService,
): ActionDefinition<AddCaseNoteInput> {
  return {
    id: "add-case-note",
    name: "Add Case Note",
    description: "Add a note to a case activity feed",
    category: ActionCategory.QUICK,
    entityTypes: ["case"], // Only cases, investigations use add-note
    requiredPermissions: ["cases:notes:create"],
    undoWindowSeconds: UNDO_WINDOWS.QUICK,
    inputSchema: addCaseNoteInputSchema,

    async generatePreview(input: AddCaseNoteInput, context: ActionContext) {
      return {
        description: `Add a ${input.noteType.toLowerCase()} note to case`,
        changes: [
          {
            field: "activity",
            oldValue: null,
            newValue:
              input.content.slice(0, 100) +
              (input.content.length > 100 ? "..." : ""),
          },
        ],
      };
    },

    async execute(input: AddCaseNoteInput, context: ActionContext) {
      if (context.entityType !== "case") {
        return {
          success: false,
          message:
            "add-case-note only supports cases. Use add-note for investigations.",
        };
      }

      // Get user name for activity description
      const user = await prisma.user.findUnique({
        where: { id: context.userId },
        select: { firstName: true, lastName: true },
      });
      const userName = user
        ? `${user.firstName} ${user.lastName}`
        : "AI Assistant";

      // Log note as Activity entry
      const activity = await prisma.activity.create({
        data: {
          organizationId: context.organizationId,
          entityType: "CASE",
          entityId: context.entityId,
          userId: context.userId,
          action: "note_added",
          description: input.content,
          actionDescription: `${userName} added a ${input.noteType.toLowerCase()} note via AI`,
          metadata: {
            noteType: input.noteType,
            source: "ai_action",
          },
        },
      });

      return {
        success: true,
        message: `Note added to case`,
        previousState: { activityId: activity.id },
        newState: { activityId: activity.id, noteType: input.noteType },
      };
    },

    async undo(
      actionId: string,
      previousState: Record<string, unknown>,
      context: ActionContext,
    ) {
      const activityId = previousState.activityId as string;
      if (!activityId) {
        throw new Error("Cannot undo: activityId not found");
      }

      await prisma.activity.delete({
        where: { id: activityId },
      });
    },
  };
}

// Placeholder for catalog registration
export const addCaseNoteAction: ActionDefinition<AddCaseNoteInput> = {
  id: "add-case-note",
  name: "Add Case Note",
  description: "Add a note to a case activity feed",
  category: ActionCategory.QUICK,
  entityTypes: ["case"],
  requiredPermissions: ["cases:notes:create"],
  undoWindowSeconds: UNDO_WINDOWS.QUICK,
  inputSchema: addCaseNoteInputSchema,

  async generatePreview(input: AddCaseNoteInput, context: ActionContext) {
    return {
      description: `Add a ${input.noteType.toLowerCase()} note to case`,
      changes: [
        {
          field: "activity",
          oldValue: null,
          newValue: input.content.slice(0, 100),
        },
      ],
    };
  },

  async execute() {
    return { success: false, message: "Not initialized" };
  },

  async undo() {
    throw new Error("Not initialized");
  },
};
```

2. Update apps/backend/src/modules/ai/actions/action.catalog.ts:

- Import createAddCaseNoteAction
- Register it in onModuleInit alongside add-note and change-status

3. Update apps/backend/src/modules/ai/actions/index.ts:

- Add export for add-case-note.action
  </action>
  <verify>
  File exists: ls apps/backend/src/modules/ai/actions/actions/add-case-note.action.ts
  Registered in catalog: grep "addCaseNote" apps/backend/src/modules/ai/actions/action.catalog.ts
  TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
  </verify>
  <done>add-case-note AI action exists and is registered in ActionCatalog</done>
  </task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
AI action system with three actions:
1. add-case-note (new): Adds notes to case activity feed
2. add-note (existing): Adds notes to investigations
3. change-status (existing): Changes case or investigation status
  </what-built>
  <how-to-verify>
1. Start the application (both backend and frontend)
2. Navigate to a case detail page: /cases/[any-case-id]
3. Click "Ask AI Assistant" button in the right column
4. Wait for WebSocket connection (green status indicator)

**Test 1: Add Case Note**

- Type: "Add a note saying 'This case requires immediate attention due to severity'"
- Expected: AI responds with confirmation, note appears in Activity tab

**Test 2: Change Status**

- Type: "Change the status of this case to Open"
- Expected: AI responds with confirmation, status badge updates

**Verification checklist:**

- [ ] AI panel connects (green indicator)
- [ ] AI responds to queries within 5 seconds
- [ ] AI can add notes to cases
- [ ] AI can change case status
- [ ] Actions appear in Activity feed
- [ ] Page refreshes after action (via onActionComplete callback)

If any test fails, document the error message and behavior.
</how-to-verify>
<resume-signal>Type "verified" with results, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
Backend verification:
```bash
cd apps/backend && npx tsc --noEmit
grep -r "add-case-note" apps/backend/src/modules/ai/actions/
```

Human verification covers runtime behavior.
</verification>

<success_criteria>

1. add-case-note AI action is registered and functional
2. User can ask AI to add notes and see them appear in Activity tab
3. User can ask AI to change status and see the badge update
4. All AI actions are attributed in the activity feed
5. Human verification confirms end-to-end functionality
   </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-10-SUMMARY.md`
</output>
