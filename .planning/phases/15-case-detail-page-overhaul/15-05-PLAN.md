---
phase: 15-case-detail-page-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - apps/frontend/src/components/cases/connected-people-card.tsx
  - apps/frontend/src/components/cases/connected-documents-card.tsx
  - apps/frontend/src/components/cases/add-person-modal.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Right column shows connected people card with evidentiary labels (witness, subject, reporter)"
    - "Right column shows connected documents card with linked files"
    - "Connected people card has Add button that opens person-add modal"
    - "Connected documents card has Add button for attaching documents"
    - "People are fetched from GET /cases/:id/persons API endpoint"
    - "AI panel trigger button exists in right column"
  artifacts:
    - path: "apps/frontend/src/components/cases/connected-people-card.tsx"
      provides: "Right column people cards with role labels and Add button"
      contains: "ConnectedPeopleCard"
    - path: "apps/frontend/src/components/cases/connected-documents-card.tsx"
      provides: "Right column document cards with Add button"
      contains: "ConnectedDocumentsCard"
    - path: "apps/frontend/src/components/cases/add-person-modal.tsx"
      provides: "Modal to add person to case with search or free-form"
      contains: "AddPersonModal"
  key_links:
    - from: "page.tsx"
      to: "connected-people-card.tsx"
      via: "import and render in right column"
      pattern: "ConnectedPeopleCard"
    - from: "connected-people-card.tsx"
      to: "/cases/:id/persons"
      via: "apiClient.get fetch"
      pattern: "/persons"
    - from: "add-person-modal.tsx"
      to: "/cases/:id/persons"
      via: "apiClient.post for association"
      pattern: "POST.*persons"
---

<objective>
Build the right column content: connected people cards with evidentiary labels, connected documents card, person-add modal, and the AI panel trigger button.

Purpose: The right column provides at-a-glance context about who and what is connected to this case. Investigators need to see subjects, witnesses, reporters, and linked documents without switching tabs. The Add buttons let them quickly associate new people and documents.

Output: ConnectedPeopleCard, ConnectedDocumentsCard, AddPersonModal components, and updated page.tsx right column.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
@apps/frontend/src/lib/api.ts
@apps/backend/src/modules/associations/person-case/person-case-association.service.ts
@.planning/phases/15-case-detail-page-overhaul/15-RESEARCH.md
@.planning/phases/15-case-detail-page-overhaul/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConnectedPeopleCard and AddPersonModal</name>
  <files>
    apps/frontend/src/components/cases/connected-people-card.tsx
    apps/frontend/src/components/cases/add-person-modal.tsx
  </files>
  <action>
    **1. connected-people-card.tsx:**
    - Props: `{ caseId: string; organizationId?: string }`
    - On mount, fetch connected people: `apiClient.get(`/cases/${caseId}/persons`)`
    - Display each person as a compact card row with:
      - Avatar (initials fallback using AvatarFallback from shadcn/ui)
      - Full name (bold)
      - Evidentiary label badge: REPORTER (blue), SUBJECT (red), WITNESS (amber) — use Badge component with appropriate variant colors
      - Role label badge (if exists): ASSIGNED_INVESTIGATOR (green), LEGAL_COUNSEL (purple) etc.
      - If person has jobTitle or department, show in muted text
    - Group by evidentiary label: show "Subjects" header, then subjects, "Witnesses" header, then witnesses, etc.
    - "Add Person" button at bottom (Plus icon + "Add Person" text)
    - Clicking Add Person sets `addPersonOpen` state to true, renders AddPersonModal
    - If no people connected, show subtle "No connected people" message with Add button
    - Loading state with Skeleton
    - Section header: "Connected People" with person count badge
    - Style: Card component wrapping the list, compact padding

    **2. add-person-modal.tsx:**
    - Props: `{ caseId: string; open: boolean; onOpenChange: (open: boolean) => void; onPersonAdded: () => void }`
    - Two modes:
      - **Search mode (default):** Input field to search existing persons by name or email. Calls `apiClient.get('/persons', { search: query })` on typing (debounced 300ms). Shows matching results as selectable rows.
      - **Free-form mode:** Toggle link "Or add new person" switches to form with fields: firstName, lastName, email (optional), phone (optional)
    - After selecting/creating person, show label selection:
      - Evidentiary label: Select with REPORTER, SUBJECT, WITNESS options
      - Notes: Optional textarea
    - Submit calls `apiClient.post(`/cases/${caseId}/persons`, { personId, evidentiaryLabel, notes })` for search mode
    - For free-form, first create person via POST /persons, then create association
    - On success: call onPersonAdded(), close
    - Use Dialog, Input, Select, Textarea, Button from shadcn/ui

    Both components: 'use client', handle errors gracefully (show inline error messages).

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify both files export named components.
  </verify>
  <done>
    ConnectedPeopleCard fetches and displays people grouped by label. AddPersonModal supports search and free-form person addition with evidentiary label selection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConnectedDocumentsCard and populate right column in page.tsx</name>
  <files>
    apps/frontend/src/components/cases/connected-documents-card.tsx
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
    **1. connected-documents-card.tsx:**
    - Props: `{ caseId: string }`
    - Fetch documents connected to case. Check what API exists:
      - Try `apiClient.get(`/cases/${caseId}/files`)` or `/storage/attachments?entityType=CASE&entityId=${caseId}`
      - Use whatever attachment/file endpoint the platform provides (from ModuleStorageService)
    - Display each document as a compact row:
      - File icon (use Lucide FileText, FileImage, FileSpreadsheet based on mime type or extension)
      - Filename (truncated if long)
      - File size (formatted: "2.4 MB")
      - Upload date
    - "Add Document" button at bottom (Plus icon + "Attach Document")
    - Clicking Add Document can open a file input or redirect to the Files tab. For V1, just switch to the Files tab: call a navigation helper or pass a callback that changes the tab to 'files'.
    - If no documents, show "No documents attached" with Add button
    - Section header: "Connected Documents" with count badge
    - Style: Card component, compact rows

    **2. Update page.tsx right column:**
    - Replace the right column placeholder content with actual components:
    ```tsx
    <aside className="border-l overflow-y-auto bg-gray-50/50 hidden lg:block">
      <div className="p-4 space-y-4">
        <ConnectedPeopleCard caseId={caseData.id} organizationId={caseData.organizationId} />
        <ConnectedDocumentsCard caseId={caseData.id} />
        <div className="pt-2">
          <Button
            variant="outline"
            className="w-full justify-start gap-2"
            onClick={() => setAiPanelOpen(true)}
          >
            <Sparkles className="w-4 h-4" />
            Ask AI Assistant
          </Button>
        </div>
      </div>
    </aside>
    ```
    - Import ConnectedPeopleCard, ConnectedDocumentsCard
    - Import Sparkles icon from lucide-react
    - Add `const [aiPanelOpen, setAiPanelOpen] = useState(false)` — the AI panel Sheet will be wired in Plan 06
    - Add `addPersonModalOpen` state and wire it if ConnectedPeopleCard needs it passed down, OR let ConnectedPeopleCard manage its own modal state internally (preferred — keeps page.tsx clean)

    IMPORTANT: Only render right column content when caseData is not null. Use conditional rendering or pass empty defaults.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify right column in page.tsx renders ConnectedPeopleCard, ConnectedDocumentsCard, and AI trigger button.
  </verify>
  <done>
    ConnectedDocumentsCard fetches and displays case documents. Right column populated with ConnectedPeopleCard, ConnectedDocumentsCard, and AI trigger button. AddPersonModal wired in ConnectedPeopleCard.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/frontend && npx tsc --noEmit` passes
2. ConnectedPeopleCard exists, fetches from /cases/:id/persons, groups by label
3. ConnectedDocumentsCard exists, fetches from appropriate file/attachment endpoint
4. AddPersonModal exists with search and free-form modes
5. Right column in page.tsx renders: ConnectedPeopleCard, ConnectedDocumentsCard, AI trigger button
6. Add Person button opens modal, successful add refreshes the people list
7. AI trigger button exists (sets aiPanelOpen state, actual panel in Plan 06)
</verification>

<success_criteria>

- Connected people card shows labeled people (SUBJECT in red, WITNESS in amber, REPORTER in blue)
- Connected documents card shows files with icons and metadata
- Add Person modal allows searching existing persons or adding free-form
- Right column is fully populated with real components (not placeholders)
- AI panel trigger button exists and sets state
  </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-05-SUMMARY.md`
</output>
