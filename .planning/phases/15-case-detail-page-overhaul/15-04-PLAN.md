---
phase: 15-case-detail-page-overhaul
plan: 04
type: execute
wave: 3
depends_on: ["15-01", "15-02"]
files_modified:
  - apps/frontend/src/components/cases/assign-modal.tsx
  - apps/frontend/src/components/cases/status-change-modal.tsx
  - apps/frontend/src/components/cases/merge-modal.tsx
  - apps/frontend/src/components/cases/add-note-modal.tsx
  - apps/frontend/src/components/cases/email-log-modal.tsx
  - apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Assign button opens modal showing available users and assigns case on submit"
    - "Status button opens modal for changing case status with rationale field"
    - "Merge button opens modal with case search and merge confirmation"
    - "Note action button opens modal to add a note logged to activity feed"
    - "Email action button opens modal to log an external email as activity entry"
    - "All modals close on success and trigger case data refresh"
  artifacts:
    - path: "apps/frontend/src/components/cases/assign-modal.tsx"
      provides: "AssignModal with user list and assignment"
      contains: "AssignModal"
    - path: "apps/frontend/src/components/cases/status-change-modal.tsx"
      provides: "StatusChangeModal with status dropdown and rationale"
      contains: "StatusChangeModal"
    - path: "apps/frontend/src/components/cases/merge-modal.tsx"
      provides: "MergeModal with case search and merge confirmation"
      contains: "MergeModal"
    - path: "apps/frontend/src/components/cases/add-note-modal.tsx"
      provides: "AddNoteModal for activity logging"
      contains: "AddNoteModal"
    - path: "apps/frontend/src/components/cases/email-log-modal.tsx"
      provides: "EmailLogModal for logging external emails"
      contains: "EmailLogModal"
  key_links:
    - from: "page.tsx"
      to: "assign-modal.tsx"
      via: "import and conditional render"
      pattern: "AssignModal"
    - from: "assign-modal.tsx"
      to: "/cases/:id"
      via: "PATCH API call for assignment"
      pattern: "casesApi"
    - from: "merge-modal.tsx"
      to: "/cases/:id/merge"
      via: "POST API call"
      pattern: "/merge"
    - from: "status-change-modal.tsx"
      to: "/cases/:id/status"
      via: "PATCH API call"
      pattern: "/status"
---

<objective>
Build the action modals that wire the header buttons (Assign, Status, Merge) and left column action buttons (Note, Email) to real backend APIs.

Purpose: Currently these buttons log to console. This plan makes them functional — investigators can assign cases, change statuses, merge cases, add notes, and log emails. Each modal is a separate component file (anti-pattern from research: don't inline modals in page.tsx).

Output: Five modal components and updated page.tsx to wire them together with open/close state management.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
@apps/frontend/src/components/cases/case-detail-header.tsx
@apps/frontend/src/lib/cases-api.ts
@apps/frontend/src/lib/api.ts
@.planning/phases/15-case-detail-page-overhaul/15-RESEARCH.md
@.planning/phases/15-case-detail-page-overhaul/15-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AssignModal, StatusChangeModal, and MergeModal</name>
  <files>
    apps/frontend/src/components/cases/assign-modal.tsx
    apps/frontend/src/components/cases/status-change-modal.tsx
    apps/frontend/src/components/cases/merge-modal.tsx
  </files>
  <action>
    Create three header-action modal components. Each uses shadcn/ui Dialog.

    **1. assign-modal.tsx:**
    - Props: `{ caseId: string; currentAssigneeIds: string[]; open: boolean; onOpenChange: (open: boolean) => void; onAssigned: () => void }`
    - On mount, fetch available users: `apiClient.get('/users')` — filter to show investigators/compliance officers
    - Display user list with Avatar, name, role. Highlight already-assigned users.
    - User selects one or more users via checkboxes
    - Submit button calls `casesApi.update(caseId, { assignedInvestigatorIds: [...selectedIds] })` (or PATCH /cases/:id with the assignment)
    - On success: call onAssigned(), close dialog
    - On error: show error in dialog (don't close)
    - Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter from shadcn/ui
    - Show loading state while fetching users
    - If no users available, show message "No investigators available"

    **2. status-change-modal.tsx:**
    - Props: `{ caseId: string; currentStatus: string; open: boolean; onOpenChange: (open: boolean) => void; onStatusChanged: () => void }`
    - Show a Select dropdown with available statuses: NEW, OPEN, CLOSED (from CaseStatus type)
    - Show a Textarea for rationale (required, min 10 characters)
    - If user selects CLOSED, show additional "Close Case" confirmation styling (yellow warning)
    - Submit calls PATCH /cases/:id/status with `{ status, rationale }`
    - On success: call onStatusChanged(), close dialog
    - Disable current status in the dropdown (can't change to same status)

    **3. merge-modal.tsx:**
    - Props: `{ caseId: string; caseReferenceNumber: string; open: boolean; onOpenChange: (open: boolean) => void; onMerged: () => void }`
    - Two-step flow:
      - Step 1: Search for target case. Input field for case reference number or ID. On typing, search cases via `apiClient.get('/cases', { search: query })`. Display matching cases as selectable cards (reference number, title, status).
      - Step 2: Confirm merge. Show source and target case info. Require a reason textarea (min 10 chars). Warning text: "This action cannot be undone. The source case will be marked as merged."
    - Submit calls `apiClient.post('/cases/${targetCaseId}/merge', { sourceCaseId: caseId, reason })` (POST to target, send source in body)
    - On success: call onMerged(), close dialog. The page should redirect to the target case since the current case is now a tombstone.
    - On error: show error message

    ALL modals:
    - 'use client'
    - Import from '@/components/ui/dialog', '@/components/ui/button', '@/components/ui/select', '@/components/ui/input', '@/components/ui/textarea'
    - Import apiClient from '@/lib/api' and/or casesApi from '@/lib/cases-api'
    - Handle loading states with disabled buttons and spinners
    - DO NOT use toast notifications (keep it simple — success = close + refresh)

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify all three files export their named components.
  </verify>
  <done>
    AssignModal shows user list and assigns case. StatusChangeModal has status dropdown + rationale. MergeModal has case search + confirmation flow. All call real backend APIs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AddNoteModal and EmailLogModal, wire all modals in page.tsx</name>
  <files>
    apps/frontend/src/components/cases/add-note-modal.tsx
    apps/frontend/src/components/cases/email-log-modal.tsx
    apps/frontend/src/app/(authenticated)/cases/[id]/page.tsx
  </files>
  <action>
    **1. add-note-modal.tsx:**
    - Props: `{ caseId: string; open: boolean; onOpenChange: (open: boolean) => void; onNoteAdded: () => void }`
    - Simple form: Textarea for note content (required, min 5 chars)
    - Submit creates activity log entry. Check what API is available:
      - Try POST /cases/:id/activity with `{ action: 'commented', description: noteText }` OR
      - Use the ActivityService pattern — call an appropriate endpoint
      - If no direct "add note" endpoint exists, use PATCH /cases/:id to add a note to customFields or use the activity service endpoint
    - On success: call onNoteAdded(), close dialog

    **2. email-log-modal.tsx:**
    - Props: `{ caseId: string; open: boolean; onOpenChange: (open: boolean) => void; onEmailLogged: () => void }`
    - Form fields:
      - Direction: Select with "Sent" / "Received" options
      - To/From: Text input for email address
      - Subject: Text input
      - Summary: Textarea for email content summary
      - Date: Date input (defaults to now)
    - Submit logs an activity entry (same approach as note, but with action type 'emailed' or similar)
    - This is NOT sending actual emails — it's logging that an email was sent/received externally

    **3. Wire all 5 modals in page.tsx:**
    - Add state for each modal: `const [assignModalOpen, setAssignModalOpen] = useState(false)`
    - Same for statusModal, mergeModal, noteModal, emailModal
    - Update handleAssign to: `setAssignModalOpen(true)`
    - Update handleChangeStatus to: `setStatusModalOpen(true)`
    - Update handleMerge to: `setMergeModalOpen(true)`
    - Update handleAction callback:
      ```typescript
      const handleAction = useCallback((action: string) => {
        switch (action) {
          case 'note': setNoteModalOpen(true); break;
          case 'email': setEmailModalOpen(true); break;
          case 'interview': console.log('Interview - coming soon'); break;
          case 'document': console.log('Document - coming soon'); break;
          case 'task': console.log('Task - coming soon'); break;
        }
      }, []);
      ```
    - Render all 5 modals at the bottom of the JSX (after the grid, before closing div):
      ```tsx
      <AssignModal
        caseId={caseData?.id ?? ''}
        currentAssigneeIds={caseData?.assignedInvestigatorIds ?? []}
        open={assignModalOpen}
        onOpenChange={setAssignModalOpen}
        onAssigned={fetchCase}
      />
      {/* ... similar for all modals */}
      ```
    - On modal success callbacks, call `fetchCase()` to refresh case data
    - For MergeModal, on success redirect to target case: `router.push('/cases/${targetId}')`

    IMPORTANT: Only render modals when caseData is not null (guard with && caseData). Otherwise modal props will be invalid.

  </action>
  <verify>
    Run `cd apps/frontend && npx tsc --noEmit`. Verify page.tsx imports all 5 modal components and has open state for each.
  </verify>
  <done>
    AddNoteModal and EmailLogModal created. All 5 modals wired in page.tsx with open/close state. Header buttons (Assign, Status, Merge) open their modals. Action buttons (Note, Email) open their modals. Interview, Document, Task show "coming soon" in console.
  </done>
</task>

</tasks>

<verification>
1. `cd apps/frontend && npx tsc --noEmit` passes
2. Five modal component files exist in apps/frontend/src/components/cases/
3. page.tsx imports and renders all 5 modals with open/close state
4. Clicking "Assign" in header opens AssignModal
5. Clicking "Status" in header opens StatusChangeModal
6. Clicking "Merge" in header opens MergeModal
7. Clicking "Note" in left column opens AddNoteModal
8. Clicking "Email" in left column opens EmailLogModal
9. All modals call real backend APIs on submit
10. All modals close on success and trigger case data refresh
</verification>

<success_criteria>

- Assign modal fetches users and assigns case via PATCH
- Status modal changes status with rationale via PATCH /cases/:id/status
- Merge modal searches cases and merges via POST /cases/:id/merge
- Note modal adds note to activity feed
- Email modal logs external email as activity entry
- All modals are separate component files (not inline in page.tsx)
- Page refreshes case data after any modal action
  </success_criteria>

<output>
After completion, create `.planning/phases/15-case-detail-page-overhaul/15-04-SUMMARY.md`
</output>
