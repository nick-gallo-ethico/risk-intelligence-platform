---
phase: 23-help-support-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/help/help.module.ts
  - apps/backend/src/modules/help/controllers/knowledge-base.controller.ts
  - apps/backend/src/modules/help/controllers/support-tickets.controller.ts
  - apps/backend/src/modules/help/services/knowledge-base.service.ts
  - apps/backend/src/modules/help/services/support-tickets.service.ts
  - apps/backend/src/modules/help/dto/knowledge-base.dto.ts
  - apps/backend/src/modules/help/dto/support-ticket.dto.ts
  - apps/backend/src/modules/help/dto/index.ts
  - apps/backend/src/modules/help/entities/help.types.ts
  - apps/backend/src/modules/help/entities/index.ts
  - apps/backend/src/modules/help/listeners/ticket.listener.ts
  - apps/backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/help/articles returns published articles (global + tenant-specific)"
    - "GET /api/v1/help/articles/:slug returns a single article by slug"
    - "GET /api/v1/help/categories returns article categories with counts"
    - "POST /api/v1/help/tickets creates a support ticket with auto-generated TICKET-XXXX number"
    - "GET /api/v1/help/tickets returns the current user's tickets"
    - "Ticket creation emits support.ticket.created event for notification listener"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "KnowledgeBaseArticle and SupportTicket models, TicketStatus and TicketPriority enums, SUPPORT_TICKET in AttachmentEntityType"
      contains: "model KnowledgeBaseArticle"
    - path: "apps/backend/src/modules/help/help.module.ts"
      provides: "NestJS HelpModule registration"
      exports: ["HelpModule"]
    - path: "apps/backend/src/modules/help/services/knowledge-base.service.ts"
      provides: "Article search and retrieval with multi-tenant query (orgId OR null)"
      exports: ["KnowledgeBaseService"]
    - path: "apps/backend/src/modules/help/services/support-tickets.service.ts"
      provides: "Ticket CRUD with auto-numbered TICKET-XXXX format"
      exports: ["SupportTicketsService"]
  key_links:
    - from: "apps/backend/src/modules/help/controllers/knowledge-base.controller.ts"
      to: "apps/backend/src/modules/help/services/knowledge-base.service.ts"
      via: "NestJS dependency injection"
      pattern: "constructor.*KnowledgeBaseService"
    - from: "apps/backend/src/modules/help/listeners/ticket.listener.ts"
      to: "NotificationService"
      via: "@OnEvent('support.ticket.created')"
      pattern: "OnEvent.*support\\.ticket\\.created"
    - from: "apps/backend/src/app.module.ts"
      to: "apps/backend/src/modules/help/help.module.ts"
      via: "imports array"
      pattern: "HelpModule"
---

<objective>
Create the backend infrastructure for the Help & Support system: Prisma database models (KnowledgeBaseArticle, SupportTicket), NestJS module with controllers and services for knowledge base article retrieval and support ticket management.

Purpose: This is the foundation that all frontend help pages will consume. Without these models and endpoints, no help content can be served and no tickets can be filed.
Output: Working REST API endpoints for article search/retrieval and ticket CRUD, plus database models ready for migration.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-help-support-system/23-RESEARCH.md

# Key reference files for patterns

@apps/backend/prisma/schema.prisma
@apps/backend/src/modules/storage/storage.controller.ts
@apps/backend/src/modules/notifications/services/notification.service.ts
@apps/backend/src/app.module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Prisma schema — add KnowledgeBaseArticle, SupportTicket models and enums</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following to the Prisma schema:

1. **TicketStatus enum** with values: OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED. Map to `@@map("ticket_status")`.

2. **TicketPriority enum** with values: LOW, MEDIUM, HIGH, URGENT. Map to `@@map("ticket_priority")`.

3. **KnowledgeBaseArticle model:**
   - `id` String @id @default(uuid())
   - `organizationId` String? (nullable — null means global article visible to all tenants)
   - `slug` String @unique — URL-friendly identifier
   - `title` String
   - `content` String @db.Text — HTML content
   - `excerpt` String? — short summary for list views
   - `category` String — e.g. "getting-started", "cases", "campaigns"
   - `sortOrder` Int @default(0)
   - `isPublished` Boolean @default(true)
   - `tags` String[] @default([])
   - `createdAt` DateTime @default(now())
   - `updatedAt` DateTime @updatedAt
   - Relation: `organization Organization? @relation(fields: [organizationId], references: [id])`
   - Indexes: `@@index([organizationId])`, `@@index([category])`, `@@index([isPublished])`
   - Map: `@@map("knowledge_base_articles")`

4. **SupportTicket model:**
   - `id` String @id @default(uuid())
   - `organizationId` String
   - `userId` String — submitting user
   - `ticketNumber` String @unique — human-readable TICKET-XXXX
   - `subject` String
   - `description` String @db.Text
   - `priority` TicketPriority @default(MEDIUM)
   - `status` TicketStatus @default(OPEN)
   - `category` String? — optional category tag
   - `createdAt` DateTime @default(now())
   - `updatedAt` DateTime @updatedAt
   - `resolvedAt` DateTime?
   - `closedAt` DateTime?
   - Relations: `organization Organization @relation(...)`, `user User @relation(...)`
   - Indexes: `@@index([organizationId])`, `@@index([organizationId, userId])`, `@@index([organizationId, status])`
   - Map: `@@map("support_tickets")`

5. **Add `SUPPORT_TICKET` to the existing `AttachmentEntityType` enum** so file attachments (screenshots) can be linked to tickets.

6. **Add the reverse relation arrays** to the Organization model (`knowledgeBaseArticles KnowledgeBaseArticle[]`, `supportTickets SupportTicket[]`) and User model (`supportTickets SupportTicket[]`).

After editing the schema, run:

```bash
cd apps/backend && npx prisma generate
```

Do NOT run `prisma migrate dev` — just generate the client so TypeScript types are available. The migration will be run at deployment time.
</action>
<verify>Run `cd apps/backend && npx prisma generate` — should complete without errors. Then run `npx prisma validate` to confirm schema validity.</verify>
<done>Prisma schema contains KnowledgeBaseArticle and SupportTicket models with all fields, enums, indexes, and relations. Prisma client generates successfully with new types available.</done>
</task>

<task type="auto">
  <name>Task 2: Backend help module — controllers, services, DTOs, event listener</name>
  <files>
    apps/backend/src/modules/help/help.module.ts
    apps/backend/src/modules/help/controllers/knowledge-base.controller.ts
    apps/backend/src/modules/help/controllers/support-tickets.controller.ts
    apps/backend/src/modules/help/services/knowledge-base.service.ts
    apps/backend/src/modules/help/services/support-tickets.service.ts
    apps/backend/src/modules/help/dto/knowledge-base.dto.ts
    apps/backend/src/modules/help/dto/support-ticket.dto.ts
    apps/backend/src/modules/help/dto/index.ts
    apps/backend/src/modules/help/entities/help.types.ts
    apps/backend/src/modules/help/entities/index.ts
    apps/backend/src/modules/help/listeners/ticket.listener.ts
    apps/backend/src/app.module.ts
  </files>
  <action>
Create the complete `apps/backend/src/modules/help/` directory tree:

**help.types.ts** — Constants for KB categories:

```typescript
export const KB_CATEGORIES = {
  GETTING_STARTED: { key: "getting-started", label: "Getting Started" },
  CASES: { key: "cases", label: "Cases" },
  INVESTIGATIONS: { key: "investigations", label: "Investigations" },
  CAMPAIGNS: { key: "campaigns", label: "Campaigns" },
  DISCLOSURES: { key: "disclosures", label: "Disclosures" },
  REPORTS: { key: "reports", label: "Reports & Analytics" },
  POLICIES: { key: "policies", label: "Policies" },
  SETTINGS: { key: "settings", label: "Settings & Admin" },
  FAQ: { key: "faq", label: "Frequently Asked Questions" },
} as const;
```

**knowledge-base.dto.ts:**

- `SearchArticlesQueryDto` with optional `q` (string), `category` (string) query params using class-validator decorators (`@IsOptional()`, `@IsString()`).

**support-ticket.dto.ts:**

- `CreateSupportTicketDto` with required `subject` (@IsString, @MinLength(5)), required `description` (@IsString, @MinLength(20)), optional `priority` (@IsEnum(TicketPriority)), optional `category` (@IsString, @IsOptional).
- `TicketQueryDto` with optional `status` (@IsEnum(TicketStatus), @IsOptional).

**knowledge-base.service.ts:**

- Inject PrismaService
- `searchArticles(organizationId: string, query?: string, category?: string)`: Query KnowledgeBaseArticle where `isPublished: true` AND `(organizationId = orgId OR organizationId IS NULL)`. If `query` provided, filter by title ILIKE or content ILIKE or tags array contains. If `category` provided, add category filter. Select only list fields (no full content). Order by sortOrder ASC, title ASC.
- `getArticleBySlug(organizationId: string, slug: string)`: Find unique by slug where published and (org match or global). Return full content.
- `getCategories(organizationId: string)`: Group published articles by category, return `{ key, label, count }[]`. Map category keys to labels using KB_CATEGORIES constant. Articles available = orgId match OR null orgId.

**support-tickets.service.ts:**

- Inject PrismaService, EventEmitter2
- `createTicket(organizationId: string, userId: string, dto: CreateSupportTicketDto)`: Count existing tickets for org, generate `TICKET-${String(count + 1).padStart(4, '0')}`, create ticket record, emit `support.ticket.created` event with `{ ticket, organizationId, userId }`. Return created ticket.
- `getMyTickets(organizationId: string, userId: string, status?: string)`: Find tickets for this user in this org, optionally filtered by status. Order by createdAt DESC. Return `{ tickets, total }`.
- `getTicketById(organizationId: string, userId: string, ticketId: string)`: Find single ticket by id, verify it belongs to user and org.

**knowledge-base.controller.ts:**

- Route prefix: `api/v1/help`
- Guards: `@UseGuards(JwtAuthGuard, TenantGuard)`
- `@Get('articles')` — calls `searchArticles` with `@TenantId()` orgId and query params
- `@Get('articles/:slug')` — calls `getArticleBySlug`
- `@Get('categories')` — calls `getCategories`

**support-tickets.controller.ts:**

- Route prefix: `api/v1/help/tickets`
- Guards: `@UseGuards(JwtAuthGuard, TenantGuard)`
- `@Post()` — calls `createTicket` with `@TenantId()` orgId, `@CurrentUser()` userId, and validated body
- `@Get()` — calls `getMyTickets` with orgId, userId, and optional status query param
- `@Get(':id')` — calls `getTicketById`

**ticket.listener.ts:**

- `@OnEvent('support.ticket.created', { async: true })` handler
- Looks up User by userId from event payload
- Calls NotificationService.notify() following the pattern from research:
  - category: NotificationCategory.SYSTEM (or closest match from existing enum)
  - type: NotificationType.SYSTEM
  - title: `Support ticket ${ticketNumber} received`
  - body: `We've received your support request: "${subject}". Our team will respond shortly.`
  - recipientUserId: userId
  - organizationId from event
- If NotificationService is not directly importable, use EventEmitter to emit a notification event that the existing notification system picks up.

**help.module.ts:**

- NestJS module importing PrismaModule
- Providers: KnowledgeBaseService, SupportTicketsService, TicketListener
- Controllers: KnowledgeBaseController, SupportTicketsController
- Exports: KnowledgeBaseService, SupportTicketsService

**app.module.ts:**

- Add `HelpModule` to the imports array.

Follow the existing codebase conventions exactly:

- Use `@TenantId()` decorator (from common/decorators) for organizationId extraction
- Use `@CurrentUser()` decorator for user context
- Use `@UseGuards(JwtAuthGuard, TenantGuard)` on controllers
- Use class-validator decorators on DTOs
- Use PrismaService for all database access
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` to verify TypeScript compilation. Check that all imports resolve and there are no type errors.</verify>
  <done>Complete help module with 2 controllers (KB + tickets), 2 services, DTOs, types, and event listener. Module registered in app.module.ts. All TypeScript compiles without errors.</done>
  </task>

</tasks>

<verification>
1. `cd apps/backend && npx prisma validate` passes
2. `cd apps/backend && npx prisma generate` succeeds
3. `cd apps/backend && npx tsc --noEmit` compiles without errors
4. HelpModule appears in app.module.ts imports
5. All 6 endpoint routes are defined (3 KB + 3 tickets)
</verification>

<success_criteria>

- Prisma schema has KnowledgeBaseArticle and SupportTicket models with correct fields, enums, and indexes
- SUPPORT_TICKET added to AttachmentEntityType enum
- Backend help module is complete with controllers, services, DTOs
- Article queries use the (orgId OR null) pattern for multi-tenancy
- Ticket creation auto-generates TICKET-XXXX numbers and emits events
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/23-help-support-system/23-01-SUMMARY.md`
</output>
