---
phase: 18-reports-data-management
plan: 07
type: execute
wave: 4
depends_on: ["18-05", "18-06"]
files_modified:
  - apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
  - apps/frontend/src/components/reports/ReportResultsViewer.tsx
  - apps/frontend/src/components/reports/ReportChart.tsx
  - apps/frontend/src/components/reports/ReportKpi.tsx
autonomous: true

must_haves:
  truths:
    - "Report detail page shows report config and results"
    - "Table visualization renders sortable data with pagination"
    - "Chart visualizations (bar, line, pie) render correctly with recharts"
    - "KPI visualization shows single metric with change indicator"
    - "Users can export report results from the detail page"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx"
      provides: "Report detail/results page"
      min_lines: 80
    - path: "apps/frontend/src/components/reports/ReportResultsViewer.tsx"
      provides: "Results display with auto-visualization selection"
      exports: ["ReportResultsViewer"]
    - path: "apps/frontend/src/components/reports/ReportChart.tsx"
      provides: "Chart rendering for bar, line, pie, stacked bar, funnel"
      exports: ["ReportChart"]
    - path: "apps/frontend/src/components/reports/ReportKpi.tsx"
      provides: "KPI card with value, change, and trend"
      exports: ["ReportKpi"]
  key_links:
    - from: "reports/[id]/page.tsx"
      to: "reports-api.ts"
      via: "API calls for report loading, running, and exporting"
      pattern: "reportsApi\\.(get|run|exportReport)"
    - from: "ReportChart.tsx"
      to: "recharts"
      via: "Chart rendering library"
      pattern: "from 'recharts'"
---

<objective>
Create the report detail/results page with visualization rendering. When a user opens a saved report, they see the results with appropriate chart or table visualization, plus actions to re-run, edit, export, and schedule.

Purpose: This is where users consume report results. The visualization must match the report configuration -- tables for tabular data, bar/line/pie charts for aggregated data, KPI cards for single metrics.

Output: /reports/[id] page with auto-visualization, recharts integration, and export actions.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/frontend/src/types/reports.ts
@apps/frontend/src/lib/reports-api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ReportChart and ReportKpi visualization components</name>
  <files>
    apps/frontend/src/components/reports/ReportChart.tsx
    apps/frontend/src/components/reports/ReportKpi.tsx
  </files>
  <action>
**ReportChart.tsx:**
A component that renders the appropriate recharts chart based on visualization type and data.

Props:

```typescript
{
  visualization: string;          // 'bar', 'line', 'pie', 'stacked_bar', 'funnel'
  groupedData: ReportGroupedItem[];
  chartConfig?: Record<string, unknown>;
  title?: string;
}
```

Use recharts (already installed). Import from 'recharts': BarChart, Bar, LineChart, Line, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, AreaChart, Area, FunnelChart, Funnel, LabelList.

Color palette: Use a consistent 8-color palette for chart segments:

```typescript
const CHART_COLORS = [
  "hsl(var(--chart-1))",
  "hsl(var(--chart-2))",
  "hsl(var(--chart-3))",
  "hsl(var(--chart-4))",
  "hsl(var(--chart-5))",
  "#6366f1",
  "#ec4899",
  "#f97316",
];
```

If CSS variables don't exist, fallback to hex colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#ec4899', '#f97316'].

For each visualization type:

**bar:** Vertical bar chart. X axis = label, Y axis = value. Use ResponsiveContainer (width="100%", height={400}).
**line:** Line chart with data points. X axis = label, Y axis = value. Include dots at data points.
**pie:** Pie chart with labels and legend. Use Cell components for colors. Inner radius 0 (full pie, not donut).
**stacked_bar:** Stacked bar chart. If groupedData has metadata with sub-categories, create stacked bars. Otherwise, fall back to regular bar.
**funnel:** Funnel chart showing decreasing values. Sort data by value descending.

All charts wrapped in ResponsiveContainer. Use Tooltip for hover details. Use Legend for multi-series.

Handle edge cases: empty data (show "No data" message), single data point (show as bar or KPI), very long labels (truncate on axis with tooltip for full text).

**ReportKpi.tsx:**
A KPI card component for single-metric reports.

Props:

```typescript
{
  value: number;
  label: string;
  previousValue?: number;
  format?: 'number' | 'percent' | 'currency';
}
```

Display:

- Large number (48px font, bold)
- Label below (14px, muted)
- If previousValue provided: show change percentage with up/down arrow and green/red coloring
  - Green + ArrowUp if current > previous
  - Red + ArrowDown if current < previous
  - Gray + Minus if unchanged

Format the number: Intl.NumberFormat for numbers (with commas), percent format for percentages, USD format for currency.

Use shadcn/ui Card component as wrapper.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
Both components export their named exports.
</verify>
<done>ReportChart renders bar, line, pie, stacked bar, and funnel charts with recharts. ReportKpi shows single metrics with change indicators.</done>
</task>

<task type="auto">
  <name>Task 2: ReportResultsViewer and /reports/[id] page</name>
  <files>
    apps/frontend/src/components/reports/ReportResultsViewer.tsx
    apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
  </files>
  <action>
**ReportResultsViewer.tsx:**
Main component that decides which visualization to render based on report config and data.

Props:

```typescript
{
  report: SavedReport;
  result: ReportResult | null;
  isLoading: boolean;
  onRun: () => void;
  onExport: (format: 'excel' | 'csv' | 'pdf') => void;
}
```

Rendering logic:

1. If isLoading: show Skeleton placeholders (full-width bar for chart area, table skeleton for table)
2. If result is null: show "Run Report" button with play icon
3. If visualization is 'table': render a data table using shadcn/ui Table (NOT DataTable from Phase 13 -- keep it simple). Show columns from result.columns, rows from result.rows. Add basic client-side sort on column headers. Show pagination if totalCount > rows.length.
4. If visualization is 'kpi': render ReportKpi with result.groupedData?.[0] or computed from result.rows
5. If visualization is 'bar', 'line', 'pie', 'stacked_bar', 'funnel': render ReportChart with result.groupedData. If no groupedData, show a message suggesting the user add grouping for chart visualizations.

Above the visualization, show a toolbar:

- "Run" button (refresh icon) to re-execute
- "Export" dropdown: Excel, CSV, PDF options
- Execution info: "X rows in Y ms" from result.summary (if available)
- Last run timestamp from report.lastRunAt

**reports/[id]/page.tsx:**
The report detail page. Layout:

Header section:

- Report name (h1)
- Report description (muted text)
- Metadata: entity type badge, visualization type badge, visibility badge, created by, last run date
- Action buttons: "Edit" (navigates to /reports/[id]/edit or opens wizard in edit mode), "Duplicate", "Delete" (with confirm dialog), "Schedule" (placeholder for now)

Main content:

- ReportResultsViewer taking full width

On page load:

1. Fetch report config: `reportsApi.get(id)`
2. If report.lastRunAt is recent (< 5 minutes), show cached results. Otherwise auto-run: `reportsApi.run(id)`
3. Store result in state

Handle the export action: call `reportsApi.exportReport(id, format)`. If it returns a jobId, show a toast "Export started, you'll be notified when it's ready" and optionally poll the export job status. If it returns a downloadUrl directly, trigger browser download.

Use useParams() from next/navigation to get the report ID.

Handle errors: report not found -> show 404 message. Run failure -> show error banner with retry button.

Use shadcn/ui: Card, Badge, Button, DropdownMenu, Skeleton, AlertDialog (for delete confirm), toast (sonner).
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
/reports/[id] page exports a default component.
ReportResultsViewer exports as named export.
</verify>
<done>Report detail page at /reports/[id] loads report config, auto-runs, and displays results with the correct visualization. Users can re-run, export, edit, duplicate, and delete from this page.</done>
</task>

</tasks>

<verification>
- /reports/[id] page loads a report and displays results
- Table visualization renders with sortable columns
- Bar/Line/Pie charts render correctly with recharts
- KPI card shows formatted number with change indicator
- Export button triggers download flow
- TypeScript compiles without errors
</verification>

<success_criteria>

1. Report detail page auto-runs and displays results on load
2. Table visualization shows columns and rows with pagination
3. Chart visualizations render bar, line, and pie charts with correct data
4. KPI visualization shows value with optional change indicator
5. Export dropdown offers Excel, CSV, PDF options
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-07-SUMMARY.md`
</output>
