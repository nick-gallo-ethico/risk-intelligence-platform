---
phase: 18-reports-data-management
plan: 06
type: execute
wave: 3
depends_on: ["18-03"]
files_modified:
  - apps/frontend/src/app/(authenticated)/reports/new/page.tsx
  - apps/frontend/src/components/reports/ReportDesignerWizard.tsx
  - apps/frontend/src/components/reports/DataSourceSelector.tsx
  - apps/frontend/src/components/reports/ReportFieldPicker.tsx
  - apps/frontend/src/components/reports/ReportFilterBuilder.tsx
autonomous: true

must_haves:
  truths:
    - "Users can create a report through a step-by-step wizard"
    - "Data source step lets users choose from 7 entity types"
    - "Field picker shows all available fields grouped by category with search"
    - "Filter builder lets users add AND/OR filter conditions"
    - "Visualization step lets users choose chart type"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/reports/new/page.tsx"
      provides: "Report creation page at /reports/new"
      min_lines: 30
    - path: "apps/frontend/src/components/reports/ReportDesignerWizard.tsx"
      provides: "Multi-step wizard for report creation"
      exports: ["ReportDesignerWizard"]
    - path: "apps/frontend/src/components/reports/DataSourceSelector.tsx"
      provides: "Entity type selection cards"
      exports: ["DataSourceSelector"]
    - path: "apps/frontend/src/components/reports/ReportFieldPicker.tsx"
      provides: "Field selection with groups, search, drag-reorder"
      exports: ["ReportFieldPicker"]
    - path: "apps/frontend/src/components/reports/ReportFilterBuilder.tsx"
      provides: "Filter condition builder"
      exports: ["ReportFilterBuilder"]
  key_links:
    - from: "ReportDesignerWizard.tsx"
      to: "reports-api.ts"
      via: "API calls for field loading and report saving"
      pattern: "reportsApi\\.(getFields|create)"
    - from: "ReportFieldPicker.tsx"
      to: "ColumnSelectionModal"
      via: "Reuses column picker pattern from Phase 13"
      pattern: "ReportField|PropertyPicker"
---

<objective>
Create the report designer wizard -- a multi-step form where users build custom reports by selecting data source, fields, filters, grouping, and visualization.

Purpose: This is the core user-facing feature of Phase 18. Without the designer wizard, users cannot create custom reports. The wizard guides users through the 5-step process: data source, fields, filters, visualization, save.

Output: ReportDesignerWizard component with 5 steps, plus supporting components for each step.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/frontend/src/components/views/ColumnSelectionModal.tsx
@apps/frontend/src/components/views/AdvancedFiltersPanel.tsx
@apps/frontend/src/types/reports.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: DataSourceSelector, ReportFieldPicker, ReportFilterBuilder components</name>
  <files>
    apps/frontend/src/components/reports/DataSourceSelector.tsx
    apps/frontend/src/components/reports/ReportFieldPicker.tsx
    apps/frontend/src/components/reports/ReportFilterBuilder.tsx
  </files>
  <action>
**DataSourceSelector.tsx:**
A grid of cards, one per entity type. Each card shows:
- Icon: Briefcase (cases), FileInput (rius), Users (persons), Megaphone (campaigns), FileText (policies), Shield (disclosures), Search (investigations) -- from lucide-react
- Name: "Cases", "Intake Reports (RIUs)", "People", "Campaigns", "Policies", "Disclosures", "Investigations"
- Short description: one line explaining what data this covers
- Card is selectable (highlighted border when selected)

Props: `{ selectedEntityType: string | null; onSelect: (type: string) => void }`

Display as a 3-column grid on large, 2 on medium, 1 on small. Use shadcn/ui Card component with cn() for conditional styling.

**ReportFieldPicker.tsx:**
Adapts the ColumnSelectionModal pattern from Phase 13 for the report designer context. Two-panel layout:

- Left panel: Available fields grouped by group name, with search input at top. Each group is collapsible (Collapsible from shadcn/ui). Each field shows its label, type badge (text, number, date), and an "Add" button (Plus icon).
- Right panel: Selected fields as an ordered list. Each item shows label with a drag handle and Remove button (X icon). Support drag-to-reorder using @dnd-kit/core (already installed).

Props:

```typescript
{
  entityType: string;
  selectedFields: string[];      // Array of field IDs
  onFieldsChange: (fields: string[]) => void;
}
```

On mount (or when entityType changes), fetch field groups via `reportsApi.getFields(entityType)`. Cache the result in state.

Search filters across all groups by field label (case-insensitive contains).

Show a field type badge: string fields get "Abc", number fields get "#", date fields get calendar icon, boolean fields get toggle icon, enum fields get list icon.

**ReportFilterBuilder.tsx:**
A simplified version of the AdvancedFiltersPanel from Phase 13, adapted for report filters. Each filter row has:

- Field selector (dropdown populated from available fields)
- Operator selector (dropdown: equals, not equals, contains, greater than, less than, between, in, is null, is not null -- filtered by field type)
- Value input (text input for strings, number input for numbers, date picker for dates, multi-select for enums)
- Remove button (X icon)

"Add Filter" button at the bottom. Filters are combined with AND logic (simplified from the Phase 13 AND/OR groups).

Props:

```typescript
{
  fields: ReportField[];          // Available fields from field registry
  filters: ReportFilter[];
  onFiltersChange: (filters: ReportFilter[]) => void;
}
```

Operator options per field type:

- string: equals, notEquals, contains, startsWith, isNull, isNotNull
- number: equals, notEquals, gt, gte, lt, lte, between, isNull
- date: equals, gt, gte, lt, lte, between, isNull
- boolean: equals
- enum: equals, notEquals, in, notIn, isNull

For enum fields, show a multi-select dropdown with the enumValues from the field definition.
For date fields, use a date picker (shadcn/ui calendar/popover pattern or a simple date input).

Use shadcn/ui components: Select, Input, Button, Popover, Calendar (if available), Badge.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
All three components export their named exports.
</verify>
<done>DataSourceSelector shows 7 entity type cards, ReportFieldPicker enables field selection with search and drag-reorder, ReportFilterBuilder allows adding filter conditions with type-appropriate inputs.</done>
</task>

<task type="auto">
  <name>Task 2: ReportDesignerWizard and /reports/new page</name>
  <files>
    apps/frontend/src/components/reports/ReportDesignerWizard.tsx
    apps/frontend/src/app/(authenticated)/reports/new/page.tsx
  </files>
  <action>
**ReportDesignerWizard.tsx:**
A multi-step wizard with 5 steps. Use a step indicator at the top showing: 1. Data Source, 2. Fields, 3. Filters, 4. Visualization, 5. Save.

State management: Use React useState for each piece of report config:

```typescript
const [step, setStep] = useState(1);
const [entityType, setEntityType] = useState<string | null>(null);
const [selectedFields, setSelectedFields] = useState<string[]>([]);
const [filters, setFilters] = useState<ReportFilter[]>([]);
const [groupBy, setGroupBy] = useState<string[]>([]);
const [aggregation, setAggregation] = useState<ReportAggregation | null>(null);
const [visualization, setVisualization] = useState("table");
const [chartConfig, setChartConfig] = useState<Record<string, unknown>>({});
const [sortBy, setSortBy] = useState<string | null>(null);
const [sortOrder, setSortOrder] = useState<"asc" | "desc">("desc");
const [name, setName] = useState("");
const [description, setDescription] = useState("");
const [visibility, setVisibility] = useState("PRIVATE");
```

Props:

```typescript
{
  templateId?: string;           // Pre-populate from template
  onSave: (report: SavedReport) => void;
  onCancel: () => void;
}
```

If templateId is provided, load the template on mount via `reportsApi.get(templateId)` and pre-populate all state.

**Step 1: Data Source**

- Render DataSourceSelector
- "Next" button enabled only when entityType is selected
- Description text: "Choose the type of data you want to report on"

**Step 2: Fields**

- Render ReportFieldPicker with the selected entityType
- "Next" enabled when at least 1 field is selected
- Description: "Select the fields to include in your report"

**Step 3: Filters (optional)**

- Render ReportFilterBuilder with fields from the field registry
- Optional step -- user can skip (Next always enabled)
- Also show:
  - "Group By" section: dropdown to select 0-3 fields to group by (only shows groupable fields)
  - "Aggregation" section: if groupBy selected, show aggregation function selector (COUNT, SUM, AVG) and optional field
  - "Sort" section: field dropdown + asc/desc toggle
- Description: "Add filters, grouping, and sorting (optional)"

**Step 4: Visualization**

- Grid of visualization type cards (similar to DataSourceSelector but for chart types):
  - Table (default), Bar Chart, Line Chart, Pie Chart, KPI, Stacked Bar, Funnel
  - Each card has an icon and name
  - Show a live preview panel below the cards (placeholder box with text "Preview will appear here when report is saved and run")
- Smart suggestion: If groupBy is set, suggest bar/pie. If no groupBy, suggest table.
- Description: "Choose how to display your results"

**Step 5: Save**

- Name input (required, max 100 chars)
- Description textarea (optional, max 500 chars)
- Visibility radio group: Private, Team, Everyone
- "Save Report" button that calls reportsApi.create() with all collected config
- "Save & Run" button that saves then navigates to /reports/[id] which will auto-run
- Description: "Name your report and choose who can see it"

Navigation: Back/Next buttons at the bottom. Step indicator shows completed steps with checkmarks. Steps are clickable for direct navigation (but only to completed steps).

**reports/new/page.tsx:**
Simple page that reads `searchParams.template` from URL, passes it to ReportDesignerWizard. On save, redirect to /reports/[id]. On cancel, redirect to /reports.

Use `useRouter()` and `useSearchParams()` from next/navigation.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
/reports/new/page.tsx exports a default component.
ReportDesignerWizard exports as named export.
</verify>
<done>Report designer wizard at /reports/new with 5 steps: data source, fields, filters, visualization, save. Supports pre-population from templates via URL parameter. Saves reports via API.</done>
</task>

</tasks>

<verification>
- /reports/new page renders the wizard
- Step 1 shows 7 data source cards
- Step 2 shows field picker with search and groups
- Step 3 shows filter builder with type-appropriate inputs
- Step 4 shows visualization type cards
- Step 5 shows save form with name, description, visibility
- Template pre-population works via ?template=id URL param
- TypeScript compiles without errors
</verification>

<success_criteria>

1. All 5 wizard steps render and navigate correctly
2. Field picker loads fields from API and supports search/drag-reorder
3. Filter builder shows appropriate operators per field type
4. Save button creates report via API and redirects to report detail
5. Template pre-population fills all fields from template config
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-06-SUMMARY.md`
</output>
