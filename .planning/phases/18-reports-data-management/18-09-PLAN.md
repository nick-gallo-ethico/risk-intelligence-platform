---
phase: 18-reports-data-management
plan: 09
type: execute
wave: 5
depends_on: ["18-07", "18-08"]
files_modified:
  - apps/frontend/src/components/reports/ScheduleReportDialog.tsx
  - apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
  - apps/backend/src/modules/analytics/reports/report.controller.ts
autonomous: true

must_haves:
  truths:
    - "Users can schedule recurring report delivery"
    - "Schedule configuration supports daily, weekly, monthly frequencies"
    - "Scheduled reports are delivered via email to specified recipients"
    - "Users can pause, resume, and run-now on scheduled reports"
  artifacts:
    - path: "apps/frontend/src/components/reports/ScheduleReportDialog.tsx"
      provides: "Dialog for configuring scheduled report delivery"
      exports: ["ScheduleReportDialog"]
  key_links:
    - from: "ScheduleReportDialog.tsx"
      to: "/api/v1/reports/:id/schedule"
      via: "Schedule creation API call"
      pattern: "apiClient\\.post.*schedule"
    - from: "reports/[id]/page.tsx"
      to: "ScheduleReportDialog"
      via: "Dialog triggered from report detail page"
      pattern: "ScheduleReportDialog"
    - from: "report.controller.ts"
      to: "scheduled-export.service.ts"
      via: "Schedule endpoint delegates to ScheduledExportService"
      pattern: "scheduledExportService\\."
---

<objective>
Create the scheduled report delivery UI and backend schedule endpoints, then integrate into the report detail page.

Purpose: Compliance teams need reports delivered on schedule (weekly case summary, monthly board report). The backend ScheduledExportService already handles the scheduling engine -- this plan adds the REST endpoints for schedule management and the frontend UI to configure and manage schedules.

Output: 7 backend schedule endpoints on ReportController, ScheduleReportDialog component, integration into report detail page with schedule management.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/backend/src/modules/analytics/exports/scheduled-export.service.ts
@apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScheduleReportDialog component</name>
  <files>
    apps/frontend/src/components/reports/ScheduleReportDialog.tsx
  </files>
  <action>
Create ScheduleReportDialog as a shadcn/ui Dialog for configuring scheduled report delivery.

Props:

```typescript
{
  open: boolean;
  onOpenChange: (open: boolean) => void;
  reportId: string;
  reportName: string;
  existingSchedule?: ScheduledExportConfig | null; // For editing existing schedule
  onScheduleCreated: (schedule: ScheduledExportConfig) => void;
}

interface ScheduledExportConfig {
  id?: string;
  name: string;
  scheduleType: 'DAILY' | 'WEEKLY' | 'MONTHLY';
  time: string;           // HH:MM format
  dayOfWeek?: number;     // 0-6 for weekly
  dayOfMonth?: number;    // 1-31 for monthly
  timezone: string;
  format: 'EXCEL' | 'CSV' | 'PDF';
  recipients: string[];   // Email addresses
  isActive: boolean;
}
```

Dialog layout:

**Schedule Name** (auto-populated from report name + " Schedule")

- Text input, editable

**Frequency section:**

- Radio group: Daily, Weekly, Monthly
- If Daily: just time picker
- If Weekly: day-of-week dropdown (Monday-Sunday) + time picker
- If Monthly: day-of-month number input (1-31) + time picker

**Time picker:**

- Two selects: hours (00-23) and minutes (00, 15, 30, 45) -- or a simple time input

**Timezone:**

- Select dropdown with common US/EU timezones. Default to browser timezone or 'America/New_York'.
- Options: America/New_York, America/Chicago, America/Denver, America/Los_Angeles, America/Anchorage, Pacific/Honolulu, Europe/London, Europe/Paris, Europe/Berlin, Asia/Tokyo, Asia/Shanghai, Australia/Sydney

**Format section:**

- Radio group: Excel (.xlsx), CSV, PDF

**Recipients section:**

- Email input with "Add" button. Shows added emails as badges with X to remove.
- Validate email format before adding.
- At least 1 recipient required.

**Footer:**

- "Cancel" button
- "Save Schedule" button (primary)
- If editing: "Delete Schedule" button (destructive, with confirmation)

On save:

1. Call `POST /api/v1/reports/:reportId/schedule` with the schedule config (for new schedules)
2. Call `PUT /api/v1/reports/:reportId/schedule` with updated config (for editing existing schedules)

Add to reports-api.ts:

```typescript
scheduleReport: (reportId: string, config: Omit<ScheduledExportConfig, 'id'>): Promise<ScheduledExportConfig> =>
  apiClient.post(`/reports/${reportId}/schedule`, config),

getSchedule: (reportId: string): Promise<ScheduledExportConfig | null> =>
  apiClient.get(`/reports/${reportId}/schedule`).catch(() => null),

updateSchedule: (reportId: string, config: Partial<ScheduledExportConfig>): Promise<ScheduledExportConfig> =>
  apiClient.put(`/reports/${reportId}/schedule`, config),

deleteSchedule: (reportId: string): Promise<void> =>
  apiClient.delete(`/reports/${reportId}/schedule`),

pauseSchedule: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/pause`),

resumeSchedule: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/resume`),

runScheduleNow: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/run-now`),
```

Handle errors: show toast on failure. Disable save button while submitting.

Use shadcn/ui: Dialog, DialogContent, DialogHeader, DialogTitle, RadioGroup, RadioGroupItem, Select, SelectContent, SelectItem, SelectTrigger, SelectValue, Input, Button, Badge, Label.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
ScheduleReportDialog exports as named export.
</verify>
<done>ScheduleReportDialog lets users configure daily/weekly/monthly report delivery with time, timezone, format, and recipient selection.</done>
</task>

<task type="auto">
  <name>Task 2: Backend schedule endpoints on ReportController</name>
  <files>
    apps/backend/src/modules/analytics/reports/report.controller.ts
    apps/backend/src/modules/analytics/reports/report.module.ts
  </files>
  <action>
Add 7 new schedule management endpoints to the ReportController. These endpoints do NOT exist in 18-03 -- they are new work created in this plan.

Inject ScheduledExportService into ReportController. Update ReportModule to import ExportsModule (or the specific ScheduledExportService provider) so it is available for injection.

Create these 7 endpoints:

1. `POST /api/v1/reports/:id/schedule` - Create a schedule for a report.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER, POLICY_AUTHOR
   - Body: { name, scheduleType, time, dayOfWeek?, dayOfMonth?, timezone, format, recipients }
   - Validate the report exists and belongs to the user's org
   - Create a ScheduledExport record via ScheduledExportService.createSchedule()
   - Link the ScheduledExport to the SavedReport by updating savedReport.scheduledExportId
   - Return the schedule config

2. `GET /api/v1/reports/:id/schedule` - Get the schedule for a report.
   - Roles: Any authenticated user
   - Look up the report, check scheduledExportId, return schedule details
   - Return null/404 if no schedule exists

3. `PUT /api/v1/reports/:id/schedule` - Update an existing schedule.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER, POLICY_AUTHOR
   - Body: Partial schedule config
   - Validate report and schedule exist
   - Update via ScheduledExportService

4. `DELETE /api/v1/reports/:id/schedule` - Delete a schedule.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER
   - Remove the ScheduledExport record
   - Clear the savedReport.scheduledExportId reference
   - Return 204 No Content

5. `POST /api/v1/reports/:id/schedule/pause` - Pause a schedule.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER, POLICY_AUTHOR
   - Validate report and schedule exist
   - Delegate to ScheduledExportService.pauseSchedule()
   - Return 200 with updated status

6. `POST /api/v1/reports/:id/schedule/resume` - Resume a paused schedule.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER, POLICY_AUTHOR
   - Validate report and schedule exist
   - Delegate to ScheduledExportService.resumeSchedule()
   - Return 200 with updated status

7. `POST /api/v1/reports/:id/schedule/run-now` - Trigger immediate execution.
   - Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER
   - Validate report and schedule exist
   - Delegate to ScheduledExportService.runNow() or equivalent
   - Return 202 Accepted

Each endpoint: look up the report first, verify organizationId matches the user's org, then delegate to ScheduledExportService methods.

Add Swagger decorators to all 7 endpoints.
</action>
<verify>
`cd apps/backend && npx tsc --noEmit --pretty` compiles without errors.
7 schedule endpoints exist on the ReportController.
ScheduledExportService is successfully injected.
</verify>
<done>ReportController has 7 new schedule management endpoints (create, get, update, delete, pause, resume, run-now) that delegate to ScheduledExportService. All endpoints enforce tenant isolation via organizationId verification.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate schedule into report detail page</name>
  <files>
    apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
  </files>
  <action>
Update the report detail page (/reports/[id]/page.tsx) to add schedule management:

1. "Schedule" button (Clock icon from lucide-react) in the page header actions that opens ScheduleReportDialog

2. If report has an existing schedule (report.scheduledExportId is set):
   - Show schedule status badge: "Scheduled: Daily at 8:00 AM" or "Scheduled: Weekly Mon 9:00 AM" etc.
   - "Pause/Resume" toggle button
   - "Run Now" button

3. On page load, if report.scheduledExportId exists, fetch the schedule details via `reportsApi.getSchedule(reportId)` to show the status badge.

4. After ScheduleReportDialog saves successfully, refresh the report data to show the updated schedule badge.

5. Pause/Resume button calls `reportsApi.pauseSchedule(reportId)` or `reportsApi.resumeSchedule(reportId)` and updates the local state.

6. Run Now button calls `reportsApi.runScheduleNow(reportId)` and shows a toast "Report scheduled for immediate delivery."

Use shadcn/ui: Button, Badge, DropdownMenu for schedule actions.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
Report detail page shows Schedule button.
</verify>
<done>Report detail page has schedule management (create, view status, pause/resume, run-now). Full scheduled report delivery pipeline is wired end-to-end.</done>
</task>

</tasks>

<verification>
- ScheduleReportDialog renders with frequency, time, timezone, format, and recipient fields
- 7 backend schedule endpoints compile and have correct route decorators
- Schedule creation calls backend and links to SavedReport
- Report detail page shows schedule status badge when scheduled
- Pause/Resume/Run-Now actions work
- Backend schedule endpoints enforce tenant isolation
- TypeScript compiles without errors (both frontend and backend)
</verification>

<success_criteria>

1. Users can schedule a report for daily/weekly/monthly delivery
2. Recipients receive emails at scheduled times (backend infrastructure handles delivery)
3. Schedule status is visible on report detail page
4. Pause/Resume/Run-Now actions function correctly
5. All backend endpoints enforce org-level access control
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-09-SUMMARY.md`
</output>
