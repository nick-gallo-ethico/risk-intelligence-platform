---
phase: 18-reports-data-management
plan: 09
type: execute
wave: 5
depends_on: ["18-07", "18-08"]
files_modified:
  - apps/frontend/src/components/reports/ScheduleReportDialog.tsx
  - apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Users can schedule recurring report delivery"
    - "Schedule configuration supports daily, weekly, monthly frequencies"
    - "Scheduled reports are delivered via email to specified recipients"
    - "Users can pause, resume, and run-now on scheduled reports"
  artifacts:
    - path: "apps/frontend/src/components/reports/ScheduleReportDialog.tsx"
      provides: "Dialog for configuring scheduled report delivery"
      exports: ["ScheduleReportDialog"]
  key_links:
    - from: "ScheduleReportDialog.tsx"
      to: "/api/v1/reports/:id/schedule"
      via: "Schedule creation API call"
      pattern: "apiClient\\.post.*schedule"
    - from: "reports/[id]/page.tsx"
      to: "ScheduleReportDialog"
      via: "Dialog triggered from report detail page"
      pattern: "ScheduleReportDialog"
---

<objective>
Create the scheduled report delivery UI and integrate it into the report detail page.

Purpose: Compliance teams need reports delivered on schedule (weekly case summary, monthly board report). The backend ScheduledExportService already handles the scheduling -- this plan adds the frontend UI to configure and manage schedules.

Output: ScheduleReportDialog component, integration into report detail page with schedule management.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/backend/src/modules/analytics/exports/scheduled-export.service.ts
@apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: ScheduleReportDialog component</name>
  <files>
    apps/frontend/src/components/reports/ScheduleReportDialog.tsx
  </files>
  <action>
Create ScheduleReportDialog as a shadcn/ui Dialog for configuring scheduled report delivery.

Props:

```typescript
{
  open: boolean;
  onOpenChange: (open: boolean) => void;
  reportId: string;
  reportName: string;
  existingSchedule?: ScheduledExportConfig | null; // For editing existing schedule
  onScheduleCreated: (schedule: ScheduledExportConfig) => void;
}

interface ScheduledExportConfig {
  id?: string;
  name: string;
  scheduleType: 'DAILY' | 'WEEKLY' | 'MONTHLY';
  time: string;           // HH:MM format
  dayOfWeek?: number;     // 0-6 for weekly
  dayOfMonth?: number;    // 1-31 for monthly
  timezone: string;
  format: 'EXCEL' | 'CSV' | 'PDF';
  recipients: string[];   // Email addresses
  isActive: boolean;
}
```

Dialog layout:

**Schedule Name** (auto-populated from report name + " Schedule")

- Text input, editable

**Frequency section:**

- Radio group: Daily, Weekly, Monthly
- If Daily: just time picker
- If Weekly: day-of-week dropdown (Monday-Sunday) + time picker
- If Monthly: day-of-month number input (1-31) + time picker

**Time picker:**

- Two selects: hours (00-23) and minutes (00, 15, 30, 45) -- or a simple time input

**Timezone:**

- Select dropdown with common US/EU timezones. Default to browser timezone or 'America/New_York'.
- Options: America/New_York, America/Chicago, America/Denver, America/Los_Angeles, America/Anchorage, Pacific/Honolulu, Europe/London, Europe/Paris, Europe/Berlin, Asia/Tokyo, Asia/Shanghai, Australia/Sydney

**Format section:**

- Radio group: Excel (.xlsx), CSV, PDF

**Recipients section:**

- Email input with "Add" button. Shows added emails as badges with X to remove.
- Validate email format before adding.
- At least 1 recipient required.

**Footer:**

- "Cancel" button
- "Save Schedule" button (primary)
- If editing: "Delete Schedule" button (destructive, with confirmation)

On save:

1. Call backend to create scheduled export. Use the existing ScheduledExport API. The endpoint would be either:
   - `POST /api/v1/reports/:reportId/schedule` (which the ReportController created in 18-03 would handle), or
   - Create via the flat export schedule endpoint with a reference to the report

Since we defined endpoint 12 in 18-03 (`POST /api/v1/reports/:id/schedule`), the controller should create a ScheduledExport record linked to the SavedReport via scheduledExportId.

Add to reports-api.ts:

```typescript
scheduleReport: (reportId: string, config: Omit<ScheduledExportConfig, 'id'>): Promise<ScheduledExportConfig> =>
  apiClient.post(`/reports/${reportId}/schedule`, config),

getSchedule: (reportId: string): Promise<ScheduledExportConfig | null> =>
  apiClient.get(`/reports/${reportId}/schedule`).catch(() => null),

updateSchedule: (reportId: string, config: Partial<ScheduledExportConfig>): Promise<ScheduledExportConfig> =>
  apiClient.put(`/reports/${reportId}/schedule`, config),

deleteSchedule: (reportId: string): Promise<void> =>
  apiClient.delete(`/reports/${reportId}/schedule`),

pauseSchedule: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/pause`),

resumeSchedule: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/resume`),

runScheduleNow: (reportId: string): Promise<void> =>
  apiClient.post(`/reports/${reportId}/schedule/run-now`),
```

Handle errors: show toast on failure. Disable save button while submitting.

Use shadcn/ui: Dialog, DialogContent, DialogHeader, DialogTitle, RadioGroup, RadioGroupItem, Select, SelectContent, SelectItem, SelectTrigger, SelectValue, Input, Button, Badge, Label.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
ScheduleReportDialog exports as named export.
</verify>
<done>ScheduleReportDialog lets users configure daily/weekly/monthly report delivery with time, timezone, format, and recipient selection.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate schedule into report detail page and add backend schedule endpoint</name>
  <files>
    apps/frontend/src/app/(authenticated)/reports/[id]/page.tsx
    apps/backend/src/modules/analytics/reports/report.controller.ts
  </files>
  <action>
**Update report detail page (/reports/[id]/page.tsx):**

Add to the report detail page header actions:

1. "Schedule" button (Clock icon) that opens ScheduleReportDialog
2. If report has an existing schedule (report.scheduledExportId is set):
   - Show schedule status badge: "Scheduled: Daily at 8:00 AM" or "Scheduled: Weekly Mon 9:00 AM" etc.
   - "Pause/Resume" toggle button
   - "Run Now" button

On page load, if report.scheduledExportId exists, fetch the schedule details to show the status badge.

After ScheduleReportDialog saves, refresh the report data to show the updated schedule badge.

**Update ReportController (backend):**

Add schedule-related endpoints to the ReportController if not already fully implemented in 18-03. The controller's `POST /reports/:id/schedule` endpoint should:

1. Validate the report exists and belongs to the user's org
2. Create a ScheduledExport record via ScheduledExportService.createSchedule()
3. Link the ScheduledExport to the SavedReport by updating savedReport.scheduledExportId
4. Return the schedule config

Add additional endpoints:

- `GET /reports/:id/schedule` - Get schedule for a report
- `PUT /reports/:id/schedule` - Update schedule
- `DELETE /reports/:id/schedule` - Delete schedule (unlinks from report)
- `POST /reports/:id/schedule/pause` - Pause schedule
- `POST /reports/:id/schedule/resume` - Resume schedule
- `POST /reports/:id/schedule/run-now` - Trigger immediate run

Each endpoint: look up the report, verify org ownership, then delegate to ScheduledExportService methods (pauseSchedule, resumeSchedule, runNow, etc.).

Inject ScheduledExportService into ReportController (add to ReportModule imports if needed -- may need to import ExportsModule or the specific service).
</action>
<verify>
`cd apps/backend && npx tsc --noEmit --pretty` compiles without errors.
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
Schedule endpoints exist on the ReportController.
Report detail page shows Schedule button.
</verify>
<done>Report detail page has schedule management (create, view status, pause/resume, run-now). Backend schedule endpoints delegate to existing ScheduledExportService. Full scheduled report delivery pipeline is wired end-to-end.</done>
</task>

</tasks>

<verification>
- ScheduleReportDialog renders with frequency, time, timezone, format, and recipient fields
- Schedule creation calls backend and links to SavedReport
- Report detail page shows schedule status badge when scheduled
- Pause/Resume/Run-Now actions work
- Backend schedule endpoints enforce tenant isolation
- TypeScript compiles without errors (both frontend and backend)
</verification>

<success_criteria>

1. Users can schedule a report for daily/weekly/monthly delivery
2. Recipients receive emails at scheduled times (backend infrastructure handles delivery)
3. Schedule status is visible on report detail page
4. Pause/Resume/Run-Now actions function correctly
5. All backend endpoints enforce org-level access control
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-09-SUMMARY.md`
</output>
