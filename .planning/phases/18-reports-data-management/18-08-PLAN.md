---
phase: 18-reports-data-management
plan: 08
type: execute
wave: 4
depends_on: ["18-03"]
files_modified:
  - apps/frontend/src/components/reports/AiReportGenerator.tsx
  - apps/frontend/src/components/views/ExportButton.tsx
  - apps/frontend/src/lib/reports-api.ts
autonomous: true

must_haves:
  truths:
    - "Users can generate reports from natural language questions"
    - "AI-generated reports show interpretation and can be saved"
    - "Export from saved views uses the existing backend export infrastructure"
    - "Export progress is tracked and download links provided"
  artifacts:
    - path: "apps/frontend/src/components/reports/AiReportGenerator.tsx"
      provides: "Natural language report generation dialog"
      exports: ["AiReportGenerator"]
  key_links:
    - from: "AiReportGenerator.tsx"
      to: "reports-api.ts"
      via: "AI generation endpoint"
      pattern: "reportsApi\\.aiGenerate"
    - from: "ExportButton.tsx"
      to: "/api/v1/exports"
      via: "Export job creation endpoint"
      pattern: "apiClient\\.post.*exports"
---

<objective>
Create the AI report generation UI and wire the export functionality from saved views to the backend export infrastructure.

Purpose: AI-powered report generation is a key differentiator -- users should be able to ask questions like "show me harassment cases from Q4 in EMEA" and get a report. Export from views integration closes gap 18.3 from V1-ISSUES-AND-GAPS.md.

Output: AiReportGenerator dialog component, enhanced ExportButton with backend wiring.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/frontend/src/components/views/ExportButton.tsx
@apps/frontend/src/lib/reports-api.ts
@apps/backend/src/modules/analytics/ai-query/ai-query.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AiReportGenerator dialog component</name>
  <files>
    apps/frontend/src/components/reports/AiReportGenerator.tsx
  </files>
  <action>
Create AiReportGenerator as a Dialog component that lets users generate reports from natural language.

Props:

```typescript
{
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onReportGenerated: (report: Partial<SavedReport>, results: ReportResult) => void;
}
```

Layout (inside shadcn/ui Dialog):

- Title: "Generate Report with AI"
- Description: "Describe the report you want in plain English"
- Large textarea input (4 rows) for the natural language query
- Example suggestions below the textarea (clickable to populate):
  - "Show me all harassment cases from Q4 2025"
  - "What are the top 5 categories by case volume this year?"
  - "How many cases are overdue by severity level?"
  - "Compare disclosure completion rates across business units"
  - "Monthly trend of new cases over the last 12 months"
- "Generate" button (primary, with sparkles icon from lucide-react)
- Loading state: show a spinner with "AI is analyzing your question..." text

On generate:

1. Call `reportsApi.aiGenerate(query)`
2. Show the result:
   - AI interpretation text (italic, muted) -- what the AI understood
   - Results preview: render ReportResultsViewer (from 18-07) with the returned results
   - Report config summary: entity type, field count, filter count, visualization type
3. Two actions:
   - "Save as Report" -- calls onReportGenerated with the report config and results, then the parent page navigates to save flow or creates the report directly
   - "Refine" -- keeps the dialog open with the query, user can edit and re-generate

Handle errors:

- AI unavailable: show a message "AI is temporarily unavailable. Try creating a report manually."
- Rate limit: show "You've reached the AI query limit. Try again in a few minutes."
- No results: show "No data matches your query. Try adjusting the question."

Use shadcn/ui: Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription, Textarea, Button, Badge, Separator, ScrollArea.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
AiReportGenerator exports as named export.
</verify>
<done>AiReportGenerator dialog lets users type natural language questions and generates reports with AI. Shows interpretation, results preview, and save option.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ExportButton to backend export infrastructure</name>
  <files>
    apps/frontend/src/components/views/ExportButton.tsx
  </files>
  <action>
Read the existing ExportButton.tsx first to understand current implementation.

Enhance the ExportButton to properly integrate with the backend export system. The ExportButton is used in saved views (Phase 13) and needs to:

1. When user clicks export:
   - Show format options: Excel (.xlsx), CSV, PDF
   - On format selection, create an export job via `POST /api/v1/exports/flat-file` with the current view's filters, columns, and selected format
   - The body should include: exportType (based on entity type being viewed), format, dateRange, statuses, categories (from current view filters), columnConfig

2. After job creation (202 Accepted response with jobId):
   - Show a toast: "Export started. We'll notify you when it's ready."
   - Start polling the job status via `GET /api/v1/exports/{jobId}` every 3 seconds
   - When status becomes COMPLETED: show toast with download link, trigger browser download via `GET /api/v1/exports/{jobId}/download`
   - When status becomes FAILED: show error toast
   - Stop polling after 5 minutes (timeout)

3. Add a small progress indicator:
   - While export is processing, show a spinning icon on the export button
   - Badge with "Exporting..." text

Import the apiClient from '@/lib/api' for making the export API calls. The endpoint format: `apiClient.post('/exports/flat-file', payload)` and `apiClient.get('/exports/{jobId}')`.

If the ExportButton currently does client-side export (e.g., generating CSV in browser), keep that as a fallback for small datasets (< 100 rows). Use the backend export for larger datasets.

Map the current view's entityType to the backend ExportType enum. The saved views already have column selection and filter state -- pass those through.

Update the component's props interface if needed to accept: entityType, filters, columns (these may already be available from the SavedViewProvider context).
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
ExportButton handles both small (client-side) and large (backend) exports.
</verify>
<done>ExportButton creates backend export jobs for large datasets, polls for completion, and triggers browser download. Maintains client-side export as fallback for small datasets.</done>
</task>

</tasks>

<verification>
- AiReportGenerator dialog opens and accepts natural language input
- AI generation call returns interpretation and results
- Generated reports can be saved
- ExportButton creates backend export jobs
- Export polling works (3s interval, 5min timeout)
- Download triggers on export completion
- TypeScript compiles without errors
</verification>

<success_criteria>

1. AI report generation works end-to-end (question -> results -> save)
2. Example queries are clickable and populate the input
3. ExportButton creates export jobs via backend API
4. Export completion triggers browser download
5. Error handling covers AI unavailable, rate limits, and export failures
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-08-SUMMARY.md`
</output>
