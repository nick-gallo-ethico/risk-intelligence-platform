---
phase: 18-reports-data-management
plan: 05
type: execute
wave: 3
depends_on: ["18-03"]
files_modified:
  - apps/frontend/src/app/(authenticated)/reports/page.tsx
  - apps/frontend/src/app/(authenticated)/reports/layout.tsx
  - apps/frontend/src/lib/reports-api.ts
  - apps/frontend/src/types/reports.ts
autonomous: true

must_haves:
  truths:
    - "Report list page is accessible at /reports with My Reports, Shared, and Templates tabs"
    - "Reports display in a table with name, owner, visualization type, last run, and actions"
    - "Template gallery shows pre-built templates with descriptions"
    - "Users can favorite, duplicate, delete, and run reports from the list"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/reports/page.tsx"
      provides: "Report list page with tabs and table"
      min_lines: 100
    - path: "apps/frontend/src/lib/reports-api.ts"
      provides: "API client for report endpoints"
      exports: ["reportsApi"]
    - path: "apps/frontend/src/types/reports.ts"
      provides: "TypeScript types for reports"
      exports:
        ["SavedReport", "ReportField", "ReportFieldGroup", "ReportResult"]
  key_links:
    - from: "reports/page.tsx"
      to: "reports-api.ts"
      via: "API calls for listing and managing reports"
      pattern: "reportsApi\\."
    - from: "reports-api.ts"
      to: "/api/v1/reports"
      via: "HTTP requests to backend report endpoints"
      pattern: "apiClient\\.(get|post|put|delete).*reports"
---

<objective>
Create the /reports page with report list, template gallery, and report management actions.

Purpose: This is the main entry point for the report designer. Users come here to see their saved reports, browse templates, and create new reports. It replaces the "Coming Soon" placeholder in the existing ReportsList component.

Output: Working /reports page with My Reports, Shared Reports, and Templates tabs; API client; TypeScript types.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-reports-data-management/18-RESEARCH.md
@apps/frontend/src/components/analytics/reports-list.tsx
@apps/frontend/src/lib/analytics-api.ts
@apps/frontend/src/types/analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report types and API client</name>
  <files>
    apps/frontend/src/types/reports.ts
    apps/frontend/src/lib/reports-api.ts
  </files>
  <action>
Create types/reports.ts with comprehensive TypeScript types:

```typescript
// Enums (matching backend)
export const ReportVisualizationType = {
  TABLE: "table",
  BAR: "bar",
  LINE: "line",
  PIE: "pie",
  KPI: "kpi",
  FUNNEL: "funnel",
  STACKED_BAR: "stacked_bar",
} as const;
export type ReportVisualizationType =
  (typeof ReportVisualizationType)[keyof typeof ReportVisualizationType];

export const ReportVisibility = {
  PRIVATE: "PRIVATE",
  TEAM: "TEAM",
  EVERYONE: "EVERYONE",
} as const;
export type ReportVisibility =
  (typeof ReportVisibility)[keyof typeof ReportVisibility];

export const ReportEntityType = {
  CASES: "cases",
  RIUS: "rius",
  PERSONS: "persons",
  CAMPAIGNS: "campaigns",
  POLICIES: "policies",
  DISCLOSURES: "disclosures",
  INVESTIGATIONS: "investigations",
} as const;
export type ReportEntityType =
  (typeof ReportEntityType)[keyof typeof ReportEntityType];

// Report field for field picker
export interface ReportField {
  id: string;
  label: string;
  type: "string" | "number" | "date" | "boolean" | "enum";
  group: string;
  filterable: boolean;
  sortable: boolean;
  groupable: boolean;
  aggregatable: boolean;
  enumValues?: string[];
  isCustomProperty?: boolean;
}

export interface ReportFieldGroup {
  groupName: string;
  fields: ReportField[];
}

// Report filter
export interface ReportFilter {
  field: string;
  operator: string;
  value: unknown;
  valueTo?: unknown;
}

// Report aggregation
export interface ReportAggregation {
  function: "count" | "sum" | "avg" | "min" | "max";
  field?: string;
}

// Saved report
export interface SavedReport {
  id: string;
  organizationId: string;
  name: string;
  description?: string;
  entityType: string;
  columns: string[];
  filters: ReportFilter[];
  groupBy?: string[];
  aggregation?: ReportAggregation;
  visualization: string;
  chartConfig?: Record<string, unknown>;
  sortBy?: string;
  sortOrder?: "asc" | "desc";
  isTemplate: boolean;
  templateCategory?: string;
  visibility: string;
  lastRunAt?: string;
  lastRunDuration?: number;
  lastRunRowCount?: number;
  isFavorite: boolean;
  scheduledExportId?: string;
  createdById: string;
  createdBy?: { id: string; firstName: string; lastName: string };
  createdAt: string;
  updatedAt: string;
}

// Report execution result
export interface ReportResultColumn {
  key: string;
  label: string;
  type: string;
}

export interface ReportGroupedItem {
  label: string;
  value: number;
  metadata?: Record<string, unknown>;
}

export interface ReportResult {
  columns: ReportResultColumn[];
  rows: Array<Record<string, unknown>>;
  totalCount: number;
  groupedData?: ReportGroupedItem[];
  summary?: { totalRows: number; executionTimeMs: number };
}

// Create/Update DTOs
export interface CreateReportInput {
  name: string;
  description?: string;
  entityType: string;
  columns: string[];
  filters?: ReportFilter[];
  groupBy?: string[];
  aggregation?: ReportAggregation;
  visualization?: string;
  chartConfig?: Record<string, unknown>;
  sortBy?: string;
  sortOrder?: "asc" | "desc";
  visibility?: string;
}

export interface RunReportInput {
  overrideFilters?: ReportFilter[];
  limit?: number;
  offset?: number;
}

// AI generation result
export interface AiGeneratedReport {
  report: Partial<SavedReport>;
  results: ReportResult;
  interpretation: string;
}
```

Create lib/reports-api.ts with API client:

```typescript
import { apiClient } from "./api";
import type {
  SavedReport,
  ReportFieldGroup,
  ReportResult,
  CreateReportInput,
  RunReportInput,
  AiGeneratedReport,
} from "@/types/reports";

export const reportsApi = {
  // Field registry
  getFields: (entityType: string): Promise<ReportFieldGroup[]> =>
    apiClient.get<ReportFieldGroup[]>(`/reports/fields/${entityType}`),

  // Templates
  getTemplates: (): Promise<SavedReport[]> =>
    apiClient.get<SavedReport[]>("/reports/templates"),

  // CRUD
  list: (params?: {
    visibility?: string;
    isTemplate?: boolean;
    search?: string;
    page?: number;
    pageSize?: number;
  }): Promise<{ data: SavedReport[]; total: number }> => {
    const sp = new URLSearchParams();
    if (params?.visibility) sp.append("visibility", params.visibility);
    if (params?.isTemplate !== undefined)
      sp.append("isTemplate", String(params.isTemplate));
    if (params?.search) sp.append("search", params.search);
    if (params?.page) sp.append("page", String(params.page));
    if (params?.pageSize) sp.append("pageSize", String(params.pageSize));
    const q = sp.toString();
    return apiClient.get(`/reports${q ? `?${q}` : ""}`);
  },

  get: (id: string): Promise<SavedReport> =>
    apiClient.get<SavedReport>(`/reports/${id}`),

  create: (input: CreateReportInput): Promise<SavedReport> =>
    apiClient.post<SavedReport>("/reports", input),

  update: (
    id: string,
    input: Partial<CreateReportInput>,
  ): Promise<SavedReport> =>
    apiClient.put<SavedReport>(`/reports/${id}`, input),

  delete: (id: string): Promise<void> => apiClient.delete(`/reports/${id}`),

  // Execution
  run: (id: string, input?: RunReportInput): Promise<ReportResult> =>
    apiClient.post<ReportResult>(`/reports/${id}/run`, input || {}),

  // Actions
  duplicate: (id: string): Promise<SavedReport> =>
    apiClient.post<SavedReport>(`/reports/${id}/duplicate`),

  toggleFavorite: (id: string): Promise<{ isFavorite: boolean }> =>
    apiClient.post<{ isFavorite: boolean }>(`/reports/${id}/favorite`),

  exportReport: (
    id: string,
    format: "excel" | "csv" | "pdf",
  ): Promise<{ jobId?: string; downloadUrl?: string; status: string }> =>
    apiClient.post(`/reports/${id}/export`, { format }),

  // AI generation
  aiGenerate: (query: string): Promise<AiGeneratedReport> =>
    apiClient.post<AiGeneratedReport>("/reports/ai-generate", { query }),
};
```

  </action>
  <verify>
    `cd apps/frontend && npx tsc --noEmit --pretty 2>&1 | findstr "reports"` returns no errors.
  </verify>
  <done>Report TypeScript types and API client are complete and type-safe.</done>
</task>

<task type="auto">
  <name>Task 2: Report list page at /reports</name>
  <files>
    apps/frontend/src/app/(authenticated)/reports/page.tsx
    apps/frontend/src/app/(authenticated)/reports/layout.tsx
  </files>
  <action>
Create the /reports page. Check the existing app router structure to determine the correct path (it may be `app/(authenticated)/reports/` or `app/reports/` depending on layout groups). Match the existing pattern.

Create layout.tsx (minimal, just passes children through with page title metadata).

Create page.tsx with:

1. Three tabs at the top: "My Reports", "Shared Reports", "Templates" (use shadcn/ui Tabs component)
2. Search bar above the tabs for filtering by name
3. "Create Report" button in the top-right (links to /reports/new)
4. "Ask AI" button next to Create (opens a dialog for natural language query)

**My Reports tab:**

- Fetches reportsApi.list({ visibility: 'PRIVATE' })
- Displays in a table using the existing ReportsList component pattern (or enhance it)
- Columns: Favorite star, Name (+ description), Visualization type icon, Last Run (relative time), Actions (dropdown: Run, Edit, Duplicate, Delete)
- Clicking a report row navigates to /reports/[id]

**Shared Reports tab:**

- Fetches reportsApi.list({ visibility: 'TEAM' }) merged with visibility: 'EVERYONE'
- Same table format, but shows owner name

**Templates tab:**

- Fetches reportsApi.getTemplates()
- Display as a card grid (3 columns on lg, 2 on md, 1 on sm)
- Each card shows: icon based on visualization type, name, description, templateCategory badge
- "Use Template" button on each card -> navigates to /reports/new?template={id}

Use React state for active tab, search query. Use useEffect + fetch (or useCallback) for data loading. Handle loading states with Skeleton components. Handle empty states with appropriate messaging.

Add visualization type icons mapping: table -> TableIcon, bar -> BarChart3, line -> LineChart, pie -> PieChart, kpi -> Activity (from lucide-react).

Use shadcn/ui components: Tabs, TabsList, TabsTrigger, TabsContent, Input (for search), Button, Card, Badge, Skeleton, DropdownMenu.

Handle errors gracefully: if the API returns an error, show a toast or inline error message. Use the try-catch pattern with console.warn for non-critical failures.

Update the existing analytics-api.ts to remove the stub reports methods (they're now in reports-api.ts). Update the analytics.ts Report type to reference the new reports.ts type if needed, or deprecate it.
</action>
<verify>
`cd apps/frontend && npx tsc --noEmit --pretty` compiles without errors.
The /reports page file exists and exports a default component.
</verify>
<done>Working /reports page with My Reports, Shared Reports, and Templates tabs. Users can search, favorite, duplicate, delete, and navigate to report details. Template gallery shows pre-built templates as cards.</done>
</task>

</tasks>

<verification>
- /reports page renders with three tabs
- My Reports tab shows user's private reports
- Templates tab shows card grid of pre-built templates
- Search filters reports by name
- Create Report button links to /reports/new
- reportsApi client covers all backend endpoints
- TypeScript compiles without errors
</verification>

<success_criteria>

1. /reports page loads with three working tabs
2. Report table shows name, visualization icon, last run, actions
3. Template gallery shows cards with "Use Template" action
4. Search bar filters reports by name
5. API client methods match all backend endpoints
   </success_criteria>

<output>
After completion, create `.planning/phases/18-reports-data-management/18-05-SUMMARY.md`
</output>
