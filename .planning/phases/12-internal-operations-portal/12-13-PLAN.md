---
phase: 12-internal-operations-portal
plan: 13
type: execute
wave: 4
depends_on: [12-06, 12-12]
files_modified:
  - apps/ops-console/src/app/layout.tsx
  - apps/ops-console/src/app/page.tsx
  - apps/ops-console/src/components/InternalLayout.tsx
  - apps/ops-console/src/components/TenantSwitcher.tsx
  - apps/ops-console/src/components/ImpersonationBar.tsx
  - apps/ops-console/src/hooks/useImpersonation.ts
  - apps/ops-console/src/app/support/page.tsx
  - apps/ops-console/src/app/support/[orgId]/page.tsx
  - apps/ops-console/package.json
autonomous: true

must_haves:
  truths:
    - "Ops console is separate Next.js app at apps/ops-console"
    - "Impersonation bar shows persistent visual indicator with remaining time"
    - "Tenant switcher allows searching and entering client context"
    - "Support console shows error logs, config, job queues for impersonated tenant"
  artifacts:
    - path: "apps/ops-console/src/components/InternalLayout.tsx"
      provides: "Layout with impersonation bar and navigation"
      min_lines: 100
    - path: "apps/ops-console/src/app/support/[orgId]/page.tsx"
      provides: "Support console detail view"
      min_lines: 150
  key_links:
    - from: "useImpersonation"
      to: "/api/v1/internal/impersonation"
      via: "fetch"
      pattern: "impersonation/sessions"
---

<objective>
Create the Ops Console frontend app with Support Console UI.

Purpose: Per CONTEXT.md: separate admin subdomain (ops.ethico.com) with security isolation. Support Console enables tenant switching, impersonation with persistent banner, and debug access.

Output: apps/ops-console Next.js app with InternalLayout, TenantSwitcher, ImpersonationBar, Support Console pages.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-internal-operations-portal/12-CONTEXT.md
@.planning/phases/12-internal-operations-portal/12-06-SUMMARY.md
@.planning/phases/12-internal-operations-portal/12-12-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Ops Console App Structure</name>
  <files>
    apps/ops-console/package.json
    apps/ops-console/next.config.js
    apps/ops-console/tailwind.config.js
    apps/ops-console/tsconfig.json
    apps/ops-console/src/app/layout.tsx
    apps/ops-console/src/app/page.tsx
  </files>
  <action>
Create new Next.js app for ops console per CONTEXT.md architecture:

**package.json:**
```json
{
  "name": "@ethico/ops-console",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3002",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "14.2.x",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "@tanstack/react-query": "^5.0.0",
    "date-fns": "^3.0.0",
    "lucide-react": "^0.300.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.0.0",
    "tailwind-merge": "^2.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "autoprefixer": "^10.4.0",
    "postcss": "^8.4.0",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.0.0"
  }
}
```

**next.config.js:**
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Ops console runs on different subdomain
  basePath: '',
  async rewrites() {
    return [
      // Proxy API calls to backend
      {
        source: '/api/:path*',
        destination: 'http://localhost:3000/api/:path*',
      },
    ];
  },
};

module.exports = nextConfig;
```

**src/app/layout.tsx:**
```tsx
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import { QueryProvider } from '@/components/providers/QueryProvider';
import './globals.css';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
  title: 'Ethico Operations',
  description: 'Internal operations portal for Ethico teams',
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <QueryProvider>
          {children}
        </QueryProvider>
      </body>
    </html>
  );
}
```

**src/app/page.tsx:**
```tsx
import { redirect } from 'next/navigation';

export default function Home() {
  // Redirect to support console by default
  redirect('/support');
}
```

Create standard tailwind.config.js and tsconfig.json based on existing frontend app.
  </action>
  <verify>
1. `cd apps/ops-console && npm install` - Dependencies install
2. `cd apps/ops-console && npm run build` - Build succeeds
  </verify>
  <done>Ops console app structure created with Next.js 14</done>
</task>

<task type="auto">
  <name>Task 2: Create Impersonation Hook and Components</name>
  <files>
    apps/ops-console/src/hooks/useImpersonation.ts
    apps/ops-console/src/components/ImpersonationBar.tsx
    apps/ops-console/src/components/TenantSwitcher.tsx
    apps/ops-console/src/components/InternalLayout.tsx
  </files>
  <action>
Create impersonation UI components per CONTEXT.md (banner + colored border):

**hooks/useImpersonation.ts:**
```tsx
'use client';

import { useState, useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

interface ImpersonationSession {
  sessionId: string;
  organizationId: string;
  organizationName: string;
  reason: string;
  expiresAt: Date;
  remainingSeconds: number;
}

export function useImpersonation() {
  const queryClient = useQueryClient();
  const [sessionId, setSessionId] = useState<string | null>(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('impersonation_session_id');
    }
    return null;
  });

  // Validate session
  const { data: session, isLoading } = useQuery({
    queryKey: ['impersonation', sessionId],
    queryFn: async () => {
      if (!sessionId) return null;
      const res = await fetch(`/api/v1/internal/impersonation/sessions/${sessionId}/validate`, {
        method: 'POST',
      });
      if (!res.ok) {
        localStorage.removeItem('impersonation_session_id');
        return null;
      }
      return res.json() as Promise<{ valid: boolean; organizationId: string; expiresAt: string; remainingSeconds: number }>;
    },
    enabled: !!sessionId,
    refetchInterval: 60000, // Refresh every minute
  });

  // Start session mutation
  const startMutation = useMutation({
    mutationFn: async (data: { organizationId: string; reason: string; ticketId?: string }) => {
      const res = await fetch('/api/v1/internal/impersonation/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      if (!res.ok) throw new Error('Failed to start session');
      return res.json();
    },
    onSuccess: (data) => {
      setSessionId(data.sessionId);
      localStorage.setItem('impersonation_session_id', data.sessionId);
      queryClient.invalidateQueries({ queryKey: ['impersonation'] });
    },
  });

  // End session mutation
  const endMutation = useMutation({
    mutationFn: async () => {
      if (!sessionId) return;
      await fetch(`/api/v1/internal/impersonation/sessions/${sessionId}`, {
        method: 'DELETE',
      });
    },
    onSuccess: () => {
      setSessionId(null);
      localStorage.removeItem('impersonation_session_id');
      queryClient.invalidateQueries({ queryKey: ['impersonation'] });
    },
  });

  const startSession = useCallback(
    (organizationId: string, reason: string, ticketId?: string) => {
      return startMutation.mutateAsync({ organizationId, reason, ticketId });
    },
    [startMutation],
  );

  const endSession = useCallback(() => {
    return endMutation.mutateAsync();
  }, [endMutation]);

  // Get headers for API requests
  const getHeaders = useCallback(() => {
    if (!sessionId) return {};
    return { 'X-Impersonation-Session': sessionId };
  }, [sessionId]);

  return {
    session: session?.valid ? session : null,
    sessionId,
    isLoading,
    isImpersonating: session?.valid ?? false,
    remainingSeconds: session?.remainingSeconds ?? 0,
    startSession,
    endSession,
    getHeaders,
  };
}
```

**components/ImpersonationBar.tsx:**
```tsx
'use client';

import { useImpersonation } from '@/hooks/useImpersonation';
import { Shield, X, Clock } from 'lucide-react';
import { cn } from '@/lib/utils';

export function ImpersonationBar() {
  const { session, isImpersonating, remainingSeconds, endSession } = useImpersonation();

  if (!isImpersonating || !session) return null;

  const hours = Math.floor(remainingSeconds / 3600);
  const minutes = Math.floor((remainingSeconds % 3600) / 60);
  const isLowTime = remainingSeconds < 15 * 60; // Less than 15 min

  return (
    <div
      className={cn(
        'sticky top-0 z-50 flex items-center justify-between px-4 py-2 text-sm',
        'border-b-4',
        isLowTime
          ? 'bg-yellow-100 border-yellow-500 text-yellow-900'
          : 'bg-blue-100 border-blue-500 text-blue-900',
      )}
    >
      <div className="flex items-center gap-3">
        <Shield className="h-5 w-5" />
        <span className="font-medium">
          Impersonating: {session.organizationName || session.organizationId}
        </span>
        <span className="text-xs bg-white/50 px-2 py-0.5 rounded">
          {session.reason}
        </span>
      </div>

      <div className="flex items-center gap-4">
        <div className={cn('flex items-center gap-1', isLowTime && 'font-bold')}>
          <Clock className="h-4 w-4" />
          <span>
            {hours}h {minutes}m remaining
          </span>
        </div>
        <button
          onClick={() => endSession()}
          className="flex items-center gap-1 px-3 py-1 bg-white rounded border hover:bg-gray-50"
        >
          <X className="h-4 w-4" />
          End Session
        </button>
      </div>
    </div>
  );
}
```

**components/TenantSwitcher.tsx:**
```tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useImpersonation } from '@/hooks/useImpersonation';
import { Search, Building2, ExternalLink } from 'lucide-react';

interface Tenant {
  id: string;
  name: string;
  slug: string;
  status: string;
  _count: { users: number; cases: number };
}

export function TenantSwitcher() {
  const [query, setQuery] = useState('');
  const [reason, setReason] = useState('');
  const [selectedTenant, setSelectedTenant] = useState<Tenant | null>(null);
  const { startSession, isImpersonating } = useImpersonation();

  const { data: tenants, isLoading } = useQuery({
    queryKey: ['tenants', query],
    queryFn: async () => {
      const res = await fetch(`/api/v1/internal/support/tenants/search?query=${encodeURIComponent(query)}`);
      return res.json() as Promise<Tenant[]>;
    },
    enabled: query.length >= 2,
  });

  const handleStartSession = async () => {
    if (!selectedTenant || !reason) return;
    await startSession(selectedTenant.id, reason);
    setSelectedTenant(null);
    setReason('');
  };

  if (isImpersonating) {
    return null; // Don't show switcher while impersonating
  }

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-semibold">Enter Client Context</h2>

      {/* Search */}
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
        <input
          type="text"
          placeholder="Search by name, domain, or ID..."
          value={query}
          onChange={(e) => setQuery(e.target.value)}
          className="w-full pl-10 pr-4 py-2 border rounded-lg"
        />
      </div>

      {/* Results */}
      {query.length >= 2 && (
        <div className="border rounded-lg divide-y max-h-64 overflow-y-auto">
          {isLoading ? (
            <div className="p-4 text-center text-gray-500">Searching...</div>
          ) : tenants?.length === 0 ? (
            <div className="p-4 text-center text-gray-500">No tenants found</div>
          ) : (
            tenants?.map((tenant) => (
              <button
                key={tenant.id}
                onClick={() => setSelectedTenant(tenant)}
                className={cn(
                  'w-full p-3 text-left hover:bg-gray-50 flex items-center justify-between',
                  selectedTenant?.id === tenant.id && 'bg-blue-50',
                )}
              >
                <div className="flex items-center gap-3">
                  <Building2 className="h-5 w-5 text-gray-400" />
                  <div>
                    <div className="font-medium">{tenant.name}</div>
                    <div className="text-sm text-gray-500">{tenant.slug}</div>
                  </div>
                </div>
                <div className="text-sm text-gray-500">
                  {tenant._count.users} users, {tenant._count.cases} cases
                </div>
              </button>
            ))
          )}
        </div>
      )}

      {/* Start session form */}
      {selectedTenant && (
        <div className="p-4 border rounded-lg bg-gray-50 space-y-3">
          <div className="font-medium">
            Impersonate: {selectedTenant.name}
          </div>
          <input
            type="text"
            placeholder="Reason for access (min 10 chars)..."
            value={reason}
            onChange={(e) => setReason(e.target.value)}
            className="w-full px-3 py-2 border rounded"
          />
          <button
            onClick={handleStartSession}
            disabled={reason.length < 10}
            className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50"
          >
            Start Impersonation Session
          </button>
        </div>
      )}
    </div>
  );
}
```

**components/InternalLayout.tsx:**
```tsx
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { ImpersonationBar } from './ImpersonationBar';
import { cn } from '@/lib/utils';
import { Shield, ClipboardList, Headphones, TrendingUp, GraduationCap, Settings } from 'lucide-react';

const navItems = [
  { href: '/support', label: 'Support Console', icon: Shield },
  { href: '/implementation', label: 'Implementation', icon: ClipboardList },
  { href: '/hotline', label: 'Hotline Ops', icon: Headphones },
  { href: '/client-success', label: 'Client Success', icon: TrendingUp },
  { href: '/training', label: 'Training', icon: GraduationCap },
];

export function InternalLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();

  return (
    <div className="min-h-screen flex flex-col">
      {/* Impersonation bar (persistent when active) */}
      <ImpersonationBar />

      {/* Navigation */}
      <nav className="border-b bg-white">
        <div className="max-w-7xl mx-auto px-4">
          <div className="flex items-center h-14">
            <Link href="/" className="font-semibold text-lg">
              Ethico Ops
            </Link>
            <div className="ml-8 flex items-center gap-1">
              {navItems.map((item) => (
                <Link
                  key={item.href}
                  href={item.href}
                  className={cn(
                    'flex items-center gap-2 px-3 py-2 rounded-md text-sm',
                    pathname?.startsWith(item.href)
                      ? 'bg-blue-50 text-blue-700'
                      : 'text-gray-600 hover:bg-gray-50',
                  )}
                >
                  <item.icon className="h-4 w-4" />
                  {item.label}
                </Link>
              ))}
            </div>
          </div>
        </div>
      </nav>

      {/* Main content */}
      <main className="flex-1 bg-gray-50">
        <div className="max-w-7xl mx-auto px-4 py-6">
          {children}
        </div>
      </main>
    </div>
  );
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/ops-console && npx tsc --noEmit`</verify>
  <done>Impersonation hook and UI components with persistent banner</done>
</task>

<task type="auto">
  <name>Task 3: Create Support Console Pages</name>
  <files>
    apps/ops-console/src/app/support/page.tsx
    apps/ops-console/src/app/support/[orgId]/page.tsx
    apps/ops-console/src/app/support/layout.tsx
  </files>
  <action>
Create support console pages:

**support/layout.tsx:**
```tsx
import { InternalLayout } from '@/components/InternalLayout';

export default function SupportLayout({ children }: { children: React.ReactNode }) {
  return <InternalLayout>{children}</InternalLayout>;
}
```

**support/page.tsx:**
```tsx
'use client';

import { TenantSwitcher } from '@/components/TenantSwitcher';
import { useImpersonation } from '@/hooks/useImpersonation';
import Link from 'next/link';

export default function SupportConsolePage() {
  const { session, isImpersonating } = useImpersonation();

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-bold">Support Console</h1>

      {!isImpersonating ? (
        <div className="max-w-xl">
          <TenantSwitcher />
        </div>
      ) : (
        <div className="space-y-4">
          <p>
            Currently viewing: <strong>{session?.organizationId}</strong>
          </p>
          <div className="grid grid-cols-2 gap-4">
            <Link
              href={`/support/${session?.organizationId}/errors`}
              className="p-4 border rounded-lg hover:bg-gray-50"
            >
              <h3 className="font-medium">Error Logs</h3>
              <p className="text-sm text-gray-500">View recent errors and warnings</p>
            </Link>
            <Link
              href={`/support/${session?.organizationId}/config`}
              className="p-4 border rounded-lg hover:bg-gray-50"
            >
              <h3 className="font-medium">Configuration</h3>
              <p className="text-sm text-gray-500">View tenant configuration</p>
            </Link>
            <Link
              href={`/support/${session?.organizationId}/jobs`}
              className="p-4 border rounded-lg hover:bg-gray-50"
            >
              <h3 className="font-medium">Job Queues</h3>
              <p className="text-sm text-gray-500">View pending and running jobs</p>
            </Link>
            <Link
              href={`/support/${session?.organizationId}/search`}
              className="p-4 border rounded-lg hover:bg-gray-50"
            >
              <h3 className="font-medium">Search Index</h3>
              <p className="text-sm text-gray-500">View Elasticsearch status</p>
            </Link>
          </div>
        </div>
      )}
    </div>
  );
}
```

**support/[orgId]/page.tsx:**
```tsx
'use client';

import { useParams } from 'next/navigation';
import { useQuery } from '@tanstack/react-query';
import { useImpersonation } from '@/hooks/useImpersonation';
import { AlertCircle, Settings, Briefcase, Search, Clock, CheckCircle, XCircle } from 'lucide-react';

export default function TenantDetailPage() {
  const { orgId } = useParams();
  const { getHeaders } = useImpersonation();

  const { data: details, isLoading } = useQuery({
    queryKey: ['tenant-details', orgId],
    queryFn: async () => {
      const res = await fetch(`/api/v1/internal/support/tenants/${orgId}`, {
        headers: getHeaders(),
      });
      return res.json();
    },
  });

  const { data: errors } = useQuery({
    queryKey: ['tenant-errors', orgId],
    queryFn: async () => {
      const res = await fetch(`/api/v1/internal/support/tenants/${orgId}/errors`, {
        headers: getHeaders(),
      });
      return res.json();
    },
  });

  const { data: config } = useQuery({
    queryKey: ['tenant-config', orgId],
    queryFn: async () => {
      const res = await fetch(`/api/v1/internal/support/tenants/${orgId}/config`, {
        headers: getHeaders(),
      });
      return res.json();
    },
  });

  const { data: jobs } = useQuery({
    queryKey: ['tenant-jobs', orgId],
    queryFn: async () => {
      const res = await fetch(`/api/v1/internal/support/tenants/${orgId}/jobs`, {
        headers: getHeaders(),
      });
      return res.json();
    },
  });

  if (isLoading) {
    return <div>Loading...</div>;
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">{details?.name}</h1>
          <p className="text-gray-500">{details?.slug}</p>
        </div>
        <div className="text-sm text-gray-500">
          {details?._count?.users} users | {details?._count?.cases} cases
        </div>
      </div>

      {/* Quick stats */}
      <div className="grid grid-cols-4 gap-4">
        <div className="p-4 bg-white border rounded-lg">
          <AlertCircle className="h-5 w-5 text-red-500 mb-2" />
          <div className="text-2xl font-bold">{errors?.length || 0}</div>
          <div className="text-sm text-gray-500">Recent Errors</div>
        </div>
        <div className="p-4 bg-white border rounded-lg">
          <Briefcase className="h-5 w-5 text-blue-500 mb-2" />
          <div className="text-2xl font-bold">{jobs?.exports?.length || 0}</div>
          <div className="text-sm text-gray-500">Pending Jobs</div>
        </div>
        <div className="p-4 bg-white border rounded-lg">
          <Settings className="h-5 w-5 text-gray-500 mb-2" />
          <div className="text-2xl font-bold">{config?.featureFlags?.filter(f => f.isAdopted).length || 0}</div>
          <div className="text-sm text-gray-500">Features Enabled</div>
        </div>
        <div className="p-4 bg-white border rounded-lg">
          <Search className="h-5 w-5 text-green-500 mb-2" />
          <div className="text-2xl font-bold">OK</div>
          <div className="text-sm text-gray-500">Search Index</div>
        </div>
      </div>

      {/* Recent errors */}
      <div className="bg-white border rounded-lg">
        <div className="p-4 border-b font-medium">Recent Errors</div>
        <div className="divide-y max-h-64 overflow-y-auto">
          {errors?.length === 0 ? (
            <div className="p-4 text-gray-500 text-center">No recent errors</div>
          ) : (
            errors?.slice(0, 10).map((error: any) => (
              <div key={error.id} className="p-3 text-sm">
                <div className="flex items-center gap-2">
                  <XCircle className="h-4 w-4 text-red-500" />
                  <span className="font-medium">{error.action}</span>
                  <span className="text-gray-500">
                    {new Date(error.createdAt).toLocaleString()}
                  </span>
                </div>
                <div className="text-gray-600 mt-1">{error.actionDescription}</div>
              </div>
            ))
          )}
        </div>
      </div>

      {/* Configuration */}
      <div className="bg-white border rounded-lg">
        <div className="p-4 border-b font-medium">Configuration</div>
        <div className="p-4 space-y-4">
          <div>
            <h4 className="text-sm font-medium mb-2">SSO</h4>
            <div className="flex items-center gap-2">
              {config?.organization?.ssoConfig ? (
                <>
                  <CheckCircle className="h-4 w-4 text-green-500" />
                  <span>{config.organization.ssoConfig.provider}</span>
                </>
              ) : (
                <>
                  <XCircle className="h-4 w-4 text-gray-400" />
                  <span className="text-gray-500">Not configured</span>
                </>
              )}
            </div>
          </div>
          <div>
            <h4 className="text-sm font-medium mb-2">HRIS Integration</h4>
            <div className="flex items-center gap-2">
              {config?.integrations?.hris ? (
                <>
                  <CheckCircle className="h-4 w-4 text-green-500" />
                  <span>{config.integrations.hris.provider}</span>
                  <span className="text-gray-500">
                    Last sync: {config.integrations.hris.lastSyncAt || 'Never'}
                  </span>
                </>
              ) : (
                <>
                  <XCircle className="h-4 w-4 text-gray-400" />
                  <span className="text-gray-500">Not configured</span>
                </>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
```
  </action>
  <verify>
1. `cd apps/ops-console && npx tsc --noEmit` - TypeScript compiles
2. `cd apps/ops-console && npm run build` - Build succeeds
  </verify>
  <done>Support Console pages with error logs, config, and debug views</done>
</task>

</tasks>

<verification>
1. `cd apps/ops-console && npm install` - Dependencies install
2. `cd apps/ops-console && npm run build` - Build succeeds
3. `cd apps/ops-console && npm run dev` - Dev server starts on port 3002
</verification>

<success_criteria>
- apps/ops-console is separate Next.js app
- ImpersonationBar shows persistent visual indicator with colored border
- Remaining session time displayed and updates
- TenantSwitcher enables searching by name/domain/ID
- Reason required to start impersonation (min 10 chars)
- Support Console shows errors, config, jobs, search index for impersonated tenant
- X-Impersonation-Session header sent with all API requests
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-13-SUMMARY.md`
</output>
