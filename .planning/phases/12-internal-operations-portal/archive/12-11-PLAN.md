---
phase: 12-internal-operations-portal
plan: 11
type: execute
wave: 4
depends_on: ["12-04"]
files_modified:
  - apps/frontend/src/pages/internal/support/SupportConsolePage.tsx
  - apps/frontend/src/pages/internal/support/TenantSwitcher.tsx
  - apps/frontend/src/pages/internal/support/ErrorLogViewer.tsx
  - apps/frontend/src/pages/internal/support/ConfigBrowser.tsx
  - apps/frontend/src/components/internal/InternalLayout.tsx
  - apps/frontend/src/components/internal/ImpersonationTimer.tsx
  - apps/frontend/src/hooks/useImpersonation.ts
  - apps/frontend/src/services/internal/support-console.api.ts
autonomous: true

must_haves:
  truths:
    - "Support team can search tenants and switch context with impersonation"
    - "Session timer shows remaining time and allows early termination"
    - "Error logs display with filtering by level, date, and search term"
    - "Configuration browser shows tenant settings in read-only mode"
  artifacts:
    - path: "apps/frontend/src/pages/internal/support/SupportConsolePage.tsx"
      provides: "Main support console page with tenant search and tools"
      exports: ["SupportConsolePage"]
    - path: "apps/frontend/src/components/internal/InternalLayout.tsx"
      provides: "Layout wrapper with navigation and impersonation bar"
      exports: ["InternalLayout"]
    - path: "apps/frontend/src/hooks/useImpersonation.ts"
      provides: "Hook for impersonation state and actions"
      exports: ["useImpersonation"]
  key_links:
    - from: "useImpersonation.ts"
      to: "/api/v1/internal/impersonation"
      via: "fetch/axios calls"
      pattern: "/internal/impersonation"
    - from: "InternalLayout.tsx"
      to: "ImpersonationTimer.tsx"
      via: "Component composition"
      pattern: "<ImpersonationTimer"
---

<objective>
Create the Support Console UI that enables support team to search tenants, start impersonation sessions, view error logs, and inspect configurations.

Purpose: Support team needs a visual interface to the support console API from 12-04. This provides the tenant switcher, error log viewer, and config browser with proper session management UI.

Output: SupportConsolePage, TenantSwitcher, ErrorLogViewer, ConfigBrowser components; InternalLayout with impersonation bar; useImpersonation hook.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-04-SUMMARY.md
@.planning/phases/12-internal-operations-portal/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useImpersonation hook and API service</name>
  <files>
    apps/frontend/src/hooks/useImpersonation.ts
    apps/frontend/src/services/internal/support-console.api.ts
  </files>
  <action>
**services/internal/support-console.api.ts:**
```typescript
import { api } from '../api';

export interface TenantOverview {
  id: string;
  name: string;
  slug: string;
  status: string;
  userCount: number;
  caseCount: number;
  lastActivityAt?: string;
}

export interface ImpersonationSession {
  id: string;
  targetOrganizationId: string;
  targetOrganizationName: string;
  reason: string;
  ticketId?: string;
  startedAt: string;
  expiresAt: string;
  remainingSeconds: number;
}

export interface ErrorLogEntry {
  id: string;
  level: 'error' | 'warn' | 'info';
  message: string;
  stack?: string;
  organizationId: string;
  createdAt: string;
}

export interface TenantConfig {
  organizationId: string;
  organizationName: string;
  settings: Record<string, unknown>;
  ssoConfig?: { provider: string; isEnabled: boolean };
  featureFlags: Record<string, boolean>;
}

export const supportConsoleApi = {
  // Tenant search
  listTenants: (params: { searchTerm?: string; status?: string; page?: number }) =>
    api.get<{ items: TenantOverview[]; total: number }>('/internal/support/tenants', { params }),

  // Impersonation
  startSession: (data: { targetOrganizationId: string; reason: string; ticketId?: string }) =>
    api.post<ImpersonationSession>('/internal/impersonation/sessions', data),

  getActiveSessions: () =>
    api.get<ImpersonationSession[]>('/internal/impersonation/sessions/active'),

  endSession: (sessionId: string) =>
    api.delete(`/internal/impersonation/sessions/${sessionId}`),

  // Cross-tenant search
  searchCases: (params: { searchTerm: string; organizationId?: string; page?: number }) =>
    api.get('/internal/support/search/cases', { params }),

  searchUsers: (params: { searchTerm: string; organizationId?: string; page?: number }) =>
    api.get('/internal/support/search/users', { params }),

  // Error logs
  getErrorLogs: (organizationId: string, params: { levels?: string[]; startDate?: string; endDate?: string; searchTerm?: string }) =>
    api.get<ErrorLogEntry[]>(`/internal/support/tenants/${organizationId}/errors`, { params }),

  // Config
  getTenantConfig: (organizationId: string) =>
    api.get<TenantConfig>(`/internal/support/tenants/${organizationId}/config`),
};
```

**hooks/useImpersonation.ts:**
```typescript
import { useState, useEffect, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { supportConsoleApi, ImpersonationSession } from '../services/internal/support-console.api';

interface UseImpersonationReturn {
  session: ImpersonationSession | null;
  isImpersonating: boolean;
  remainingTime: number; // seconds
  startSession: (targetOrgId: string, reason: string, ticketId?: string) => Promise<void>;
  endSession: () => Promise<void>;
  isLoading: boolean;
}

export function useImpersonation(): UseImpersonationReturn {
  const queryClient = useQueryClient();
  const [remainingTime, setRemainingTime] = useState(0);

  // Fetch active sessions
  const { data: sessions, isLoading } = useQuery({
    queryKey: ['impersonation', 'active'],
    queryFn: () => supportConsoleApi.getActiveSessions(),
    refetchInterval: 30000, // Refresh every 30 seconds
  });

  const session = sessions?.[0] ?? null; // Use first active session

  // Update remaining time every second
  useEffect(() => {
    if (!session) {
      setRemainingTime(0);
      return;
    }

    const updateRemaining = () => {
      const expires = new Date(session.expiresAt).getTime();
      const now = Date.now();
      const remaining = Math.max(0, Math.floor((expires - now) / 1000));
      setRemainingTime(remaining);

      if (remaining === 0) {
        queryClient.invalidateQueries({ queryKey: ['impersonation'] });
      }
    };

    updateRemaining();
    const interval = setInterval(updateRemaining, 1000);
    return () => clearInterval(interval);
  }, [session, queryClient]);

  // Start session mutation
  const startMutation = useMutation({
    mutationFn: ({ targetOrgId, reason, ticketId }: { targetOrgId: string; reason: string; ticketId?: string }) =>
      supportConsoleApi.startSession({ targetOrganizationId: targetOrgId, reason, ticketId }),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['impersonation'] });
    },
  });

  // End session mutation
  const endMutation = useMutation({
    mutationFn: (sessionId: string) => supportConsoleApi.endSession(sessionId),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['impersonation'] });
    },
  });

  const startSession = useCallback(async (targetOrgId: string, reason: string, ticketId?: string) => {
    await startMutation.mutateAsync({ targetOrgId, reason, ticketId });
  }, [startMutation]);

  const endSession = useCallback(async () => {
    if (session) {
      await endMutation.mutateAsync(session.id);
    }
  }, [session, endMutation]);

  return {
    session,
    isImpersonating: !!session,
    remainingTime,
    startSession,
    endSession,
    isLoading,
  };
}
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>useImpersonation hook and API service created</done>
</task>

<task type="auto">
  <name>Task 2: Create InternalLayout and ImpersonationTimer components</name>
  <files>
    apps/frontend/src/components/internal/InternalLayout.tsx
    apps/frontend/src/components/internal/ImpersonationTimer.tsx
  </files>
  <action>
**components/internal/ImpersonationTimer.tsx:**
```typescript
import { useImpersonation } from '@/hooks/useImpersonation';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Shield, Clock, X } from 'lucide-react';
import { cn } from '@/lib/utils';

export function ImpersonationTimer() {
  const { session, remainingTime, endSession, isImpersonating } = useImpersonation();

  if (!isImpersonating || !session) return null;

  const formatTime = (seconds: number) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return h > 0 ? `${h}h ${m}m` : `${m}m ${s}s`;
  };

  const isWarning = remainingTime < 15 * 60; // 15 minutes
  const isCritical = remainingTime < 5 * 60; // 5 minutes

  return (
    <div className={cn(
      "flex items-center justify-between px-4 py-2 border-b",
      isCritical ? "bg-red-100 border-red-200" :
      isWarning ? "bg-yellow-100 border-yellow-200" :
      "bg-blue-50 border-blue-100"
    )}>
      <div className="flex items-center gap-3">
        <Shield className="h-4 w-4 text-blue-600" />
        <span className="font-medium">
          Impersonating: {session.targetOrganizationName}
        </span>
        <Badge variant="outline">{session.reason}</Badge>
        {session.ticketId && (
          <Badge variant="secondary">Ticket: {session.ticketId}</Badge>
        )}
      </div>

      <div className="flex items-center gap-4">
        <div className={cn(
          "flex items-center gap-2 text-sm",
          isCritical && "text-red-700 font-medium",
          isWarning && !isCritical && "text-yellow-700"
        )}>
          <Clock className="h-4 w-4" />
          {formatTime(remainingTime)} remaining
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={endSession}
          className="flex items-center gap-1"
        >
          <X className="h-3 w-3" />
          End Session
        </Button>
      </div>
    </div>
  );
}
```

**components/internal/InternalLayout.tsx:**
```typescript
import { Outlet, NavLink, useNavigate } from 'react-router-dom';
import { ImpersonationTimer } from './ImpersonationTimer';
import { cn } from '@/lib/utils';
import {
  Headset, // Support
  ClipboardList, // Implementation
  Phone, // Hotline
  HeartPulse, // Client Success
  Settings, // Admin
  User,
  LogOut,
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';

const navItems = [
  { to: '/internal/support', label: 'Support', icon: Headset },
  { to: '/internal/implementation', label: 'Implementation', icon: ClipboardList },
  { to: '/internal/hotline', label: 'Hotline Ops', icon: Phone },
  { to: '/internal/client-success', label: 'Client Success', icon: HeartPulse },
  { to: '/internal/admin', label: 'Admin', icon: Settings },
];

export function InternalLayout() {
  const navigate = useNavigate();

  const handleLogout = () => {
    // Clear internal auth and redirect
    localStorage.removeItem('internal_token');
    navigate('/internal/login');
  };

  return (
    <div className="min-h-screen flex flex-col bg-gray-50">
      {/* Header */}
      <header className="h-14 border-b bg-white flex items-center px-4 shadow-sm">
        <div className="flex items-center gap-2">
          <img src="/logo.svg" alt="Ethico" className="h-8" />
          <span className="font-semibold text-gray-900">Operations</span>
        </div>

        <nav className="ml-8 flex items-center gap-1">
          {navItems.map((item) => (
            <NavLink
              key={item.to}
              to={item.to}
              className={({ isActive }) => cn(
                "flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium transition-colors",
                isActive
                  ? "bg-blue-100 text-blue-700"
                  : "text-gray-600 hover:bg-gray-100 hover:text-gray-900"
              )}
            >
              <item.icon className="h-4 w-4" />
              {item.label}
            </NavLink>
          ))}
        </nav>

        <div className="ml-auto">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="ghost" size="sm" className="flex items-center gap-2">
                <User className="h-4 w-4" />
                <span>Operator</span>
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end">
              <DropdownMenuItem onClick={handleLogout}>
                <LogOut className="h-4 w-4 mr-2" />
                Logout
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>
        </div>
      </header>

      {/* Impersonation Bar */}
      <ImpersonationTimer />

      {/* Main Content */}
      <main className="flex-1">
        <Outlet />
      </main>
    </div>
  );
}
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>InternalLayout with navigation and ImpersonationTimer created</done>
</task>

<task type="auto">
  <name>Task 3: Create Support Console Page with TenantSwitcher and tools</name>
  <files>
    apps/frontend/src/pages/internal/support/SupportConsolePage.tsx
    apps/frontend/src/pages/internal/support/TenantSwitcher.tsx
    apps/frontend/src/pages/internal/support/ErrorLogViewer.tsx
    apps/frontend/src/pages/internal/support/ConfigBrowser.tsx
  </files>
  <action>
**pages/internal/support/TenantSwitcher.tsx:**
```typescript
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { supportConsoleApi, TenantOverview } from '@/services/internal/support-console.api';
import { useImpersonation } from '@/hooks/useImpersonation';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Search, Building2, Users, FileText } from 'lucide-react';

interface TenantSwitcherProps {
  onSelect?: (tenant: TenantOverview) => void;
}

export function TenantSwitcher({ onSelect }: TenantSwitcherProps) {
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedTenant, setSelectedTenant] = useState<TenantOverview | null>(null);
  const [reason, setReason] = useState('');
  const [ticketId, setTicketId] = useState('');
  const [dialogOpen, setDialogOpen] = useState(false);
  const { startSession, isImpersonating } = useImpersonation();

  const { data: tenants, isLoading } = useQuery({
    queryKey: ['tenants', searchTerm],
    queryFn: () => supportConsoleApi.listTenants({ searchTerm }),
    enabled: searchTerm.length >= 2,
  });

  const handleStartSession = async () => {
    if (!selectedTenant || !reason) return;
    await startSession(selectedTenant.id, reason, ticketId || undefined);
    setDialogOpen(false);
    onSelect?.(selectedTenant);
  };

  return (
    <div className="space-y-4">
      <div className="relative">
        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
        <Input
          placeholder="Search tenants by name, slug, or ID..."
          value={searchTerm}
          onChange={(e) => setSearchTerm(e.target.value)}
          className="pl-10"
        />
      </div>

      {isLoading && <div className="text-sm text-gray-500">Searching...</div>}

      {tenants?.items && tenants.items.length > 0 && (
        <div className="border rounded-lg divide-y">
          {tenants.items.map((tenant) => (
            <div
              key={tenant.id}
              className="p-3 flex items-center justify-between hover:bg-gray-50"
            >
              <div className="flex items-center gap-3">
                <Building2 className="h-5 w-5 text-gray-400" />
                <div>
                  <div className="font-medium">{tenant.name}</div>
                  <div className="text-sm text-gray-500">{tenant.slug}</div>
                </div>
              </div>

              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2 text-sm text-gray-500">
                  <Users className="h-4 w-4" />
                  {tenant.userCount}
                </div>
                <div className="flex items-center gap-2 text-sm text-gray-500">
                  <FileText className="h-4 w-4" />
                  {tenant.caseCount}
                </div>

                <Dialog open={dialogOpen && selectedTenant?.id === tenant.id} onOpenChange={setDialogOpen}>
                  <DialogTrigger asChild>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => setSelectedTenant(tenant)}
                      disabled={isImpersonating}
                    >
                      {isImpersonating ? 'Session Active' : 'Access'}
                    </Button>
                  </DialogTrigger>
                  <DialogContent>
                    <DialogHeader>
                      <DialogTitle>Start Impersonation Session</DialogTitle>
                    </DialogHeader>
                    <div className="space-y-4 py-4">
                      <div>
                        <Label>Tenant</Label>
                        <div className="font-medium">{tenant.name}</div>
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="reason">Reason (required)</Label>
                        <Textarea
                          id="reason"
                          placeholder="Describe why you need access..."
                          value={reason}
                          onChange={(e) => setReason(e.target.value)}
                        />
                      </div>
                      <div className="space-y-2">
                        <Label htmlFor="ticketId">Support Ticket ID (optional)</Label>
                        <Input
                          id="ticketId"
                          placeholder="e.g., SUPPORT-1234"
                          value={ticketId}
                          onChange={(e) => setTicketId(e.target.value)}
                        />
                      </div>
                      <div className="text-sm text-gray-500">
                        Session will expire in 4 hours. All actions are logged.
                      </div>
                    </div>
                    <div className="flex justify-end gap-2">
                      <Button variant="outline" onClick={() => setDialogOpen(false)}>
                        Cancel
                      </Button>
                      <Button onClick={handleStartSession} disabled={!reason}>
                        Start Session
                      </Button>
                    </div>
                  </DialogContent>
                </Dialog>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
```

**pages/internal/support/ErrorLogViewer.tsx:**
- Query error logs with filters (level, date range, search)
- Display in DataGrid or table with expandable rows for stack traces
- Color-code by level (red=error, yellow=warn, blue=info)
- Support pagination

**pages/internal/support/ConfigBrowser.tsx:**
- Fetch tenant config via supportConsoleApi.getTenantConfig
- Display settings in collapsible sections (general, branding, notifications)
- Show feature flags as checklist
- Read-only - no edit capabilities

**pages/internal/support/SupportConsolePage.tsx:**
```typescript
import { useState } from 'react';
import { TenantSwitcher } from './TenantSwitcher';
import { ErrorLogViewer } from './ErrorLogViewer';
import { ConfigBrowser } from './ConfigBrowser';
import { useImpersonation } from '@/hooks/useImpersonation';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export function SupportConsolePage() {
  const { session, isImpersonating } = useImpersonation();
  const [activeTab, setActiveTab] = useState('search');

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Support Console</h1>
        <p className="text-gray-500">Search tenants, view logs, and inspect configurations</p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Tenant Search</CardTitle>
          <CardDescription>Find and access client accounts</CardDescription>
        </CardHeader>
        <CardContent>
          <TenantSwitcher />
        </CardContent>
      </Card>

      {isImpersonating && session && (
        <Tabs value={activeTab} onValueChange={setActiveTab}>
          <TabsList>
            <TabsTrigger value="errors">Error Logs</TabsTrigger>
            <TabsTrigger value="config">Configuration</TabsTrigger>
            <TabsTrigger value="search">Cross-Tenant Search</TabsTrigger>
          </TabsList>

          <TabsContent value="errors" className="mt-4">
            <ErrorLogViewer organizationId={session.targetOrganizationId} />
          </TabsContent>

          <TabsContent value="config" className="mt-4">
            <ConfigBrowser organizationId={session.targetOrganizationId} />
          </TabsContent>

          <TabsContent value="search" className="mt-4">
            {/* Cross-tenant search UI */}
            <Card>
              <CardContent className="pt-6">
                <p className="text-gray-500">Search cases and users across this tenant...</p>
              </CardContent>
            </Card>
          </TabsContent>
        </Tabs>
      )}
    </div>
  );
}
```
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>Support Console page with TenantSwitcher, ErrorLogViewer, and ConfigBrowser created</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/frontend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify TenantSwitcher requires reason for impersonation
4. Verify ImpersonationTimer shows warning at 15 minutes
5. Verify ErrorLogViewer filters work correctly
</verification>

<success_criteria>
- InternalLayout provides navigation for all internal portals
- ImpersonationTimer shows remaining time with color-coded warnings
- TenantSwitcher searches tenants and starts impersonation with reason
- ErrorLogViewer displays logs with filtering by level and date
- ConfigBrowser shows tenant settings in read-only mode
- All components use existing shadcn/ui patterns
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-11-SUMMARY.md`
</output>
