---
phase: 12-internal-operations-portal
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - apps/backend/src/modules/operations/support/support-console.service.ts
  - apps/backend/src/modules/operations/support/support-console.controller.ts
  - apps/backend/src/modules/operations/support/dto/support-console.dto.ts
  - apps/backend/src/modules/operations/support/types/support-console.types.ts
  - apps/backend/src/modules/operations/support/support.module.ts
  - apps/backend/src/modules/operations/support/index.ts
autonomous: true

must_haves:
  truths:
    - "Support team can search cases/users across all tenants with impersonation"
    - "Error logs can be filtered by tenant, severity, and time range"
    - "Configuration inspector shows tenant settings without modification"
    - "All cross-tenant searches are logged to impersonation audit"
  artifacts:
    - path: "apps/backend/src/modules/operations/support/support-console.service.ts"
      provides: "Cross-tenant search, error logs, config inspection"
      exports: ["SupportConsoleService"]
    - path: "apps/backend/src/modules/operations/support/support-console.controller.ts"
      provides: "REST endpoints for support console"
      exports: ["SupportConsoleController"]
  key_links:
    - from: "support-console.service.ts"
      to: "ImpersonationService"
      via: "logImpersonationAction for audit"
      pattern: "impersonationService\\.logImpersonationAction"
    - from: "support-console.controller.ts"
      to: "ElevatedAccessGuard"
      via: "@UseGuards decorator"
      pattern: "@UseGuards.*ElevatedAccessGuard"
---

<objective>
Create the Support Console service that enables Support team to search across tenants, view error logs, and inspect configurations for debugging customer issues.

Purpose: Support team needs to diagnose issues without database access. This service provides safe, audited cross-tenant access following the impersonation infrastructure from 12-01.

Output: SupportConsoleService with cross-tenant search, error log viewer, config inspector; REST controller with proper guards.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-01-SUMMARY.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Support Console types and DTOs</name>
  <files>
    apps/backend/src/modules/operations/support/types/support-console.types.ts
    apps/backend/src/modules/operations/support/dto/support-console.dto.ts
  </files>
  <action>
**types/support-console.types.ts:**
```typescript
export interface CrossTenantSearchResult<T> {
  items: T[];
  total: number;
  page: number;
  limit: number;
  searchedTenants: number;
}

export interface CaseSummary {
  id: string;
  referenceNumber: string;
  summary?: string;
  status: string;
  severity: string;
  categoryName?: string;
  organizationId: string;
  organizationName: string;
  createdAt: Date;
  updatedAt: Date;
}

export interface UserSummary {
  id: string;
  email: string;
  firstName: string;
  lastName: string;
  role: string;
  isActive: boolean;
  organizationId: string;
  organizationName: string;
  lastLoginAt?: Date;
}

export interface ErrorLogEntry {
  id: string;
  level: 'error' | 'warn' | 'info';
  message: string;
  stack?: string;
  context?: Record<string, unknown>;
  organizationId: string;
  userId?: string;
  requestId?: string;
  createdAt: Date;
}

export interface TenantConfig {
  organizationId: string;
  organizationName: string;
  settings: {
    general: Record<string, unknown>;
    branding: Record<string, unknown>;
    notifications: Record<string, unknown>;
    workflows: Record<string, unknown>;
  };
  ssoConfig?: {
    provider: string;
    isEnabled: boolean;
  };
  featureFlags: Record<string, boolean>;
}

export interface TenantOverview {
  id: string;
  name: string;
  slug: string;
  status: string;
  userCount: number;
  caseCount: number;
  createdAt: Date;
  lastActivityAt?: Date;
}
```

**dto/support-console.dto.ts:**
```typescript
import { IsOptional, IsString, IsNumber, IsEnum, Min, Max, IsArray } from 'class-validator';
import { Type } from 'class-transformer';

export class CrossTenantSearchDto {
  @IsString()
  searchTerm: string;

  @IsOptional()
  @IsString()
  organizationId?: string;

  @IsOptional()
  @IsString()
  status?: string;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(100)
  limit?: number = 20;
}

export class ErrorLogQueryDto {
  @IsString()
  organizationId: string;

  @IsOptional()
  @IsArray()
  @IsString({ each: true })
  levels?: ('error' | 'warn' | 'info')[];

  @IsOptional()
  @IsString()
  startDate?: string;

  @IsOptional()
  @IsString()
  endDate?: string;

  @IsOptional()
  @IsString()
  searchTerm?: string;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(500)
  limit?: number = 100;
}

export class TenantListQueryDto {
  @IsOptional()
  @IsString()
  searchTerm?: string;

  @IsOptional()
  @IsString()
  status?: string;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(100)
  limit?: number = 50;
}
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>Types and DTOs for support console operations defined</done>
</task>

<task type="auto">
  <name>Task 2: Create SupportConsoleService with cross-tenant operations</name>
  <files>apps/backend/src/modules/operations/support/support-console.service.ts</files>
  <action>
Create SupportConsoleService with the following methods:

1. **Inject dependencies:**
   - PrismaService
   - ImpersonationService (from 12-01)
   - Logger

2. **searchCasesAllTenants(operatorUserId: string, query: CrossTenantSearchDto):**
   - Validate operator has cross-tenant search permission via validateElevatedAccess helper
   - Log search action via impersonationService.logImpersonationAction
   - Use Prisma.$extends to bypass RLS:
     ```typescript
     await this.prisma.$executeRaw`SET LOCAL app.bypass_rls = true`;
     ```
   - Query cases with OR clause for referenceNumber and summary ILIKE search
   - Filter by organizationId if provided
   - Include organization relation for name
   - Map to CaseSummary[]
   - Reset RLS: `SET LOCAL app.bypass_rls = false`
   - Return CrossTenantSearchResult<CaseSummary>

3. **searchUsersAllTenants(operatorUserId: string, query: CrossTenantSearchDto):**
   - Similar pattern to cases
   - Search by email, firstName, lastName
   - Return CrossTenantSearchResult<UserSummary>

4. **getErrorLogs(operatorUserId: string, query: ErrorLogQueryDto):**
   - Validate elevated access
   - Log action
   - Query ApplicationLog table (or AuditLog with action_category = 'ERROR') filtered by:
     - organizationId (required)
     - levels array (error, warn, info)
     - date range
     - search term in message
   - Return ErrorLogEntry[] (max 100-500 entries)

5. **getTenantConfig(operatorUserId: string, organizationId: string):**
   - Validate elevated access
   - Log action as VIEW_CONFIG
   - Query Organization with relations:
     - OrganizationSettings (general, branding, etc.)
     - TenantSsoConfig
   - Build TenantConfig response
   - Return read-only view (no modification methods)

6. **listTenants(operatorUserId: string, query: TenantListQueryDto):**
   - Validate elevated access (SUPPORT_ADMIN or PLATFORM_ADMIN only)
   - Log action as LIST_TENANTS
   - Query all organizations with:
     - User count
     - Case count
     - Last activity timestamp
   - Filter by search term (name, slug)
   - Return paginated TenantOverview[]

7. **validateElevatedAccess(operatorUserId: string, action: string):**
   - Private helper method
   - Verify operator is InternalUser with appropriate role
   - Throw ForbiddenException if insufficient permissions
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>SupportConsoleService provides cross-tenant search, error logs, and config inspection with audit logging</done>
</task>

<task type="auto">
  <name>Task 3: Create SupportConsoleController and module</name>
  <files>
    apps/backend/src/modules/operations/support/support-console.controller.ts
    apps/backend/src/modules/operations/support/support.module.ts
    apps/backend/src/modules/operations/support/index.ts
  </files>
  <action>
**support-console.controller.ts:**
```typescript
@Controller('api/v1/internal/support')
@UseGuards(ElevatedAccessGuard)
export class SupportConsoleController {
  constructor(private readonly supportService: SupportConsoleService) {}

  @Get('tenants')
  async listTenants(
    @CurrentInternalUser() operator: InternalUser,
    @Query() query: TenantListQueryDto,
  ) {
    return this.supportService.listTenants(operator.id, query);
  }

  @Get('search/cases')
  async searchCases(
    @CurrentInternalUser() operator: InternalUser,
    @Query() query: CrossTenantSearchDto,
  ) {
    return this.supportService.searchCasesAllTenants(operator.id, query);
  }

  @Get('search/users')
  async searchUsers(
    @CurrentInternalUser() operator: InternalUser,
    @Query() query: CrossTenantSearchDto,
  ) {
    return this.supportService.searchUsersAllTenants(operator.id, query);
  }

  @Get('tenants/:organizationId/errors')
  async getErrorLogs(
    @CurrentInternalUser() operator: InternalUser,
    @Param('organizationId') organizationId: string,
    @Query() query: ErrorLogQueryDto,
  ) {
    return this.supportService.getErrorLogs(operator.id, { ...query, organizationId });
  }

  @Get('tenants/:organizationId/config')
  async getTenantConfig(
    @CurrentInternalUser() operator: InternalUser,
    @Param('organizationId') organizationId: string,
  ) {
    return this.supportService.getTenantConfig(operator.id, organizationId);
  }
}
```

Note: Create a simple @CurrentInternalUser() decorator that extracts the internal user from request (set by ImpersonationMiddleware).

**support.module.ts:**
```typescript
import { Module } from '@nestjs/common';
import { SupportConsoleService } from './support-console.service';
import { SupportConsoleController } from './support-console.controller';
import { ImpersonationModule } from '../impersonation';

@Module({
  imports: [ImpersonationModule],
  providers: [SupportConsoleService],
  controllers: [SupportConsoleController],
  exports: [SupportConsoleService],
})
export class SupportModule {}
```

**index.ts:**
- Export SupportConsoleService, SupportModule, types, DTOs
  </action>
  <verify>npm run lint passes on new files</verify>
  <done>SupportConsoleController with proper guards and SupportModule configured</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify ElevatedAccessGuard is applied to all controller methods
4. Verify all methods log to impersonation audit
5. Verify RLS bypass is properly scoped and reset
</verification>

<success_criteria>
- SupportConsoleService provides cross-tenant case and user search
- Error logs can be queried by tenant, severity, and date range
- Tenant config is viewable in read-only mode
- All operations require ElevatedAccessGuard
- All operations log to ImpersonationAuditLog via impersonationService
- RLS bypass is scoped to individual queries and reset after
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-04-SUMMARY.md`
</output>
