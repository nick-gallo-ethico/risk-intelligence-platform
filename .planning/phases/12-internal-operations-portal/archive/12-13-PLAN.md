---
phase: 12-internal-operations-portal
plan: 13
type: execute
wave: 4
depends_on: ["12-06"]
files_modified:
  - apps/frontend/src/pages/internal/implementation/MigrationWizard.tsx
  - apps/frontend/src/pages/internal/implementation/steps/UploadStep.tsx
  - apps/frontend/src/pages/internal/implementation/steps/MappingStep.tsx
  - apps/frontend/src/pages/internal/implementation/steps/PreviewStep.tsx
  - apps/frontend/src/pages/internal/implementation/steps/ImportStep.tsx
  - apps/frontend/src/pages/internal/implementation/steps/VerifyStep.tsx
  - apps/frontend/src/services/internal/migration-wizard.api.ts
autonomous: true

must_haves:
  truths:
    - "Wizard progresses through 5 steps: Upload, Map, Preview, Import, Verify"
    - "Field mapping provides AI suggestions with manual override"
    - "Preview shows sample transformed data before import"
    - "Progress bar updates during import with percentage"
    - "Rollback is available for 7 days after successful import"
  artifacts:
    - path: "apps/frontend/src/pages/internal/implementation/MigrationWizard.tsx"
      provides: "Multi-step wizard container with step navigation"
      exports: ["MigrationWizard"]
    - path: "apps/frontend/src/pages/internal/implementation/steps/MappingStep.tsx"
      provides: "Field mapping UI with AI suggestions"
      exports: ["MappingStep"]
  key_links:
    - from: "migration-wizard.api.ts"
      to: "/api/v1/internal/migration-wizard"
      via: "API calls"
      pattern: "/internal/migration-wizard"
---

<objective>
Create the Migration Wizard UI that guides implementation specialists through data migration with AI-assisted field mapping, validation preview, and rollback capability.

Purpose: The migration backend exists from Phase 11 and was extended in 12-06. This plan builds the multi-step wizard UI that makes migration accessible without technical expertise.

Output: MigrationWizard with 5 step components (Upload, Mapping, Preview, Import, Verify); API service.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-06-SUMMARY.md
@.planning/phases/12-internal-operations-portal/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Migration Wizard API service</name>
  <files>apps/frontend/src/services/internal/migration-wizard.api.ts</files>
  <action>
Create API service for migration wizard:

```typescript
import { api } from '../api';

export enum WizardStep {
  UPLOAD = 'UPLOAD',
  DETECT = 'DETECT',
  MAP = 'MAP',
  VALIDATE = 'VALIDATE',
  PREVIEW = 'PREVIEW',
  IMPORT = 'IMPORT',
  VERIFY = 'VERIFY',
}

export interface WizardSession {
  job: {
    id: string;
    fileName: string;
    sourceType: string;
    status: string;
    totalRows?: number;
    validRows?: number;
    errorRows?: number;
    progress?: number;
  };
  wizard: {
    currentStep: WizardStep;
    completedSteps: WizardStep[];
    startedAt: string;
    lastActivityAt: string;
  };
  canRollback?: boolean;
  rollbackExpiresAt?: string;
}

export interface FieldMapping {
  sourceField: string;
  targetField: string;
  targetEntity: 'CASE' | 'RIU' | 'PERSON' | 'INVESTIGATION';
  isRequired: boolean;
  transformFunction?: string;
  confidence?: number;
  aiSuggested?: boolean;
}

export interface AiMappingSuggestion {
  sourceField: string;
  suggestedTargetField: string;
  suggestedTargetEntity: string;
  confidence: number;
  reasoning?: string;
}

export interface ValidationError {
  rowNumber: number;
  field: string;
  value: unknown;
  error: string;
  severity: 'error' | 'warning';
}

export interface PreviewRow {
  rowNumber: number;
  sourceData: Record<string, unknown>;
  transformedData: {
    case?: Record<string, unknown>;
    riu?: Record<string, unknown>;
    person?: Record<string, unknown>;
  };
  issues: string[];
}

export const migrationWizardApi = {
  // Initiate wizard
  initiate: (organizationId: string, sourceType?: string) =>
    api.post<{ jobId: string }>('/internal/migration-wizard/initiate', { organizationId, sourceType }),

  // Get session
  getSession: (jobId: string, organizationId: string) =>
    api.get<WizardSession>(`/internal/migration-wizard/${jobId}/session`, { params: { organizationId } }),

  // Upload file
  uploadFile: (jobId: string, file: File) => {
    const formData = new FormData();
    formData.append('file', file);
    return api.post(`/internal/migration-wizard/${jobId}/upload`, formData, {
      headers: { 'Content-Type': 'multipart/form-data' },
    });
  },

  // Detect format (returns detected fields and suggestions)
  detectFormat: (jobId: string) =>
    api.post<{
      sourceType: string;
      confidence: number;
      detectedFields: string[];
      sampleRows: Record<string, unknown>[];
      suggestedMappings: FieldMapping[];
    }>(`/internal/migration-wizard/${jobId}/proceed`, { targetStep: 'DETECT' }),

  // Request AI mapping assistance
  requestAiMapping: (jobId: string, unmappedFields: string[], contextHint?: string) =>
    api.post<{
      suggestions: AiMappingSuggestion[];
      processingTime: number;
      aiUsed: boolean;
    }>(`/internal/migration-wizard/${jobId}/ai-mapping`, { unmappedFields, contextHint }),

  // Save mappings
  saveMappings: (jobId: string, mappings: FieldMapping[]) =>
    api.post(`/internal/migration-wizard/${jobId}/proceed`, { targetStep: 'VALIDATE', mappings }),

  // Get validation results
  getValidation: (jobId: string) =>
    api.get<{
      validRows: number;
      errorRows: number;
      errors: ValidationError[];
    }>(`/internal/migration-wizard/${jobId}/validation`),

  // Get preview
  getPreview: (jobId: string, limit?: number) =>
    api.get<PreviewRow[]>(`/internal/migration-wizard/${jobId}/preview`, { params: { limit } }),

  // Confirm import
  confirmImport: (jobId: string, notes?: string) =>
    api.post(`/internal/migration-wizard/${jobId}/confirm-import`, { acknowledged: true, notes }),

  // Get import progress
  getProgress: (jobId: string) =>
    api.get<{ status: string; progress: number; importedRows?: number }>(`/internal/migration-wizard/${jobId}/status`),

  // Check rollback eligibility
  canRollback: (jobId: string) =>
    api.get<{ canRollback: boolean; reason?: string; expiresAt?: string }>(`/internal/migration-wizard/${jobId}/can-rollback`),

  // Execute rollback
  rollback: (jobId: string) =>
    api.post(`/internal/migration-wizard/${jobId}/rollback`, { confirmText: 'ROLLBACK' }),

  // Cancel wizard
  cancel: (jobId: string) =>
    api.delete(`/internal/migration-wizard/${jobId}`),
};
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>Migration wizard API service created</done>
</task>

<task type="auto">
  <name>Task 2: Create MigrationWizard container and Upload/Mapping steps</name>
  <files>
    apps/frontend/src/pages/internal/implementation/MigrationWizard.tsx
    apps/frontend/src/pages/internal/implementation/steps/UploadStep.tsx
    apps/frontend/src/pages/internal/implementation/steps/MappingStep.tsx
  </files>
  <action>
**pages/internal/implementation/MigrationWizard.tsx:**
```typescript
import { useState, useEffect } from 'react';
import { useSearchParams, useNavigate } from 'react-router-dom';
import { useQuery } from '@tanstack/react-query';
import { migrationWizardApi, WizardStep, WizardSession } from '@/services/internal/migration-wizard.api';
import { UploadStep } from './steps/UploadStep';
import { MappingStep } from './steps/MappingStep';
import { PreviewStep } from './steps/PreviewStep';
import { ImportStep } from './steps/ImportStep';
import { VerifyStep } from './steps/VerifyStep';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { cn } from '@/lib/utils';
import { Check, Upload, GitCompare, Eye, Play, CheckCircle2 } from 'lucide-react';

const STEPS = [
  { id: WizardStep.UPLOAD, label: 'Upload', icon: Upload },
  { id: WizardStep.MAP, label: 'Map Fields', icon: GitCompare },
  { id: WizardStep.PREVIEW, label: 'Preview', icon: Eye },
  { id: WizardStep.IMPORT, label: 'Import', icon: Play },
  { id: WizardStep.VERIFY, label: 'Verify', icon: CheckCircle2 },
];

interface MigrationWizardProps {
  organizationId: string;
}

export function MigrationWizard({ organizationId }: MigrationWizardProps) {
  const [searchParams, setSearchParams] = useSearchParams();
  const navigate = useNavigate();
  const jobId = searchParams.get('jobId');

  const { data: session, refetch } = useQuery({
    queryKey: ['migration-session', jobId],
    queryFn: () => migrationWizardApi.getSession(jobId!, organizationId),
    enabled: !!jobId,
    refetchInterval: (data) => {
      // Poll during import
      if (data?.wizard.currentStep === WizardStep.IMPORT) return 2000;
      return false;
    },
  });

  const currentStep = session?.wizard.currentStep || WizardStep.UPLOAD;
  const completedSteps = session?.wizard.completedSteps || [];

  const getStepStatus = (stepId: WizardStep) => {
    if (completedSteps.includes(stepId)) return 'completed';
    if (stepId === currentStep) return 'current';
    return 'upcoming';
  };

  const handleJobCreated = (newJobId: string) => {
    setSearchParams({ jobId: newJobId });
  };

  const handleStepComplete = () => {
    refetch();
  };

  const handleCancel = async () => {
    if (jobId) {
      await migrationWizardApi.cancel(jobId);
    }
    navigate('/internal/implementation');
  };

  return (
    <div className="p-6 max-w-5xl mx-auto space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Data Migration Wizard</h1>
          <p className="text-gray-500">Import historical data from legacy systems</p>
        </div>
        <Button variant="outline" onClick={handleCancel}>
          Cancel
        </Button>
      </div>

      {/* Step Indicator */}
      <nav className="flex items-center justify-center">
        {STEPS.map((step, idx) => {
          const status = getStepStatus(step.id);
          const Icon = step.icon;
          return (
            <div key={step.id} className="flex items-center">
              <div className={cn(
                "flex items-center gap-2 px-4 py-2 rounded-full",
                status === 'completed' && "bg-green-100 text-green-700",
                status === 'current' && "bg-blue-100 text-blue-700",
                status === 'upcoming' && "bg-gray-100 text-gray-400"
              )}>
                {status === 'completed' ? (
                  <Check className="h-5 w-5" />
                ) : (
                  <Icon className="h-5 w-5" />
                )}
                <span className="font-medium">{step.label}</span>
              </div>
              {idx < STEPS.length - 1 && (
                <div className={cn(
                  "w-12 h-0.5 mx-2",
                  completedSteps.includes(STEPS[idx + 1].id) ? "bg-green-300" : "bg-gray-200"
                )} />
              )}
            </div>
          );
        })}
      </nav>

      {/* Step Content */}
      <Card>
        <CardContent className="pt-6">
          {currentStep === WizardStep.UPLOAD && (
            <UploadStep
              organizationId={organizationId}
              jobId={jobId}
              onJobCreated={handleJobCreated}
              onComplete={handleStepComplete}
            />
          )}
          {(currentStep === WizardStep.DETECT || currentStep === WizardStep.MAP) && jobId && (
            <MappingStep
              jobId={jobId}
              session={session!}
              onComplete={handleStepComplete}
            />
          )}
          {(currentStep === WizardStep.VALIDATE || currentStep === WizardStep.PREVIEW) && jobId && (
            <PreviewStep
              jobId={jobId}
              session={session!}
              onComplete={handleStepComplete}
            />
          )}
          {currentStep === WizardStep.IMPORT && jobId && (
            <ImportStep
              jobId={jobId}
              session={session!}
              onComplete={handleStepComplete}
            />
          )}
          {currentStep === WizardStep.VERIFY && jobId && (
            <VerifyStep
              jobId={jobId}
              session={session!}
            />
          )}
        </CardContent>
      </Card>
    </div>
  );
}
```

**steps/UploadStep.tsx:**
- File drop zone with drag-and-drop
- Source type selector (NAVEX, EQS, Legacy Ethico, Generic CSV)
- Auto-detect option
- File size and type validation
- Upload progress bar

**steps/MappingStep.tsx:**
- Two-column layout: source fields | target fields
- Drag-and-drop or dropdown mapping
- AI suggestions button with loading state
- Confidence indicators for AI suggestions
- Manual override with explanation
- Required fields indicator
- Transform function selector (dates, numbers, etc.)
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>MigrationWizard container and Upload/Mapping steps created</done>
</task>

<task type="auto">
  <name>Task 3: Create Preview, Import, and Verify steps</name>
  <files>
    apps/frontend/src/pages/internal/implementation/steps/PreviewStep.tsx
    apps/frontend/src/pages/internal/implementation/steps/ImportStep.tsx
    apps/frontend/src/pages/internal/implementation/steps/VerifyStep.tsx
  </files>
  <action>
**steps/PreviewStep.tsx:**
- Validation summary: X valid, Y errors
- Error list with row numbers and field names
- Sample data table showing source -> transformed
- Color-coded issues (red for errors, yellow for warnings)
- "Fix Mappings" button to go back
- "Proceed to Import" button

**steps/ImportStep.tsx:**
```typescript
import { useEffect, useState } from 'react';
import { useQuery, useMutation } from '@tanstack/react-query';
import { migrationWizardApi, WizardSession } from '@/services/internal/migration-wizard.api';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Alert, AlertDescription, AlertTitle } from '@/components/ui/alert';
import { Checkbox } from '@/components/ui/checkbox';
import { AlertTriangle, Play, Loader2 } from 'lucide-react';

interface ImportStepProps {
  jobId: string;
  session: WizardSession;
  onComplete: () => void;
}

export function ImportStep({ jobId, session, onComplete }: ImportStepProps) {
  const [acknowledged, setAcknowledged] = useState(false);
  const [isImporting, setIsImporting] = useState(false);

  const { data: progress, refetch } = useQuery({
    queryKey: ['migration-progress', jobId],
    queryFn: () => migrationWizardApi.getProgress(jobId),
    enabled: isImporting,
    refetchInterval: 2000,
  });

  const importMutation = useMutation({
    mutationFn: () => migrationWizardApi.confirmImport(jobId),
    onSuccess: () => {
      setIsImporting(true);
    },
  });

  useEffect(() => {
    if (progress?.status === 'COMPLETED') {
      onComplete();
    }
  }, [progress?.status, onComplete]);

  const handleStartImport = () => {
    importMutation.mutate();
  };

  if (isImporting) {
    return (
      <div className="space-y-6 text-center py-8">
        <Loader2 className="h-12 w-12 animate-spin mx-auto text-blue-600" />
        <div>
          <h3 className="text-lg font-semibold">Importing Data</h3>
          <p className="text-gray-500">This may take a few minutes...</p>
        </div>
        <div className="max-w-md mx-auto space-y-2">
          <Progress value={progress?.progress || 0} />
          <p className="text-sm text-gray-500">
            {progress?.progress || 0}% complete
            {progress?.importedRows && ` - ${progress.importedRows} rows imported`}
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <Alert variant="warning">
        <AlertTriangle className="h-4 w-4" />
        <AlertTitle>Ready to Import</AlertTitle>
        <AlertDescription>
          You are about to import {session.job.validRows || 0} records into the system.
          This action will create new cases, RIUs, and persons.
          A 7-day rollback window will be available after import.
        </AlertDescription>
      </Alert>

      <div className="border rounded-lg p-4 space-y-4">
        <h3 className="font-semibold">Import Summary</h3>
        <div className="grid grid-cols-2 gap-4 text-sm">
          <div>
            <span className="text-gray-500">Source File:</span>
            <span className="ml-2 font-medium">{session.job.fileName}</span>
          </div>
          <div>
            <span className="text-gray-500">Source Type:</span>
            <span className="ml-2 font-medium">{session.job.sourceType}</span>
          </div>
          <div>
            <span className="text-gray-500">Valid Records:</span>
            <span className="ml-2 font-medium text-green-600">{session.job.validRows}</span>
          </div>
          <div>
            <span className="text-gray-500">Skipped (errors):</span>
            <span className="ml-2 font-medium text-red-600">{session.job.errorRows}</span>
          </div>
        </div>
      </div>

      <div className="flex items-center gap-2">
        <Checkbox
          id="acknowledge"
          checked={acknowledged}
          onCheckedChange={(checked) => setAcknowledged(checked as boolean)}
        />
        <label htmlFor="acknowledge" className="text-sm">
          I understand this will create new records and have reviewed the preview data
        </label>
      </div>

      <div className="flex justify-end">
        <Button
          onClick={handleStartImport}
          disabled={!acknowledged || importMutation.isPending}
          className="flex items-center gap-2"
        >
          <Play className="h-4 w-4" />
          Start Import
        </Button>
      </div>
    </div>
  );
}
```

**steps/VerifyStep.tsx:**
- Import complete summary
- Records created breakdown by type
- Rollback availability notice with expiration date
- "Rollback" button with confirmation dialog
- Link to view imported records
- "Complete" button to close wizard
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>Preview, Import, and Verify steps created</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/frontend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify wizard step indicator shows progress correctly
4. Verify AI mapping suggestions display with confidence
5. Verify import progress updates in real-time
6. Verify rollback button appears after successful import
</verification>

<success_criteria>
- MigrationWizard navigates through 5 steps with visual progress indicator
- UploadStep handles file selection with format auto-detection
- MappingStep displays AI suggestions with manual override capability
- PreviewStep shows validation errors and transformed data
- ImportStep tracks progress with real-time updates
- VerifyStep shows completion summary with rollback option
- All steps use existing shadcn/ui patterns
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-13-SUMMARY.md`
</output>
