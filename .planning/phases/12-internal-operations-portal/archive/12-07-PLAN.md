---
phase: 12-internal-operations-portal
plan: 07
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - apps/backend/src/modules/operations/hotline-ops/hotline-ops.service.ts
  - apps/backend/src/modules/operations/hotline-ops/directive-admin.service.ts
  - apps/backend/src/modules/operations/hotline-ops/bulk-qa.service.ts
  - apps/backend/src/modules/operations/hotline-ops/hotline-ops.controller.ts
  - apps/backend/src/modules/operations/hotline-ops/dto/hotline-ops.dto.ts
  - apps/backend/src/modules/operations/hotline-ops/hotline-ops.module.ts
  - apps/backend/src/modules/operations/hotline-ops/index.ts
autonomous: true

must_haves:
  truths:
    - "Hotline supervisors can create, update, and delete directives with versioning"
    - "Bulk QA actions process multiple items in transaction with optimistic locking"
    - "Case reassignment transfers ownership with full audit trail"
    - "All operations require HOTLINE_SUPERVISOR or higher role"
  artifacts:
    - path: "apps/backend/src/modules/operations/hotline-ops/directive-admin.service.ts"
      provides: "Full CRUD for directives with version control"
      exports: ["DirectiveAdminService"]
    - path: "apps/backend/src/modules/operations/hotline-ops/bulk-qa.service.ts"
      provides: "Bulk approve/reject/reassign for QA queue"
      exports: ["BulkQaService"]
  key_links:
    - from: "directive-admin.service.ts"
      to: "DirectivesService"
      via: "Extends existing read operations"
      pattern: "directivesService\\."
    - from: "bulk-qa.service.ts"
      to: "QaQueueService"
      via: "Extends existing QA operations"
      pattern: "qaQueueService\\."
---

<objective>
Create the Hotline Operations service that enables supervisors to manage directives, perform bulk QA actions, and reassign cases.

Purpose: Hotline supervisors currently need developer help to edit directives and lack bulk actions for QA queue. This service extends existing Phase 8 infrastructure with admin capabilities.

Output: DirectiveAdminService for CRUD with versioning, BulkQaService for bulk operations, HotlineOpsController for REST API.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-01-SUMMARY.md
@apps/backend/src/modules/portals/operator/directives.service.ts
@apps/backend/src/modules/portals/operator/qa-queue.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hotline Ops DTOs</name>
  <files>apps/backend/src/modules/operations/hotline-ops/dto/hotline-ops.dto.ts</files>
  <action>
Create DTOs for hotline operations:

```typescript
import { IsString, IsOptional, IsArray, IsEnum, IsBoolean, ValidateNested, IsNumber, Min, Max } from 'class-validator';
import { Type } from 'class-transformer';
import { DirectiveStage } from '@prisma/client';

// Directive Admin DTOs
export class CreateDirectiveAdminDto {
  @IsString()
  organizationId: string;

  @IsEnum(DirectiveStage)
  stage: DirectiveStage;

  @IsOptional()
  @IsString()
  categoryId?: string;

  @IsString()
  title: string;

  @IsString()
  content: string;

  @IsOptional()
  @IsBoolean()
  isReadAloud?: boolean;

  @IsOptional()
  @IsNumber()
  order?: number;
}

export class UpdateDirectiveAdminDto {
  @IsOptional()
  @IsEnum(DirectiveStage)
  stage?: DirectiveStage;

  @IsOptional()
  @IsString()
  categoryId?: string;

  @IsOptional()
  @IsString()
  title?: string;

  @IsOptional()
  @IsString()
  content?: string;

  @IsOptional()
  @IsBoolean()
  isReadAloud?: boolean;

  @IsOptional()
  @IsBoolean()
  isActive?: boolean;

  @IsOptional()
  @IsNumber()
  order?: number;
}

export class DirectiveVersionDto {
  version: number;
  content: string;
  stage: DirectiveStage;
  archivedAt: Date;
  archivedByName: string;
}

export class DirectiveWithVersionsDto {
  id: string;
  organizationId: string;
  stage: DirectiveStage;
  categoryId?: string;
  categoryName?: string;
  title: string;
  content: string;
  isReadAloud: boolean;
  isActive: boolean;
  order: number;
  version: number;
  createdAt: Date;
  updatedAt: Date;
  versions: DirectiveVersionDto[];
}

// Bulk QA DTOs
export class BulkQaActionDto {
  @IsArray()
  @IsString({ each: true })
  riuIds: string[];

  @IsString()
  organizationId: string;
}

export class BulkApproveDto extends BulkQaActionDto {
  @IsOptional()
  @IsString()
  notes?: string;
}

export class BulkRejectDto extends BulkQaActionDto {
  @IsString()
  reason: string;

  @IsOptional()
  @IsBoolean()
  returnToOperator?: boolean; // Default: true
}

export class BulkReassignDto {
  @IsArray()
  @IsString({ each: true })
  riuIds: string[];

  @IsString()
  organizationId: string;

  @IsString()
  newReviewerId: string;

  @IsOptional()
  @IsString()
  reason?: string;
}

export class BulkActionResultDto {
  successCount: number;
  failureCount: number;
  failures: {
    riuId: string;
    error: string;
  }[];
  processedAt: Date;
}

// Case Reassignment DTOs
export class ReassignCaseDto {
  @IsString()
  caseId: string;

  @IsString()
  organizationId: string;

  @IsString()
  newAssigneeId: string;

  @IsString()
  reason: string;
}

export class BulkCaseReassignDto {
  @IsArray()
  @ValidateNested({ each: true })
  @Type(() => ReassignCaseDto)
  assignments: ReassignCaseDto[];
}

// Query DTOs
export class DirectiveQueryDto {
  @IsString()
  organizationId: string;

  @IsOptional()
  @IsEnum(DirectiveStage)
  stage?: DirectiveStage;

  @IsOptional()
  @IsBoolean()
  includeInactive?: boolean;

  @IsOptional()
  @IsString()
  categoryId?: string;
}

export class QaSupervisorQueueDto {
  @IsString()
  organizationId: string;

  @IsOptional()
  @IsString()
  reviewerId?: string; // Filter by assigned reviewer

  @IsOptional()
  @IsString()
  status?: string;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  page?: number = 1;

  @IsOptional()
  @Type(() => Number)
  @IsNumber()
  @Min(1)
  @Max(100)
  limit?: number = 50;
}
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>Hotline operations DTOs defined for directives, bulk QA, and reassignment</done>
</task>

<task type="auto">
  <name>Task 2: Create DirectiveAdminService with versioning</name>
  <files>apps/backend/src/modules/operations/hotline-ops/directive-admin.service.ts</files>
  <action>
Create DirectiveAdminService extending directive management with admin capabilities:

1. **Inject dependencies:**
   - PrismaService
   - DirectivesService (from portals/operator)
   - AuditService
   - Logger

2. **createDirective(dto: CreateDirectiveAdminDto, userId: string):**
   - Delegate to directivesService.create
   - Log to audit as DIRECTIVE_CREATED
   - Return created directive

3. **updateDirective(id: string, organizationId: string, dto: UpdateDirectiveAdminDto, userId: string):**
   - Get current directive
   - Archive current version to DirectiveVersion table:
     ```typescript
     await this.prisma.directiveVersion.create({
       data: {
         directiveId: id,
         version: current.version,
         stage: current.stage,
         content: current.content,
         archivedAt: new Date(),
         archivedById: userId,
       },
     });
     ```
   - Update directive with new values and increment version
   - Log to audit with before/after changes
   - Return updated directive

4. **deleteDirective(id: string, organizationId: string, userId: string):**
   - Soft delete via directivesService.delete
   - Log to audit as DIRECTIVE_DELETED
   - Return void

5. **getDirectiveWithVersions(id: string, organizationId: string):**
   - Get directive with all version history
   - Return DirectiveWithVersionsDto

6. **restoreVersion(directiveId: string, versionNumber: number, userId: string):**
   - Find archived version
   - Archive current version
   - Restore historical version content
   - Log to audit
   - Return restored directive

7. **listDirectives(query: DirectiveQueryDto):**
   - Delegate to directivesService.getAllDirectives
   - Include version count per directive

8. **reorderDirectives(organizationId: string, ids: string[], userId: string):**
   - Delegate to directivesService.reorder
   - Log to audit
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>DirectiveAdminService provides CRUD with version history and restoration</done>
</task>

<task type="auto">
  <name>Task 3: Create BulkQaService, HotlineOpsController, and module</name>
  <files>
    apps/backend/src/modules/operations/hotline-ops/bulk-qa.service.ts
    apps/backend/src/modules/operations/hotline-ops/hotline-ops.controller.ts
    apps/backend/src/modules/operations/hotline-ops/hotline-ops.module.ts
    apps/backend/src/modules/operations/hotline-ops/index.ts
  </files>
  <action>
**bulk-qa.service.ts:**
1. Inject PrismaService, QaQueueService (from portals/operator), AuditService

2. **bulkApprove(dto: BulkApproveDto, userId: string):**
   - Use transaction with FOR UPDATE to prevent race conditions:
     ```typescript
     await this.prisma.$transaction(async (tx) => {
       // Lock rows for update
       const items = await tx.hotlineRiu.findMany({
         where: { id: { in: dto.riuIds }, organizationId: dto.organizationId },
         select: { id: true, qaStatus: true },
       });

       for (const item of items) {
         // Check item not already processed
         if (item.qaStatus !== 'PENDING' && item.qaStatus !== 'IN_REVIEW') {
           failures.push({ riuId: item.id, error: `Already ${item.qaStatus}` });
           continue;
         }
         // Approve
         await tx.hotlineRiu.update({...});
         successCount++;
       }
     });
     ```
   - Log bulk action to audit
   - Return BulkActionResultDto

3. **bulkReject(dto: BulkRejectDto, userId: string):**
   - Similar transaction pattern
   - Update status to REJECTED
   - If returnToOperator, clear qaReviewerId
   - Return BulkActionResultDto

4. **bulkReassign(dto: BulkReassignDto, userId: string):**
   - Validate newReviewerId is valid internal user
   - Update qaReviewerId for all items
   - Log reassignment with reason
   - Return BulkActionResultDto

5. **getSupervisorQueueView(query: QaSupervisorQueueDto):**
   - Get queue items grouped by reviewer
   - Include reviewer name, item count per reviewer
   - Support filtering and pagination

6. **reassignCase(dto: ReassignCaseDto, userId: string):**
   - Validate case exists and new assignee is valid
   - Update case assignedToId
   - Log reassignment with reason to audit
   - Create activity entry

**hotline-ops.controller.ts:**
```typescript
@Controller('api/v1/internal/hotline-ops')
@UseGuards(InternalAuthGuard)
@Roles('HOTLINE_SUPERVISOR', 'PLATFORM_ADMIN') // Custom roles guard
export class HotlineOpsController {
  constructor(
    private readonly directiveAdmin: DirectiveAdminService,
    private readonly bulkQa: BulkQaService,
  ) {}

  // Directive endpoints
  @Get('directives')
  async listDirectives(@Query() query: DirectiveQueryDto) {...}

  @Get('directives/:id')
  async getDirective(@Param('id') id: string, @Query('organizationId') orgId: string) {...}

  @Post('directives')
  async createDirective(@Body() dto: CreateDirectiveAdminDto, @CurrentInternalUser() user) {...}

  @Patch('directives/:id')
  async updateDirective(@Param('id') id: string, @Body() dto: UpdateDirectiveAdminDto, @CurrentInternalUser() user) {...}

  @Delete('directives/:id')
  async deleteDirective(@Param('id') id: string, @Query('organizationId') orgId: string, @CurrentInternalUser() user) {...}

  @Post('directives/:id/restore-version')
  async restoreVersion(@Param('id') id: string, @Body() body: { version: number }, @CurrentInternalUser() user) {...}

  @Post('directives/reorder')
  async reorderDirectives(@Body() body: { organizationId: string; ids: string[] }, @CurrentInternalUser() user) {...}

  // Bulk QA endpoints
  @Get('qa-queue')
  async getQaQueue(@Query() query: QaSupervisorQueueDto) {...}

  @Post('qa/bulk-approve')
  async bulkApprove(@Body() dto: BulkApproveDto, @CurrentInternalUser() user) {...}

  @Post('qa/bulk-reject')
  async bulkReject(@Body() dto: BulkRejectDto, @CurrentInternalUser() user) {...}

  @Post('qa/bulk-reassign')
  async bulkReassign(@Body() dto: BulkReassignDto, @CurrentInternalUser() user) {...}

  // Case reassignment
  @Post('cases/reassign')
  async reassignCase(@Body() dto: ReassignCaseDto, @CurrentInternalUser() user) {...}

  @Post('cases/bulk-reassign')
  async bulkReassignCases(@Body() dto: BulkCaseReassignDto, @CurrentInternalUser() user) {...}
}
```

**hotline-ops.module.ts:**
- Import PrismaModule, AuditModule, OperatorPortalModule (for DirectivesService, QaQueueService)
- Provide DirectiveAdminService, BulkQaService
- Add HotlineOpsController
- Export services

**index.ts:**
- Export all services, DTOs
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>BulkQaService handles bulk operations with optimistic locking, controller provides REST API</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify directive versioning creates history entries
4. Verify bulk operations use transactions with FOR UPDATE
5. Verify all operations log to audit
6. Verify role guards restrict to HOTLINE_SUPERVISOR+
</verification>

<success_criteria>
- DirectiveAdminService provides CRUD with automatic version archiving
- Version restoration allows rollback to previous directive content
- BulkQaService handles bulk approve/reject/reassign with optimistic locking
- Race conditions prevented via FOR UPDATE in transactions
- Case reassignment supported with audit trail
- All operations restricted to HOTLINE_SUPERVISOR or higher
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-07-SUMMARY.md`
</output>
