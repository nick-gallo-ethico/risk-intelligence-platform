---
phase: 12-internal-operations-portal
plan: 09
type: execute
wave: 3
depends_on: ["12-02"]
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/operations/training/training-admin.service.ts
  - apps/backend/src/modules/operations/training/dto/training.dto.ts
  - apps/backend/src/modules/operations/training/types/training.types.ts
  - apps/backend/src/modules/operations/training/training.controller.ts
  - apps/backend/src/modules/operations/training/training.module.ts
  - apps/backend/src/modules/operations/training/index.ts
autonomous: true

must_haves:
  truths:
    - "Certification tracks have required and optional courses"
    - "Progress is tracked per user per certification"
    - "Exams can be required for certification completion"
    - "Training assignments link to implementation projects"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "CertificationTrack, Course, TrainingProgress, Exam models"
      contains: "model CertificationTrack"
    - path: "apps/backend/src/modules/operations/training/training-admin.service.ts"
      provides: "CRUD for tracks, courses, progress tracking"
      exports: ["TrainingAdminService"]
  key_links:
    - from: "TrainingProgress"
      to: "InternalUser"
      via: "userId FK"
      pattern: "userId.*InternalUser"
    - from: "TrainingAssignment"
      to: "ImplementationProject"
      via: "projectId FK"
      pattern: "projectId.*ImplementationProject"
---

<objective>
Create the Training Administration service for managing certification tracks, courses, progress tracking, and exam administration for internal staff and client training.

Purpose: Implementation team needs to track training completion as part of go-live readiness. This service provides the backend for certification management tied to implementation projects.

Output: Prisma models for training entities, TrainingAdminService for CRUD and progress tracking, REST controller.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Training Prisma models to schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models to schema.prisma:

1. **TrackType enum**:
   - INTERNAL (for Ethico staff)
   - CLIENT_ADMIN (for client administrators)
   - CLIENT_INVESTIGATOR (for client investigators)
   - CLIENT_EMPLOYEE (for general employees)

2. **CertificationTrack model**:
   - id (String @id @default(uuid()))
   - name (String) - e.g., "System Administrator Certification"
   - description (String?)
   - type (TrackType)
   - isActive (Boolean @default(true))
   - requiredForGoLive (Boolean @default(false)) - If true, blocks go-live
   - estimatedHours (Int?) - Total estimated time
   - createdAt, updatedAt
   - Relations: courses Course[], progress TrainingProgress[]
   - Index: (type, isActive)

3. **CourseStatus enum**:
   - NOT_STARTED, IN_PROGRESS, COMPLETED, FAILED

4. **Course model**:
   - id (String @id @default(uuid()))
   - trackId (String) - FK to CertificationTrack
   - name (String)
   - description (String?)
   - contentUrl (String?) - Link to LMS or video
   - estimatedMinutes (Int?) - Duration
   - sortOrder (Int)
   - isRequired (Boolean @default(true))
   - hasExam (Boolean @default(false))
   - passingScore (Int?) - If hasExam, minimum passing percentage
   - createdAt, updatedAt
   - Relations: track CertificationTrack, progress CourseProgress[]
   - Index: trackId

5. **TrainingProgress model** (per user per track):
   - id (String @id @default(uuid()))
   - userId (String) - FK to InternalUser or User depending on track type
   - userType (String) - 'INTERNAL' or 'CLIENT'
   - trackId (String) - FK to CertificationTrack
   - organizationId (String?) - For client users
   - status (CourseStatus @default(NOT_STARTED))
   - startedAt (DateTime?)
   - completedAt (DateTime?)
   - certificateUrl (String?) - Generated certificate
   - createdAt, updatedAt
   - Relations: track CertificationTrack, courseProgress CourseProgress[]
   - Unique: (userId, trackId)
   - Index: (trackId, status), (organizationId, trackId)

6. **CourseProgress model** (per user per course):
   - id (String @id @default(uuid()))
   - trainingProgressId (String) - FK to TrainingProgress
   - courseId (String) - FK to Course
   - status (CourseStatus @default(NOT_STARTED))
   - startedAt (DateTime?)
   - completedAt (DateTime?)
   - examScore (Int?) - If course has exam
   - examAttempts (Int @default(0))
   - createdAt, updatedAt
   - Relations: trainingProgress TrainingProgress, course Course
   - Unique: (trainingProgressId, courseId)

7. **TrainingAssignment model** (links to implementation):
   - id (String @id @default(uuid()))
   - projectId (String) - FK to ImplementationProject
   - trackId (String) - FK to CertificationTrack
   - targetRole (String) - 'ADMIN', 'INVESTIGATOR', etc.
   - requiredCompletions (Int) - How many users must complete
   - currentCompletions (Int @default(0)) - Denormalized count
   - dueDate (DateTime?)
   - createdAt, updatedAt
   - Relations: project ImplementationProject, track CertificationTrack
   - Index: projectId

Run `npx prisma generate` after adding models.
  </action>
  <verify>npx prisma validate passes without errors</verify>
  <done>Training models exist in Prisma schema with proper relations</done>
</task>

<task type="auto">
  <name>Task 2: Create Training types, DTOs, and TrainingAdminService</name>
  <files>
    apps/backend/src/modules/operations/training/types/training.types.ts
    apps/backend/src/modules/operations/training/dto/training.dto.ts
    apps/backend/src/modules/operations/training/training-admin.service.ts
  </files>
  <action>
**types/training.types.ts:**
```typescript
export { TrackType, CourseStatus } from '@prisma/client';

export interface TrackWithProgress {
  id: string;
  name: string;
  type: TrackType;
  totalCourses: number;
  completedCourses: number;
  progressPercent: number;
  status: CourseStatus;
  isRequired: boolean;
}

export interface CertificationSummary {
  trackId: string;
  trackName: string;
  totalEnrolled: number;
  completed: number;
  inProgress: number;
  notStarted: number;
  completionRate: number;
}

export interface ProjectTrainingStatus {
  projectId: string;
  assignments: {
    trackName: string;
    targetRole: string;
    required: number;
    completed: number;
    isComplete: boolean;
  }[];
  overallComplete: boolean;
}
```

**dto/training.dto.ts:**
- CreateTrackDto: name, description?, type, isActive, requiredForGoLive, estimatedHours?
- UpdateTrackDto: Partial of CreateTrackDto
- CreateCourseDto: trackId, name, description?, contentUrl?, estimatedMinutes?, sortOrder, isRequired, hasExam, passingScore?
- UpdateCourseDto: Partial of CreateCourseDto
- EnrollUserDto: userId, userType, trackId, organizationId?
- UpdateCourseProgressDto: courseProgressId, status, examScore?
- AssignTrainingToProjectDto: projectId, trackId, targetRole, requiredCompletions, dueDate?
- TrackQueryDto: type?, isActive?, page?, limit?
- ProgressQueryDto: trackId?, organizationId?, status?, userId?

**training-admin.service.ts:**
1. Inject PrismaService, Logger

2. **Track CRUD:**
   - createTrack(dto: CreateTrackDto)
   - updateTrack(id, dto: UpdateTrackDto)
   - getTrack(id) - include courses
   - listTracks(query: TrackQueryDto)
   - deleteTrack(id) - soft delete via isActive=false

3. **Course CRUD:**
   - createCourse(dto: CreateCourseDto)
   - updateCourse(id, dto: UpdateCourseDto)
   - getCourse(id)
   - deleteCourse(id)
   - reorderCourses(trackId, ids[])

4. **Enrollment & Progress:**
   - enrollUser(dto: EnrollUserDto):
     - Create TrainingProgress
     - Create CourseProgress for each course in track
     - Return TrainingProgress with courses

   - updateCourseProgress(dto: UpdateCourseProgressDto):
     - Update course progress
     - If completed, check if all required courses done
     - If all done, mark TrainingProgress as COMPLETED
     - If linked to project, update TrainingAssignment.currentCompletions

   - getUserProgress(userId, trackId):
     - Get TrainingProgress with all CourseProgress
     - Calculate completion percentage

   - getTrackCertificationSummary(trackId):
     - Aggregate progress across all enrolled users
     - Return CertificationSummary

5. **Project Integration:**
   - assignTrainingToProject(dto: AssignTrainingToProjectDto)
   - getProjectTrainingStatus(projectId):
     - Get all assignments
     - Check completion against requirements
     - Return ProjectTrainingStatus

   - checkGoLiveReadiness(projectId):
     - Get required training assignments
     - Return { ready: boolean, blocking: TrackWithProgress[] }
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>TrainingAdminService provides track, course, and progress management</done>
</task>

<task type="auto">
  <name>Task 3: Create Training Controller and Module</name>
  <files>
    apps/backend/src/modules/operations/training/training.controller.ts
    apps/backend/src/modules/operations/training/training.module.ts
    apps/backend/src/modules/operations/training/index.ts
  </files>
  <action>
**training.controller.ts:**
```typescript
@Controller('api/v1/internal/training')
@UseGuards(InternalAuthGuard)
export class TrainingController {
  constructor(private readonly trainingService: TrainingAdminService) {}

  // Track endpoints
  @Get('tracks')
  async listTracks(@Query() query: TrackQueryDto) {
    return this.trainingService.listTracks(query);
  }

  @Get('tracks/:id')
  async getTrack(@Param('id') id: string) {
    return this.trainingService.getTrack(id);
  }

  @Post('tracks')
  @Roles('IMPLEMENTATION_MANAGER', 'PLATFORM_ADMIN')
  async createTrack(@Body() dto: CreateTrackDto) {
    return this.trainingService.createTrack(dto);
  }

  @Patch('tracks/:id')
  @Roles('IMPLEMENTATION_MANAGER', 'PLATFORM_ADMIN')
  async updateTrack(@Param('id') id: string, @Body() dto: UpdateTrackDto) {
    return this.trainingService.updateTrack(id, dto);
  }

  // Course endpoints
  @Post('courses')
  @Roles('IMPLEMENTATION_MANAGER', 'PLATFORM_ADMIN')
  async createCourse(@Body() dto: CreateCourseDto) {
    return this.trainingService.createCourse(dto);
  }

  @Patch('courses/:id')
  @Roles('IMPLEMENTATION_MANAGER', 'PLATFORM_ADMIN')
  async updateCourse(@Param('id') id: string, @Body() dto: UpdateCourseDto) {
    return this.trainingService.updateCourse(id, dto);
  }

  @Post('tracks/:trackId/courses/reorder')
  @Roles('IMPLEMENTATION_MANAGER', 'PLATFORM_ADMIN')
  async reorderCourses(@Param('trackId') trackId: string, @Body() body: { ids: string[] }) {
    return this.trainingService.reorderCourses(trackId, body.ids);
  }

  // Enrollment & Progress
  @Post('enroll')
  async enrollUser(@Body() dto: EnrollUserDto) {
    return this.trainingService.enrollUser(dto);
  }

  @Get('progress/:userId/:trackId')
  async getUserProgress(@Param('userId') userId: string, @Param('trackId') trackId: string) {
    return this.trainingService.getUserProgress(userId, trackId);
  }

  @Patch('course-progress/:id')
  async updateCourseProgress(@Param('id') id: string, @Body() dto: UpdateCourseProgressDto) {
    return this.trainingService.updateCourseProgress({ ...dto, courseProgressId: id });
  }

  @Get('tracks/:trackId/summary')
  async getTrackSummary(@Param('trackId') trackId: string) {
    return this.trainingService.getTrackCertificationSummary(trackId);
  }

  // Project integration
  @Post('projects/:projectId/assign')
  async assignToProject(@Param('projectId') projectId: string, @Body() dto: Omit<AssignTrainingToProjectDto, 'projectId'>) {
    return this.trainingService.assignTrainingToProject({ ...dto, projectId });
  }

  @Get('projects/:projectId/status')
  async getProjectTrainingStatus(@Param('projectId') projectId: string) {
    return this.trainingService.getProjectTrainingStatus(projectId);
  }

  @Get('projects/:projectId/go-live-readiness')
  async checkGoLiveReadiness(@Param('projectId') projectId: string) {
    return this.trainingService.checkGoLiveReadiness(projectId);
  }
}
```

**training.module.ts:**
```typescript
@Module({
  imports: [PrismaModule],
  providers: [TrainingAdminService],
  controllers: [TrainingController],
  exports: [TrainingAdminService],
})
export class TrainingModule {}
```

**index.ts:**
- Export TrainingAdminService, types, DTOs
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>TrainingController provides REST API with role guards</done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - schema is valid
2. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
3. Run `npm run lint` - no lint errors
4. Verify TrainingProgress links to TrainingAssignment for project tracking
5. Verify go-live readiness check returns blocking certifications
</verification>

<success_criteria>
- CertificationTrack, Course, TrainingProgress, CourseProgress models exist
- TrainingAdminService provides full CRUD for tracks and courses
- Progress tracking updates automatically on course completion
- Project integration tracks training as implementation requirement
- Go-live readiness check identifies incomplete required training
- REST API protected by appropriate role guards
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-09-SUMMARY.md`
</output>
