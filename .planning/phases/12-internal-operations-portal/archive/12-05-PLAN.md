---
phase: 12-internal-operations-portal
plan: 05
type: execute
wave: 2
depends_on: ["12-02"]
files_modified:
  - apps/backend/src/modules/operations/implementation/checklist.service.ts
  - apps/backend/src/modules/operations/implementation/templates/standard-template.ts
  - apps/backend/src/modules/operations/implementation/templates/index.ts
  - apps/backend/src/modules/operations/implementation/implementation.service.ts
  - apps/backend/src/modules/operations/implementation/implementation.controller.ts
  - apps/backend/src/modules/operations/implementation/implementation.module.ts
autonomous: true

must_haves:
  truths:
    - "Projects are created from templates based on implementation type"
    - "Tasks are automatically generated with proper phase assignment"
    - "Project health score is calculated from task completion and blockers"
    - "Task status changes update project denormalized counts"
    - "Blockers can be created, resolved, and escalated"
  artifacts:
    - path: "apps/backend/src/modules/operations/implementation/checklist.service.ts"
      provides: "Template-based task generation and project health calculation"
      exports: ["ChecklistService"]
    - path: "apps/backend/src/modules/operations/implementation/implementation.service.ts"
      provides: "Project and task CRUD with blocker management"
      exports: ["ImplementationService"]
    - path: "apps/backend/src/modules/operations/implementation/templates/standard-template.ts"
      provides: "Standard 8-phase implementation checklist"
      exports: ["STANDARD_TEMPLATE", "QUICK_START_TEMPLATE"]
  key_links:
    - from: "implementation.service.ts"
      to: "checklist.service.ts"
      via: "createFromTemplate"
      pattern: "checklistService\\.createFromTemplate"
    - from: "checklist.service.ts"
      to: "prisma.implementationTask"
      via: "createMany"
      pattern: "prisma\\.implementationTask\\.createMany"
---

<objective>
Create the Implementation checklist service with template-based task generation, project management, and health score calculation.

Purpose: Implementation team needs standardized checklists for client onboarding. This service generates tasks from templates, tracks progress, manages blockers, and calculates project health per CONTEXT.md requirements.

Output: ChecklistService for template-based generation, ImplementationService for CRUD operations, templates for each implementation type, REST controller.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-02-SUMMARY.md
@.planning/phases/12-internal-operations-portal/CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create implementation checklist templates</name>
  <files>
    apps/backend/src/modules/operations/implementation/templates/standard-template.ts
    apps/backend/src/modules/operations/implementation/templates/index.ts
  </files>
  <action>
Create checklist templates per CONTEXT.md phases:

**templates/standard-template.ts:**
```typescript
import { ChecklistTemplate, ImplementationPhase } from '../types/implementation.types';
import { ImplementationType } from '@prisma/client';

export const STANDARD_TEMPLATE: ChecklistTemplate = {
  type: ImplementationType.STANDARD,
  phases: [
    {
      phase: ImplementationPhase.FOUNDATION,
      name: 'Foundation',
      tasks: [
        { name: 'Create tenant account', isRequired: true, estimatedHours: 1 },
        { name: 'Configure organization settings', isRequired: true, estimatedHours: 2 },
        { name: 'Upload company logo and branding', isRequired: true, estimatedHours: 1 },
        { name: 'Configure hotline number', isRequired: true, estimatedHours: 1 },
        { name: 'Set up custom domain', isRequired: false, estimatedHours: 2 },
        { name: 'Configure email templates', isRequired: false, estimatedHours: 2 },
      ],
    },
    {
      phase: ImplementationPhase.USERS_ACCESS,
      name: 'Users & Access',
      tasks: [
        { name: 'Configure SSO integration', isRequired: false, estimatedHours: 4 },
        { name: 'Import initial user list', isRequired: true, estimatedHours: 2 },
        { name: 'Assign user roles', isRequired: true, estimatedHours: 2 },
        { name: 'Test user login flow', isRequired: true, estimatedHours: 1 },
        { name: 'Configure MFA requirements', isRequired: false, estimatedHours: 1 },
      ],
    },
    {
      phase: ImplementationPhase.CASE_MANAGEMENT,
      name: 'Case Management Setup',
      tasks: [
        { name: 'Configure intake categories', isRequired: true, estimatedHours: 3 },
        { name: 'Set up intake forms', isRequired: true, estimatedHours: 4 },
        { name: 'Configure routing rules', isRequired: true, estimatedHours: 2 },
        { name: 'Create investigation templates', isRequired: true, estimatedHours: 4 },
        { name: 'Set up workflow stages', isRequired: true, estimatedHours: 2 },
        { name: 'Configure SLA thresholds', isRequired: false, estimatedHours: 1 },
      ],
    },
    {
      phase: ImplementationPhase.INTEGRATIONS,
      name: 'Integrations',
      tasks: [
        { name: 'Complete SSO testing', isRequired: false, estimatedHours: 2 },
        { name: 'Configure HRIS sync', isRequired: false, estimatedHours: 4 },
        { name: 'Test HRIS sync', isRequired: false, estimatedHours: 2 },
        { name: 'Set up email relay', isRequired: false, estimatedHours: 2 },
      ],
    },
    {
      phase: ImplementationPhase.DATA_MIGRATION,
      name: 'Data Migration',
      tasks: [
        { name: 'Export data from legacy system', isRequired: false, estimatedHours: 4 },
        { name: 'Map fields to Ethico schema', isRequired: false, estimatedHours: 4 },
        { name: 'Run test migration', isRequired: false, estimatedHours: 2 },
        { name: 'Review migrated data', isRequired: false, estimatedHours: 4 },
        { name: 'Complete production migration', isRequired: false, estimatedHours: 4 },
      ],
    },
    {
      phase: ImplementationPhase.TRAINING,
      name: 'Training',
      tasks: [
        { name: 'Schedule admin training', isRequired: true, estimatedHours: 1 },
        { name: 'Conduct admin training', isRequired: true, estimatedHours: 4 },
        { name: 'Schedule investigator training', isRequired: true, estimatedHours: 1 },
        { name: 'Conduct investigator training', isRequired: true, estimatedHours: 4 },
        { name: 'Create internal documentation', isRequired: false, estimatedHours: 4 },
      ],
    },
    {
      phase: ImplementationPhase.GO_LIVE_READINESS,
      name: 'Go-Live Readiness',
      tasks: [
        { name: 'Complete UAT testing', isRequired: true, estimatedHours: 8 },
        { name: 'Obtain stakeholder sign-off', isRequired: true, estimatedHours: 2 },
        { name: 'Configure production hotline', isRequired: true, estimatedHours: 1 },
        { name: 'Final security review', isRequired: true, estimatedHours: 2 },
        { name: 'Go-live communication plan', isRequired: true, estimatedHours: 2 },
      ],
    },
    {
      phase: ImplementationPhase.HANDOFF,
      name: 'Handoff',
      tasks: [
        { name: 'CSM introduction meeting', isRequired: true, estimatedHours: 1 },
        { name: 'Create support documentation', isRequired: true, estimatedHours: 2 },
        { name: 'Transfer to ongoing support', isRequired: true, estimatedHours: 1 },
        { name: 'Schedule 30-day check-in', isRequired: true, estimatedHours: 1 },
      ],
    },
  ],
};

// Quick Start is subset of Standard
export const QUICK_START_TEMPLATE: ChecklistTemplate = {
  type: ImplementationType.QUICK_START,
  phases: STANDARD_TEMPLATE.phases.filter(p =>
    [ImplementationPhase.FOUNDATION, ImplementationPhase.USERS_ACCESS,
     ImplementationPhase.CASE_MANAGEMENT, ImplementationPhase.TRAINING,
     ImplementationPhase.GO_LIVE_READINESS, ImplementationPhase.HANDOFF].includes(p.phase)
  ).map(p => ({
    ...p,
    tasks: p.tasks.filter(t => t.isRequired) // Only required tasks
  })),
};

// Create similar for COMPLEX and ENTERPRISE with more tasks
export const COMPLEX_TEMPLATE: ChecklistTemplate = {
  type: ImplementationType.COMPLEX,
  phases: STANDARD_TEMPLATE.phases, // Same phases, add custom tasks via customization
};

export const ENTERPRISE_TEMPLATE: ChecklistTemplate = {
  type: ImplementationType.ENTERPRISE,
  phases: STANDARD_TEMPLATE.phases, // Same structure, longer timelines
};
```

**templates/index.ts:**
```typescript
import { ImplementationType } from '@prisma/client';
import { ChecklistTemplate } from '../types/implementation.types';
import { STANDARD_TEMPLATE, QUICK_START_TEMPLATE, COMPLEX_TEMPLATE, ENTERPRISE_TEMPLATE } from './standard-template';

export const TEMPLATES: Record<ImplementationType, ChecklistTemplate> = {
  [ImplementationType.QUICK_START]: QUICK_START_TEMPLATE,
  [ImplementationType.STANDARD]: STANDARD_TEMPLATE,
  [ImplementationType.COMPLEX]: COMPLEX_TEMPLATE,
  [ImplementationType.ENTERPRISE]: ENTERPRISE_TEMPLATE,
};

export function getTemplate(type: ImplementationType): ChecklistTemplate {
  return TEMPLATES[type];
}

export * from './standard-template';
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>Implementation templates defined for all implementation types with proper phase structure</done>
</task>

<task type="auto">
  <name>Task 2: Create ChecklistService for template-based task generation</name>
  <files>apps/backend/src/modules/operations/implementation/checklist.service.ts</files>
  <action>
Create ChecklistService with the following methods:

1. **Inject dependencies:**
   - PrismaService
   - Logger

2. **createFromTemplate(projectId: string, type: ImplementationType):**
   - Get template for type from TEMPLATES
   - Flatten phases into tasks with sortOrder
   - Use prisma.implementationTask.createMany for batch insert
   - Return created tasks

3. **calculateProjectHealth(projectId: string):**
   - Get project with all tasks and blockers
   - Calculate base score from task completion:
     ```typescript
     const requiredTasks = tasks.filter(t => t.isRequired);
     const completedRequired = requiredTasks.filter(t => t.status === 'COMPLETED');
     let score = (completedRequired.length / requiredTasks.length) * 100;
     ```
   - Apply penalties:
     - Blocked tasks: -5 points each
     - Overdue tasks: -10 points each (dueDate < now && status !== 'COMPLETED')
     - Unresolved blockers: -5 points each
   - Clamp to 0-100
   - Return rounded integer

4. **updateProjectDenormalizedCounts(projectId: string):**
   - Count total tasks
   - Count completed tasks
   - Count blocked tasks
   - Update project with new counts
   - Recalculate and update healthScore

5. **getProjectProgress(projectId: string):**
   - Get all tasks grouped by phase
   - Calculate completion percentage per phase
   - Return structured progress report:
     ```typescript
     interface PhaseProgress {
       phase: ImplementationPhase;
       name: string;
       total: number;
       completed: number;
       blocked: number;
       percentComplete: number;
     }
     ```

6. **getOverdueTasks(projectId: string):**
   - Find tasks where dueDate < now AND status NOT IN ['COMPLETED', 'SKIPPED']
   - Return sorted by dueDate ascending (most overdue first)
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>ChecklistService provides template-based generation and health calculation</done>
</task>

<task type="auto">
  <name>Task 3: Create ImplementationService and Controller</name>
  <files>
    apps/backend/src/modules/operations/implementation/implementation.service.ts
    apps/backend/src/modules/operations/implementation/implementation.controller.ts
    apps/backend/src/modules/operations/implementation/implementation.module.ts
  </files>
  <action>
**implementation.service.ts:**
1. Inject PrismaService, ChecklistService, AuditService

2. **createProject(dto: CreateProjectDto, creatorId: string):**
   - Validate organization exists
   - Create project with status NOT_STARTED
   - Call checklistService.createFromTemplate to generate tasks
   - Update denormalized counts
   - Log to audit
   - Return project with tasks

3. **updateProject(projectId: string, dto: UpdateProjectDto, userId: string):**
   - Update project fields
   - If status changes, log to audit
   - Return updated project

4. **updateTaskStatus(taskId: string, status: TaskStatus, userId: string, notes?: string):**
   - Update task status
   - If COMPLETED, set completedAt and completedById
   - Call checklistService.updateProjectDenormalizedCounts
   - Log to audit

5. **createBlocker(dto: CreateBlockerDto, creatorId: string):**
   - Create blocker
   - If linked to task, update task status to BLOCKED
   - Update project denormalized counts
   - Return blocker

6. **resolveBlocker(blockerId: string, resolution: string, userId: string):**
   - Update blocker with isResolved=true, resolution, resolvedAt, resolvedById
   - If linked to task, change task status from BLOCKED to IN_PROGRESS
   - Update project denormalized counts
   - Return updated blocker

7. **getProject(projectId: string):**
   - Get project with tasks, blockers, specialist, manager relations
   - Include calculated fields (progress, overdue tasks)

8. **listProjects(query: ProjectQueryDto):**
   - Filter by status, specialistId, type
   - Include denormalized counts
   - Paginate

**implementation.controller.ts:**
```typescript
@Controller('api/v1/internal/implementation')
@UseGuards(InternalAuthGuard) // Internal users only
export class ImplementationController {
  constructor(private readonly implementationService: ImplementationService) {}

  @Post('projects')
  async createProject(@Body() dto: CreateProjectDto, @CurrentInternalUser() user) {
    return this.implementationService.createProject(dto, user.id);
  }

  @Get('projects')
  async listProjects(@Query() query: ProjectQueryDto) {
    return this.implementationService.listProjects(query);
  }

  @Get('projects/:id')
  async getProject(@Param('id') id: string) {
    return this.implementationService.getProject(id);
  }

  @Patch('projects/:id')
  async updateProject(@Param('id') id: string, @Body() dto: UpdateProjectDto, @CurrentInternalUser() user) {
    return this.implementationService.updateProject(id, dto, user.id);
  }

  @Patch('tasks/:id/status')
  async updateTaskStatus(
    @Param('id') id: string,
    @Body() body: { status: TaskStatus; notes?: string },
    @CurrentInternalUser() user,
  ) {
    return this.implementationService.updateTaskStatus(id, body.status, user.id, body.notes);
  }

  @Post('blockers')
  async createBlocker(@Body() dto: CreateBlockerDto, @CurrentInternalUser() user) {
    return this.implementationService.createBlocker(dto, user.id);
  }

  @Patch('blockers/:id/resolve')
  async resolveBlocker(@Param('id') id: string, @Body() body: ResolveBlockerDto, @CurrentInternalUser() user) {
    return this.implementationService.resolveBlocker(id, body.resolution, user.id);
  }
}
```

**Update implementation.module.ts:**
- Import PrismaModule, AuditModule
- Provide ChecklistService, ImplementationService
- Add ImplementationController
- Export services
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>ImplementationService handles project CRUD with automatic task generation and blocker management</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify templates have all 8 phases per CONTEXT.md
4. Verify health score calculation includes penalties
5. Verify task status changes trigger denormalized count updates
</verification>

<success_criteria>
- Templates define tasks for QUICK_START, STANDARD, COMPLEX, ENTERPRISE types
- ChecklistService.createFromTemplate generates tasks from template
- Health score calculated with completion and penalties for blockers/overdue
- Denormalized counts update on every task/blocker change
- ImplementationService provides full CRUD for projects, tasks, blockers
- All changes logged to audit
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-05-SUMMARY.md`
</output>
