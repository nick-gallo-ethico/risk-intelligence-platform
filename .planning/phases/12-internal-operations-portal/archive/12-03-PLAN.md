---
phase: 12-internal-operations-portal
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/operations/client-health/entities/client-health.entity.ts
  - apps/backend/src/modules/operations/client-health/dto/client-health.dto.ts
  - apps/backend/src/modules/operations/client-health/types/client-health.types.ts
  - apps/backend/src/modules/operations/client-health/client-health.module.ts
  - apps/backend/src/modules/operations/client-health/index.ts
autonomous: true

must_haves:
  truths:
    - "Health scores are calculated daily from multiple weighted components"
    - "Usage metrics track logins, cases, campaigns, and feature usage"
    - "Feature adoption tracks which features each tenant has used"
    - "Trend detection identifies improving, stable, or declining health"
    - "Risk level is derived from score and trend combination"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "TenantHealthScore, UsageMetric, FeatureAdoption models"
      contains: "model TenantHealthScore"
    - path: "apps/backend/src/modules/operations/client-health/types/client-health.types.ts"
      provides: "Health score component weights and calculation types"
      exports: ["HEALTH_WEIGHTS", "HealthTrend", "RiskLevel"]
  key_links:
    - from: "TenantHealthScore"
      to: "Organization"
      via: "organizationId FK"
      pattern: "organizationId.*Organization"
---

<objective>
Create the database models for client health metrics - health scores, usage metrics, and feature adoption tracking that enable Client Success Managers to monitor tenant health and identify at-risk accounts.

Purpose: CSMs currently have no visibility into client usage patterns. This infrastructure enables proactive health monitoring, renewal risk identification, and adoption tracking per CONTEXT.md requirements.

Output: Prisma models for TenantHealthScore, UsageMetric, FeatureAdoption with proper relations; TypeScript entities, types with weight configuration, and DTOs.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/CONTEXT.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Client Health Prisma models to schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models to schema.prisma:

1. **HealthTrend enum**:
   - IMPROVING, STABLE, DECLINING

2. **RiskLevel enum**:
   - LOW, MEDIUM, HIGH

3. **TenantHealthScore model** (per CONTEXT.md health calculation):
   - id (String @id @default(uuid()))
   - organizationId (String) - FK to Organization
   - calculatedAt (DateTime @default(now()))

   Component scores (0-100 each):
   - loginScore (Int) - Active users / total users
   - caseResolutionScore (Int) - On-time case closures
   - campaignCompletionScore (Int) - Attestation/campaign completion rates
   - featureAdoptionScore (Int) - Features used / features available
   - supportTicketScore (Int) - Inverse of ticket volume (lower tickets = higher score)

   Composite:
   - overallScore (Int) - Weighted average per HEALTH_WEIGHTS
   - trend (HealthTrend)
   - riskLevel (RiskLevel)

   - createdAt (DateTime @default(now()))
   - Relation: organization Organization
   - Indexes: organizationId, (organizationId, calculatedAt), calculatedAt
   - Unique: (organizationId, calculatedAt) - One score per org per calculation time

4. **MetricType enum**:
   - DAILY_ACTIVE_USERS, MONTHLY_ACTIVE_USERS
   - CASES_CREATED, CASES_CLOSED, CASES_CLOSED_ON_TIME
   - CAMPAIGNS_COMPLETED, CAMPAIGN_RESPONSE_RATE
   - REPORTS_GENERATED, SEARCHES_PERFORMED
   - API_CALLS, SUPPORT_TICKETS

5. **UsageMetric model**:
   - id (String @id @default(uuid()))
   - organizationId (String) - FK to Organization
   - metricType (MetricType)
   - date (DateTime) - The date this metric applies to
   - value (Int) - The metric value
   - previousValue (Int?) - Value from previous period for comparison
   - changePercent (Float?) - Calculated change percentage
   - createdAt (DateTime @default(now()))
   - Relation: organization Organization
   - Indexes: (organizationId, metricType, date), (organizationId, date)
   - Unique: (organizationId, metricType, date) - One metric per type per org per day

6. **FeatureName enum** (key features to track):
   - CASE_MANAGEMENT, INVESTIGATION_CHECKLISTS
   - ANONYMOUS_REPORTING, EMPLOYEE_PORTAL
   - CAMPAIGN_MANAGEMENT, COI_DISCLOSURES
   - POLICY_MANAGEMENT, AI_ASSISTANT
   - CUSTOM_DASHBOARDS, SCHEDULED_REPORTS
   - HRIS_INTEGRATION, SSO

7. **FeatureAdoption model**:
   - id (String @id @default(uuid()))
   - organizationId (String) - FK to Organization
   - featureName (FeatureName)
   - isEnabled (Boolean @default(false)) - Feature is available to tenant
   - isUsed (Boolean @default(false)) - Tenant has used the feature
   - firstUsedAt (DateTime?) - When feature was first used
   - lastUsedAt (DateTime?) - Most recent usage
   - usageCount (Int @default(0)) - Total usage count
   - createdAt, updatedAt
   - Relation: organization Organization
   - Index: organizationId
   - Unique: (organizationId, featureName)

Run `npx prisma generate` after adding models.
  </action>
  <verify>npx prisma validate passes without errors</verify>
  <done>TenantHealthScore, UsageMetric, FeatureAdoption models exist with proper enums, relations, and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript entities, types, and DTOs</name>
  <files>
    apps/backend/src/modules/operations/client-health/entities/client-health.entity.ts
    apps/backend/src/modules/operations/client-health/types/client-health.types.ts
    apps/backend/src/modules/operations/client-health/dto/client-health.dto.ts
    apps/backend/src/modules/operations/client-health/client-health.module.ts
    apps/backend/src/modules/operations/client-health/index.ts
  </files>
  <action>
Create the directory structure and files:

**types/client-health.types.ts:**
```typescript
// Re-export enums from Prisma
export { HealthTrend, RiskLevel, MetricType, FeatureName } from '@prisma/client';

// Health score weight configuration per CONTEXT.md
export const HEALTH_WEIGHTS = {
  login: 0.20,          // 20% - User engagement
  caseResolution: 0.25, // 25% - Core workflow execution
  campaignCompletion: 0.25, // 25% - Compliance program adoption
  featureAdoption: 0.15, // 15% - Platform utilization
  supportTickets: 0.15, // 15% - Operational health (inverse)
} as const;

// Thresholds for trend determination
export const TREND_THRESHOLDS = {
  IMPROVING: 5,  // Score increased by 5+ points
  DECLINING: -5, // Score decreased by 5+ points
  // Between these = STABLE
} as const;

// Risk level determination
export interface RiskDetermination {
  score: number;
  trend: HealthTrend;
  riskLevel: RiskLevel;
}

// Health score with organization info for dashboard
export interface HealthScoreSummary {
  organizationId: string;
  organizationName: string;
  overallScore: number;
  trend: HealthTrend;
  riskLevel: RiskLevel;
  componentScores: {
    login: number;
    caseResolution: number;
    campaignCompletion: number;
    featureAdoption: number;
    supportTickets: number;
  };
  calculatedAt: Date;
  renewalDate?: Date;
  daysUntilRenewal?: number;
}

// Usage metric with trend
export interface UsageMetricWithTrend {
  metricType: MetricType;
  currentValue: number;
  previousValue?: number;
  changePercent?: number;
  trend: 'up' | 'down' | 'stable';
  periodStart: Date;
  periodEnd: Date;
}

// Feature adoption summary
export interface FeatureAdoptionSummary {
  totalFeatures: number;
  enabledFeatures: number;
  usedFeatures: number;
  adoptionRate: number; // usedFeatures / enabledFeatures * 100
  features: {
    name: FeatureName;
    isEnabled: boolean;
    isUsed: boolean;
    usageCount: number;
    lastUsedAt?: Date;
  }[];
}
```

**entities/client-health.entity.ts:**
- TenantHealthScoreEntity matching Prisma model
- UsageMetricEntity matching Prisma model
- FeatureAdoptionEntity matching Prisma model
- Include organization relation as optional

**dto/client-health.dto.ts:**
- HealthScoreQueryDto: organizationId?, riskLevel?, trend?, minScore?, maxScore?, page?, limit?, sortBy?, sortDir?
- UsageMetricQueryDto: organizationId, metricTypes[]?, startDate?, endDate?
- FeatureAdoptionQueryDto: organizationId, onlyUnused? (boolean)
- RecordUsageDto: organizationId, metricType, value, date?
- UpdateFeatureAdoptionDto: organizationId, featureName, isEnabled?, isUsed?, usageCount?

**client-health.module.ts:**
```typescript
import { Module } from '@nestjs/common';

@Module({
  imports: [],
  providers: [],
  exports: [],
})
export class ClientHealthModule {}
```

**index.ts:**
- Export all types, entities, DTOs, HEALTH_WEIGHTS
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>TypeScript entities, types with HEALTH_WEIGHTS configuration, and DTOs are complete and exported</done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - schema is valid
2. Run `npx prisma generate` - Prisma client generates
3. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
4. Verify HEALTH_WEIGHTS sums to 1.0 (0.20 + 0.25 + 0.25 + 0.15 + 0.15 = 1.00)
5. Verify all enums match between Prisma schema and TypeScript types
6. Verify ClientHealthModule is importable
</verification>

<success_criteria>
- TenantHealthScore, UsageMetric, FeatureAdoption Prisma models exist
- Enums: HealthTrend, RiskLevel, MetricType, FeatureName
- HEALTH_WEIGHTS constant matches CONTEXT.md specification
- TypeScript entities match Prisma models
- DTOs for querying and recording metrics defined
- HealthScoreSummary interface includes all dashboard display fields
- FeatureAdoptionSummary calculates adoption rate
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-03-SUMMARY.md`
</output>
