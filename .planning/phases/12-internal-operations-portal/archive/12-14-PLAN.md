---
phase: 12-internal-operations-portal
plan: 14
type: execute
wave: 4
depends_on: ["12-07"]
files_modified:
  - apps/frontend/src/pages/internal/hotline/HotlineOpsPage.tsx
  - apps/frontend/src/pages/internal/hotline/DirectiveEditor.tsx
  - apps/frontend/src/pages/internal/hotline/BulkQaDashboard.tsx
  - apps/frontend/src/pages/internal/hotline/CaseReassignment.tsx
  - apps/frontend/src/services/internal/hotline-ops.api.ts
autonomous: true

must_haves:
  truths:
    - "Directive editor supports CRUD with version history"
    - "Bulk QA actions process multiple items with progress feedback"
    - "Case reassignment shows current owner and allows transfer"
    - "QA queue displays items grouped by reviewer with bulk selection"
  artifacts:
    - path: "apps/frontend/src/pages/internal/hotline/DirectiveEditor.tsx"
      provides: "CRUD UI for directives with stage grouping and version history"
      exports: ["DirectiveEditor"]
    - path: "apps/frontend/src/pages/internal/hotline/BulkQaDashboard.tsx"
      provides: "QA queue with bulk selection and action buttons"
      exports: ["BulkQaDashboard"]
  key_links:
    - from: "hotline-ops.api.ts"
      to: "/api/v1/internal/hotline-ops"
      via: "API calls"
      pattern: "/internal/hotline-ops"
---

<objective>
Create the Hotline Operations UI that enables supervisors to manage directives, perform bulk QA actions, and reassign cases.

Purpose: Hotline supervisors need to update directives without developer help and efficiently process QA queue backlogs. This builds the UI for the 12-07 backend services.

Output: HotlineOpsPage, DirectiveEditor, BulkQaDashboard, CaseReassignment components; API service.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hotline Operations API service</name>
  <files>apps/frontend/src/services/internal/hotline-ops.api.ts</files>
  <action>
Create API service for hotline operations:

```typescript
import { api } from '../api';

export type DirectiveStage = 'OPENING' | 'INTAKE' | 'CATEGORY_SPECIFIC' | 'CLOSING';

export interface Directive {
  id: string;
  organizationId: string;
  stage: DirectiveStage;
  categoryId?: string;
  categoryName?: string;
  title: string;
  content: string;
  isReadAloud: boolean;
  isActive: boolean;
  order: number;
  version: number;
  createdAt: string;
  updatedAt: string;
}

export interface DirectiveVersion {
  version: number;
  content: string;
  stage: DirectiveStage;
  archivedAt: string;
  archivedByName: string;
}

export interface QaQueueItem {
  id: string;
  organizationId: string;
  organizationName: string;
  referenceNumber: string;
  summary?: string;
  categoryName?: string;
  severity: string;
  qaStatus: string;
  qaReviewerId?: string;
  qaReviewerName?: string;
  createdAt: string;
}

export interface BulkActionResult {
  successCount: number;
  failureCount: number;
  failures: { riuId: string; error: string }[];
}

export const hotlineOpsApi = {
  // Directives
  listDirectives: (organizationId: string, params?: { stage?: DirectiveStage; includeInactive?: boolean }) =>
    api.get<Record<DirectiveStage, Directive[]>>('/internal/hotline-ops/directives', {
      params: { organizationId, ...params },
    }),

  getDirective: (id: string, organizationId: string) =>
    api.get<Directive & { versions: DirectiveVersion[] }>(`/internal/hotline-ops/directives/${id}`, {
      params: { organizationId },
    }),

  createDirective: (data: {
    organizationId: string;
    stage: DirectiveStage;
    categoryId?: string;
    title: string;
    content: string;
    isReadAloud?: boolean;
  }) => api.post<Directive>('/internal/hotline-ops/directives', data),

  updateDirective: (id: string, data: Partial<Directive>) =>
    api.patch<Directive>(`/internal/hotline-ops/directives/${id}`, data),

  deleteDirective: (id: string, organizationId: string) =>
    api.delete(`/internal/hotline-ops/directives/${id}`, { params: { organizationId } }),

  restoreVersion: (id: string, version: number) =>
    api.post(`/internal/hotline-ops/directives/${id}/restore-version`, { version }),

  reorderDirectives: (organizationId: string, ids: string[]) =>
    api.post('/internal/hotline-ops/directives/reorder', { organizationId, ids }),

  // QA Queue
  getQaQueue: (params: { organizationId: string; reviewerId?: string; status?: string; page?: number; limit?: number }) =>
    api.get<{ items: QaQueueItem[]; total: number }>('/internal/hotline-ops/qa-queue', { params }),

  bulkApprove: (riuIds: string[], organizationId: string, notes?: string) =>
    api.post<BulkActionResult>('/internal/hotline-ops/qa/bulk-approve', { riuIds, organizationId, notes }),

  bulkReject: (riuIds: string[], organizationId: string, reason: string, returnToOperator?: boolean) =>
    api.post<BulkActionResult>('/internal/hotline-ops/qa/bulk-reject', { riuIds, organizationId, reason, returnToOperator }),

  bulkReassign: (riuIds: string[], organizationId: string, newReviewerId: string, reason?: string) =>
    api.post<BulkActionResult>('/internal/hotline-ops/qa/bulk-reassign', { riuIds, organizationId, newReviewerId, reason }),

  // Case reassignment
  reassignCase: (caseId: string, organizationId: string, newAssigneeId: string, reason: string) =>
    api.post('/internal/hotline-ops/cases/reassign', { caseId, organizationId, newAssigneeId, reason }),
};
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>Hotline operations API service created</done>
</task>

<task type="auto">
  <name>Task 2: Create DirectiveEditor component</name>
  <files>apps/frontend/src/pages/internal/hotline/DirectiveEditor.tsx</files>
  <action>
Create DirectiveEditor with full CRUD and version history:

```typescript
import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { hotlineOpsApi, Directive, DirectiveStage, DirectiveVersion } from '@/services/internal/hotline-ops.api';
import { useImpersonation } from '@/hooks/useImpersonation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { Label } from '@/components/ui/label';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Plus, Edit2, Trash2, History, GripVertical, Volume2 } from 'lucide-react';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';

const STAGES: { id: DirectiveStage; label: string }[] = [
  { id: 'OPENING', label: 'Opening' },
  { id: 'INTAKE', label: 'Intake' },
  { id: 'CATEGORY_SPECIFIC', label: 'Category Specific' },
  { id: 'CLOSING', label: 'Closing' },
];

export function DirectiveEditor() {
  const { session } = useImpersonation();
  const queryClient = useQueryClient();
  const [selectedStage, setSelectedStage] = useState<DirectiveStage>('OPENING');
  const [editingDirective, setEditingDirective] = useState<Directive | null>(null);
  const [showVersionHistory, setShowVersionHistory] = useState(false);
  const [includeInactive, setIncludeInactive] = useState(false);

  const organizationId = session?.targetOrganizationId || '';

  const { data: directives } = useQuery({
    queryKey: ['directives', organizationId, includeInactive],
    queryFn: () => hotlineOpsApi.listDirectives(organizationId, { includeInactive }),
    enabled: !!organizationId,
  });

  const createMutation = useMutation({
    mutationFn: hotlineOpsApi.createDirective,
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['directives'] }),
  });

  const updateMutation = useMutation({
    mutationFn: ({ id, data }: { id: string; data: Partial<Directive> }) =>
      hotlineOpsApi.updateDirective(id, data),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['directives'] }),
  });

  const deleteMutation = useMutation({
    mutationFn: (id: string) => hotlineOpsApi.deleteDirective(id, organizationId),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['directives'] }),
  });

  const reorderMutation = useMutation({
    mutationFn: (ids: string[]) => hotlineOpsApi.reorderDirectives(organizationId, ids),
    onSuccess: () => queryClient.invalidateQueries({ queryKey: ['directives'] }),
  });

  const handleDragEnd = (result: any) => {
    if (!result.destination || !directives) return;

    const stageDirectives = [...(directives[selectedStage] || [])];
    const [removed] = stageDirectives.splice(result.source.index, 1);
    stageDirectives.splice(result.destination.index, 0, removed);

    reorderMutation.mutate(stageDirectives.map((d) => d.id));
  };

  const currentDirectives = directives?.[selectedStage] || [];

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h2 className="text-xl font-semibold">Directive Management</h2>
          <p className="text-gray-500">
            {session?.targetOrganizationName || 'Select a tenant to manage directives'}
          </p>
        </div>
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2">
            <Switch
              id="inactive"
              checked={includeInactive}
              onCheckedChange={setIncludeInactive}
            />
            <Label htmlFor="inactive">Show inactive</Label>
          </div>
          <CreateDirectiveDialog
            organizationId={organizationId}
            stage={selectedStage}
            onCreate={(data) => createMutation.mutate(data)}
          />
        </div>
      </div>

      {/* Stage Tabs */}
      <Tabs value={selectedStage} onValueChange={(v) => setSelectedStage(v as DirectiveStage)}>
        <TabsList>
          {STAGES.map((stage) => (
            <TabsTrigger key={stage.id} value={stage.id}>
              {stage.label}
              <Badge variant="secondary" className="ml-2">
                {directives?.[stage.id]?.length || 0}
              </Badge>
            </TabsTrigger>
          ))}
        </TabsList>

        <TabsContent value={selectedStage} className="mt-4">
          <DragDropContext onDragEnd={handleDragEnd}>
            <Droppable droppableId="directives">
              {(provided) => (
                <div {...provided.droppableProps} ref={provided.innerRef} className="space-y-2">
                  {currentDirectives.map((directive, index) => (
                    <Draggable key={directive.id} draggableId={directive.id} index={index}>
                      {(provided) => (
                        <Card
                          ref={provided.innerRef}
                          {...provided.draggableProps}
                          className={!directive.isActive ? 'opacity-50' : ''}
                        >
                          <CardContent className="p-4 flex items-start gap-4">
                            <div {...provided.dragHandleProps} className="pt-1 cursor-grab">
                              <GripVertical className="h-5 w-5 text-gray-400" />
                            </div>

                            <div className="flex-1 space-y-2">
                              <div className="flex items-center gap-2">
                                <h3 className="font-medium">{directive.title}</h3>
                                {directive.isReadAloud && (
                                  <Badge variant="outline" className="flex items-center gap-1">
                                    <Volume2 className="h-3 w-3" />
                                    Read Aloud
                                  </Badge>
                                )}
                                {directive.categoryName && (
                                  <Badge variant="secondary">{directive.categoryName}</Badge>
                                )}
                                <Badge variant="outline">v{directive.version}</Badge>
                              </div>
                              <p className="text-sm text-gray-600 whitespace-pre-wrap">
                                {directive.content}
                              </p>
                            </div>

                            <div className="flex items-center gap-2">
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => setEditingDirective(directive)}
                              >
                                <Edit2 className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => {
                                  setEditingDirective(directive);
                                  setShowVersionHistory(true);
                                }}
                              >
                                <History className="h-4 w-4" />
                              </Button>
                              <Button
                                variant="ghost"
                                size="icon"
                                onClick={() => deleteMutation.mutate(directive.id)}
                              >
                                <Trash2 className="h-4 w-4 text-red-500" />
                              </Button>
                            </div>
                          </CardContent>
                        </Card>
                      )}
                    </Draggable>
                  ))}
                  {provided.placeholder}
                </div>
              )}
            </Droppable>
          </DragDropContext>

          {currentDirectives.length === 0 && (
            <div className="text-center py-8 text-gray-500">
              No directives for this stage
            </div>
          )}
        </TabsContent>
      </Tabs>

      {/* Edit Dialog */}
      {editingDirective && !showVersionHistory && (
        <EditDirectiveDialog
          directive={editingDirective}
          onSave={(data) => updateMutation.mutate({ id: editingDirective.id, data })}
          onClose={() => setEditingDirective(null)}
        />
      )}

      {/* Version History Dialog */}
      {editingDirective && showVersionHistory && (
        <VersionHistoryDialog
          directiveId={editingDirective.id}
          organizationId={organizationId}
          onClose={() => {
            setEditingDirective(null);
            setShowVersionHistory(false);
          }}
        />
      )}
    </div>
  );
}

// Helper components: CreateDirectiveDialog, EditDirectiveDialog, VersionHistoryDialog
// Implement as separate Dialog components with appropriate forms
```
  </action>
  <verify>npx tsc --noEmit compiles without errors</verify>
  <done>DirectiveEditor with drag-drop reordering and version history created</done>
</task>

<task type="auto">
  <name>Task 3: Create BulkQaDashboard and CaseReassignment components</name>
  <files>
    apps/frontend/src/pages/internal/hotline/BulkQaDashboard.tsx
    apps/frontend/src/pages/internal/hotline/CaseReassignment.tsx
    apps/frontend/src/pages/internal/hotline/HotlineOpsPage.tsx
  </files>
  <action>
**pages/internal/hotline/BulkQaDashboard.tsx:**
- QA queue table with multi-select checkboxes
- Filter by reviewer, status, severity
- Bulk action bar: Approve All, Reject All, Reassign
- Confirmation dialogs for bulk actions
- Progress indicator during bulk operations
- Result summary (success/failure counts)
- Group by reviewer view

**pages/internal/hotline/CaseReassignment.tsx:**
- Case search by reference number
- Current assignee display
- Assignee selector (dropdown with users)
- Reason text field (required)
- Confirmation and success feedback

**pages/internal/hotline/HotlineOpsPage.tsx:**
```typescript
import { useState } from 'react';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { useImpersonation } from '@/hooks/useImpersonation';
import { DirectiveEditor } from './DirectiveEditor';
import { BulkQaDashboard } from './BulkQaDashboard';
import { CaseReassignment } from './CaseReassignment';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { FileText, ClipboardCheck, UserCog } from 'lucide-react';

export function HotlineOpsPage() {
  const { isImpersonating, session } = useImpersonation();
  const [activeTab, setActiveTab] = useState('directives');

  if (!isImpersonating) {
    return (
      <div className="p-6">
        <Alert>
          <AlertDescription>
            Please start an impersonation session from the Support Console to manage hotline operations.
          </AlertDescription>
        </Alert>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Hotline Operations</h1>
        <p className="text-gray-500">
          Managing: {session?.targetOrganizationName}
        </p>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList>
          <TabsTrigger value="directives" className="flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Directives
          </TabsTrigger>
          <TabsTrigger value="qa-queue" className="flex items-center gap-2">
            <ClipboardCheck className="h-4 w-4" />
            QA Queue
          </TabsTrigger>
          <TabsTrigger value="reassignment" className="flex items-center gap-2">
            <UserCog className="h-4 w-4" />
            Case Reassignment
          </TabsTrigger>
        </TabsList>

        <TabsContent value="directives" className="mt-4">
          <DirectiveEditor />
        </TabsContent>

        <TabsContent value="qa-queue" className="mt-4">
          <BulkQaDashboard />
        </TabsContent>

        <TabsContent value="reassignment" className="mt-4">
          <CaseReassignment />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```
  </action>
  <verify>npm run lint passes; TypeScript compiles</verify>
  <done>BulkQaDashboard, CaseReassignment, and HotlineOpsPage created</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` from apps/frontend - TypeScript compiles
2. Run `npm run lint` - no lint errors
3. Verify directive drag-drop reordering works
4. Verify bulk QA actions show confirmation and results
5. Verify case reassignment requires reason
</verification>

<success_criteria>
- DirectiveEditor provides CRUD with drag-drop reordering and version history
- BulkQaDashboard shows QA queue with multi-select and bulk actions
- CaseReassignment allows transferring case ownership with audit
- HotlineOpsPage requires impersonation session to access
- All components use existing shadcn/ui patterns
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-14-SUMMARY.md`
</output>
