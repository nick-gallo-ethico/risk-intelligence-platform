---
phase: 12-internal-operations-portal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/operations/impersonation/impersonation.service.ts
  - apps/backend/src/modules/operations/impersonation/impersonation.guard.ts
  - apps/backend/src/modules/operations/impersonation/impersonation.middleware.ts
  - apps/backend/src/modules/operations/impersonation/impersonation.controller.ts
  - apps/backend/src/modules/operations/impersonation/dto/impersonation.dto.ts
  - apps/backend/src/modules/operations/impersonation/types/impersonation.types.ts
  - apps/backend/src/modules/operations/impersonation/impersonation.module.ts
  - apps/backend/src/modules/operations/impersonation/index.ts
autonomous: true

must_haves:
  truths:
    - "Internal user can start impersonation session with reason and optional ticket ID"
    - "Impersonation session has 4-hour maximum duration"
    - "All actions during impersonation are logged to ImpersonationAuditLog"
    - "Session can be ended early by operator or expires automatically"
    - "Services can detect if currently impersonating via ImpersonationService"
  artifacts:
    - path: "apps/backend/src/modules/operations/impersonation/impersonation.service.ts"
      provides: "ImpersonationService with startSession, endSession, getEffectiveOrganizationId"
      exports: ["ImpersonationService"]
    - path: "apps/backend/src/modules/operations/impersonation/impersonation.guard.ts"
      provides: "ElevatedAccessGuard for cross-tenant endpoints"
      exports: ["ElevatedAccessGuard"]
    - path: "apps/backend/src/modules/operations/impersonation/impersonation.middleware.ts"
      provides: "Middleware that sets CLS context from session header"
      exports: ["ImpersonationMiddleware"]
  key_links:
    - from: "impersonation.middleware.ts"
      to: "ClsService"
      via: "cls.set('impersonation', context)"
      pattern: "cls\\.set.*impersonation"
    - from: "impersonation.service.ts"
      to: "prisma.impersonationSession"
      via: "Prisma client"
      pattern: "prisma\\.impersonationSession\\.(create|findUnique)"
---

<objective>
Create the cross-tenant access infrastructure that enables internal Ethico teams to securely access client accounts for support, implementation, and operations.

Purpose: Internal teams need to access client data for support tickets, implementation tasks, and operations management. This must be done with full audit trail and explicit session management per CONTEXT.md security requirements.

Output: ImpersonationSession and ImpersonationAuditLog Prisma models, ImpersonationService for session management, ElevatedAccessGuard for protected endpoints, ImpersonationMiddleware for CLS context overlay.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
@apps/backend/src/modules/audit/audit.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Prisma models for impersonation infrastructure</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models to schema.prisma:

1. **InternalRole enum**:
   - SUPPORT_TIER_1, SUPPORT_TIER_2, SUPPORT_ADMIN
   - IMPLEMENTATION_SPECIALIST, IMPLEMENTATION_MANAGER
   - CLIENT_SUCCESS
   - HOTLINE_OPERATOR, HOTLINE_SUPERVISOR
   - PLATFORM_ADMIN

2. **InternalUser model**:
   - id (String @id @default(uuid()))
   - email (String @unique)
   - firstName, lastName (String)
   - role (InternalRole)
   - isActive (Boolean @default(true))
   - lastLoginAt (DateTime?)
   - createdAt, updatedAt
   - Relation: impersonationSessions ImpersonationSession[]

3. **ImpersonationSession model**:
   - id (String @id @default(uuid()))
   - operatorUserId (String) - FK to InternalUser
   - operatorRole (InternalRole) - Denormalized for audit
   - targetOrganizationId (String) - FK to Organization
   - reason (String) - Required justification
   - ticketId (String?) - Optional support ticket reference
   - startedAt (DateTime @default(now()))
   - expiresAt (DateTime) - Max 4 hours from start
   - endedAt (DateTime?) - Null if still active
   - endedBy (String?) - User who ended session
   - Relations: operator InternalUser, targetOrganization Organization, auditLogs ImpersonationAuditLog[]
   - Indexes: operatorUserId, targetOrganizationId, (expiresAt, endedAt)

4. **ImpersonationAuditLog model**:
   - id (String @id @default(uuid()))
   - sessionId (String) - FK to ImpersonationSession
   - action (String) - e.g., VIEW_CASE, UPDATE_CONFIG, SEARCH_USERS
   - entityType (String?) - e.g., Case, User, Config
   - entityId (String?) - ID of affected entity
   - details (Json?) - Additional context
   - createdAt (DateTime @default(now()))
   - Relation: session ImpersonationSession
   - Index: sessionId, (sessionId, createdAt)

Run `npx prisma generate` after adding models. Do NOT run migrations - that happens during execution.
  </action>
  <verify>npx prisma validate passes without errors</verify>
  <done>InternalUser, ImpersonationSession, ImpersonationAuditLog models exist in schema.prisma with proper relations and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create ImpersonationService with session management</name>
  <files>
    apps/backend/src/modules/operations/impersonation/impersonation.service.ts
    apps/backend/src/modules/operations/impersonation/dto/impersonation.dto.ts
    apps/backend/src/modules/operations/impersonation/types/impersonation.types.ts
  </files>
  <action>
Create the impersonation service following the patterns from 12-RESEARCH.md:

**types/impersonation.types.ts:**
```typescript
export interface ImpersonationContext {
  sessionId: string;
  operatorUserId: string;
  operatorRole: string; // InternalRole
  targetOrganizationId: string;
  reason: string;
  ticketId?: string;
  expiresAt: Date;
}
```

**dto/impersonation.dto.ts:**
- StartSessionDto: targetOrganizationId (string), reason (string), ticketId (string optional)
- SessionResponseDto: id, operatorUserId, targetOrganizationId, reason, ticketId, startedAt, expiresAt, remainingSeconds

**impersonation.service.ts:**
1. Inject PrismaService, ClsService (from nestjs-cls), AuditService
2. **startSession(operatorUserId, dto):**
   - Validate operator exists and has permission to impersonate (canImpersonate helper)
   - Validate target organization exists
   - Create session with 4-hour expiration: `new Date(Date.now() + 4 * 60 * 60 * 1000)`
   - Log SESSION_STARTED via logImpersonationAction
   - Return session with calculated remainingSeconds

3. **endSession(sessionId, endedByUserId):**
   - Validate session exists and not already ended
   - Update session with endedAt and endedBy
   - Log SESSION_ENDED

4. **validateSession(sessionId):**
   - Find session by ID
   - Return null if endedAt is set or expiresAt < now
   - Return session if valid

5. **getEffectiveOrganizationId():**
   - Get impersonation context from CLS
   - If valid impersonation, return targetOrganizationId
   - Otherwise return normal organizationId from CLS

6. **isImpersonating():**
   - Check if valid impersonation context exists in CLS

7. **getCurrentSessionId():**
   - Return sessionId from CLS context or null

8. **logImpersonationAction(sessionId, action, entityType, entityId, details?):**
   - Create ImpersonationAuditLog entry
   - Called by middleware/guards for automatic logging

9. **canImpersonate(role: InternalRole):**
   - Returns true for: SUPPORT_TIER_2, SUPPORT_ADMIN, IMPLEMENTATION_SPECIALIST, IMPLEMENTATION_MANAGER, PLATFORM_ADMIN
   - Returns false for: SUPPORT_TIER_1, CLIENT_SUCCESS, HOTLINE_OPERATOR, HOTLINE_SUPERVISOR

10. **getActiveSessions(operatorUserId):**
    - Return all sessions where operatorUserId matches and endedAt is null and expiresAt > now
  </action>
  <verify>File compiles with `npx tsc --noEmit` from apps/backend</verify>
  <done>ImpersonationService handles session lifecycle with audit logging and CLS integration</done>
</task>

<task type="auto">
  <name>Task 3: Create ImpersonationMiddleware and ElevatedAccessGuard</name>
  <files>
    apps/backend/src/modules/operations/impersonation/impersonation.middleware.ts
    apps/backend/src/modules/operations/impersonation/impersonation.guard.ts
    apps/backend/src/modules/operations/impersonation/impersonation.controller.ts
    apps/backend/src/modules/operations/impersonation/impersonation.module.ts
    apps/backend/src/modules/operations/impersonation/index.ts
  </files>
  <action>
**impersonation.middleware.ts:**
- Implement NestMiddleware
- Extract session ID from X-Impersonation-Session header
- If present, validate session via ImpersonationService.validateSession()
- If valid:
  - Set impersonation context in CLS: `this.cls.set('impersonation', context)`
  - Override RLS tenant context: `SET LOCAL app.current_tenant = targetOrganizationId`
  - Set X-Impersonation-Remaining response header with remaining seconds
- If invalid, clear any existing impersonation context

**impersonation.guard.ts:**
- Create ElevatedAccessGuard implementing CanActivate
- Check if request has valid impersonation session
- Throw ForbiddenException if no session or invalid session
- Used on cross-tenant endpoints that REQUIRE impersonation

**impersonation.controller.ts:**
- @Controller('api/v1/internal/impersonation')
- Use InternalAuthGuard (to be created in 12-02) on all endpoints
- POST /sessions - startSession (body: StartSessionDto)
- GET /sessions/active - getActiveSessions for current operator
- GET /sessions/:id - getSession details including audit logs
- DELETE /sessions/:id - endSession

**impersonation.module.ts:**
- Import PrismaModule, ClsModule
- Provide ImpersonationService
- Export ImpersonationService, ElevatedAccessGuard, ImpersonationMiddleware

**index.ts:**
- Export all public APIs
  </action>
  <verify>npm run lint passes on new files</verify>
  <done>ImpersonationMiddleware sets CLS context, ElevatedAccessGuard protects cross-tenant endpoints, controller provides session management API</done>
</task>

</tasks>

<verification>
1. Run `npx prisma validate` - schema is valid
2. Run `npx tsc --noEmit` from apps/backend - TypeScript compiles
3. Run `npm run lint` - no lint errors in new files
4. Verify ImpersonationService is injectable and exported
5. Verify middleware reads X-Impersonation-Session header
6. Verify guard throws ForbiddenException when no session
</verification>

<success_criteria>
- InternalUser, ImpersonationSession, ImpersonationAuditLog models exist in Prisma schema
- ImpersonationService provides startSession, endSession, validateSession, logImpersonationAction
- ImpersonationMiddleware overlays CLS context from session header
- ElevatedAccessGuard can protect cross-tenant endpoints
- All session operations are logged to ImpersonationAuditLog
- Session max duration is 4 hours
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-01-SUMMARY.md`
</output>
