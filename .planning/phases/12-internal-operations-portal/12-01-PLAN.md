---
phase: 12-internal-operations-portal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/operations/operations.module.ts
  - apps/backend/src/modules/operations/entities/internal-user.entity.ts
  - apps/backend/src/modules/operations/entities/impersonation-session.entity.ts
  - apps/backend/src/modules/operations/entities/impersonation-audit-log.entity.ts
  - apps/backend/src/modules/operations/types/internal-roles.types.ts
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "InternalUser model exists separate from tenant User model"
    - "ImpersonationSession model tracks cross-tenant access"
    - "ImpersonationAuditLog captures all actions during impersonation"
    - "InternalRole enum defines support staff permission levels"
  artifacts:
    - path: "apps/backend/src/modules/operations/operations.module.ts"
      provides: "Operations module aggregating all internal ops submodules"
      min_lines: 20
    - path: "apps/backend/src/modules/operations/entities/internal-user.entity.ts"
      provides: "InternalUser Prisma model definition"
      contains: "model InternalUser"
    - path: "apps/backend/src/modules/operations/entities/impersonation-session.entity.ts"
      provides: "ImpersonationSession model with session tracking"
      contains: "model ImpersonationSession"
  key_links:
    - from: "apps/backend/src/app.module.ts"
      to: "OperationsModule"
      via: "imports array"
      pattern: "OperationsModule"
---

<objective>
Create the foundational database models and module structure for the Internal Operations Portal.

Purpose: Establish the data layer for cross-tenant operations, internal user management, and impersonation audit trails. This is the foundation for all Phase 12 features - Support Console, Implementation Portal, Hotline Ops, and Client Success.

Output: Prisma schema additions for InternalUser, ImpersonationSession, ImpersonationAuditLog models plus OperationsModule NestJS structure.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-internal-operations-portal/12-CONTEXT.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Internal User and Role Types</name>
  <files>
    apps/backend/src/modules/operations/types/internal-roles.types.ts
    apps/backend/src/modules/operations/entities/internal-user.entity.ts
  </files>
  <action>
Create the types and Prisma schema for internal Ethico staff:

**InternalRole enum** (types/internal-roles.types.ts):
```typescript
export enum InternalRole {
  SUPPORT_L1 = 'SUPPORT_L1',        // Basic support access
  SUPPORT_L2 = 'SUPPORT_L2',        // Advanced support with debug access
  SUPPORT_L3 = 'SUPPORT_L3',        // Full support with all capabilities
  IMPLEMENTATION = 'IMPLEMENTATION', // Implementation specialist
  HOTLINE_OPS = 'HOTLINE_OPS',      // Hotline operations (QA, directives)
  CLIENT_SUCCESS = 'CLIENT_SUCCESS', // CSM access to health metrics
  ADMIN = 'ADMIN',                  // Internal admin (full access)
}

export const ROLE_PERMISSIONS = {
  [InternalRole.SUPPORT_L1]: ['impersonate', 'view_config'],
  [InternalRole.SUPPORT_L2]: ['impersonate', 'view_config', 'view_errors', 'view_jobs'],
  [InternalRole.SUPPORT_L3]: ['impersonate', 'view_config', 'view_errors', 'view_jobs', 'modify_config'],
  [InternalRole.IMPLEMENTATION]: ['impersonate', 'view_config', 'manage_projects', 'run_migrations'],
  [InternalRole.HOTLINE_OPS]: ['view_global_qa', 'bulk_qa_actions', 'manage_directives', 'view_operator_status'],
  [InternalRole.CLIENT_SUCCESS]: ['view_health_scores', 'view_usage_metrics', 'view_benchmarks'],
  [InternalRole.ADMIN]: ['*'],
} as const;
```

**Prisma schema** (entities/internal-user.entity.ts - describes the schema to add):
```prisma
enum InternalRole {
  SUPPORT_L1
  SUPPORT_L2
  SUPPORT_L3
  IMPLEMENTATION
  HOTLINE_OPS
  CLIENT_SUCCESS
  ADMIN
}

model InternalUser {
  id            String       @id @default(uuid())
  email         String       @unique
  name          String
  role          InternalRole
  azureAdId     String?      @unique  // SSO via Azure AD
  isActive      Boolean      @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  impersonationSessions ImpersonationSession[]

  @@map("internal_users")
}
```

Add description comments explaining this is separate from tenant User model for SOC 2 isolation.
  </action>
  <verify>TypeScript compiles without errors: `cd apps/backend && npx tsc --noEmit`</verify>
  <done>InternalRole enum and InternalUser Prisma model defined with all role types from CONTEXT.md</done>
</task>

<task type="auto">
  <name>Task 2: Create Impersonation Session and Audit Models</name>
  <files>
    apps/backend/src/modules/operations/entities/impersonation-session.entity.ts
    apps/backend/src/modules/operations/entities/impersonation-audit-log.entity.ts
    apps/backend/prisma/schema.prisma
  </files>
  <action>
Add Prisma models for impersonation tracking with full audit trail:

**ImpersonationSession model** (in schema.prisma):
```prisma
model ImpersonationSession {
  id                   String       @id @default(uuid())
  operatorUserId       String       // FK to InternalUser
  operatorRole         InternalRole
  targetOrganizationId String       // FK to Organization being accessed
  reason               String       // Required reason for access
  ticketId             String?      // Optional support ticket reference
  startedAt            DateTime     @default(now())
  endedAt              DateTime?    // Null = still active
  expiresAt            DateTime     // Max session duration (4 hours)
  ipAddress            String?      // For audit trail
  userAgent            String?      // For audit trail

  // Relations
  operator             InternalUser @relation(fields: [operatorUserId], references: [id])
  organization         Organization @relation(fields: [targetOrganizationId], references: [id])
  auditLogs            ImpersonationAuditLog[]

  @@index([operatorUserId])
  @@index([targetOrganizationId])
  @@index([startedAt])
  @@map("impersonation_sessions")
}

model ImpersonationAuditLog {
  id          String   @id @default(uuid())
  sessionId   String   // FK to ImpersonationSession
  action      String   // Action performed (VIEW_CASE, UPDATE_USER, etc.)
  entityType  String?  // Entity type affected
  entityId    String?  // Entity ID affected
  details     Json?    // Additional details (changes made, etc.)
  createdAt   DateTime @default(now())

  // Relations
  session     ImpersonationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([action])
  @@index([createdAt])
  @@map("impersonation_audit_logs")
}
```

Add relation on Organization model:
```prisma
// In Organization model
impersonationSessions ImpersonationSession[]
```

Create entity definition files that mirror the schema for documentation and type exports.
  </action>
  <verify>Prisma validates: `cd apps/backend && npx prisma validate`</verify>
  <done>ImpersonationSession and ImpersonationAuditLog models in schema.prisma with proper indexes and relations</done>
</task>

<task type="auto">
  <name>Task 3: Create Operations Module Structure and Register</name>
  <files>
    apps/backend/src/modules/operations/operations.module.ts
    apps/backend/src/modules/operations/index.ts
    apps/backend/src/app.module.ts
  </files>
  <action>
Create the OperationsModule as the aggregator for all internal ops features:

**operations.module.ts:**
```typescript
/**
 * OperationsModule - Internal Operations Portal
 *
 * Aggregates all internal tooling for Ethico teams:
 * - Support Console (impersonation, debugging)
 * - Implementation Portal (onboarding, migrations)
 * - Hotline Operations (directive management, QA)
 * - Client Success (health metrics)
 *
 * This module is NOT tenant-scoped - it operates across tenants
 * with elevated permissions and full audit logging.
 *
 * Security: All endpoints require InternalUser authentication
 * and produce ImpersonationAuditLog entries.
 */
@Module({
  imports: [
    PrismaModule,
    AuditModule,
    // Sub-modules will be added in subsequent plans
  ],
  controllers: [],
  providers: [],
  exports: [],
})
export class OperationsModule {}
```

**index.ts** - export types and enums:
```typescript
export * from './types/internal-roles.types';
// More exports added as features are built
```

**Register in app.module.ts:**
Add OperationsModule to the imports array.

Run Prisma migrate to create the new tables:
```bash
cd apps/backend && npx prisma migrate dev --name add_internal_operations_models
```
  </action>
  <verify>
1. `cd apps/backend && npx prisma migrate dev --name add_internal_operations_models` succeeds
2. `cd apps/backend && npm run lint` passes
3. OperationsModule imported in app.module.ts
  </verify>
  <done>OperationsModule registered in app.module.ts, Prisma migration applied, database has new tables</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npx prisma validate` - Schema is valid
2. `cd apps/backend && npx prisma migrate dev` - Migration applies cleanly
3. `cd apps/backend && npx tsc --noEmit` - TypeScript compiles
4. `cd apps/backend && npm run lint` - No linting errors
5. Tables exist in database: internal_users, impersonation_sessions, impersonation_audit_logs
</verification>

<success_criteria>
- InternalUser model exists with InternalRole enum (7 role types)
- ImpersonationSession model tracks session with operator, target org, reason, ticket
- ImpersonationAuditLog captures action, entityType, entityId, details per session action
- OperationsModule registered in app.module.ts
- Prisma migration applied successfully
- All types exported from operations/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-01-SUMMARY.md`
</output>
