---
phase: 12-internal-operations-portal
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/operations/entities/certification-track.entity.ts
  - apps/backend/src/modules/operations/entities/course.entity.ts
  - apps/backend/src/modules/operations/entities/quiz.entity.ts
  - apps/backend/src/modules/operations/entities/certificate.entity.ts
  - apps/backend/src/modules/operations/entities/user-certification.entity.ts
  - apps/backend/src/modules/operations/types/certification.types.ts
  - apps/backend/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Certification tracks are modular with required and optional courses"
    - "Courses have short video/text content plus quizzes"
    - "Quizzes require 80% to pass per CONTEXT.md"
    - "Certificates can be generated as PDFs with expiration tracking"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Certification system models"
      contains: "model CertificationTrack"
    - path: "apps/backend/src/modules/operations/types/certification.types.ts"
      provides: "Certification enums and types"
      exports: ["CertificationLevel", "CourseType", "QuizStatus"]
  key_links:
    - from: "UserCertification"
      to: "CertificationTrack"
      via: "trackId FK"
      pattern: "trackId.*String"
---

<objective>
Create database models for the full certification system.

Purpose: Enable modular training with Platform Fundamentals (required) and specialty tracks (optional). Per CONTEXT.md: short courses + quizzes, 80% to pass, PDF certificates, expiration tracking for major versions.

Output: Prisma schema for CertificationTrack, Course, Quiz, QuizAttempt, Certificate, UserCertification models.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-internal-operations-portal/12-CONTEXT.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Certification Types and Enums</name>
  <files>
    apps/backend/src/modules/operations/types/certification.types.ts
  </files>
  <action>
Define certification system types per CONTEXT.md:

```typescript
/**
 * Certification System Types
 *
 * Per CONTEXT.md:
 * - Modular: Platform Fundamentals required, specialty tracks optional
 * - Short courses + quizzes
 * - 80% to pass
 * - PDF certificates
 * - Expiration tracking for major versions
 */

export enum CertificationLevel {
  FOUNDATION = 'FOUNDATION',   // Platform Fundamentals (required)
  INTERMEDIATE = 'INTERMEDIATE',
  ADVANCED = 'ADVANCED',
}

export enum CourseType {
  VIDEO = 'VIDEO',
  TEXT = 'TEXT',
  INTERACTIVE = 'INTERACTIVE',
}

export enum QuizStatus {
  NOT_STARTED = 'NOT_STARTED',
  IN_PROGRESS = 'IN_PROGRESS',
  PASSED = 'PASSED',
  FAILED = 'FAILED',
}

export enum CertificateStatus {
  ACTIVE = 'ACTIVE',
  EXPIRED = 'EXPIRED',
  REVOKED = 'REVOKED',
}

// Track types per CONTEXT.md
export enum TrackType {
  PLATFORM_FUNDAMENTALS = 'PLATFORM_FUNDAMENTALS', // Required for all
  CASE_MANAGEMENT = 'CASE_MANAGEMENT',
  CAMPAIGNS_DISCLOSURES = 'CAMPAIGNS_DISCLOSURES',
  POLICY_MANAGEMENT = 'POLICY_MANAGEMENT',
  ANALYTICS_REPORTING = 'ANALYTICS_REPORTING',
  ADMIN_CONFIGURATION = 'ADMIN_CONFIGURATION',
}

// Pass threshold per CONTEXT.md
export const QUIZ_PASS_THRESHOLD = 0.80; // 80%

// Certificate PDF template data
export interface CertificateData {
  recipientName: string;
  trackName: string;
  completedDate: Date;
  expiresDate?: Date;
  certificateId: string;
  organizationName?: string; // For client certifications
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/backend && npx tsc --noEmit`</verify>
  <done>Certification types with track types, course types, pass threshold</done>
</task>

<task type="auto">
  <name>Task 2: Create Track, Course, and Quiz Models</name>
  <files>
    apps/backend/src/modules/operations/entities/certification-track.entity.ts
    apps/backend/src/modules/operations/entities/course.entity.ts
    apps/backend/src/modules/operations/entities/quiz.entity.ts
    apps/backend/prisma/schema.prisma
  </files>
  <action>
Add Prisma models for certification content:

**CertificationTrack model:**
```prisma
enum CertificationLevel {
  FOUNDATION
  INTERMEDIATE
  ADVANCED
}

enum TrackType {
  PLATFORM_FUNDAMENTALS
  CASE_MANAGEMENT
  CAMPAIGNS_DISCLOSURES
  POLICY_MANAGEMENT
  ANALYTICS_REPORTING
  ADMIN_CONFIGURATION
}

model CertificationTrack {
  id              String             @id @default(uuid())
  name            String
  slug            String             @unique
  description     String?
  type            TrackType
  level           CertificationLevel
  isRequired      Boolean            @default(false) // Platform Fundamentals = true

  // Versioning for expiration tracking
  version         String             @default("1.0")
  versionMajor    Int                @default(1)

  // Timing
  estimatedMinutes Int               @default(30)

  // Ordering
  sortOrder       Int                @default(0)
  isActive        Boolean            @default(true)

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  // Relations
  courses         Course[]
  userCertifications UserCertification[]

  @@map("certification_tracks")
}

model Course {
  id              String   @id @default(uuid())
  trackId         String   // FK to CertificationTrack
  title           String
  description     String?
  type            CourseType
  contentUrl      String?  // Video URL or content path
  contentHtml     String?  // For TEXT type

  // Timing
  estimatedMinutes Int     @default(10)

  // Ordering within track
  sortOrder       Int      @default(0)
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  track           CertificationTrack @relation(fields: [trackId], references: [id], onDelete: Cascade)
  quiz            Quiz?

  @@index([trackId])
  @@map("courses")
}

enum CourseType {
  VIDEO
  TEXT
  INTERACTIVE
}

model Quiz {
  id              String   @id @default(uuid())
  courseId        String   @unique // One quiz per course
  title           String
  passingScore    Float    @default(0.80) // 80% per CONTEXT.md

  // Questions stored as JSON for flexibility
  questions       Json     // Array of QuizQuestion

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attempts        QuizAttempt[]

  @@map("quizzes")
}

// QuizQuestion type (stored in JSON):
// {
//   id: string,
//   question: string,
//   type: 'MULTIPLE_CHOICE' | 'TRUE_FALSE' | 'MULTI_SELECT',
//   options: { id: string, text: string }[],
//   correctOptionIds: string[],
//   explanation?: string
// }
```
  </action>
  <verify>Prisma validates: `cd apps/backend && npx prisma validate`</verify>
  <done>CertificationTrack, Course, Quiz models with versioning and pass threshold</done>
</task>

<task type="auto">
  <name>Task 3: Create User Certification and Quiz Attempt Models</name>
  <files>
    apps/backend/src/modules/operations/entities/user-certification.entity.ts
    apps/backend/src/modules/operations/entities/certificate.entity.ts
    apps/backend/prisma/schema.prisma
  </files>
  <action>
Add models for user progress and certificates:

**QuizAttempt model:**
```prisma
enum QuizStatus {
  NOT_STARTED
  IN_PROGRESS
  PASSED
  FAILED
}

model QuizAttempt {
  id              String     @id @default(uuid())
  quizId          String     // FK to Quiz
  userId          String     // FK to User (tenant user) or InternalUser

  // For internal users (Ethico staff)
  internalUserId  String?    // FK to InternalUser if internal

  // Attempt details
  startedAt       DateTime   @default(now())
  completedAt     DateTime?
  status          QuizStatus @default(IN_PROGRESS)

  // Results
  score           Float?     // 0.0 to 1.0
  answers         Json?      // User's answers for review

  // Relations
  quiz            Quiz       @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
  @@index([userId])
  @@index([internalUserId])
  @@map("quiz_attempts")
}
```

**UserCertification model** (progress per track):
```prisma
model UserCertification {
  id              String   @id @default(uuid())
  trackId         String   // FK to CertificationTrack
  userId          String?  // FK to User (tenant user)
  internalUserId  String?  // FK to InternalUser (Ethico staff)

  // Progress
  startedAt       DateTime @default(now())
  completedAt     DateTime?
  completedVersion String? // Track version when completed

  // Certificate
  certificateId   String?  // FK to Certificate when issued
  expiresAt       DateTime? // Based on major version

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  track           CertificationTrack @relation(fields: [trackId], references: [id])
  certificate     Certificate? @relation(fields: [certificateId], references: [id])

  @@unique([trackId, userId])
  @@unique([trackId, internalUserId])
  @@index([userId])
  @@index([internalUserId])
  @@map("user_certifications")
}
```

**Certificate model** (PDF generation):
```prisma
enum CertificateStatus {
  ACTIVE
  EXPIRED
  REVOKED
}

model Certificate {
  id              String            @id @default(uuid())
  certificateNumber String          @unique // Human-readable: CERT-2026-00001
  recipientName   String
  trackName       String
  trackVersion    String

  issuedAt        DateTime          @default(now())
  expiresAt       DateTime?         // For major version expiration
  status          CertificateStatus @default(ACTIVE)

  // PDF storage
  pdfUrl          String?           // URL to generated PDF

  // Organization (for client certifications)
  organizationId  String?           // If certifying client user
  organizationName String?

  // Relations
  userCertification UserCertification[]

  @@index([status])
  @@map("certificates")
}
```

Run migration:
```bash
cd apps/backend && npx prisma migrate dev --name add_certification_models
```
  </action>
  <verify>
1. `cd apps/backend && npx prisma migrate dev --name add_certification_models` succeeds
2. `cd apps/backend && npm run lint` passes
  </verify>
  <done>QuizAttempt, UserCertification, Certificate models with version tracking and expiration</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npx prisma validate` - Schema is valid
2. `cd apps/backend && npx prisma migrate dev` - Migration applies cleanly
3. `cd apps/backend && npx tsc --noEmit` - TypeScript compiles
4. Tables exist: certification_tracks, courses, quizzes, quiz_attempts, user_certifications, certificates
</verification>

<success_criteria>
- CertificationTrack has type (Platform Fundamentals required), level, version
- Course belongs to track with type (VIDEO/TEXT/INTERACTIVE)
- Quiz has passingScore (default 0.80 per CONTEXT.md) and JSON questions
- QuizAttempt tracks progress for both tenant users and internal users
- UserCertification tracks completion per track with version
- Certificate generates unique certificate number with optional expiration
- All types exported from types/certification.types.ts
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-04-SUMMARY.md`
</output>
