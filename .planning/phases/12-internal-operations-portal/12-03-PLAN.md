---
phase: 12-internal-operations-portal
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/operations/entities/tenant-health-score.entity.ts
  - apps/backend/src/modules/operations/entities/usage-metric.entity.ts
  - apps/backend/src/modules/operations/entities/feature-adoption.entity.ts
  - apps/backend/src/modules/operations/entities/peer-benchmark.entity.ts
  - apps/backend/src/modules/operations/types/health-metrics.types.ts
  - apps/backend/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "TenantHealthScore uses blended scoring (usage + outcome metrics)"
    - "Health scores have component breakdown (login, case resolution, campaigns, features, tickets)"
    - "FeatureAdoption tracks binary flags per tenant per feature"
    - "PeerBenchmark stores nightly aggregates for comparison"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Health metrics models"
      contains: "model TenantHealthScore"
    - path: "apps/backend/src/modules/operations/types/health-metrics.types.ts"
      provides: "Health scoring weights and risk levels"
      exports: ["HEALTH_WEIGHTS", "RiskLevel", "HealthTrend"]
  key_links:
    - from: "TenantHealthScore"
      to: "Organization"
      via: "organizationId FK"
      pattern: "organizationId.*String"
---

<objective>
Create database models for client health metrics with peer benchmarking.

Purpose: Enable Client Success team to monitor tenant health via blended scores (usage + outcome metrics) with traffic light indicators and peer comparison. Per CONTEXT.md: configurable alerts, percentile display, nightly cached aggregates.

Output: Prisma schema for TenantHealthScore, UsageMetric, FeatureAdoption, PeerBenchmark models.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-internal-operations-portal/12-CONTEXT.md
@.planning/phases/12-internal-operations-portal/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Health Metrics Types and Weights</name>
  <files>
    apps/backend/src/modules/operations/types/health-metrics.types.ts
  </files>
  <action>
Define health scoring types, weights, and constants per CONTEXT.md and RESEARCH.md:

```typescript
/**
 * Client Health Metrics Types
 *
 * Blended scoring approach per CONTEXT.md:
 * - Usage metrics: login frequency, feature adoption
 * - Outcome metrics: case resolution, SLA compliance, attestation rates
 *
 * Weight distribution (must sum to 1.0) per RESEARCH.md:
 * - Login: 20%
 * - Case Resolution: 25%
 * - Campaign Completion: 25%
 * - Feature Adoption: 15%
 * - Support Tickets: 15%
 */

export const HEALTH_WEIGHTS = {
  login: 0.20,
  caseResolution: 0.25,
  campaignCompletion: 0.25,
  featureAdoption: 0.15,
  supportTickets: 0.15,
} as const;

export enum RiskLevel {
  LOW = 'LOW',       // Score >= 70, stable or improving
  MEDIUM = 'MEDIUM', // Score 40-70 OR declining
  HIGH = 'HIGH',     // Score < 40 OR (score < 60 AND declining)
}

export enum HealthTrend {
  IMPROVING = 'IMPROVING', // Delta > +5
  STABLE = 'STABLE',       // Delta -5 to +5
  DECLINING = 'DECLINING', // Delta < -5
}

export enum AlertLevel {
  NONE = 'NONE',           // No alerts
  DASHBOARD_ONLY = 'DASHBOARD_ONLY', // Show on dashboard (SMB/PLG)
  PROACTIVE = 'PROACTIVE', // Proactive notification (high-touch)
}

// Features tracked for adoption (binary flags per CONTEXT.md)
export enum TrackedFeature {
  // Core
  HOTLINE_INTAKE = 'HOTLINE_INTAKE',
  WEB_INTAKE = 'WEB_INTAKE',
  CASE_MANAGEMENT = 'CASE_MANAGEMENT',
  INVESTIGATIONS = 'INVESTIGATIONS',

  // Advanced
  AI_ASSISTANT = 'AI_ASSISTANT',
  CUSTOM_WORKFLOWS = 'CUSTOM_WORKFLOWS',
  CUSTOM_DASHBOARDS = 'CUSTOM_DASHBOARDS',
  POLICY_MANAGEMENT = 'POLICY_MANAGEMENT',

  // Campaigns
  COI_CAMPAIGNS = 'COI_CAMPAIGNS',
  ATTESTATION_CAMPAIGNS = 'ATTESTATION_CAMPAIGNS',
  GIFT_DISCLOSURES = 'GIFT_DISCLOSURES',

  // Integrations
  SSO_ENABLED = 'SSO_ENABLED',
  HRIS_INTEGRATION = 'HRIS_INTEGRATION',
  API_USAGE = 'API_USAGE',
}

export interface HealthScoreComponents {
  loginScore: number;           // Active users / total users
  caseResolutionScore: number;  // On-time closures
  campaignCompletionScore: number; // Attestation rates
  featureAdoptionScore: number; // Features used / available
  supportTicketScore: number;   // Inverse of ticket volume
}

// Peer benchmark display per CONTEXT.md
export interface BenchmarkDisplay {
  yourValue: number;
  percentile: number;      // Your percentile rank
  p25: number;             // 25th percentile
  median: number;          // 50th percentile
  p75: number;             // 75th percentile
  peerCount: number;       // Number of peers (min 5 for privacy)
  filterDescription: string; // "all customers" or "Healthcare, 100-500 employees"
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/backend && npx tsc --noEmit`</verify>
  <done>Health metrics types with weights, risk levels, tracked features defined</done>
</task>

<task type="auto">
  <name>Task 2: Create TenantHealthScore and UsageMetric Models</name>
  <files>
    apps/backend/src/modules/operations/entities/tenant-health-score.entity.ts
    apps/backend/src/modules/operations/entities/usage-metric.entity.ts
    apps/backend/prisma/schema.prisma
  </files>
  <action>
Add Prisma models for health scoring:

**TenantHealthScore model:**
```prisma
enum RiskLevel {
  LOW
  MEDIUM
  HIGH
}

enum HealthTrend {
  IMPROVING
  STABLE
  DECLINING
}

enum AlertLevel {
  NONE
  DASHBOARD_ONLY
  PROACTIVE
}

model TenantHealthScore {
  id                      String       @id @default(uuid())
  organizationId          String       // FK to Organization
  calculatedAt            DateTime     @default(now())

  // Component scores (0-100 each)
  loginScore              Int
  caseResolutionScore     Int
  campaignCompletionScore Int
  featureAdoptionScore    Int
  supportTicketScore      Int

  // Overall (weighted average)
  overallScore            Int          // 0-100

  // Trend and risk
  trend                   HealthTrend
  riskLevel               RiskLevel
  previousScore           Int?         // For delta calculation

  // Alert configuration (per account, per CONTEXT.md)
  alertLevel              AlertLevel   @default(DASHBOARD_ONLY)

  // Relations
  organization            Organization @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([calculatedAt])
  @@map("tenant_health_scores")
}

model UsageMetric {
  id                String   @id @default(uuid())
  organizationId    String   // FK to Organization
  metricDate        DateTime // Date of the metric (daily granularity)

  // Login metrics
  activeUsers       Int      // Users who logged in
  totalUsers        Int      // Total enabled users

  // Case metrics
  casesCreated      Int
  casesClosed       Int
  casesOnTime       Int      // Closed within SLA
  casesOverdue      Int

  // Campaign metrics
  campaignsActive   Int
  assignmentsTotal  Int
  assignmentsCompleted Int

  // Support metrics (if tracked)
  supportTickets    Int      @default(0)

  createdAt         DateTime @default(now())

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, metricDate])
  @@index([organizationId])
  @@index([metricDate])
  @@map("usage_metrics")
}
```

Add relations to Organization model:
```prisma
// In Organization model
healthScores      TenantHealthScore[]
usageMetrics      UsageMetric[]
```
  </action>
  <verify>Prisma validates: `cd apps/backend && npx prisma validate`</verify>
  <done>TenantHealthScore with component breakdown and UsageMetric for daily stats</done>
</task>

<task type="auto">
  <name>Task 3: Create Feature Adoption and Peer Benchmark Models</name>
  <files>
    apps/backend/src/modules/operations/entities/feature-adoption.entity.ts
    apps/backend/src/modules/operations/entities/peer-benchmark.entity.ts
    apps/backend/prisma/schema.prisma
  </files>
  <action>
Add models for feature tracking and peer comparison:

**FeatureAdoption model** (binary flags per CONTEXT.md):
```prisma
model FeatureAdoption {
  id              String   @id @default(uuid())
  organizationId  String   // FK to Organization
  feature         String   // TrackedFeature enum value
  isAdopted       Boolean  @default(false)
  firstUsedAt     DateTime? // When feature was first used
  lastUsedAt      DateTime? // Most recent usage

  // Relations
  organization    Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, feature])
  @@index([organizationId])
  @@index([feature])
  @@map("feature_adoptions")
}
```

**PeerBenchmark model** (nightly cached aggregates per CONTEXT.md):
```prisma
model PeerBenchmark {
  id              String   @id @default(uuid())
  metricName      String   // e.g., "attestation_completion_rate"
  calculatedAt    DateTime @default(now())

  // Filter criteria (null = all customers)
  industrySector  String?  // Healthcare, Financial, etc.
  employeeMin     Int?     // Min employees for size filter
  employeeMax     Int?     // Max employees for size filter

  // Aggregates
  peerCount       Int      // Number of tenants in this cohort (min 5)
  p25             Float    // 25th percentile
  median          Float    // 50th percentile
  p75             Float    // 75th percentile
  mean            Float    // Average
  min             Float
  max             Float

  @@unique([metricName, industrySector, employeeMin, employeeMax, calculatedAt])
  @@index([metricName])
  @@index([calculatedAt])
  @@map("peer_benchmarks")
}
```

Add relation to Organization:
```prisma
// In Organization model
featureAdoptions  FeatureAdoption[]
```

Run migration:
```bash
cd apps/backend && npx prisma migrate dev --name add_health_metrics_models
```
  </action>
  <verify>
1. `cd apps/backend && npx prisma migrate dev --name add_health_metrics_models` succeeds
2. `cd apps/backend && npm run lint` passes
  </verify>
  <done>FeatureAdoption and PeerBenchmark models with proper indexes for filtering</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npx prisma validate` - Schema is valid
2. `cd apps/backend && npx prisma migrate dev` - Migration applies cleanly
3. `cd apps/backend && npx tsc --noEmit` - TypeScript compiles
4. Tables exist: tenant_health_scores, usage_metrics, feature_adoptions, peer_benchmarks
</verification>

<success_criteria>
- TenantHealthScore has 5 component scores plus overall, trend, risk level
- UsageMetric captures daily login, case, campaign, support stats
- FeatureAdoption tracks binary adoption per feature per tenant
- PeerBenchmark stores cached aggregates with industry/size filters (min 5 peers for privacy)
- HEALTH_WEIGHTS constant matches RESEARCH.md distribution
- All enums and types exported from types/health-metrics.types.ts
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-03-SUMMARY.md`
</output>
