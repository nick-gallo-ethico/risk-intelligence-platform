---
phase: 12-internal-operations-portal
plan: 19
type: execute
wave: 5
depends_on: []
files_modified:
  - apps/ops-console/vite.config.ts
  - apps/ops-console/src/app/layout.tsx
  - apps/ops-console/src/components/common/ErrorBoundary.tsx
  - apps/ops-console/src/components/common/SkeletonLoaders.tsx
  - apps/ops-console/src/styles/accessibility.css
  - apps/backend/prisma/seeds/acme-phase-12.ts
autonomous: false

must_haves:
  truths:
    - "Bundle splitting reduces initial load time"
    - "Error boundaries catch and display errors gracefully"
    - "WCAG 2.1 AA compliance for ops console"
    - "Demo data seeded for Phase 12 features"
  artifacts:
    - path: "apps/ops-console/src/components/common/ErrorBoundary.tsx"
      provides: "Error boundary with fallback UI"
      min_lines: 50
    - path: "apps/backend/prisma/seeds/acme-phase-12.ts"
      provides: "Demo data for internal operations"
      min_lines: 100
  key_links:
    - from: "ErrorBoundary"
      to: "All pages"
      via: "Component wrapping"
      pattern: "<ErrorBoundary>"
---

<objective>
Complete Phase 12 with frontend polish, demo data seeding, and final verification checkpoint.

Purpose: Ensure ops console is production-ready with proper error handling, accessibility, and demo data for all Phase 12 features.

Output: Error boundaries, accessibility styles, Acme Co. demo data for internal ops features, and final verification.
</objective>

<execution_context>
@.claude/agents/gsd-executor.md
@.claude/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/12-internal-operations-portal/12-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Error Boundaries and Accessibility Styles</name>
  <files>
    apps/ops-console/src/components/common/ErrorBoundary.tsx
    apps/ops-console/src/components/common/SkeletonLoaders.tsx
    apps/ops-console/src/styles/accessibility.css
  </files>
  <action>
Create error boundaries and accessibility improvements for ops console:

**components/common/ErrorBoundary.tsx:**
```tsx
'use client';

import { Component, ErrorInfo, ReactNode } from 'react';
import { AlertTriangle, RefreshCw, Home } from 'lucide-react';

interface ErrorBoundaryProps {
  children: ReactNode;
  fallback?: ReactNode;
  onError?: (error: Error, errorInfo: ErrorInfo) => void;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends Component<ErrorBoundaryProps, ErrorBoundaryState> {
  constructor(props: ErrorBoundaryProps) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): ErrorBoundaryState {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
    this.props.onError?.(error, errorInfo);

    // Report to error tracking (Sentry, etc.)
    if (typeof window !== 'undefined' && (window as any).Sentry) {
      (window as any).Sentry.captureException(error, { extra: errorInfo });
    }
  }

  handleReset = () => {
    this.setState({ hasError: false, error: null });
  };

  render() {
    if (this.state.hasError) {
      if (this.props.fallback) {
        return this.props.fallback;
      }

      return (
        <div className="min-h-[400px] flex items-center justify-center p-6">
          <div className="max-w-md w-full bg-white border rounded-lg p-8 text-center">
            <AlertTriangle className="h-12 w-12 text-red-500 mx-auto mb-4" />
            <h2 className="text-xl font-semibold mb-2">Something went wrong</h2>
            <p className="text-gray-600 mb-6">
              An unexpected error occurred. Please try again or contact support.
            </p>

            {process.env.NODE_ENV === 'development' && this.state.error && (
              <pre className="p-3 bg-red-50 rounded-lg text-sm text-red-800 overflow-auto max-h-32 mb-4 text-left">
                {this.state.error.message}
              </pre>
            )}

            <div className="flex justify-center gap-3">
              <button
                onClick={this.handleReset}
                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                <RefreshCw className="h-4 w-4" />
                Try Again
              </button>
              <a
                href="/"
                className="flex items-center gap-2 px-4 py-2 border rounded-lg hover:bg-gray-50"
              >
                <Home className="h-4 w-4" />
                Go Home
              </a>
            </div>
          </div>
        </div>
      );
    }

    return this.props.children;
  }
}

// HOC for easy wrapping
export function withErrorBoundary<P extends object>(
  Component: React.ComponentType<P>,
  errorBoundaryProps?: Omit<ErrorBoundaryProps, 'children'>
) {
  return function WrappedComponent(props: P) {
    return (
      <ErrorBoundary {...errorBoundaryProps}>
        <Component {...props} />
      </ErrorBoundary>
    );
  };
}
```

**components/common/SkeletonLoaders.tsx:**
```tsx
import { cn } from '@/lib/utils';

function Skeleton({ className, ...props }: React.HTMLAttributes<HTMLDivElement>) {
  return (
    <div
      className={cn('animate-pulse rounded-md bg-gray-200', className)}
      {...props}
    />
  );
}

export function PageSkeleton() {
  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center justify-between">
        <Skeleton className="h-8 w-48" />
        <Skeleton className="h-10 w-32" />
      </div>
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Skeleton className="h-24" />
        <Skeleton className="h-24" />
        <Skeleton className="h-24" />
        <Skeleton className="h-24" />
      </div>
      <Skeleton className="h-64 w-full" />
    </div>
  );
}

export function TableSkeleton({ rows = 5 }: { rows?: number }) {
  return (
    <div className="space-y-3">
      <div className="flex gap-4 pb-3 border-b">
        <Skeleton className="h-5 w-6" />
        <Skeleton className="h-5 w-32" />
        <Skeleton className="h-5 w-48" />
        <Skeleton className="h-5 w-24" />
        <Skeleton className="h-5 w-20" />
      </div>
      {Array.from({ length: rows }).map((_, i) => (
        <div key={i} className="flex gap-4 py-2">
          <Skeleton className="h-4 w-6" />
          <Skeleton className="h-4 w-32" />
          <Skeleton className="h-4 w-48" />
          <Skeleton className="h-4 w-24" />
          <Skeleton className="h-4 w-20" />
        </div>
      ))}
    </div>
  );
}

export function CardSkeleton() {
  return (
    <div className="border rounded-lg p-4 space-y-3">
      <Skeleton className="h-5 w-3/4" />
      <Skeleton className="h-4 w-full" />
      <Skeleton className="h-4 w-2/3" />
    </div>
  );
}

export function FormSkeleton({ fields = 4 }: { fields?: number }) {
  return (
    <div className="space-y-6">
      {Array.from({ length: fields }).map((_, i) => (
        <div key={i} className="space-y-2">
          <Skeleton className="h-4 w-24" />
          <Skeleton className="h-10 w-full" />
        </div>
      ))}
      <Skeleton className="h-10 w-32" />
    </div>
  );
}

export function DetailSkeleton() {
  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center gap-4">
        <Skeleton className="h-12 w-12 rounded-full" />
        <div className="space-y-2">
          <Skeleton className="h-6 w-48" />
          <Skeleton className="h-4 w-32" />
        </div>
      </div>
      <div className="grid grid-cols-2 gap-6">
        <Skeleton className="h-32" />
        <Skeleton className="h-32" />
      </div>
      <Skeleton className="h-48" />
    </div>
  );
}
```

**styles/accessibility.css:**
```css
/* Focus visible styles */
:focus-visible {
  outline: 2px solid hsl(var(--primary));
  outline-offset: 2px;
}

/* Skip link for keyboard navigation */
.skip-link {
  position: absolute;
  left: -9999px;
  z-index: 9999;
  padding: 1rem;
  background: white;
  border: 2px solid hsl(var(--primary));
  border-radius: 0.375rem;
}

.skip-link:focus {
  left: 1rem;
  top: 1rem;
}

/* Minimum touch target size (44x44px) */
.touch-target {
  min-width: 44px;
  min-height: 44px;
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Screen reader only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* High contrast mode */
@media (prefers-contrast: high) {
  button,
  a {
    border: 2px solid currentColor;
  }
}

/* Mobile responsive improvements */
@media (max-width: 768px) {
  /* Larger touch targets on mobile */
  button,
  [role='button'],
  input[type='checkbox'],
  input[type='radio'] {
    min-height: 44px;
  }

  /* Stack forms on mobile */
  .form-row {
    flex-direction: column;
  }

  /* Full-width buttons on mobile */
  .btn-mobile-full {
    width: 100%;
  }
}

/* Impersonation mode visual indicator */
.impersonation-active {
  border-left: 4px solid hsl(var(--warning));
}

.impersonation-active::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: hsl(var(--warning));
  z-index: 9999;
}
```
  </action>
  <verify>TypeScript compiles: `cd apps/ops-console && npx tsc --noEmit`</verify>
  <done>Error boundaries and accessibility styles for ops console</done>
</task>

<task type="auto">
  <name>Task 2: Create Demo Data Seed for Phase 12</name>
  <files>
    apps/backend/prisma/seeds/acme-phase-12.ts
  </files>
  <action>
Create Acme Co. demo data for Phase 12 internal operations:

**prisma/seeds/acme-phase-12.ts:**
```typescript
import { PrismaClient } from '@prisma/client';
import { addDays, subDays, subMonths } from 'date-fns';

const prisma = new PrismaClient();

export async function seedPhase12(acmeOrgId: string) {
  console.log('Seeding Phase 12: Internal Operations Portal...');

  // =====================================
  // 1. Internal Users
  // =====================================
  const internalUsers = await Promise.all([
    prisma.internalUser.create({
      data: {
        email: 'sarah.support@ethico.com',
        name: 'Sarah Support',
        role: 'SUPPORT_SPECIALIST',
        department: 'Support',
        isActive: true,
      },
    }),
    prisma.internalUser.create({
      data: {
        email: 'ian.implementation@ethico.com',
        name: 'Ian Implementation',
        role: 'IMPLEMENTATION_SPECIALIST',
        department: 'Implementation',
        isActive: true,
      },
    }),
    prisma.internalUser.create({
      data: {
        email: 'holly.hotline@ethico.com',
        name: 'Holly Hotline',
        role: 'HOTLINE_OPERATOR',
        department: 'Hotline Operations',
        isActive: true,
      },
    }),
    prisma.internalUser.create({
      data: {
        email: 'chris.csm@ethico.com',
        name: 'Chris CSM',
        role: 'CLIENT_SUCCESS_MANAGER',
        department: 'Client Success',
        isActive: true,
      },
    }),
  ]);

  const [sarahSupport, ianImpl, hollyHotline, chrisCSM] = internalUsers;

  // =====================================
  // 2. Impersonation Sessions (historical)
  // =====================================
  await prisma.impersonationSession.createMany({
    data: [
      {
        operatorId: sarahSupport.id,
        organizationId: acmeOrgId,
        reason: 'Investigating SSO login issue reported in ticket #4521',
        ticketId: '4521',
        startedAt: subDays(new Date(), 5),
        endedAt: subDays(new Date(), 5),
      },
      {
        operatorId: sarahSupport.id,
        organizationId: acmeOrgId,
        reason: 'Reviewing workflow configuration for case escalation',
        startedAt: subDays(new Date(), 2),
        endedAt: subDays(new Date(), 2),
      },
    ],
  });

  // =====================================
  // 3. Implementation Project
  // =====================================
  const implProject = await prisma.implementationProject.create({
    data: {
      organizationId: acmeOrgId,
      type: 'ENTERPRISE_FULL',
      status: 'IN_PROGRESS',
      currentPhase: 'CONFIGURATION',
      healthScore: 85,
      assignedToId: ianImpl.id,
      startDate: subMonths(new Date(), 2),
      targetGoLiveDate: addDays(new Date(), 30),
    },
  });

  // Implementation tasks
  const taskTemplates = [
    { phase: 'DISCOVERY', name: 'Kickoff meeting', isRequired: true, completed: true },
    { phase: 'DISCOVERY', name: 'Requirements gathering', isRequired: true, completed: true },
    { phase: 'DISCOVERY', name: 'Technical assessment', isRequired: true, completed: true },
    { phase: 'CONFIGURATION', name: 'SSO setup', isRequired: true, completed: true },
    { phase: 'CONFIGURATION', name: 'User provisioning', isRequired: true, completed: true },
    { phase: 'CONFIGURATION', name: 'Workflow configuration', isRequired: true, completed: false },
    { phase: 'CONFIGURATION', name: 'Category setup', isRequired: true, completed: false },
    { phase: 'DATA_MIGRATION', name: 'Data mapping', isRequired: true, completed: false },
    { phase: 'DATA_MIGRATION', name: 'Test import', isRequired: true, completed: false },
    { phase: 'DATA_MIGRATION', name: 'Production import', isRequired: true, completed: false },
    { phase: 'UAT', name: 'User acceptance testing', isRequired: true, completed: false },
    { phase: 'GO_LIVE', name: 'Go-live preparation', isRequired: true, completed: false },
    { phase: 'OPTIMIZATION', name: 'Post-launch review', isRequired: false, completed: false },
  ];

  await Promise.all(
    taskTemplates.map((task, i) =>
      prisma.implementationTask.create({
        data: {
          projectId: implProject.id,
          name: task.name,
          phase: task.phase,
          isRequired: task.isRequired,
          status: task.completed ? 'COMPLETED' : 'PENDING',
          sortOrder: i + 1,
          completedAt: task.completed ? subDays(new Date(), 10 - i) : null,
        },
      })
    )
  );

  // Implementation blocker
  await prisma.implementationBlocker.create({
    data: {
      projectId: implProject.id,
      title: 'Waiting for SSO metadata from client IT',
      description: 'Client IT team has not provided SAML metadata file',
      category: 'CLIENT_SIDE',
      status: 'OPEN',
      createdAt: subDays(new Date(), 3),
    },
  });

  // =====================================
  // 4. Health Scores (30-day history)
  // =====================================
  for (let i = 30; i >= 0; i--) {
    const date = subDays(new Date(), i);
    const baseScore = 75 + Math.floor(Math.random() * 15);

    await prisma.tenantHealthScore.create({
      data: {
        organizationId: acmeOrgId,
        overallScore: baseScore,
        loginScore: baseScore + Math.floor(Math.random() * 10) - 5,
        caseResolutionScore: baseScore + Math.floor(Math.random() * 10) - 5,
        campaignCompletionScore: baseScore + Math.floor(Math.random() * 10) - 5,
        featureAdoptionScore: baseScore + Math.floor(Math.random() * 10) - 5,
        ticketVolumeScore: 100 - Math.floor(Math.random() * 20),
        calculatedAt: date,
      },
    });
  }

  // =====================================
  // 5. Feature Adoption
  // =====================================
  const features = [
    { key: 'case_management', name: 'Case Management', category: 'Core', adopted: true },
    { key: 'workflows', name: 'Workflows', category: 'Core', adopted: true },
    { key: 'campaigns', name: 'Campaigns', category: 'Core', adopted: true },
    { key: 'policies', name: 'Policy Management', category: 'Core', adopted: true },
    { key: 'ai_summaries', name: 'AI Summaries', category: 'Advanced', adopted: true },
    { key: 'ai_categorization', name: 'AI Categorization', category: 'Advanced', adopted: false },
    { key: 'custom_dashboards', name: 'Custom Dashboards', category: 'Advanced', adopted: false },
    { key: 'hris_sync', name: 'HRIS Integration', category: 'Integration', adopted: true },
    { key: 'sso', name: 'SSO', category: 'Integration', adopted: true },
    { key: 'board_reports', name: 'Board Reports', category: 'Reporting', adopted: false },
    { key: 'flat_export', name: 'Flat File Export', category: 'Reporting', adopted: true },
  ];

  await Promise.all(
    features.map((f) =>
      prisma.featureAdoption.create({
        data: {
          organizationId: acmeOrgId,
          featureKey: f.key,
          featureName: f.name,
          category: f.category,
          isAdopted: f.adopted,
          firstUsedAt: f.adopted ? subMonths(new Date(), Math.floor(Math.random() * 6)) : null,
          lastUsedAt: f.adopted ? subDays(new Date(), Math.floor(Math.random() * 7)) : null,
        },
      })
    )
  );

  // =====================================
  // 6. Certification Tracks and Courses
  // =====================================
  const platformFundamentalsTrack = await prisma.certificationTrack.create({
    data: {
      name: 'Platform Fundamentals',
      description: 'Core knowledge required for all Ethico users',
      type: 'REQUIRED',
      isActive: true,
      requiredForGoLive: true,
      estimatedHours: 2,
      passingScore: 80,
    },
  });

  const fundamentalsCourses = [
    { name: 'Introduction to Ethico', minutes: 15 },
    { name: 'Navigating the Dashboard', minutes: 20 },
    { name: 'Case Management Basics', minutes: 30 },
    { name: 'Campaign Management', minutes: 25 },
    { name: 'Reports and Analytics', minutes: 20 },
  ];

  await Promise.all(
    fundamentalsCourses.map((course, i) =>
      prisma.certificationCourse.create({
        data: {
          trackId: platformFundamentalsTrack.id,
          name: course.name,
          estimatedMinutes: course.minutes,
          contentType: 'VIDEO',
          sortOrder: i + 1,
          isRequired: true,
          hasQuiz: i === fundamentalsCourses.length - 1, // Only last course has quiz
        },
      })
    )
  );

  // Specialty track
  const investigatorTrack = await prisma.certificationTrack.create({
    data: {
      name: 'Investigator Certification',
      description: 'Advanced training for investigation leads',
      type: 'SPECIALTY',
      isActive: true,
      requiredForGoLive: false,
      estimatedHours: 4,
      passingScore: 80,
      prerequisiteId: platformFundamentalsTrack.id,
    },
  });

  // =====================================
  // 7. Go-Live Gates
  // =====================================
  const goLiveGates = [
    { name: 'Authentication configured', type: 'HARD', completed: true },
    { name: 'At least 1 admin trained', type: 'HARD', completed: true },
    { name: 'Terms & DPA signed', type: 'HARD', completed: true },
    { name: 'Primary contact designated', type: 'HARD', completed: true },
    { name: 'Data migration completed', type: 'SOFT', points: 15, completed: false },
    { name: 'Test workflow run', type: 'SOFT', points: 10, completed: true },
    { name: 'Users invited', type: 'SOFT', points: 10, completed: true },
    { name: 'Branding configured', type: 'SOFT', points: 5, completed: true },
    { name: 'Categories configured', type: 'SOFT', points: 10, completed: false },
    { name: 'HRIS integration enabled', type: 'SOFT', points: 10, completed: true },
    { name: 'First policy published', type: 'SOFT', points: 10, completed: false },
  ];

  await Promise.all(
    goLiveGates.map((gate, i) =>
      prisma.goLiveGate.create({
        data: {
          projectId: implProject.id,
          name: gate.name,
          gateType: gate.type as 'HARD' | 'SOFT',
          points: gate.points || null,
          isPassed: gate.completed,
          sortOrder: i + 1,
          passedAt: gate.completed ? subDays(new Date(), 10 - i) : null,
        },
      })
    )
  );

  // =====================================
  // 8. Peer Benchmarks (aggregated)
  // =====================================
  await prisma.peerBenchmark.create({
    data: {
      metricKey: 'attestation_completion',
      metricName: 'Attestation Completion Rate',
      sizeCategory: 'ENTERPRISE',
      industryCategory: 'GENERAL',
      p25: 72,
      median: 85,
      p75: 94,
      peerCount: 47,
      calculatedAt: new Date(),
    },
  });

  await prisma.peerBenchmark.create({
    data: {
      metricKey: 'case_resolution_days',
      metricName: 'Average Case Resolution (Days)',
      sizeCategory: 'ENTERPRISE',
      industryCategory: 'GENERAL',
      p25: 45,
      median: 32,
      p75: 21,
      peerCount: 47,
      calculatedAt: new Date(),
    },
  });

  console.log('Phase 12 seed complete!');
}

// Run directly if executed as script
if (require.main === module) {
  const ACME_ORG_ID = process.env.ACME_ORG_ID || 'acme-org-id';
  seedPhase12(ACME_ORG_ID)
    .then(() => prisma.$disconnect())
    .catch((e) => {
      console.error(e);
      prisma.$disconnect();
      process.exit(1);
    });
}
```
  </action>
  <verify>npm run seed:acme-phase-12 runs without errors</verify>
  <done>Demo data seeded for Phase 12 internal operations features</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 12: Internal Operations Portal including:
- Support Console with impersonation and tenant access
- Implementation Portal with project tracking and go-live readiness
- Hotline Operations with directive management and QA queue
- Client Success Dashboard with health metrics and benchmarks
- Training Portal with certification system
- Backend tech debt (WebSocket E2E, query optimization)
  </what-built>
  <how-to-verify>
1. **Support Console:**
   - Navigate to ops.localhost:3002/support
   - Search for "Acme" tenant
   - Start impersonation session (verify banner appears)
   - Check error logs, config, job queues visible
   - End session and verify audit logged

2. **Implementation Portal:**
   - Navigate to /implementation
   - Open Acme's implementation project
   - Verify checklist shows phases with completion status
   - Check blocker is displayed with escalation status
   - Navigate to Go-Live readiness page
   - Verify hard gates vs soft gates displayed correctly

3. **Hotline Operations:**
   - Navigate to /hotline
   - Check QA queue loads with items
   - Test bulk select and actions (approve, reject)
   - Open directive editor, create/edit a directive
   - Check operator status board

4. **Client Success:**
   - Navigate to /client-success
   - Verify health cards show traffic light colors
   - Click a client to see drill-down
   - Check usage metrics chart displays data
   - Navigate to benchmarks, verify 5-peer minimum enforced

5. **Training Portal:**
   - Navigate to /training
   - View course catalog with track types
   - Enroll in a track
   - Start a course and mark complete
   - Take exam, verify 80% pass threshold

6. **Demo Data:**
   - Verify Acme Co. has Phase 12 demo data
   - Implementation project with tasks and blocker
   - Health score history
   - Feature adoption records

7. **Tech Debt:**
   - Run `npm run test:e2e` - all tests pass
   - Check no N+1 queries in case list (enable query logging)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
### Demo Data Checkpoint
- [ ] InternalUser records created for support, implementation, hotline, CSM roles
- [ ] Impersonation session history for Acme Co
- [ ] Implementation project with phase-based tasks and blockers
- [ ] 30-day health score history
- [ ] Feature adoption records
- [ ] Certification tracks and courses
- [ ] Go-live gates with mix of passed/pending
- [ ] Peer benchmark aggregates
- [ ] npm run seed:acme-phase-12 (cumulative seed script)
</verification>

<success_criteria>
- Error boundaries catch errors in ops console gracefully
- Accessibility styles include focus visible, skip link, touch targets
- Demo data seeded for all Phase 12 features
- All Phase 12 plans executed successfully
- Final verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/12-internal-operations-portal/12-19-SUMMARY.md`
</output>
