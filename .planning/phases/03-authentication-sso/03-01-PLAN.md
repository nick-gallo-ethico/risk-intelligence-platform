---
phase: 03-authentication-sso
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/auth/interfaces/sso-user.interface.ts
  - apps/backend/src/modules/auth/interfaces/tenant-sso-config.interface.ts
  - apps/backend/src/modules/auth/interfaces/index.ts
autonomous: true

must_haves:
  truths:
    - "TenantDomain model stores email domains with verification status"
    - "TenantSsoConfig model stores per-tenant SSO provider configuration"
    - "User model has SSO-related fields for provider linking and MFA"
    - "RLS policies enforce tenant isolation on new tables"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "TenantDomain and TenantSsoConfig models with User SSO fields"
      contains: "model TenantDomain"
    - path: "apps/backend/src/modules/auth/interfaces/sso-user.interface.ts"
      provides: "SSO user data interface for provider callbacks"
      exports: ["SsoUserData", "SsoProvider"]
    - path: "apps/backend/src/modules/auth/interfaces/tenant-sso-config.interface.ts"
      provides: "TypeScript interfaces matching Prisma models"
      exports: ["TenantSsoConfigData"]
  key_links:
    - from: "TenantDomain"
      to: "Organization"
      via: "organizationId foreign key"
      pattern: "organizationId.*Organization"
    - from: "TenantSsoConfig"
      to: "Organization"
      via: "organizationId foreign key with unique constraint"
      pattern: "organizationId.*@unique"
---

<objective>
Add database models and TypeScript interfaces for enterprise SSO support.

Purpose: Create the foundational data structures that all SSO strategies, domain verification, and MFA features depend on. This establishes the TenantDomain model for email domain-to-tenant mapping and TenantSsoConfig for per-tenant SSO provider configuration.

Output: Prisma schema with TenantDomain, TenantSsoConfig models; User model extended with SSO and MFA fields; TypeScript interfaces for type safety.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-sso/03-RESEARCH.md
@apps/backend/prisma/schema.prisma
@apps/backend/src/modules/auth/interfaces/jwt-payload.interface.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TenantDomain and TenantSsoConfig models to Prisma schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models to the Prisma schema after the Session model:

1. **TenantDomain model** - Maps email domains to organizations for SSO tenant routing:
   - id: String @id @default(uuid())
   - organizationId: String @map("organization_id")
   - domain: String @unique (e.g., "acme.com")
   - verified: Boolean @default(false)
   - verifiedAt: DateTime? @map("verified_at")
   - verificationToken: String @map("verification_token")
   - verificationMethod: String @default("DNS_TXT") @map("verification_method")
   - isPrimary: Boolean @default(false) @map("is_primary")
   - createdAt: DateTime @default(now()) @map("created_at")
   - updatedAt: DateTime @updatedAt @map("updated_at")
   - Relation: organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
   - Indexes: [organizationId], [domain]
   - Map to: "tenant_domains"

2. **TenantSsoConfig model** - Per-tenant SSO provider configuration:
   - id: String @id @default(uuid())
   - organizationId: String @unique @map("organization_id")
   - ssoProvider: String? @map("sso_provider") // 'azure-ad', 'google', 'saml'
   - ssoEnabled: Boolean @default(false) @map("sso_enabled")
   - jitProvisioningEnabled: Boolean @default(true) @map("jit_provisioning_enabled")
   - defaultRole: UserRole @default(EMPLOYEE) @map("default_role")
   - azureTenantId: String? @map("azure_tenant_id")
   - samlIdpEntityId: String? @map("saml_idp_entity_id")
   - samlIdpEntryPoint: String? @map("saml_idp_entry_point")
   - samlIdpCertificate: String? @map("saml_idp_certificate") // PEM format
   - samlSpEntityId: String? @map("saml_sp_entity_id")
   - mfaRequired: Boolean @default(false) @map("mfa_required")
   - createdAt: DateTime @default(now()) @map("created_at")
   - updatedAt: DateTime @updatedAt @map("updated_at")
   - Relation: organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
   - Map to: "tenant_sso_configs"

3. **Add relations to Organization model**:
   - tenantDomains TenantDomain[]
   - tenantSsoConfig TenantSsoConfig?

4. **Add SSO and MFA fields to User model** (after lastLoginAt):
   - ssoProvider: String? @map("sso_provider") // 'azure-ad', 'google', 'saml'
   - ssoId: String? @map("sso_id") // Provider-specific unique ID
   - mfaEnabled: Boolean @default(false) @map("mfa_enabled")
   - mfaSecret: String? @map("mfa_secret") // TOTP secret (will be encrypted)
   - mfaVerifiedAt: DateTime? @map("mfa_verified_at")
   - mfaRecoveryCodes: String[] @default([]) @map("mfa_recovery_codes") // Hashed codes

5. **Add index to User model** for SSO lookups:
   - @@index([ssoProvider, ssoId])

Add doc comments explaining:
- TenantDomain: "Maps email domains to organizations for SSO tenant routing. Domains must be verified via DNS TXT record."
- TenantSsoConfig: "Stores per-tenant SSO provider configuration. One config per organization (unique constraint)."
  </action>
  <verify>
Run: `cd apps/backend && npx prisma validate`
Should output: "The schema at 'prisma/schema.prisma' is valid"
  </verify>
  <done>
Prisma schema contains TenantDomain and TenantSsoConfig models with proper relations, User model has SSO and MFA fields, schema validates successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript interfaces for SSO data types</name>
  <files>
apps/backend/src/modules/auth/interfaces/sso-user.interface.ts
apps/backend/src/modules/auth/interfaces/tenant-sso-config.interface.ts
apps/backend/src/modules/auth/interfaces/index.ts
  </files>
  <action>
1. Create `sso-user.interface.ts`:
```typescript
/**
 * SSO provider identifiers
 */
export type SsoProvider = 'azure-ad' | 'google' | 'saml';

/**
 * User data extracted from SSO provider callback.
 * Used by SsoService to find or create users during SSO flow.
 */
export interface SsoUserData {
  /** Email address (required for all providers) */
  email: string;

  /** First name from profile */
  firstName: string;

  /** Last name from profile */
  lastName: string;

  /** SSO provider type */
  provider: SsoProvider;

  /** Provider-specific unique ID (oid for Azure, sub for Google, nameID for SAML) */
  ssoId: string;

  /** Azure AD tenant ID (Azure only) */
  azureTenantId?: string;

  /** Profile picture URL (if provided) */
  avatarUrl?: string;

  /** Raw profile data from provider (for debugging/auditing) */
  rawProfile?: Record<string, unknown>;
}
```

2. Create `tenant-sso-config.interface.ts`:
```typescript
import { UserRole } from '@prisma/client';

/**
 * Domain verification methods supported
 */
export type DomainVerificationMethod = 'DNS_TXT' | 'META_TAG' | 'FILE';

/**
 * Domain verification status
 */
export interface TenantDomainData {
  id: string;
  organizationId: string;
  domain: string;
  verified: boolean;
  verifiedAt: Date | null;
  verificationToken: string;
  verificationMethod: DomainVerificationMethod;
  isPrimary: boolean;
}

/**
 * Per-tenant SSO configuration data
 */
export interface TenantSsoConfigData {
  id: string;
  organizationId: string;
  ssoProvider: string | null;
  ssoEnabled: boolean;
  jitProvisioningEnabled: boolean;
  defaultRole: UserRole;
  azureTenantId: string | null;
  samlIdpEntityId: string | null;
  samlIdpEntryPoint: string | null;
  samlIdpCertificate: string | null;
  samlSpEntityId: string | null;
  mfaRequired: boolean;
}

/**
 * SAML configuration subset for strategy initialization
 */
export interface SamlConfig {
  callbackUrl: string;
  entryPoint: string;
  issuer: string;
  cert: string;
  wantAssertionsSigned: boolean;
  wantAuthnResponseSigned: boolean;
  signatureAlgorithm: 'sha256' | 'sha512';
}
```

3. Update `index.ts` to export new interfaces:
```typescript
export * from './jwt-payload.interface';
export * from './sso-user.interface';
export * from './tenant-sso-config.interface';
```
  </action>
  <verify>
Run: `cd apps/backend && npx tsc --noEmit`
Should compile without errors related to the new interface files.
  </verify>
  <done>
TypeScript interfaces exist for SsoUserData, SsoProvider, TenantDomainData, TenantSsoConfigData, and SamlConfig. All types are exported from interfaces/index.ts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Generate Prisma client and run migration</name>
  <files>apps/backend/prisma/migrations/</files>
  <action>
1. Generate the Prisma client:
   `cd apps/backend && npx prisma generate`

2. Create the database migration:
   `cd apps/backend && npx prisma migrate dev --name add_sso_and_mfa_support`

3. Verify the migration was created successfully by checking that a new migration folder exists in `prisma/migrations/` with the expected changes.

Note: If running in CI/test environment without database access, use `npx prisma migrate deploy` instead, or skip migration and just verify schema with `npx prisma validate`.
  </action>
  <verify>
Run: `cd apps/backend && npx prisma generate && npx prisma db push --accept-data-loss`
(Use db push for development to apply schema changes)

Verify tables exist:
`cd apps/backend && npx prisma db execute --stdin <<< "SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' AND table_name IN ('tenant_domains', 'tenant_sso_configs');"`

Should show both tables exist.
  </verify>
  <done>
Prisma client is regenerated with new types. Database has tenant_domains and tenant_sso_configs tables. User table has new SSO and MFA columns.
  </done>
</task>

</tasks>

<verification>
1. Schema validates: `cd apps/backend && npx prisma validate`
2. TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
3. Prisma client includes new types: Check `node_modules/.prisma/client/index.d.ts` contains TenantDomain, TenantSsoConfig
4. Tests pass: `cd apps/backend && npm test`
</verification>

<success_criteria>
- TenantDomain model exists with domain, verification fields, and Organization relation
- TenantSsoConfig model exists with SSO provider fields and unique organizationId
- User model has ssoProvider, ssoId, mfaEnabled, mfaSecret, mfaVerifiedAt, mfaRecoveryCodes fields
- TypeScript interfaces provide type safety for SSO operations
- Prisma client regenerated and database schema applied
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-sso/03-01-SUMMARY.md`
</output>
