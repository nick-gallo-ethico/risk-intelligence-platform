---
phase: 03-authentication-sso
plan: 06
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - apps/backend/src/modules/auth/strategies/google.strategy.ts
  - apps/backend/src/modules/auth/auth.controller.ts
  - apps/backend/src/modules/auth/auth.module.ts
  - apps/backend/package.json
autonomous: true
user_setup:
  - service: google
    why: "Google OAuth requires project and OAuth credentials in Google Cloud Console"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create OAuth 2.0 credentials"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials -> OAuth client ID"
      - task: "Configure authorized redirect URI"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Your OAuth Client"
        details: "Add redirect URI: {API_URL}/api/v1/auth/google/callback"

must_haves:
  truths:
    - "User can initiate Google OAuth login from the application"
    - "Google callback validates user and issues JWT tokens"
    - "User is JIT provisioned if domain is verified and JIT enabled"
    - "Google Workspace domains route to correct tenant"
  artifacts:
    - path: "apps/backend/src/modules/auth/strategies/google.strategy.ts"
      provides: "Passport strategy for Google OAuth 2.0"
      exports: ["GoogleStrategy"]
    - path: "apps/backend/src/modules/auth/auth.controller.ts"
      provides: "Google OAuth login and callback endpoints"
      contains: "@UseGuards(AuthGuard('google'))"
  key_links:
    - from: "google.strategy.ts"
      to: "sso.service.ts"
      via: "findOrCreateSsoUser"
      pattern: "ssoService\\.findOrCreateSsoUser"
    - from: "auth.controller.ts"
      to: "google.strategy.ts"
      via: "AuthGuard('google')"
      pattern: "AuthGuard\\('google'\\)"
---

<objective>
Implement Google OAuth 2.0 SSO strategy with passport-google-oauth20.

Purpose: Enable users from organizations using Google Workspace to log in via single sign-on. Google OAuth is common for organizations using G Suite/Google Workspace. The strategy validates OAuth tokens from Google and uses SsoService for user lookup/provisioning based on verified domains.

Output: GoogleStrategy passport strategy, login initiation and callback endpoints, integration with existing auth flow.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-sso/03-RESEARCH.md
@.planning/phases/03-authentication-sso/03-04-SUMMARY.md
@apps/backend/src/modules/auth/sso/sso.service.ts
@apps/backend/src/modules/auth/strategies/azure-ad.strategy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install passport-google-oauth20 package</name>
  <files>apps/backend/package.json</files>
  <action>
Install the Google OAuth passport strategy:

```bash
cd apps/backend && npm install passport-google-oauth20 @types/passport-google-oauth20
```

passport-google-oauth20 is the official Passport.js strategy for Google OAuth 2.0 authentication.
  </action>
  <verify>
Run: `cd apps/backend && npm ls passport-google-oauth20`
Should show passport-google-oauth20 installed.
  </verify>
  <done>
passport-google-oauth20 and @types/passport-google-oauth20 packages installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GoogleStrategy</name>
  <files>apps/backend/src/modules/auth/strategies/google.strategy.ts</files>
  <action>
Create `strategies/google.strategy.ts`:

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { Strategy, Profile, VerifyCallback } from 'passport-google-oauth20';
import { ConfigService } from '@nestjs/config';
import { SsoService } from '../sso/sso.service';
import { SsoUserData } from '../interfaces';

/**
 * Google OAuth 2.0 Strategy for SSO.
 *
 * Supports Google Workspace (G Suite) domains for enterprise SSO.
 * Domain routing is handled by our domain verification system -
 * users with verified domains are routed to their organization.
 *
 * Required environment variables:
 * - GOOGLE_CLIENT_ID: OAuth 2.0 Client ID from Google Cloud Console
 * - GOOGLE_CLIENT_SECRET: OAuth 2.0 Client Secret from Google Cloud Console
 * - API_URL: Base URL for callback (e.g., https://api.ethico.com)
 */
@Injectable()
export class GoogleStrategy extends PassportStrategy(Strategy, 'google') {
  private readonly logger = new Logger(GoogleStrategy.name);

  constructor(
    private configService: ConfigService,
    private ssoService: SsoService,
  ) {
    const clientId = configService.get<string>('GOOGLE_CLIENT_ID');
    const clientSecret = configService.get<string>('GOOGLE_CLIENT_SECRET');
    const apiUrl = configService.get<string>('API_URL', 'http://localhost:3000');

    if (!clientId || !clientSecret) {
      throw new Error('Google OAuth configuration missing: GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET required');
    }

    super({
      clientID: clientId,
      clientSecret: clientSecret,
      callbackURL: `${apiUrl}/api/v1/auth/google/callback`,
      scope: ['email', 'profile', 'openid'],
    });
  }

  /**
   * Validate callback from Google OAuth.
   * Called by Passport after successful authentication with Google.
   *
   * @param accessToken - Google access token (not stored)
   * @param refreshToken - Google refresh token (not stored)
   * @param profile - User profile from Google
   * @param done - Passport callback
   */
  async validate(
    accessToken: string,
    refreshToken: string,
    profile: Profile,
    done: VerifyCallback,
  ): Promise<void> {
    try {
      const email = profile.emails?.[0]?.value;

      this.logger.log(`Google OAuth callback for user: ${email}`);

      if (!email) {
        this.logger.error('Google profile missing email');
        return done(new Error('Email not provided by Google'), null);
      }

      // Extract user data from Google profile
      const ssoUser: SsoUserData = {
        email: email.toLowerCase(),
        firstName: profile.name?.givenName || '',
        lastName: profile.name?.familyName || '',
        provider: 'google',
        ssoId: profile.id, // Google user ID - stable unique identifier
        avatarUrl: profile.photos?.[0]?.value,
        rawProfile: profile._json,
      };

      // Use SsoService for user lookup/creation
      const user = await this.ssoService.findOrCreateSsoUser(ssoUser);

      done(null, user);
    } catch (error) {
      this.logger.error(`Google OAuth validation error: ${error.message}`);
      done(error, null);
    }
  }
}
```
  </action>
  <verify>
Run: `cd apps/backend && npx tsc --noEmit`
Should compile without errors.
  </verify>
  <done>
GoogleStrategy extends PassportStrategy with Google OAuth Strategy, validates Google callbacks, extracts user data, and uses SsoService for JIT provisioning.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Google OAuth endpoints to AuthController and register strategy</name>
  <files>
apps/backend/src/modules/auth/auth.controller.ts
apps/backend/src/modules/auth/auth.module.ts
apps/backend/src/modules/auth/strategies/index.ts
  </files>
  <action>
1. Update `strategies/index.ts` to export GoogleStrategy:

```typescript
export * from './jwt.strategy';
export * from './azure-ad.strategy';
export * from './google.strategy';
```

2. Update `auth.module.ts` to include GoogleStrategy:

Add GoogleStrategy to providers array:

```typescript
import { JwtStrategy, AzureAdStrategy, GoogleStrategy } from './strategies';

// In @Module providers:
providers: [AuthService, JwtStrategy, AzureAdStrategy, GoogleStrategy],
```

3. Add Google OAuth endpoints to `auth.controller.ts`:

Add after Azure AD endpoints:

```typescript
/**
 * Initiate Google OAuth SSO login.
 * Redirects user to Google login page.
 */
@Get('google')
@UseGuards(AuthGuard('google'))
@Throttle({ default: { limit: 10, ttl: 60000 } })
@Public()
@ApiOperation({ summary: 'Initiate Google OAuth SSO login' })
@ApiResponse({ status: 302, description: 'Redirects to Google login' })
googleLogin(): void {
  // Passport handles the redirect to Google
  // This method body never executes
}

/**
 * Handle Google OAuth SSO callback.
 * Validates the authentication and issues JWT tokens.
 */
@Get('google/callback')
@UseGuards(AuthGuard('google'))
@Throttle({ default: { limit: 20, ttl: 60000 } })
@Public()
@ApiOperation({ summary: 'Google OAuth SSO callback' })
@ApiResponse({ status: 200, type: AuthResponseDto })
async googleCallback(
  @Req() req: Request,
  @Res({ passthrough: true }) res: Response,
): Promise<AuthResponseDto> {
  // User is already validated by GoogleStrategy
  const user = req.user as any;

  // Create session and generate JWT tokens using existing auth service
  const session = await this.authService.createSsoSession(
    user.id,
    user.organizationId,
    req.headers['user-agent'],
    req.ip,
  );

  const tokens = await this.authService.generateTokensForUser(user, session.id);

  return {
    ...tokens,
    user: {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      role: user.role,
      organizationId: user.organizationId,
    },
  };
}
```

Note: Google OAuth callback uses GET (not POST like Azure AD's form_post). The callback endpoint receives the authorization code in query params, which Passport exchanges for tokens automatically.
  </action>
  <verify>
Run: `cd apps/backend && npx tsc --noEmit && npm test`
TypeScript compiles and tests pass.
  </verify>
  <done>
GoogleStrategy registered in AuthModule. AuthController has /google (GET) for initiating login and /google/callback (GET) for handling callback. Both endpoints use AuthGuard('google').
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
2. Tests pass: `cd apps/backend && npm test`
3. Strategy registered: Check that GoogleStrategy is in AuthModule providers
4. Endpoints exist: Start server and verify /api/v1/auth/google exists
</verification>

<success_criteria>
- passport-google-oauth20 package installed
- GoogleStrategy validates Google OAuth tokens
- GET /api/v1/auth/google redirects to Google login
- GET /api/v1/auth/google/callback handles callback and issues JWT
- JIT provisioning works for users with verified domains
- Existing users are linked to Google on first login
- Google Workspace users routed to correct tenant via domain verification
- Rate limiting applied to SSO endpoints
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-sso/03-06-SUMMARY.md`
</output>
