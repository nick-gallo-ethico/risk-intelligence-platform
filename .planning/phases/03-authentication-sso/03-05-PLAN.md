---
phase: 03-authentication-sso
plan: 05
type: execute
wave: 3
depends_on: ["03-03", "03-04"]
files_modified:
  - apps/backend/src/modules/auth/strategies/azure-ad.strategy.ts
  - apps/backend/src/modules/auth/auth.controller.ts
  - apps/backend/src/modules/auth/auth.module.ts
  - apps/backend/package.json
autonomous: true
user_setup:
  - service: azure-ad
    why: "Azure AD OAuth requires app registration in Azure portal"
    env_vars:
      - name: AZURE_AD_CLIENT_ID
        source: "Azure Portal -> App registrations -> Your app -> Application (client) ID"
      - name: AZURE_AD_CLIENT_SECRET
        source: "Azure Portal -> App registrations -> Your app -> Certificates & secrets -> New client secret"
    dashboard_config:
      - task: "Register application in Azure AD"
        location: "Azure Portal -> Azure Active Directory -> App registrations"
      - task: "Configure redirect URI"
        location: "Azure Portal -> App registrations -> Your app -> Authentication -> Add platform -> Web"
        details: "Add redirect URI: {API_URL}/api/v1/auth/azure-ad/callback"

must_haves:
  truths:
    - "User can initiate Azure AD login from the application"
    - "Azure AD callback validates user and issues JWT tokens"
    - "User is JIT provisioned if domain is verified and JIT enabled"
    - "Existing users are linked to Azure AD on first SSO login"
  artifacts:
    - path: "apps/backend/src/modules/auth/strategies/azure-ad.strategy.ts"
      provides: "Passport strategy for Azure AD OIDC"
      exports: ["AzureAdStrategy"]
    - path: "apps/backend/src/modules/auth/auth.controller.ts"
      provides: "Azure AD login and callback endpoints"
      contains: "@UseGuards(AuthGuard('azure-ad'))"
  key_links:
    - from: "azure-ad.strategy.ts"
      to: "sso.service.ts"
      via: "findOrCreateSsoUser"
      pattern: "ssoService\\.findOrCreateSsoUser"
    - from: "auth.controller.ts"
      to: "azure-ad.strategy.ts"
      via: "AuthGuard('azure-ad')"
      pattern: "AuthGuard\\('azure-ad'\\)"
---

<objective>
Implement Azure AD SSO strategy with passport-azure-ad.

Purpose: Enable users from organizations using Azure AD (Microsoft Entra ID) to log in via single sign-on. This is the most common enterprise SSO provider. The strategy validates OIDC tokens from Azure AD and uses SsoService for user lookup/provisioning.

Output: AzureAdStrategy passport strategy, login initiation and callback endpoints, integration with existing auth flow.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-authentication-sso/03-RESEARCH.md
@.planning/phases/03-authentication-sso/03-04-SUMMARY.md
@apps/backend/src/modules/auth/sso/sso.service.ts
@apps/backend/src/modules/auth/strategies/jwt.strategy.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install passport-azure-ad package</name>
  <files>apps/backend/package.json</files>
  <action>
Install the Azure AD passport strategy:

```bash
cd apps/backend && npm install passport-azure-ad @types/passport-azure-ad
```

passport-azure-ad is the official Microsoft library for Azure AD authentication with Passport.js. It supports OIDC (OpenID Connect) which is the recommended protocol for modern Azure AD integrations.
  </action>
  <verify>
Run: `cd apps/backend && npm ls passport-azure-ad`
Should show passport-azure-ad installed.
  </verify>
  <done>
passport-azure-ad and @types/passport-azure-ad packages installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AzureAdStrategy</name>
  <files>apps/backend/src/modules/auth/strategies/azure-ad.strategy.ts</files>
  <action>
Create `strategies/azure-ad.strategy.ts`:

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import {
  OIDCStrategy,
  IProfile,
  VerifyCallback,
  IOIDCStrategyOptionWithoutRequest,
} from 'passport-azure-ad';
import { ConfigService } from '@nestjs/config';
import { SsoService } from '../sso/sso.service';
import { SsoUserData } from '../interfaces';

/**
 * Azure AD OIDC Strategy for enterprise SSO.
 *
 * Uses the "common" endpoint to support multi-tenant apps where users
 * from any Azure AD tenant can sign in. Tenant routing is handled by
 * our domain verification system.
 *
 * Required environment variables:
 * - AZURE_AD_CLIENT_ID: Application (client) ID from Azure portal
 * - AZURE_AD_CLIENT_SECRET: Client secret from Azure portal
 * - API_URL: Base URL for callback (e.g., https://api.ethico.com)
 */
@Injectable()
export class AzureAdStrategy extends PassportStrategy(OIDCStrategy, 'azure-ad') {
  private readonly logger = new Logger(AzureAdStrategy.name);

  constructor(
    private configService: ConfigService,
    private ssoService: SsoService,
  ) {
    const clientId = configService.get<string>('AZURE_AD_CLIENT_ID');
    const clientSecret = configService.get<string>('AZURE_AD_CLIENT_SECRET');
    const apiUrl = configService.get<string>('API_URL', 'http://localhost:3000');
    const nodeEnv = configService.get<string>('NODE_ENV', 'development');

    if (!clientId || !clientSecret) {
      throw new Error('Azure AD configuration missing: AZURE_AD_CLIENT_ID and AZURE_AD_CLIENT_SECRET required');
    }

    const options: IOIDCStrategyOptionWithoutRequest = {
      // Use "common" for multi-tenant - allows any Azure AD tenant
      identityMetadata: 'https://login.microsoftonline.com/common/v2.0/.well-known/openid-configuration',
      clientID: clientId,
      clientSecret: clientSecret,
      responseType: 'code',
      responseMode: 'form_post',
      redirectUrl: `${apiUrl}/api/v1/auth/azure-ad/callback`,
      allowHttpForRedirectUrl: nodeEnv === 'development',
      scope: ['openid', 'profile', 'email'],
      passReqToCallback: false,
      loggingLevel: nodeEnv === 'production' ? 'warn' : 'info',
      loggingNoPII: true, // Never log personally identifiable info
    };

    super(options);
  }

  /**
   * Validate callback from Azure AD.
   * Called by Passport after successful authentication with Azure AD.
   *
   * @param profile - User profile from Azure AD
   * @param done - Passport callback
   */
  async validate(profile: IProfile, done: VerifyCallback): Promise<void> {
    try {
      this.logger.log(`Azure AD callback for user: ${profile._json?.email || profile._json?.preferred_username}`);

      // Extract user data from Azure AD profile
      const ssoUser: SsoUserData = {
        email: this.extractEmail(profile),
        firstName: profile._json?.given_name || '',
        lastName: profile._json?.family_name || '',
        provider: 'azure-ad',
        ssoId: profile.oid, // Azure object ID - stable unique identifier
        azureTenantId: profile._json?.tid, // Azure tenant ID
        rawProfile: profile._json,
      };

      if (!ssoUser.email) {
        this.logger.error('Azure AD profile missing email');
        return done(new Error('Email not provided by Azure AD'), null);
      }

      // Use SsoService for user lookup/creation
      const user = await this.ssoService.findOrCreateSsoUser(ssoUser);

      done(null, user);
    } catch (error) {
      this.logger.error(`Azure AD validation error: ${error.message}`);
      done(error, null);
    }
  }

  /**
   * Extract email from Azure AD profile.
   * Azure AD can return email in different fields depending on configuration.
   */
  private extractEmail(profile: IProfile): string {
    // Priority: email claim > preferred_username (usually email) > upn
    return (
      profile._json?.email ||
      profile._json?.preferred_username ||
      profile._json?.upn ||
      ''
    );
  }
}
```
  </action>
  <verify>
Run: `cd apps/backend && npx tsc --noEmit`
Should compile without errors.
  </verify>
  <done>
AzureAdStrategy extends PassportStrategy with OIDCStrategy, validates Azure AD callbacks, extracts user data, and uses SsoService for JIT provisioning.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Azure AD endpoints to AuthController and register strategy</name>
  <files>
apps/backend/src/modules/auth/auth.controller.ts
apps/backend/src/modules/auth/auth.module.ts
apps/backend/src/modules/auth/strategies/index.ts
  </files>
  <action>
1. Create/update `strategies/index.ts`:

```typescript
export * from './jwt.strategy';
export * from './azure-ad.strategy';
```

2. Update `auth.module.ts` to include AzureAdStrategy:

```typescript
import { Module, forwardRef } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { PassportModule } from '@nestjs/passport';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { AuthService } from './auth.service';
import { AuthController } from './auth.controller';
import { JwtStrategy, AzureAdStrategy } from './strategies';
import { DomainModule } from './domain';
import { SsoModule } from './sso';

@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'jwt' }),
    JwtModule.registerAsync({
      imports: [ConfigModule],
      inject: [ConfigService],
      useFactory: (configService: ConfigService) => ({
        secret: configService.get<string>('jwt.secret'),
        signOptions: {
          expiresIn: configService.get<string>('jwt.accessTokenExpiry', '15m'),
        },
      }),
    }),
    ConfigModule,
    DomainModule,
    SsoModule,
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy, AzureAdStrategy],
  exports: [AuthService, JwtModule, DomainModule, SsoModule],
})
export class AuthModule {}
```

3. Add Azure AD endpoints to `auth.controller.ts`:

Add imports:
```typescript
import { AuthGuard } from '@nestjs/passport';
import { Throttle } from '@nestjs/throttler';
```

Add endpoints (typically after login endpoint):

```typescript
/**
 * Initiate Azure AD SSO login.
 * Redirects user to Microsoft login page.
 */
@Get('azure-ad')
@UseGuards(AuthGuard('azure-ad'))
@Throttle({ default: { limit: 10, ttl: 60000 } })
@Public()
@ApiOperation({ summary: 'Initiate Azure AD SSO login' })
@ApiResponse({ status: 302, description: 'Redirects to Microsoft login' })
azureAdLogin(): void {
  // Passport handles the redirect to Azure AD
  // This method body never executes
}

/**
 * Handle Azure AD SSO callback.
 * Validates the authentication and issues JWT tokens.
 */
@Post('azure-ad/callback')
@UseGuards(AuthGuard('azure-ad'))
@Throttle({ default: { limit: 20, ttl: 60000 } })
@Public()
@HttpCode(HttpStatus.OK)
@ApiOperation({ summary: 'Azure AD SSO callback' })
@ApiResponse({ status: 200, type: AuthResponseDto })
async azureAdCallback(
  @Req() req: Request,
  @Res({ passthrough: true }) res: Response,
): Promise<AuthResponseDto> {
  // User is already validated by AzureAdStrategy
  const user = req.user as any;

  // Create session and generate JWT tokens using existing auth service
  const session = await this.authService.createSsoSession(
    user.id,
    user.organizationId,
    req.headers['user-agent'],
    req.ip,
  );

  const tokens = await this.authService.generateTokensForUser(user, session.id);

  return {
    ...tokens,
    user: {
      id: user.id,
      email: user.email,
      firstName: user.firstName,
      lastName: user.lastName,
      role: user.role,
      organizationId: user.organizationId,
    },
  };
}
```

4. Add helper methods to `auth.service.ts`:

```typescript
/**
 * Create session for SSO-authenticated user.
 * Used by SSO callback handlers.
 */
async createSsoSession(
  userId: string,
  organizationId: string,
  userAgent?: string,
  ipAddress?: string,
) {
  return this.createSession(userId, organizationId, userAgent, ipAddress);
}

/**
 * Generate tokens for an already-authenticated user.
 * Used by SSO callback handlers.
 */
async generateTokensForUser(
  user: { id: string; email: string; organizationId: string; role: string },
  sessionId: string,
) {
  return this.generateTokens(user, sessionId);
}
```

Note: If createSession and generateTokens are private, make them protected or add these wrapper methods.
  </action>
  <verify>
Run: `cd apps/backend && npx tsc --noEmit && npm test`
TypeScript compiles and tests pass.
  </verify>
  <done>
AzureAdStrategy registered in AuthModule. AuthController has /azure-ad (GET) for initiating login and /azure-ad/callback (POST) for handling callback. Both endpoints use AuthGuard('azure-ad').
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
2. Tests pass: `cd apps/backend && npm test`
3. Strategy registered: Check that AzureAdStrategy is in AuthModule providers
4. Endpoints exist: Start server and verify /api/v1/auth/azure-ad exists
</verification>

<success_criteria>
- passport-azure-ad package installed
- AzureAdStrategy validates Azure AD OIDC tokens
- GET /api/v1/auth/azure-ad redirects to Microsoft login
- POST /api/v1/auth/azure-ad/callback handles callback and issues JWT
- JIT provisioning works for users with verified domains
- Existing users are linked to Azure AD on first login
- Rate limiting applied to SSO endpoints
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03-authentication-sso/03-05-SUMMARY.md`
</output>
