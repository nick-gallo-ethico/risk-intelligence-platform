---
phase: 07-notifications-email
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/notifications/notifications.module.ts
  - apps/backend/src/modules/notifications/entities/notification.types.ts
  - apps/backend/src/modules/notifications/dto/notification.dto.ts
  - apps/backend/src/modules/jobs/types/job-data.types.ts
autonomous: true

must_haves:
  truths:
    - "Notification records can be created for email and in-app channels"
    - "User preferences can be stored and retrieved with organization defaults"
    - "Email delivery status can be tracked from queued to delivered/failed"
    - "Organization-enforced notification minimums are stored separately from user preferences"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Notification, NotificationPreference, NotificationDelivery, OrgNotificationSettings models"
      contains: "model Notification"
    - path: "apps/backend/src/modules/notifications/entities/notification.types.ts"
      provides: "NotificationType, NotificationChannel, DeliveryStatus enums and interfaces"
      exports: ["NotificationType", "NotificationChannel", "DeliveryStatus"]
    - path: "apps/backend/src/modules/notifications/notifications.module.ts"
      provides: "NotificationsModule with service placeholders"
      exports: ["NotificationsModule"]
  key_links:
    - from: "apps/backend/src/modules/notifications/notifications.module.ts"
      to: "apps/backend/prisma/schema.prisma"
      via: "PrismaService injection"
      pattern: "PrismaService"
---

<objective>
Create the database schema and type definitions for the notification system.

Purpose: Establish the data layer that all notification services will use - notification records, user preferences, delivery tracking, and organization settings.
Output: Prisma models, TypeScript types/enums, DTOs, and a skeleton NotificationsModule.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-notifications-email/07-CONTEXT.md
@.planning/phases/07-notifications-email/07-RESEARCH.md

Reference existing patterns:
@apps/backend/src/modules/events/events/base.event.ts
@apps/backend/src/modules/jobs/types/job-data.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Prisma models for notifications</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models to the Prisma schema:

1. **Notification** - Core notification record
   - id (uuid), organizationId, userId
   - channel: NotificationChannel enum (EMAIL, IN_APP)
   - type: NotificationType enum (ASSIGNMENT, DEADLINE, APPROVAL, MENTION, INTERVIEW, STATUS_UPDATE, COMMENT, COMPLETION, ESCALATION, DIGEST)
   - status: NotificationStatus enum (QUEUED, SENT, DELIVERED, FAILED, READ, ARCHIVED)
   - title (String), body (String?)
   - entityType (String?), entityId (String?) - for navigation
   - templateId (String?) - which email template was used
   - isRead (Boolean), readAt (DateTime?)
   - createdAt, updatedAt
   - Relations: organization, user

2. **NotificationDelivery** - Email delivery tracking
   - id (uuid), notificationId (FK to Notification)
   - messageId (String?) - from email provider
   - status: DeliveryStatus enum (PENDING, SENT, DELIVERED, BOUNCED, FAILED, DEFERRED)
   - attempts (Int), lastAttemptAt (DateTime?)
   - errorMessage (String?)
   - createdAt, updatedAt
   - Unique constraint on notificationId

3. **NotificationPreference** - User preferences
   - id (uuid), organizationId, userId (unique together)
   - preferences (Json) - structure: { categoryName: { email: bool, inApp: bool } }
   - quietHoursStart (String?), quietHoursEnd (String?), timezone (String default "UTC")
   - backupUserId (String?), oooUntil (DateTime?)
   - createdAt, updatedAt
   - Relations: organization, user, backupUser

4. **OrgNotificationSettings** - Organization-level settings
   - id (uuid), organizationId (unique)
   - enforcedCategories (String[]) - categories users cannot disable
   - defaultQuietHoursStart (String?), defaultQuietHoursEnd (String?)
   - digestTime (String default "17:00")
   - createdAt, updatedAt
   - Relations: organization

Add RLS policies (via @@map annotations) for all models. Use snake_case for table/column names.

Add enums:
- NotificationChannel: EMAIL, IN_APP
- NotificationType: ASSIGNMENT, DEADLINE, APPROVAL, MENTION, INTERVIEW, STATUS_UPDATE, COMMENT, COMPLETION, ESCALATION, DIGEST
- NotificationStatus: QUEUED, SENT, DELIVERED, FAILED, READ, ARCHIVED
- DeliveryStatus: PENDING, SENT, DELIVERED, BOUNCED, FAILED, DEFERRED
  </action>
  <verify>Run `cd apps/backend && npx prisma validate` - should pass without errors</verify>
  <done>All 4 models and enums are added to schema.prisma with proper relations and constraints</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types and DTOs</name>
  <files>
    apps/backend/src/modules/notifications/entities/notification.types.ts
    apps/backend/src/modules/notifications/dto/notification.dto.ts
    apps/backend/src/modules/jobs/types/job-data.types.ts
  </files>
  <action>
Create `apps/backend/src/modules/notifications/` directory structure:
```
notifications/
├── entities/
│   └── notification.types.ts
├── dto/
│   └── notification.dto.ts
└── notifications.module.ts
```

In **notification.types.ts**, define:
- Re-export Prisma enums for convenience
- NotificationCategory type = 'ASSIGNMENT' | 'DEADLINE' | 'APPROVAL' | 'MENTION' | 'INTERVIEW' | 'STATUS_UPDATE' | 'COMMENT' | 'COMPLETION'
- PreferenceSettings interface: { [category: string]: { email: boolean; inApp: boolean } }
- DEFAULT_PREFERENCES const per CONTEXT.md:
  - ASSIGNMENT, DEADLINE, MENTION, APPROVAL, INTERVIEW: email=true, inApp=true
  - STATUS_UPDATE, COMMENT, COMPLETION: email=false, inApp=true
- QueueEmailParams interface for notification service
- SendInAppParams interface for notification service
- InAppNotification interface (for WebSocket payload)

In **notification.dto.ts**, define:
- CreateNotificationDto (organizationId, userId, channel, type, title, body?, entityType?, entityId?)
- UpdatePreferencesDto (preferences: PreferenceSettings, quietHoursStart?, quietHoursEnd?, timezone?, backupUserId?, oooUntil?)
- NotificationQueryDto (channel?, type?, isRead?, limit?, offset?)
- MarkReadDto (notificationIds: string[])

Update **job-data.types.ts**:
- Extend EmailJobData to include: notificationId (String), html (String - pre-rendered content)
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - should compile without type errors</verify>
  <done>Type definitions and DTOs are created with proper exports</done>
</task>

<task type="auto">
  <name>Task 3: Create skeleton NotificationsModule</name>
  <files>
    apps/backend/src/modules/notifications/notifications.module.ts
    apps/backend/src/modules/notifications/index.ts
  </files>
  <action>
Create **notifications.module.ts**:
- Import @Module from @nestjs/common
- Import PrismaModule (for database access)
- Import BullModule.registerQueue for EMAIL_QUEUE_NAME (from jobs module)
- Create empty providers array (services will be added in later plans)
- Create empty exports array
- Add comment indicating which services will be added:
  // Services to be added:
  // - NotificationService (07-04)
  // - PreferenceService (07-03)
  // - EmailTemplateService (07-02)
  // - DeliveryTrackerService (07-07)
  // - DigestService (07-06)

Create **index.ts** barrel file:
- Export NotificationsModule
- Export all types from entities/notification.types.ts
- Export all DTOs from dto/notification.dto.ts
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - module should compile</verify>
  <done>NotificationsModule is created and can be imported by other modules</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npx prisma validate` passes
2. `cd apps/backend && npx tsc --noEmit` passes
3. Directory structure exists: `apps/backend/src/modules/notifications/{entities,dto}/`
4. Grep for "model Notification" in schema.prisma returns results
</verification>

<success_criteria>
- Prisma schema has Notification, NotificationDelivery, NotificationPreference, OrgNotificationSettings models
- All 4 enums are defined (NotificationChannel, NotificationType, NotificationStatus, DeliveryStatus)
- TypeScript types match Prisma schema
- DTOs are properly validated with class-validator decorators
- NotificationsModule can be imported without errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-email/07-01-SUMMARY.md`
</output>
