---
phase: 07-notifications-email
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/notifications/services/email-template.service.ts
  - apps/backend/src/modules/notifications/templates/base/layout.mjml.hbs
  - apps/backend/src/modules/notifications/templates/base/header.mjml.hbs
  - apps/backend/src/modules/notifications/templates/base/footer.mjml.hbs
  - apps/backend/src/modules/notifications/templates/assignment/case-assigned.mjml.hbs
  - apps/backend/src/modules/notifications/templates/deadline/sla-warning.mjml.hbs
  - apps/backend/package.json
autonomous: true

must_haves:
  truths:
    - "Email templates render MJML to HTML via Handlebars"
    - "Organization-specific template overrides work via database lookup"
    - "Templates are pre-compiled on module initialization for performance"
    - "Base layout templates are shared via Handlebars partials"
  artifacts:
    - path: "apps/backend/src/modules/notifications/services/email-template.service.ts"
      provides: "EmailTemplateService with render, getTemplate, saveTemplate methods"
      exports: ["EmailTemplateService"]
      min_lines: 150
    - path: "apps/backend/src/modules/notifications/templates/base/layout.mjml.hbs"
      provides: "Base MJML layout with header/footer partials"
      contains: "<mjml>"
    - path: "apps/backend/src/modules/notifications/templates/assignment/case-assigned.mjml.hbs"
      provides: "Case assignment notification template"
      contains: "Case #"
  key_links:
    - from: "apps/backend/src/modules/notifications/services/email-template.service.ts"
      to: "apps/backend/prisma/schema.prisma"
      via: "PrismaService for org template overrides"
      pattern: "prisma\\.emailTemplate"
---

<objective>
Create the email template service with MJML and Handlebars integration.

Purpose: Enable rendering of responsive, branded email templates that can be customized per organization while maintaining a consistent base layout.
Output: EmailTemplateService, base layout templates, and sample notification templates.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-notifications-email/07-CONTEXT.md
@.planning/phases/07-notifications-email/07-RESEARCH.md

Reference existing pattern:
@apps/backend/src/modules/ai/services/prompt.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MJML and create EmailTemplateService</name>
  <files>
    apps/backend/package.json
    apps/backend/src/modules/notifications/services/email-template.service.ts
  </files>
  <action>
Install dependencies:
```bash
cd apps/backend && npm install mjml @types/mjml --save
```

Create **email-template.service.ts** following the PromptService pattern from Phase 5:

```typescript
@Injectable()
export class EmailTemplateService implements OnModuleInit {
  private readonly logger = new Logger(EmailTemplateService.name);
  private readonly compiledTemplates = new Map<string, Handlebars.TemplateDelegate>();
  private readonly subjectTemplates = new Map<string, Handlebars.TemplateDelegate>();
  private readonly templateDir: string;

  constructor(private readonly prisma: PrismaService) {
    this.templateDir = path.join(__dirname, '..', 'templates');
  }

  async onModuleInit(): Promise<void> {
    await this.loadFileTemplates();
    this.registerHelpers();
    this.logger.log(`Loaded ${this.compiledTemplates.size} email templates`);
  }
}
```

Implement methods:
1. **render(templateName: string, context: Record<string, unknown>, organizationId?: string)**: Promise<{ subject: string; html: string }>
   - Check database for org-specific override first
   - Fall back to file template
   - Compile MJML to HTML after Handlebars rendering
   - Return subject and html

2. **getTemplate(templateName: string, organizationId?: string)**: Promise<TemplateResult>
   - Return raw template content for editing

3. **saveTemplate(params: SaveTemplateParams)**: Promise<{ id: string; version: number }>
   - Save org-specific override with version increment
   - Deactivate previous versions

4. **listTemplates()**: string[]
   - Return available template names

5. **private loadFileTemplates()**: Load all .mjml.hbs files from templates directory
6. **private registerHelpers()**: Register Handlebars helpers (formatDate, formatDateTime, urgentBadge, etc.)

Add EmailTemplate model to Prisma if not exists (for org overrides):
- id, organizationId, name, version, mjmlContent, subjectTemplate, isActive, createdAt, updatedAt
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - should compile without errors</verify>
  <done>EmailTemplateService is created with all methods and can compile MJML templates</done>
</task>

<task type="auto">
  <name>Task 2: Create base layout templates</name>
  <files>
    apps/backend/src/modules/notifications/templates/base/layout.mjml.hbs
    apps/backend/src/modules/notifications/templates/base/header.mjml.hbs
    apps/backend/src/modules/notifications/templates/base/footer.mjml.hbs
    apps/backend/src/modules/notifications/templates/base/styles.mjml.hbs
  </files>
  <action>
Create the template directory structure:
```
templates/
├── base/
│   ├── layout.mjml.hbs      # Full email wrapper
│   ├── header.mjml.hbs      # Logo and tenant branding
│   ├── footer.mjml.hbs      # Footer with unsubscribe/legal
│   └── styles.mjml.hbs      # Shared style definitions
├── assignment/              # To be created in this task
├── deadline/               # To be created in this task
└── _subjects.json          # Subject line templates
```

**layout.mjml.hbs**:
```handlebars
<mjml>
  <mj-head>
    {{> base/styles }}
    <mj-title>{{subject}}</mj-title>
    <mj-preview>{{preview}}</mj-preview>
  </mj-head>
  <mj-body background-color="#f4f4f5">
    {{> base/header org=org }}

    <mj-section padding="20px">
      <mj-column>
        {{{content}}}
      </mj-column>
    </mj-section>

    {{> base/footer org=org isTransactional=isTransactional }}
  </mj-body>
</mjml>
```

**header.mjml.hbs**:
- Display org logo if available (org.branding.logoUrl)
- Display org name
- Use org.branding.primaryColor for accent

**footer.mjml.hbs**:
- If isTransactional: "This is a required notification from {{org.name}}"
- If not isTransactional: Include unsubscribe link
- Company address, contact info
- "Powered by Ethico" subtle branding

**styles.mjml.hbs**:
- Define mj-class for buttons, text, headings
- Use org.branding.primaryColor where available with fallback
  </action>
  <verify>Files exist in templates/base/ directory</verify>
  <done>Base layout templates created with proper partial structure</done>
</task>

<task type="auto">
  <name>Task 3: Create initial notification templates</name>
  <files>
    apps/backend/src/modules/notifications/templates/assignment/case-assigned.mjml.hbs
    apps/backend/src/modules/notifications/templates/deadline/sla-warning.mjml.hbs
    apps/backend/src/modules/notifications/templates/deadline/sla-breach.mjml.hbs
    apps/backend/src/modules/notifications/templates/_subjects.json
  </files>
  <action>
Create notification templates that use the base layout:

**assignment/case-assigned.mjml.hbs**:
```handlebars
{{!-- Subject: Case #{{case.referenceNumber}} Assigned to You --}}
<mj-section background-color="#ffffff" border-radius="8px" padding="24px">
  <mj-column>
    <mj-text font-size="20px" font-weight="bold" color="#111827">
      {{#if (eq case.severity 'HIGH')}}{{urgentBadge case.severity}} {{/if}}
      New Case Assignment
    </mj-text>

    <mj-text font-size="16px" color="#374151" padding-top="16px">
      {{assignedBy.name}} has assigned you Case #{{case.referenceNumber}}.
    </mj-text>

    <mj-divider border-color="#e5e7eb" padding="16px 0" />

    <mj-text font-size="14px" color="#6b7280">
      <strong>Category:</strong> {{case.categoryName}}<br/>
      <strong>Priority:</strong> {{case.severity}}<br/>
      <strong>Due Date:</strong> {{formatDate case.dueDate}}<br/>
    </mj-text>

    <mj-button href="{{appUrl}}/cases/{{case.id}}"
               background-color="{{default org.branding.primaryColor '#2563eb'}}"
               border-radius="6px"
               padding="16px 0">
      View Case Details
    </mj-button>
  </mj-column>
</mj-section>
```

**deadline/sla-warning.mjml.hbs**:
- Warning about approaching SLA deadline
- Time remaining prominently displayed
- Case details summary
- CTA button to view case

**deadline/sla-breach.mjml.hbs**:
- Red/urgent styling
- SLA has been breached notification
- Overdue by X hours/days
- Immediate action required messaging

**_subjects.json** - Subject line templates by template name:
```json
{
  "assignment/case-assigned": "Case #{{case.referenceNumber}} Assigned to You",
  "deadline/sla-warning": "SLA Warning: Case #{{case.referenceNumber}} Due in {{hoursRemaining}} Hours",
  "deadline/sla-breach": "URGENT: SLA Breached for Case #{{case.referenceNumber}}"
}
```

Per CONTEXT.md - templates must NOT include:
- Names of complainants/subjects
- Allegation details
- Sensitive findings
  </action>
  <verify>Template files exist and contain valid MJML structure (check for `<mj-section>` tags)</verify>
  <done>Assignment and deadline templates created with proper MJML structure</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npm list mjml` shows mjml installed
2. `cd apps/backend && npx tsc --noEmit` passes
3. Template files exist in templates/ subdirectories
4. EmailTemplateService.render() can be called without errors (add simple unit test if time permits)
</verification>

<success_criteria>
- MJML package is installed
- EmailTemplateService follows PromptService pattern from Phase 5
- Base layout templates use Handlebars partials for composition
- At least 3 notification templates created (case-assigned, sla-warning, sla-breach)
- Templates reference org branding variables for white-labeling
- Sensitive information (names, allegations) not included per CONTEXT.md
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-email/07-02-SUMMARY.md`
</output>
