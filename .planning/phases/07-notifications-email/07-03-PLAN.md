---
phase: 07-notifications-email
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - apps/backend/src/modules/notifications/services/preference.service.ts
  - apps/backend/src/modules/notifications/notifications.module.ts
autonomous: true

must_haves:
  truths:
    - "User preferences are retrieved with 5-minute cache TTL"
    - "Default preferences are applied when user has no custom preferences"
    - "Organization-enforced categories cannot be disabled by users"
    - "OOO backup delegation routes urgent notifications to backup user"
    - "Quiet hours can block non-urgent notifications"
  artifacts:
    - path: "apps/backend/src/modules/notifications/services/preference.service.ts"
      provides: "PreferenceService with getPreferences, updatePreferences, getEffectivePreferences methods"
      exports: ["PreferenceService"]
      min_lines: 150
  key_links:
    - from: "apps/backend/src/modules/notifications/services/preference.service.ts"
      to: "apps/backend/prisma/schema.prisma"
      via: "PrismaService for preference queries"
      pattern: "prisma\\.notificationPreference"
---

<objective>
Create the notification preference service with caching and organization enforcement.

Purpose: Manage user notification preferences efficiently with caching, apply organization-enforced minimums, and handle OOO/backup delegation.
Output: PreferenceService with preference retrieval, update, and effective preference calculation.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-notifications-email/07-CONTEXT.md
@.planning/phases/07-notifications-email/07-RESEARCH.md
@.planning/phases/07-notifications-email/07-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreferenceService with caching</name>
  <files>apps/backend/src/modules/notifications/services/preference.service.ts</files>
  <action>
Create **preference.service.ts** with the following structure:

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { Cache } from 'cache-manager';
import { CACHE_MANAGER } from '@nestjs/cache-manager';
import { Inject } from '@nestjs/common';
import {
  PreferenceSettings,
  DEFAULT_PREFERENCES,
  NotificationCategory
} from '../entities/notification.types';

const PREFERENCE_CACHE_TTL = 5 * 60 * 1000; // 5 minutes

@Injectable()
export class PreferenceService {
  private readonly logger = new Logger(PreferenceService.name);

  constructor(
    private readonly prisma: PrismaService,
    @Inject(CACHE_MANAGER) private cacheManager: Cache,
  ) {}
}
```

Implement methods:

1. **getPreferences(userId: string, organizationId: string)**: Promise<UserPreferences>
   - Check cache first: `prefs:${organizationId}:${userId}`
   - If miss, query database
   - If no record exists, return DEFAULT_PREFERENCES
   - Cache result for 5 minutes
   - Return full preference object including quiet hours, backup

2. **getEffectivePreferences(userId: string, organizationId: string, category: NotificationCategory)**: Promise<EffectivePreference>
   - Get user preferences
   - Get organization settings (enforcedCategories)
   - If category is enforced by org, override user preference to enabled
   - Check quiet hours if applicable
   - Check OOO status and return backup user if OOO and urgent
   - Return: { email: boolean, inApp: boolean, isOOO: boolean, backupUserId?: string, isQuietHours: boolean }

3. **updatePreferences(userId: string, organizationId: string, update: UpdatePreferencesDto)**: Promise<void>
   - Upsert preference record
   - Invalidate cache
   - Validate backup user exists if provided

4. **setOOO(userId: string, organizationId: string, backupUserId: string, oooUntil: Date)**: Promise<void>
   - Set OOO status with backup user
   - Invalidate cache

5. **clearOOO(userId: string, organizationId: string)**: Promise<void>
   - Clear OOO status
   - Invalidate cache

6. **isQuietHours(userId: string, organizationId: string)**: Promise<boolean>
   - Check if current time is within user's quiet hours
   - Fall back to org default quiet hours if user hasn't set custom

7. **getOrgSettings(organizationId: string)**: Promise<OrgNotificationSettings>
   - Cache org settings with 5-minute TTL
   - Return enforced categories, default quiet hours, digest time

Private helper methods:
- **getCacheKey(organizationId: string, userId: string)**: string
- **invalidateCache(organizationId: string, userId: string)**: Promise<void>
- **mergeWithDefaults(userPrefs: Partial<PreferenceSettings>)**: PreferenceSettings

Type definitions needed:
```typescript
interface UserPreferences {
  preferences: PreferenceSettings;
  quietHoursStart: string | null;
  quietHoursEnd: string | null;
  timezone: string;
  backupUserId: string | null;
  oooUntil: Date | null;
}

interface EffectivePreference {
  email: boolean;
  inApp: boolean;
  isOOO: boolean;
  backupUserId?: string;
  isQuietHours: boolean;
  isEnforcedByOrg: boolean;
}
```
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - should compile without errors</verify>
  <done>PreferenceService is created with caching, org enforcement, and OOO handling</done>
</task>

<task type="auto">
  <name>Task 2: Add OrgNotificationSettingsService</name>
  <files>apps/backend/src/modules/notifications/services/org-settings.service.ts</files>
  <action>
Create **org-settings.service.ts** for organization-level notification settings:

```typescript
@Injectable()
export class OrgNotificationSettingsService {
  private readonly logger = new Logger(OrgNotificationSettingsService.name);

  constructor(
    private readonly prisma: PrismaService,
    @Inject(CACHE_MANAGER) private cacheManager: Cache,
  ) {}
}
```

Implement methods:

1. **getSettings(organizationId: string)**: Promise<OrgNotificationSettings>
   - Cache with key `org-settings:${organizationId}`
   - Return default if no record exists

2. **updateSettings(organizationId: string, update: UpdateOrgSettingsDto)**: Promise<void>
   - Upsert org settings
   - Invalidate cache
   - Only SYSTEM_ADMIN should call this (enforced at controller level)

3. **isEnforcedCategory(organizationId: string, category: NotificationCategory)**: Promise<boolean>
   - Check if category is in enforcedCategories array

4. **getDigestTime(organizationId: string)**: Promise<string>
   - Return configured digest time, default "17:00"

Default org settings:
```typescript
const DEFAULT_ORG_SETTINGS = {
  enforcedCategories: ['ASSIGNMENT', 'ESCALATION', 'DEADLINE'],
  defaultQuietHoursStart: null,
  defaultQuietHoursEnd: null,
  digestTime: '17:00',
};
```

Per CONTEXT.md: Organizations can require critical notifications (assignments, escalations, SLA warnings) that users cannot disable.
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - should compile without errors</verify>
  <done>OrgNotificationSettingsService is created for managing organization-level settings</done>
</task>

<task type="auto">
  <name>Task 3: Register services in NotificationsModule</name>
  <files>apps/backend/src/modules/notifications/notifications.module.ts</files>
  <action>
Update **notifications.module.ts** to register the preference services:

```typescript
import { Module } from '@nestjs/common';
import { CacheModule } from '@nestjs/cache-manager';
import { PrismaModule } from '../prisma/prisma.module';
import { PreferenceService } from './services/preference.service';
import { OrgNotificationSettingsService } from './services/org-settings.service';

@Module({
  imports: [
    PrismaModule,
    CacheModule.register({
      ttl: 5 * 60 * 1000, // 5 minutes default
    }),
  ],
  providers: [
    PreferenceService,
    OrgNotificationSettingsService,
    // More services to be added in later plans
  ],
  exports: [
    PreferenceService,
    OrgNotificationSettingsService,
  ],
})
export class NotificationsModule {}
```

Create barrel export in services/index.ts:
```typescript
export * from './preference.service';
export * from './org-settings.service';
```

Update module index.ts to export services.
  </action>
  <verify>Run `cd apps/backend && npx tsc --noEmit` - module should compile with services registered</verify>
  <done>Services are registered in NotificationsModule and exported</done>
</task>

</tasks>

<verification>
1. `cd apps/backend && npx tsc --noEmit` passes
2. PreferenceService has getPreferences, getEffectivePreferences, updatePreferences methods
3. OrgNotificationSettingsService handles enforced categories
4. Cache TTL is configured at 5 minutes per RESEARCH.md pitfall recommendations
5. Services are exported from NotificationsModule
</verification>

<success_criteria>
- PreferenceService caches preferences with 5-minute TTL
- Default preferences match CONTEXT.md (urgent=email+inApp, FYI=inApp only)
- Organization-enforced categories override user preferences
- OOO status correctly identifies backup user for delegation
- Quiet hours checking works with timezone awareness
- Cache is properly invalidated on preference updates
</success_criteria>

<output>
After completion, create `.planning/phases/07-notifications-email/07-03-SUMMARY.md`
</output>
