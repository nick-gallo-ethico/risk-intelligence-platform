---
phase: 13-hubspot-style-saved-views-system
plan: 04
type: execute
wave: 2
depends_on: ["13-03"]
files_modified:
  - apps/frontend/src/components/views/ViewTabsBar.tsx
  - apps/frontend/src/components/views/SortableViewTab.tsx
  - apps/frontend/src/components/views/ViewTabContextMenu.tsx
  - apps/frontend/src/components/views/AddViewButton.tsx
  - apps/frontend/src/components/views/CreateViewDialog.tsx
  - apps/frontend/src/components/views/index.ts
autonomous: true

must_haves:
  truths:
    - "View tabs are draggable horizontally to reorder using dnd-kit"
    - "Active tab has distinct visual styling (underline/background)"
    - "Tab context menu offers Rename, Clone, Manage sharing, Delete options"
    - "Add view button opens popover with create new or open existing options"
  artifacts:
    - path: "apps/frontend/src/components/views/ViewTabsBar.tsx"
      provides: "Horizontal row of draggable view tabs"
      contains: "DndContext"
    - path: "apps/frontend/src/components/views/SortableViewTab.tsx"
      provides: "Individual sortable tab component"
      contains: "useSortable"
    - path: "apps/frontend/src/components/views/ViewTabContextMenu.tsx"
      provides: "Context menu for tab actions"
      contains: "DropdownMenu"
  key_links:
    - from: "ViewTabsBar"
      to: "SavedViewContext"
      via: "useSavedViewContext hook"
      pattern: "useSavedViewContext"
---

<objective>
Create the ViewTabsBar component (Zone 1) with draggable view tabs using dnd-kit.

Purpose: Users need to switch between saved views and reorder them by dragging. The tabs bar is the primary navigation for views.

Output: ViewTabsBar with draggable tabs, context menus, record count badges, and add view button.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@.planning/phases/13-hubspot-style-saved-views-system/13-RESEARCH.md
@apps/frontend/src/components/views/SavedViewProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SortableViewTab component</name>
  <files>apps/frontend/src/components/views/SortableViewTab.tsx</files>
  <action>
Create the sortable tab component using dnd-kit:

```typescript
'use client';

import React from 'react';
import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical } from 'lucide-react';
import { cn } from '@/lib/utils';
import { Badge } from '@/components/ui/badge';
import { SavedView } from '@/lib/views/types';
import { ViewTabContextMenu } from './ViewTabContextMenu';
import { RECORD_COUNT_STALE_MINUTES } from '@/lib/views/constants';

interface SortableViewTabProps {
  view: SavedView;
  isActive: boolean;
  hasUnsavedChanges: boolean;
  onSelect: () => void;
}

export function SortableViewTab({
  view,
  isActive,
  hasUnsavedChanges,
  onSelect
}: SortableViewTabProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: view.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  // Check if record count is stale
  const isRecordCountStale = view.recordCountAt
    ? (Date.now() - new Date(view.recordCountAt).getTime()) > RECORD_COUNT_STALE_MINUTES * 60 * 1000
    : true;

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'flex items-center gap-1 px-3 py-2 cursor-pointer border-b-2 transition-colors select-none',
        'hover:bg-accent',
        isActive
          ? 'border-primary bg-background font-medium'
          : 'border-transparent',
        isDragging && 'opacity-50 z-50',
      )}
      onClick={onSelect}
    >
      {/* Drag handle */}
      <button
        className="p-0.5 hover:bg-muted rounded cursor-grab active:cursor-grabbing"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="h-4 w-4 text-muted-foreground" />
      </button>

      {/* Tab name */}
      <span className={cn(
        'whitespace-nowrap',
        hasUnsavedChanges && isActive && 'italic'
      )}>
        {view.name}
        {hasUnsavedChanges && isActive && ' â€¢'}
      </span>

      {/* Record count badge */}
      {view.recordCount !== undefined && view.recordCount !== null && (
        <Badge
          variant="secondary"
          className={cn(
            'ml-1 text-xs',
            isRecordCountStale && 'opacity-60'
          )}
        >
          {view.recordCount.toLocaleString()}
        </Badge>
      )}

      {/* Context menu */}
      <ViewTabContextMenu view={view} isActive={isActive} />
    </div>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>SortableViewTab component created with drag handle, badge, and context menu trigger</done>
</task>

<task type="auto">
  <name>Task 2: Create ViewTabContextMenu component</name>
  <files>apps/frontend/src/components/views/ViewTabContextMenu.tsx</files>
  <action>
Create the context menu for tab actions:

```typescript
'use client';

import React, { useState } from 'react';
import { MoreVertical, Pencil, Copy, Users, Trash2 } from 'lucide-react';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { SavedView } from '@/lib/views/types';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { VISIBILITY_OPTIONS } from '@/lib/views/constants';
import { toast } from 'sonner';

interface ViewTabContextMenuProps {
  view: SavedView;
  isActive: boolean;
}

export function ViewTabContextMenu({ view, isActive }: ViewTabContextMenuProps) {
  const { renameView, duplicateView, deleteView } = useSavedViewContext();

  const [renameOpen, setRenameOpen] = useState(false);
  const [sharingOpen, setSharingOpen] = useState(false);
  const [deleteOpen, setDeleteOpen] = useState(false);
  const [newName, setNewName] = useState(view.name);
  const [visibility, setVisibility] = useState<'private' | 'team' | 'everyone'>(
    view.isShared ? (view.sharedWithTeamId ? 'team' : 'everyone') : 'private'
  );

  const handleRename = async () => {
    if (!newName.trim()) return;
    try {
      await renameView(view.id, newName.trim());
      toast.success('View renamed');
      setRenameOpen(false);
    } catch (error) {
      toast.error('Failed to rename view');
    }
  };

  const handleDuplicate = async () => {
    try {
      const newView = await duplicateView(view.id);
      toast.success(`Created "${newView.name}"`);
    } catch (error) {
      toast.error('Failed to duplicate view');
    }
  };

  const handleDelete = async () => {
    try {
      await deleteView(view.id);
      toast.success('View deleted');
      setDeleteOpen(false);
    } catch (error) {
      toast.error('Failed to delete view');
    }
  };

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild onClick={(e) => e.stopPropagation()}>
          <button className="p-0.5 hover:bg-muted rounded opacity-0 group-hover:opacity-100 focus:opacity-100">
            <MoreVertical className="h-4 w-4 text-muted-foreground" />
          </button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="start" onClick={(e) => e.stopPropagation()}>
          <DropdownMenuItem onClick={() => { setNewName(view.name); setRenameOpen(true); }}>
            <Pencil className="h-4 w-4 mr-2" />
            Rename
          </DropdownMenuItem>
          <DropdownMenuItem onClick={handleDuplicate}>
            <Copy className="h-4 w-4 mr-2" />
            Clone
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => setSharingOpen(true)}>
            <Users className="h-4 w-4 mr-2" />
            Manage sharing
          </DropdownMenuItem>
          <DropdownMenuSeparator />
          <DropdownMenuItem
            className="text-destructive focus:text-destructive"
            onClick={() => setDeleteOpen(true)}
          >
            <Trash2 className="h-4 w-4 mr-2" />
            Delete
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>

      {/* Rename Dialog */}
      <Dialog open={renameOpen} onOpenChange={setRenameOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Rename view</DialogTitle>
          </DialogHeader>
          <div className="py-4">
            <Label htmlFor="name">Name</Label>
            <Input
              id="name"
              value={newName}
              onChange={(e) => setNewName(e.target.value)}
              placeholder="View name"
              className="mt-1.5"
              onKeyDown={(e) => e.key === 'Enter' && handleRename()}
            />
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setRenameOpen(false)}>
              Cancel
            </Button>
            <Button onClick={handleRename} disabled={!newName.trim()}>
              Save
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Sharing Dialog */}
      <Dialog open={sharingOpen} onOpenChange={setSharingOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Manage sharing</DialogTitle>
            <DialogDescription>
              Control who can see this view.
            </DialogDescription>
          </DialogHeader>
          <div className="py-4">
            <Label>Visibility</Label>
            <Select value={visibility} onValueChange={(v) => setVisibility(v as typeof visibility)}>
              <SelectTrigger className="mt-1.5">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {VISIBILITY_OPTIONS.map((opt) => (
                  <SelectItem key={opt.value} value={opt.value}>
                    <div>
                      <div className="font-medium">{opt.label}</div>
                      <div className="text-xs text-muted-foreground">{opt.description}</div>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
          <DialogFooter>
            <Button variant="outline" onClick={() => setSharingOpen(false)}>
              Cancel
            </Button>
            <Button onClick={() => { setSharingOpen(false); toast.success('Sharing updated'); }}>
              Save
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete Confirmation */}
      <AlertDialog open={deleteOpen} onOpenChange={setDeleteOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete view?</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete "{view.name}"? This action cannot be undone.
              This will not delete any records, only the saved view.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction
              className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
              onClick={handleDelete}
            >
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>ViewTabContextMenu with Rename, Clone, Manage sharing, Delete actions</done>
</task>

<task type="auto">
  <name>Task 3: Create ViewTabsBar and AddViewButton components</name>
  <files>apps/frontend/src/components/views/ViewTabsBar.tsx, apps/frontend/src/components/views/AddViewButton.tsx, apps/frontend/src/components/views/CreateViewDialog.tsx</files>
  <action>
Create the ViewTabsBar with dnd-kit:

```typescript
// apps/frontend/src/components/views/ViewTabsBar.tsx
'use client';

import React from 'react';
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from '@dnd-kit/core';
import {
  SortableContext,
  horizontalListSortingStrategy,
  arrayMove,
} from '@dnd-kit/sortable';
import { restrictToHorizontalAxis } from '@dnd-kit/modifiers';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { SortableViewTab } from './SortableViewTab';
import { AddViewButton } from './AddViewButton';
import { ScrollArea, ScrollBar } from '@/components/ui/scroll-area';

export function ViewTabsBar() {
  const {
    views,
    activeViewId,
    hasUnsavedChanges,
    setActiveView,
    reorderTabs
  } = useSavedViewContext();

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: { distance: 5 },
    }),
    useSensor(KeyboardSensor)
  );

  const handleDragEnd = async (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const oldIndex = views.findIndex((v) => v.id === active.id);
      const newIndex = views.findIndex((v) => v.id === over.id);
      const newOrder = arrayMove(
        views.map((v) => v.id),
        oldIndex,
        newIndex
      );
      await reorderTabs(newOrder);
    }
  };

  // Sort views by displayOrder
  const sortedViews = [...views].sort((a, b) => a.displayOrder - b.displayOrder);

  return (
    <div className="flex items-center border-b bg-muted/30">
      <ScrollArea className="flex-1">
        <div className="flex items-center">
          <DndContext
            sensors={sensors}
            collisionDetection={closestCenter}
            onDragEnd={handleDragEnd}
            modifiers={[restrictToHorizontalAxis]}
          >
            <SortableContext
              items={sortedViews.map((v) => v.id)}
              strategy={horizontalListSortingStrategy}
            >
              {sortedViews.map((view) => (
                <div key={view.id} className="group">
                  <SortableViewTab
                    view={view}
                    isActive={view.id === activeViewId}
                    hasUnsavedChanges={view.id === activeViewId && hasUnsavedChanges}
                    onSelect={() => setActiveView(view.id)}
                  />
                </div>
              ))}
            </SortableContext>
          </DndContext>
        </div>
        <ScrollBar orientation="horizontal" />
      </ScrollArea>

      <div className="flex-shrink-0 border-l">
        <AddViewButton />
      </div>
    </div>
  );
}
```

Create AddViewButton:

```typescript
// apps/frontend/src/components/views/AddViewButton.tsx
'use client';

import React, { useState } from 'react';
import { Plus, FolderOpen } from 'lucide-react';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { CreateViewDialog } from './CreateViewDialog';

export function AddViewButton() {
  const { views, setActiveView } = useSavedViewContext();
  const [open, setOpen] = useState(false);
  const [createOpen, setCreateOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');

  // Filter views by search
  const filteredViews = views.filter((v) =>
    v.name.toLowerCase().includes(searchQuery.toLowerCase())
  );

  const handleSelectView = (viewId: string) => {
    setActiveView(viewId);
    setOpen(false);
    setSearchQuery('');
  };

  return (
    <>
      <Popover open={open} onOpenChange={setOpen}>
        <PopoverTrigger asChild>
          <Button
            variant="ghost"
            size="icon"
            className="h-9 w-9 rounded-full"
          >
            <Plus className="h-4 w-4" />
          </Button>
        </PopoverTrigger>
        <PopoverContent className="w-64 p-0" align="end">
          <div className="p-2 border-b">
            <Button
              variant="ghost"
              className="w-full justify-start"
              onClick={() => {
                setOpen(false);
                setCreateOpen(true);
              }}
            >
              <Plus className="h-4 w-4 mr-2" />
              Create new view
            </Button>
          </div>

          <div className="p-2 border-b">
            <Input
              placeholder="Search views..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="h-8"
            />
          </div>

          <ScrollArea className="h-[200px]">
            <div className="p-1">
              {filteredViews.length === 0 ? (
                <div className="text-center text-sm text-muted-foreground py-4">
                  No views found
                </div>
              ) : (
                filteredViews.map((view) => (
                  <Button
                    key={view.id}
                    variant="ghost"
                    className="w-full justify-start font-normal"
                    onClick={() => handleSelectView(view.id)}
                  >
                    <FolderOpen className="h-4 w-4 mr-2 text-muted-foreground" />
                    {view.name}
                  </Button>
                ))
              )}
            </div>
          </ScrollArea>
        </PopoverContent>
      </Popover>

      <CreateViewDialog open={createOpen} onOpenChange={setCreateOpen} />
    </>
  );
}
```

Create CreateViewDialog:

```typescript
// apps/frontend/src/components/views/CreateViewDialog.tsx
'use client';

import React, { useState } from 'react';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { VISIBILITY_OPTIONS } from '@/lib/views/constants';
import { toast } from 'sonner';

interface CreateViewDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function CreateViewDialog({ open, onOpenChange }: CreateViewDialogProps) {
  const { saveViewAs, setActiveView } = useSavedViewContext();
  const [name, setName] = useState('');
  const [visibility, setVisibility] = useState<'private' | 'team' | 'everyone'>('private');
  const [isLoading, setIsLoading] = useState(false);

  const handleCreate = async () => {
    if (!name.trim()) return;

    setIsLoading(true);
    try {
      const newView = await saveViewAs(name.trim(), visibility);
      await setActiveView(newView.id);
      toast.success(`Created "${newView.name}"`);
      onOpenChange(false);
      setName('');
      setVisibility('private');
    } catch (error) {
      toast.error('Failed to create view');
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Create new view</DialogTitle>
          <DialogDescription>
            Save your current filters, columns, and sort settings as a reusable view.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div>
            <Label htmlFor="view-name">Name</Label>
            <Input
              id="view-name"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="My view"
              className="mt-1.5"
              onKeyDown={(e) => e.key === 'Enter' && handleCreate()}
            />
          </div>

          <div>
            <Label>Visibility</Label>
            <Select value={visibility} onValueChange={(v) => setVisibility(v as typeof visibility)}>
              <SelectTrigger className="mt-1.5">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {VISIBILITY_OPTIONS.map((opt) => (
                  <SelectItem key={opt.value} value={opt.value}>
                    <div>
                      <div className="font-medium">{opt.label}</div>
                      <div className="text-xs text-muted-foreground">{opt.description}</div>
                    </div>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button onClick={handleCreate} disabled={!name.trim() || isLoading}>
            {isLoading ? 'Creating...' : 'Create view'}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Update the components index:

```typescript
// apps/frontend/src/components/views/index.ts
export { SavedViewProvider, SavedViewContext } from "./SavedViewProvider";
export type { SavedViewContextValue } from "./SavedViewProvider";
export { ViewTabsBar } from "./ViewTabsBar";
export { SortableViewTab } from "./SortableViewTab";
export { ViewTabContextMenu } from "./ViewTabContextMenu";
export { AddViewButton } from "./AddViewButton";
export { CreateViewDialog } from "./CreateViewDialog";
```

  </action>
  <verify>npm run typecheck passes; npm run lint passes</verify>
  <done>ViewTabsBar with draggable tabs, AddViewButton with popover, and CreateViewDialog</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- ViewTabsBar renders horizontally scrollable row of view tabs
- Tabs are draggable using dnd-kit with horizontal constraint
- Active tab has distinct border/background styling
- Unsaved changes show italic name with bullet indicator
- Record count badges appear on tabs when available
- Context menu (three-dot) offers Rename, Clone, Manage sharing, Delete
- Add view button (+) opens popover with create new and search existing options
- CreateViewDialog captures name and visibility for new views
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-04-SUMMARY.md`
</output>
