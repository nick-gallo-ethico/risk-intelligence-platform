---
phase: 13-hubspot-style-saved-views-system
plan: 06
type: execute
wave: 2
depends_on: ["13-03"]
files_modified:
  - apps/frontend/src/components/views/ColumnSelectionModal.tsx
  - apps/frontend/src/components/views/PropertyPicker.tsx
  - apps/frontend/src/components/views/SelectedColumnsList.tsx
  - apps/frontend/src/components/views/index.ts
autonomous: true

must_haves:
  truths:
    - "Modal has left panel with available columns grouped by category"
    - "Modal has right panel with selected columns that are drag-reorderable"
    - "Frozen column count dropdown allows 0-3 frozen columns"
    - "Search box filters available columns"
    - "First column (Name) cannot be removed"
  artifacts:
    - path: "apps/frontend/src/components/views/ColumnSelectionModal.tsx"
      provides: "Full column selection modal with two-panel layout"
      contains: "frozenColumnCount"
    - path: "apps/frontend/src/components/views/SelectedColumnsList.tsx"
      provides: "Drag-reorderable list of selected columns"
      contains: "DndContext"
  key_links:
    - from: "ColumnSelectionModal"
      to: "SavedViewContext"
      via: "useSavedViewContext"
      pattern: "setVisibleColumns"
---

<objective>
Create the Column Selection Modal (Edit Columns) for managing which columns appear in the view.

Purpose: Users need to select which columns to show, reorder them via drag-and-drop, and set how many columns to freeze. This modal is the primary interface for column configuration.

Output: ColumnSelectionModal with available columns picker, drag-reorderable selected columns, and frozen column control.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@apps/frontend/src/components/views/SavedViewProvider.tsx
@apps/frontend/src/lib/views/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PropertyPicker component for available columns</name>
  <files>apps/frontend/src/components/views/PropertyPicker.tsx</files>
  <action>
Create a searchable, grouped property picker:

```typescript
'use client';

import React, { useMemo, useState } from 'react';
import { Search, ChevronDown, ChevronRight, Check } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Checkbox } from '@/components/ui/checkbox';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { ColumnConfig, PropertyGroup } from '@/lib/views/types';
import { cn } from '@/lib/utils';

interface PropertyPickerProps {
  columns: ColumnConfig[];
  selectedColumnIds: string[];
  onToggleColumn: (columnId: string) => void;
  groups?: PropertyGroup[];
}

export function PropertyPicker({
  columns,
  selectedColumnIds,
  onToggleColumn,
  groups = [],
}: PropertyPickerProps) {
  const [search, setSearch] = useState('');
  const [expandedGroups, setExpandedGroups] = useState<Set<string>>(new Set(groups.map((g) => g.id)));

  // Filter columns by search
  const filteredColumns = useMemo(() => {
    if (!search.trim()) return columns;
    const lower = search.toLowerCase();
    return columns.filter(
      (col) =>
        col.header.toLowerCase().includes(lower) ||
        col.id.toLowerCase().includes(lower)
    );
  }, [columns, search]);

  // Group columns
  const groupedColumns = useMemo(() => {
    const result = new Map<string, ColumnConfig[]>();

    // Initialize groups
    groups.forEach((g) => result.set(g.id, []));
    result.set('other', []); // For ungrouped columns

    filteredColumns.forEach((col) => {
      const groupId = col.group || 'other';
      if (!result.has(groupId)) {
        result.set(groupId, []);
      }
      result.get(groupId)!.push(col);
    });

    return result;
  }, [filteredColumns, groups]);

  const toggleGroup = (groupId: string) => {
    setExpandedGroups((prev) => {
      const next = new Set(prev);
      if (next.has(groupId)) {
        next.delete(groupId);
      } else {
        next.add(groupId);
      }
      return next;
    });
  };

  const renderColumnItem = (col: ColumnConfig) => {
    const isSelected = selectedColumnIds.includes(col.id);

    return (
      <div
        key={col.id}
        className={cn(
          'flex items-center gap-3 px-3 py-2 cursor-pointer hover:bg-accent rounded-md',
          isSelected && 'bg-accent/50'
        )}
        onClick={() => onToggleColumn(col.id)}
      >
        <Checkbox checked={isSelected} />
        <span className="text-sm flex-1">{col.header}</span>
        {isSelected && <Check className="h-4 w-4 text-primary" />}
      </div>
    );
  };

  return (
    <div className="flex flex-col h-full">
      {/* Search */}
      <div className="relative mb-3">
        <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
        <Input
          placeholder="Search columns..."
          value={search}
          onChange={(e) => setSearch(e.target.value)}
          className="pl-9"
        />
      </div>

      {/* Grouped columns */}
      <ScrollArea className="flex-1">
        <div className="space-y-2">
          {groups.map((group) => {
            const groupColumns = groupedColumns.get(group.id) || [];
            if (groupColumns.length === 0) return null;

            return (
              <Collapsible
                key={group.id}
                open={expandedGroups.has(group.id)}
                onOpenChange={() => toggleGroup(group.id)}
              >
                <CollapsibleTrigger className="flex items-center gap-2 w-full px-2 py-1.5 text-sm font-medium text-muted-foreground hover:text-foreground">
                  {expandedGroups.has(group.id) ? (
                    <ChevronDown className="h-4 w-4" />
                  ) : (
                    <ChevronRight className="h-4 w-4" />
                  )}
                  {group.label}
                  <span className="ml-auto text-xs">({groupColumns.length})</span>
                </CollapsibleTrigger>
                <CollapsibleContent>
                  <div className="ml-2 space-y-0.5">
                    {groupColumns.map(renderColumnItem)}
                  </div>
                </CollapsibleContent>
              </Collapsible>
            );
          })}

          {/* Ungrouped columns */}
          {(groupedColumns.get('other')?.length ?? 0) > 0 && (
            <div className="space-y-0.5">
              {groups.length > 0 && (
                <div className="px-2 py-1.5 text-sm font-medium text-muted-foreground">
                  Other
                </div>
              )}
              {groupedColumns.get('other')?.map(renderColumnItem)}
            </div>
          )}
        </div>
      </ScrollArea>
    </div>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>PropertyPicker component with search and grouped columns</done>
</task>

<task type="auto">
  <name>Task 2: Create SelectedColumnsList with drag-and-drop reordering</name>
  <files>apps/frontend/src/components/views/SelectedColumnsList.tsx</files>
  <action>
Create the draggable selected columns list:

```typescript
'use client';

import React from 'react';
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from '@dnd-kit/core';
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { GripVertical, X, Lock } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { ScrollArea } from '@/components/ui/scroll-area';
import { ColumnConfig } from '@/lib/views/types';
import { cn } from '@/lib/utils';

interface SortableColumnItemProps {
  column: ColumnConfig;
  isLocked: boolean;
  isFrozen: boolean;
  onRemove: (columnId: string) => void;
}

function SortableColumnItem({ column, isLocked, isFrozen, onRemove }: SortableColumnItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: column.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        'flex items-center gap-2 px-2 py-2 bg-background border rounded-md',
        isDragging && 'opacity-50 shadow-lg',
        isFrozen && 'bg-blue-50 dark:bg-blue-950/30 border-blue-200 dark:border-blue-800'
      )}
    >
      {/* Drag handle */}
      <button
        className="cursor-grab active:cursor-grabbing p-1 hover:bg-accent rounded"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="h-4 w-4 text-muted-foreground" />
      </button>

      {/* Column name */}
      <span className="flex-1 text-sm truncate">{column.header}</span>

      {/* Frozen indicator */}
      {isFrozen && (
        <span className="text-xs text-blue-600 dark:text-blue-400 font-medium">
          Frozen
        </span>
      )}

      {/* Lock or remove button */}
      {isLocked ? (
        <Lock className="h-4 w-4 text-muted-foreground" />
      ) : (
        <Button
          variant="ghost"
          size="icon"
          className="h-6 w-6"
          onClick={() => onRemove(column.id)}
        >
          <X className="h-4 w-4" />
        </Button>
      )}
    </div>
  );
}

interface SelectedColumnsListProps {
  columns: ColumnConfig[];
  selectedColumnIds: string[];
  frozenCount: number;
  lockedColumnId?: string; // First column that can't be removed
  onReorder: (newOrder: string[]) => void;
  onRemove: (columnId: string) => void;
}

export function SelectedColumnsList({
  columns,
  selectedColumnIds,
  frozenCount,
  lockedColumnId,
  onReorder,
  onRemove,
}: SelectedColumnsListProps) {
  const sensors = useSensors(
    useSensor(PointerSensor),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  // Get selected columns in order
  const selectedColumns = selectedColumnIds
    .map((id) => columns.find((c) => c.id === id))
    .filter((c): c is ColumnConfig => c !== undefined);

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const oldIndex = selectedColumnIds.indexOf(active.id as string);
      const newIndex = selectedColumnIds.indexOf(over.id as string);
      const newOrder = arrayMove(selectedColumnIds, oldIndex, newIndex);
      onReorder(newOrder);
    }
  };

  return (
    <ScrollArea className="h-full">
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragEnd={handleDragEnd}
      >
        <SortableContext
          items={selectedColumnIds}
          strategy={verticalListSortingStrategy}
        >
          <div className="space-y-1 pr-4">
            {selectedColumns.map((column, index) => (
              <SortableColumnItem
                key={column.id}
                column={column}
                isLocked={column.id === lockedColumnId}
                isFrozen={index < frozenCount}
                onRemove={onRemove}
              />
            ))}
          </div>
        </SortableContext>
      </DndContext>
    </ScrollArea>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>SelectedColumnsList with drag-reorder and frozen column indicators</done>
</task>

<task type="auto">
  <name>Task 3: Create ColumnSelectionModal component</name>
  <files>apps/frontend/src/components/views/ColumnSelectionModal.tsx</files>
  <action>
Create the main column selection modal:

```typescript
'use client';

import React, { useState, useCallback } from 'react';
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Label } from '@/components/ui/label';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { PropertyPicker } from './PropertyPicker';
import { SelectedColumnsList } from './SelectedColumnsList';

interface ColumnSelectionModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
}

export function ColumnSelectionModal({ open, onOpenChange }: ColumnSelectionModalProps) {
  const {
    config,
    visibleColumns,
    frozenColumnCount,
    setVisibleColumns,
    setFrozenColumnCount,
  } = useSavedViewContext();

  // Local state for editing
  const [localColumns, setLocalColumns] = useState<string[]>(visibleColumns);
  const [localFrozenCount, setLocalFrozenCount] = useState(frozenColumnCount);

  // Reset local state when modal opens
  React.useEffect(() => {
    if (open) {
      setLocalColumns(visibleColumns);
      setLocalFrozenCount(frozenColumnCount);
    }
  }, [open, visibleColumns, frozenColumnCount]);

  // Get the locked column (first column in config)
  const lockedColumnId = config.columns[0]?.id;

  const handleToggleColumn = useCallback((columnId: string) => {
    // Don't allow removing the locked column
    if (columnId === lockedColumnId) return;

    setLocalColumns((prev) => {
      if (prev.includes(columnId)) {
        return prev.filter((id) => id !== columnId);
      } else {
        return [...prev, columnId];
      }
    });
  }, [lockedColumnId]);

  const handleReorder = useCallback((newOrder: string[]) => {
    setLocalColumns(newOrder);
  }, []);

  const handleRemove = useCallback((columnId: string) => {
    setLocalColumns((prev) => prev.filter((id) => id !== columnId));
  }, []);

  const handleRemoveAll = useCallback(() => {
    // Keep only the locked column
    setLocalColumns(lockedColumnId ? [lockedColumnId] : []);
    setLocalFrozenCount(0);
  }, [lockedColumnId]);

  const handleApply = () => {
    setVisibleColumns(localColumns);
    setFrozenColumnCount(localFrozenCount);
    onOpenChange(false);
  };

  const handleCancel = () => {
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl h-[600px] flex flex-col">
        <DialogHeader>
          <DialogTitle>Choose which columns you see</DialogTitle>
        </DialogHeader>

        <div className="flex-1 grid grid-cols-2 gap-6 min-h-0">
          {/* Left panel - Available columns */}
          <div className="flex flex-col min-h-0">
            <PropertyPicker
              columns={config.columns}
              selectedColumnIds={localColumns}
              onToggleColumn={handleToggleColumn}
              groups={config.propertyGroups}
            />
          </div>

          {/* Right panel - Selected columns */}
          <div className="flex flex-col min-h-0">
            <div className="flex items-center justify-between mb-3">
              <Label className="text-sm font-medium">
                SELECTED COLUMNS ({localColumns.length})
              </Label>
              <div className="flex items-center gap-2">
                <Label className="text-sm text-muted-foreground">Frozen:</Label>
                <Select
                  value={String(localFrozenCount)}
                  onValueChange={(v) => setLocalFrozenCount(Number(v))}
                >
                  <SelectTrigger className="w-16 h-8">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="0">0</SelectItem>
                    <SelectItem value="1">1</SelectItem>
                    <SelectItem value="2">2</SelectItem>
                    <SelectItem value="3">3</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <SelectedColumnsList
              columns={config.columns}
              selectedColumnIds={localColumns}
              frozenCount={localFrozenCount}
              lockedColumnId={lockedColumnId}
              onReorder={handleReorder}
              onRemove={handleRemove}
            />
          </div>
        </div>

        <DialogFooter className="flex items-center justify-between">
          <Button variant="ghost" onClick={handleRemoveAll}>
            Remove All Columns
          </Button>
          <div className="flex gap-2">
            <Button variant="outline" onClick={handleCancel}>
              Cancel
            </Button>
            <Button onClick={handleApply}>Apply</Button>
          </div>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Update exports:

```typescript
// apps/frontend/src/components/views/index.ts
export { SavedViewProvider, SavedViewContext } from "./SavedViewProvider";
export type { SavedViewContextValue } from "./SavedViewProvider";
export { ViewTabsBar } from "./ViewTabsBar";
export { SortableViewTab } from "./SortableViewTab";
export { ViewTabContextMenu } from "./ViewTabContextMenu";
export { AddViewButton } from "./AddViewButton";
export { CreateViewDialog } from "./CreateViewDialog";
export { ViewToolbar } from "./ViewToolbar";
export { ViewModeToggle } from "./ViewModeToggle";
export { SaveButton } from "./SaveButton";
export { SortButton } from "./SortButton";
export { ExportButton } from "./ExportButton";
export { ColumnSelectionModal } from "./ColumnSelectionModal";
export { PropertyPicker } from "./PropertyPicker";
export { SelectedColumnsList } from "./SelectedColumnsList";
```

  </action>
  <verify>npm run typecheck passes; npm run lint passes</verify>
  <done>ColumnSelectionModal with two-panel layout, search, drag-reorder, and frozen columns</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- ColumnSelectionModal displays with two-panel layout
- Left panel shows available columns grouped by category with search
- Right panel shows selected columns with drag handles for reordering
- Frozen columns dropdown allows 0-3 frozen columns
- Frozen columns are visually indicated (blue background)
- First column (Name) shows lock icon and cannot be removed
- Apply button saves changes; Cancel discards them
- Remove All Columns clears all except locked column
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-06-SUMMARY.md`
</output>
