---
phase: 13-hubspot-style-saved-views-system
plan: 05
type: execute
wave: 2
depends_on: ["13-03"]
files_modified:
  - apps/frontend/src/components/views/ViewToolbar.tsx
  - apps/frontend/src/components/views/ViewModeToggle.tsx
  - apps/frontend/src/components/views/SaveButton.tsx
  - apps/frontend/src/components/views/ExportButton.tsx
  - apps/frontend/src/components/views/SortButton.tsx
  - apps/frontend/src/components/views/index.ts
autonomous: true

must_haves:
  truths:
    - "Toolbar includes search box, view mode toggle, Edit columns, Filter, Sort, Export, Save buttons"
    - "Save button is disabled when no unsaved changes exist"
    - "Filter button shows count of active filters"
    - "View mode toggle switches between Table and Board views"
  artifacts:
    - path: "apps/frontend/src/components/views/ViewToolbar.tsx"
      provides: "Horizontal toolbar row with all action buttons"
      contains: "ViewToolbar"
    - path: "apps/frontend/src/components/views/SaveButton.tsx"
      provides: "Save button that enables when changes exist"
      contains: "hasUnsavedChanges"
  key_links:
    - from: "ViewToolbar"
      to: "SavedViewContext"
      via: "useSavedViewContext"
      pattern: "useSavedViewContext"
---

<objective>
Create the ViewToolbar component (Zone 2) with search, buttons, and action controls.

Purpose: The toolbar provides quick access to search, column editing, filtering, sorting, exporting, and saving views. It's the command center for view operations.

Output: ViewToolbar with search box, view mode toggle, Edit columns, Filter, Sort, Export, and Save buttons.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@apps/frontend/src/components/views/SavedViewProvider.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ViewModeToggle component</name>
  <files>apps/frontend/src/components/views/ViewModeToggle.tsx</files>
  <action>
Create the view mode toggle:

```typescript
'use client';

import React from 'react';
import { Table2, Kanban } from 'lucide-react';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { ViewMode } from '@/lib/views/types';

export function ViewModeToggle() {
  const { config, viewMode, setViewMode } = useSavedViewContext();

  // Only show toggle if board view is configured
  if (!config.boardConfig) {
    return null;
  }

  return (
    <Select value={viewMode} onValueChange={(v) => setViewMode(v as ViewMode)}>
      <SelectTrigger className="w-[130px] h-9">
        <SelectValue />
      </SelectTrigger>
      <SelectContent>
        <SelectItem value="table">
          <div className="flex items-center gap-2">
            <Table2 className="h-4 w-4" />
            Table view
          </div>
        </SelectItem>
        <SelectItem value="board">
          <div className="flex items-center gap-2">
            <Kanban className="h-4 w-4" />
            Board view
          </div>
        </SelectItem>
      </SelectContent>
    </Select>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>ViewModeToggle component created with Table/Board options</done>
</task>

<task type="auto">
  <name>Task 2: Create SaveButton, SortButton, and ExportButton components</name>
  <files>apps/frontend/src/components/views/SaveButton.tsx, apps/frontend/src/components/views/SortButton.tsx, apps/frontend/src/components/views/ExportButton.tsx</files>
  <action>
Create SaveButton:

```typescript
// apps/frontend/src/components/views/SaveButton.tsx
'use client';

import React, { useState } from 'react';
import { Save, ChevronDown } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { CreateViewDialog } from './CreateViewDialog';
import { toast } from 'sonner';

export function SaveButton() {
  const { hasUnsavedChanges, activeView, saveView } = useSavedViewContext();
  const [createOpen, setCreateOpen] = useState(false);
  const [isSaving, setIsSaving] = useState(false);

  const handleSave = async () => {
    setIsSaving(true);
    try {
      await saveView();
      toast.success('View saved');
    } catch (error) {
      toast.error('Failed to save view');
    } finally {
      setIsSaving(false);
    }
  };

  // If no active view, show "Save as new view"
  if (!activeView) {
    return (
      <>
        <Button
          variant="outline"
          size="sm"
          disabled={!hasUnsavedChanges}
          onClick={() => setCreateOpen(true)}
        >
          <Save className="h-4 w-4 mr-2" />
          Save view
        </Button>
        <CreateViewDialog open={createOpen} onOpenChange={setCreateOpen} />
      </>
    );
  }

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button
            variant={hasUnsavedChanges ? 'default' : 'outline'}
            size="sm"
            disabled={!hasUnsavedChanges && !activeView}
          >
            <Save className="h-4 w-4 mr-2" />
            Save
            <ChevronDown className="h-4 w-4 ml-1" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="end">
          <DropdownMenuItem onClick={handleSave} disabled={!hasUnsavedChanges || isSaving}>
            Save changes
          </DropdownMenuItem>
          <DropdownMenuItem onClick={() => setCreateOpen(true)}>
            Save as new view...
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
      <CreateViewDialog open={createOpen} onOpenChange={setCreateOpen} />
    </>
  );
}
```

Create SortButton:

```typescript
// apps/frontend/src/components/views/SortButton.tsx
'use client';

import React from 'react';
import { ArrowUpDown, ArrowUp, ArrowDown, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Label } from '@/components/ui/label';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { SortOrder } from '@/lib/views/types';

export function SortButton() {
  const { config, sortBy, sortOrder, setSort } = useSavedViewContext();

  const sortableColumns = config.columns.filter((c) => c.sortable);
  const activeColumn = sortBy ? config.columns.find((c) => c.id === sortBy) : null;

  const handleColumnChange = (columnId: string) => {
    if (columnId === 'none') {
      setSort(null, 'asc');
    } else {
      setSort(columnId, sortOrder);
    }
  };

  const handleOrderChange = (order: SortOrder) => {
    if (sortBy) {
      setSort(sortBy, order);
    }
  };

  const clearSort = () => {
    setSort(null, 'asc');
  };

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button variant="outline" size="sm">
          {sortBy ? (
            sortOrder === 'asc' ? (
              <ArrowUp className="h-4 w-4 mr-2" />
            ) : (
              <ArrowDown className="h-4 w-4 mr-2" />
            )
          ) : (
            <ArrowUpDown className="h-4 w-4 mr-2" />
          )}
          Sort
          {activeColumn && (
            <span className="ml-1 text-muted-foreground">
              : {activeColumn.header}
            </span>
          )}
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-64" align="end">
        <div className="space-y-4">
          <div>
            <Label>Sort by</Label>
            <Select value={sortBy || 'none'} onValueChange={handleColumnChange}>
              <SelectTrigger className="mt-1.5">
                <SelectValue placeholder="Select column" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="none">None</SelectItem>
                {sortableColumns.map((col) => (
                  <SelectItem key={col.id} value={col.id}>
                    {col.header}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>

          {sortBy && (
            <div>
              <Label>Direction</Label>
              <div className="flex gap-2 mt-1.5">
                <Button
                  variant={sortOrder === 'asc' ? 'default' : 'outline'}
                  size="sm"
                  className="flex-1"
                  onClick={() => handleOrderChange('asc')}
                >
                  <ArrowUp className="h-4 w-4 mr-1" />
                  Ascending
                </Button>
                <Button
                  variant={sortOrder === 'desc' ? 'default' : 'outline'}
                  size="sm"
                  className="flex-1"
                  onClick={() => handleOrderChange('desc')}
                >
                  <ArrowDown className="h-4 w-4 mr-1" />
                  Descending
                </Button>
              </div>
            </div>
          )}

          {sortBy && (
            <Button
              variant="ghost"
              size="sm"
              className="w-full"
              onClick={clearSort}
            >
              <X className="h-4 w-4 mr-2" />
              Clear sort
            </Button>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}
```

Create ExportButton:

```typescript
// apps/frontend/src/components/views/ExportButton.tsx
'use client';

import React, { useState } from 'react';
import { Download, FileSpreadsheet, FileText } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { api } from '@/lib/api';
import { toast } from 'sonner';

export function ExportButton() {
  const { config, filters, sortBy, sortOrder, visibleColumns } = useSavedViewContext();
  const [isExporting, setIsExporting] = useState(false);

  const handleExport = async (format: 'xlsx' | 'csv') => {
    setIsExporting(true);
    try {
      const response = await api.post(
        config.endpoints.export,
        {
          format,
          filters,
          sortBy,
          sortOrder,
          columns: visibleColumns,
        },
        { responseType: 'blob' }
      );

      // Create download link
      const blob = new Blob([response.data], {
        type: format === 'xlsx'
          ? 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
          : 'text/csv',
      });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${config.entityName.plural.toLowerCase()}-export.${format}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);

      toast.success('Export downloaded');
    } catch (error) {
      toast.error('Export failed');
    } finally {
      setIsExporting(false);
    }
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="outline" size="sm" disabled={isExporting}>
          <Download className="h-4 w-4 mr-2" />
          {isExporting ? 'Exporting...' : 'Export'}
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end">
        <DropdownMenuItem onClick={() => handleExport('xlsx')}>
          <FileSpreadsheet className="h-4 w-4 mr-2" />
          Export to Excel (.xlsx)
        </DropdownMenuItem>
        <DropdownMenuItem onClick={() => handleExport('csv')}>
          <FileText className="h-4 w-4 mr-2" />
          Export to CSV (.csv)
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>SaveButton, SortButton, and ExportButton components created</done>
</task>

<task type="auto">
  <name>Task 3: Create ViewToolbar component</name>
  <files>apps/frontend/src/components/views/ViewToolbar.tsx</files>
  <action>
Create the main ViewToolbar component:

```typescript
'use client';

import React, { useState } from 'react';
import { Search, Columns, Filter, Copy, Settings } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { ViewModeToggle } from './ViewModeToggle';
import { SaveButton } from './SaveButton';
import { SortButton } from './SortButton';
import { ExportButton } from './ExportButton';
import { useDebounce } from '@/hooks/useDebounce';

interface ViewToolbarProps {
  onEditColumnsClick: () => void;
  onFilterClick: () => void;
  filterCount: number;
  showFilters: boolean;
}

export function ViewToolbar({
  onEditColumnsClick,
  onFilterClick,
  filterCount,
  showFilters,
}: ViewToolbarProps) {
  const {
    searchQuery,
    setSearchQuery,
    duplicateView,
    activeView,
  } = useSavedViewContext();

  const [localSearch, setLocalSearch] = useState(searchQuery);

  // Debounce search input
  useDebounce(
    () => {
      setSearchQuery(localSearch);
    },
    300,
    [localSearch]
  );

  const handleDuplicate = async () => {
    if (activeView) {
      await duplicateView(activeView.id);
    }
  };

  return (
    <div className="flex items-center gap-2 p-2 border-b bg-background">
      {/* Search box */}
      <div className="relative flex-1 max-w-sm">
        <Search className="absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
        <Input
          placeholder="Search..."
          value={localSearch}
          onChange={(e) => setLocalSearch(e.target.value)}
          className="pl-9 h-9"
        />
      </div>

      {/* View mode toggle */}
      <ViewModeToggle />

      {/* Settings gear (placeholder for future) */}
      <Button variant="ghost" size="icon" className="h-9 w-9">
        <Settings className="h-4 w-4" />
      </Button>

      <div className="h-6 w-px bg-border mx-1" />

      {/* Edit Columns button */}
      <Button variant="outline" size="sm" onClick={onEditColumnsClick}>
        <Columns className="h-4 w-4 mr-2" />
        Edit columns
      </Button>

      {/* Filter button */}
      <Button
        variant={showFilters ? 'default' : 'outline'}
        size="sm"
        onClick={onFilterClick}
      >
        <Filter className="h-4 w-4 mr-2" />
        Filter
        {filterCount > 0 && (
          <Badge variant="secondary" className="ml-1.5 h-5 px-1.5">
            {filterCount}
          </Badge>
        )}
      </Button>

      {/* Sort button */}
      <SortButton />

      <div className="h-6 w-px bg-border mx-1" />

      {/* Export button */}
      <ExportButton />

      {/* Duplicate button */}
      {activeView && (
        <Button variant="ghost" size="icon" className="h-9 w-9" onClick={handleDuplicate}>
          <Copy className="h-4 w-4" />
        </Button>
      )}

      {/* Save button */}
      <SaveButton />
    </div>
  );
}
```

Also create a simple useDebounce hook if not exists:

```typescript
// apps/frontend/src/hooks/useDebounce.ts (if not exists, add this)
import { useEffect, useRef } from "react";

export function useDebounce(
  callback: () => void,
  delay: number,
  dependencies: unknown[],
) {
  const timeoutRef = useRef<NodeJS.Timeout>();

  useEffect(() => {
    timeoutRef.current = setTimeout(callback, delay);
    return () => {
      if (timeoutRef.current) {
        clearTimeout(timeoutRef.current);
      }
    };
  }, dependencies);
}
```

Update exports:

```typescript
// apps/frontend/src/components/views/index.ts
export { SavedViewProvider, SavedViewContext } from "./SavedViewProvider";
export type { SavedViewContextValue } from "./SavedViewProvider";
export { ViewTabsBar } from "./ViewTabsBar";
export { SortableViewTab } from "./SortableViewTab";
export { ViewTabContextMenu } from "./ViewTabContextMenu";
export { AddViewButton } from "./AddViewButton";
export { CreateViewDialog } from "./CreateViewDialog";
export { ViewToolbar } from "./ViewToolbar";
export { ViewModeToggle } from "./ViewModeToggle";
export { SaveButton } from "./SaveButton";
export { SortButton } from "./SortButton";
export { ExportButton } from "./ExportButton";
```

  </action>
  <verify>npm run typecheck passes; npm run lint passes</verify>
  <done>ViewToolbar component with all buttons and search box</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- ViewToolbar renders horizontal bar with all action buttons
- Search box with magnifying glass icon and debounced input
- View mode toggle shows Table/Board options (only when board configured)
- Edit columns button triggers onEditColumnsClick callback
- Filter button shows count badge when filters active
- Sort button shows current sort column and direction
- Export button offers Excel/CSV download options
- Save button disabled when no unsaved changes, enabled when dirty
- Duplicate button copies current view
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-05-SUMMARY.md`
</output>
