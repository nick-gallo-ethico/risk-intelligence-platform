---
phase: 13-hubspot-style-saved-views-system
plan: 11
type: execute
wave: 4
depends_on:
  [
    "13-01",
    "13-03",
    "13-04",
    "13-05",
    "13-06",
    "13-07",
    "13-08",
    "13-09",
    "13-10",
  ]
files_modified:
  - apps/frontend/src/lib/views/configs/cases.config.ts
  - apps/frontend/src/app/(authenticated)/cases/page.tsx
  - apps/frontend/src/hooks/views/useCasesView.ts
autonomous: true

must_haves:
  truths:
    - "Cases page uses SavedViewProvider with cases config"
    - "Cases config defines all columns (name, status, category, assignee, priority, dates)"
    - "Cases has default views: All Cases, My Cases, Open Cases, Recently Created"
    - "Cases bulk actions: Assign, Change Status, Export, Delete"
    - "Cases board view groups by case status"
  artifacts:
    - path: "apps/frontend/src/lib/views/configs/cases.config.ts"
      provides: "ModuleViewConfig for Cases module"
      contains: "CASES_VIEW_CONFIG"
    - path: "apps/frontend/src/app/(authenticated)/cases/page.tsx"
      provides: "Cases page using saved views system"
      contains: "SavedViewProvider"
  key_links:
    - from: "CasesPage"
      to: "SavedViewProvider"
      via: "CASES_VIEW_CONFIG"
      pattern: "moduleType: 'cases'"
---

<objective>
Integrate the saved views system into the Cases module as the first pillar implementation.

Purpose: Cases is the primary module and serves as the template for other module integrations. This plan creates the Cases view configuration and updates the Cases page to use the new saved views system.

Output: Cases page with full saved views functionality including table/board views, filters, and column selection.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@apps/frontend/src/lib/views/types.ts
@apps/frontend/src/lib/views/view-config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cases view configuration</name>
  <files>apps/frontend/src/lib/views/configs/cases.config.ts</files>
  <action>
Create the complete Cases module view configuration:

```typescript
import {
  Calendar,
  User,
  Tag,
  AlertCircle,
  Clock,
  Building2,
  Hash,
} from "lucide-react";
import {
  ModuleViewConfig,
  ColumnConfig,
  PropertyGroup,
  BulkAction,
} from "../types";

// Case status options with colors
const CASE_STATUSES = [
  { value: "open", label: "Open", color: "#3B82F6" },
  { value: "in_progress", label: "In Progress", color: "#F59E0B" },
  { value: "pending_review", label: "Pending Review", color: "#8B5CF6" },
  { value: "closed", label: "Closed", color: "#10B981" },
  { value: "archived", label: "Archived", color: "#6B7280" },
];

const CASE_PRIORITIES = [
  { value: "low", label: "Low", color: "#10B981" },
  { value: "medium", label: "Medium", color: "#F59E0B" },
  { value: "high", label: "High", color: "#EF4444" },
  { value: "critical", label: "Critical", color: "#DC2626" },
];

const CASE_CATEGORIES = [
  { value: "harassment", label: "Harassment" },
  { value: "discrimination", label: "Discrimination" },
  { value: "fraud", label: "Fraud" },
  { value: "theft", label: "Theft" },
  { value: "conflict_of_interest", label: "Conflict of Interest" },
  { value: "safety", label: "Safety Violation" },
  { value: "policy_violation", label: "Policy Violation" },
  { value: "other", label: "Other" },
];

// Column definitions
const CASES_COLUMNS: ColumnConfig[] = [
  // Core fields
  {
    id: "caseNumber",
    accessorKey: "caseNumber",
    header: "Case #",
    type: "link",
    group: "core",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 120,
  },
  {
    id: "title",
    accessorKey: "title",
    header: "Title",
    type: "text",
    group: "core",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 250,
  },
  {
    id: "status",
    accessorKey: "status",
    header: "Status",
    type: "select",
    group: "core",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    options: CASE_STATUSES,
    width: 130,
  },
  {
    id: "priority",
    accessorKey: "priority",
    header: "Priority",
    type: "select",
    group: "core",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    options: CASE_PRIORITIES,
    width: 100,
  },
  {
    id: "category",
    accessorKey: "category",
    header: "Category",
    type: "select",
    group: "core",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    options: CASE_CATEGORIES,
    width: 150,
  },

  // Assignment
  {
    id: "assignee",
    accessorKey: "assignee.name",
    header: "Assignee",
    type: "user",
    group: "assignment",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    options: [], // Populated dynamically from team members
    width: 150,
  },
  {
    id: "team",
    accessorKey: "team.name",
    header: "Team",
    type: "select",
    group: "assignment",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    options: [], // Populated dynamically
    width: 120,
  },

  // Dates
  {
    id: "createdAt",
    accessorKey: "createdAt",
    header: "Created Date",
    type: "datetime",
    group: "dates",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    width: 150,
  },
  {
    id: "updatedAt",
    accessorKey: "updatedAt",
    header: "Last Updated",
    type: "datetime",
    group: "dates",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 150,
  },
  {
    id: "dueDate",
    accessorKey: "dueDate",
    header: "Due Date",
    type: "date",
    group: "dates",
    sortable: true,
    filterable: true,
    quickFilterable: true,
    width: 120,
  },
  {
    id: "closedAt",
    accessorKey: "closedAt",
    header: "Closed Date",
    type: "datetime",
    group: "dates",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 150,
  },

  // Source
  {
    id: "sourceChannel",
    accessorKey: "sourceChannel",
    header: "Source",
    type: "select",
    group: "source",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    options: [
      { value: "hotline", label: "Hotline" },
      { value: "web_form", label: "Web Form" },
      { value: "email", label: "Email" },
      { value: "chatbot", label: "Chatbot" },
      { value: "manager", label: "Manager Report" },
    ],
    width: 120,
  },
  {
    id: "businessUnit",
    accessorKey: "businessUnit.name",
    header: "Business Unit",
    type: "select",
    group: "organization",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    options: [], // Populated dynamically
    width: 150,
  },
  {
    id: "location",
    accessorKey: "location",
    header: "Location",
    type: "text",
    group: "organization",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 150,
  },

  // Investigation
  {
    id: "investigationsCount",
    accessorKey: "investigationsCount",
    header: "Investigations",
    type: "number",
    group: "investigation",
    sortable: true,
    filterable: false,
    quickFilterable: false,
    width: 100,
  },
  {
    id: "hasOpenInvestigation",
    accessorKey: "hasOpenInvestigation",
    header: "Active Investigation",
    type: "boolean",
    group: "investigation",
    sortable: false,
    filterable: true,
    quickFilterable: false,
    width: 120,
  },

  // AI
  {
    id: "aiSummary",
    accessorKey: "aiSummary",
    header: "AI Summary",
    type: "text",
    group: "ai",
    sortable: false,
    filterable: false,
    quickFilterable: false,
    width: 300,
  },
  {
    id: "aiRiskScore",
    accessorKey: "aiRiskScore",
    header: "Risk Score",
    type: "number",
    group: "ai",
    sortable: true,
    filterable: true,
    quickFilterable: false,
    width: 100,
  },
];

// Property groups for column selection
const CASES_PROPERTY_GROUPS: PropertyGroup[] = [
  { id: "core", label: "Core Fields" },
  { id: "assignment", label: "Assignment" },
  { id: "dates", label: "Dates" },
  { id: "source", label: "Source" },
  { id: "organization", label: "Organization" },
  { id: "investigation", label: "Investigation" },
  { id: "ai", label: "AI Enrichment" },
];

// Bulk actions
const CASES_BULK_ACTIONS: BulkAction[] = [
  {
    id: "assign",
    label: "Assign",
    children: [], // Populated dynamically with team members
  },
  {
    id: "status",
    label: "Change Status",
    children: CASE_STATUSES.map((s) => ({
      id: `status-${s.value}`,
      label: s.label,
    })),
  },
  {
    id: "priority",
    label: "Set Priority",
    children: CASE_PRIORITIES.map((p) => ({
      id: `priority-${p.value}`,
      label: p.label,
    })),
  },
  {
    id: "export",
    label: "Export Selected",
  },
  {
    id: "delete",
    label: "Delete",
    destructive: true,
  },
];

// Default views
const CASES_DEFAULT_VIEWS = [
  {
    name: "All Cases",
    columns: [
      "caseNumber",
      "title",
      "status",
      "priority",
      "category",
      "assignee",
      "createdAt",
    ],
    filters: [],
    sort: { column: "createdAt", direction: "desc" as const },
  },
  {
    name: "My Cases",
    columns: [
      "caseNumber",
      "title",
      "status",
      "priority",
      "dueDate",
      "updatedAt",
    ],
    filters: [
      {
        id: "my-cases-filter",
        conditions: [
          {
            id: "1",
            propertyId: "assignee",
            operator: "is" as const,
            value: "{{currentUserId}}",
          },
        ],
      },
    ],
    sort: { column: "updatedAt", direction: "desc" as const },
  },
  {
    name: "Open Cases",
    columns: [
      "caseNumber",
      "title",
      "priority",
      "category",
      "assignee",
      "createdAt",
      "dueDate",
    ],
    filters: [
      {
        id: "open-cases-filter",
        conditions: [
          {
            id: "1",
            propertyId: "status",
            operator: "is_any_of" as const,
            value: ["open", "in_progress"],
          },
        ],
      },
    ],
    sort: { column: "priority", direction: "desc" as const },
  },
  {
    name: "High Priority",
    columns: [
      "caseNumber",
      "title",
      "status",
      "assignee",
      "dueDate",
      "createdAt",
    ],
    filters: [
      {
        id: "high-priority-filter",
        conditions: [
          {
            id: "1",
            propertyId: "priority",
            operator: "is_any_of" as const,
            value: ["high", "critical"],
          },
        ],
      },
    ],
    sort: { column: "createdAt", direction: "desc" as const },
  },
];

// Complete Cases module config
export const CASES_VIEW_CONFIG: ModuleViewConfig = {
  moduleType: "cases",
  entityName: {
    singular: "Case",
    plural: "Cases",
  },
  columns: CASES_COLUMNS,
  propertyGroups: CASES_PROPERTY_GROUPS,
  defaultColumns: [
    "caseNumber",
    "title",
    "status",
    "priority",
    "category",
    "assignee",
    "createdAt",
  ],
  defaultQuickFilters: ["status", "priority", "assignee", "createdAt"],
  bulkActions: CASES_BULK_ACTIONS,
  defaultViews: CASES_DEFAULT_VIEWS,
  endpoints: {
    list: "/api/cases",
    export: "/api/cases/export",
    bulk: "/api/cases/bulk",
  },
  boardConfig: {
    defaultGroupBy: "status",
    columns: CASE_STATUSES.map((s) => ({
      id: s.value,
      label: s.label,
      color: s.color,
    })),
    cardConfig: {
      titleField: "title",
      subtitleField: "caseNumber",
      priorityField: "priority",
      ownerField: "assignee.name",
      dateField: "createdAt",
      displayFields: [{ key: "category", type: "text", icon: Tag }],
    },
  },
};
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>Cases view configuration with columns, filters, bulk actions, and board config</done>
</task>

<task type="auto">
  <name>Task 2: Create useCasesView hook</name>
  <files>apps/frontend/src/hooks/views/useCasesView.ts</files>
  <action>
Create a hook for Cases-specific view logic:

```typescript
import { useMemo, useCallback } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { api } from "@/lib/api";
import { CASES_VIEW_CONFIG } from "@/lib/views/configs/cases.config";
import { useSavedViewContext } from "./useSavedViewContext";
import { toast } from "sonner";

interface Case {
  id: string;
  caseNumber: string;
  title: string;
  status: string;
  priority: string;
  category: string;
  assignee?: {
    id: string;
    name: string;
    avatar?: string;
  };
  team?: {
    id: string;
    name: string;
  };
  createdAt: string;
  updatedAt: string;
  dueDate?: string;
  closedAt?: string;
  sourceChannel?: string;
  businessUnit?: {
    id: string;
    name: string;
  };
  location?: string;
  investigationsCount: number;
  hasOpenInvestigation: boolean;
  aiSummary?: string;
  aiRiskScore?: number;
}

interface CasesResponse {
  data: Case[];
  total: number;
  page: number;
  pageSize: number;
}

export function useCasesView() {
  const queryClient = useQueryClient();
  const { filters, quickFilters, searchQuery, sortBy, sortOrder, viewMode } =
    useSavedViewContext();

  // Build query params from view state
  const queryParams = useMemo(() => {
    const params: Record<string, unknown> = {};

    // Search
    if (searchQuery) {
      params.search = searchQuery;
    }

    // Sort
    if (sortBy) {
      params.sortBy = sortBy;
      params.sortOrder = sortOrder;
    }

    // Filters
    const allConditions = [
      ...filters.flatMap((g) => g.conditions),
      ...quickFilters.filter((qf) => qf.condition).map((qf) => qf.condition!),
    ];

    if (allConditions.length > 0) {
      params.filters = JSON.stringify(allConditions);
    }

    return params;
  }, [filters, quickFilters, searchQuery, sortBy, sortOrder]);

  // Fetch cases
  const {
    data: casesData,
    isLoading,
    error,
    refetch,
  } = useQuery<CasesResponse>({
    queryKey: ["cases", queryParams],
    queryFn: async () => {
      const response = await api.get("/api/cases", { params: queryParams });
      return response.data;
    },
  });

  // Bulk status change mutation
  const statusMutation = useMutation({
    mutationFn: async ({ ids, status }: { ids: string[]; status: string }) => {
      await api.post("/api/cases/bulk", {
        action: "status",
        ids,
        data: { status },
      });
    },
    onSuccess: () => {
      toast.success("Cases updated");
      queryClient.invalidateQueries({ queryKey: ["cases"] });
    },
    onError: () => {
      toast.error("Failed to update cases");
    },
  });

  // Bulk assign mutation
  const assignMutation = useMutation({
    mutationFn: async ({
      ids,
      assigneeId,
    }: {
      ids: string[];
      assigneeId: string;
    }) => {
      await api.post("/api/cases/bulk", {
        action: "assign",
        ids,
        data: { assigneeId },
      });
    },
    onSuccess: () => {
      toast.success("Cases assigned");
      queryClient.invalidateQueries({ queryKey: ["cases"] });
    },
    onError: () => {
      toast.error("Failed to assign cases");
    },
  });

  // Bulk delete mutation
  const deleteMutation = useMutation({
    mutationFn: async (ids: string[]) => {
      await api.post("/api/cases/bulk", {
        action: "delete",
        ids,
      });
    },
    onSuccess: () => {
      toast.success("Cases deleted");
      queryClient.invalidateQueries({ queryKey: ["cases"] });
    },
    onError: () => {
      toast.error("Failed to delete cases");
    },
  });

  // Handle bulk actions
  const handleBulkAction = useCallback(
    (actionId: string, selectedIds: string[]) => {
      if (actionId === "export") {
        // Handle export
        window.open(`/api/cases/export?ids=${selectedIds.join(",")}`, "_blank");
        return;
      }

      if (actionId === "delete") {
        // Confirm before delete
        if (confirm(`Delete ${selectedIds.length} case(s)?`)) {
          deleteMutation.mutate(selectedIds);
        }
        return;
      }

      // Status changes
      if (actionId.startsWith("status-")) {
        const status = actionId.replace("status-", "");
        statusMutation.mutate({ ids: selectedIds, status });
        return;
      }

      // Priority changes
      if (actionId.startsWith("priority-")) {
        const priority = actionId.replace("priority-", "");
        statusMutation.mutate({ ids: selectedIds, status: priority }); // TODO: use priority mutation
        return;
      }

      // Assignment
      if (actionId.startsWith("assign-")) {
        const assigneeId = actionId.replace("assign-", "");
        assignMutation.mutate({ ids: selectedIds, assigneeId });
        return;
      }
    },
    [statusMutation, assignMutation, deleteMutation],
  );

  // Handle status change from board drag-and-drop
  const handleStatusChange = useCallback(
    (caseId: string, newStatus: string) => {
      statusMutation.mutate({ ids: [caseId], status: newStatus });
    },
    [statusMutation],
  );

  return {
    config: CASES_VIEW_CONFIG,
    cases: casesData?.data || [],
    totalRecords: casesData?.total || 0,
    isLoading,
    error,
    refetch,
    handleBulkAction,
    handleStatusChange,
  };
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>useCasesView hook with data fetching and bulk action handlers</done>
</task>

<task type="auto">
  <name>Task 3: Update Cases page to use saved views</name>
  <files>apps/frontend/src/app/(authenticated)/cases/page.tsx</files>
  <action>
Update the Cases page to use the saved views system:

```typescript
'use client';

import React, { useState, useCallback } from 'react';
import { useRouter } from 'next/navigation';
import {
  SavedViewProvider,
  ViewTabsBar,
  ViewToolbar,
  QuickFiltersRow,
  ColumnSelectionModal,
  AdvancedFiltersPanel,
  DataTable,
  BoardView,
} from '@/components/views';
import { CASES_VIEW_CONFIG } from '@/lib/views/configs/cases.config';
import { useCasesView } from '@/hooks/views/useCasesView';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';

function CasesPageContent() {
  const router = useRouter();
  const {
    cases,
    totalRecords,
    isLoading,
    handleBulkAction,
    handleStatusChange,
  } = useCasesView();

  const { viewMode, filters, quickFilters } = useSavedViewContext();

  // UI state
  const [showFilters, setShowFilters] = useState(false);
  const [showColumnModal, setShowColumnModal] = useState(false);
  const [showAdvancedFilters, setShowAdvancedFilters] = useState(false);

  // Pagination state
  const [currentPage, setCurrentPage] = useState(1);
  const [pageSize, setPageSize] = useState(25);

  // Count active filters
  const quickFilterCount = quickFilters.filter((qf) => qf.condition).length;
  const advancedFilterCount = filters.reduce((sum, g) => sum + g.conditions.length, 0);
  const totalFilterCount = quickFilterCount + advancedFilterCount;

  const handleRowClick = useCallback(
    (caseRecord: (typeof cases)[0]) => {
      router.push(`/cases/${caseRecord.id}`);
    },
    [router]
  );

  const handlePageChange = useCallback((page: number) => {
    setCurrentPage(page);
  }, []);

  const handlePageSizeChange = useCallback((size: number) => {
    setPageSize(size);
    setCurrentPage(1); // Reset to first page
  }, []);

  return (
    <div className="flex flex-col h-full">
      {/* Zone 1: View Tabs */}
      <ViewTabsBar />

      {/* Zone 2: Toolbar */}
      <ViewToolbar
        onEditColumnsClick={() => setShowColumnModal(true)}
        onFilterClick={() => setShowFilters(!showFilters)}
        filterCount={totalFilterCount}
        showFilters={showFilters}
      />

      {/* Zone 3: Quick Filters (conditional) */}
      {showFilters && (
        <QuickFiltersRow
          onAdvancedFiltersClick={() => setShowAdvancedFilters(true)}
          advancedFilterCount={advancedFilterCount}
        />
      )}

      {/* Zone 4: Data Table or Board */}
      <div className="flex-1 min-h-0">
        {viewMode === 'table' ? (
          <DataTable
            data={cases}
            isLoading={isLoading}
            totalRecords={totalRecords}
            currentPage={currentPage}
            pageSize={pageSize}
            onPageChange={handlePageChange}
            onPageSizeChange={handlePageSizeChange}
            onRowClick={handleRowClick}
            onBulkAction={handleBulkAction}
            getRowId={(row) => row.id}
            emptyMessage="No cases match your current filters"
          />
        ) : (
          <BoardView
            data={cases}
            isLoading={isLoading}
            onRecordClick={handleRowClick}
            onStatusChange={handleStatusChange}
            getRecordId={(row) => row.id}
            emptyMessage="No cases match your current filters"
          />
        )}
      </div>

      {/* Modals and Panels */}
      <ColumnSelectionModal
        open={showColumnModal}
        onOpenChange={setShowColumnModal}
      />
      <AdvancedFiltersPanel
        open={showAdvancedFilters}
        onOpenChange={setShowAdvancedFilters}
      />
    </div>
  );
}

export default function CasesPage() {
  return (
    <SavedViewProvider moduleType="cases" config={CASES_VIEW_CONFIG}>
      <CasesPageContent />
    </SavedViewProvider>
  );
}
```

  </action>
  <verify>npm run typecheck passes; npm run lint passes</verify>
  <done>Cases page with full saved views integration</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- Cases page renders with SavedViewProvider wrapping content
- View tabs bar shows saved views with add/reorder/context menu
- Toolbar has all action buttons (search, columns, filter, sort, export, save)
- Quick filters row appears when filter button is toggled
- Column selection modal allows adding/removing/reordering columns
- Advanced filters panel slides out with AND/OR filter groups
- DataTable renders cases with sorting, selection, and pagination
- BoardView renders cases as draggable cards in status lanes
- Bulk actions work for selected rows (assign, status, export, delete)
- View mode toggle switches between table and board views
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-11-SUMMARY.md`
</output>
