---
phase: 13-hubspot-style-saved-views-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/saved-views/dto/saved-view.dto.ts
  - apps/backend/src/modules/saved-views/saved-views.service.ts
  - apps/backend/src/modules/saved-views/saved-views.controller.ts
autonomous: true

must_haves:
  truths:
    - "SavedView model has frozenColumnCount, viewMode, boardGroupBy, recordCount fields"
    - "API returns recordCount for each view in list response"
    - "Clone endpoint creates duplicate view with (copy) suffix"
    - "Reorder endpoint updates displayOrder for multiple views in one transaction"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Extended SavedView model"
      contains: "frozenColumnCount"
    - path: "apps/backend/src/modules/saved-views/dto/saved-view.dto.ts"
      provides: "DTOs for new fields and endpoints"
      contains: "class CloneSavedViewDto"
  key_links:
    - from: "SavedView model"
      to: "SavedViewsService"
      via: "Prisma client"
      pattern: "prisma.savedView"
---

<objective>
Extend the backend SavedView infrastructure to support the full HubSpot-style saved views feature set.

Purpose: The existing Phase 6 SavedView model lacks fields needed for HubSpot-style views (frozen columns, view mode, board grouping, record counts). This plan adds those fields and enhances the API.

Output: Extended SavedView model, enhanced DTOs, and complete CRUD API with clone/reorder endpoints.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@apps/backend/src/modules/saved-views/saved-views.service.ts
@apps/backend/src/modules/saved-views/dto/saved-view.dto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SavedView Prisma model with new fields</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following fields to the SavedView model:

```prisma
// Add these fields to SavedView model after the existing 'columns' field:
frozenColumnCount Int      @default(0) @map("frozen_column_count") // 0-3 frozen columns
viewMode          String   @default("table") @map("view_mode") // 'table' | 'board'
boardGroupBy      String?  @map("board_group_by") // Property to group by in board view
recordCount       Int?     @map("record_count") // Cached count of matching records
recordCountAt     DateTime? @map("record_count_at") // When count was last updated
```

Run Prisma generate after schema update. Do NOT run migrate since we're using baseline migrations.
</action>
<verify>npx prisma generate succeeds; TypeScript can import the new fields from @prisma/client</verify>
<done>SavedView model has frozenColumnCount, viewMode, boardGroupBy, recordCount, recordCountAt fields</done>
</task>

<task type="auto">
  <name>Task 2: Update DTOs and interfaces for new fields</name>
  <files>apps/backend/src/modules/saved-views/dto/saved-view.dto.ts</files>
  <action>
Update the existing DTOs to include new fields:

1. Add to FilterCriteria interface:
   - groups: FilterGroup[] for advanced AND/OR filter groups

2. Add FilterGroup and FilterCondition interfaces:

```typescript
export interface FilterGroup {
  id: string;
  conditions: FilterCondition[]; // AND-joined
}

export interface FilterCondition {
  id: string;
  propertyId: string;
  operator: string;
  value?: unknown;
  secondaryValue?: unknown; // For 'is_between'
  unit?: "day" | "week" | "month"; // For relative dates
}
```

3. Add to CreateSavedViewDto:
   - frozenColumnCount: number (optional, @IsInt, @Min(0), @Max(3))
   - viewMode: string (optional, @IsString)
   - boardGroupBy: string (optional, @IsString)

4. Add to UpdateSavedViewDto: same fields as Create

5. Create CloneSavedViewDto:
   - newName: string (optional, @IsString)

6. Create ReorderSavedViewsDto:
   - viewOrders: { id: string; displayOrder: number }[] (required)

7. Update ApplyViewResponseDto to include new fields
   </action>
   <verify>npm run typecheck passes; new DTOs are properly exported</verify>
   <done>DTOs include frozenColumnCount, viewMode, boardGroupBy, FilterGroup, FilterCondition, CloneSavedViewDto, ReorderSavedViewsDto</done>
   </task>

<task type="auto">
  <name>Task 3: Enhance SavedViewsService with new methods and fields</name>
  <files>apps/backend/src/modules/saved-views/saved-views.service.ts</files>
  <action>
Enhance the existing service:

1. Update create() to handle new fields:
   - frozenColumnCount (default 0)
   - viewMode (default 'table')
   - boardGroupBy

2. Update update() to handle new fields

3. Add updateRecordCount() method:
   - Takes viewId and count
   - Updates recordCount and recordCountAt

4. Update findAll() to include recordCount in response

5. Verify duplicate() method handles all new fields (copy frozenColumnCount, viewMode, boardGroupBy)

6. Update validateFilters() to handle FilterGroup[] structure:
   - Iterate through groups and conditions
   - Validate each condition's propertyId and operator

7. Update applyView() to:
   - Return frozenColumnCount, viewMode, boardGroupBy
   - Track usage (already exists)
     </action>
     <verify>npm run typecheck passes; npm run lint passes</verify>
     <done>SavedViewsService handles all new fields and has updateRecordCount method</done>
     </task>

</tasks>

<verification>
```bash
cd apps/backend
npx prisma generate
npm run typecheck
npm run lint
npm test -- --testPathPattern="saved-views" --passWithNoTests
```
</verification>

<success_criteria>

- SavedView Prisma model includes all new fields (frozenColumnCount, viewMode, boardGroupBy, recordCount, recordCountAt)
- DTOs properly validate new fields with class-validator decorators
- Service methods handle new fields in create/update/apply operations
- TypeScript compiles without errors
- All new interfaces are exported from the module index
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-01-SUMMARY.md`
</output>
