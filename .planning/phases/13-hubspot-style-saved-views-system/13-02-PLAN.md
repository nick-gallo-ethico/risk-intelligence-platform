---
phase: 13-hubspot-style-saved-views-system
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/package.json
  - apps/frontend/src/lib/views/types.ts
  - apps/frontend/src/lib/views/operators.ts
  - apps/frontend/src/lib/views/constants.ts
  - apps/frontend/src/types/view-config.ts
autonomous: true

must_haves:
  truths:
    - "@tanstack/react-table is installed as a dependency"
    - "ModuleViewConfig type defines columns, quickFilters, bulkActions, boardConfig"
    - "Filter operators are defined for each property type (text, number, date, boolean, enum, user)"
    - "ColumnDefinition type includes type, group, sortable, filterable, defaultVisible"
  artifacts:
    - path: "apps/frontend/src/lib/views/types.ts"
      provides: "Core type definitions for view system"
      contains: "FilterGroup"
    - path: "apps/frontend/src/lib/views/operators.ts"
      provides: "Filter operator definitions by property type"
      contains: "OPERATORS_BY_TYPE"
    - path: "apps/frontend/src/types/view-config.ts"
      provides: "Module configuration types"
      contains: "ModuleViewConfig"
  key_links:
    - from: "ModuleViewConfig"
      to: "ColumnDefinition"
      via: "columns array"
      pattern: "columns: ColumnDefinition[]"
---

<objective>
Install @tanstack/react-table and establish the type system and constants for the reusable view system.

Purpose: The view system needs a consistent type system that all modules will use. TanStack Table provides headless table functionality with column visibility, sorting, and resizing.

Output: @tanstack/react-table installed, comprehensive TypeScript types for views, filter operators, and module configuration.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@.planning/phases/13-hubspot-style-saved-views-system/13-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @tanstack/react-table</name>
  <files>apps/frontend/package.json</files>
  <action>
Install @tanstack/react-table v8.x for headless table functionality:

```bash
cd apps/frontend && npm install @tanstack/react-table
```

This package provides:

- Column visibility management
- Sorting with multi-column support
- Column resizing
- Row selection
- Pagination helpers

Verify the package is added to package.json dependencies.
</action>
<verify>npm list @tanstack/react-table shows version 8.x installed</verify>
<done>@tanstack/react-table is installed as a dependency in apps/frontend/package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create core view system types</name>
  <files>apps/frontend/src/lib/views/types.ts</files>
  <action>
Create the types file with the following:

```typescript
// Core types for the saved views system

export type PropertyType =
  | "text"
  | "number"
  | "date"
  | "boolean"
  | "enum"
  | "user"
  | "status"
  | "severity";

export type ViewMode = "table" | "board";

export type SortOrder = "asc" | "desc";

export type ViewVisibility = "private" | "team" | "everyone";

// Filter types matching backend
export interface FilterGroup {
  id: string;
  conditions: FilterCondition[]; // AND-joined within group
}
// Groups are OR-joined with each other

export interface FilterCondition {
  id: string;
  propertyId: string;
  operator: FilterOperator;
  value?: unknown;
  secondaryValue?: unknown; // For 'is_between'
  unit?: "day" | "week" | "month"; // For relative dates
}

export type FilterOperator =
  // Text operators
  | "is"
  | "is_not"
  | "contains"
  | "does_not_contain"
  | "starts_with"
  | "ends_with"
  // Number operators
  | "is_equal_to"
  | "is_not_equal_to"
  | "is_greater_than"
  | "is_greater_than_or_equal_to"
  | "is_less_than"
  | "is_less_than_or_equal_to"
  | "is_between"
  // Date operators
  | "is_before"
  | "is_after"
  | "is_less_than_n_ago"
  | "is_more_than_n_ago"
  // Boolean operators
  | "is_true"
  | "is_false"
  // Multi-value operators
  | "is_any_of"
  | "is_none_of"
  // Null operators
  | "is_known"
  | "is_unknown";

// Column configuration
export interface ColumnConfig {
  key: string;
  visible: boolean;
  order: number;
  width?: number;
}

// Quick filter values
export type QuickFilterValue =
  | string
  | string[]
  | { from?: string; to?: string }
  | undefined;

// Saved view matching backend
export interface SavedView {
  id: string;
  organizationId: string;
  createdById: string;
  name: string;
  description?: string;
  entityType: ViewEntityType;
  filters: FilterGroup[];
  sortBy?: string;
  sortOrder?: SortOrder;
  columns?: ColumnConfig[];
  frozenColumnCount: number;
  viewMode: ViewMode;
  boardGroupBy?: string;
  isShared: boolean;
  sharedWithTeamId?: string;
  isDefault: boolean;
  isPinned: boolean;
  displayOrder: number;
  color?: string;
  recordCount?: number;
  recordCountAt?: string;
  lastUsedAt?: string;
  useCount: number;
  createdAt: string;
  updatedAt: string;
}

export type ViewEntityType =
  | "CASES"
  | "RIUS"
  | "INVESTIGATIONS"
  | "PERSONS"
  | "CAMPAIGNS"
  | "REMEDIATION_PLANS"
  | "DISCLOSURES"
  | "INTAKE_FORMS"
  | "POLICIES";

// Bulk action result
export interface BulkActionResult {
  success: boolean;
  affected: number;
  errors?: string[];
}
```

  </action>
  <verify>npm run typecheck passes in apps/frontend</verify>
  <done>Core types file exists with all filter, column, and view types</done>
</task>

<task type="auto">
  <name>Task 3: Create filter operators definitions</name>
  <files>apps/frontend/src/lib/views/operators.ts</files>
  <action>
Create operators file defining available operators per property type:

```typescript
import { PropertyType, FilterOperator } from "./types";

export interface OperatorOption {
  value: FilterOperator;
  label: string;
  requiresValue: boolean;
  requiresSecondaryValue?: boolean;
  requiresUnit?: boolean;
}

export const OPERATORS_BY_TYPE: Record<PropertyType, OperatorOption[]> = {
  text: [
    { value: "is", label: "is", requiresValue: true },
    { value: "is_not", label: "is not", requiresValue: true },
    { value: "contains", label: "contains", requiresValue: true },
    {
      value: "does_not_contain",
      label: "does not contain",
      requiresValue: true,
    },
    { value: "starts_with", label: "starts with", requiresValue: true },
    { value: "ends_with", label: "ends with", requiresValue: true },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  number: [
    { value: "is_equal_to", label: "is equal to", requiresValue: true },
    { value: "is_not_equal_to", label: "is not equal to", requiresValue: true },
    { value: "is_greater_than", label: "is greater than", requiresValue: true },
    {
      value: "is_greater_than_or_equal_to",
      label: "is greater than or equal to",
      requiresValue: true,
    },
    { value: "is_less_than", label: "is less than", requiresValue: true },
    {
      value: "is_less_than_or_equal_to",
      label: "is less than or equal to",
      requiresValue: true,
    },
    {
      value: "is_between",
      label: "is between",
      requiresValue: true,
      requiresSecondaryValue: true,
    },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  date: [
    { value: "is", label: "is", requiresValue: true },
    { value: "is_before", label: "is before", requiresValue: true },
    { value: "is_after", label: "is after", requiresValue: true },
    {
      value: "is_between",
      label: "is between",
      requiresValue: true,
      requiresSecondaryValue: true,
    },
    {
      value: "is_less_than_n_ago",
      label: "is less than",
      requiresValue: true,
      requiresUnit: true,
    },
    {
      value: "is_more_than_n_ago",
      label: "is more than",
      requiresValue: true,
      requiresUnit: true,
    },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  boolean: [
    { value: "is_true", label: "is true", requiresValue: false },
    { value: "is_false", label: "is false", requiresValue: false },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  enum: [
    { value: "is_any_of", label: "is any of", requiresValue: true },
    { value: "is_none_of", label: "is none of", requiresValue: true },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  user: [
    { value: "is_any_of", label: "is any of", requiresValue: true },
    { value: "is_none_of", label: "is none of", requiresValue: true },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  status: [
    { value: "is_any_of", label: "is any of", requiresValue: true },
    { value: "is_none_of", label: "is none of", requiresValue: true },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
  severity: [
    { value: "is_any_of", label: "is any of", requiresValue: true },
    { value: "is_none_of", label: "is none of", requiresValue: true },
    { value: "is_known", label: "is known", requiresValue: false },
    { value: "is_unknown", label: "is unknown", requiresValue: false },
  ],
};

export function getOperatorsForPropertyType(
  type: PropertyType,
): OperatorOption[] {
  return OPERATORS_BY_TYPE[type] || OPERATORS_BY_TYPE.text;
}

export function getOperatorLabel(operator: FilterOperator): string {
  for (const ops of Object.values(OPERATORS_BY_TYPE)) {
    const found = ops.find((o) => o.value === operator);
    if (found) return found.label;
  }
  return operator;
}

export function operatorRequiresValue(operator: FilterOperator): boolean {
  for (const ops of Object.values(OPERATORS_BY_TYPE)) {
    const found = ops.find((o) => o.value === operator);
    if (found) return found.requiresValue;
  }
  return true;
}
```

  </action>
  <verify>npm run typecheck passes; operators are properly typed</verify>
  <done>Operators file defines operators for all property types with metadata</done>
</task>

<task type="auto">
  <name>Task 4: Create module configuration types</name>
  <files>apps/frontend/src/types/view-config.ts</files>
  <action>
Create the module configuration type file:

```typescript
import { PropertyType, ViewEntityType, FilterGroup } from "@/lib/views/types";
import { CellContext } from "@tanstack/react-table";
import { ReactNode } from "react";

// Column definition for a module
export interface ColumnDefinition {
  id: string; // Unique column ID
  header: string; // Display name
  accessorKey: string; // Property path (e.g., 'status', 'createdBy.name')
  group: string; // Group name for organization in column picker
  type: PropertyType; // Property type for filtering/formatting
  sortable?: boolean; // Can sort by this column (default: false)
  filterable?: boolean; // Can filter by this column (default: false)
  defaultVisible?: boolean; // Shown by default (default: false)
  width?: number; // Default width in pixels
  minWidth?: number; // Minimum width in pixels
  maxWidth?: number; // Maximum width in pixels
  cell?: (props: CellContext<any, unknown>) => ReactNode; // Custom cell renderer
  enableResizing?: boolean; // Can resize column (default: true)
}

// Default view configuration
export interface DefaultViewConfig {
  name: string;
  description?: string;
  filters?: FilterGroup[];
  sortBy?: string;
  sortOrder?: "asc" | "desc";
  columns?: string[]; // Column IDs to show
  isSystem: boolean; // System views cannot be deleted
}

// Bulk action configuration
export interface BulkActionConfig {
  id: string;
  label: string;
  icon?: string; // Lucide icon name
  destructive?: boolean;
  requireConfirmation?: boolean;
  confirmationMessage?: string;
}

// Board view configuration
export interface BoardConfig {
  groupByOptions: { propertyId: string; label: string }[];
  defaultGroupBy: string;
  cardFields?: string[]; // Fields to show on board cards
}

// Quick filter property
export interface QuickFilterProperty {
  propertyId: string;
  label: string;
  type: PropertyType;
  options?: { value: string; label: string }[]; // For enum types
}

// Main module configuration
export interface ModuleViewConfig {
  moduleType: ViewEntityType;

  // Column definitions
  columns: ColumnDefinition[];

  // Quick filter defaults (which properties appear in quick filter row)
  quickFilterProperties: QuickFilterProperty[];

  // Default views (seeded for new orgs)
  defaultViews: DefaultViewConfig[];

  // Bulk actions available for this module
  bulkActions: BulkActionConfig[];

  // Board view options (optional - not all modules support board view)
  boardConfig?: BoardConfig;

  // Primary column (first column, cannot be hidden)
  primaryColumnId: string;

  // API endpoints
  endpoints: {
    list: string; // GET endpoint for fetching data
    export: string; // POST endpoint for exporting data
    bulk: string; // POST endpoint for bulk actions
    single: (id: string) => string; // GET endpoint for single item
  };

  // Entity display name (singular and plural)
  entityName: {
    singular: string;
    plural: string;
  };
}

// Helper to create a column definition with defaults
export function createColumn(
  id: string,
  header: string,
  accessorKey: string,
  group: string,
  type: PropertyType,
  options?: Partial<ColumnDefinition>,
): ColumnDefinition {
  return {
    id,
    header,
    accessorKey,
    group,
    type,
    sortable: false,
    filterable: false,
    defaultVisible: false,
    enableResizing: true,
    ...options,
  };
}
```

  </action>
  <verify>npm run typecheck passes; all types properly export</verify>
  <done>ModuleViewConfig and related types are defined with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 5: Create constants file and index exports</name>
  <files>apps/frontend/src/lib/views/constants.ts</files>
  <action>
Create constants file with default values:

```typescript
// Default values for the view system

export const DEFAULT_PAGE_SIZE = 25;
export const PAGE_SIZE_OPTIONS = [25, 50, 100] as const;

export const MAX_FILTER_GROUPS = 2;
export const MAX_CONDITIONS_PER_GROUP = 20;
export const MAX_SAVED_VIEWS = 50;
export const MAX_FROZEN_COLUMNS = 3;

export const DEFAULT_FROZEN_COLUMNS = 0;
export const DEFAULT_VIEW_MODE = "table" as const;

export const RECORD_COUNT_STALE_MINUTES = 5;

// Date range presets for quick filters
export const DATE_RANGE_PRESETS = [
  { value: "today", label: "Today" },
  { value: "yesterday", label: "Yesterday" },
  { value: "this_week", label: "This week" },
  { value: "last_week", label: "Last week" },
  { value: "this_month", label: "This month" },
  { value: "last_month", label: "Last month" },
  { value: "this_quarter", label: "This quarter" },
  { value: "last_30_days", label: "Last 30 days" },
  { value: "last_90_days", label: "Last 90 days" },
  { value: "this_year", label: "This year" },
  { value: "custom", label: "Custom range" },
] as const;

// Time unit options for relative date filters
export const TIME_UNIT_OPTIONS = [
  { value: "day", label: "days" },
  { value: "week", label: "weeks" },
  { value: "month", label: "months" },
] as const;

// Visibility options
export const VISIBILITY_OPTIONS = [
  {
    value: "private",
    label: "Private",
    description: "Only you can see this view",
  },
  {
    value: "team",
    label: "My team",
    description: "Anyone on your team can see this view",
  },
  {
    value: "everyone",
    label: "Everyone",
    description: "Anyone in your organization can see this view",
  },
] as const;
```

Also create an index.ts file at apps/frontend/src/lib/views/index.ts:

```typescript
export * from "./types";
export * from "./operators";
export * from "./constants";
```

  </action>
  <verify>npm run typecheck passes; exports work correctly</verify>
  <done>Constants defined and all view system types/utilities exported from index</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm list @tanstack/react-table
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- @tanstack/react-table v8.x is installed
- FilterGroup, FilterCondition, FilterOperator types are defined
- OPERATORS_BY_TYPE provides operators for all property types
- ModuleViewConfig type defines the module configuration structure
- ColumnDefinition includes type, group, sortable, filterable, defaultVisible
- All types are exported from apps/frontend/src/lib/views/index.ts
- TypeScript compiles without errors
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-02-SUMMARY.md`
</output>
