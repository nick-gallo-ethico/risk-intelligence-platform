---
phase: 13-hubspot-style-saved-views-system
plan: 09
type: execute
wave: 3
depends_on: ["13-02", "13-03"]
files_modified:
  - apps/frontend/src/components/views/DataTable.tsx
  - apps/frontend/src/components/views/DataTableHeader.tsx
  - apps/frontend/src/components/views/DataTableRow.tsx
  - apps/frontend/src/components/views/PaginationBar.tsx
  - apps/frontend/src/components/views/BulkActionsBar.tsx
  - apps/frontend/src/components/views/index.ts
autonomous: true

must_haves:
  truths:
    - "Table uses @tanstack/react-table for headless functionality"
    - "Column headers support click-to-sort with ascending/descending/none cycle"
    - "Frozen columns remain fixed during horizontal scroll"
    - "Checkbox column enables row selection with bulk actions"
    - "Pagination shows page numbers with 25/50/100 per page options"
    - "Column widths are resizable by dragging header borders"
  artifacts:
    - path: "apps/frontend/src/components/views/DataTable.tsx"
      provides: "Main data table with TanStack Table integration"
      contains: "useReactTable"
    - path: "apps/frontend/src/components/views/PaginationBar.tsx"
      provides: "Pagination controls with page numbers and per-page dropdown"
      contains: "pageSize"
  key_links:
    - from: "DataTable"
      to: "SavedViewContext"
      via: "useSavedViewContext"
      pattern: "visibleColumns"
---

<objective>
Create the DataTable component (Zone 4) using @tanstack/react-table for the table view.

Purpose: The data table is the primary way users view and interact with records. It must support sorting, column freezing, row selection, column resizing, and pagination.

Output: DataTable with TanStack Table, sortable/resizable headers, frozen columns, row selection, bulk actions, and pagination.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/hubspot-view-system-spec.md
@apps/frontend/src/components/views/SavedViewProvider.tsx
@apps/frontend/src/lib/views/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PaginationBar component</name>
  <files>apps/frontend/src/components/views/PaginationBar.tsx</files>
  <action>
Create the pagination bar:

```typescript
'use client';

import React from 'react';
import { ChevronLeft, ChevronRight } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { cn } from '@/lib/utils';

interface PaginationBarProps {
  currentPage: number;
  totalPages: number;
  pageSize: number;
  totalRecords: number;
  onPageChange: (page: number) => void;
  onPageSizeChange: (size: number) => void;
}

const PAGE_SIZE_OPTIONS = [25, 50, 100];

export function PaginationBar({
  currentPage,
  totalPages,
  pageSize,
  totalRecords,
  onPageChange,
  onPageSizeChange,
}: PaginationBarProps) {
  // Generate page numbers to show
  const getPageNumbers = (): (number | 'ellipsis')[] => {
    const pages: (number | 'ellipsis')[] = [];
    const maxVisible = 7;

    if (totalPages <= maxVisible) {
      for (let i = 1; i <= totalPages; i++) {
        pages.push(i);
      }
    } else {
      // Always show first page
      pages.push(1);

      if (currentPage > 3) {
        pages.push('ellipsis');
      }

      // Show pages around current
      const start = Math.max(2, currentPage - 1);
      const end = Math.min(totalPages - 1, currentPage + 1);

      for (let i = start; i <= end; i++) {
        pages.push(i);
      }

      if (currentPage < totalPages - 2) {
        pages.push('ellipsis');
      }

      // Always show last page
      pages.push(totalPages);
    }

    return pages;
  };

  const startRecord = (currentPage - 1) * pageSize + 1;
  const endRecord = Math.min(currentPage * pageSize, totalRecords);

  return (
    <div className="flex items-center justify-between px-4 py-3 border-t bg-background">
      {/* Record count info */}
      <div className="text-sm text-muted-foreground">
        Showing {startRecord.toLocaleString()} - {endRecord.toLocaleString()} of{' '}
        {totalRecords.toLocaleString()} records
      </div>

      {/* Pagination controls */}
      <div className="flex items-center gap-2">
        {/* Previous button */}
        <Button
          variant="outline"
          size="sm"
          onClick={() => onPageChange(currentPage - 1)}
          disabled={currentPage === 1}
        >
          <ChevronLeft className="h-4 w-4 mr-1" />
          Prev
        </Button>

        {/* Page numbers */}
        <div className="flex items-center gap-1">
          {getPageNumbers().map((page, index) => {
            if (page === 'ellipsis') {
              return (
                <span key={`ellipsis-${index}`} className="px-2 text-muted-foreground">
                  ...
                </span>
              );
            }

            return (
              <Button
                key={page}
                variant={currentPage === page ? 'default' : 'ghost'}
                size="sm"
                className={cn('w-9', currentPage === page && 'pointer-events-none')}
                onClick={() => onPageChange(page)}
              >
                {page}
              </Button>
            );
          })}
        </div>

        {/* Next button */}
        <Button
          variant="outline"
          size="sm"
          onClick={() => onPageChange(currentPage + 1)}
          disabled={currentPage === totalPages}
        >
          Next
          <ChevronRight className="h-4 w-4 ml-1" />
        </Button>
      </div>

      {/* Page size selector */}
      <div className="flex items-center gap-2">
        <Select
          value={String(pageSize)}
          onValueChange={(v) => onPageSizeChange(Number(v))}
        >
          <SelectTrigger className="w-[100px]">
            <SelectValue />
          </SelectTrigger>
          <SelectContent>
            {PAGE_SIZE_OPTIONS.map((size) => (
              <SelectItem key={size} value={String(size)}>
                {size} per page
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
    </div>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>PaginationBar with page numbers, prev/next, and page size dropdown</done>
</task>

<task type="auto">
  <name>Task 2: Create BulkActionsBar component</name>
  <files>apps/frontend/src/components/views/BulkActionsBar.tsx</files>
  <action>
Create the bulk actions bar that appears when rows are selected:

```typescript
'use client';

import React from 'react';
import { X, Trash2, Download, UserPlus, Tag, CheckCircle } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { BulkAction } from '@/lib/views/types';

interface BulkActionsBarProps {
  selectedCount: number;
  totalCount: number;
  actions: BulkAction[];
  onClearSelection: () => void;
  onSelectAll: () => void;
  onAction: (actionId: string, selectedIds: string[]) => void;
  selectedIds: string[];
}

const ACTION_ICONS: Record<string, React.ReactNode> = {
  assign: <UserPlus className="h-4 w-4 mr-2" />,
  status: <CheckCircle className="h-4 w-4 mr-2" />,
  category: <Tag className="h-4 w-4 mr-2" />,
  export: <Download className="h-4 w-4 mr-2" />,
  delete: <Trash2 className="h-4 w-4 mr-2" />,
};

export function BulkActionsBar({
  selectedCount,
  totalCount,
  actions,
  onClearSelection,
  onSelectAll,
  onAction,
  selectedIds,
}: BulkActionsBarProps) {
  if (selectedCount === 0) return null;

  const allSelected = selectedCount === totalCount;

  return (
    <div className="flex items-center gap-3 px-4 py-2 bg-primary text-primary-foreground">
      {/* Selection info */}
      <div className="flex items-center gap-2">
        <Badge variant="secondary" className="bg-primary-foreground text-primary">
          {selectedCount}
        </Badge>
        <span className="text-sm font-medium">selected</span>
      </div>

      {/* Select all link */}
      {!allSelected && (
        <Button
          variant="link"
          size="sm"
          className="text-primary-foreground underline"
          onClick={onSelectAll}
        >
          Select all {totalCount}
        </Button>
      )}

      <div className="h-4 w-px bg-primary-foreground/30" />

      {/* Bulk action buttons */}
      {actions.map((action) => {
        if (action.children) {
          // Dropdown for actions with sub-options
          return (
            <DropdownMenu key={action.id}>
              <DropdownMenuTrigger asChild>
                <Button variant="secondary" size="sm">
                  {ACTION_ICONS[action.id] || null}
                  {action.label}
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent>
                {action.children.map((child) => (
                  <DropdownMenuItem
                    key={child.id}
                    onClick={() => onAction(child.id, selectedIds)}
                  >
                    {child.label}
                  </DropdownMenuItem>
                ))}
              </DropdownMenuContent>
            </DropdownMenu>
          );
        }

        return (
          <Button
            key={action.id}
            variant={action.destructive ? 'destructive' : 'secondary'}
            size="sm"
            onClick={() => onAction(action.id, selectedIds)}
          >
            {ACTION_ICONS[action.id] || null}
            {action.label}
          </Button>
        );
      })}

      {/* Spacer */}
      <div className="flex-1" />

      {/* Clear selection */}
      <Button
        variant="ghost"
        size="sm"
        className="text-primary-foreground hover:text-primary-foreground hover:bg-primary-foreground/20"
        onClick={onClearSelection}
      >
        <X className="h-4 w-4 mr-1" />
        Clear
      </Button>
    </div>
  );
}
```

  </action>
  <verify>npm run typecheck passes</verify>
  <done>BulkActionsBar with selection count, bulk actions, and clear</done>
</task>

<task type="auto">
  <name>Task 3: Create DataTable component with TanStack Table</name>
  <files>apps/frontend/src/components/views/DataTable.tsx</files>
  <action>
Create the main DataTable component:

```typescript
'use client';

import React, { useMemo, useRef, useCallback } from 'react';
import {
  useReactTable,
  getCoreRowModel,
  getSortedRowModel,
  flexRender,
  ColumnDef,
  SortingState,
  RowSelectionState,
  ColumnResizeMode,
} from '@tanstack/react-table';
import { ArrowUp, ArrowDown, ArrowUpDown, MoreHorizontal } from 'lucide-react';
import { Checkbox } from '@/components/ui/checkbox';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import { useSavedViewContext } from '@/hooks/views/useSavedViewContext';
import { BulkActionsBar } from './BulkActionsBar';
import { PaginationBar } from './PaginationBar';
import { ColumnConfig } from '@/lib/views/types';
import { cn } from '@/lib/utils';
import { format } from 'date-fns';

interface DataTableProps<T> {
  data: T[];
  isLoading?: boolean;
  totalRecords: number;
  currentPage: number;
  pageSize: number;
  onPageChange: (page: number) => void;
  onPageSizeChange: (size: number) => void;
  onRowClick?: (row: T) => void;
  onBulkAction?: (actionId: string, selectedIds: string[]) => void;
  getRowId: (row: T) => string;
  emptyMessage?: string;
}

export function DataTable<T extends Record<string, unknown>>({
  data,
  isLoading = false,
  totalRecords,
  currentPage,
  pageSize,
  onPageChange,
  onPageSizeChange,
  onRowClick,
  onBulkAction,
  getRowId,
  emptyMessage = 'No records found',
}: DataTableProps<T>) {
  const {
    config,
    visibleColumns,
    frozenColumnCount,
    sortBy,
    sortOrder,
    setSort,
  } = useSavedViewContext();

  const tableContainerRef = useRef<HTMLDivElement>(null);

  // Build TanStack column definitions from visible columns
  const columns = useMemo<ColumnDef<T>[]>(() => {
    const cols: ColumnDef<T>[] = [];

    // Checkbox column
    cols.push({
      id: 'select',
      header: ({ table }) => (
        <Checkbox
          checked={
            table.getIsAllPageRowsSelected() ||
            (table.getIsSomePageRowsSelected() && 'indeterminate')
          }
          onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
          aria-label="Select all"
        />
      ),
      cell: ({ row }) => (
        <Checkbox
          checked={row.getIsSelected()}
          onCheckedChange={(value) => row.toggleSelected(!!value)}
          aria-label="Select row"
          onClick={(e) => e.stopPropagation()}
        />
      ),
      size: 40,
      enableResizing: false,
    });

    // Data columns from visible columns
    visibleColumns.forEach((colId, index) => {
      const colConfig = config.columns.find((c) => c.id === colId);
      if (!colConfig) return;

      cols.push({
        id: colConfig.id,
        accessorKey: colConfig.accessorKey || colConfig.id,
        header: ({ column }) => (
          <div className="flex items-center gap-2">
            <span className="truncate">{colConfig.header}</span>
            {colConfig.sortable && (
              <Button
                variant="ghost"
                size="sm"
                className="h-6 w-6 p-0"
                onClick={() => {
                  const currentDir = column.getIsSorted();
                  if (!currentDir) {
                    setSort(colConfig.id, 'asc');
                  } else if (currentDir === 'asc') {
                    setSort(colConfig.id, 'desc');
                  } else {
                    setSort(null, 'asc');
                  }
                }}
              >
                {column.getIsSorted() === 'asc' ? (
                  <ArrowUp className="h-4 w-4" />
                ) : column.getIsSorted() === 'desc' ? (
                  <ArrowDown className="h-4 w-4" />
                ) : (
                  <ArrowUpDown className="h-4 w-4 opacity-50" />
                )}
              </Button>
            )}
          </div>
        ),
        cell: ({ getValue, row }) => renderCell(getValue(), colConfig, row.original),
        size: colConfig.width || 150,
        enableResizing: true,
      });
    });

    // Actions column
    cols.push({
      id: 'actions',
      header: '',
      cell: ({ row }) => (
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="ghost" size="icon" className="h-8 w-8">
              <MoreHorizontal className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent align="end">
            <DropdownMenuItem onClick={() => onRowClick?.(row.original)}>
              View details
            </DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem>Edit</DropdownMenuItem>
            <DropdownMenuItem className="text-destructive">Delete</DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      ),
      size: 50,
      enableResizing: false,
    });

    return cols;
  }, [visibleColumns, config.columns, setSort, onRowClick]);

  // Render cell based on column type
  const renderCell = (value: unknown, colConfig: ColumnConfig, row: T) => {
    if (value === null || value === undefined) {
      return <span className="text-muted-foreground">--</span>;
    }

    switch (colConfig.type) {
      case 'date':
        return format(new Date(value as string), 'MMM d, yyyy');
      case 'datetime':
        return format(new Date(value as string), 'MMM d, yyyy HH:mm');
      case 'boolean':
        return value ? 'Yes' : 'No';
      case 'select':
        const option = colConfig.options?.find(
          (o) => (typeof o === 'string' ? o : o.value) === value
        );
        if (typeof option === 'object' && option?.color) {
          return (
            <Badge style={{ backgroundColor: option.color }} className="text-white">
              {option.label}
            </Badge>
          );
        }
        return String(value);
      case 'user':
        // Render user with avatar if available
        return <span>{String(value)}</span>;
      case 'link':
        // First column is usually clickable
        return (
          <button
            className="text-primary hover:underline font-medium text-left"
            onClick={() => onRowClick?.(row)}
          >
            {String(value)}
          </button>
        );
      case 'number':
        return typeof value === 'number' ? value.toLocaleString() : String(value);
      default:
        const strValue = String(value);
        if (strValue.length > 50) {
          return (
            <span title={strValue} className="truncate block max-w-[200px]">
              {strValue}
            </span>
          );
        }
        return strValue;
    }
  };

  // Sorting state (controlled by context)
  const sorting = useMemo<SortingState>(() => {
    if (!sortBy) return [];
    return [{ id: sortBy, desc: sortOrder === 'desc' }];
  }, [sortBy, sortOrder]);

  // Row selection state
  const [rowSelection, setRowSelection] = React.useState<RowSelectionState>({});

  // Table instance
  const table = useReactTable({
    data,
    columns,
    state: {
      sorting,
      rowSelection,
    },
    enableRowSelection: true,
    onRowSelectionChange: setRowSelection,
    getCoreRowModel: getCoreRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getRowId,
    columnResizeMode: 'onChange' as ColumnResizeMode,
    manualSorting: true, // Sorting is handled by backend
  });

  const selectedRowIds = Object.keys(rowSelection);

  const handleClearSelection = useCallback(() => {
    setRowSelection({});
  }, []);

  const handleSelectAll = useCallback(() => {
    const allIds = data.reduce((acc, row) => {
      acc[getRowId(row)] = true;
      return acc;
    }, {} as RowSelectionState);
    setRowSelection(allIds);
  }, [data, getRowId]);

  const handleBulkAction = useCallback(
    (actionId: string, ids: string[]) => {
      onBulkAction?.(actionId, ids);
      handleClearSelection();
    },
    [onBulkAction, handleClearSelection]
  );

  const totalPages = Math.ceil(totalRecords / pageSize);

  return (
    <div className="flex flex-col h-full">
      {/* Bulk actions bar */}
      <BulkActionsBar
        selectedCount={selectedRowIds.length}
        totalCount={data.length}
        actions={config.bulkActions || []}
        onClearSelection={handleClearSelection}
        onSelectAll={handleSelectAll}
        onAction={handleBulkAction}
        selectedIds={selectedRowIds}
      />

      {/* Table container with horizontal scroll */}
      <div ref={tableContainerRef} className="flex-1 overflow-auto">
        <table className="w-full border-collapse">
          {/* Header */}
          <thead className="sticky top-0 bg-muted z-10">
            {table.getHeaderGroups().map((headerGroup) => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map((header, index) => {
                  const isFrozen = index <= frozenColumnCount; // +1 for checkbox
                  return (
                    <th
                      key={header.id}
                      className={cn(
                        'px-3 py-2 text-left text-sm font-medium text-muted-foreground border-b bg-muted',
                        isFrozen && 'sticky left-0 z-20 bg-muted',
                        header.column.getCanResize() && 'relative'
                      )}
                      style={{
                        width: header.getSize(),
                        left: isFrozen ? `${index * 40}px` : undefined, // Simplified left calc
                      }}
                    >
                      {header.isPlaceholder
                        ? null
                        : flexRender(header.column.columnDef.header, header.getContext())}

                      {/* Resize handle */}
                      {header.column.getCanResize() && (
                        <div
                          onMouseDown={header.getResizeHandler()}
                          onTouchStart={header.getResizeHandler()}
                          className={cn(
                            'absolute right-0 top-0 h-full w-1 cursor-col-resize select-none touch-none',
                            header.column.getIsResizing() && 'bg-primary'
                          )}
                        />
                      )}
                    </th>
                  );
                })}
              </tr>
            ))}
          </thead>

          {/* Body */}
          <tbody>
            {isLoading ? (
              // Loading skeleton
              Array.from({ length: 10 }).map((_, i) => (
                <tr key={i}>
                  {columns.map((_, j) => (
                    <td key={j} className="px-3 py-3 border-b">
                      <Skeleton className="h-5 w-full" />
                    </td>
                  ))}
                </tr>
              ))
            ) : data.length === 0 ? (
              // Empty state
              <tr>
                <td colSpan={columns.length} className="text-center py-12">
                  <p className="text-muted-foreground">{emptyMessage}</p>
                  <p className="text-sm text-muted-foreground mt-1">
                    Try adjusting your filters or search criteria.
                  </p>
                </td>
              </tr>
            ) : (
              // Data rows
              table.getRowModel().rows.map((row) => (
                <tr
                  key={row.id}
                  className={cn(
                    'hover:bg-muted/50 cursor-pointer',
                    row.getIsSelected() && 'bg-primary/5'
                  )}
                  onClick={() => onRowClick?.(row.original)}
                >
                  {row.getVisibleCells().map((cell, index) => {
                    const isFrozen = index <= frozenColumnCount;
                    return (
                      <td
                        key={cell.id}
                        className={cn(
                          'px-3 py-3 text-sm border-b',
                          isFrozen && 'sticky left-0 bg-background z-10'
                        )}
                        style={{
                          width: cell.column.getSize(),
                          left: isFrozen ? `${index * 40}px` : undefined,
                        }}
                      >
                        {flexRender(cell.column.columnDef.cell, cell.getContext())}
                      </td>
                    );
                  })}
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Pagination */}
      <PaginationBar
        currentPage={currentPage}
        totalPages={totalPages}
        pageSize={pageSize}
        totalRecords={totalRecords}
        onPageChange={onPageChange}
        onPageSizeChange={onPageSizeChange}
      />
    </div>
  );
}
```

Update exports:

```typescript
// apps/frontend/src/components/views/index.ts - add these exports
export { DataTable } from "./DataTable";
export { PaginationBar } from "./PaginationBar";
export { BulkActionsBar } from "./BulkActionsBar";
```

  </action>
  <verify>npm run typecheck passes; npm run lint passes</verify>
  <done>DataTable with TanStack Table, sorting, freezing, selection, and pagination</done>
</task>

</tasks>

<verification>
```bash
cd apps/frontend
npm run typecheck
npm run lint
```
</verification>

<success_criteria>

- DataTable uses @tanstack/react-table for headless table functionality
- Column headers show sort icons (ascending, descending, or unsorted)
- Clicking header toggles sort direction (none -> asc -> desc -> none)
- Frozen columns (1-3) remain fixed when scrolling horizontally
- Checkbox column in first position enables row selection
- Selected rows trigger BulkActionsBar to appear
- Bulk actions are configurable per module
- Column widths are resizable by dragging header borders
- Pagination shows page numbers with ellipsis for large page counts
- Page size dropdown offers 25, 50, 100 options
- Loading state shows skeleton rows
- Empty state shows helpful message with filter suggestion
  </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-09-SUMMARY.md`
</output>
