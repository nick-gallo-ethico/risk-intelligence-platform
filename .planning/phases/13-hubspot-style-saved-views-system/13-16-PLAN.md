---
phase: 13-hubspot-style-saved-views-system
plan: 16
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/src/lib/views/configs/cases.config.ts
  - apps/frontend/src/components/views/BoardCard.tsx
  - apps/frontend/src/hooks/views/useCasesView.ts
  - apps/backend/src/modules/investigations/investigations.service.ts
  - apps/backend/src/modules/investigations/investigations.controller.ts
  - apps/backend/prisma/seeders/case.seeder.ts
  - apps/backend/src/modules/cases/cases.controller.ts
  - apps/backend/src/modules/policies/policies.controller.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Board view cards display priority badge and owner avatar"
    - "Board view drag-and-drop persists status changes to database"
    - "Investigations page loads investigation data in table"
    - "Search box filters cases without hiding all data"
    - "Export button downloads Excel and CSV files respecting current filters"
  artifacts:
    - path: "apps/frontend/src/lib/views/configs/cases.config.ts"
      provides: "Correct cardConfig field mappings for board view"
      contains: "priorityField: 'priority'"
    - path: "apps/frontend/src/components/views/BoardCard.tsx"
      provides: "Full-width card styling"
      contains: "w-full"
    - path: "apps/frontend/src/hooks/views/useCasesView.ts"
      provides: "Status update via PATCH /cases/:id/status"
      pattern: "PATCH.*cases/.*status"
    - path: "apps/backend/src/modules/investigations/investigations.controller.ts"
      provides: "GET /investigations endpoint"
      exports: ["InvestigationsController.findAll"]
    - path: "apps/backend/src/modules/investigations/investigations.service.ts"
      provides: "findAll method for investigations listing"
      exports: ["InvestigationsService.findAll"]
    - path: "apps/backend/prisma/seeders/case.seeder.ts"
      provides: "SQL to populate search_vector after seed"
      contains: "UPDATE.*search_vector"
    - path: "apps/backend/src/modules/cases/cases.controller.ts"
      provides: "POST /cases/export endpoint"
      exports: ["CasesController.export"]
    - path: "apps/backend/src/modules/policies/policies.controller.ts"
      provides: "POST /policies/export endpoint"
      exports: ["PoliciesController.export"]
  key_links:
    - from: "apps/frontend/src/components/views/BoardView.tsx"
      to: "apps/backend/src/modules/cases/cases.controller.ts"
      via: "handleStatusChange calling PATCH /cases/:id/status"
      pattern: "PATCH.*api/v1/cases/.*status"
    - from: "apps/frontend/src/pages/investigations"
      to: "apps/backend/src/modules/investigations/investigations.controller.ts"
      via: "useInvestigationsView calling GET /investigations"
      pattern: "GET.*api/v1/investigations"
    - from: "apps/frontend/src/components/views/ExportButton.tsx"
      to: "apps/backend/src/modules/*/export"
      via: "handleExport calling POST /{entity}/export"
      pattern: "POST.*api/v1/(cases|policies|investigations)/export"
---

<objective>
Close all 4 remaining UAT gaps from Phase 13 verification: fix board view visibility and drag-drop persistence, add investigations list endpoint, fix search by populating search_vector, and wire export endpoints across all modules.

**Purpose:** Complete Phase 13 HubSpot-Style Saved Views System by addressing all major issues preventing demo readiness.

**Output:** All view tabs functional across Cases, Investigations, Policies modules with working board view, search, and export.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\.planning\PROJECT.md
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\.planning\ROADMAP.md
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\.planning\STATE.md
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\.planning\phases\13-hubspot-style-saved-views-system\13-UAT.md

# Reference implementations

@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\apps\backend\src\modules\analytics\exports\excel-export.service.ts
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\apps\backend\src\modules\cases\cases.controller.ts
@C:\Users\cu0718\Documents\Claude Code Projects\Risk Intelligence Platform\apps\backend\src\modules\investigations\investigations.controller.ts
</context>

<tasks>

<task type="auto">
  <name>Fix Board View Card Configuration and Styling</name>
  <files>
    apps/frontend/src/lib/views/configs/cases.config.ts
    apps/frontend/src/components/views/BoardCard.tsx
  </files>
  <action>
    **Issue 1: Field name mismatches in cardConfig**

    In `cases.config.ts` line 465-466, fix cardConfig field mappings:
    - Change `priorityField: 'severity'` to `priorityField: 'priority'`
    - Change `ownerField: 'createdBy.firstName'` to `ownerField: 'assignee.name'`

    **Rationale:** Case entity has `priority` field (not severity), and `assignee` relation (not createdBy) for ownership. This mismatch prevents badge/avatar from displaying.

    **Issue 2: Missing w-full class on BoardCard**

    In `BoardCard.tsx` line 76, add `w-full` to the card className:
    - Change `className="bg-white border rounded-md p-3 shadow-sm cursor-move"`
    - To `className="w-full bg-white border rounded-md p-3 shadow-sm cursor-move"`

    **Rationale:** Cards need full width to fill their lane containers properly.

  </action>
  <verify>
    1. Inspect cases.config.ts lines 465-466 - verify priorityField='priority' and ownerField='assignee.name'
    2. Inspect BoardCard.tsx line 76 - verify w-full class present
    3. Run `npm run typecheck` in apps/frontend - should pass
  </verify>
  <done>
    - Board view cardConfig uses correct field names matching Case entity schema
    - BoardCard has w-full class for proper lane width filling
    - TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Fix Board View Drag-Drop Status Persistence</name>
  <files>
    apps/frontend/src/hooks/views/useCasesView.ts
  </files>
  <action>
    **Issue: handleStatusChange calls non-existent /cases/bulk endpoint**

    In `useCasesView.ts` lines 170-186, replace bulk endpoint call with individual status update:

    **Current code pattern:**
    ```typescript
    const response = await fetch('/api/v1/cases/bulk', {
      method: 'POST',
      body: JSON.stringify({ caseIds: [caseId], action: 'updateStatus', status: newStatus })
    });
    ```

    **Replace with:**
    ```typescript
    const response = await fetch(`/api/v1/cases/${caseId}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    ```

    **Rationale:** Backend has PATCH /cases/:id/status endpoint (already exists from Phase 6), but no bulk operations endpoint. Frontend incorrectly calls /cases/bulk which returns 404, causing drag-drop to revert.

    **Why this approach:** Phase 6 already implemented ChangeCaseStatusDto and status transition logic. We reuse existing proven endpoint instead of building new bulk API.

  </action>
  <verify>
    1. Inspect useCasesView.ts lines 170-186 - verify PATCH endpoint with caseId in path
    2. Verify fetch includes headers: { 'Content-Type': 'application/json' }
    3. Run `npm run typecheck` in apps/frontend - should pass
  </verify>
  <done>
    - handleStatusChange uses PATCH /cases/:id/status endpoint
    - Board drag-and-drop persists status changes to database
    - Cards remain in new lane after drop (no revert to original lane)
  </done>
</task>

<task type="auto">
  <name>Add Investigations List Endpoint (Backend)</name>
  <files>
    apps/backend/src/modules/investigations/investigations.service.ts
    apps/backend/src/modules/investigations/investigations.controller.ts
  </files>
  <action>
    **Issue: Investigations page has no data - missing GET /investigations endpoint**

    **Part 1: InvestigationsService.findAll() method**

    Add to `investigations.service.ts` after existing methods:

    ```typescript
    /**
     * Returns paginated list of investigations across all cases.
     * Used by investigations list view (not case-scoped).
     */
    async findAll(
      query: InvestigationQueryDto,
      organizationId: string,
    ): Promise<{
      data: Investigation[];
      total: number;
      limit: number;
      page: number;
    }> {
      const { limit = 25, page = 1, status, assignedToUserId, sortBy = 'createdAt', sortOrder = 'desc' } = query;
      const skip = (page - 1) * limit;

      const where: Prisma.InvestigationWhereInput = {
        organizationId,
        ...(status && { status }),
        ...(assignedToUserId && {
          assignments: {
            some: { userId: assignedToUserId }
          }
        }),
      };

      const [data, total] = await Promise.all([
        this.prisma.investigation.findMany({
          where,
          skip,
          take: limit,
          orderBy: { [sortBy]: sortOrder },
          include: {
            case: {
              select: {
                id: true,
                referenceNumber: true,
                title: true,
                status: true,
              },
            },
            assignments: {
              include: {
                user: {
                  select: {
                    id: true,
                    firstName: true,
                    lastName: true,
                    email: true,
                  },
                },
              },
            },
          },
        }),
        this.prisma.investigation.count({ where }),
      ]);

      return { data, total, limit, page };
    }
    ```

    **Part 2: InvestigationsController GET /investigations endpoint**

    Add to `investigations.controller.ts` in the InvestigationsController class (after existing endpoints):

    ```typescript
    /**
     * GET /api/v1/investigations
     * Returns paginated list of all investigations across cases.
     */
    @Get()
    @ApiOperation({
      summary: 'List all investigations',
      description: 'Returns paginated list of investigations across all cases',
    })
    @ApiQuery({ name: 'limit', required: false, type: Number })
    @ApiQuery({ name: 'page', required: false, type: Number })
    @ApiQuery({ name: 'status', required: false, type: String })
    @ApiQuery({ name: 'assignedToUserId', required: false, type: String })
    @ApiResponse({ status: 200, description: 'List of investigations' })
    @ApiResponse({ status: 401, description: 'Unauthorized' })
    async findAll(
      @Query() query: InvestigationQueryDto,
      @TenantId() organizationId: string,
    ): Promise<{
      data: Investigation[];
      total: number;
      limit: number;
      page: number;
    }> {
      return this.investigationsService.findAll(query, organizationId);
    }
    ```

    **Rationale:** Investigations page needs standalone endpoint to list all investigations (not case-scoped). Follows same pattern as Cases controller GET /cases endpoint.

    **Why this approach:** Reuses existing InvestigationQueryDto and follows established pagination pattern from Phase 6.

  </action>
  <verify>
    1. Run `npm run typecheck` in apps/backend - should pass
    2. Start backend: `cd apps/backend && npm run start:dev`
    3. Test endpoint: `curl http://localhost:3000/api/v1/investigations -H "Authorization: Bearer [token]"`
    4. Verify response has { data: [], total: number, limit: number, page: number } structure
  </verify>
  <done>
    - InvestigationsService.findAll() method exists with pagination support
    - InvestigationsController GET /investigations endpoint registered
    - Endpoint returns investigations list with case and assignee details
    - Investigations page loads data successfully
  </done>
</task>

<task type="auto">
  <name>Fix Search by Populating search_vector (Seeder)</name>
  <files>
    apps/backend/prisma/seeders/case.seeder.ts
  </files>
  <action>
    **Issue: Seeded cases have null search_vector because createMany() bypasses PostgreSQL triggers**

    In `case.seeder.ts`, find the case creation section (likely using `prisma.case.create()` or `prisma.case.createMany()` in a loop).

    **After all case creation completes**, add SQL UPDATE to populate search_vector:

    ```typescript
    // After all case creation
    console.log('Populating search vectors for seeded cases...');
    await prisma.$executeRaw`
      UPDATE "Case"
      SET search_vector =
        setweight(to_tsvector('english', COALESCE("referenceNumber", '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(title, '')), 'A') ||
        setweight(to_tsvector('english', COALESCE(description, '')), 'B') ||
        setweight(to_tsvector('english', COALESCE(summary, '')), 'C')
      WHERE "organizationId" = ${organizationId}
        AND search_vector IS NULL;
    `;
    console.log('Search vectors populated for cases');
    ```

    **Rationale:** PostgreSQL triggers that populate search_vector only fire on INSERT, not during bulk operations. Manual SQL UPDATE ensures search works on seeded data.

    **Why this approach:** Matches search_vector definition from Phase 1 search infrastructure. Uses weighted fields (A=highest for reference/title, B=medium for description, C=lower for summary).

  </action>
  <verify>
    1. Run seeder: `cd apps/backend && npm run seed`
    2. Check search_vector column: `psql -c "SELECT id, search_vector IS NULL FROM \"Case\" LIMIT 5;"`
    3. Verify all seeded cases have non-null search_vector
    4. Test search in UI: type "harassment" in search box, verify cases appear (not empty table)
  </verify>
  <done>
    - Case seeder includes SQL UPDATE to populate search_vector after creation
    - All seeded cases have populated search_vector (not null)
    - Search box filtering works - typing shows matching cases instead of empty table
  </done>
</task>

<task type="auto">
  <name>Wire Export Endpoints (Cases, Policies, Investigations)</name>
  <files>
    apps/backend/src/modules/cases/cases.controller.ts
    apps/backend/src/modules/policies/policies.controller.ts
    apps/backend/src/modules/investigations/investigations.controller.ts
  </files>
  <action>
    **Issue: Export button calls POST /{entity}/export but endpoints don't exist**

    **Background:** ExcelExportService already exists from Phase 11 (apps/backend/src/modules/analytics/exports/excel-export.service.ts) with methods:
    - `generateBuffer(columns, rows, options)` - For <10k rows with formatting
    - `streamExport(columns, rows, stream, options)` - For >10k rows

    **Part 1: Cases Export Endpoint**

    Add to `cases.controller.ts`:

    ```typescript
    import { ExcelExportService } from '../analytics/exports/excel-export.service';

    // In constructor, inject ExcelExportService:
    constructor(
      private readonly casesService: CasesService,
      private readonly activityService: ActivityService,
      private readonly excelExportService: ExcelExportService, // ADD THIS
    ) {}

    /**
     * POST /api/v1/cases/export
     * Exports filtered cases to Excel or CSV.
     */
    @Post('export')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({
      summary: 'Export cases',
      description: 'Exports filtered cases to Excel or CSV format',
    })
    @ApiResponse({ status: 200, description: 'File generated successfully' })
    @ApiResponse({ status: 400, description: 'Validation error' })
    @ApiResponse({ status: 401, description: 'Unauthorized' })
    async export(
      @Body() body: { format: 'excel' | 'csv'; filters?: any; columns?: string[] },
      @Query() query: CaseQueryDto,
      @TenantId() organizationId: string,
      @Res() res: Response,
    ): Promise<void> {
      const { format, columns } = body;

      // Get filtered cases (reuse existing findAll logic)
      const { data } = await this.casesService.findAll(query, organizationId);

      // Default columns if not specified
      const exportColumns = columns || [
        'referenceNumber', 'title', 'status', 'priority', 'category',
        'createdAt', 'assignee', 'daysOpen'
      ];

      // Map columns to ExcelExportService format
      const columnDefs = exportColumns.map(col => ({
        key: col,
        header: col.charAt(0).toUpperCase() + col.slice(1).replace(/([A-Z])/g, ' $1'),
        width: 20,
      }));

      // Map case data to rows
      const rows = data.map(c => ({
        referenceNumber: c.referenceNumber,
        title: c.title,
        status: c.status,
        priority: c.priority,
        category: c.category?.name || '',
        createdAt: c.createdAt.toISOString().split('T')[0],
        assignee: c.assignee?.name || 'Unassigned',
        daysOpen: Math.floor((Date.now() - c.createdAt.getTime()) / (1000 * 60 * 60 * 24)),
      }));

      // Generate Excel buffer
      const buffer = await this.excelExportService.generateBuffer(
        columnDefs,
        rows,
        { sheetName: 'Cases Export' },
      );

      // Send file response
      const filename = `cases-export-${new Date().toISOString().split('T')[0]}.xlsx`;
      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');
      res.setHeader('Content-Disposition', `attachment; filename="${filename}"`);
      res.send(buffer);
    }
    ```

    **Part 2: Policies Export Endpoint**

    Add similar endpoint to `policies.controller.ts`:

    ```typescript
    import { ExcelExportService } from '../analytics/exports/excel-export.service';

    // Inject in constructor

    @Post('export')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: 'Export policies', description: 'Exports policies to Excel' })
    async export(
      @Body() body: { format: 'excel' | 'csv'; columns?: string[] },
      @Query() query: any,
      @TenantId() organizationId: string,
      @Res() res: Response,
    ): Promise<void> {
      // Similar pattern to cases export
      // Query policies, map to rows, generate Excel, send response
    }
    ```

    **Part 3: Investigations Export Endpoint**

    Add similar endpoint to `investigations.controller.ts`:

    ```typescript
    @Post('export')
    @HttpCode(HttpStatus.OK)
    @ApiOperation({ summary: 'Export investigations', description: 'Exports investigations to Excel' })
    async export(
      @Body() body: { format: 'excel' | 'csv'; columns?: string[] },
      @Query() query: InvestigationQueryDto,
      @TenantId() organizationId: string,
      @Res() res: Response,
    ): Promise<void> {
      // Similar pattern
    }
    ```

    **Rationale:** ExcelExportService from Phase 11 provides battle-tested Excel generation. We wire it to entity controllers following NestJS controller pattern.

    **Why this approach:** Reuses existing Phase 11 infrastructure (11-07-PLAN.md created ExcelExportService). No new dependencies needed. Direct buffer response for <10k rows avoids job queue complexity for typical exports.

  </action>
  <verify>
    1. Run `npm run typecheck` in apps/backend - should pass
    2. Start backend: `cd apps/backend && npm run start:dev`
    3. Test cases export: `curl -X POST http://localhost:3000/api/v1/cases/export -H "Authorization: Bearer [token]" -H "Content-Type: application/json" -d '{"format":"excel"}' --output test-cases.xlsx`
    4. Verify test-cases.xlsx opens in Excel with case data
    5. Test in UI: Click Export button on Cases page, select Excel, verify file downloads
  </verify>
  <done>
    - Cases, Policies, and Investigations controllers have POST /export endpoints
    - Endpoints use ExcelExportService from Phase 11 for file generation
    - Export button downloads Excel files with current filter results
    - CSV format supported (detected by file extension or format parameter)
  </done>
</task>

</tasks>

<verification>

## Automated Checks

```bash
# TypeScript compilation
cd apps/frontend && npm run typecheck
cd apps/backend && npm run typecheck

# Backend start (verify no crashes)
cd apps/backend && npm run start:dev

# Test investigations endpoint
curl http://localhost:3000/api/v1/investigations \
  -H "Authorization: Bearer [demo-token]"

# Test export endpoint
curl -X POST http://localhost:3000/api/v1/cases/export \
  -H "Authorization: Bearer [demo-token]" \
  -H "Content-Type: application/json" \
  -d '{"format":"excel"}' \
  --output test.xlsx

# Verify seeded data has search_vector
psql ethico_dev -c "SELECT COUNT(*) FROM \"Case\" WHERE search_vector IS NULL;"
# Should return 0
```

## Manual Verification (Human)

1. **Board View Cards:** Navigate to Cases > Board View
   - Verify cards show priority badge (colored chip)
   - Verify cards show owner avatar/name
   - Verify cards are full width (not narrow/compressed)

2. **Board View Drag-Drop:** In Cases Board View
   - Drag a case from "Open" to "In Progress" lane
   - Verify card stays in new lane (doesn't snap back)
   - Refresh page - verify case still in "In Progress"

3. **Investigations Page:** Navigate to Investigations
   - Verify table shows investigation data (not empty)
   - Verify columns: Case #, Title, Status, Assignee, Created Date

4. **Search Filtering:** On Cases page
   - Type "harassment" in search box
   - Verify table shows filtered cases (not empty table)
   - Clear search - verify all cases return

5. **Export Functionality:** On Cases page
   - Click Export button dropdown
   - Select "Excel"
   - Verify file downloads (cases-export-YYYY-MM-DD.xlsx)
   - Open file in Excel - verify case data present with headers

6. **Cross-Module Export:** Repeat export test on Policies and Investigations pages
   </verification>

<success_criteria>

**All 4 UAT gaps must be closed:**

1. **Board View (Test 11):**
   - [ ] Priority badge displays on cards in lanes
   - [ ] Owner avatar/name displays on cards
   - [ ] Cards are full width (w-full class applied)
   - [ ] Drag-and-drop persists status change (card stays in new lane)
   - [ ] Page refresh maintains status change (database updated)

2. **Investigations Empty (Test 12):**
   - [ ] Investigations page loads data (GET /investigations returns results)
   - [ ] Table shows investigations with case details
   - [ ] Pagination works (can navigate pages if >25 investigations)

3. **Search Hides Data (Test 17):**
   - [ ] Typing in search box filters results (doesn't empty table)
   - [ ] Seeded cases have non-null search_vector
   - [ ] Search returns relevant results based on keywords

4. **Export Not Working (Test 18):**
   - [ ] Cases export downloads Excel file
   - [ ] Policies export downloads Excel file
   - [ ] Investigations export downloads Excel file
   - [ ] Excel files contain filtered data with proper columns
   - [ ] CSV option works (if selected)

**Technical criteria:**

- [ ] All TypeScript compilation succeeds (frontend + backend)
- [ ] Backend starts without errors
- [ ] All new endpoints return 200 status (not 404/500)
      </success_criteria>

<output>
After completion, create `.planning/phases/13-hubspot-style-saved-views-system/13-16-SUMMARY.md` documenting:

- All 4 UAT gaps closed
- Board view field mappings corrected
- Status persistence via PATCH endpoint
- Investigations list endpoint added
- Search vector population in seeder
- Export endpoints wired across 3 modules
- Manual verification results
- Phase 13 completion confirmation
  </output>
