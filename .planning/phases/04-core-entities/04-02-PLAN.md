---
phase: 04-core-entities
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/persons/persons.service.ts
  - apps/backend/src/modules/persons/dto/create-person.dto.ts
  - apps/backend/src/modules/persons/dto/update-person.dto.ts
autonomous: true

must_haves:
  truths:
    - "Person records of type EMPLOYEE link to Employee table via employeeId"
    - "Employee-linked Person records have business_unit_id, manager_id, job_title, status from Employee"
    - "Manager hierarchy is navigable through Employee -> manager_id self-reference"
    - "Creating a Person from Employee copies key fields for denormalized access"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Person-Employee relation with FK"
      contains: "employeeId String?"
    - path: "apps/backend/src/modules/persons/persons.service.ts"
      provides: "createFromEmployee method"
      exports: ["PersonsService"]
  key_links:
    - from: "apps/backend/prisma/schema.prisma"
      to: "Person.employeeId"
      via: "@relation to Employee"
      pattern: "employee Employee?"
---

<objective>
Add Employee-specific fields to Person and implement the Person-Employee linkage for HRIS-synced employees.

Purpose: When Person.type = EMPLOYEE, the Person should link to the existing Employee record and surface key fields (business unit, manager, job title) for filtering and display without always joining to Employee table.

Output: Enhanced Person model with Employee relation and denormalized fields, service methods for creating Person from Employee.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-entities/04-CONTEXT.md
@.planning/phases/04-core-entities/04-01-SUMMARY.md
@apps/backend/prisma/schema.prisma
@apps/backend/src/modules/persons/persons.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Employee-related fields to Person model</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
    Update the Person model to add Employee-linked fields:

    1. Add Employee relation (already has employeeId):
       ```prisma
       employee Employee? @relation(fields: [employeeId], references: [id])
       ```

    2. Add denormalized Employee fields (copied when Person created from Employee):
       - businessUnitId String? @map("business_unit_id")
       - businessUnitName String? @map("business_unit_name")
       - managerId String? @map("manager_id") // FK to another Person
       - managerName String? @map("manager_name") // Denormalized for display
       - jobTitle String? @map("job_title")
       - employmentStatus String? @map("employment_status")
       - locationId String? @map("location_id")
       - locationName String? @map("location_name")

    3. Add self-referential manager relation:
       ```prisma
       manager Person? @relation("PersonManager", fields: [managerId], references: [id])
       directReports Person[] @relation("PersonManager")
       ```

    4. Add index for manager lookups:
       - @@index([organizationId, managerId])
       - @@index([organizationId, businessUnitId])

    5. Add persons relation to Employee model:
       ```prisma
       // In Employee model
       personRecords Person[]
       ```

    Run `npx prisma format` to validate.
  </action>
  <verify>
    ```bash
    cd apps/backend && npx prisma validate
    ```
  </verify>
  <done>Person model has Employee relation, denormalized employee fields, and manager self-reference.</done>
</task>

<task type="auto">
  <name>Task 2: Update PersonsService with Employee linkage methods</name>
  <files>
    apps/backend/src/modules/persons/persons.service.ts
    apps/backend/src/modules/persons/dto/create-person.dto.ts
    apps/backend/src/modules/persons/dto/update-person.dto.ts
  </files>
  <action>
    1. Update CreatePersonDto to add optional employee-linked fields:
       - businessUnitId, businessUnitName: string (optional)
       - managerId, managerName: string (optional)
       - jobTitle, employmentStatus: string (optional)
       - locationId, locationName: string (optional)

    2. Add createFromEmployee method to PersonsService:
       ```typescript
       async createFromEmployee(
         employeeId: string,
         userId: string,
         organizationId: string,
       ): Promise<Person> {
         // 1. Fetch employee with manager relation
         const employee = await this.prisma.employee.findUnique({
           where: { id: employeeId },
           include: { manager: true, teamAssignment: true, locationAssignment: true },
         });

         // 2. Check if Person already exists for this Employee
         const existing = await this.prisma.person.findFirst({
           where: { organizationId, employeeId },
         });
         if (existing) return existing;

         // 3. Find or create manager Person (if employee has manager)
         let managerPersonId: string | undefined;
         if (employee.managerId) {
           const managerPerson = await this.createFromEmployee(
             employee.managerId,
             userId,
             organizationId,
           );
           managerPersonId = managerPerson.id;
         }

         // 4. Create Person with denormalized fields
         const person = await this.prisma.person.create({
           data: {
             organizationId,
             type: 'EMPLOYEE',
             source: 'HRIS_SYNC',
             firstName: employee.firstName,
             lastName: employee.lastName,
             email: employee.email,
             phone: employee.phone,
             employeeId: employee.id,
             businessUnitId: employee.businessUnitId,
             businessUnitName: employee.department, // denormalized
             managerId: managerPersonId,
             managerName: employee.managerName,
             jobTitle: employee.jobTitle,
             employmentStatus: employee.employmentStatus,
             locationId: employee.locationId,
             locationName: employee.location,
             anonymityTier: 'OPEN',
             status: 'ACTIVE',
             createdById: userId,
             updatedById: userId,
           },
         });

         // 5. Emit event and log audit
         this.eventEmitter.emit('person.created', {
           organizationId,
           personId: person.id,
           source: 'HRIS_SYNC',
         });

         return person;
       }
       ```

    3. Add syncFromEmployee method for updates:
       ```typescript
       async syncFromEmployee(
         personId: string,
         employeeId: string,
         userId: string,
         organizationId: string,
       ): Promise<Person> {
         const employee = await this.prisma.employee.findUnique({
           where: { id: employeeId },
         });

         return this.prisma.person.update({
           where: { id: personId },
           data: {
             firstName: employee.firstName,
             lastName: employee.lastName,
             email: employee.email,
             jobTitle: employee.jobTitle,
             employmentStatus: employee.employmentStatus,
             updatedById: userId,
           },
         });
       }
       ```

    4. Add findByEmployeeId method:
       ```typescript
       async findByEmployeeId(
         employeeId: string,
         organizationId: string,
       ): Promise<Person | null> {
         return this.prisma.person.findFirst({
           where: { organizationId, employeeId },
         });
       }
       ```

    5. Add getManagerChain method for org chart navigation:
       ```typescript
       async getManagerChain(
         personId: string,
         organizationId: string,
       ): Promise<Person[]> {
         const chain: Person[] = [];
         let current = await this.prisma.person.findUnique({
           where: { id: personId },
         });

         while (current?.managerId) {
           const manager = await this.prisma.person.findUnique({
             where: { id: current.managerId },
           });
           if (manager) {
             chain.push(manager);
             current = manager;
           } else {
             break;
           }
         }

         return chain;
       }
       ```
  </action>
  <verify>
    ```bash
    cd apps/backend && npm run build
    ```
  </verify>
  <done>PersonsService has createFromEmployee, syncFromEmployee, findByEmployeeId, getManagerChain methods.</done>
</task>

<task type="auto">
  <name>Task 3: Run migration for Employee linkage fields</name>
  <files>apps/backend/prisma/migrations/</files>
  <action>
    1. Generate and apply migration:
       ```bash
       cd apps/backend && npx prisma migrate dev --name add_person_employee_linkage
       ```

    2. Verify migration includes:
       - ALTER TABLE persons ADD COLUMN business_unit_id
       - ALTER TABLE persons ADD COLUMN manager_id (self-reference)
       - New indexes for manager and business unit lookups

    3. Regenerate Prisma client:
       ```bash
       cd apps/backend && npx prisma generate
       ```
  </action>
  <verify>
    ```bash
    cd apps/backend && npx prisma db push && npm run build
    ```
  </verify>
  <done>Database schema updated with Employee linkage fields and self-referential manager relation.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema validates:
   ```bash
   cd apps/backend && npx prisma validate
   ```

2. Build succeeds:
   ```bash
   cd apps/backend && npm run build
   ```

3. Manager chain query works (manual test):
   - Create Person A (CEO, no manager)
   - Create Person B (VP, manager = A)
   - Create Person C (Manager, manager = B)
   - getManagerChain(C.id) should return [B, A]
</verification>

<success_criteria>
- Person model has Employee relation with employeeId FK
- Denormalized fields (businessUnitId, managerId, jobTitle, etc.) exist on Person
- Manager self-reference enables org chart navigation
- createFromEmployee recursively creates manager chain
- All changes compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-entities/04-02-SUMMARY.md` using the summary template.
</output>
