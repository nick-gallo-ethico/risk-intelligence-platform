---
phase: 04-core-entities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/persons/persons.module.ts
  - apps/backend/src/modules/persons/persons.service.ts
  - apps/backend/src/modules/persons/persons.controller.ts
  - apps/backend/src/modules/persons/dto/create-person.dto.ts
  - apps/backend/src/modules/persons/dto/update-person.dto.ts
  - apps/backend/src/modules/persons/types/person.types.ts
  - apps/backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Person records can be created with type (EMPLOYEE, EXTERNAL_CONTACT, ANONYMOUS_PLACEHOLDER)"
    - "Person records track source (HRIS_SYNC, MANUAL, INTAKE_CREATED)"
    - "Person records support three anonymity tiers (Anonymous, Confidential, Open)"
    - "One Anonymous Placeholder exists per organization for pattern detection"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Person model with type, source, anonymity tier enums"
      contains: "model Person"
    - path: "apps/backend/src/modules/persons/persons.service.ts"
      provides: "Person CRUD with organizationId scoping"
      exports: ["PersonsService"]
    - path: "apps/backend/src/modules/persons/persons.controller.ts"
      provides: "REST API endpoints for Person management"
      exports: ["PersonsController"]
  key_links:
    - from: "apps/backend/src/modules/persons/persons.service.ts"
      to: "prisma.person"
      via: "PrismaService injection"
      pattern: "this.prisma.person"
    - from: "apps/backend/src/app.module.ts"
      to: "PersonsModule"
      via: "imports array"
      pattern: "PersonsModule"
---

<objective>
Create the Person entity (HubSpot Contact equivalent) with type classification, source tracking, and anonymity tiers.

Purpose: Person is the foundation for all people-based pattern detection. Employees, external contacts, and anonymous reporters all become Person records that can be associated with Cases and RIUs for cross-entity analysis.

Output: Person model in Prisma schema, PersonsModule with service and controller for CRUD operations.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-entities/04-CONTEXT.md
@.planning/phases/04-core-entities/04-RESEARCH.md
@apps/backend/prisma/schema.prisma
@apps/backend/src/app.module.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Person model and enums to Prisma schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
    Add the Person model after the existing Employee model section. Include:

    1. Create PersonType enum:
       - EMPLOYEE (linked to HRIS Employee record)
       - EXTERNAL_CONTACT (vendor, contractor, customer, etc.)
       - ANONYMOUS_PLACEHOLDER (special record for anonymous reports)

    2. Create PersonSource enum:
       - HRIS_SYNC (created/updated from HRIS integration)
       - MANUAL (manually created by user)
       - INTAKE_CREATED (auto-created during RIU intake)

    3. Create AnonymityTier enum:
       - ANONYMOUS (no identifying info shared)
       - CONFIDENTIAL (identity known to limited roles)
       - OPEN (identity visible to case team)

    4. Create PersonStatus enum:
       - ACTIVE
       - INACTIVE
       - MERGED

    5. Create Person model with fields:
       - id, organizationId (required for RLS)
       - type (PersonType)
       - source (PersonSource)
       - firstName, lastName, email, phone (all optional for anonymous)
       - employeeId (optional FK to Employee when type = EMPLOYEE)
       - company, title, relationship (for external contacts)
       - anonymityTier (default OPEN)
       - status (default ACTIVE)
       - mergedIntoPrimaryId, mergedAt, mergedById (for merge support)
       - createdAt, updatedAt, createdById, updatedById (audit)

    6. Add indexes:
       - @@index([organizationId])
       - @@index([organizationId, type])
       - @@index([organizationId, status])
       - @@unique([organizationId, email]) - only when email is not null

    7. Add Organization relation and Person array to Organization model.

    Run `npx prisma format` after changes to validate syntax.
  </action>
  <verify>
    ```bash
    cd apps/backend && npx prisma validate
    ```
    Should complete with no errors.
  </verify>
  <done>Person model, PersonType, PersonSource, AnonymityTier, PersonStatus enums exist in schema.prisma with proper indexes and relations.</done>
</task>

<task type="auto">
  <name>Task 2: Create PersonsModule with service and controller</name>
  <files>
    apps/backend/src/modules/persons/persons.module.ts
    apps/backend/src/modules/persons/persons.service.ts
    apps/backend/src/modules/persons/persons.controller.ts
    apps/backend/src/modules/persons/dto/create-person.dto.ts
    apps/backend/src/modules/persons/dto/update-person.dto.ts
    apps/backend/src/modules/persons/types/person.types.ts
    apps/backend/src/app.module.ts
  </files>
  <action>
    1. Create `apps/backend/src/modules/persons/types/person.types.ts`:
       - Export PersonType, PersonSource, AnonymityTier, PersonStatus as TypeScript types matching Prisma enums
       - Export PersonWithRelations interface for typed includes

    2. Create `apps/backend/src/modules/persons/dto/create-person.dto.ts`:
       - type: PersonType (required)
       - source: PersonSource (required)
       - firstName, lastName, email, phone: string (optional)
       - employeeId: string (optional, for EMPLOYEE type)
       - company, title, relationship: string (optional, for EXTERNAL_CONTACT)
       - anonymityTier: AnonymityTier (optional, default OPEN)
       - Use class-validator decorators: @IsEnum, @IsOptional, @IsString, @IsEmail

    3. Create `apps/backend/src/modules/persons/dto/update-person.dto.ts`:
       - Extend PartialType(CreatePersonDto) from @nestjs/mapped-types
       - Exclude type and source (immutable after creation)

    4. Create `apps/backend/src/modules/persons/persons.service.ts`:
       - Inject PrismaService, EventEmitter2, AuditService
       - create(dto, userId, organizationId): Create person, emit event, log audit
       - findAll(organizationId, filters): List with pagination and filtering
       - findOne(id, organizationId): Get single person
       - update(id, dto, userId, organizationId): Update person, emit event, log audit
       - getOrCreateAnonymousPlaceholder(organizationId): Returns singleton anonymous placeholder
       - findByEmail(email, organizationId): Lookup for intake matching

    5. Create `apps/backend/src/modules/persons/persons.controller.ts`:
       - @Controller('api/v1/persons')
       - @UseGuards(JwtAuthGuard) on class
       - POST / - create (COMPLIANCE_OFFICER, SYSTEM_ADMIN, TRIAGE_LEAD)
       - GET / - findAll (any authenticated user)
       - GET /:id - findOne (any authenticated user)
       - PATCH /:id - update (COMPLIANCE_OFFICER, SYSTEM_ADMIN)
       - Use @TenantId() and @CurrentUser() decorators

    6. Create `apps/backend/src/modules/persons/persons.module.ts`:
       - Import PrismaModule
       - Provide PersonsService
       - Export PersonsService for use by other modules

    7. Register PersonsModule in app.module.ts imports array.

    Follow existing patterns from cases module for structure.
  </action>
  <verify>
    ```bash
    cd apps/backend && npm run build
    ```
    Should compile without errors.
  </verify>
  <done>PersonsModule exists with working service, controller, and DTOs. Module registered in app.module.ts.</done>
</task>

<task type="auto">
  <name>Task 3: Run migration and generate Prisma client</name>
  <files>apps/backend/prisma/migrations/</files>
  <action>
    1. Generate and run migration:
       ```bash
       cd apps/backend && npx prisma migrate dev --name add_person_entity
       ```

    2. Verify the generated migration SQL includes:
       - CREATE TYPE person_type
       - CREATE TYPE person_source
       - CREATE TYPE anonymity_tier
       - CREATE TYPE person_status
       - CREATE TABLE persons
       - Proper indexes

    3. Generate updated Prisma client:
       ```bash
       cd apps/backend && npx prisma generate
       ```
  </action>
  <verify>
    ```bash
    cd apps/backend && npx prisma db push --force-reset && npm run build
    ```
    Should complete without errors. (Use db push for dev, migrate for production)
  </verify>
  <done>Database has persons table with all enums and indexes. Prisma client updated with Person type.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Schema validation:
   ```bash
   cd apps/backend && npx prisma validate
   ```

2. Build succeeds:
   ```bash
   cd apps/backend && npm run build
   ```

3. Type check passes:
   ```bash
   cd apps/backend && npm run typecheck
   ```

4. Manual API test (if server running):
   ```bash
   # Create a person
   curl -X POST http://localhost:3000/api/v1/persons \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer $TOKEN" \
     -d '{"type": "EXTERNAL_CONTACT", "source": "MANUAL", "firstName": "John", "lastName": "Doe", "email": "john@example.com"}'
   ```
</verification>

<success_criteria>
- Person model exists in Prisma schema with type, source, anonymity tier
- PersonsModule provides CRUD operations
- Anonymous placeholder singleton pattern works
- All changes compile and pass type checking
- Module integrated into app.module.ts
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-entities/04-01-SUMMARY.md` using the summary template.
</output>
