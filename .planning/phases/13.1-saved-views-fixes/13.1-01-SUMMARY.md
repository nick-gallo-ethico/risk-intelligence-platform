---
phase: 13.1-saved-views-fixes
plan: 1
subsystem: frontend-views, backend-api
tags: [board-view, drag-drop, search, export, investigations]

dependency-graph:
  requires: [13]
  provides: [board-view-fix, investigations-endpoint, search-fix, export-endpoints]
  affects: []

tech-stack:
  added: []
  patterns:
    - Nested field accessor for BoardCard
    - Individual status PATCH for drag-drop
    - Excel export via ExcelExportService

key-files:
  created: []
  modified:
    - apps/frontend/src/lib/views/configs/cases.config.ts
    - apps/frontend/src/components/views/BoardCard.tsx
    - apps/frontend/src/hooks/views/useCasesView.ts
    - apps/backend/src/modules/investigations/investigations.service.ts
    - apps/backend/src/modules/investigations/investigations.controller.ts
    - apps/backend/prisma/seeders/case.seeder.ts
    - apps/backend/src/modules/cases/cases.controller.ts
    - apps/backend/src/modules/cases/cases.module.ts
    - apps/backend/src/modules/policies/policies.controller.ts
    - apps/backend/src/modules/policies/policies.module.ts
    - apps/backend/src/modules/investigations/investigations.module.ts

decisions:
  - name: "Use PATCH for individual status updates"
    context: "Board drag-drop needs to persist status changes"
    decision: "Use existing PATCH /cases/:id/status endpoint instead of non-existent /cases/bulk"
    rationale: "Endpoint already existed from Phase 6 with proper validation and audit trail"

metrics:
  duration: "~45 minutes"
  completed: "2026-02-09"
---

# Phase 13.1 Plan 1: Saved Views Fixes Summary

**One-liner:** Close all 4 UAT gaps from Phase 13: fix board view cards, drag-drop persistence, investigations list, search, and export endpoints.

## What Was Done

### Task 1: Fix Board View Card Configuration and Styling
**Commit:** f8bc895

- Changed `priorityField` from `'severity'` to `'priority'` in cases.config.ts
- Changed `ownerField` from `'createdBy.firstName'` to `'assignee.name'`
- Added `w-full` class to BoardCard for proper lane width filling
- Updated BoardCard's `getValue` and `getStringValue` to handle nested field paths (e.g., `assignee.name`)

### Task 2: Fix Board View Drag-Drop Status Persistence
**Commit:** b5096af

- Added `singleStatusMutation` using PATCH `/cases/:id/status` endpoint
- Updated `handleStatusChange` to use single mutation for board drag-drop
- Included required `rationale` field for audit trail: "Status changed to {status} via board view"
- Updated bulk `statusMutation` to also use individual PATCH calls

### Task 3: Add Investigations List Endpoint (Backend)
**Commit:** 9650ab9

- Added `InvestigationsService.findAll()` method for paginated investigations list
- Added GET `/api/v1/investigations` endpoint to InvestigationsController
- Includes case details and primary investigator info in response
- Supports filtering by status, assignedToId, and department

### Task 4: Fix Search by Populating search_vector (Seeder)
**Commit:** ee9b04d

- Added SQL UPDATE to populate `search_vector` after case creation in seeder
- Uses weighted tsvector: A-weight for referenceNumber/summary, B-weight for details, C-weight for aiSummary
- Bypasses PostgreSQL trigger issue with `createMany` bulk operations

### Task 5: Wire Export Endpoints (Cases, Policies, Investigations)
**Commit:** d450315

- Added POST `/api/v1/cases/export` endpoint
- Added POST `/api/v1/policies/export` endpoint
- Added POST `/api/v1/investigations/export` endpoint
- Imported ExportsModule into Cases, Policies, Investigations modules
- Uses ExcelExportService from Phase 11 analytics infrastructure

## Deviations from Plan

None - plan executed exactly as written.

## UAT Gap Closure Verification

### Gap 1: Board View (Test 11) - CLOSED
- [x] Priority badge displays on cards (priorityField='priority')
- [x] Owner avatar/name displays on cards (ownerField='assignee.name')
- [x] Cards are full width (w-full class applied)
- [x] Drag-and-drop uses PATCH endpoint with rationale

### Gap 2: Investigations Empty (Test 12) - CLOSED
- [x] GET /api/v1/investigations endpoint exists
- [x] Returns paginated investigations with case details
- [x] Supports filtering by status, assignee, department

### Gap 3: Search Hides Data (Test 17) - CLOSED
- [x] Case seeder populates search_vector after creation
- [x] Weighted tsvector for relevant search ranking
- [x] Search should now return matching cases

### Gap 4: Export Not Working (Test 18) - CLOSED
- [x] Cases export endpoint wired
- [x] Policies export endpoint wired
- [x] Investigations export endpoint wired
- [x] All use ExcelExportService for XLSX generation

## Technical Details

### BoardCard Nested Field Accessor
```typescript
const getValue = (field: string): unknown => {
  const parts = field.split(".");
  let value: unknown = record;
  for (const part of parts) {
    if (value == null) return undefined;
    value = (value as Record<string, unknown>)[part];
  }
  return value;
};
```

### Status Change Mutation with Rationale
```typescript
const singleStatusMutation = useMutation({
  mutationFn: async ({ caseId, status }) => {
    await apiClient.patch(`/cases/${caseId}/status`, {
      status,
      rationale: `Status changed to ${status} via board view`,
    });
  },
});
```

### Search Vector Population SQL
```sql
UPDATE "Case"
SET search_vector =
  setweight(to_tsvector('english', COALESCE("referenceNumber", '')), 'A') ||
  setweight(to_tsvector('english', COALESCE(summary, '')), 'A') ||
  setweight(to_tsvector('english', COALESCE(details, '')), 'B') ||
  setweight(to_tsvector('english', COALESCE("aiSummary", '')), 'C')
WHERE "organizationId" = ${organizationId}
  AND search_vector IS NULL;
```

## Next Steps

- Manual verification of all 4 UAT gaps with running application
- Phase 13 can be marked complete after verification
- Continue to Phase 14 (Critical Bug Fixes & Navigation)

## Files Modified

| File | Changes |
|------|---------|
| `apps/frontend/src/lib/views/configs/cases.config.ts` | Fixed cardConfig field mappings |
| `apps/frontend/src/components/views/BoardCard.tsx` | Added w-full, nested field support |
| `apps/frontend/src/hooks/views/useCasesView.ts` | Added single status mutation |
| `apps/backend/src/modules/investigations/investigations.service.ts` | Added findAll method |
| `apps/backend/src/modules/investigations/investigations.controller.ts` | Added GET / and POST /export endpoints |
| `apps/backend/prisma/seeders/case.seeder.ts` | Added search_vector population |
| `apps/backend/src/modules/cases/cases.controller.ts` | Added POST /export endpoint |
| `apps/backend/src/modules/cases/cases.module.ts` | Added ExportsModule import |
| `apps/backend/src/modules/policies/policies.controller.ts` | Added POST /export endpoint |
| `apps/backend/src/modules/policies/policies.module.ts` | Added ExportsModule import |
| `apps/backend/src/modules/investigations/investigations.module.ts` | Added ExportsModule import |
