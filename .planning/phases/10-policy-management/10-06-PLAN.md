---
phase: 10-policy-management
plan: 06
type: execute
wave: 3
depends_on: [10-02]
files_modified:
  - apps/backend/src/modules/policies/associations/policy-case-association.service.ts
  - apps/backend/src/modules/policies/associations/policy-case-association.controller.ts
  - apps/backend/src/modules/policies/associations/dto/association.dto.ts
  - apps/backend/src/modules/policies/policies.module.ts
autonomous: true

must_haves:
  truths:
    - "Cases can be linked to policies (specific versions) for violation tracking"
    - "Link types distinguish VIOLATION vs REFERENCE vs GOVERNING"
    - "Users need permission on BOTH policy (read) and case (update) to create link"
    - "Policy detail shows linked cases, case detail shows linked policies"
  artifacts:
    - path: "apps/backend/src/modules/policies/associations/policy-case-association.service.ts"
      provides: "Link policies to cases"
      exports: ["PolicyCaseAssociationService"]
    - path: "apps/backend/src/modules/policies/associations/policy-case-association.controller.ts"
      provides: "REST endpoints for policy-case links"
      exports: ["PolicyCaseAssociationController"]
  key_links:
    - from: "PolicyCaseAssociationService.create"
      to: "PolicyCaseAssociation model"
      via: "prisma.policyCaseAssociation.create"
      pattern: "policyCaseAssociation.create"
---

<objective>
Create policy-to-case linking - connect policies (specific versions) to Cases for violation tracking, reference documentation, and governance mapping.

Purpose: Enable compliance officers to track which policies were violated in cases and reference policies during investigations.
Output: PolicyCaseAssociationService and endpoints for managing policy-case relationships.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-policy-management/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create association DTOs and PolicyCaseAssociationService</name>
  <files>
apps/backend/src/modules/policies/associations/dto/association.dto.ts
apps/backend/src/modules/policies/associations/policy-case-association.service.ts
  </files>
  <action>
**Create dto/association.dto.ts:**

CreatePolicyCaseAssociationDto:
- policyId: string (required)
- policyVersionId: string (optional - defaults to latest published version)
- caseId: string (required)
- linkType: PolicyCaseLinkType (required: VIOLATION | REFERENCE | GOVERNING)
- linkReason: string (optional - explanation for the link)
- violationDate: Date (optional - when violation occurred, for VIOLATION type)

UpdatePolicyCaseAssociationDto:
- linkType: PolicyCaseLinkType (optional)
- linkReason: string (optional)
- violationDate: Date (optional)

PolicyCaseQueryDto:
- policyId: string (optional - filter by policy)
- caseId: string (optional - filter by case)
- linkType: PolicyCaseLinkType (optional)
- page: number (default 1)
- limit: number (default 20)

**Create policy-case-association.service.ts:**

@Injectable() PolicyCaseAssociationService with:
- PrismaService
- ActivityService
- EventEmitter2

Methods:

`create(dto: CreatePolicyCaseAssociationDto, userId: string, organizationId: string): Promise<PolicyCaseAssociation>`
- Verify policy exists and belongs to org
- Verify case exists and belongs to org
- Get policyVersionId (use dto.policyVersionId or find latest isLatest: true)
- Check for existing link (unique constraint: policyId + caseId)
  - If exists, throw ConflictException("Policy already linked to this case")
- Create PolicyCaseAssociation
- Log activity on case: "Policy linked: {policyTitle}"
- Log activity on policy: "Linked to case: {caseReference}"
- Emit PolicyLinkedToCaseEvent
- Return association with relations

`update(id: string, dto: UpdatePolicyCaseAssociationDto, userId: string, organizationId: string): Promise<PolicyCaseAssociation>`
- Verify association exists and belongs to org
- Update fields
- Log activity
- Return updated association

`delete(id: string, userId: string, organizationId: string): Promise<void>`
- Verify association exists and belongs to org
- Delete association
- Log activity: "Policy unlinked from case"
- Emit PolicyUnlinkedFromCaseEvent

`findByPolicy(policyId: string, organizationId: string): Promise<PolicyCaseAssociation[]>`
- Return all associations for policy
- Include case relation (referenceNumber, status, title)
- Include policyVersion (version, versionLabel)
- Order by createdAt DESC

`findByCase(caseId: string, organizationId: string): Promise<PolicyCaseAssociation[]>`
- Return all associations for case
- Include policy relation (title, policyType, status)
- Include policyVersion (version, content for display)
- Order by linkType (VIOLATION first), then createdAt DESC

`findById(id: string, organizationId: string): Promise<PolicyCaseAssociation>`
- Return single association with all relations

`getViolationStats(organizationId: string, filters?: { startDate?: Date, endDate?: Date, policyType?: PolicyType }): Promise<{ policyId: string, policyTitle: string, violationCount: number }[]>`
- Aggregate violations by policy
- Return policies ordered by violation count DESC
- Useful for compliance dashboards
  </action>
  <verify>Service compiles. Methods verify both policy and case belong to organization.</verify>
  <done>PolicyCaseAssociationService provides CRUD for policy-case links with proper permission checks.</done>
</task>

<task type="auto">
  <name>Task 2: Create association controller</name>
  <files>apps/backend/src/modules/policies/associations/policy-case-association.controller.ts</files>
  <action>
Create policy-case-association.controller.ts:

@Controller('policy-case-associations')
@UseGuards(AuthGuard, RolesGuard)
@ApiBearerAuth()
@ApiTags('policy-case-associations')

Endpoints:

POST / - Create policy-case link
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR)
- @Body() CreatePolicyCaseAssociationDto
- Verify user has read access to policy and update access to case
- Returns PolicyCaseAssociation

GET / - Query associations
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR, Role.READ_ONLY)
- @Query() PolicyCaseQueryDto
- Returns { data: PolicyCaseAssociation[], total: number }

GET /:id - Get single association
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR, Role.READ_ONLY)
- Returns PolicyCaseAssociation with full relations

PUT /:id - Update association
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR)
- @Body() UpdatePolicyCaseAssociationDto
- Returns PolicyCaseAssociation

DELETE /:id - Delete association
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR)
- Returns 204 No Content

GET /by-policy/:policyId - Get associations for policy
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.POLICY_AUTHOR, Role.READ_ONLY)
- Returns PolicyCaseAssociation[]

GET /by-case/:caseId - Get associations for case
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER, Role.INVESTIGATOR, Role.READ_ONLY)
- Returns PolicyCaseAssociation[]

GET /violation-stats - Get violation statistics
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER)
- @Query() { startDate?: Date, endDate?: Date, policyType?: PolicyType }
- Returns violation counts by policy
  </action>
  <verify>Controller compiles. Endpoints have proper role guards.</verify>
  <done>PolicyCaseAssociationController exposes REST API for managing policy-case links.</done>
</task>

<task type="auto">
  <name>Task 3: Update module and create index exports</name>
  <files>
apps/backend/src/modules/policies/associations/index.ts
apps/backend/src/modules/policies/policies.module.ts
  </files>
  <action>
**Create associations/index.ts:**
```typescript
export * from './policy-case-association.service';
export * from './policy-case-association.controller';
export * from './dto/association.dto';
```

**Update policies.module.ts:**

Add to imports:
- CasesModule (for case access validation if needed)

Add to providers:
- PolicyCaseAssociationService

Add to controllers:
- PolicyCaseAssociationController

Add to exports:
- PolicyCaseAssociationService

Ensure folder structure:
```
apps/backend/src/modules/policies/
  ├── associations/
  │   ├── dto/
  │   │   └── association.dto.ts
  │   ├── policy-case-association.service.ts
  │   ├── policy-case-association.controller.ts
  │   └── index.ts
  └── ...
```
  </action>
  <verify>Run `npm run build`. Module compiles with association service and controller.</verify>
  <done>PolicyCaseAssociation exports added to module.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. create() verifies both policy and case belong to organization
3. Unique constraint prevents duplicate policy-case links
4. findByPolicy() and findByCase() return related associations
5. Activity logged on both policy and case when linked
6. Violation stats aggregation works
7. Controller endpoints have appropriate role guards
</verification>

<success_criteria>
- Policy-case links created with specific version tracking
- Three link types: VIOLATION, REFERENCE, GOVERNING
- Bidirectional queries: find cases by policy, find policies by case
- Violation statistics for compliance dashboards
- Activity logged for audit trail
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-06-SUMMARY.md`
</output>
