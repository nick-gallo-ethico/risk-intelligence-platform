---
phase: 10-policy-management
plan: 07
type: execute
wave: 3
depends_on: [10-02]
files_modified:
  - apps/backend/src/modules/search/indexing/index-mappings/policy.mapping.ts
  - apps/backend/src/modules/search/indexing/indexers/policy.indexer.ts
  - apps/backend/src/modules/policies/listeners/search-index.listener.ts
  - apps/backend/src/modules/search/search.service.ts
  - apps/backend/src/modules/policies/policies.module.ts
autonomous: true

must_haves:
  truths:
    - "Policies are indexed in Elasticsearch per tenant pattern"
    - "Search includes title, content, and translated content"
    - "Policy events trigger re-indexing automatically"
    - "Search results include policy metadata and version info"
  artifacts:
    - path: "apps/backend/src/modules/search/indexing/index-mappings/policy.mapping.ts"
      provides: "Elasticsearch mapping for policies"
      exports: ["POLICY_INDEX_MAPPING"]
    - path: "apps/backend/src/modules/search/indexing/indexers/policy.indexer.ts"
      provides: "Policy document indexer"
      exports: ["PolicyIndexer"]
  key_links:
    - from: "PolicySearchIndexListener"
      to: "IndexingService"
      via: "event-driven indexing"
      pattern: "indexingService.index"
    - from: "SearchService"
      to: "policy index"
      via: "Elasticsearch query"
      pattern: "org_.*_policies"
---

<objective>
Add policies to the Elasticsearch indexing pipeline - create mapping, indexer, and event listeners for automatic index updates on policy publish.

Purpose: Enable full-text search across policies, including translated content, following existing per-tenant index pattern.
Output: Policy ES mapping, indexer, and search integration.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-policy-management/10-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-06-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create policy Elasticsearch mapping</name>
  <files>apps/backend/src/modules/search/indexing/index-mappings/policy.mapping.ts</files>
  <action>
Create policy.mapping.ts following the established pattern from other entity mappings:

```typescript
export const POLICY_INDEX_MAPPING = {
  mappings: {
    properties: {
      // Identity
      id: { type: 'keyword' },
      organizationId: { type: 'keyword' },
      slug: { type: 'keyword' },

      // Core fields (searchable)
      title: {
        type: 'text',
        analyzer: 'compliance_analyzer',
        fields: { keyword: { type: 'keyword' } },
      },
      policyType: { type: 'keyword' },
      category: { type: 'keyword' },
      status: { type: 'keyword' },

      // Content (main searchable text)
      content: {
        type: 'text',
        analyzer: 'compliance_analyzer',
      },
      plainText: {
        type: 'text',
        analyzer: 'compliance_analyzer',
      },
      summary: {
        type: 'text',
        analyzer: 'compliance_analyzer',
      },

      // Version tracking
      currentVersion: { type: 'integer' },
      versionLabel: { type: 'keyword' },
      latestVersionId: { type: 'keyword' },

      // Dates
      effectiveDate: { type: 'date' },
      reviewDate: { type: 'date' },
      publishedAt: { type: 'date' },
      createdAt: { type: 'date' },
      updatedAt: { type: 'date' },

      // Ownership
      ownerId: { type: 'keyword' },
      ownerName: {
        type: 'text',
        fields: { keyword: { type: 'keyword' } },
      },
      ownerEmail: { type: 'keyword' },

      // Translations (denormalized for search)
      translationLanguages: { type: 'keyword' },  // Array: ['es', 'fr', 'de']
      translatedContent: {
        type: 'text',
        analyzer: 'multilingual_analyzer',
      },

      // Statistics (denormalized)
      hasActiveAttestationCampaign: { type: 'boolean' },
      linkedCaseCount: { type: 'integer' },
      attestationCompletionRate: { type: 'float' },

      // Approval status
      approvalStatus: { type: 'keyword' },  // null, PENDING, APPROVED
      workflowInstanceId: { type: 'keyword' },
    },
  },
  settings: {
    number_of_shards: 1,
    number_of_replicas: 0,
    analysis: {
      analyzer: {
        compliance_analyzer: {
          type: 'custom',
          tokenizer: 'standard',
          filter: ['lowercase', 'compliance_synonyms', 'english_stemmer'],
        },
        multilingual_analyzer: {
          type: 'custom',
          tokenizer: 'standard',
          filter: ['lowercase', 'icu_folding'],  // For accented characters
        },
      },
      filter: {
        compliance_synonyms: {
          type: 'synonym',
          synonyms: [
            'policy,procedure,guideline,standard',
            'conduct,behavior,behaviour',
            'harassment,bullying,discrimination,hostile',
            'bribery,corruption,kickback,payoff',
            'privacy,confidentiality,data protection,pii',
            'whistleblower,speak up,report,hotline',
            'ethics,integrity,compliance',
          ],
        },
        english_stemmer: {
          type: 'stemmer',
          language: 'english',
        },
      },
    },
  },
};

export const POLICY_INDEX_NAME = 'policies';
```

Add to index-mappings/index.ts exports if not already there.
  </action>
  <verify>File created with proper mapping structure. Exports POLICY_INDEX_MAPPING.</verify>
  <done>Elasticsearch mapping for policies with compliance-specific synonyms and multilingual support.</done>
</task>

<task type="auto">
  <name>Task 2: Create PolicyIndexer service</name>
  <files>apps/backend/src/modules/search/indexing/indexers/policy.indexer.ts</files>
  <action>
Create policy.indexer.ts following the pattern from other indexers:

@Injectable() PolicyIndexer with:
- PrismaService
- IndexingService (base indexing operations)

Methods:

`async indexPolicy(policyId: string, organizationId: string): Promise<void>`
- Fetch policy with relations:
  - owner (User)
  - latestVersion (PolicyVersion where isLatest: true)
  - translations (through latestVersion)
  - caseAssociations (count)
  - attestationCampaigns (active count, completion rate)
- Build document:
```typescript
const doc = {
  id: policy.id,
  organizationId: policy.organizationId,
  slug: policy.slug,
  title: policy.title,
  policyType: policy.policyType,
  category: policy.category,
  status: policy.status,
  content: latestVersion?.content || policy.draftContent,
  plainText: latestVersion?.plainText || this.extractPlainText(policy.draftContent),
  summary: latestVersion?.summary,
  currentVersion: policy.currentVersion,
  versionLabel: latestVersion?.versionLabel,
  latestVersionId: latestVersion?.id,
  effectiveDate: policy.effectiveDate,
  reviewDate: policy.reviewDate,
  publishedAt: latestVersion?.publishedAt,
  createdAt: policy.createdAt,
  updatedAt: policy.updatedAt,
  ownerId: policy.ownerId,
  ownerName: policy.owner?.name,
  ownerEmail: policy.owner?.email,
  translationLanguages: translations.map(t => t.languageCode),
  translatedContent: translations.map(t => t.plainText).join(' '),
  hasActiveAttestationCampaign: activeAttestationCount > 0,
  linkedCaseCount: caseAssociationCount,
  attestationCompletionRate: completionRate,
  approvalStatus: workflowInstance?.status || null,
  workflowInstanceId: workflowInstance?.id,
};
```
- Call indexingService.indexDocument(organizationId, 'policies', policy.id, doc)

`async removePolicy(policyId: string, organizationId: string): Promise<void>`
- Call indexingService.removeDocument(organizationId, 'policies', policyId)

`async reindexAllPolicies(organizationId: string): Promise<number>`
- Get all policies for organization
- Index each one
- Return count

`private extractPlainText(html: string | null): string`
- Strip HTML tags if content exists
- Return empty string if null

Register PolicyIndexer in SearchModule providers.
  </action>
  <verify>Indexer compiles. indexPolicy() fetches all related data and builds complete document.</verify>
  <done>PolicyIndexer indexes policies with all metadata, translations, and statistics.</done>
</task>

<task type="auto">
  <name>Task 3: Create search index event listener and update search service</name>
  <files>
apps/backend/src/modules/policies/listeners/search-index.listener.ts
apps/backend/src/modules/search/search.service.ts
apps/backend/src/modules/policies/policies.module.ts
  </files>
  <action>
**Create listeners/search-index.listener.ts:**

@Injectable() PolicySearchIndexListener with:
- PolicyIndexer

Event handlers (all { async: true }):

`@OnEvent('policy.published')`
onPolicyPublished(event) - Re-index policy (new version content)

`@OnEvent('policy.updated')`
onPolicyUpdated(event) - Re-index policy (draft changes)

`@OnEvent('policy.retired')`
onPolicyRetired(event) - Re-index policy (status change)

`@OnEvent('policy.translation.created')`
onTranslationCreated(event) - Re-index policy (new translation language)

`@OnEvent('policy.translation.updated')`
onTranslationUpdated(event) - Re-index policy (updated translation)

`@OnEvent('policy.case.linked')`
onPolicyCaseLinked(event) - Re-index policy (linked case count changed)

`@OnEvent('policy.case.unlinked')`
onPolicyCaseUnlinked(event) - Re-index policy

Wrap all handlers in try-catch - log errors, don't throw.

**Update search.service.ts:**

Add to ENTITY_TYPES constant or similar:
- 'policies' with mapping reference

Add or update searchPolicies() method if not using generic search:
```typescript
async searchPolicies(
  query: string,
  organizationId: string,
  filters?: {
    status?: PolicyStatus[],
    policyType?: PolicyType[],
    ownerId?: string,
    translationLanguages?: string[],
  },
  pagination?: { page: number, limit: number },
): Promise<{ hits: any[], total: number }>
```

Use existing searchEntities pattern if available, or add policies to supported types.

**Update policies.module.ts:**

Add to providers:
- PolicySearchIndexListener

Add to imports:
- SearchModule (if not already)
  </action>
  <verify>Run `npm run build`. Listener handles all policy events. Search service supports policy search.</verify>
  <done>Policy events trigger automatic re-indexing, search service includes policy support.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. POLICY_INDEX_MAPPING includes all fields (title, content, translations, stats)
3. PolicyIndexer.indexPolicy() fetches policy with all relations
4. Event handlers trigger re-indexing on publish, update, translation changes
5. Search service can query policies index
6. Index follows per-tenant naming: org_{orgId}_policies
</verification>

<success_criteria>
- Policies indexed in Elasticsearch per tenant pattern (org_{orgId}_policies)
- Search includes title, content, summary, and translated content
- Policy events (publish, update, translation) trigger automatic re-indexing
- Search results include version info, owner, translation languages
- Compliance synonyms improve search relevance
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-07-SUMMARY.md`
</output>
