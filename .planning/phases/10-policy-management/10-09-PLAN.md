---
phase: 10-policy-management
plan: 09
type: execute
wave: 4
depends_on: [10-04, 10-05, 10-06, 10-07]
files_modified:
  - apps/frontend/src/app/(authenticated)/policies/[id]/page.tsx
  - apps/frontend/src/components/policies/policy-detail-header.tsx
  - apps/frontend/src/components/policies/policy-version-history.tsx
  - apps/frontend/src/components/policies/policy-translations-panel.tsx
  - apps/frontend/src/components/policies/policy-attestations-panel.tsx
  - apps/frontend/src/components/policies/policy-cases-panel.tsx
  - apps/frontend/src/components/policies/policy-version-diff.tsx
autonomous: true

must_haves:
  truths:
    - "Policy detail page shows content with tabbed sections"
    - "Version history shows all published versions with diff view"
    - "Translations panel shows available languages and status"
    - "Attestation campaigns panel shows campaign status and completion"
    - "Linked cases panel shows policy-case associations"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/policies/[id]/page.tsx"
      provides: "Policy detail page with tabs"
      min_lines: 80
    - path: "apps/frontend/src/components/policies/policy-version-diff.tsx"
      provides: "Version comparison with diff highlighting"
      min_lines: 50
  key_links:
    - from: "PolicyDetailPage"
      to: "policiesApi"
      via: "data fetching"
      pattern: "policiesApi"
    - from: "PolicyVersionDiff"
      to: "diff library"
      via: "diffChars or diffWords"
      pattern: "diff"
---

<objective>
Create the policy detail page with version history, translations panel, attestation campaigns, and linked cases - providing full visibility into policy lifecycle and distribution.

Purpose: Enable compliance officers to view complete policy status, compare versions, manage translations, and track attestation compliance.
Output: Policy detail page with tabbed interface for all related information.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-policy-management/10-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create policy detail page structure with tabs</name>
  <files>
apps/frontend/src/app/(authenticated)/policies/[id]/page.tsx
apps/frontend/src/components/policies/policy-detail-header.tsx
  </files>
  <action>
**Create components/policies/policy-detail-header.tsx:**

PolicyDetailHeader component:
- Props: policy, onEdit, onPublish, onRetire
- Display: Title, Status badge, Policy type badge, Version info
- Metadata row: Owner, Effective date, Review date (with warning if overdue)
- Action buttons:
  - Edit (if DRAFT or PUBLISHED)
  - Submit for Approval (if DRAFT)
  - Publish (if APPROVED)
  - Create Attestation Campaign (if PUBLISHED)
  - Retire (if PUBLISHED)
- Approval status indicator if PENDING_APPROVAL:
  - Current step name
  - Pending reviewer names
  - "Cancel Approval" button

```tsx
interface PolicyDetailHeaderProps {
  policy: Policy;
  onEdit: () => void;
  onPublish: () => void;
  onRetire: () => void;
  onCreateAttestation: () => void;
}

export function PolicyDetailHeader({
  policy,
  onEdit,
  onPublish,
  onRetire,
  onCreateAttestation,
}: PolicyDetailHeaderProps) {
  const isReviewOverdue = policy.reviewDate && new Date(policy.reviewDate) < new Date();

  return (
    <div className="space-y-4">
      <div className="flex items-start justify-between">
        <div>
          <div className="flex items-center gap-2">
            <h1 className="text-2xl font-semibold">{policy.title}</h1>
            <StatusBadge status={policy.status} />
          </div>
          <div className="flex items-center gap-4 mt-2 text-sm text-muted-foreground">
            <span>v{policy.currentVersion || 'Draft'}</span>
            <span>{formatPolicyType(policy.policyType)}</span>
            {policy.owner && <span>Owner: {policy.owner.name}</span>}
          </div>
        </div>
        <div className="flex gap-2">
          {/* Action buttons based on status */}
        </div>
      </div>

      {/* Review date warning */}
      {isReviewOverdue && (
        <Alert variant="warning">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            This policy is due for review (was due {formatDate(policy.reviewDate)})
          </AlertDescription>
        </Alert>
      )}

      {/* Approval workflow status */}
      {policy.status === 'PENDING_APPROVAL' && (
        <ApprovalStatusCard policyId={policy.id} />
      )}
    </div>
  );
}
```

**Create app/(authenticated)/policies/[id]/page.tsx:**

PolicyDetailPage with:
- Fetch policy by ID with React Query
- PolicyDetailHeader
- Tabs component (shadcn/ui Tabs):
  - Content (default) - render rich text content
  - Versions - PolicyVersionHistory
  - Translations - PolicyTranslationsPanel
  - Attestations - PolicyAttestationsPanel
  - Linked Cases - PolicyCasesPanel
- Tab sync with URL: ?tab=versions
- Loading skeleton
- Not found state

```tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { useParams, useRouter, useSearchParams } from 'next/navigation';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { PolicyDetailHeader } from '@/components/policies/policy-detail-header';
import { PolicyVersionHistory } from '@/components/policies/policy-version-history';
import { PolicyTranslationsPanel } from '@/components/policies/policy-translations-panel';
import { PolicyAttestationsPanel } from '@/components/policies/policy-attestations-panel';
import { PolicyCasesPanel } from '@/components/policies/policy-cases-panel';
import { policiesApi } from '@/services/policies';
import { RichTextDisplay } from '@/components/rich-text/rich-text-display';

export default function PolicyDetailPage() {
  const { id } = useParams<{ id: string }>();
  const router = useRouter();
  const searchParams = useSearchParams();
  const currentTab = searchParams.get('tab') || 'content';

  const { data: policy, isLoading } = useQuery({
    queryKey: ['policy', id],
    queryFn: () => policiesApi.getById(id),
  });

  const { data: versions } = useQuery({
    queryKey: ['policy-versions', id],
    queryFn: () => policiesApi.getVersions(id),
    enabled: currentTab === 'versions',
  });

  const handleTabChange = (tab: string) => {
    router.push(`/policies/${id}?tab=${tab}`);
  };

  if (isLoading) return <PolicyDetailSkeleton />;
  if (!policy) return <NotFound />;

  // Get display content (latest version or draft)
  const displayContent = policy.currentVersion > 0
    ? versions?.find(v => v.isLatest)?.content
    : policy.draftContent;

  return (
    <div className="space-y-6">
      <PolicyDetailHeader
        policy={policy}
        onEdit={() => router.push(`/policies/${id}/edit`)}
        onPublish={() => {/* publish dialog */}}
        onRetire={() => {/* retire confirmation */}}
        onCreateAttestation={() => router.push(`/attestations/new?policyId=${id}`)}
      />

      <Tabs value={currentTab} onValueChange={handleTabChange}>
        <TabsList>
          <TabsTrigger value="content">Content</TabsTrigger>
          <TabsTrigger value="versions">Versions ({policy.currentVersion})</TabsTrigger>
          <TabsTrigger value="translations">Translations</TabsTrigger>
          <TabsTrigger value="attestations">Attestations</TabsTrigger>
          <TabsTrigger value="cases">Linked Cases</TabsTrigger>
        </TabsList>

        <TabsContent value="content" className="mt-6">
          <div className="prose max-w-none">
            <RichTextDisplay content={displayContent} />
          </div>
        </TabsContent>

        <TabsContent value="versions">
          <PolicyVersionHistory policyId={id} versions={versions} />
        </TabsContent>

        <TabsContent value="translations">
          <PolicyTranslationsPanel policyId={id} latestVersionId={versions?.find(v => v.isLatest)?.id} />
        </TabsContent>

        <TabsContent value="attestations">
          <PolicyAttestationsPanel policyId={id} />
        </TabsContent>

        <TabsContent value="cases">
          <PolicyCasesPanel policyId={id} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```
  </action>
  <verify>Page compiles. Tabs navigate correctly. Header shows policy metadata and actions.</verify>
  <done>Policy detail page with header and tabbed content structure.</done>
</task>

<task type="auto">
  <name>Task 2: Create version history and diff components</name>
  <files>
apps/frontend/src/components/policies/policy-version-history.tsx
apps/frontend/src/components/policies/policy-version-diff.tsx
  </files>
  <action>
**Create components/policies/policy-version-diff.tsx:**

PolicyVersionDiff component:
- Props: oldContent, newContent, mode ('inline' | 'side-by-side')
- Use 'diff' library (already in package.json)
- Inline mode (default per CONTEXT.md):
  - Additions highlighted green background
  - Deletions red with strikethrough
- Side-by-side mode (toggle):
  - Two columns showing old and new
- Toggle button to switch modes

```tsx
import { diffWords } from 'diff';

interface PolicyVersionDiffProps {
  oldContent: string;
  newContent: string;
  mode?: 'inline' | 'side-by-side';
}

export function PolicyVersionDiff({
  oldContent,
  newContent,
  mode = 'inline',
}: PolicyVersionDiffProps) {
  // Strip HTML for text diff, or use HTML diff library
  const oldText = stripHtml(oldContent);
  const newText = stripHtml(newContent);
  const differences = diffWords(oldText, newText);

  if (mode === 'inline') {
    return (
      <div className="prose max-w-none">
        {differences.map((part, i) => (
          <span
            key={i}
            className={cn(
              part.added && 'bg-green-100 text-green-800',
              part.removed && 'bg-red-100 text-red-800 line-through',
            )}
          >
            {part.value}
          </span>
        ))}
      </div>
    );
  }

  // Side-by-side mode
  return (
    <div className="grid grid-cols-2 gap-4">
      <div className="border rounded p-4">
        <h4 className="font-medium mb-2">Previous Version</h4>
        <RichTextDisplay content={oldContent} />
      </div>
      <div className="border rounded p-4">
        <h4 className="font-medium mb-2">Current Version</h4>
        <RichTextDisplay content={newContent} />
      </div>
    </div>
  );
}
```

**Create components/policies/policy-version-history.tsx:**

PolicyVersionHistory component:
- Props: policyId, versions
- Timeline display of all versions:
  - Version number/label
  - Published date and by whom
  - Change notes (if any)
  - "View" button to see full content
  - "Compare" button to show diff with previous version
- Selected version detail panel:
  - Full content
  - Summary
  - Effective date
- Compare mode:
  - Select two versions
  - Show PolicyVersionDiff between them

```tsx
interface PolicyVersionHistoryProps {
  policyId: string;
  versions?: PolicyVersion[];
}

export function PolicyVersionHistory({ policyId, versions }: PolicyVersionHistoryProps) {
  const [selectedVersion, setSelectedVersion] = useState<PolicyVersion | null>(null);
  const [compareVersions, setCompareVersions] = useState<[string, string] | null>(null);
  const [diffMode, setDiffMode] = useState<'inline' | 'side-by-side'>('inline');

  if (!versions?.length) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        No versions published yet. Publish this policy to create the first version.
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Mode toggle */}
      <div className="flex justify-end">
        <ToggleGroup value={diffMode} onValueChange={setDiffMode}>
          <ToggleGroupItem value="inline">Inline</ToggleGroupItem>
          <ToggleGroupItem value="side-by-side">Side by Side</ToggleGroupItem>
        </ToggleGroup>
      </div>

      {/* Version timeline */}
      <div className="space-y-4">
        {versions.map((version, index) => (
          <div key={version.id} className="flex items-start gap-4 border-l-2 pl-4">
            <div className="flex-1">
              <div className="flex items-center gap-2">
                <Badge variant={version.isLatest ? 'default' : 'outline'}>
                  v{version.version}
                </Badge>
                {version.versionLabel && <span>{version.versionLabel}</span>}
                {version.isLatest && <Badge variant="secondary">Latest</Badge>}
              </div>
              <p className="text-sm text-muted-foreground mt-1">
                Published {formatDate(version.publishedAt)} by {version.publishedBy?.name}
              </p>
              {version.changeNotes && (
                <p className="text-sm mt-2">{version.changeNotes}</p>
              )}
            </div>
            <div className="flex gap-2">
              <Button variant="outline" size="sm" onClick={() => setSelectedVersion(version)}>
                View
              </Button>
              {index < versions.length - 1 && (
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => setCompareVersions([versions[index + 1].id, version.id])}
                >
                  Compare
                </Button>
              )}
            </div>
          </div>
        ))}
      </div>

      {/* Diff view */}
      {compareVersions && (
        <PolicyVersionDiff
          oldContent={versions.find(v => v.id === compareVersions[0])?.content || ''}
          newContent={versions.find(v => v.id === compareVersions[1])?.content || ''}
          mode={diffMode}
        />
      )}
    </div>
  );
}
```
  </action>
  <verify>Components compile. Diff shows additions green, deletions red. Toggle switches modes.</verify>
  <done>Version history timeline with diff comparison between versions.</done>
</task>

<task type="auto">
  <name>Task 3: Create translations, attestations, and cases panels</name>
  <files>
apps/frontend/src/components/policies/policy-translations-panel.tsx
apps/frontend/src/components/policies/policy-attestations-panel.tsx
apps/frontend/src/components/policies/policy-cases-panel.tsx
  </files>
  <action>
**Create components/policies/policy-translations-panel.tsx:**

PolicyTranslationsPanel:
- Props: policyId, latestVersionId
- Fetch translations for latest version
- Grid of translation cards:
  - Language flag/name
  - Status badge (PENDING_REVIEW, APPROVED, PUBLISHED)
  - Stale indicator with "Refresh" button
  - "View", "Edit" buttons
- "Add Translation" button with language selector
- Empty state: "No translations yet"

```tsx
export function PolicyTranslationsPanel({ policyId, latestVersionId }: Props) {
  const { data: translations } = useQuery({
    queryKey: ['policy-translations', latestVersionId],
    queryFn: () => policiesApi.getTranslations(latestVersionId!),
    enabled: !!latestVersionId,
  });

  const createMutation = useMutation({
    mutationFn: ({ versionId, languageCode }: any) =>
      policiesApi.createTranslation(versionId, languageCode),
    onSuccess: () => queryClient.invalidateQueries(['policy-translations']),
  });

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-medium">Translations</h3>
        <AddTranslationDialog onAdd={(lang) => createMutation.mutate({ versionId: latestVersionId, languageCode: lang })} />
      </div>

      <div className="grid grid-cols-3 gap-4">
        {translations?.map((t) => (
          <TranslationCard key={t.id} translation={t} />
        ))}
      </div>
    </div>
  );
}
```

**Create components/policies/policy-attestations-panel.tsx:**

PolicyAttestationsPanel:
- Props: policyId
- Fetch attestation campaigns for this policy
- Campaign cards showing:
  - Campaign name
  - Status (ACTIVE, COMPLETED, etc.)
  - Progress bar (completed/total)
  - Due date
  - "View Campaign" link
- "Create Attestation Campaign" button
- Empty state if no campaigns

**Create components/policies/policy-cases-panel.tsx:**

PolicyCasesPanel:
- Props: policyId
- Fetch policy-case associations
- Table with columns:
  - Case Reference
  - Case Title
  - Link Type (VIOLATION badge red, REFERENCE badge blue, GOVERNING badge gray)
  - Violation Date (if applicable)
  - Linked Date
  - Actions (View Case, Unlink)
- "Link to Case" button opening case search dialog
- Empty state: "No cases linked to this policy"

```tsx
export function PolicyCasesPanel({ policyId }: { policyId: string }) {
  const { data: associations } = useQuery({
    queryKey: ['policy-case-associations', policyId],
    queryFn: () => fetch(`/api/policy-case-associations/by-policy/${policyId}`).then(r => r.json()),
  });

  return (
    <div className="space-y-4">
      <div className="flex justify-between items-center">
        <h3 className="text-lg font-medium">Linked Cases</h3>
        <LinkCaseDialog policyId={policyId} />
      </div>

      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Case</TableHead>
            <TableHead>Link Type</TableHead>
            <TableHead>Violation Date</TableHead>
            <TableHead>Linked</TableHead>
            <TableHead></TableHead>
          </TableRow>
        </TableHeader>
        <TableBody>
          {associations?.map((assoc: any) => (
            <TableRow key={assoc.id}>
              <TableCell>
                <Link href={`/cases/${assoc.caseId}`}>
                  {assoc.case?.referenceNumber}
                </Link>
              </TableCell>
              <TableCell>
                <LinkTypeBadge type={assoc.linkType} />
              </TableCell>
              <TableCell>{assoc.violationDate && formatDate(assoc.violationDate)}</TableCell>
              <TableCell>{formatDate(assoc.createdAt)}</TableCell>
              <TableCell>
                <DropdownMenu>...</DropdownMenu>
              </TableCell>
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```
  </action>
  <verify>All panels compile. Data fetching works. Actions trigger mutations.</verify>
  <done>Translations, attestations, and linked cases panels complete the policy detail view.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds in frontend
2. Policy detail page loads with all tabs
3. Version history shows timeline with compare functionality
4. Diff view shows inline additions/deletions by default
5. Translations panel shows languages with status badges
6. Attestations panel shows campaign progress
7. Cases panel shows linked cases with type badges
8. Tab navigation updates URL
</verification>

<success_criteria>
- Policy detail page with tabbed sections
- Version history with all published versions
- Diff view (inline default, toggle to side-by-side)
- Translations panel with status and stale indicator
- Attestation campaigns with progress tracking
- Linked cases with type badges (VIOLATION/REFERENCE/GOVERNING)
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-09-SUMMARY.md`
</output>
