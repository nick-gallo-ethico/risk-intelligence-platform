---
phase: 10-policy-management
plan: 11
type: execute
wave: 5
depends_on: [10-08]
files_modified:
  - apps/frontend/src/app/(authenticated)/settings/organization/page.tsx
  - apps/frontend/src/components/settings/organization-general-settings.tsx
  - apps/frontend/src/components/settings/organization-branding-settings.tsx
  - apps/frontend/src/components/settings/organization-notification-settings.tsx
  - apps/frontend/src/components/settings/organization-security-settings.tsx
  - apps/frontend/src/services/organization.ts
  - apps/frontend/src/types/organization.ts
autonomous: true

must_haves:
  truths:
    - "Admin can update organization name and settings"
    - "Branding settings (logo, colors) are configurable"
    - "Notification defaults can be set at org level"
    - "Security settings (SSO, MFA requirements) are manageable"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/settings/organization/page.tsx"
      provides: "Organization settings page"
      min_lines: 80
    - path: "apps/frontend/src/components/settings/organization-general-settings.tsx"
      provides: "General org settings form"
      min_lines: 50
  key_links:
    - from: "OrganizationSettingsPage"
      to: "organizationApi"
      via: "data fetching and mutations"
      pattern: "organizationApi"
---

<objective>
Create organization settings UI - general settings, branding customization, notification defaults, and security configuration.

Purpose: Enable system admins to configure organization-wide settings and branding.
Output: Organization settings page with sections for general, branding, notifications, and security.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization types and API client</name>
  <files>
apps/frontend/src/types/organization.ts
apps/frontend/src/services/organization.ts
  </files>
  <action>
**Create types/organization.ts:**

```typescript
export interface Organization {
  id: string;
  name: string;
  slug: string;
  domain?: string;
  logoUrl?: string;
  faviconUrl?: string;
  primaryColor?: string;
  secondaryColor?: string;
  timezone: string;
  dateFormat: string;
  createdAt: string;
  updatedAt: string;
}

export interface OrganizationSettings {
  // General
  name: string;
  timezone: string;
  dateFormat: string;
  defaultLanguage: string;

  // Branding
  logoUrl?: string;
  faviconUrl?: string;
  brandingMode: 'STANDARD' | 'CO_BRANDED' | 'FULL_WHITE_LABEL';
  primaryColor?: string;
  secondaryColor?: string;
  accentColor?: string;
  customCss?: string;

  // Notifications
  defaultDigestTime: string; // HH:mm format
  digestEnabled: boolean;
  enforcedNotificationCategories: string[];
  quietHoursEnabled: boolean;
  quietHoursStart?: string;
  quietHoursEnd?: string;

  // Security
  mfaRequired: boolean;
  mfaRequiredRoles: string[];
  sessionTimeoutMinutes: number;
  passwordPolicy: {
    minLength: number;
    requireUppercase: boolean;
    requireLowercase: boolean;
    requireNumbers: boolean;
    requireSpecialChars: boolean;
  };

  // SSO
  ssoEnabled: boolean;
  ssoProvider?: 'AZURE_AD' | 'GOOGLE' | 'SAML';
  ssoConfig?: {
    clientId?: string;
    tenantId?: string;
    metadataUrl?: string;
    enforceForAllUsers: boolean;
  };
}

export interface UpdateOrganizationDto {
  name?: string;
  timezone?: string;
  dateFormat?: string;
  defaultLanguage?: string;
}

export interface UpdateBrandingDto {
  brandingMode?: 'STANDARD' | 'CO_BRANDED' | 'FULL_WHITE_LABEL';
  primaryColor?: string;
  secondaryColor?: string;
  accentColor?: string;
  customCss?: string;
}

export interface UpdateNotificationSettingsDto {
  defaultDigestTime?: string;
  digestEnabled?: boolean;
  enforcedNotificationCategories?: string[];
  quietHoursEnabled?: boolean;
  quietHoursStart?: string;
  quietHoursEnd?: string;
}

export interface UpdateSecuritySettingsDto {
  mfaRequired?: boolean;
  mfaRequiredRoles?: string[];
  sessionTimeoutMinutes?: number;
  passwordPolicy?: {
    minLength: number;
    requireUppercase: boolean;
    requireLowercase: boolean;
    requireNumbers: boolean;
    requireSpecialChars: boolean;
  };
}

export const TIMEZONES = [
  { value: 'America/New_York', label: 'Eastern Time (US & Canada)' },
  { value: 'America/Chicago', label: 'Central Time (US & Canada)' },
  { value: 'America/Denver', label: 'Mountain Time (US & Canada)' },
  { value: 'America/Los_Angeles', label: 'Pacific Time (US & Canada)' },
  { value: 'Europe/London', label: 'London' },
  { value: 'Europe/Paris', label: 'Paris' },
  { value: 'Europe/Berlin', label: 'Berlin' },
  { value: 'Asia/Tokyo', label: 'Tokyo' },
  { value: 'Asia/Shanghai', label: 'Shanghai' },
  { value: 'Asia/Singapore', label: 'Singapore' },
  { value: 'Australia/Sydney', label: 'Sydney' },
];

export const DATE_FORMATS = [
  { value: 'MM/DD/YYYY', label: 'MM/DD/YYYY (US)' },
  { value: 'DD/MM/YYYY', label: 'DD/MM/YYYY (Europe)' },
  { value: 'YYYY-MM-DD', label: 'YYYY-MM-DD (ISO)' },
];
```

**Create services/organization.ts:**

```typescript
import { apiClient } from './api-client';
import type {
  Organization,
  OrganizationSettings,
  UpdateOrganizationDto,
  UpdateBrandingDto,
  UpdateNotificationSettingsDto,
  UpdateSecuritySettingsDto,
} from '@/types/organization';

export const organizationApi = {
  getCurrent: async () => {
    return apiClient.get<Organization>('/organization');
  },

  getSettings: async () => {
    return apiClient.get<OrganizationSettings>('/organization/settings');
  },

  updateGeneral: async (dto: UpdateOrganizationDto) => {
    return apiClient.put<Organization>('/organization', dto);
  },

  updateBranding: async (dto: UpdateBrandingDto) => {
    return apiClient.put<OrganizationSettings>('/organization/branding', dto);
  },

  uploadLogo: async (file: File) => {
    const formData = new FormData();
    formData.append('logo', file);
    return apiClient.post<{ url: string }>('/organization/logo', formData);
  },

  uploadFavicon: async (file: File) => {
    const formData = new FormData();
    formData.append('favicon', file);
    return apiClient.post<{ url: string }>('/organization/favicon', formData);
  },

  updateNotificationSettings: async (dto: UpdateNotificationSettingsDto) => {
    return apiClient.put<OrganizationSettings>('/organization/notification-settings', dto);
  },

  updateSecuritySettings: async (dto: UpdateSecuritySettingsDto) => {
    return apiClient.put<OrganizationSettings>('/organization/security-settings', dto);
  },

  getSsoConfig: async () => {
    return apiClient.get<any>('/organization/sso');
  },

  updateSsoConfig: async (dto: any) => {
    return apiClient.put<any>('/organization/sso', dto);
  },

  testSsoConnection: async () => {
    return apiClient.post<{ success: boolean; message: string }>('/organization/sso/test');
  },

  getVerifiedDomains: async () => {
    return apiClient.get<{ domain: string; verified: boolean; verifiedAt: string }[]>('/organization/domains');
  },
};
```
  </action>
  <verify>Types and API client compile. All settings operations covered.</verify>
  <done>Organization types with settings structure and API client.</done>
</task>

<task type="auto">
  <name>Task 2: Create organization settings page with tabs</name>
  <files>
apps/frontend/src/app/(authenticated)/settings/organization/page.tsx
apps/frontend/src/components/settings/organization-general-settings.tsx
apps/frontend/src/components/settings/organization-branding-settings.tsx
  </files>
  <action>
**Create components/settings/organization-general-settings.tsx:**

OrganizationGeneralSettings component:
- Props: settings, onSave, isSaving
- Form fields:
  - Organization Name
  - Timezone (select from TIMEZONES)
  - Date Format (select from DATE_FORMATS)
  - Default Language (select)
- Save button

```tsx
interface OrganizationGeneralSettingsProps {
  settings: OrganizationSettings;
  onSave: (data: UpdateOrganizationDto) => Promise<void>;
  isSaving: boolean;
}

export function OrganizationGeneralSettings({
  settings,
  onSave,
  isSaving,
}: OrganizationGeneralSettingsProps) {
  const { register, handleSubmit } = useForm({
    defaultValues: {
      name: settings.name,
      timezone: settings.timezone,
      dateFormat: settings.dateFormat,
      defaultLanguage: settings.defaultLanguage,
    },
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle>General Settings</CardTitle>
        <CardDescription>Basic organization information</CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onSave)} className="space-y-4">
          <FormField label="Organization Name">
            <Input {...register('name')} />
          </FormField>

          <div className="grid grid-cols-2 gap-4">
            <FormField label="Timezone">
              <Select {...register('timezone')}>
                {TIMEZONES.map((tz) => (
                  <SelectItem key={tz.value} value={tz.value}>
                    {tz.label}
                  </SelectItem>
                ))}
              </Select>
            </FormField>

            <FormField label="Date Format">
              <Select {...register('dateFormat')}>
                {DATE_FORMATS.map((df) => (
                  <SelectItem key={df.value} value={df.value}>
                    {df.label}
                  </SelectItem>
                ))}
              </Select>
            </FormField>
          </div>

          <div className="flex justify-end">
            <Button type="submit" disabled={isSaving}>
              {isSaving ? 'Saving...' : 'Save Changes'}
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

**Create components/settings/organization-branding-settings.tsx:**

OrganizationBrandingSettings component:
- Logo upload with preview
- Favicon upload with preview
- Branding mode select (Standard, Co-branded, White Label)
- Color pickers for primary, secondary, accent colors
- Custom CSS textarea (advanced)
- Preview panel showing branding applied

```tsx
export function OrganizationBrandingSettings({
  settings,
  onSave,
  onUploadLogo,
  onUploadFavicon,
  isSaving,
}: BrandingSettingsProps) {
  const [primaryColor, setPrimaryColor] = useState(settings.primaryColor || '#0070f3');

  return (
    <Card>
      <CardHeader>
        <CardTitle>Branding</CardTitle>
        <CardDescription>Customize the appearance of your platform</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Logo Upload */}
        <FormField label="Logo">
          <div className="flex items-center gap-4">
            {settings.logoUrl && (
              <img src={settings.logoUrl} alt="Logo" className="h-12 w-auto" />
            )}
            <FileUpload
              accept="image/*"
              onUpload={onUploadLogo}
              label="Upload Logo"
            />
          </div>
          <p className="text-sm text-muted-foreground mt-1">
            Recommended: PNG or SVG, max 2MB, 200x50px
          </p>
        </FormField>

        {/* Branding Mode */}
        <FormField label="Branding Mode">
          <RadioGroup value={settings.brandingMode} onValueChange={...}>
            <RadioGroupItem value="STANDARD" label="Standard" description="Ethico branding" />
            <RadioGroupItem value="CO_BRANDED" label="Co-branded" description="Your logo + Ethico" />
            <RadioGroupItem value="FULL_WHITE_LABEL" label="White Label" description="Your branding only" />
          </RadioGroup>
        </FormField>

        {/* Color Pickers */}
        {settings.brandingMode !== 'STANDARD' && (
          <div className="grid grid-cols-3 gap-4">
            <FormField label="Primary Color">
              <ColorPicker value={primaryColor} onChange={setPrimaryColor} />
            </FormField>
            <FormField label="Secondary Color">
              <ColorPicker value={settings.secondaryColor} onChange={...} />
            </FormField>
            <FormField label="Accent Color">
              <ColorPicker value={settings.accentColor} onChange={...} />
            </FormField>
          </div>
        )}

        {/* Preview */}
        <div className="border rounded-lg p-4">
          <h4 className="font-medium mb-2">Preview</h4>
          <BrandingPreview
            logo={settings.logoUrl}
            primaryColor={primaryColor}
            secondaryColor={settings.secondaryColor}
          />
        </div>

        <div className="flex justify-end">
          <Button onClick={() => onSave({ primaryColor, ... })} disabled={isSaving}>
            Save Branding
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Create app/(authenticated)/settings/organization/page.tsx:**

OrganizationSettingsPage:
- Breadcrumb: Settings > Organization
- Fetch settings with React Query
- Tabs: General, Branding, Notifications, Security
- Each tab renders corresponding settings component
- Only SYSTEM_ADMIN can access

```tsx
'use client';

import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { OrganizationGeneralSettings } from '@/components/settings/organization-general-settings';
import { OrganizationBrandingSettings } from '@/components/settings/organization-branding-settings';
import { OrganizationNotificationSettings } from '@/components/settings/organization-notification-settings';
import { OrganizationSecuritySettings } from '@/components/settings/organization-security-settings';
import { organizationApi } from '@/services/organization';
import { toast } from 'sonner';

export default function OrganizationSettingsPage() {
  const queryClient = useQueryClient();

  const { data: settings, isLoading } = useQuery({
    queryKey: ['organization-settings'],
    queryFn: organizationApi.getSettings,
  });

  const updateGeneralMutation = useMutation({
    mutationFn: organizationApi.updateGeneral,
    onSuccess: () => {
      queryClient.invalidateQueries(['organization-settings']);
      toast.success('Settings saved');
    },
  });

  if (isLoading) return <Skeleton />;

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold">Organization Settings</h1>
        <p className="text-muted-foreground">Configure your organization</p>
      </div>

      <Tabs defaultValue="general">
        <TabsList>
          <TabsTrigger value="general">General</TabsTrigger>
          <TabsTrigger value="branding">Branding</TabsTrigger>
          <TabsTrigger value="notifications">Notifications</TabsTrigger>
          <TabsTrigger value="security">Security</TabsTrigger>
        </TabsList>

        <TabsContent value="general">
          <OrganizationGeneralSettings
            settings={settings!}
            onSave={updateGeneralMutation.mutateAsync}
            isSaving={updateGeneralMutation.isPending}
          />
        </TabsContent>

        <TabsContent value="branding">
          <OrganizationBrandingSettings settings={settings!} {...} />
        </TabsContent>

        <TabsContent value="notifications">
          <OrganizationNotificationSettings settings={settings!} {...} />
        </TabsContent>

        <TabsContent value="security">
          <OrganizationSecuritySettings settings={settings!} {...} />
        </TabsContent>
      </Tabs>
    </div>
  );
}
```
  </action>
  <verify>Pages compile. Tabs switch between settings sections. Forms submit.</verify>
  <done>Organization settings page with general and branding settings.</done>
</task>

<task type="auto">
  <name>Task 3: Create notification and security settings components</name>
  <files>
apps/frontend/src/components/settings/organization-notification-settings.tsx
apps/frontend/src/components/settings/organization-security-settings.tsx
  </files>
  <action>
**Create components/settings/organization-notification-settings.tsx:**

OrganizationNotificationSettings component:
- Digest settings:
  - Enable/disable digest
  - Default digest time (time picker)
- Enforced categories (checkboxes for categories that can't be disabled by users)
- Quiet hours:
  - Enable/disable
  - Start and end time
- Preview of user experience

```tsx
export function OrganizationNotificationSettings({
  settings,
  onSave,
  isSaving,
}: NotificationSettingsProps) {
  const { register, handleSubmit, watch } = useForm({
    defaultValues: {
      digestEnabled: settings.digestEnabled,
      defaultDigestTime: settings.defaultDigestTime,
      enforcedNotificationCategories: settings.enforcedNotificationCategories,
      quietHoursEnabled: settings.quietHoursEnabled,
      quietHoursStart: settings.quietHoursStart,
      quietHoursEnd: settings.quietHoursEnd,
    },
  });

  const digestEnabled = watch('digestEnabled');
  const quietHoursEnabled = watch('quietHoursEnabled');

  return (
    <Card>
      <CardHeader>
        <CardTitle>Notification Settings</CardTitle>
        <CardDescription>Configure organization-wide notification defaults</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* Digest Settings */}
        <div className="space-y-4">
          <h4 className="font-medium">Daily Digest</h4>
          <div className="flex items-center justify-between">
            <Label>Enable daily digest emails</Label>
            <Switch {...register('digestEnabled')} />
          </div>
          {digestEnabled && (
            <FormField label="Default digest time">
              <TimePicker {...register('defaultDigestTime')} />
              <p className="text-sm text-muted-foreground">
                Users receive digest at this time in their timezone
              </p>
            </FormField>
          )}
        </div>

        <Separator />

        {/* Enforced Categories */}
        <div className="space-y-4">
          <h4 className="font-medium">Enforced Notifications</h4>
          <p className="text-sm text-muted-foreground">
            Users cannot disable these notification categories
          </p>
          <div className="grid grid-cols-2 gap-2">
            {NOTIFICATION_CATEGORIES.map((cat) => (
              <div key={cat.value} className="flex items-center gap-2">
                <Checkbox
                  checked={settings.enforcedNotificationCategories.includes(cat.value)}
                  onCheckedChange={...}
                />
                <Label>{cat.label}</Label>
              </div>
            ))}
          </div>
        </div>

        <Separator />

        {/* Quiet Hours */}
        <div className="space-y-4">
          <h4 className="font-medium">Quiet Hours</h4>
          <div className="flex items-center justify-between">
            <Label>Enable organization-wide quiet hours</Label>
            <Switch {...register('quietHoursEnabled')} />
          </div>
          {quietHoursEnabled && (
            <div className="grid grid-cols-2 gap-4">
              <FormField label="Start time">
                <TimePicker {...register('quietHoursStart')} />
              </FormField>
              <FormField label="End time">
                <TimePicker {...register('quietHoursEnd')} />
              </FormField>
            </div>
          )}
        </div>

        <div className="flex justify-end">
          <Button onClick={handleSubmit(onSave)} disabled={isSaving}>
            Save Settings
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

**Create components/settings/organization-security-settings.tsx:**

OrganizationSecuritySettings component:
- MFA settings:
  - Require MFA for all users (toggle)
  - Require MFA for specific roles (multi-select)
- Session settings:
  - Session timeout (minutes)
- Password policy:
  - Minimum length
  - Require uppercase, lowercase, numbers, special chars
- SSO configuration:
  - Enable SSO
  - Provider selection
  - Configuration fields based on provider
  - "Test Connection" button
- Domain verification status

```tsx
export function OrganizationSecuritySettings({
  settings,
  onSave,
  onTestSso,
  isSaving,
}: SecuritySettingsProps) {
  const { register, handleSubmit, watch } = useForm({
    defaultValues: {
      mfaRequired: settings.mfaRequired,
      mfaRequiredRoles: settings.mfaRequiredRoles,
      sessionTimeoutMinutes: settings.sessionTimeoutMinutes,
      passwordPolicy: settings.passwordPolicy,
    },
  });

  const mfaRequired = watch('mfaRequired');

  return (
    <Card>
      <CardHeader>
        <CardTitle>Security Settings</CardTitle>
        <CardDescription>Configure authentication and security policies</CardDescription>
      </CardHeader>
      <CardContent className="space-y-6">
        {/* MFA Settings */}
        <div className="space-y-4">
          <h4 className="font-medium">Multi-Factor Authentication</h4>
          <div className="flex items-center justify-between">
            <div>
              <Label>Require MFA for all users</Label>
              <p className="text-sm text-muted-foreground">
                Users must set up MFA on their next login
              </p>
            </div>
            <Switch {...register('mfaRequired')} />
          </div>
          {!mfaRequired && (
            <FormField label="Require MFA for specific roles">
              <MultiSelect
                options={ROLES.map((r) => ({ value: r, label: ROLE_DISPLAY_NAMES[r] }))}
                value={settings.mfaRequiredRoles}
                onChange={...}
              />
            </FormField>
          )}
        </div>

        <Separator />

        {/* Session Settings */}
        <div className="space-y-4">
          <h4 className="font-medium">Session Settings</h4>
          <FormField label="Session timeout (minutes)">
            <Input
              type="number"
              {...register('sessionTimeoutMinutes', { valueAsNumber: true })}
              min={5}
              max={1440}
            />
            <p className="text-sm text-muted-foreground">
              Users will be logged out after this period of inactivity
            </p>
          </FormField>
        </div>

        <Separator />

        {/* Password Policy */}
        <div className="space-y-4">
          <h4 className="font-medium">Password Policy</h4>
          <div className="grid grid-cols-2 gap-4">
            <FormField label="Minimum length">
              <Input
                type="number"
                {...register('passwordPolicy.minLength', { valueAsNumber: true })}
                min={8}
                max={32}
              />
            </FormField>
          </div>
          <div className="grid grid-cols-2 gap-2">
            <div className="flex items-center gap-2">
              <Checkbox {...register('passwordPolicy.requireUppercase')} />
              <Label>Require uppercase letter</Label>
            </div>
            <div className="flex items-center gap-2">
              <Checkbox {...register('passwordPolicy.requireLowercase')} />
              <Label>Require lowercase letter</Label>
            </div>
            <div className="flex items-center gap-2">
              <Checkbox {...register('passwordPolicy.requireNumbers')} />
              <Label>Require number</Label>
            </div>
            <div className="flex items-center gap-2">
              <Checkbox {...register('passwordPolicy.requireSpecialChars')} />
              <Label>Require special character</Label>
            </div>
          </div>
        </div>

        <Separator />

        {/* SSO Configuration */}
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <h4 className="font-medium">Single Sign-On</h4>
              <p className="text-sm text-muted-foreground">
                {settings.ssoEnabled ? `Connected via ${settings.ssoProvider}` : 'Not configured'}
              </p>
            </div>
            <Button variant="outline" asChild>
              <Link href="/settings/organization/sso">Configure SSO</Link>
            </Button>
          </div>
        </div>

        <div className="flex justify-end">
          <Button onClick={handleSubmit(onSave)} disabled={isSaving}>
            Save Settings
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>Components compile. Forms have proper validation. Toggle switches work.</verify>
  <done>Notification and security settings components with all configuration options.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds in frontend
2. Organization settings page loads with all tabs
3. General settings (name, timezone, date format) can be updated
4. Branding settings (logo, colors) can be configured
5. Notification settings (digest, quiet hours) work
6. Security settings (MFA, session, password policy) can be configured
7. Changes save and persist
</verification>

<success_criteria>
- Admin can update organization name and regional settings
- Branding settings (logo, colors, mode) configurable
- Notification defaults (digest, quiet hours, enforced categories) settable
- Security settings (MFA requirements, session timeout, password policy) manageable
- Proper access control (SYSTEM_ADMIN only)
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-11-SUMMARY.md`
</output>
