---
phase: 10-policy-management
plan: 10
type: execute
wave: 5
depends_on: [10-08]
files_modified:
  - apps/frontend/src/app/(authenticated)/settings/users/page.tsx
  - apps/frontend/src/app/(authenticated)/settings/users/[id]/page.tsx
  - apps/frontend/src/app/(authenticated)/settings/users/invite/page.tsx
  - apps/frontend/src/components/settings/user-list.tsx
  - apps/frontend/src/components/settings/user-form.tsx
  - apps/frontend/src/components/settings/role-permissions-table.tsx
  - apps/frontend/src/services/users.ts
  - apps/frontend/src/types/user.ts
autonomous: true

must_haves:
  truths:
    - "Admin can view and manage users in the organization"
    - "Users can be invited by email with role assignment"
    - "User roles can be changed by admins"
    - "Role permissions are visible in a clear matrix"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/settings/users/page.tsx"
      provides: "User management list page"
      min_lines: 50
    - path: "apps/frontend/src/components/settings/user-form.tsx"
      provides: "User create/edit form"
      min_lines: 60
  key_links:
    - from: "UserListPage"
      to: "usersApi"
      via: "data fetching"
      pattern: "usersApi"
    - from: "UserForm"
      to: "role selection"
      via: "RoleSelect component"
      pattern: "RoleSelect"
---

<objective>
Create user management and RBAC UI - list users, invite new users, manage roles, and display role permissions matrix.

Purpose: Enable system admins to manage who has access to the platform and what they can do.
Output: User management pages under settings with invite and role management capabilities.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create user types and API client</name>
  <files>
apps/frontend/src/types/user.ts
apps/frontend/src/services/users.ts
  </files>
  <action>
**Update/create types/user.ts:**

```typescript
export type UserRole =
  | 'SYSTEM_ADMIN'
  | 'COMPLIANCE_OFFICER'
  | 'POLICY_AUTHOR'
  | 'POLICY_REVIEWER'
  | 'INVESTIGATOR'
  | 'TRIAGE_LEAD'
  | 'DEPARTMENT_ADMIN'
  | 'READ_ONLY'
  | 'EMPLOYEE';

export type UserStatus = 'ACTIVE' | 'INACTIVE' | 'PENDING_INVITE' | 'SUSPENDED';

export interface User {
  id: string;
  email: string;
  name: string;
  role: UserRole;
  status: UserStatus;
  lastLoginAt?: string;
  createdAt: string;
  updatedAt: string;
  // SSO info
  ssoProvider?: string;
  // MFA
  mfaEnabled: boolean;
  // Profile
  avatarUrl?: string;
  title?: string;
  department?: string;
}

export interface InviteUserDto {
  email: string;
  name: string;
  role: UserRole;
  message?: string;
}

export interface UpdateUserDto {
  name?: string;
  role?: UserRole;
  status?: UserStatus;
  title?: string;
  department?: string;
}

export interface UserFilters {
  role?: UserRole;
  status?: UserStatus;
  search?: string;
}

// Role permission definitions
export interface RolePermission {
  resource: string;
  actions: {
    create: boolean;
    read: boolean;
    update: boolean;
    delete: boolean;
  };
}

export const ROLE_DISPLAY_NAMES: Record<UserRole, string> = {
  SYSTEM_ADMIN: 'System Administrator',
  COMPLIANCE_OFFICER: 'Compliance Officer',
  POLICY_AUTHOR: 'Policy Author',
  POLICY_REVIEWER: 'Policy Reviewer',
  INVESTIGATOR: 'Investigator',
  TRIAGE_LEAD: 'Triage Lead',
  DEPARTMENT_ADMIN: 'Department Administrator',
  READ_ONLY: 'Read Only',
  EMPLOYEE: 'Employee',
};

export const ROLE_DESCRIPTIONS: Record<UserRole, string> = {
  SYSTEM_ADMIN: 'Full access to all features and settings',
  COMPLIANCE_OFFICER: 'Manage policies, cases, campaigns, and reports',
  POLICY_AUTHOR: 'Create and edit policies',
  POLICY_REVIEWER: 'Review and approve policies',
  INVESTIGATOR: 'Conduct investigations and manage cases',
  TRIAGE_LEAD: 'Review and triage incoming reports',
  DEPARTMENT_ADMIN: 'Manage department-specific data',
  READ_ONLY: 'View-only access to reports and dashboards',
  EMPLOYEE: 'Self-service access to own data',
};
```

**Create services/users.ts:**

```typescript
import { apiClient } from './api-client';
import type { User, InviteUserDto, UpdateUserDto, UserFilters } from '@/types/user';

export const usersApi = {
  list: async (filters?: UserFilters, page = 1, limit = 20) => {
    const params = new URLSearchParams({ page: String(page), limit: String(limit) });
    if (filters?.role) params.set('role', filters.role);
    if (filters?.status) params.set('status', filters.status);
    if (filters?.search) params.set('search', filters.search);
    return apiClient.get<{ data: User[], total: number }>(`/users?${params}`);
  },

  getById: async (id: string) => {
    return apiClient.get<User>(`/users/${id}`);
  },

  invite: async (dto: InviteUserDto) => {
    return apiClient.post<User>('/users/invite', dto);
  },

  update: async (id: string, dto: UpdateUserDto) => {
    return apiClient.put<User>(`/users/${id}`, dto);
  },

  deactivate: async (id: string) => {
    return apiClient.post<User>(`/users/${id}/deactivate`);
  },

  reactivate: async (id: string) => {
    return apiClient.post<User>(`/users/${id}/reactivate`);
  },

  resendInvite: async (id: string) => {
    return apiClient.post<void>(`/users/${id}/resend-invite`);
  },

  resetMfa: async (id: string) => {
    return apiClient.post<void>(`/users/${id}/reset-mfa`);
  },

  getRolePermissions: async () => {
    return apiClient.get<Record<string, RolePermission[]>>('/users/role-permissions');
  },
};
```
  </action>
  <verify>Types and API client compile. All user management operations covered.</verify>
  <done>User types with role definitions and API client for user management.</done>
</task>

<task type="auto">
  <name>Task 2: Create user list and management pages</name>
  <files>
apps/frontend/src/app/(authenticated)/settings/users/page.tsx
apps/frontend/src/app/(authenticated)/settings/users/[id]/page.tsx
apps/frontend/src/components/settings/user-list.tsx
  </files>
  <action>
**Create components/settings/user-list.tsx:**

UserList component:
- Props: users, onEdit, onDeactivate, onResendInvite
- Table with columns:
  - Name (with avatar)
  - Email
  - Role (badge)
  - Status (badge: ACTIVE green, PENDING_INVITE yellow, INACTIVE gray, SUSPENDED red)
  - Last Login
  - Actions dropdown
- Actions:
  - Edit
  - Deactivate (if ACTIVE)
  - Reactivate (if INACTIVE)
  - Resend Invite (if PENDING_INVITE)
  - Reset MFA
- Empty state: "No users found"

```tsx
interface UserListProps {
  users: User[];
  total: number;
  page: number;
  onPageChange: (page: number) => void;
  onEdit: (user: User) => void;
  onDeactivate: (user: User) => void;
  onReactivate: (user: User) => void;
  onResendInvite: (user: User) => void;
}

export function UserList({ users, total, page, onPageChange, ...actions }: UserListProps) {
  return (
    <Table>
      <TableHeader>
        <TableRow>
          <TableHead>User</TableHead>
          <TableHead>Role</TableHead>
          <TableHead>Status</TableHead>
          <TableHead>Last Login</TableHead>
          <TableHead></TableHead>
        </TableRow>
      </TableHeader>
      <TableBody>
        {users.map((user) => (
          <TableRow key={user.id}>
            <TableCell>
              <div className="flex items-center gap-3">
                <Avatar>
                  <AvatarImage src={user.avatarUrl} />
                  <AvatarFallback>{getInitials(user.name)}</AvatarFallback>
                </Avatar>
                <div>
                  <div className="font-medium">{user.name}</div>
                  <div className="text-sm text-muted-foreground">{user.email}</div>
                </div>
              </div>
            </TableCell>
            <TableCell>
              <Badge variant="outline">{ROLE_DISPLAY_NAMES[user.role]}</Badge>
            </TableCell>
            <TableCell>
              <StatusBadge status={user.status} />
            </TableCell>
            <TableCell>
              {user.lastLoginAt ? formatRelativeTime(user.lastLoginAt) : 'Never'}
            </TableCell>
            <TableCell>
              <UserActionsDropdown user={user} {...actions} />
            </TableCell>
          </TableRow>
        ))}
      </TableBody>
    </Table>
  );
}
```

**Create app/(authenticated)/settings/users/page.tsx:**

UsersPage:
- Breadcrumb: Settings > Users
- Header with "Users" title and "Invite User" button
- Filters: role dropdown, status dropdown, search
- UserList component
- Pagination
- Requires SYSTEM_ADMIN role

```tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { useState } from 'react';
import { UserPlus } from 'lucide-react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { UserList } from '@/components/settings/user-list';
import { usersApi } from '@/services/users';
import { useAuth } from '@/hooks/use-auth';
import type { UserFilters } from '@/types/user';

export default function UsersPage() {
  const { user: currentUser } = useAuth();
  const [filters, setFilters] = useState<UserFilters>({});
  const [page, setPage] = useState(1);

  // Only SYSTEM_ADMIN can access
  if (currentUser?.role !== 'SYSTEM_ADMIN') {
    return <AccessDenied />;
  }

  const { data, isLoading } = useQuery({
    queryKey: ['users', filters, page],
    queryFn: () => usersApi.list(filters, page),
  });

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold">Users</h1>
          <p className="text-muted-foreground">Manage user access and roles</p>
        </div>
        <Button asChild>
          <Link href="/settings/users/invite">
            <UserPlus className="mr-2 h-4 w-4" />
            Invite User
          </Link>
        </Button>
      </div>

      <UserFiltersBar filters={filters} onChange={setFilters} />

      {isLoading ? <Skeleton /> : (
        <UserList
          users={data?.data || []}
          total={data?.total || 0}
          page={page}
          onPageChange={setPage}
          onEdit={(user) => router.push(`/settings/users/${user.id}`)}
          onDeactivate={handleDeactivate}
          onReactivate={handleReactivate}
          onResendInvite={handleResendInvite}
        />
      )}
    </div>
  );
}
```

**Create app/(authenticated)/settings/users/[id]/page.tsx:**

UserDetailPage:
- Fetch user by ID
- UserForm for editing
- Activity/audit log section
- "Back to Users" link
  </action>
  <verify>Pages compile. User list shows with proper role/status badges. Actions work.</verify>
  <done>User management pages with list, filters, and actions.</done>
</task>

<task type="auto">
  <name>Task 3: Create invite page, user form, and role permissions table</name>
  <files>
apps/frontend/src/app/(authenticated)/settings/users/invite/page.tsx
apps/frontend/src/components/settings/user-form.tsx
apps/frontend/src/components/settings/role-permissions-table.tsx
  </files>
  <action>
**Create components/settings/user-form.tsx:**

UserForm component:
- Props: user (optional for edit), onSubmit, isSubmitting
- Fields:
  - Email (required, disabled if editing)
  - Name (required)
  - Role (select from UserRole options)
  - Title (optional)
  - Department (optional)
- Role select shows description below selection
- Submit button: "Invite User" or "Save Changes"

```tsx
interface UserFormProps {
  user?: User;
  onSubmit: (data: InviteUserDto | UpdateUserDto) => Promise<void>;
  isSubmitting?: boolean;
}

export function UserForm({ user, onSubmit, isSubmitting }: UserFormProps) {
  const { register, handleSubmit, watch, formState: { errors } } = useForm({
    defaultValues: {
      email: user?.email || '',
      name: user?.name || '',
      role: user?.role || 'EMPLOYEE',
      title: user?.title || '',
      department: user?.department || '',
    },
  });

  const selectedRole = watch('role');

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
      <div className="grid grid-cols-2 gap-4">
        <FormField label="Email" error={errors.email?.message}>
          <Input
            {...register('email', { required: 'Email is required' })}
            type="email"
            disabled={!!user}
            placeholder="user@example.com"
          />
        </FormField>

        <FormField label="Name" error={errors.name?.message}>
          <Input
            {...register('name', { required: 'Name is required' })}
            placeholder="John Doe"
          />
        </FormField>
      </div>

      <FormField label="Role" error={errors.role?.message}>
        <RoleSelect
          value={selectedRole}
          onChange={(value) => setValue('role', value)}
        />
        <p className="text-sm text-muted-foreground mt-1">
          {ROLE_DESCRIPTIONS[selectedRole as UserRole]}
        </p>
      </FormField>

      <div className="grid grid-cols-2 gap-4">
        <FormField label="Title (optional)">
          <Input {...register('title')} placeholder="Compliance Manager" />
        </FormField>

        <FormField label="Department (optional)">
          <Input {...register('department')} placeholder="Legal & Compliance" />
        </FormField>
      </div>

      <div className="flex justify-end">
        <Button type="submit" disabled={isSubmitting}>
          {user ? 'Save Changes' : 'Send Invitation'}
        </Button>
      </div>
    </form>
  );
}
```

**Create components/settings/role-permissions-table.tsx:**

RolePermissionsTable component:
- Matrix showing roles vs permissions
- Rows: Resources (Policies, Cases, Investigations, Campaigns, Users, Settings, Reports)
- Columns: Roles (grouped by category)
- Cells: Check marks for allowed actions
- Expandable rows for detailed CRUD breakdown

```tsx
const PERMISSION_MATRIX = {
  SYSTEM_ADMIN: { policies: 'full', cases: 'full', users: 'full', settings: 'full', reports: 'full' },
  COMPLIANCE_OFFICER: { policies: 'full', cases: 'full', users: 'read', settings: 'read', reports: 'full' },
  POLICY_AUTHOR: { policies: 'write', cases: 'read', users: 'none', settings: 'none', reports: 'read' },
  // ... etc
};

export function RolePermissionsTable() {
  return (
    <div className="border rounded-lg overflow-hidden">
      <Table>
        <TableHeader>
          <TableRow>
            <TableHead>Permission</TableHead>
            {Object.keys(ROLE_DISPLAY_NAMES).map((role) => (
              <TableHead key={role} className="text-center">
                {ROLE_DISPLAY_NAMES[role as UserRole].split(' ')[0]}
              </TableHead>
            ))}
          </TableRow>
        </TableHeader>
        <TableBody>
          {RESOURCES.map((resource) => (
            <TableRow key={resource}>
              <TableCell className="font-medium">{resource}</TableCell>
              {ROLES.map((role) => (
                <TableCell key={role} className="text-center">
                  <PermissionCell level={PERMISSION_MATRIX[role][resource]} />
                </TableCell>
              ))}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  );
}
```

**Create app/(authenticated)/settings/users/invite/page.tsx:**

InviteUserPage:
- Breadcrumb: Settings > Users > Invite
- Header: "Invite User"
- UserForm
- Role permissions reference (collapsible)
- Success: redirect to /settings/users with success toast

```tsx
'use client';

import { useMutation } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { toast } from 'sonner';
import { UserForm } from '@/components/settings/user-form';
import { RolePermissionsTable } from '@/components/settings/role-permissions-table';
import { usersApi } from '@/services/users';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';

export default function InviteUserPage() {
  const router = useRouter();

  const inviteMutation = useMutation({
    mutationFn: usersApi.invite,
    onSuccess: () => {
      toast.success('Invitation sent successfully');
      router.push('/settings/users');
    },
    onError: (error: any) => {
      toast.error(error.message || 'Failed to send invitation');
    },
  });

  return (
    <div className="max-w-2xl space-y-6">
      <div>
        <h1 className="text-2xl font-semibold">Invite User</h1>
        <p className="text-muted-foreground">
          Send an invitation email to add a new user to your organization
        </p>
      </div>

      <UserForm
        onSubmit={inviteMutation.mutateAsync}
        isSubmitting={inviteMutation.isPending}
      />

      <Collapsible>
        <CollapsibleTrigger className="text-sm text-muted-foreground hover:text-foreground">
          View role permissions reference
        </CollapsibleTrigger>
        <CollapsibleContent className="mt-4">
          <RolePermissionsTable />
        </CollapsibleContent>
      </Collapsible>
    </div>
  );
}
```
  </action>
  <verify>All components compile. Invite form submits. Role permissions table renders matrix.</verify>
  <done>User invite page, form, and role permissions reference table.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds in frontend
2. Users page lists users with role and status badges
3. Filters by role, status, search work
4. Invite page sends invitation with role
5. User detail page allows editing role/status
6. Role permissions table shows clear matrix
7. Actions (deactivate, reactivate, resend invite) work
</verification>

<success_criteria>
- Admin can view all users with role/status info
- Invite user by email with role assignment
- Edit user role and status
- Role permissions visible in clear matrix
- Proper access control (SYSTEM_ADMIN only)
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-10-SUMMARY.md`
</output>
