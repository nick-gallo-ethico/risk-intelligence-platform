---
phase: 10-policy-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/policies/dto/policy.dto.ts
autonomous: true

must_haves:
  truths:
    - "Policy model exists with draft/published status, version tracking, and rich text content"
    - "PolicyVersion model stores immutable published snapshots with version numbers"
    - "PolicyVersionTranslation stores translated content linked to specific versions"
    - "PolicyCaseAssociation links policies to cases for violation tracking"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "Policy, PolicyVersion, PolicyVersionTranslation, PolicyCaseAssociation models"
      contains: "model Policy"
    - path: "apps/backend/src/modules/policies/dto/policy.dto.ts"
      provides: "DTOs for policy operations"
      exports: ["CreatePolicyDto", "UpdatePolicyDto", "PublishPolicyDto"]
  key_links:
    - from: "PolicyVersion"
      to: "Policy"
      via: "policyId FK"
      pattern: "policyId.*String.*@map"
    - from: "PolicyVersionTranslation"
      to: "PolicyVersion"
      via: "policyVersionId FK"
      pattern: "policyVersionId.*String.*@map"
---

<objective>
Create the Policy database schema - Policy entity with draft/published lifecycle, PolicyVersion for immutable published snapshots, PolicyVersionTranslation for multi-language support, and PolicyCaseAssociation for violation tracking.

Purpose: Foundation for policy lifecycle management - all subsequent plans depend on these models.
Output: Prisma models with migrations applied, TypeScript DTOs ready for service layer.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-policy-management/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Policy, PolicyVersion, and translation models to Prisma schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models and enums to schema.prisma. Follow the established patterns (organizationId on all models, UUID ids, timestamps, snake_case DB column mapping).

**Enums:**

```prisma
enum PolicyType {
  CODE_OF_CONDUCT
  ANTI_HARASSMENT
  ANTI_BRIBERY
  DATA_PRIVACY
  INFORMATION_SECURITY
  GIFT_ENTERTAINMENT
  CONFLICTS_OF_INTEREST
  TRAVEL_EXPENSE
  WHISTLEBLOWER
  SOCIAL_MEDIA
  ACCEPTABLE_USE
  OTHER

  @@map("policy_type")
}

enum PolicyStatus {
  DRAFT
  PENDING_APPROVAL
  APPROVED
  PUBLISHED
  RETIRED

  @@map("policy_status")
}

enum TranslationSource {
  AI
  HUMAN
  IMPORT

  @@map("translation_source")
}

enum TranslationReviewStatus {
  PENDING_REVIEW
  APPROVED
  NEEDS_REVISION
  PUBLISHED

  @@map("translation_review_status")
}

enum PolicyCaseLinkType {
  VIOLATION
  REFERENCE
  GOVERNING

  @@map("policy_case_link_type")
}
```

**Policy model:**
- organizationId, title, slug (unique within org), policyType, category (optional)
- status (PolicyStatus default DRAFT), currentVersion (Int default 0)
- draftContent (String? - HTML), draftUpdatedAt, draftUpdatedById
- ownerId (FK to User), effectiveDate, reviewDate, retiredAt
- createdAt, updatedAt, createdById
- Relations: organization, owner (User), versions[], translations[] (directly on Policy for convenience queries), caseAssociations[]

**PolicyVersion model:**
- organizationId, policyId (FK to Policy)
- version (Int), versionLabel (optional String)
- content (String - immutable HTML), plainText (String - for search)
- summary (optional), changeNotes (optional)
- publishedAt, publishedById, effectiveDate
- isLatest (Boolean default true)
- Relations: organization, policy, publishedBy (User), translations[]
- Unique constraint: [policyId, version]

**PolicyVersionTranslation model:**
- organizationId, policyVersionId (FK to PolicyVersion)
- languageCode (ISO 639-1), languageName
- title (translated), content (HTML), plainText
- translatedBy (TranslationSource), aiModel (optional)
- reviewStatus (TranslationReviewStatus default PENDING_REVIEW)
- reviewedAt, reviewedById, reviewNotes
- isStale (Boolean default false)
- createdAt, updatedAt
- Relations: organization, policyVersion, reviewer (User)
- Unique constraint: [policyVersionId, languageCode]

**PolicyCaseAssociation model:**
- organizationId, policyId, policyVersionId, caseId
- linkType (PolicyCaseLinkType)
- linkReason (optional), violationDate (optional)
- createdAt, createdById
- Relations: organization, policy, policyVersion, case (Case model), createdBy (User)
- Unique constraint: [policyId, caseId]

Add POLICY and POLICY_VERSION to WorkflowEntityType enum if not present.
Add POLICY, POLICY_VERSION, POLICY_TRANSLATION to AuditEntityType enum.

Run `npx prisma format` after adding models.
  </action>
  <verify>Run `npx prisma validate` - no errors. Run `npx prisma format` - schema formatted.</verify>
  <done>Prisma schema has Policy, PolicyVersion, PolicyVersionTranslation, PolicyCaseAssociation models with all fields and relations.</done>
</task>

<task type="auto">
  <name>Task 2: Generate Prisma migration and client</name>
  <files>apps/backend/prisma/migrations/</files>
  <action>
Generate and apply the Prisma migration for the Policy models.

```bash
cd apps/backend
npx prisma migrate dev --name add_policy_models
```

This creates the migration SQL and updates the Prisma client with the new types.

Verify the migration includes:
- policy_type, policy_status, translation_source, translation_review_status, policy_case_link_type enum types
- policies table with all columns
- policy_versions table with unique constraint
- policy_version_translations table with unique constraint
- policy_case_associations table with unique constraint
- Foreign key constraints to organizations, users, cases
  </action>
  <verify>Migration created in migrations folder. Run `npx prisma generate` - client generated with Policy types.</verify>
  <done>Migration applied, Prisma client includes Policy, PolicyVersion, PolicyVersionTranslation, PolicyCaseAssociation types.</done>
</task>

<task type="auto">
  <name>Task 3: Create Policy DTOs</name>
  <files>apps/backend/src/modules/policies/dto/policy.dto.ts</files>
  <action>
Create the DTO file with validation decorators following project patterns (class-validator, class-transformer).

**CreatePolicyDto:**
- title: string (required, @IsString, @MinLength(1), @MaxLength(500))
- policyType: PolicyType (required, @IsEnum)
- category: string (optional, @IsOptional, @IsString)
- content: string (optional - initial draft content)
- ownerId: string (optional - defaults to current user)
- effectiveDate: Date (optional)
- reviewDate: Date (optional)

**UpdatePolicyDto:**
- title: string (optional)
- policyType: PolicyType (optional)
- category: string (optional)
- content: string (optional - updates draft)
- ownerId: string (optional)
- effectiveDate: Date (optional)
- reviewDate: Date (optional)

**PublishPolicyDto:**
- versionLabel: string (optional, e.g., "v1.0", "2026 Update")
- summary: string (optional - AI or manual summary)
- changeNotes: string (optional - what changed)
- effectiveDate: Date (optional - defaults to now)
- requireReAttestation: boolean (optional - for attestation campaigns)
- reAttestationReason: string (optional - required if requireReAttestation)

**PolicyQueryDto:**
- status: PolicyStatus (optional, filter)
- policyType: PolicyType (optional, filter)
- ownerId: string (optional, filter)
- search: string (optional, text search)
- page: number (optional, default 1)
- limit: number (optional, default 20)
- sortBy: string (optional, default 'updatedAt')
- sortOrder: 'asc' | 'desc' (optional, default 'desc')

**CreateTranslationDto:**
- policyVersionId: string (required)
- languageCode: string (required, ISO 639-1)
- languageName: string (optional - derived if not provided)
- content: string (optional - for manual translation)

**LinkPolicyToCaseDto:**
- policyId: string (required)
- policyVersionId: string (optional - defaults to latest)
- caseId: string (required)
- linkType: PolicyCaseLinkType (required)
- linkReason: string (optional)
- violationDate: Date (optional)

Create index.ts that exports all DTOs.
  </action>
  <verify>Run `npm run build` - DTOs compile. Verify class-validator decorators are applied.</verify>
  <done>DTOs created with validation decorators, exported from index.ts.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx prisma validate` passes
2. `npm run build` succeeds (at least for policy dto files)
3. Policy model has: organizationId, title, slug, policyType, status, currentVersion, draftContent, ownerId
4. PolicyVersion model has: version, content, plainText, publishedAt, isLatest
5. PolicyVersionTranslation model has: languageCode, content, reviewStatus, isStale
6. PolicyCaseAssociation model has: linkType, policyVersionId, caseId
7. DTOs have proper validation decorators
</verification>

<success_criteria>
- Prisma schema has all four models (Policy, PolicyVersion, PolicyVersionTranslation, PolicyCaseAssociation)
- Migration created and applied
- DTOs with validation ready for service layer
- Enums for PolicyType, PolicyStatus, TranslationSource, TranslationReviewStatus, PolicyCaseLinkType exist
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-01-SUMMARY.md`
</output>
