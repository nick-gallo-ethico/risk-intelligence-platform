---
phase: 10-policy-management
plan: 04
type: execute
wave: 3
depends_on: [10-02]
files_modified:
  - apps/backend/src/modules/campaigns/attestation/attestation-campaign.service.ts
  - apps/backend/src/modules/campaigns/attestation/attestation-response.service.ts
  - apps/backend/src/modules/campaigns/attestation/dto/attestation.dto.ts
  - apps/backend/src/modules/campaigns/attestation/attestation.controller.ts
  - apps/backend/src/modules/campaigns/campaigns.module.ts
  - apps/backend/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Attestation campaigns link to specific PolicyVersion (not just Policy)"
    - "Employees can attest to policies via checkbox, signature, or quiz"
    - "Attestation response creates an RIU record (immutable)"
    - "Refusal with reason creates a compliance case automatically"
  artifacts:
    - path: "apps/backend/src/modules/campaigns/attestation/attestation-campaign.service.ts"
      provides: "Create attestation campaigns from policies"
      exports: ["AttestationCampaignService"]
    - path: "apps/backend/src/modules/campaigns/attestation/attestation-response.service.ts"
      provides: "Process attestation responses"
      exports: ["AttestationResponseService"]
  key_links:
    - from: "AttestationCampaignService.createFromPolicy"
      to: "CampaignsService.create"
      via: "service injection"
      pattern: "campaignsService.create"
    - from: "AttestationResponseService.submit"
      to: "RiusService.create"
      via: "creates RIU record"
      pattern: "riusService.create"
---

<objective>
Create attestation campaigns from published policies - employees receive assignments, attest via checkbox/signature/quiz, responses tracked as RIUs, refusals auto-create cases.

Purpose: Complete the policy-to-employee distribution loop with auditable acknowledgment tracking.
Output: AttestationCampaignService, AttestationResponseService, and controller endpoints.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-policy-management/10-RESEARCH.md
@.planning/phases/04-core-entities/04-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Campaign model for attestation fields</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add attestation-specific fields to the existing Campaign model:

```prisma
// Add to Campaign model
  // Policy attestation fields (when type = ATTESTATION)
  policyId          String?   @map("policy_id")
  policyVersionId   String?   @map("policy_version_id")

  // Attestation configuration
  attestationType   AttestationType?   @map("attestation_type")
  quizConfig        Json?     @map("quiz_config")  // { questions, passingScore, maxAttempts }
  forceScroll       Boolean   @default(false) @map("force_scroll")  // Require scrolling to bottom
  signatureRequired Boolean   @default(false) @map("signature_required")

  // Auto-case creation rules
  autoCreateCaseOnRefusal Boolean @default(true) @map("auto_create_case_on_refusal")

  // Relations
  policy            Policy?        @relation(fields: [policyId], references: [id])
  policyVersion     PolicyVersion? @relation("PolicyVersionCampaigns", fields: [policyVersionId], references: [id])
```

Add AttestationType enum:
```prisma
enum AttestationType {
  CHECKBOX    // Simple acknowledge checkbox
  SIGNATURE   // Electronic signature capture
  QUIZ        // Must pass quiz to attest

  @@map("attestation_type")
}
```

Add to CampaignAssignment for attestation tracking:
```prisma
// Add to CampaignAssignment model
  attestedAt        DateTime? @map("attested_at")
  attestationType   AttestationType? @map("attestation_type")  // How they attested
  quizScore         Int?      @map("quiz_score")
  quizAttempts      Int?      @default(0) @map("quiz_attempts")
  signatureData     String?   @map("signature_data")  // Base64 signature image
  refusedAt         DateTime? @map("refused_at")
  refusalReason     String?   @map("refusal_reason")
```

Run `npx prisma format` then generate migration:
`npx prisma migrate dev --name add_attestation_fields`
  </action>
  <verify>Migration applies successfully. Campaign model has attestation fields.</verify>
  <done>Campaign and CampaignAssignment extended with attestation tracking fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create AttestationCampaignService and AttestationResponseService</name>
  <files>
apps/backend/src/modules/campaigns/attestation/attestation-campaign.service.ts
apps/backend/src/modules/campaigns/attestation/attestation-response.service.ts
apps/backend/src/modules/campaigns/attestation/dto/attestation.dto.ts
  </files>
  <action>
**Create dto/attestation.dto.ts:**

CreateAttestationCampaignDto:
- policyVersionId: string (required)
- name: string (optional - defaults to policy title)
- description: string (optional)
- attestationType: AttestationType (default CHECKBOX)
- quizConfig: { questions: QuizQuestion[], passingScore: number, maxAttempts: number } (optional)
- forceScroll: boolean (optional)
- audienceMode: 'ALL' | 'SEGMENT' | 'MANUAL' (default ALL)
- segmentCriteria: object (optional - for SEGMENT mode)
- employeeIds: string[] (optional - for MANUAL mode)
- dueDate: Date (required)
- reminderDays: number[] (optional, default [7, 3, 1])
- autoCreateCaseOnRefusal: boolean (default true)

SubmitAttestationDto:
- assignmentId: string (required)
- acknowledged: boolean (required for CHECKBOX)
- signatureData: string (optional - base64 for SIGNATURE)
- quizAnswers: { questionId: string, answerId: string }[] (optional for QUIZ)
- refused: boolean (optional)
- refusalReason: string (required if refused)

QuizQuestion interface:
- id: string
- text: string
- options: { id: string, text: string }[]
- correctOptionId: string
- explanation: string (shown after answer)

**Create attestation-campaign.service.ts:**

@Injectable() AttestationCampaignService with:
- PrismaService
- CampaignsService (existing)
- PoliciesService
- EventEmitter2

Methods:

`createFromPolicy(dto: CreateAttestationCampaignDto, userId: string, organizationId: string): Promise<Campaign>`
- Verify policyVersionId exists and belongs to published policy
- Get policy details for campaign name/description defaults
- Create campaign via CampaignsService.create() with:
  - type: 'ATTESTATION'
  - policyId, policyVersionId
  - attestationType, quizConfig, forceScroll
  - audienceMode, segmentCriteria or employeeIds
  - dueDate, reminderDays
  - autoCreateCaseOnRefusal
- Emit PolicyAttestationCampaignCreatedEvent
- Return campaign

`createFromPublish(policyVersionId: string, dto: Partial<CreateAttestationCampaignDto>, userId: string, organizationId: string): Promise<Campaign | null>`
- Convenience method called from policy publish flow
- If dto is empty/null, return null (no campaign)
- Otherwise call createFromPolicy with defaults

`getPolicyCampaigns(policyId: string, organizationId: string): Promise<Campaign[]>`
- Return all attestation campaigns for a policy
- Include completion statistics

**Create attestation-response.service.ts:**

@Injectable() AttestationResponseService with:
- PrismaService
- RiusService
- CampaignAssignmentService
- CasesService
- EventEmitter2

Methods:

`submitAttestation(dto: SubmitAttestationDto, employeeId: string, organizationId: string): Promise<{ assignment: CampaignAssignment, riu?: Riu, case?: Case }>`
- Get assignment with campaign relation
- Validate assignment belongs to employee and org
- Validate assignment not already completed
- Handle by attestationType:
  - CHECKBOX: Verify acknowledged === true
  - SIGNATURE: Verify signatureData present
  - QUIZ: Score quiz, check pass threshold
- If refused:
  - Create RIU with type ATTESTATION_REFUSAL
  - If autoCreateCaseOnRefusal, create Case
  - Update assignment with refusedAt, refusalReason
- If attested:
  - Create RIU with type ATTESTATION_RESPONSE
  - Update assignment: status COMPLETED, attestedAt, attestationType, quizScore, signatureData
- Update campaign statistics via event
- Return { assignment, riu, case }

`scoreQuiz(quizConfig: any, answers: any[]): { score: number, passed: boolean, results: any[] }`
- Calculate percentage correct
- Return detailed results with explanations

`getAttestationHistory(employeeId: string, organizationId: string): Promise<CampaignAssignment[]>`
- Return all attestation assignments for employee
- Include policy and campaign details
  </action>
  <verify>Services compile. Methods handle all three attestation types.</verify>
  <done>AttestationCampaignService creates campaigns, AttestationResponseService processes responses.</done>
</task>

<task type="auto">
  <name>Task 3: Create attestation controller and update module</name>
  <files>
apps/backend/src/modules/campaigns/attestation/attestation.controller.ts
apps/backend/src/modules/campaigns/campaigns.module.ts
  </files>
  <action>
**Create attestation.controller.ts:**

@Controller('attestations')
@UseGuards(AuthGuard, RolesGuard)
@ApiBearerAuth()
@ApiTags('attestations')

Endpoints:

POST /campaigns - Create attestation campaign from policy
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER)
- @Body() CreateAttestationCampaignDto
- Returns Campaign

GET /campaigns/policy/:policyId - Get campaigns for policy
- @Roles(Role.SYSTEM_ADMIN, Role.COMPLIANCE_OFFICER)
- Returns Campaign[]

POST /submit - Submit attestation response
- @Roles(Role.EMPLOYEE, Role.COMPLIANCE_OFFICER, ...) - any authenticated user
- @Body() SubmitAttestationDto
- Verify assignment belongs to current user's employee record
- Returns { assignment, riu, case }

GET /my-pending - Get user's pending attestations
- Any authenticated role
- Returns CampaignAssignment[] where status PENDING/IN_PROGRESS

GET /my-history - Get user's attestation history
- Any authenticated role
- Returns CampaignAssignment[] (completed)

GET /assignment/:id - Get assignment details for attestation UI
- Verify assignment belongs to user
- Include policy content, campaign config
- Returns { assignment, policy, campaign }

**Update campaigns.module.ts:**

Add to providers:
- AttestationCampaignService
- AttestationResponseService

Add to controllers:
- AttestationController

Add to imports:
- PoliciesModule (for PoliciesService access)
- RiusModule (for RiusService)
- CasesModule (for auto-case creation)

Add to exports:
- AttestationCampaignService
- AttestationResponseService

Create attestation/index.ts exporting services, DTOs.
  </action>
  <verify>Run `npm run build`. Controller compiles. Module has all imports.</verify>
  <done>Attestation endpoints exposed, module updated with service dependencies.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. Campaign model has policyVersionId, attestationType, quizConfig fields
3. CampaignAssignment has attestedAt, quizScore, refusalReason fields
4. createFromPolicy() creates campaign linked to specific PolicyVersion
5. submitAttestation() creates RIU record (immutable attestation)
6. Refusal with autoCreateCaseOnRefusal creates Case
7. Quiz scoring calculates pass/fail correctly
</verification>

<success_criteria>
- Attestation campaigns link to specific PolicyVersion (not just policyId)
- Three attestation types work: CHECKBOX, SIGNATURE, QUIZ
- Attestation response creates RIU (immutable audit trail)
- Refusal auto-creates case for compliance follow-up
- Quiz scoring with immediate feedback works
</success_criteria>

<output>
After completion, create `.planning/phases/10-policy-management/10-04-SUMMARY.md`
</output>
