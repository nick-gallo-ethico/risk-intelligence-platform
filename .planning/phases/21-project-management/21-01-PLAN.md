---
phase: 21-project-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/projects/dto/project.dto.ts
  - apps/backend/src/modules/projects/dto/project-task.dto.ts
  - apps/backend/src/modules/projects/dto/project-group.dto.ts
  - apps/backend/src/modules/projects/dto/project-template.dto.ts
  - apps/backend/src/modules/projects/dto/index.ts
  - apps/backend/src/modules/projects/project.service.ts
  - apps/backend/src/modules/projects/project-task.service.ts
  - apps/backend/src/modules/projects/project-group.service.ts
  - apps/backend/src/modules/projects/project-template.service.ts
  - apps/backend/src/modules/projects/events/project.events.ts
  - apps/backend/src/modules/projects/projects.module.ts
autonomous: true

must_haves:
  truths:
    - "ProjectGroup, ProjectTask, ProjectColumn, ProjectTemplate Prisma models exist with migrations applied"
    - "ProjectService provides CRUD for projects with group and task counts"
    - "ProjectTaskService provides CRUD for tasks with status, priority, assignee, subtask support"
    - "ProjectGroupService provides CRUD for groups with reordering"
    - "ProjectTemplateService provides CRUD for templates with apply-template-to-project functionality"
    - "All services enforce organizationId tenant isolation"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "ProjectGroup, ProjectTask, ProjectColumn, ProjectTemplate models"
      contains: "model ProjectGroup"
    - path: "apps/backend/src/modules/projects/project.service.ts"
      provides: "Extended project CRUD with groups and tasks"
    - path: "apps/backend/src/modules/projects/project-task.service.ts"
      provides: "Task CRUD with subtask support, bulk operations"
    - path: "apps/backend/src/modules/projects/project-template.service.ts"
      provides: "Template CRUD with apply functionality"
  key_links:
    - from: "project.service.ts"
      to: "prisma.milestone"
      via: "Prisma client queries"
      pattern: "prisma\\.milestone\\."
    - from: "project-task.service.ts"
      to: "prisma.projectTask"
      via: "Prisma client queries"
      pattern: "prisma\\.projectTask\\."
---

<objective>
Create the backend data model and services for Monday.com-style project management. This adds ProjectGroup (sections within a project), ProjectTask (rich task model replacing MilestoneItem for project tasks), ProjectColumn (customizable columns per project), and ProjectTemplate (reusable project templates) to the existing Milestone-based infrastructure.

Purpose: Establish the data layer and business logic for project boards, task management, and project templates.
Output: Prisma models with migration, service classes with full CRUD, DTOs with validation, and event definitions.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-project-management/21-RESEARCH.md
@apps/backend/prisma/schema.prisma
@apps/backend/src/modules/projects/projects.module.ts
@apps/backend/src/modules/projects/milestone.service.ts
@apps/backend/src/modules/projects/dto/milestone.dto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Prisma models and enums for project management</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add the following models and enums to schema.prisma AFTER the existing MilestoneItem model (around line 6067, before the Internal Operations Portal section):

**New Enums:**

- `ProjectTaskStatus`: NOT_STARTED, IN_PROGRESS, STUCK, DONE, CANCELLED
- `ProjectTaskPriority`: LOW, MEDIUM, HIGH, CRITICAL
- `ProjectColumnType`: STATUS, PERSON, DATE, TEXT, NUMBER, PRIORITY, LABEL

**ProjectGroup model** (sections/groups within a project):

- `id` (String @id @default(uuid()))
- `organizationId` (String, FK to Organization)
- `milestoneId` (String, FK to Milestone - the parent project)
- `name` (String)
- `color` (String? - hex color for group header)
- `sortOrder` (Int @default(0))
- `isCollapsed` (Boolean @default(false))
- `createdAt`, `updatedAt`
- Relations: organization, milestone (Milestone), tasks (ProjectTask[])
- Indexes: [milestoneId], [organizationId]
- @@map("project_groups")

**ProjectTask model** (rich tasks within a project):

- `id` (String @id @default(uuid()))
- `organizationId` (String, FK to Organization)
- `milestoneId` (String, FK to Milestone - the parent project)
- `groupId` (String?, FK to ProjectGroup - nullable for ungrouped tasks)
- `title` (String)
- `description` (String?)
- `status` (ProjectTaskStatus @default(NOT_STARTED))
- `priority` (ProjectTaskPriority @default(MEDIUM))
- `assigneeId` (String?, FK to User)
- `startDate` (DateTime?)
- `dueDate` (DateTime?)
- `completedAt` (DateTime?)
- `sortOrder` (Int @default(0))
- `parentTaskId` (String? - self-reference for subtasks)
- `customFields` (Json? - extensible JSON for custom columns)
- `createdAt`, `updatedAt`
- `createdById` (String, FK to User)
- Relations: organization, milestone (Milestone), group (ProjectGroup?), assignee (User?), createdBy (User), parentTask (self), subtasks (self[])
- Indexes: [milestoneId], [groupId], [assigneeId], [organizationId, status], [parentTaskId]
- @@map("project_tasks")

**ProjectColumn model** (customizable columns per project):

- `id` (String @id @default(uuid()))
- `organizationId` (String, FK to Organization)
- `milestoneId` (String, FK to Milestone)
- `name` (String)
- `type` (ProjectColumnType)
- `settings` (Json? - options for STATUS/LABEL columns, e.g., {options: [{value, label, color}]})
- `sortOrder` (Int @default(0))
- `width` (Int? - pixel width for table view)
- `isRequired` (Boolean @default(false))
- `createdAt`, `updatedAt`
- Relations: organization, milestone (Milestone)
- Indexes: [milestoneId], [organizationId]
- @@map("project_columns")

**ProjectTemplate model**:

- `id` (String @id @default(uuid()))
- `organizationId` (String?, FK to Organization - null for system templates)
- `name` (String)
- `description` (String?)
- `category` (MilestoneCategory - reuse existing enum)
- `templateData` (Json - contains groups, columns, sample tasks structure)
- `isSystem` (Boolean @default(false))
- `createdAt`, `updatedAt`
- `createdById` (String?, FK to User)
- Relations: organization (Organization?), createdBy (User?)
- Indexes: [organizationId], [category]
- @@map("project_templates")

Add `PROJECT_TASK` to the AuditEntityType enum (after MILESTONE_ITEM).
Add `PROJECTS` to the ViewEntityType enum (after INTAKE_FORMS).

Add relations on Milestone model: `groups ProjectGroup[]`, `tasks ProjectTask[]`, `columns ProjectColumn[]`.
Add relations on User model for: ProjectTask assignee and createdBy.
Add relations on Organization model for the new models.

Then run `npx prisma migrate dev --name add_project_management_models` from apps/backend.
Then run `npx prisma generate`.
</action>
<verify>
Run `npx prisma validate` from apps/backend - should succeed with no errors.
Run `npx prisma migrate dev --name add_project_management_models` - migration should apply cleanly.
The generated Prisma client should export ProjectGroup, ProjectTask, ProjectColumn, ProjectTemplate types.
</verify>
<done>All 4 new models exist in schema.prisma with proper relations, indexes, and enums. Migration applied. Prisma client generated with new types.</done>
</task>

<task type="auto">
  <name>Task 2: Create DTOs, services, and events for project management</name>
  <files>
    apps/backend/src/modules/projects/dto/project.dto.ts
    apps/backend/src/modules/projects/dto/project-task.dto.ts
    apps/backend/src/modules/projects/dto/project-group.dto.ts
    apps/backend/src/modules/projects/dto/project-template.dto.ts
    apps/backend/src/modules/projects/dto/index.ts
    apps/backend/src/modules/projects/project.service.ts
    apps/backend/src/modules/projects/project-task.service.ts
    apps/backend/src/modules/projects/project-group.service.ts
    apps/backend/src/modules/projects/project-template.service.ts
    apps/backend/src/modules/projects/events/project.events.ts
    apps/backend/src/modules/projects/projects.module.ts
  </files>
  <action>
**Events** (`events/project.events.ts`):
Create event classes extending BaseEvent pattern:
- `ProjectTaskCreatedEvent`, `ProjectTaskUpdatedEvent`, `ProjectTaskCompletedEvent`, `ProjectTaskDeletedEvent`
- `ProjectGroupCreatedEvent`, `ProjectGroupDeletedEvent`
- Event names: `project.task.created`, `project.task.updated`, etc.
- All require organizationId per BaseEvent pattern.

**DTOs:**

`project.dto.ts` - Extended project DTOs:

- `ProjectDetailResponseDto` extending MilestoneResponseDto: adds `groups` (ProjectGroup[]), `taskCount`, `completedTaskCount`, `columns` (ProjectColumn[])
- `ProjectQueryDto` extending MilestoneQueryDto: adds `search` (string, optional)

`project-task.dto.ts`:

- `CreateProjectTaskDto`: title (required), description?, status?, priority?, assigneeId?, startDate?, dueDate?, groupId?, parentTaskId?, sortOrder?, customFields?
- `UpdateProjectTaskDto`: All fields optional (PartialType)
- `ProjectTaskQueryDto`: status?, priority?, assigneeId?, groupId?, search?, sortBy?, sortOrder?, limit/offset
- `BulkUpdateTasksDto`: taskIds (string[]), update (Partial: status?, priority?, assigneeId?, dueDate?)
- `ReorderTasksDto`: orderedIds (string[])
- All use class-validator decorators.

`project-group.dto.ts`:

- `CreateProjectGroupDto`: name (required), color?, sortOrder?
- `UpdateProjectGroupDto`: name?, color?, sortOrder?, isCollapsed?
- `ReorderGroupsDto`: orderedIds (string[])

`project-template.dto.ts`:

- `CreateProjectTemplateDto`: name, description?, category, templateData (JSON)
- `ApplyTemplateDto`: templateId, name (project name), targetDate, ownerId?

Update `dto/index.ts` to re-export all new DTOs.

**Services:**

`project.service.ts`:

- Injectable, constructor takes PrismaService and EventEmitter2
- `getDetail(orgId, projectId)`: Returns project with groups, tasks, columns, task counts
- `updateProgress(orgId, projectId)`: Recalculates progress from ProjectTask completion counts (not MilestoneItem), updates Milestone.progressPercent, totalItems, completedItems
- `getProjectsWithTaskCounts(orgId, query)`: List projects with task count summary

`project-task.service.ts`:

- Injectable, constructor takes PrismaService, EventEmitter2, AuditService
- `create(orgId, projectId, userId, dto)`: Create task, emit event, update project progress
- `update(orgId, taskId, userId, dto)`: Update task, if status changes to DONE set completedAt. Emit event. Update project progress.
- `delete(orgId, taskId, userId)`: Delete task, update project progress
- `list(orgId, projectId, query)`: List tasks with filters, includes assignee and subtask count
- `bulkUpdate(orgId, dto)`: Update multiple tasks at once (for drag-drop status changes)
- `reorder(orgId, projectId, groupId, orderedIds)`: Reorder tasks within a group
- `getSubtasks(orgId, parentTaskId)`: Get subtasks for a task
- All methods log to AuditService with entity type MILESTONE (or PROJECT_TASK if added)

`project-group.service.ts`:

- Injectable, constructor takes PrismaService
- `create(orgId, projectId, dto)`: Create group
- `update(orgId, groupId, dto)`: Update group
- `delete(orgId, groupId)`: Delete group (moves tasks to ungrouped or deletes)
- `reorder(orgId, projectId, orderedIds)`: Reorder groups

`project-template.service.ts`:

- Injectable, constructor takes PrismaService
- `create(orgId, userId, dto)`: Create template
- `list(orgId)`: List templates (org-specific + system templates where isSystem=true)
- `get(orgId, templateId)`: Get single template
- `delete(orgId, templateId)`: Delete (only if not system)
- `applyTemplate(orgId, userId, dto)`: Creates a new Milestone (project) from template, creates groups, columns, and tasks from templateData JSON. Returns the new project ID.
- System templates seeded: "New Client Implementation", "Annual Policy Review", "Compliance Audit Prep", "Investigation Project", "Training Rollout", "Disclosure Campaign"

**Module Update** (`projects.module.ts`):

- Import AuditModule (if not already @Global)
- Add ProjectService (new), ProjectTaskService, ProjectGroupService, ProjectTemplateService to providers
- Export all services
  </action>
  <verify>
  TypeScript compilation succeeds: `cd apps/backend && npx tsc --noEmit` should pass.
  All services can be instantiated via NestJS DI (no circular dependency errors).
  </verify>
  <done>
  All 4 services created with full CRUD operations. DTOs have class-validator decorators. Events defined. ProjectsModule updated with new providers. TypeScript compiles cleanly.
  </done>
  </task>

</tasks>

<verification>
- `npx prisma validate` passes
- `npx tsc --noEmit` passes from apps/backend
- New models visible in Prisma Studio
- ViewEntityType includes PROJECTS
- AuditEntityType includes PROJECT_TASK
</verification>

<success_criteria>

- 4 new Prisma models (ProjectGroup, ProjectTask, ProjectColumn, ProjectTemplate) with migration applied
- 4 new services with CRUD operations
- DTOs with validation for all operations
- Template system with 6 built-in compliance project templates
- Progress recalculation based on ProjectTask completion
- All queries scoped by organizationId
  </success_criteria>

<output>
After completion, create `.planning/phases/21-project-management/21-01-SUMMARY.md`
</output>
