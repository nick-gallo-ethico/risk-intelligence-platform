---
phase: 21-project-management
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - apps/backend/src/modules/projects/projects.controller.ts
  - apps/backend/src/modules/projects/project-template.controller.ts
  - apps/backend/src/modules/analytics/my-work/task-aggregator.service.ts
  - apps/backend/src/modules/analytics/my-work/entities/unified-task.entity.ts
  - apps/backend/src/modules/projects/projects.module.ts
autonomous: true

must_haves:
  truths:
    - "REST endpoints exist for project tasks CRUD at /api/v1/projects/:id/tasks"
    - "REST endpoints exist for project groups CRUD at /api/v1/projects/:id/groups"
    - "REST endpoints exist for project templates at /api/v1/project-templates"
    - "Bulk task update endpoint exists for drag-drop operations"
    - "Project tasks appear in My Work unified task queue"
    - "GET /api/v1/projects/:id returns full detail with groups, tasks, and columns"
  artifacts:
    - path: "apps/backend/src/modules/projects/projects.controller.ts"
      provides: "Extended REST API for groups and tasks"
    - path: "apps/backend/src/modules/projects/project-template.controller.ts"
      provides: "Template CRUD and apply endpoints"
    - path: "apps/backend/src/modules/analytics/my-work/task-aggregator.service.ts"
      provides: "Project tasks in My Work queue"
  key_links:
    - from: "projects.controller.ts"
      to: "project-task.service.ts"
      via: "NestJS dependency injection"
      pattern: "projectTaskService"
    - from: "task-aggregator.service.ts"
      to: "prisma.projectTask"
      via: "Prisma query for assigned tasks"
      pattern: "projectTask\\.findMany"
---

<objective>
Extend the projects controller with endpoints for tasks, groups, and columns. Create a separate template controller. Integrate project tasks into the My Work unified task queue so assigned tasks appear in users' task lists.

Purpose: Expose the project management services via REST API and integrate with platform-wide task aggregation.
Output: Extended controller with ~15 new endpoints, template controller, and My Work integration.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-project-management/21-01-SUMMARY.md
@apps/backend/src/modules/projects/projects.controller.ts
@apps/backend/src/modules/analytics/my-work/task-aggregator.service.ts
@apps/backend/src/modules/analytics/my-work/entities/unified-task.entity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend ProjectsController with task, group, and column endpoints</name>
  <files>
    apps/backend/src/modules/projects/projects.controller.ts
    apps/backend/src/modules/projects/project-template.controller.ts
    apps/backend/src/modules/projects/projects.module.ts
  </files>
  <action>
**Extend ProjectsController** with new endpoints (keep all existing endpoints):

Project Detail (override existing):

- `GET /projects/:id` - Update to call `projectService.getDetail()` returning full project with groups, tasks, columns, task counts

Task Endpoints:

- `GET /projects/:id/tasks` - List tasks with filters (uses ProjectTaskQueryDto)
- `POST /projects/:id/tasks` - Create task (COMPLIANCE_OFFICER, MANAGER, SYSTEM_ADMIN)
- `PUT /projects/:id/tasks/:taskId` - Update task
- `DELETE /projects/:id/tasks/:taskId` - Delete task
- `PUT /projects/:id/tasks/bulk` - Bulk update tasks (for drag-drop: change status or group)
- `PUT /projects/:id/tasks/reorder` - Reorder tasks within group (ReorderTasksDto)
- `GET /projects/:id/tasks/:taskId/subtasks` - Get subtasks

Group Endpoints:

- `GET /projects/:id/groups` - List groups for project
- `POST /projects/:id/groups` - Create group
- `PUT /projects/:id/groups/:groupId` - Update group
- `DELETE /projects/:id/groups/:groupId` - Delete group
- `PUT /projects/:id/groups/reorder` - Reorder groups (ReorderGroupsDto)

All endpoints use `@UseGuards(JwtAuthGuard, TenantGuard)` at class level. Write endpoints use `@Roles(UserRole.COMPLIANCE_OFFICER, UserRole.MANAGER, UserRole.SYSTEM_ADMIN)` with `@UseGuards(RolesGuard)`. All use `@CurrentUser()` and `@TenantId()` decorators. All have Swagger decorators.

**Create ProjectTemplateController** (`project-template.controller.ts`):
Route prefix: `project-templates`

- `GET /project-templates` - List templates (org + system)
- `GET /project-templates/:id` - Get template
- `POST /project-templates` - Create template
- `DELETE /project-templates/:id` - Delete template (not system)
- `POST /project-templates/:id/apply` - Apply template to create new project (ApplyTemplateDto)
  All use same guard pattern as ProjectsController.

**Update ProjectsModule**:

- Add ProjectsController (already there) and ProjectTemplateController to controllers array
- Inject ProjectService, ProjectTaskService, ProjectGroupService, ProjectTemplateService into both controllers
  </action>
  <verify>
  `cd apps/backend && npx tsc --noEmit` passes.
  Check that all new routes register by starting the server briefly or checking NestJS route output.
  </verify>
  <done>ProjectsController has 13+ new endpoints for tasks and groups. ProjectTemplateController has 5 endpoints. All routes use proper guards and decorators.</done>
  </task>

<task type="auto">
  <name>Task 2: Integrate project tasks into My Work queue</name>
  <files>
    apps/backend/src/modules/analytics/my-work/task-aggregator.service.ts
    apps/backend/src/modules/analytics/my-work/entities/unified-task.entity.ts
  </files>
  <action>
**Update unified-task.entity.ts:**
- Add `PROJECT_TASK` to the `TaskType` enum (alongside CASE, INVESTIGATION, CAMPAIGN_ASSIGNMENT, etc.)

**Update TaskAggregatorService:**

- Add a new private method `fetchProjectTasks(params: FetchTasksParams): Promise<UnifiedTask[]>` that:
  1. Queries `prisma.projectTask.findMany()` where assigneeId = userId AND organizationId AND status NOT IN [DONE, CANCELLED]
  2. Includes: milestone (for project name), group (for group name)
  3. Maps each ProjectTask to a UnifiedTask:
     - id: `PROJECT_TASK-${task.id}` (following existing task ID encoding pattern)
     - type: TaskType.PROJECT_TASK
     - title: task.title
     - description: task.description
     - entityId: task.id
     - entityType: 'PROJECT_TASK'
     - parentEntityId: task.milestoneId
     - parentEntityType: 'PROJECT'
     - parentEntityName: task.milestone.name
     - status: Map ProjectTaskStatus to TaskStatus (NOT_STARTED->PENDING, IN_PROGRESS->IN_PROGRESS, STUCK->IN_PROGRESS, DONE->COMPLETED, CANCELLED->COMPLETED)
     - priority: Map ProjectTaskPriority to TaskPriority (LOW->LOW, MEDIUM->MEDIUM, HIGH->HIGH, CRITICAL->CRITICAL)
     - dueDate: task.dueDate
     - createdAt: task.createdAt
     - url: `/projects/${task.milestoneId}?task=${task.id}`

- In the main `fetchTasks()` method, add `fetchProjectTasks()` to the `Promise.all()` array alongside existing task fetchers
- In `getTaskCounts()`, add PROJECT_TASK count query

This ensures project tasks assigned to a user appear in their "My Work" queue alongside case tasks, investigation tasks, etc.
</action>
<verify>
`cd apps/backend && npx tsc --noEmit` passes.
PROJECT_TASK exists in TaskType enum.
fetchProjectTasks method exists in TaskAggregatorService.
</verify>
<done>Project tasks assigned to users appear in the My Work unified task queue. TaskType.PROJECT_TASK is recognized. Task counts include project tasks.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from apps/backend
- All 18+ new endpoints accessible via API
- My Work queue includes PROJECT_TASK type
</verification>

<success_criteria>

- Full REST API for project tasks, groups, and templates
- Bulk update endpoint for drag-drop operations
- Project templates can be applied to create new projects
- Project tasks show in My Work queue
- All endpoints enforce tenant isolation and role-based access
  </success_criteria>

<output>
After completion, create `.planning/phases/21-project-management/21-02-SUMMARY.md`
</output>
