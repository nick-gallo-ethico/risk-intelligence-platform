---
phase: 21-project-management
plan: 09
type: execute
wave: 7
depends_on: ["21-05"]
files_modified:
  - apps/backend/src/modules/projects/services/project-stats.service.ts
  - apps/backend/src/modules/projects/projects.controller.ts
  - apps/frontend/src/components/projects/ProjectWorkloadView.tsx
  - apps/frontend/src/components/projects/ProjectDashboardView.tsx
  - apps/frontend/src/app/(authenticated)/projects/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Workload view shows team member capacity with task distribution bars"
    - "Project dashboard shows KPI cards, status breakdown chart, and progress timeline"
    - "Backend stats endpoint returns aggregated project metrics"
    - "All 5 view modes work on project detail: table, board, timeline, workload, dashboard"
    - "Workload bars show overloaded team members in red"
  artifacts:
    - path: "apps/frontend/src/components/projects/ProjectWorkloadView.tsx"
      provides: "Workload view showing team capacity and task distribution"
    - path: "apps/frontend/src/components/projects/ProjectDashboardView.tsx"
      provides: "Project dashboard with KPI cards and charts"
    - path: "apps/backend/src/modules/projects/services/project-stats.service.ts"
      provides: "Backend service for aggregated project statistics"
  key_links:
    - from: "ProjectWorkloadView.tsx"
      to: "use-project-detail.ts"
      via: "useProjectStats hook for workload data"
      pattern: "useProjectStats"
    - from: "ProjectDashboardView.tsx"
      to: "project-stats.service.ts"
      via: "GET /projects/:id/stats endpoint"
      pattern: "projects.*stats"
---

<objective>
Add the Workload view and Project Dashboard view to complete the 5-view experience on the project detail page. The Workload view shows team member capacity — who has too many tasks, who has room. The Dashboard view provides a project-level overview with KPIs, charts, and progress metrics. This matches Monday.com's Workload and Dashboard views.

Purpose: Project managers need to see at a glance who's overloaded and how the project is tracking against timeline. These views transform raw task data into actionable insights.
Output: Workload view with capacity bars, dashboard with KPI cards and charts, backend stats endpoint.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-project-management/21-05-SUMMARY.md
@apps/frontend/src/app/(authenticated)/projects/[id]/page.tsx
@apps/frontend/src/hooks/use-project-detail.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build backend stats endpoint and frontend workload view</name>
  <files>
    apps/backend/src/modules/projects/services/project-stats.service.ts
    apps/backend/src/modules/projects/projects.controller.ts
    apps/frontend/src/components/projects/ProjectWorkloadView.tsx
    apps/frontend/src/hooks/use-project-detail.ts
  </files>
  <action>
**ProjectStatsService** (`services/project-stats.service.ts`):

Injectable service that computes aggregated project statistics:

```typescript
@Injectable()
export class ProjectStatsService {
  constructor(private prisma: PrismaService) {}

  async getProjectStats(projectId: string, organizationId: string) {
    const project = await this.prisma.milestone.findFirst({
      where: { id: projectId, organizationId },
    });

    const tasks = await this.prisma.projectTask.findMany({
      where: { projectId, organizationId },
      include: { assignee: { select: { id: true, name: true, email: true } } },
    });

    // Status breakdown
    const statusCounts = {
      NOT_STARTED: 0,
      IN_PROGRESS: 0,
      STUCK: 0,
      DONE: 0,
      CANCELLED: 0,
    };
    tasks.forEach((t) => {
      statusCounts[t.status]++;
    });

    // Priority breakdown
    const priorityCounts = {
      LOW: 0,
      MEDIUM: 0,
      HIGH: 0,
      CRITICAL: 0,
    };
    tasks.forEach((t) => {
      priorityCounts[t.priority]++;
    });

    // Workload per assignee
    const workloadMap = new Map<
      string,
      {
        user: any;
        total: number;
        done: number;
        inProgress: number;
        stuck: number;
        overdue: number;
      }
    >();
    const now = new Date();
    tasks.forEach((t) => {
      if (!t.assigneeId) return;
      if (!workloadMap.has(t.assigneeId)) {
        workloadMap.set(t.assigneeId, {
          user: t.assignee,
          total: 0,
          done: 0,
          inProgress: 0,
          stuck: 0,
          overdue: 0,
        });
      }
      const entry = workloadMap.get(t.assigneeId)!;
      entry.total++;
      if (t.status === "DONE") entry.done++;
      if (t.status === "IN_PROGRESS") entry.inProgress++;
      if (t.status === "STUCK") entry.stuck++;
      if (t.dueDate && new Date(t.dueDate) < now && t.status !== "DONE")
        entry.overdue++;
    });

    // Overdue tasks
    const overdueTasks = tasks.filter(
      (t) =>
        t.dueDate &&
        new Date(t.dueDate) < now &&
        t.status !== "DONE" &&
        t.status !== "CANCELLED",
    );

    // Unassigned tasks
    const unassignedTasks = tasks.filter(
      (t) => !t.assigneeId && t.status !== "DONE" && t.status !== "CANCELLED",
    );

    // Progress over time (last 30 days: count of completed tasks per day)
    const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    const completedByDay = tasks
      .filter((t) => t.completedAt && new Date(t.completedAt) >= thirtyDaysAgo)
      .reduce(
        (acc, t) => {
          const day = new Date(t.completedAt!).toISOString().split("T")[0];
          acc[day] = (acc[day] || 0) + 1;
          return acc;
        },
        {} as Record<string, number>,
      );

    // Group progress
    const groups = await this.prisma.projectGroup.findMany({
      where: { projectId, organizationId },
    });
    const groupProgress = groups.map((g) => {
      const groupTasks = tasks.filter((t) => t.groupId === g.id);
      const done = groupTasks.filter((t) => t.status === "DONE").length;
      return {
        groupId: g.id,
        groupName: g.name,
        groupColor: g.color,
        total: groupTasks.length,
        done,
        progressPercent:
          groupTasks.length > 0
            ? Math.round((done / groupTasks.length) * 100)
            : 0,
      };
    });

    return {
      totalTasks: tasks.length,
      completedTasks: statusCounts.DONE,
      progressPercent:
        tasks.length > 0
          ? Math.round((statusCounts.DONE / tasks.length) * 100)
          : 0,
      statusCounts,
      priorityCounts,
      workload: Array.from(workloadMap.values()),
      overdueTasks: overdueTasks.length,
      unassignedTasks: unassignedTasks.length,
      completedByDay,
      groupProgress,
      daysUntilTarget: project?.targetDate
        ? Math.ceil(
            (new Date(project.targetDate).getTime() - now.getTime()) /
              (1000 * 60 * 60 * 24),
          )
        : null,
    };
  }
}
```

**Add stats endpoint to projects.controller.ts**:

```typescript
@Get(':id/stats')
@Roles(Role.COMPLIANCE_OFFICER, Role.MANAGER, Role.SYSTEM_ADMIN, Role.POLICY_AUTHOR)
async getProjectStats(@Param('id') id: string, @TenantId() orgId: string) {
  return this.projectStatsService.getProjectStats(id, orgId);
}
```

**Add hook to use-project-detail.ts**:

```typescript
export function useProjectStats(projectId: string) {
  return useQuery({
    queryKey: ["project", projectId, "stats"],
    queryFn: () =>
      apiClient.get(`/projects/${projectId}/stats`).then((r) => r.data),
    enabled: !!projectId,
    refetchInterval: 60000, // Refresh every 60 seconds
  });
}
```

**ProjectWorkloadView.tsx** — Monday.com's Workload View:

Shows each team member's task distribution as horizontal stacked bars:

- Header: "Team Workload" with capacity threshold selector (default: 10 tasks per person)
- For each assignee (from stats.workload):
  - Left side: Avatar + Name
  - Right side: Horizontal stacked bar showing:
    - Green section: Done tasks
    - Blue section: In Progress tasks
    - Red section: Stuck tasks
    - Gray section: Not Started tasks
  - Total count at end of bar
  - If total > capacity threshold: bar background turns red (overloaded indicator)
  - Overdue badge: red number if any overdue tasks
- "Unassigned" row at bottom: shows count of tasks with no assignee
- Sort options: By name (A-Z), By total tasks (desc), By overdue (desc)
- Click on a person's bar expands to show their individual task list (inline)
- Color legend at top: Done (green), In Progress (blue), Stuck (red), Not Started (gray)
- Capacity line: vertical dashed line at the capacity threshold
  </action>
  <verify>
  `cd apps/backend && npx tsc --noEmit` passes.
  `cd apps/frontend && npx tsc --noEmit` passes.
  Stats endpoint returns workload data.
  Workload view shows capacity bars per team member.
  </verify>
  <done>Backend stats endpoint returns aggregated project metrics (status/priority counts, workload per assignee, overdue, progress over time). Workload view shows team capacity with stacked horizontal bars and overload indicators.</done>
  </task>

<task type="auto">
  <name>Task 2: Build project dashboard view and wire up all 5 view modes</name>
  <files>
    apps/frontend/src/components/projects/ProjectDashboardView.tsx
    apps/frontend/src/app/(authenticated)/projects/[id]/page.tsx
  </files>
  <action>
**ProjectDashboardView.tsx** — Project-level dashboard with widgets:

A grid layout dashboard showing project health at a glance:

**Row 1: KPI Cards** (4 cards across):

1. **Total Progress**: Large percentage number + circular progress ring. Color: green if >75%, yellow if >50%, red if <50%.
2. **Tasks Completed**: "X of Y" with small progress bar. Shows completion rate.
3. **Days Remaining**: Number with target date below. Red if negative (overdue). Green if >30 days.
4. **Overdue Tasks**: Count in red. "0" in green if none. Click navigates to filtered table view showing overdue tasks.

**Row 2: Charts** (2 charts side by side):

1. **Status Breakdown** (Donut/Pie chart):

- Segments: Not Started (gray), In Progress (blue), Stuck (red), Done (green), Cancelled (muted gray)
- Center: total task count
- Legend below with counts
- Use recharts PieChart with custom colors

2. **Completion Trend** (Line/Area chart):

- X-axis: Last 30 days
- Y-axis: Cumulative completed tasks
- Area fill in green gradient
- Annotation: "On track" or "Behind schedule" based on burn rate vs. remaining days
- Use recharts AreaChart

**Row 3: Group Progress** (horizontal bar chart or progress list):

- For each ProjectGroup:
  - Group name with colored dot
  - Horizontal progress bar (done/total)
  - Percentage label
  - Sorted by progress ascending (least progress first, to highlight blockers)

**Row 4: Priority Distribution** (stacked bar or pie):

- Small chart showing task distribution by priority
- LOW (gray), MEDIUM (yellow), HIGH (orange), CRITICAL (red)

**Row 5: Quick Stats**:

- Unassigned tasks count (with "Assign" link)
- Stuck tasks count (with "View" link)
- Tasks due this week count
- Recently completed (last 7 days) count

All charts use recharts library (already in the project from Phase 11 Analytics).
Responsive: on mobile, cards stack vertically.
Loading state: skeleton cards while stats load.

**Update project detail page** (`[id]/page.tsx`):

Complete the 5-view integration:

- ViewModeTabs now shows 5 tabs: Table | Board | Timeline | Workload | Dashboard
- Each tab icon:
  - Table: List icon
  - Board: LayoutGrid icon
  - Timeline: GanttChartSquare icon
  - Workload: Users icon
  - Dashboard: BarChart3 icon
- View mode stored in URL: `?view=table|board|timeline|workload|dashboard`
- Default: 'table'
- Content rendering:
  ```tsx
  {
    viewMode === "table" && <ProjectTaskTable project={project} />;
  }
  {
    viewMode === "board" && <ProjectBoardView project={project} />;
  }
  {
    viewMode === "timeline" && <ProjectTimelineView project={project} />;
  }
  {
    viewMode === "workload" && <ProjectWorkloadView project={project} />;
  }
  {
    viewMode === "dashboard" && <ProjectDashboardView project={project} />;
  }
  ```
- Remove any remaining placeholder components for board/timeline (replaced in Plan 05)
- Ensure TaskDetailPanel slides over any view (fixed positioning, not part of view content)
  </action>
  <verify>
  `cd apps/frontend && npx tsc --noEmit` passes.
  Dashboard shows KPI cards, charts, and group progress.
  All 5 view modes switch correctly.
  URL persists view mode.
  </verify>
  <done>Project dashboard with KPI cards (progress, completed, days remaining, overdue), status donut chart, completion trend line, group progress bars, and priority distribution. All 5 view modes integrated into project detail page with URL persistence.</done>
  </task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from both apps/backend and apps/frontend
- GET /projects/:id/stats returns aggregated metrics
- Workload view shows team capacity bars with overload indicators
- Dashboard shows KPI cards, status pie chart, completion trend, group progress
- All 5 view tabs work: table, board, timeline, workload, dashboard
- View mode persists in URL searchParams
</verification>

<success_criteria>

- Workload view shows horizontal stacked bars per team member
- Overloaded team members highlighted in red
- Unassigned tasks shown separately
- Dashboard has 4 KPI cards with visual indicators
- Status breakdown pie chart with correct colors
- Completion trend line chart over 30 days
- Group progress bars sorted by completion
- All 5 view modes accessible and functional
- Stats endpoint refreshes efficiently
  </success_criteria>

<output>
After completion, create `.planning/phases/21-project-management/21-09-SUMMARY.md`
</output>
