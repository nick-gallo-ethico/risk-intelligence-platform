---
phase: 21-project-management
plan: 06
type: execute
wave: 6
depends_on: ["21-04", "21-05"]
files_modified:
  - apps/frontend/src/components/projects/TaskDetailPanel.tsx
  - apps/frontend/src/components/projects/TaskUpdateThread.tsx
  - apps/frontend/src/components/projects/TaskActivityLog.tsx
  - apps/frontend/src/components/projects/TaskFileList.tsx
  - apps/frontend/src/components/projects/TaskSubscriberList.tsx
  - apps/frontend/src/components/projects/TaskDependencyList.tsx
  - apps/frontend/src/components/projects/MentionInput.tsx
autonomous: true

must_haves:
  truths:
    - "Task detail panel has 4 tabs: Details, Updates, Activity, Files"
    - "Updates tab shows threaded conversation with @mention support"
    - "Activity tab shows chronological log of all task changes"
    - "Files tab shows attachments with upload/download/delete"
    - "Users can subscribe/unsubscribe to task notifications"
    - "Task dependencies can be viewed and managed from detail panel"
    - "@mention input provides user autocomplete and creates notifications"
  artifacts:
    - path: "apps/frontend/src/components/projects/TaskDetailPanel.tsx"
      provides: "Enhanced task detail panel with 4 tabbed sections"
    - path: "apps/frontend/src/components/projects/TaskUpdateThread.tsx"
      provides: "Threaded conversation UI for task updates"
    - path: "apps/frontend/src/components/projects/MentionInput.tsx"
      provides: "Rich text input with @mention autocomplete"
  key_links:
    - from: "TaskUpdateThread.tsx"
      to: "use-project-detail.ts"
      via: "useTaskUpdates, useCreateTaskUpdate hooks"
      pattern: "useTaskUpdates|useCreateTaskUpdate"
    - from: "MentionInput.tsx"
      to: "use-project-detail.ts"
      via: "useProjectMembers hook for autocomplete"
      pattern: "useProjectMembers"
---

<objective>
Enhance the TaskDetailPanel from Plan 04 into a full-featured task workspace with four tabs — the Monday.com-style item detail experience. The Updates tab is the centerpiece: a threaded conversation system with @mention support that drives collaboration. Activity log tracks every change. File attachments allow uploads. Subscribers control who gets notified.

Purpose: This is Monday.com's #1 differentiator — the conversation thread inside each task. It transforms tasks from static work items into collaborative workspaces.
Output: Rich task detail panel with conversation threads, activity log, file attachments, subscribers, and dependency management.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-project-management/21-05-SUMMARY.md
@apps/frontend/src/components/projects/TaskDetailPanel.tsx
@apps/frontend/src/hooks/use-project-detail.ts
@apps/frontend/src/types/project.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build MentionInput and TaskUpdateThread components</name>
  <files>
    apps/frontend/src/components/projects/MentionInput.tsx
    apps/frontend/src/components/projects/TaskUpdateThread.tsx
  </files>
  <action>
**MentionInput.tsx** — Rich text input with @mention autocomplete:

This is the core collaboration input used throughout the task detail panel.

- Uses a contentEditable div (or textarea with overlay) for input
- When user types `@`, show a floating autocomplete popover:
  - Fetches project members from `useProjectMembers(projectId)` hook
  - Filters as user types after `@` (debounced 150ms)
  - Shows user avatar, name, and role in dropdown
  - Arrow keys to navigate, Enter to select, Escape to close
  - Selected mention inserts as a styled span: `<span data-mention-id="userId" class="mention">@Name</span>`
- Supports basic formatting: bold (**text**), italic (_text_), bullet lists
- Submit button (or Ctrl+Enter) to post
- Props: `onSubmit(content: string, mentionedUserIds: string[])`, `placeholder`, `autoFocus`
- Extract mentionedUserIds from the content's data-mention-id attributes before submission
- Keyboard accessible: Tab to reach submit, proper ARIA labels

**TaskUpdateThread.tsx** — Threaded conversation for task updates:

Monday.com's "Updates Section" equivalent. Shows chronological conversation per task.

- Fetches updates via `useTaskUpdates(taskId)` hook (GET /projects/:projectId/tasks/:taskId/updates)
- Each update displays:
  - Author avatar and name
  - Timestamp (relative: "2 hours ago", absolute on hover)
  - Rich text content with rendered @mentions (highlighted with user name)
  - Reactions row: thumbs-up emoji button with count (simplified from Monday.com's full emoji picker)
  - "Reply" button to expand threaded replies
  - If author is current user: three-dot menu with Edit and Delete options
  - If pinned: pin icon indicator at top
- Threaded replies:
  - Each update can have replies (nested one level only)
  - "Reply" button expands a MentionInput below the update
  - Replies are indented with a left border line
  - Reply count shown: "3 replies" with expand/collapse toggle
- New update: MentionInput at the top of the thread (above updates, like Monday.com)
- On submit: `useCreateTaskUpdate(taskId)` mutation (POST /projects/:projectId/tasks/:taskId/updates)
  - Body: `{ content, mentionedUserIds, parentUpdateId? }`
- Loading state: skeleton cards while fetching
- Empty state: "No updates yet. Start the conversation!" with illustration
- Scroll behavior: newest updates at top (reverse chronological)
  </action>
  <verify>
  `cd apps/frontend && npx tsc --noEmit` passes.
  MentionInput shows autocomplete on @ typing.
  TaskUpdateThread renders updates with replies.
  </verify>
  <done>MentionInput with @mention autocomplete and keyboard navigation. TaskUpdateThread with threaded replies, reactions, edit/delete, and pin indicators.</done>
  </task>

<task type="auto">
  <name>Task 2: Build TaskActivityLog, TaskFileList, TaskSubscriberList, TaskDependencyList and enhance TaskDetailPanel</name>
  <files>
    apps/frontend/src/components/projects/TaskActivityLog.tsx
    apps/frontend/src/components/projects/TaskFileList.tsx
    apps/frontend/src/components/projects/TaskSubscriberList.tsx
    apps/frontend/src/components/projects/TaskDependencyList.tsx
    apps/frontend/src/components/projects/TaskDetailPanel.tsx
  </files>
  <action>
**TaskActivityLog.tsx** — Chronological activity feed:

Monday.com's "Activity Log" — every field change tracked with who/when.

- Fetches via `useTaskActivity(taskId)` hook (GET /projects/:projectId/tasks/:taskId/activity)
- Each activity entry shows:
  - User avatar and name (who made the change)
  - Timestamp (relative)
  - Description of change in natural language:
    - "changed status from Not Started to In Progress"
    - "changed priority from Medium to High"
    - "assigned to Sarah Chen"
    - "set due date to Mar 15, 2026"
    - "added a file: Q1-report.pdf"
    - "mentioned you in an update"
    - "moved to group Evidence Collection"
  - Icon for activity type (status change, assignment, comment, file, etc.)
- Filter bar at top: "All", "Updates", "Status Changes", "Assignments", "Files" toggle buttons
- Infinite scroll or "Load more" for older entries
- Empty state: "No activity yet"

**TaskFileList.tsx** — File attachments management:

- Fetches via `useTaskFiles(taskId)` hook (GET /projects/:projectId/tasks/:taskId/files)
- Upload area: drag-and-drop zone + "Upload" button
  - Uses `useUploadTaskFile(taskId)` mutation (POST /projects/:projectId/tasks/:taskId/files)
  - Shows upload progress bar during upload
  - Accepted types: images, PDFs, documents, spreadsheets (configurable)
  - Max size: 25MB (show error if exceeded)
- File list displays:
  - File icon (based on type: image preview thumbnail, PDF icon, doc icon, etc.)
  - File name (truncated with tooltip for long names)
  - File size (formatted: "2.4 MB")
  - Uploaded by (avatar + name)
  - Upload date (relative)
  - Actions: Download button, Delete button (with confirmation)
- Download uses signed URL from `useDownloadTaskFile(taskId, fileId)`
- Delete uses `useDeleteTaskFile(taskId, fileId)` mutation
- Grid or list view toggle
- Empty state: drag-and-drop illustration with "Drop files here or click to upload"

**TaskSubscriberList.tsx** — Watchers/subscribers management:

Monday.com's subscriber system — controls who gets notified about task changes.

- Fetches via `useTaskSubscribers(taskId)` hook (GET /projects/:projectId/tasks/:taskId/subscribers)
- Shows list of subscribed users:
  - Avatar, name, role
  - "Auto" badge if auto-subscribed (assignee or creator)
  - Remove button (X icon) for manual subscribers
- "Add subscriber" button opens a user search popover (same pattern as assignee picker)
  - Uses `useSubscribeToTask(taskId)` mutation (POST /projects/:projectId/tasks/:taskId/subscribers)
- Self-subscribe toggle: "Watch this task" toggle button
  - Current user can toggle their own subscription
- Subscriber count shown in header: "5 watching"
- Compact mode: just show avatar stack with "+3" overflow and expand on click

**TaskDependencyList.tsx** — Task dependency management:

- Fetches via `useTaskDependencies(taskId)` hook (GET /projects/:projectId/tasks/:taskId/dependencies)
- Two sections:
  - "Depends on" (prerequisites): Tasks that must complete before this one
  - "Blocking" (dependents): Tasks that are waiting on this one
- Each dependency shows:
  - Task title (clickable — navigates to that task in detail panel)
  - Task status badge (colored)
  - Dependency type label (Finish-to-Start, Start-to-Start, etc.)
  - Violation indicator: red warning if dependency is violated (e.g., this task started before prerequisite finished)
  - Remove button (X icon) with confirmation
- "Add dependency" button:
  - Opens a task search popover that lists other tasks in the project
  - Select task, then select dependency type from dropdown
  - Uses `useCreateTaskDependency(taskId)` mutation
- Empty state: "No dependencies" with description of what dependencies do

**Enhance TaskDetailPanel.tsx** — Upgrade from Plan 04's basic panel to full 4-tab experience:

The basic panel from Plan 04 had title, description, status, priority, assignee, dates, and subtasks. Now restructure into tabs:

- **Tab bar** at top of panel: Details | Updates | Activity | Files
  - Use shadcn/ui Tabs component
  - Show unread indicator dot on Updates tab if new updates since last viewed
  - Show file count badge on Files tab

- **Details tab** (enhanced from Plan 04):
  - All existing fields from Plan 04 (title, description, status, priority, assignee, dates, group, subtasks)
  - ADD: TaskSubscriberList component below the fields
  - ADD: TaskDependencyList component below subscribers
  - ADD: Custom fields section (renders from customFields JSON, read-only for now — Plan 07 enables configuration)
  - ADD: Created by / Created at / Last updated metadata at bottom

- **Updates tab**:
  - Renders TaskUpdateThread component
  - Full conversation thread with @mention input

- **Activity tab**:
  - Renders TaskActivityLog component
  - Filterable activity feed

- **Files tab**:
  - Renders TaskFileList component
  - Upload and manage file attachments

- Panel header:
  - Task title (editable on click)
  - Close button (X)
  - Task ID display (e.g., "#42")
  - Three-dot menu: Delete task, Copy link, Move to group
  - Subscriber count indicator (eye icon with count)

- Panel width: ~480px (wider than Plan 04's basic panel to accommodate conversation thread)
- Keyboard: Escape to close, Tab to navigate between fields
  </action>
  <verify>
  `cd apps/frontend && npx tsc --noEmit` passes.
  TaskDetailPanel shows 4 tabs: Details, Updates, Activity, Files.
  Each tab renders its component with data.
  Subscribers and dependencies visible on Details tab.
  </verify>
  <done>TaskDetailPanel enhanced with 4 tabs. Updates tab has threaded conversation with @mentions. Activity tab has filterable change log. Files tab has drag-drop upload. Details tab has subscribers and dependencies.</done>
  </task>

</tasks>

<verification>
- `npx tsc --noEmit` passes from apps/frontend
- TaskDetailPanel opens with 4 working tabs
- Updates tab shows conversation thread with @mention autocomplete
- Activity tab shows change history
- Files tab supports upload/download/delete
- Subscribers list shows watchers with add/remove
- Dependencies list shows both directions with violation indicators
</verification>

<success_criteria>

- Monday.com-style conversation thread inside each task
- @mention input with user autocomplete and notification creation
- Threaded replies on updates (one level deep)
- Activity log tracking every field change
- File attachments with drag-and-drop upload
- Subscriber management for notification control
- Task dependency viewing and management
- All components use existing React Query hooks from use-project-detail.ts
  </success_criteria>

<output>
After completion, create `.planning/phases/21-project-management/21-06-SUMMARY.md`
</output>
