---
phase: 09-campaigns-disclosures
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/disclosures/conflict-detection.service.ts
  - apps/backend/src/modules/disclosures/dto/conflict.dto.ts
autonomous: true

must_haves:
  truths:
    - "Conflicts detected across disclosure history, vendor data, and HRIS"
    - "Fuzzy matching identifies similar entity names with confidence scores"
    - "Conflict alerts include full context for review"
  artifacts:
    - path: "apps/backend/prisma/schema.prisma"
      provides: "ConflictAlert model"
      contains: "model ConflictAlert"
    - path: "apps/backend/src/modules/disclosures/conflict-detection.service.ts"
      provides: "Cross-system conflict detection"
      exports: ["ConflictDetectionService"]
    - path: "apps/backend/src/modules/disclosures/dto/conflict.dto.ts"
      provides: "Conflict DTOs with context"
      exports: ["ConflictAlertDto", "ConflictCheckResult"]
  key_links:
    - from: "apps/backend/src/modules/disclosures/conflict-detection.service.ts"
      to: "prisma.conflictAlert"
      via: "database query"
      pattern: "prisma\\.conflictAlert"
---

<objective>
Create the conflict detection service for cross-system matching per RS.41-RS.45 - detecting conflicts across disclosure history, vendor master, HRIS, and case history.

Purpose: Automatically flag potential conflicts when employees submit disclosures by comparing against known relationships across multiple data sources. This is the 09-A4 work item from the spec.

Output:
- ConflictAlert and ConflictExclusion models in Prisma
- ConflictDetectionService with multi-source detection
- Fuzzy matching algorithms for entity name similarity
- Dismissal workflow with exclusion list management
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ConflictAlert and ConflictExclusion models to Prisma schema</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add conflict alert and exclusion models for conflict detection per RS.41-RS.44. Include ConflictType enum with all 7 types (VENDOR_MATCH, APPROVAL_AUTHORITY, PRIOR_CASE_HISTORY, HRIS_MATCH, GIFT_AGGREGATE, RELATIONSHIP_PATTERN, SELF_DEALING), ConflictSeverity (LOW, MEDIUM, HIGH, CRITICAL), ConflictStatus (OPEN, DISMISSED, ESCALATED, RESOLVED), and ExclusionScope (PERMANENT, TIME_LIMITED, ONE_TIME). ConflictAlert stores matchDetails as JSON for full context bundle. ConflictExclusion has unique constraint on (organizationId, personId, matchedEntity, conflictType) to prevent duplicate exclusions.
  </action>
  <verify>cd apps/backend && npx prisma validate</verify>
  <done>Prisma schema validates with ConflictAlert and ConflictExclusion models with all required enums and relations.</done>
</task>

<task type="auto">
  <name>Task 2: Create conflict DTOs with full context structures</name>
  <files>apps/backend/src/modules/disclosures/dto/conflict.dto.ts</files>
  <action>
Create DTOs for conflict detection including ConflictAlertDto, ConflictCheckResult, DismissConflictDto with DismissalCategory enum (FALSE_MATCH_DIFFERENT_ENTITY, FALSE_MATCH_NAME_COLLISION, ALREADY_REVIEWED, PRE_APPROVED_EXCEPTION, BELOW_THRESHOLD, OTHER), MatchDetails interface with vendorContext, employeeContext, disclosureContext, and caseContext, EntityTimelineDto and EntityTimelineItem for RS.45 entity timeline, and ConflictQueryDto for filtering.
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>Conflict DTOs compile with full context structures for all RS.41-RS.45 requirements.</done>
</task>

<task type="auto">
  <name>Task 3: Create ConflictDetectionService with fuzzy matching</name>
  <files>apps/backend/src/modules/disclosures/conflict-detection.service.ts</files>
  <action>
Implement ConflictDetectionService with: detectConflicts() main method that checks all sources, checkSelfDealing() for prior disclosures with same entity, checkHrisMatch() for disclosed person matching employee, checkPriorCases() for entity appearing in case history, checkRelationshipPatterns() for multiple employees with same entity, calculateSimilarity() using Levenshtein distance with configurable thresholds (60%, 75%, 90%, 100%), dismissConflict() with optional exclusion creation, getEntityTimeline() for RS.45 entity history view, exclusion filtering to suppress previously dismissed false positives. Emit conflict.detected event when conflicts found.
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>ConflictDetectionService compiles with multi-source detection, fuzzy matching, dismissal workflow, and entity timeline.</done>
</task>

</tasks>

<verification>
1. Run `cd apps/backend && npx prisma validate` - schema valid
2. Run `cd apps/backend && npx tsc --noEmit` - no TypeScript errors
3. Verify ConflictAlert model has all 7 conflict types
4. Verify fuzzy matching thresholds configurable
5. Verify dismissal creates exclusion when requested
</verification>

<success_criteria>
1. Prisma schema validates with ConflictAlert and ConflictExclusion
2. TypeScript compiles with no errors
3. Fuzzy matching uses Levenshtein distance
4. Dismissal categories match RS.43 spec
5. Entity timeline aggregates disclosure and conflict history
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-04-SUMMARY.md`
</output>
