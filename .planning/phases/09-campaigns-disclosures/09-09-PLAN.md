---
phase: 09-campaigns-disclosures
plan: 09
type: execute
wave: 2
depends_on: ["09-08"]
files_modified:
  - apps/backend/src/modules/campaigns/campaign-reminder.service.ts
  - apps/backend/src/modules/campaigns/campaign-reminder.processor.ts
  - apps/backend/prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "Reminder sequence is configurable per campaign"
    - "Manager CC activates on configurable day"
    - "Repeat non-responders flagged automatically"
  artifacts:
    - path: "apps/backend/src/modules/campaigns/campaign-reminder.service.ts"
      provides: "Configurable reminder sequences"
      exports: ["CampaignReminderService"]
    - path: "apps/backend/src/modules/campaigns/campaign-reminder.processor.ts"
      provides: "BullMQ processor for reminders"
      exports: ["CampaignReminderProcessor"]
  key_links:
    - from: "apps/backend/src/modules/campaigns/campaign-reminder.service.ts"
      to: "apps/backend/src/modules/notifications/notification.service.ts"
      via: "service injection"
      pattern: "constructor.*NotificationService"
---

<objective>
Create the reminder sequence engine with configurable schedules, manager CC logic, and repeat non-responder detection per RS.51.

Purpose: Ensure employees complete their disclosure campaigns through progressive reminders with escalation to managers, while tracking patterns of non-compliance. This is the 09-B3 work item from the spec.

Output:
- CampaignReminderService for reminder configuration and tracking
- BullMQ processor for sending reminders on schedule
- Employee compliance profile for non-responder tracking
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-08-SUMMARY.md

# Existing notification service
@apps/backend/src/modules/notifications/notification.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reminder and compliance profile models</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add models for reminder tracking:

Add to Campaign model:
- reminderConfig: Json  // ReminderSequence[]
  // Example: [{ day: 5, ccManager: false }, { day: 10, ccManager: true }, { day: 13, ccManager: true, ccHR: true }]

Add to CampaignAssignment:
- remindersSent: Int @default(0)
- lastReminderAt: DateTime?
- managerNotifiedAt: DateTime?

EmployeeComplianceProfile:
- id, organizationId, personId (unique per org+person)
- campaignsAssigned: Int @default(0)
- campaignsCompleted: Int @default(0)
- campaignsMissedDeadline: Int @default(0)
- averageResponseDays: Float?
- isRepeatNonResponder: Boolean @default(false)
- lastCampaignCompletedAt: DateTime?
- lastUpdatedAt: DateTime

ReminderLog:
- id, organizationId
- campaignAssignmentId
- reminderNumber: Int
- sentAt: DateTime
- ccManager: Boolean
- ccHR: Boolean
- notificationId: String? (link to notification record)
  </action>
  <verify>cd apps/backend && npx prisma validate</verify>
  <done>Prisma schema validates with reminder tracking and EmployeeComplianceProfile.</done>
</task>

<task type="auto">
  <name>Task 2: Create CampaignReminderService</name>
  <files>apps/backend/src/modules/campaigns/campaign-reminder.service.ts</files>
  <action>
Create reminder service:

1. processReminders(campaignId): Process all pending reminders for campaign
   - Get overdue assignments
   - Determine which reminder to send based on days overdue
   - Check if already sent this reminder
   - Send via NotificationService
   - Log reminder sent

2. shouldSendReminder(assignment, reminderConfig): { send: boolean, reminderIndex: number, ccManager: boolean }
   - Calculate days since deadline
   - Match to configured reminder days
   - Check if already sent

3. isRepeatNonResponder(personId, organizationId): boolean
   - Check EmployeeComplianceProfile
   - Threshold: 2+ late in 12 months

4. updateComplianceProfile(personId, organizationId, completed: boolean, responseTime?: number)
   - Increment counters
   - Update averages
   - Set isRepeatNonResponder flag

5. getRepeatNonResponders(organizationId): List flagged employees
   - For compliance review dashboard

6. configureReminders(campaignId, config): Set reminder sequence
   - Validate config structure
   - Store on campaign

Smart escalation: If isRepeatNonResponder, CC manager on FIRST reminder
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>CampaignReminderService compiles with reminder processing, compliance profiles, and repeat non-responder detection.</done>
</task>

<task type="auto">
  <name>Task 3: Create BullMQ reminder processor</name>
  <files>apps/backend/src/modules/campaigns/campaign-reminder.processor.ts</files>
  <action>
Create processor for reminder scheduling:

@Processor('campaign-reminders')
export class CampaignReminderProcessor {
  @Process('send-reminders')
  async handleCampaignReminders(job: Job<{ campaignId: string }>)

  @Process('check-overdue')
  async handleOverdueCheck(job: Job<{ organizationId: string }>)
}

handleCampaignReminders:
- Call reminderService.processReminders(campaignId)
- Reschedule for next day if campaign still active

handleOverdueCheck:
- Run daily via cron
- Find all active campaigns
- Queue reminder processing for each

Cron job setup:
- @Cron('0 9 * * *') // 9 AM daily
- Queue overdue check for all organizations
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>CampaignReminderProcessor compiles with daily cron scheduling.</done>
</task>

</tasks>

<verification>
1. Prisma schema validates
2. TypeScript compiles without errors
3. Reminders sent on configured days
4. Manager CC on day 10 (configurable)
5. Repeat non-responder flagged after 2+ late
</verification>

<success_criteria>
1. Reminder sequence configurable: [day 5, day 10 + manager, day 13 + HR]
2. EmployeeComplianceProfile tracks response patterns
3. Repeat non-responders get manager CC on first reminder
4. Daily cron processes all active campaigns
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-09-SUMMARY.md`
</output>
