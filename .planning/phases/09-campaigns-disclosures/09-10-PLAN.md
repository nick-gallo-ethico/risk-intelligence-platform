---
phase: 09-campaigns-disclosures
plan: 10
type: execute
wave: 2
depends_on: ["09-02"]
files_modified:
  - apps/backend/src/modules/campaigns/campaign-translation.service.ts
  - apps/backend/src/modules/campaigns/dto/campaign-translation.dto.ts
autonomous: true

must_haves:
  truths:
    - "Campaigns have parent-child translation model"
    - "Stale translations flagged when parent updated"
    - "Employees receive campaign in preferred language"
  artifacts:
    - path: "apps/backend/src/modules/campaigns/campaign-translation.service.ts"
      provides: "Campaign translation management"
      exports: ["CampaignTranslationService"]
    - path: "apps/backend/src/modules/campaigns/dto/campaign-translation.dto.ts"
      provides: "Translation DTOs"
      exports: ["CreateTranslationDto", "TranslationStatusDto"]
  key_links:
    - from: "apps/backend/src/modules/campaigns/campaign-translation.service.ts"
      to: "prisma.campaign"
      via: "database query"
      pattern: "prisma\\.campaign"
---

<objective>
Create the campaign translation service with parent-child linking, stale detection, and language preference routing per RS.52.

Purpose: Enable campaigns to be translated to multiple languages while maintaining version tracking and alerting when translations become stale. This is the 09-B4 work item from the spec.

Output:
- CampaignTranslationService for translation management
- Stale detection logic
- Language routing for employee delivery
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create translation DTOs</name>
  <files>apps/backend/src/modules/campaigns/dto/campaign-translation.dto.ts</files>
  <action>
Create DTOs for campaign translations:

CreateCampaignTranslationDto:
- sourceCampaignId: string (parent)
- targetLanguage: string (ISO code)
- name: string (translated name)
- description?: string (translated description)
- formTemplateId?: string (link to translated form)

TranslationStatusDto:
- id, language
- basedOnVersion: number (parent version)
- currentParentVersion: number
- isStale: boolean
- staleFields?: string[] (which fields changed in parent)

CampaignWithTranslationsDto:
- ...CampaignResponseDto
- translations: TranslationStatusDto[]
- availableLanguages: string[]

LanguagePreferenceDto:
- personId
- preferredLanguage: string
- fallbackLanguage: string (org default)
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>Translation DTOs compile with stale detection fields.</done>
</task>

<task type="auto">
  <name>Task 2: Create CampaignTranslationService</name>
  <files>apps/backend/src/modules/campaigns/campaign-translation.service.ts</files>
  <action>
Create translation service:

1. createTranslation(dto, organizationId, userId): Create child translation
   - Copy parent campaign
   - Set parentCampaignId
   - Set language
   - Record parentVersionAtCreation

2. getTranslationStatus(campaignId): TranslationStatusDto[]
   - Get all translations for parent
   - Compare each translation's basedOnVersion to parent's current version
   - Calculate isStale flag
   - Identify changed fields (name, description, deadline, form)

3. markAsUpdated(translationId, userId): Clear stale flag
   - Update basedOnVersion to match current parent
   - Used after manual review

4. getAvailableLanguages(campaignId): string[]
   - Return languages that have translations

5. getCampaignForEmployee(campaignId, personId): Campaign
   - Get employee's preferred language from HRIS
   - Find translation in that language
   - Fall back to org default language
   - Fall back to parent (English)

6. getStaleTranslations(organizationId): List campaigns with stale translations
   - For compliance dashboard
   - Group by campaign, show affected languages

Track: parentVersionAtCreation on each translation
When parent updated, translations automatically become stale
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>CampaignTranslationService compiles with translation CRUD, stale detection, and language routing.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Translation links to parent via parentCampaignId
3. Stale flag set when parent version > translation.basedOnVersion
4. Employee gets campaign in preferred language
</verification>

<success_criteria>
1. createTranslation copies parent and links
2. Stale detection accurate when parent updated
3. getCampaignForEmployee returns correct language version
4. Dashboard shows stale translation count
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-10-SUMMARY.md`
</output>
