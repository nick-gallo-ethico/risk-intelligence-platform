---
phase: 09-campaigns-disclosures
plan: 11
type: execute
wave: 3
depends_on: ["09-05", "09-06"]
files_modified:
  - apps/backend/src/modules/disclosures/ai-triage.service.ts
  - apps/backend/src/modules/ai/skills/triage.skill.ts
autonomous: true

must_haves:
  truths:
    - "Natural language queries interpreted to filters"
    - "Bulk action preview shows table before execution"
    - "Actions require explicit confirmation"
  artifacts:
    - path: "apps/backend/src/modules/disclosures/ai-triage.service.ts"
      provides: "AI-assisted bulk triage"
      exports: ["AiTriageService"]
    - path: "apps/backend/src/modules/ai/skills/triage.skill.ts"
      provides: "Triage skill for AI agent"
      exports: ["TriageSkill"]
  key_links:
    - from: "apps/backend/src/modules/disclosures/ai-triage.service.ts"
      to: "apps/backend/src/modules/ai/ai-service.ts"
      via: "service injection"
      pattern: "constructor.*AiService"
---

<objective>
Create the AI triage service for natural language bulk processing per RS.47 - interpret queries, preview results as table, require confirmation before execution.

Purpose: Enable compliance officers to process large volumes of disclosures efficiently using natural language commands like "Approve all under $100 where manager approved". This is the 09-C1 work item from the spec.

Output:
- AiTriageService for NL interpretation and bulk actions
- TriageSkill for AI agent integration
- Preview and execute endpoints
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md

# AI infrastructure from Phase 5
@apps/backend/src/modules/ai/skills/base.skill.ts
@apps/backend/src/modules/ai/ai-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AiTriageService</name>
  <files>apps/backend/src/modules/disclosures/ai-triage.service.ts</files>
  <action>
Create AI triage service for bulk disclosure processing:

1. interpretQuery(query: string, organizationId): TriageInterpretation
   - Use Claude to parse natural language into structured filter
   - Return: { filters: ConflictQueryDto | DisclosureQueryDto, action: 'approve' | 'dismiss' | 'escalate', confidence: number }
   - Prompt: "Parse this compliance triage request into structured filters..."

2. previewAction(interpretation, organizationId): TriagePreview
   - Execute query with filters
   - Return table of matching items (limit 100 for preview)
   - Include: count, sample items, estimated impact
   - NO ACTION TAKEN - read only

3. executeAction(previewId, confirmation: boolean, organizationId, userId): TriageResult
   - Require confirmation = true
   - Process all matching items
   - Return: { processed: number, succeeded: number, failed: number, errors: [] }
   - Log to audit: "AI-assisted bulk action: {count} items {action}"

4. cancelPreview(previewId): void
   - Clear preview cache
   - No action taken

Preview caching:
- Store preview results in Redis with 5-minute TTL
- Preview ID required for execute
- Prevents stale execution

Safeguards per RS.47:
- Table always shown first (preview)
- Explicit confirmation with count
- 5-minute undo window (via AiAction table)
- Full audit trail
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>AiTriageService compiles with NL interpretation, preview, and guarded execution.</done>
</task>

<task type="auto">
  <name>Task 2: Create TriageSkill for AI agent</name>
  <files>apps/backend/src/modules/ai/skills/triage.skill.ts</files>
  <action>
Create triage skill following existing skill pattern:

```typescript
export class TriageSkill extends BaseSkill {
  name = 'triage';
  description = 'Bulk process disclosures or conflicts using natural language queries';

  inputSchema = z.object({
    query: z.string().describe('Natural language query like "approve all under $100"'),
    entityType: z.enum(['disclosure', 'conflict']).describe('What to triage'),
  });

  async execute(input, context): Promise<SkillResult> {
    // 1. Interpret query
    const interpretation = await this.triageService.interpretQuery(input.query, context.organizationId);

    // 2. Generate preview
    const preview = await this.triageService.previewAction(interpretation, context.organizationId);

    // 3. Return table for confirmation (DO NOT EXECUTE)
    return {
      status: 'pending_confirmation',
      preview: {
        query: input.query,
        interpretation: interpretation,
        matchCount: preview.count,
        sampleItems: preview.items.slice(0, 10),
        previewId: preview.id,
      },
      message: `Found ${preview.count} items matching "${input.query}". Review the table and confirm to proceed.`,
    };
  }
}
```

Register skill in SkillsRegistry.
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>TriageSkill compiles and follows existing skill pattern with preview-first flow.</done>
</task>

<task type="auto">
  <name>Task 3: Create triage controller endpoints</name>
  <files>apps/backend/src/modules/disclosures/triage.controller.ts</files>
  <action>
Create REST endpoints per spec API section:

POST /api/v1/triage/interpret
- Body: { query: string, entityType: 'disclosure' | 'conflict' }
- Returns: TriageInterpretation

POST /api/v1/triage/preview
- Body: { interpretation: TriageInterpretation }
- Returns: TriagePreview with previewId

POST /api/v1/triage/execute
- Body: { previewId: string, confirm: boolean }
- Requires confirm: true
- Returns: TriageResult

DELETE /api/v1/triage/preview/:previewId
- Cancel preview, clear cache

Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER only
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>TriageController compiles with all endpoints for AI bulk processing.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. NL query "approve all under $100" parses to correct filter
3. Preview returns matching items without executing
4. Execute requires explicit confirm: true
5. Audit log records AI-assisted bulk action
</verification>

<success_criteria>
1. Natural language parsed to structured filters
2. Preview table shows items before action
3. Execution blocked without confirmation
4. Full audit trail with AI attribution
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-11-SUMMARY.md`
</output>
