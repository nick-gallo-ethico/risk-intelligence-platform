---
phase: 09-campaigns-disclosures
plan: 12
type: execute
wave: 3
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/tables/user-table.service.ts
  - apps/backend/src/modules/tables/user-table.controller.ts
  - apps/backend/src/modules/tables/tables.module.ts
autonomous: true

must_haves:
  truths:
    - "Users can create and save custom data tables"
    - "Tables can be pinned to dashboards"
    - "Tables can be scheduled for email delivery"
  artifacts:
    - path: "apps/backend/src/modules/tables/user-table.service.ts"
      provides: "User-created table management"
      exports: ["UserTableService"]
    - path: "apps/backend/src/modules/tables/user-table.controller.ts"
      provides: "Table REST endpoints"
      exports: ["UserTableController"]
  key_links:
    - from: "apps/backend/src/modules/tables/user-table.service.ts"
      to: "prisma.userDataTable"
      via: "database query"
      pattern: "prisma\\.userDataTable"
---

<objective>
Create the user-created tables feature per RS.48 - dual-path table creation (manual builder + AI-generated) with save destinations and scheduled delivery.

Purpose: Enable users to create custom data views and reports, either through a manual builder or via AI-generated queries, and save them to dashboards or schedule for email delivery. This is the 09-C2 work item from the spec.

Output:
- UserDataTable model in Prisma
- UserTableService for table CRUD and execution
- REST endpoints for table management
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-RESEARCH.md

# Reporting infrastructure from Phase 1
@apps/backend/src/modules/reports/report.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add UserDataTable model to Prisma</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add model for user-created tables:

UserDataTable:
- id, organizationId
- createdById, createdBy relation
- name: String
- description?: String

# Creation method
- createdVia: TableCreationMethod (BUILDER, AI_GENERATED, IMPORT)
- aiPrompt?: String (if AI-generated, original prompt)

# Table definition
- dataSources: String[] (entity types to query)
- columns: Json (TableColumn[])
- filters: Json (FilterCriteria[])
- groupBy: String[]?
- aggregates: Json? (AggregateDefinition[])
- sortBy: Json? ({ field: string, direction: 'asc' | 'desc' }[])

# Destinations
- destinations: Json (TableDestination[])
  # { type: 'dashboard' | 'view' | 'report', id?: string }

# Sharing
- visibility: TableVisibility (PRIVATE, TEAM, ORG)
- sharedWithTeams: String[]?
- sharedWithUsers: String[]?

# Scheduling
- scheduleConfig: Json? ({ frequency: 'daily' | 'weekly' | 'monthly', recipients: string[], format: 'csv' | 'excel' | 'pdf' })
- nextScheduledRun: DateTime?

- createdAt, updatedAt

enum TableCreationMethod { BUILDER, AI_GENERATED, IMPORT }
enum TableVisibility { PRIVATE, TEAM, ORG }
  </action>
  <verify>cd apps/backend && npx prisma validate</verify>
  <done>Prisma schema validates with UserDataTable model and related enums.</done>
</task>

<task type="auto">
  <name>Task 2: Create UserTableService</name>
  <files>apps/backend/src/modules/tables/user-table.service.ts</files>
  <action>
Create service for user table management:

1. create(dto, organizationId, userId): Create table definition
   - Store table config
   - If aiPrompt provided, mark as AI_GENERATED

2. update(id, dto, organizationId, userId): Update table definition

3. execute(id, organizationId): Execute table query
   - Build Prisma query from definition
   - Apply filters, groupBy, aggregates
   - Return result rows

4. refresh(id, organizationId): Re-execute and cache results

5. export(id, format, organizationId): Export to CSV/Excel/PDF
   - Use existing ReportService export infrastructure

6. schedule(id, config, organizationId): Configure scheduled delivery
   - Set scheduleConfig
   - Calculate nextScheduledRun
   - Create BullMQ repeatable job

7. share(id, visibility, shareWith, organizationId): Update sharing settings

8. clone(id, newName, organizationId, userId): Duplicate table

9. findMany(query, organizationId, userId): List tables
   - Filter by visibility (user can see PRIVATE own, TEAM if member, ORG all)

10. delete(id, organizationId, userId): Soft delete

Query execution uses existing ReportService.QueryBuilder for complex queries.
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>UserTableService compiles with full CRUD, execution, export, and scheduling.</done>
</task>

<task type="auto">
  <name>Task 3: Create UserTableController and module</name>
  <files>
apps/backend/src/modules/tables/user-table.controller.ts
apps/backend/src/modules/tables/tables.module.ts
  </files>
  <action>
Create controller per spec API section:

POST /api/v1/tables - Create table
GET /api/v1/tables - List user's tables
GET /api/v1/tables/:id - Get table definition
PUT /api/v1/tables/:id - Update table
DELETE /api/v1/tables/:id - Delete table
POST /api/v1/tables/:id/refresh - Re-execute query
POST /api/v1/tables/:id/export - Export data (query params: format)
POST /api/v1/tables/:id/schedule - Configure delivery schedule
POST /api/v1/tables/:id/share - Update sharing

Create TablesModule:
- Import from ReportsModule for QueryBuilder
- Export UserTableService
- Register in AppModule
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>UserTableController and TablesModule compile with all endpoints.</done>
</task>

</tasks>

<verification>
1. Prisma schema validates
2. TypeScript compiles without errors
3. Table definition stored correctly
4. Execute returns query results
5. Export produces correct format
6. Schedule creates repeatable job
</verification>

<success_criteria>
1. Tables created via builder or AI
2. Results refresh on demand
3. Export to CSV, Excel, PDF
4. Scheduled delivery to email
5. Sharing respects visibility rules
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-12-SUMMARY.md`
</output>
