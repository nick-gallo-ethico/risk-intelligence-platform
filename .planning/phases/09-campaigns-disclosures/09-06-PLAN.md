---
phase: 09-campaigns-disclosures
plan: 06
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03", "09-04"]
files_modified:
  - apps/backend/src/modules/disclosures/disclosure-submission.service.ts
  - apps/backend/src/modules/disclosures/dto/disclosure-submission.dto.ts
  - apps/backend/src/modules/disclosures/disclosure.controller.ts
autonomous: true

must_haves:
  truths:
    - "Disclosures can be submitted with draft save/resume"
    - "Submission triggers threshold evaluation automatically"
    - "Submission triggers conflict detection automatically"
  artifacts:
    - path: "apps/backend/src/modules/disclosures/disclosure-submission.service.ts"
      provides: "Disclosure submission with threshold and conflict checks"
      exports: ["DisclosureSubmissionService"]
    - path: "apps/backend/src/modules/disclosures/disclosure.controller.ts"
      provides: "Disclosure REST endpoints"
      exports: ["DisclosureController"]
  key_links:
    - from: "apps/backend/src/modules/disclosures/disclosure-submission.service.ts"
      to: "apps/backend/src/modules/disclosures/threshold.service.ts"
      via: "service injection"
      pattern: "constructor.*ThresholdService"
    - from: "apps/backend/src/modules/disclosures/disclosure-submission.service.ts"
      to: "apps/backend/src/modules/disclosures/conflict-detection.service.ts"
      via: "service injection"
      pattern: "constructor.*ConflictDetectionService"
---

<objective>
Create the disclosure submission service that orchestrates form validation, threshold evaluation, conflict detection, and approval workflow routing per RS.24 (drafts) and the integration of 09-A3/09-A4 services.

Purpose: Enable employees to submit disclosures with auto-save drafts, trigger automatic threshold checks that may create cases, and run conflict detection. This is the core submission flow that ties together form templates, thresholds, and conflicts.

Output:
- DisclosureSubmissionService coordinating validation, threshold, and conflict services
- DisclosureController with submission and draft endpoints
- DTOs for submission workflow
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-01-SUMMARY.md
@.planning/phases/09-campaigns-disclosures/09-03-SUMMARY.md
@.planning/phases/09-campaigns-disclosures/09-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create disclosure submission DTOs</name>
  <files>apps/backend/src/modules/disclosures/dto/disclosure-submission.dto.ts</files>
  <action>
Create DTOs for disclosure submission workflow:
- SaveDraftDto: partial form data, formTemplateId, campaignAssignmentId (optional)
- SubmitDisclosureDto: complete form data, formTemplateId, attestation acknowledgment
- DisclosureResponseDto: full disclosure with conflicts, threshold results
- DisclosureListItemDto: summary for list views
- DisclosureQueryDto: filters (status, type, personId, campaignId, hasConflicts)

Status enum: DRAFT, SUBMITTED, UNDER_REVIEW, APPROVED, REJECTED
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>Disclosure submission DTOs compile with all fields for draft/submit workflow.</done>
</task>

<task type="auto">
  <name>Task 2: Create DisclosureSubmissionService</name>
  <files>apps/backend/src/modules/disclosures/disclosure-submission.service.ts</files>
  <action>
Create submission service that orchestrates the disclosure flow:

1. saveDraft(): Store partial form data, update draft timestamp, return draft ID
   - Create RIU with status DRAFT if new
   - Update RiuDisclosureExtension with form data

2. submitDisclosure(): Complete submission flow:
   a. Validate form data against template schema (using Ajv like existing Form engine)
   b. Create/update RIU with status SUBMITTED
   c. Capture form version at submission time (RS.32)
   d. Call ThresholdService.evaluateDisclosure() - if CREATE_CASE triggered, create case
   e. Call ConflictDetectionService.detectConflicts() - store alerts
   f. If routing rules configured, create WorkflowInstance for approval
   g. Update CampaignAssignment status if linked to campaign
   h. Emit disclosure.submitted event
   i. Return submission result with conflicts and threshold results

3. getDraft(): Retrieve draft with form data
4. deleteDraft(): Remove incomplete draft
5. getDisclosure(): Get completed disclosure with conflicts
6. findMany(): List disclosures with filtering

Inject: PrismaService, ThresholdService, ConflictDetectionService, EventEmitter2, AuditService
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>DisclosureSubmissionService compiles with draft save, submit with threshold/conflict integration, and listing.</done>
</task>

<task type="auto">
  <name>Task 3: Create DisclosureController</name>
  <files>apps/backend/src/modules/disclosures/disclosure.controller.ts</files>
  <action>
Create REST controller per spec API section:
- POST /api/v1/disclosures - Submit disclosure (creates/updates from draft)
- GET /api/v1/disclosures - List disclosures with filters
- GET /api/v1/disclosures/:id - Get disclosure details
- PUT /api/v1/disclosures/:id - Update draft (not submitted)
- POST /api/v1/disclosures/:id/submit - Submit final from draft
- GET /api/v1/disclosures/:id/conflicts - Get detected conflicts for disclosure
- POST /api/v1/disclosures/:id/approve - Approve disclosure (reviewer action)
- POST /api/v1/disclosures/:id/reject - Reject disclosure with reason

Roles: Employees can create/submit their own. COMPLIANCE_OFFICER can approve/reject.
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>DisclosureController compiles with all REST endpoints for submission workflow.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Draft save/resume functional
3. Submit triggers threshold evaluation
4. Submit triggers conflict detection
5. CampaignAssignment updated when linked
</verification>

<success_criteria>
1. POST /api/v1/disclosures creates RIU with RiuDisclosureExtension
2. Threshold breach creates case automatically
3. Conflicts stored and returned in response
4. Form version captured at submission time
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-06-SUMMARY.md`
</output>
