---
phase: 09-campaigns-disclosures
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/campaigns/campaign-targeting.service.ts
  - apps/backend/src/modules/campaigns/dto/campaign-targeting.dto.ts
autonomous: true

must_haves:
  truths:
    - "Segment builder can target employees by department, location, tenure"
    - "Audience preview shows count and list before launch"
    - "HRIS attributes available for targeting criteria"
  artifacts:
    - path: "apps/backend/src/modules/campaigns/campaign-targeting.service.ts"
      provides: "Enhanced segment builder for campaigns"
      exports: ["CampaignTargetingService"]
    - path: "apps/backend/src/modules/campaigns/dto/campaign-targeting.dto.ts"
      provides: "Targeting criteria DTOs"
      exports: ["TargetingCriteriaDto", "AudiencePreviewDto"]
  key_links:
    - from: "apps/backend/src/modules/campaigns/campaign-targeting.service.ts"
      to: "apps/backend/src/modules/campaigns/segment.service.ts"
      via: "service extension"
      pattern: "extends.*SegmentService|constructor.*SegmentService"
---

<objective>
Enhance the campaign targeting service with "mom test" friendly segment builder per RS.50 - natural language-like conditions with visual preview.

Purpose: Enable compliance officers to easily target employees for disclosure campaigns using intuitive criteria without complex query building. This is the 09-B1 work item from the spec.

Output:
- CampaignTargetingService with enhanced segment builder
- DTOs for targeting criteria with simple/advanced modes
- Audience preview with count and employee list
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-campaigns-disclosures/09-CONTEXT.md
@.planning/phases/09-campaigns-disclosures/09-RESEARCH.md

# Existing segment service to extend
@apps/backend/src/modules/campaigns/segment.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enhanced targeting criteria DTOs</name>
  <files>apps/backend/src/modules/campaigns/dto/campaign-targeting.dto.ts</files>
  <action>
Create DTOs for the "mom test" friendly segment builder:

SimpleTargetingDto - checkboxes for common criteria:
- departments: string[] (department IDs to include)
- locations: string[] (location IDs to include)
- includeSubordinates: boolean (include their teams)

AdvancedTargetingDto - power user criteria:
- jobTitles: string[] (specific titles)
- managerHierarchyDepth: number (levels to include)
- tenureMinDays: number (hired before X days ago)
- tenureMaxDays: number (hired after X days ago)
- customAttributes: Record<string, unknown> (HRIS custom fields)
- previousCampaignResponses: { campaignId: string, status: string }[]
- exclusions: string[] (employee IDs to exclude)

TargetingCriteriaDto - combines both modes:
- mode: 'simple' | 'advanced' | 'all'
- simple?: SimpleTargetingDto
- advanced?: AdvancedTargetingDto

AudiencePreviewDto:
- totalCount: number
- employees: { id, name, department, location, email }[] (paginated)
- criteriaDescription: string (human-readable summary)
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>Targeting DTOs compile with simple and advanced modes per RS.50.</done>
</task>

<task type="auto">
  <name>Task 2: Create CampaignTargetingService</name>
  <files>apps/backend/src/modules/campaigns/campaign-targeting.service.ts</files>
  <action>
Create enhanced targeting service building on existing SegmentQueryBuilder:

1. previewAudience(criteria, organizationId): AudiencePreviewDto
   - Convert criteria to Prisma where clause using SegmentQueryBuilder
   - Execute count and limited select for preview
   - Build human-readable description: "Finance and Procurement at US locations, 183 people"

2. buildCriteriaDescription(criteria): string
   - Natural language summary of targeting rules
   - Examples: "Everyone in [Finance, Procurement]", "US locations only", "90+ days tenure"

3. getTargetEmployeeIds(criteria, organizationId): string[]
   - Full list for campaign launch
   - Include subordinates if requested (recursive manager query)

4. validateCriteria(criteria, organizationId): ValidationResult
   - Check departments exist
   - Check locations exist
   - Warn if criteria matches 0 employees

5. getAvailableAttributes(organizationId): TargetingAttribute[]
   - List available targeting options from HRIS
   - Include custom attributes configured for org
  </action>
  <verify>cd apps/backend && npx tsc --noEmit</verify>
  <done>CampaignTargetingService compiles with audience preview, criteria description, and HRIS attribute support.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Simple mode: department + location checkboxes work
3. Advanced mode: tenure, hierarchy depth work
4. Preview returns count and sample employees
5. Description reads naturally (mom test)
</verification>

<success_criteria>
1. previewAudience returns accurate count
2. Criteria description human-readable
3. includeSubordinates walks org hierarchy
4. Custom HRIS attributes available for targeting
</success_criteria>

<output>
After completion, create `.planning/phases/09-campaigns-disclosures/09-07-SUMMARY.md`
</output>
