---
phase: 22-dark-mode-theme
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/frontend/package.json
  - apps/frontend/src/app/layout.tsx
  - apps/frontend/src/app/providers.tsx
  - apps/frontend/src/components/ui/toaster.tsx
autonomous: true

must_haves:
  truths:
    - "next-themes package is installed and functional"
    - "ThemeProvider wraps the entire app with class strategy"
    - "html element has suppressHydrationWarning for FOIT prevention"
    - "System preference detection works (prefers-color-scheme)"
    - "Theme persists in localStorage across page refreshes"
    - "Sonner toasts respect the active theme"
  artifacts:
    - path: "apps/frontend/src/app/providers.tsx"
      provides: "ThemeProvider wrapping app"
      contains: "ThemeProvider"
    - path: "apps/frontend/src/app/layout.tsx"
      provides: "suppressHydrationWarning on html element"
      contains: "suppressHydrationWarning"
  key_links:
    - from: "providers.tsx"
      to: "next-themes"
      via: "ThemeProvider import"
      pattern: "from 'next-themes'"
    - from: "toaster.tsx"
      to: "next-themes"
      via: "useTheme hook for theme prop"
      pattern: "useTheme"
---

<objective>
Install next-themes and wire the ThemeProvider into the app's root layout and providers. This is the foundational infrastructure that enables all subsequent dark mode work.

Purpose: Without this, the `.dark` CSS variables already defined in globals.css cannot be activated. This plan makes the dark mode toggle mechanism functional.
Output: Working theme switching infrastructure with system preference detection, localStorage persistence, and FOIT prevention.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-dark-mode-theme/22-RESEARCH.md
@apps/frontend/src/app/layout.tsx
@apps/frontend/src/app/providers.tsx
@apps/frontend/src/components/ui/toaster.tsx
@apps/frontend/src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-themes and wire ThemeProvider</name>
  <files>
    apps/frontend/package.json
    apps/frontend/src/app/providers.tsx
    apps/frontend/src/app/layout.tsx
  </files>
  <action>
1. Install next-themes:
   ```bash
   cd apps/frontend && npm install next-themes
   ```

2. Update `apps/frontend/src/app/layout.tsx`:
   - Add `suppressHydrationWarning` to the `<html>` element. This is REQUIRED by next-themes to prevent hydration mismatch warnings when the theme class is injected before React hydration.
   - Do NOT add a `className` to `<html>` — next-themes manages this automatically.

   ```tsx
   <html lang="en" suppressHydrationWarning>
   ```

3. Update `apps/frontend/src/app/providers.tsx`:
   - Import `ThemeProvider` from `next-themes`
   - Wrap the existing provider tree with ThemeProvider as the OUTERMOST provider (it needs to be above everything that might use theme-dependent rendering)
   - Configure with:
     - `attribute="class"` — matches existing Tailwind `darkMode: ['class']` config
     - `defaultTheme="system"` — auto-detect OS preference as default (success criteria #4)
     - `enableSystem={true}` — enable system preference detection
     - `disableTransitionOnChange` — prevent flash of transition animation during theme switch

   ```tsx
   import { ThemeProvider } from 'next-themes';

   // Wrap existing providers:
   <ThemeProvider attribute="class" defaultTheme="system" enableSystem disableTransitionOnChange>
     <QueryClientProvider client={queryClient}>
       <AuthProvider>
         <ShortcutsProvider>
           {children}
         </ShortcutsProvider>
       </AuthProvider>
     </QueryClientProvider>
   </ThemeProvider>
   ```

   Note: next-themes handles localStorage persistence automatically (key: "theme"). No additional code needed for persistence (success criteria #3 partial).
  </action>
  <verify>
  - `cd apps/frontend && npx tsc --noEmit` should compile without errors
  - `next-themes` should appear in package.json dependencies
  - The app should start without hydration warnings: `cd apps/frontend && npm run dev`
  </verify>
  <done>next-themes installed, ThemeProvider wraps app with class strategy, html has suppressHydrationWarning, system preference detection enabled, localStorage persistence active.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Sonner toasts to respect active theme</name>
  <files>apps/frontend/src/components/ui/toaster.tsx</files>
  <action>
Update `apps/frontend/src/components/ui/toaster.tsx` to pass the current theme to Sonner's `Toaster` component.

Sonner supports a `theme` prop that accepts `'light' | 'dark' | 'system'`. Wire it from next-themes:

```tsx
'use client';

import { useTheme } from 'next-themes';
import { Toaster as Sonner } from 'sonner';

function Toaster() {
  const { theme = 'system' } = useTheme();

  return (
    <Sonner
      theme={theme as 'light' | 'dark' | 'system'}
      // ... keep all existing props (className, toastOptions, etc.)
    />
  );
}
```

Important: Keep ALL existing props on the Sonner component — only ADD the `theme` prop. Do not remove any existing configuration like `className`, `toastOptions`, etc.

If the file already has hardcoded color references in `toastOptions` or `className`, replace them with theme-aware equivalents using CSS variable classes (e.g., `bg-background text-foreground border-border`).
  </action>
  <verify>
  - `cd apps/frontend && npx tsc --noEmit` should compile without errors
  - Toast notifications should render with correct colors in both light and dark mode
  </verify>
  <done>Sonner toasts respect the active theme, rendering with appropriate light/dark styling.</done>
</task>

</tasks>

<verification>
- `cd apps/frontend && npx tsc --noEmit` passes
- `next-themes` in package.json dependencies
- ThemeProvider wraps entire app in providers.tsx
- html element has suppressHydrationWarning in layout.tsx
- Manually toggling `.dark` class on `<html>` in browser DevTools switches the color scheme
</verification>

<success_criteria>
- next-themes installed and ThemeProvider configured with class strategy
- System preference detection active (defaultTheme="system")
- localStorage persistence functional (theme key)
- No flash of wrong theme on page load (suppressHydrationWarning + next-themes script injection)
- Sonner toasts theme-aware
</success_criteria>

<output>
After completion, create `.planning/phases/22-dark-mode-theme/22-01-SUMMARY.md`
</output>
