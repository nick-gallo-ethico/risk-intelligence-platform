# Phase 14.2: Case Creation & Search Fixes

## Overview

Phase 14.2 addresses two critical gaps discovered during Phase 14.1 human verification:

1. **Missing Category/Subcategory in Case Creation** - The case creation form lacks category and subcategory dropdowns, which are required per PRDs
2. **Search Returning No Results** - Unified search returns empty despite 4,500 cases having populated search vectors

## Issue 1: Category/Subcategory Missing from Case Creation

### Problem Statement

When creating a case directly in the system (e.g., compliance officer creating a case), users cannot select a category or subcategory. Per the PRDs:

- Web form intake: employee selects category
- Hotline intake: operator selects category (confirmed/changed in QA)
- Direct case creation: compliance officer must select category AND subcategory

### Current State

- **Backend**: `CreateCaseDto` already supports `primaryCategoryId` and `secondaryCategoryId` (lines 253-267)
- **Database**: 32 categories exist with proper hierarchy (7 level-0 parents, 25+ level-1 subcategories)
- **Frontend Missing**:
  - `case-schema.ts` has no categoryId fields in Zod schema
  - `basic-info-section.tsx` has no Category/Subcategory dropdowns
  - No categories API hook exists for fetching options

### Required Changes

1. Add `primaryCategoryId` and `secondaryCategoryId` to `case-schema.ts` Zod schema
2. Create `useCategories` hook to fetch categories from API
3. Add Category dropdown (level 0 categories) to `basic-info-section.tsx`
4. Add Subcategory dropdown (filtered by selected category) to `basic-info-section.tsx`
5. Update form transformation to include category IDs in API call

### Reference Files

- `apps/backend/src/modules/cases/dto/create-case.dto.ts` (lines 253-267)
- `apps/frontend/src/lib/validations/case-schema.ts`
- `apps/frontend/src/components/cases/form-sections/basic-info-section.tsx`

### Database Context

```sql
-- Top-level categories (level 0)
SELECT id, name FROM categories WHERE module = 'CASE' AND parent_category_id IS NULL;
-- Harassment, Fraud & Financial, Conflicts of Interest, Safety & Health, Data & Privacy, Policy Violations, Request for Information

-- Subcategories (level 1) - example for Harassment
SELECT id, name FROM categories WHERE parent_category_id = 'af8c9ff3-bc83-4d7c-83a7-c823be0ab79e';
-- Sexual Harassment, Discriminatory Harassment, Bullying/Hostile Work Environment, Retaliation
```

## Issue 2: Search Returning No Results

### Problem Statement

The unified search (`/api/v1/search/unified?q=...`) returns empty results despite:

- 4,500 cases in database
- All cases having `search_vector` populated (verified via SQL)
- API returning 200 OK (not erroring)

### Current State

- Search vectors are properly populated in PostgreSQL
- API endpoint exists and responds without errors
- Frontend correctly calls the endpoint
- Results come back empty

### Investigation Needed

1. Check `SearchController` and `SearchService` query logic
2. Verify the PostgreSQL full-text search query (ts_query, ts_rank)
3. Check if there's a tenant isolation issue in the search query
4. Verify the search_vector column is being queried correctly

### Reference Files

- `apps/backend/src/modules/search/search.controller.ts`
- `apps/backend/src/modules/search/search.service.ts`
- Database schema for cases table search_vector column

## Success Criteria

1. Case creation form shows Category dropdown with all level-0 categories
2. After selecting a category, Subcategory dropdown populates with matching level-1 categories
3. Created case has correct `primaryCategoryId` and `secondaryCategoryId` set
4. Search for "harassment" returns matching cases
5. Search for case numbers (e.g., "CASE-2025") returns matching cases

## Phase 14.1 Fixes Already Applied

The following were fixed in Phase 14.1 (commit `33043f8`):

- Notifications page: 96 notifications now display (was 400 error)
- My Work page: 70 tasks now display (was 400 error)
- Audit Log page: 35,094 entries now display (was 400 error)

Root cause: Frontend was using `page` parameter but backend DTOs expect `offset`.
