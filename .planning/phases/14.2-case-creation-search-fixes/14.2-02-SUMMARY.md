---
phase: 14.2-case-creation-search-fixes
plan: 02
subsystem: search
tags:
  - postgresql-fts
  - elasticsearch-fallback
  - unified-search
  - cases
dependency-graph:
  requires:
    - 06-10 # Original unified search implementation
    - 13.1-01 # search_vector population in case seeder
  provides:
    - PostgreSQL FTS fallback for unified search
    - Search works without Elasticsearch running
  affects:
    - Frontend search page shows results
    - Demo environment works out of the box
tech-stack:
  added: []
  patterns:
    - PostgreSQL full-text search fallback
    - Graceful ES degradation
key-files:
  created: []
  modified:
    - apps/backend/src/modules/search/unified-search.service.ts
decisions:
  - id: 14.2-02-01
    description: Use prefix matching (word:*) in FTS for partial word searches
    rationale: "harass" should match "harassment" for better UX
  - id: 14.2-02-02
    description: Try FTS fallback on both ES index-not-found and ES 0-results
    rationale: Covers both missing index and empty index scenarios
metrics:
  duration: 8 min
  completed: 2026-02-10
---

# Phase 14.2 Plan 02: PostgreSQL FTS Fallback for Unified Search Summary

**One-liner:** Added PostgreSQL full-text search fallback to unified search so cases are searchable even when Elasticsearch indices don't exist.

## What Was Built

### PostgreSQL FTS Fallback Method

Added `searchCasesWithFts()` method to `UnifiedSearchService`:

```typescript
private async searchCasesWithFts(
  ctx: PermissionContext,
  query: string,
  limit: number,
): Promise<EntityTypeResult> {
  // Build tsquery with prefix matching for partial words
  const tsQuery = searchWords.map((word) => `${word}:*`).join(' & ');

  const results = await this.prisma.$queryRawUnsafe<...>(
    `SELECT id, reference_number, details, summary, status, severity, created_at,
            ts_rank(search_vector, to_tsquery('english', $1)) as score
     FROM cases
     WHERE organization_id = $2
       AND search_vector @@ to_tsquery('english', $1)
     ORDER BY score DESC, created_at DESC
     LIMIT $3`,
    tsQuery,
    ctx.organizationId,
    limit,
  );
  // ...
}
```

### Fallback Triggers

The FTS fallback is used in two scenarios:

1. **ES index not found** - When Elasticsearch throws a 404 for the index
2. **ES returns 0 results** - When ES search succeeds but finds nothing for cases

### Key Design Decisions

| Decision                   | Rationale                                                  |
| -------------------------- | ---------------------------------------------------------- |
| Prefix matching (`word:*`) | Allows partial word searches like "harass" -> "harassment" |
| snake_case in raw SQL      | Per decision 14.1-04, use @@map table names                |
| Fallback only for cases    | Cases have populated search_vector; other entities may not |
| Try FTS on any ES error    | More resilient - search works even if ES is unhealthy      |

## Files Modified

| File                                                        | Changes                                                                                          |
| ----------------------------------------------------------- | ------------------------------------------------------------------------------------------------ |
| `apps/backend/src/modules/search/unified-search.service.ts` | Added PrismaService injection, searchCasesWithFts() method, fallback logic in searchEntityType() |

## Testing

### Verification Criteria

1. Search for "harassment" returns cases containing that word
2. Search for "CASE-2025" returns cases with matching reference numbers
3. Search works without requiring Elasticsearch to be running
4. No errors in backend logs when ES indices don't exist

### How to Test

```bash
# Start backend
cd apps/backend && npm run start:dev

# Search for content (with valid auth token)
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3001/api/v1/search/unified?q=harassment"

# Search for case number
curl -H "Authorization: Bearer $TOKEN" "http://localhost:3001/api/v1/search/unified?q=CASE-2025"
```

## Deviations from Plan

None - plan executed exactly as written.

## Commits

| Hash    | Message                                                       |
| ------- | ------------------------------------------------------------- |
| c5038c5 | feat(14.2-02): add PostgreSQL FTS fallback for unified search |

## Next Phase Readiness

**Dependencies satisfied:**

- Unified search now returns results from PostgreSQL when ES unavailable
- Demo environment search will work out of the box

**No blockers identified.**
