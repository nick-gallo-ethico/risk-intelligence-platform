---
phase: 14.2
plan: 01
subsystem: case-creation
tags: [frontend, backend, categories, form]
dependency-graph:
  requires: [14.1]
  provides: [categories-endpoint, category-dropdowns]
  affects: [case-creation, disclosure-forms]
tech-stack:
  added: []
  patterns: [hierarchical-categories, authenticated-api]
key-files:
  created:
    - apps/backend/src/modules/organization/categories.controller.ts
  modified:
    - apps/backend/src/modules/organization/organization.module.ts
    - apps/backend/src/modules/organization/index.ts
    - apps/frontend/src/lib/validations/case-schema.ts
    - apps/frontend/src/components/cases/form-sections/basic-info-section.tsx
    - apps/frontend/src/hooks/useTenantCategories.ts
decisions:
  - id: 14.2-01-D1
    title: Categories controller in organization module
    choice: Place CategoriesController in organization module
    rationale: Categories are organization-scoped, reuses existing module structure
metrics:
  duration: 13m
  completed: 2026-02-10
---

# Phase 14.2 Plan 01: Category Dropdowns for Case Creation Summary

**One-liner:** Added GET /api/v1/categories endpoint and Category/Subcategory dropdowns to case creation form

## What Was Built

1. **Backend Categories Endpoint** (`categories.controller.ts`)
   - GET /api/v1/categories returns all active categories for the authenticated user's organization
   - Supports optional `module` query parameter to filter by module type (CASE, DISCLOSURE, etc.)
   - Orders categories by level ASC, sortOrder ASC, name ASC
   - Maps `parentCategoryId` to `parentId` for frontend compatibility
   - Properly guarded with JwtAuthGuard and TenantGuard for tenant isolation

2. **Frontend Category Fields**
   - Added `primaryCategoryId` and `secondaryCategoryId` to case creation Zod schema
   - Added default empty string values for category fields

3. **Category Dropdowns in BasicInfoSection**
   - Primary Category dropdown shows level-0 CASE module categories
   - Subcategory dropdown appears when a primary category is selected AND has children
   - Subcategory resets when primary category changes
   - Loading state shown while categories fetch

4. **Category Type Update**
   - Extended `Category` interface with `level` and `module` optional fields

## Technical Details

### Backend Endpoint

```typescript
GET /api/v1/categories
GET /api/v1/categories?module=CASE

Response: {
  categories: [
    {
      id: "uuid",
      name: "Harassment",
      description: "...",
      icon: null,
      parentId: null,
      level: 0,
      sortOrder: 0,
      isEnabled: true,
      module: "CASE"
    },
    // ... children with parentId pointing to parent
  ]
}
```

### Frontend Integration

- `useAuthenticatedCategories` hook already existed, now has working endpoint
- Categories filtered to `module === 'CASE' && isEnabled`
- Top-level categories: `level === 0`
- Subcategories: `parentId === primaryCategoryId`

## Files Changed

| File                       | Change Type | Description                                            |
| -------------------------- | ----------- | ------------------------------------------------------ |
| `categories.controller.ts` | Created     | New controller for categories API                      |
| `organization.module.ts`   | Modified    | Added CategoriesController to controllers array        |
| `organization/index.ts`    | Modified    | Export new controller                                  |
| `case-schema.ts`           | Modified    | Added primaryCategoryId and secondaryCategoryId fields |
| `basic-info-section.tsx`   | Modified    | Added Category and Subcategory dropdowns               |
| `useTenantCategories.ts`   | Modified    | Added level and module to Category type                |

## Commits

| Hash    | Message                                                                     |
| ------- | --------------------------------------------------------------------------- |
| c5038c5 | feat(14.2-02): add PostgreSQL FTS fallback (included categories controller) |
| 9cde4bc | feat(14.2-01): add category dropdowns to case creation form                 |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Extended Category type**

- **Found during:** Task 2
- **Issue:** Category type in useTenantCategories.ts was missing `level` and `module` fields needed for filtering
- **Fix:** Added optional `level` and `module` fields to Category interface
- **Files modified:** apps/frontend/src/hooks/useTenantCategories.ts
- **Commit:** 9cde4bc

## Verification Results

1. Backend TypeScript compilation: PASSED
2. Frontend TypeScript compilation: PASSED
3. Pre-commit hooks (lint, typecheck, security): PASSED

## Next Steps

1. Run backend and verify categories endpoint returns expected data
2. Start frontend and test case creation form:
   - Verify Category dropdown shows 7 level-0 categories
   - Select category and verify subcategories appear
   - Create case with category and verify it saves to database
3. Continue to 14.2-02 for search fixes (if not already done)
