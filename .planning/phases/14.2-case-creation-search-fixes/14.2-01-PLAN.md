---
phase: 14.2-case-creation-search-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/organization/categories.controller.ts
  - apps/backend/src/modules/organization/organization.module.ts
  - apps/frontend/src/lib/validations/case-schema.ts
  - apps/frontend/src/components/cases/form-sections/basic-info-section.tsx
autonomous: true

must_haves:
  truths:
    - "Case creation form shows Category dropdown with all level-0 categories"
    - "Subcategory dropdown populates based on selected parent category"
    - "Created cases have correct primaryCategoryId and secondaryCategoryId"
  artifacts:
    - path: "apps/backend/src/modules/organization/categories.controller.ts"
      provides: "GET /api/v1/categories endpoint for authenticated users"
      exports: ["CategoriesController"]
    - path: "apps/frontend/src/lib/validations/case-schema.ts"
      provides: "Zod schema with category fields"
      contains: "primaryCategoryId"
    - path: "apps/frontend/src/components/cases/form-sections/basic-info-section.tsx"
      provides: "Category and Subcategory dropdowns"
      contains: "useAuthenticatedCategories"
  key_links:
    - from: "apps/frontend/src/hooks/useAuthenticatedCategories.ts"
      to: "/api/v1/categories"
      via: "apiClient.get('/categories')"
      pattern: "apiClient\\.get.*categories"
    - from: "apps/frontend/src/components/cases/form-sections/basic-info-section.tsx"
      to: "apps/frontend/src/lib/validations/case-schema.ts"
      via: "setValue('primaryCategoryId')"
      pattern: "setValue.*primaryCategoryId"
---

<objective>
Add Category and Subcategory dropdowns to the case creation form.

Purpose: Compliance officers creating cases directly need to classify them by category. The backend already supports this (CreateCaseDto has primaryCategoryId/secondaryCategoryId), but the frontend form is missing the dropdowns. An authenticated categories endpoint is also missing.

Output: Working category selection in case creation that persists to the database.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14.2-case-creation-search-fixes/14.2-RESEARCH.md
@apps/backend/src/modules/organization/organization.controller.ts
@apps/frontend/src/hooks/useAuthenticatedCategories.ts
@apps/frontend/src/lib/validations/case-schema.ts
@apps/frontend/src/components/cases/form-sections/basic-info-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Categories Controller</name>
  <files>
    apps/backend/src/modules/organization/categories.controller.ts
    apps/backend/src/modules/organization/organization.module.ts
  </files>
  <action>
Create a new `CategoriesController` in the organization module to expose categories for authenticated users.

**File: categories.controller.ts**
Create controller with:

- Route: `@Controller('categories')`
- Guard: `JwtAuthGuard, TenantGuard`
- Single endpoint: `GET /` returning all categories for the tenant

```typescript
@Get()
@ApiOperation({ summary: 'Get all categories for the tenant' })
async getCategories(
  @TenantId() organizationId: string,
  @Query('module') module?: string,
): Promise<{ categories: Category[] }>
```

Query logic:

- Filter by `organizationId` (tenant isolation)
- Filter by `isActive: true` (only enabled categories)
- Optional `module` filter (e.g., 'CASE', 'DISCLOSURE')
- Order by `level ASC, sortOrder ASC`

**File: organization.module.ts**

- Add `CategoriesController` to the `controllers` array
- Ensure PrismaService is available (already should be)

Use existing patterns from `organization.controller.ts` for guards, decorators, and API documentation.

**IMPORTANT:** The existing `useAuthenticatedCategories` hook calls `/api/v1/categories` - ensure the route matches (the /api/v1 prefix is added by main.ts).
</action>
<verify>
Run the backend and test with curl:

```bash
curl -H "Authorization: Bearer $TOKEN" http://localhost:3001/api/v1/categories
```

Should return JSON with `categories` array containing level-0 and level-1 categories.
</verify>
<done>
GET /api/v1/categories returns all active categories for the authenticated user's organization, ordered by level and sortOrder.
</done>
</task>

<task type="auto">
  <name>Task 2: Add Category Fields to Case Schema and Form</name>
  <files>
    apps/frontend/src/lib/validations/case-schema.ts
    apps/frontend/src/components/cases/form-sections/basic-info-section.tsx
  </files>
  <action>
**File: case-schema.ts**
Add category fields to the Zod schema:
```typescript
// In caseCreationSchema, after severity field:
primaryCategoryId: z.string().uuid('Invalid category ID').optional().or(z.literal('')),
secondaryCategoryId: z.string().uuid('Invalid subcategory ID').optional().or(z.literal('')),
```

Update `defaultCaseFormValues`:

```typescript
primaryCategoryId: '',
secondaryCategoryId: '',
```

**File: basic-info-section.tsx**

1. Import the `useAuthenticatedCategories` hook
2. Call the hook at the top of the component:
   ```typescript
   const { flatCategories, isLoading: categoriesLoading } =
     useAuthenticatedCategories();
   ```
3. Get current values:
   ```typescript
   const primaryCategoryId = watch("primaryCategoryId");
   const secondaryCategoryId = watch("secondaryCategoryId");
   ```
4. Filter for CASE module categories only:
   ```typescript
   const caseCategories = flatCategories.filter(
     (c) => c.module === "CASE" && c.isEnabled,
   );
   const topLevelCategories = caseCategories.filter((c) => c.level === 0);
   const subcategories = caseCategories.filter(
     (c) => c.parentId === primaryCategoryId,
   );
   ```
5. Add new row after the existing grid (source/type/severity):

   ```tsx
   <div className="grid gap-4 md:grid-cols-2">
     {/* Primary Category */}
     <div className="space-y-2">
       <Label htmlFor="primaryCategoryId">Category</Label>
       <Select
         value={primaryCategoryId || undefined}
         onValueChange={(value) => {
           setValue("primaryCategoryId", value);
           setValue("secondaryCategoryId", ""); // Reset subcategory when category changes
         }}
         disabled={categoriesLoading}
       >
         <SelectTrigger id="primaryCategoryId">
           <SelectValue
             placeholder={
               categoriesLoading ? "Loading..." : "Select category..."
             }
           />
         </SelectTrigger>
         <SelectContent>
           {topLevelCategories.map((category) => (
             <SelectItem key={category.id} value={category.id}>
               {category.name}
             </SelectItem>
           ))}
         </SelectContent>
       </Select>
     </div>

     {/* Subcategory - only show if primary category selected and has subcategories */}
     {primaryCategoryId && subcategories.length > 0 && (
       <div className="space-y-2">
         <Label htmlFor="secondaryCategoryId">Subcategory</Label>
         <Select
           value={secondaryCategoryId || undefined}
           onValueChange={(value) => setValue("secondaryCategoryId", value)}
         >
           <SelectTrigger id="secondaryCategoryId">
             <SelectValue placeholder="Select subcategory..." />
           </SelectTrigger>
           <SelectContent>
             {subcategories.map((category) => (
               <SelectItem key={category.id} value={category.id}>
                 {category.name}
               </SelectItem>
             ))}
           </SelectContent>
         </Select>
       </div>
     )}
   </div>
   ```

**Note on Category type:** The `useAuthenticatedCategories` hook returns categories with `parentId` field (not `parentCategoryId`). Check the actual type definition and adjust accordingly.
</action>
<verify>

1. Run TypeScript check: `cd apps/frontend && npm run typecheck`
2. Start frontend and navigate to case creation form
3. Verify Category dropdown appears with 7 level-0 categories
4. Select "Harassment" and verify subcategories appear (Sexual Harassment, Discriminatory Harassment, etc.)
5. Create a case with category selected and verify it saves to database
   </verify>
   <done>
   Case creation form displays Category dropdown with level-0 categories. When a category is selected, Subcategory dropdown appears with its children. Form submission includes primaryCategoryId and secondaryCategoryId in API call.
   </done>
   </task>

</tasks>

<verification>
1. Backend endpoint test:
   - GET /api/v1/categories returns categories with proper tenant isolation
   - Categories include both level-0 parents and level-1 children
   - Response includes id, name, level, parentId, module, isEnabled, sortOrder

2. Frontend integration test:
   - Category dropdown loads and displays 7 parent categories
   - Selecting a category populates subcategory dropdown
   - Changing category resets subcategory selection
   - Form submission includes category IDs

3. End-to-end test:
   - Create a new case with category "Harassment" and subcategory "Sexual Harassment"
   - Verify in database that case has correct primaryCategoryId and secondaryCategoryId
     </verification>

<success_criteria>

1. GET /api/v1/categories endpoint exists and returns categories
2. Case creation form shows Category dropdown with all level-0 CASE categories
3. Subcategory dropdown appears after selecting a category
4. Created cases have correct primaryCategoryId and secondaryCategoryId in database
   </success_criteria>

<output>
After completion, create `.planning/phases/14.2-case-creation-search-fixes/14.2-01-SUMMARY.md`
</output>
