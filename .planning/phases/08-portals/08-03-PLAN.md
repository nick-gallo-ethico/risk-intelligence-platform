---
phase: 08-portals
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/portals/operator/client-profile.service.ts
  - apps/backend/src/modules/portals/operator/client-profile.controller.ts
  - apps/backend/src/modules/portals/operator/dto/client-profile.dto.ts
autonomous: true

must_haves:
  truths:
    - "Operators can look up clients by phone number"
    - "Client profile includes hotline configuration and QA settings"
    - "Multiple hotline numbers can map to one client"
    - "Client profile loads with associated category templates"
  artifacts:
    - path: "apps/backend/src/modules/portals/operator/client-profile.service.ts"
      provides: "ClientProfileService with phone lookup and profile loading"
      exports: ["ClientProfileService"]
    - path: "apps/backend/prisma/schema.prisma"
      provides: "HotlineNumber and ClientQaConfig models"
      contains: "model HotlineNumber"
  key_links:
    - from: "ClientProfileService"
      to: "HotlineNumber"
      via: "Prisma query"
      pattern: "prisma\\.hotlineNumber\\.findFirst"
    - from: "ClientProfileService"
      to: "Organization"
      via: "Prisma include"
      pattern: "include.*organization"
---

<objective>
Create the client profile service that enables operators to identify clients by incoming phone number and load their full configuration including QA settings and category templates.

Purpose: Operators need instant client identification when calls come in to load correct scripts and settings.
Output: ClientProfileService with phone lookup, profile loading, and QA configuration.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HotlineNumber and ClientQaConfig models</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add HotlineNumber model:
- id: String @id @default(uuid())
- organizationId: String (FK to Organization)
- phoneNumber: String (E.164 format, e.g., "+18005551234")
- displayName: String? (e.g., "Main Hotline", "After Hours")
- isActive: Boolean @default(true)
- createdAt: DateTime @default(now())
- organization: Organization relation
- @@unique([phoneNumber]) -- phone numbers globally unique
- @@index([organizationId])

Add ClientQaConfig model:
- id: String @id @default(uuid())
- organizationId: String @unique (FK to Organization)
- defaultMode: QaMode enum (ALL, RISK_BASED, SAMPLE, NONE)
- samplePercentage: Int? (for SAMPLE mode, 1-100)
- highRiskCategories: String[] (category IDs that always go to QA)
- keywordTriggers: String[] (words that trigger QA regardless of mode)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- organization: Organization relation

Add QaMode enum:
- ALL: 100% QA review
- RISK_BASED: High-risk categories only
- SAMPLE: Random percentage
- NONE: No QA required

Add categoryOverrides Json field to ClientQaConfig for per-category QA mode overrides.

Add relations to Organization:
- hotlineNumbers: HotlineNumber[]
- qaConfig: ClientQaConfig?
  </action>
  <verify>npx prisma format && npx prisma validate</verify>
  <done>HotlineNumber and ClientQaConfig models exist with proper enums</done>
</task>

<task type="auto">
  <name>Task 2: Create ClientProfileService with phone lookup</name>
  <files>
    apps/backend/src/modules/portals/operator/client-profile.service.ts
    apps/backend/src/modules/portals/operator/dto/client-profile.dto.ts
    apps/backend/src/modules/portals/operator/types/client-profile.types.ts
  </files>
  <action>
Create ClientProfileService with methods:
1. findByPhoneNumber(phoneNumber: string): Promise<ClientProfile | null>
   - Normalize phone number to E.164 format
   - Query HotlineNumber to find associated organization
   - Return full ClientProfile or null if not found

2. getClientProfile(organizationId: string): Promise<ClientProfile>
   - Load organization with includes:
     - qaConfig
     - hotlineNumbers
     - categories (active only, for intake form)
     - branding (for operator console theming)
   - Throw NotFoundException if organization not found

3. requiresQaReview(organizationId: string, categoryId: string, content: string): boolean
   - Check QA mode (ALL = always true, NONE = always false)
   - For RISK_BASED: Check if categoryId in highRiskCategories
   - For SAMPLE: Return random based on samplePercentage
   - Check keywordTriggers in content for any mode except NONE
   - Check categoryOverrides for per-category mode

4. normalizePhoneNumber(phone: string): string
   - Strip non-numeric characters except leading +
   - Add +1 if 10 digits without country code
   - Validate E.164 format

Create types:
- ClientProfile interface: id, name, slug, hotlineNumbers, qaConfig, categories, branding
- QaCheckResult interface: requiresQa, reason (mode, keyword, category)

Create DTOs:
- CreateHotlineNumberDto: phoneNumber, displayName
- UpdateQaConfigDto: defaultMode, samplePercentage, highRiskCategories, keywordTriggers
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>ClientProfileService compiles with phone lookup and QA check methods</done>
</task>

<task type="auto">
  <name>Task 3: Create ClientProfileController with operator endpoints</name>
  <files>
    apps/backend/src/modules/portals/operator/client-profile.controller.ts
    apps/backend/src/modules/portals/operator/operator-portal.module.ts
  </files>
  <action>
Create ClientProfileController with endpoints:
1. GET /api/v1/operator/lookup/phone/:phoneNumber
   - Requires OPERATOR role
   - Returns ClientProfile or 404 if not found
   - Phone number in path, URL-encoded if needed

2. GET /api/v1/operator/clients/:clientId/profile
   - Requires OPERATOR role
   - Returns full ClientProfile for given organization ID

3. GET /api/v1/operator/clients
   - Requires OPERATOR role
   - Returns paginated list of all client organizations (for manual lookup)
   - Query params: search, page, limit

4. POST /api/v1/admin/clients/:clientId/hotline-numbers
   - Requires SYSTEM_ADMIN role
   - Adds hotline number to client

5. DELETE /api/v1/admin/clients/:clientId/hotline-numbers/:numberId
   - Requires SYSTEM_ADMIN role
   - Removes hotline number

6. PUT /api/v1/admin/clients/:clientId/qa-config
   - Requires SYSTEM_ADMIN role
   - Updates QA configuration for client

Update OperatorPortalModule:
- Add ClientProfileService provider
- Add ClientProfileController
- Export ClientProfileService
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>ClientProfileController has all endpoints, module updated</done>
</task>

</tasks>

<verification>
1. Run `npx prisma migrate dev --name add-hotline-qa-config` to create migration
2. Run `npm run build -- --filter=backend` to verify compilation
3. Test phone number normalization with various formats
4. Verify QA check logic with different modes
</verification>

<success_criteria>
- HotlineNumber model maps phone numbers to organizations
- ClientQaConfig stores per-client QA review settings
- Phone lookup normalizes and finds clients
- QA review check considers mode, categories, and keywords
- Operator endpoints require OPERATOR role
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-03-SUMMARY.md`
</output>
