---
phase: 08-portals
plan: 06
type: execute
wave: 2
depends_on: ["08-04"]
files_modified:
  - apps/backend/src/modules/portals/employee/employee-history.service.ts
  - apps/backend/src/modules/portals/employee/employee-portal.controller.ts
  - apps/backend/src/modules/portals/employee/manager-proxy.service.ts
  - apps/backend/src/modules/portals/employee/dto/employee-views.dto.ts
autonomous: true

must_haves:
  truths:
    - "Employees can view their submitted reports with status"
    - "Employees can view their disclosure history"
    - "Employees can view pending and completed attestations"
    - "Managers can submit proxy reports on behalf of team members"
  artifacts:
    - path: "apps/backend/src/modules/portals/employee/employee-history.service.ts"
      provides: "EmployeeHistoryService for my reports/disclosures/attestations"
      exports: ["EmployeeHistoryService"]
    - path: "apps/backend/src/modules/portals/employee/manager-proxy.service.ts"
      provides: "ManagerProxyService for proxy reporting"
      exports: ["ManagerProxyService"]
  key_links:
    - from: "EmployeeHistoryService"
      to: "RiskIntelligenceUnit"
      via: "Prisma query"
      pattern: "prisma\\.riskIntelligenceUnit\\.findMany"
    - from: "ManagerProxyService"
      to: "PersonManager"
      via: "Prisma query"
      pattern: "prisma\\.personManager\\.findFirst"
---

<objective>
Create the Employee Portal history views and manager proxy reporting - enabling employees to see their compliance history and managers to submit reports on behalf of their team.

Purpose: Employees need visibility into their compliance activities; managers need to facilitate reporting for their teams.
Output: EmployeeHistoryService for history views and ManagerProxyService for proxy reporting.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/04-core-entities/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EmployeeHistoryService for my views</name>
  <files>
    apps/backend/src/modules/portals/employee/employee-history.service.ts
    apps/backend/src/modules/portals/employee/types/employee-history.types.ts
  </files>
  <action>
Create EmployeeHistoryService with methods:

1. getMyReports(personId: string, organizationId: string, options?: PaginationOptions): Promise<PaginatedResult<ReportSummary>>
   - Find RIUs where reporter Person matches personId
   - Include: referenceNumber, category, status, submittedAt, case status (if linked)
   - Exclude internal details (investigator notes, etc.)
   - Order by submittedAt DESC

2. getMyDisclosures(personId: string, organizationId: string, options?: PaginationOptions): Promise<PaginatedResult<DisclosureSummary>>
   - Find CampaignAssignments where person matches and campaign type is DISCLOSURE
   - Include: disclosureType, campaign name, submittedAt, status, next review date
   - Order by submittedAt DESC

3. getMyAttestations(personId: string, organizationId: string, options?: PaginationOptions): Promise<PaginatedResult<AttestationSummary>>
   - Find CampaignAssignments where person matches and campaign type is ATTESTATION
   - Split into pending vs completed
   - Include: policy name, dueDate, completedAt, campaign name

4. getComplianceOverview(personId: string, organizationId: string): Promise<ComplianceOverview>
   - Return summary counts:
     - totalReports, pendingReports
     - totalDisclosures, upcomingReviewDates
     - totalAttestations, pendingAttestations
   - Calculate compliance score (% attestations complete, % disclosures up to date)

Create types:
- ReportSummary: id, referenceNumber, category, status, submittedAt, caseStatus?
- DisclosureSummary: id, type, campaignName, status, submittedAt, nextReviewDate?
- AttestationSummary: id, policyName, campaignName, dueDate, completedAt?, status
- ComplianceOverview: counts + complianceScore

Note: personId comes from authenticated user's Person record (linked via User.personId or lookup by employeeId).
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>EmployeeHistoryService compiles with all my views methods</done>
</task>

<task type="auto">
  <name>Task 2: Create ManagerProxyService for proxy reporting</name>
  <files>
    apps/backend/src/modules/portals/employee/manager-proxy.service.ts
    apps/backend/src/modules/portals/employee/dto/proxy-report.dto.ts
  </files>
  <action>
Create ManagerProxyService with methods:

1. getTeamMembers(managerId: string, organizationId: string): Promise<TeamMember[]>
   - Query PersonManager where managerId matches
   - Return direct reports with: id, name, email, jobTitle, department
   - Include nested reports if manager has hierarchy access

2. canProxyFor(managerId: string, employeeId: string, organizationId: string): Promise<boolean>
   - Check if manager has proxy permission for employee
   - Verify direct or transitive reporting relationship via PersonManager
   - Return true if valid relationship exists

3. submitProxyReport(managerId: string, dto: ProxyReportDto): Promise<ProxySubmissionResult>
   - Validate canProxyFor
   - Create RIU with:
     - Reporter: employee's Person record
     - ProxySubmitter: manager's Person record
     - isProxySubmission: true
     - proxyReason: dto.reason
   - Generate access code (give to employee, not manager)
   - Emit proxy_report.submitted event
   - Audit log the proxy action

4. getProxySubmissions(managerId: string, organizationId: string): Promise<ProxySubmission[]>
   - Return list of reports manager has submitted on behalf of others
   - Include: reportId, employeeName, submittedAt, status

Create DTOs:
- ProxyReportDto: employeeId, categoryId, content, reason (why proxy), urgencyFlag?
- Reason enum: REQUESTED_BY_EMPLOYEE, LANGUAGE_BARRIER, TECHNICAL_DIFFICULTY, OTHER

Create types:
- TeamMember: id, name, email, jobTitle, department
- ProxySubmissionResult: accessCode, reportId, referenceNumber, employeeName
- ProxySubmission: reportId, employeeName, submittedAt, status, reason

Security:
- Manager must have active manager relationship
- Proxy reason is required and audited
- Access code goes to employee (not manager) per CONTEXT.md
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>ManagerProxyService compiles with proxy validation and submission</done>
</task>

<task type="auto">
  <name>Task 3: Add Employee Portal history and proxy endpoints</name>
  <files>
    apps/backend/src/modules/portals/employee/employee-portal.controller.ts
    apps/backend/src/modules/portals/employee/employee-portal.module.ts
  </files>
  <action>
Add endpoints to EmployeePortalController:

History endpoints (authenticated user's own data):
1. GET /api/v1/employee/reports
   - Returns paginated ReportSummary[]
   - Query: page, limit, status

2. GET /api/v1/employee/disclosures
   - Returns paginated DisclosureSummary[]
   - Query: page, limit, type

3. GET /api/v1/employee/attestations
   - Returns paginated AttestationSummary[]
   - Query: page, limit, status (pending/completed)

4. GET /api/v1/employee/overview
   - Returns ComplianceOverview with counts and score

Manager proxy endpoints (requires manager role):
5. GET /api/v1/employee/team
   - Requires user is a manager
   - Returns TeamMember[]

6. POST /api/v1/employee/proxy-report
   - Requires user is a manager
   - Body: ProxyReportDto
   - Returns ProxySubmissionResult

7. GET /api/v1/employee/proxy-submissions
   - Requires user is a manager
   - Returns ProxySubmission[] submitted by this manager

Update EmployeePortalModule:
- Add EmployeeHistoryService provider
- Add ManagerProxyService provider
- Import PersonModule (for manager relationship)

Add custom @IsManager() guard or check in controller.
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>EmployeePortalController has all 7 additional endpoints</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=backend` to verify compilation
2. Verify history endpoints return only authenticated user's data
3. Verify proxy endpoints check manager relationship
4. Verify proxy reason is required and logged
</verification>

<success_criteria>
- My Reports shows employee's submitted RIUs with status
- My Disclosures shows disclosure campaign assignments
- My Attestations shows pending and completed attestations
- Manager proxy requires valid reporting relationship
- Proxy submissions are audited with reason
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-06-SUMMARY.md`
</output>
