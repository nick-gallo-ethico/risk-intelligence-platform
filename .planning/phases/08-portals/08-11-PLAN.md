---
phase: 08-portals
plan: 11
type: execute
wave: 4
depends_on: ["08-08"]
files_modified:
  - apps/frontend/src/app/ethics/[tenant]/status/page.tsx
  - apps/frontend/src/components/ethics/access-code-input.tsx
  - apps/frontend/src/components/ethics/status-view.tsx
  - apps/frontend/src/components/ethics/message-thread.tsx
  - apps/frontend/src/components/ethics/message-composer.tsx
autonomous: true

must_haves:
  truths:
    - "Reporter can enter access code to check report status"
    - "Status shows current report state without internal process details"
    - "Reporter can send and receive messages through relay"
    - "New messages show notification indicator"
  artifacts:
    - path: "apps/frontend/src/app/ethics/[tenant]/status/page.tsx"
      provides: "Status check page route"
      exports: ["default"]
    - path: "apps/frontend/src/components/ethics/access-code-input.tsx"
      provides: "Segmented access code input component"
      exports: ["AccessCodeInput"]
    - path: "apps/frontend/src/components/ethics/message-thread.tsx"
      provides: "Two-way message thread display"
      exports: ["MessageThread"]
  key_links:
    - from: "status/page.tsx"
      to: "/api/v1/public/access"
      via: "fetch call"
      pattern: "fetch.*public/access"
    - from: "MessageComposer"
      to: "/api/v1/public/access/:code/messages"
      via: "POST request"
      pattern: "fetch.*messages.*POST"
    - from: "MessageThread"
      to: "MessageRelayService (Phase 6, plan 06-09)"
      via: "backend relay - messages fetched via /api/v1/public/access/:code/messages"
      pattern: "MessageRelayService\\.getMessagesForReporter"
---

<objective>
Create the Ethics Portal status check and messaging UI - enabling anonymous reporters to check their report status and communicate with investigators using their access code.

Purpose: Anonymous reporters need a way to track their report and respond to investigator questions.
Output: Status check page with access code input, status display, and message thread.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/04-core-entities/04-06-SUMMARY.md
@.planning/phases/06-case-management/06-09-SUMMARY.md (MessageRelayService for anonymous messaging)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create access code input and status lookup</name>
  <files>
    apps/frontend/src/components/ethics/access-code-input.tsx
    apps/frontend/src/hooks/useReportStatus.ts
    apps/frontend/src/types/ethics-portal.types.ts
  </files>
  <action>
Create src/types/ethics-portal.types.ts:
- ReportStatus interface: referenceNumber, status, statusLabel, statusDescription, canMessage, hasUnreadMessages, lastUpdated
- Status enum: RECEIVED, UNDER_REVIEW, ADDITIONAL_INFO_NEEDED, CLOSED
- Message interface: id, direction ('inbound' | 'outbound'), content, createdAt, readAt?, attachments?
- AccessCodeValidation interface: isValid, lockoutUntil?, attemptsRemaining?

Create src/components/ethics/access-code-input.tsx per RESEARCH.md pattern:
- Props: onComplete, disabled, error
- Three segments of 4 characters each (total 12)
- Auto-advance to next segment on fill
- Backspace moves to previous segment
- Uppercase only, alphanumeric
- Visual feedback: segment border color on focus
- Error state: red border, shake animation
- Paste support: handle full code paste and distribute
- Mobile-friendly: large inputs, numeric keyboard hint

Create src/hooks/useReportStatus.ts:
- useReportStatus() hook
- State: status, messages, isLoading, error, isLocked, lockoutRemaining
- Methods:
  - checkStatus(accessCode: string): Fetch from /api/v1/public/access/:code/status
  - Handle 429 rate limit: set isLocked, calculate lockout time
  - Handle 404: show "invalid code" error
- Auto-refresh status every 60 seconds when page visible
- Return: { status, messages, checkStatus, isLoading, error, isLocked, lockoutRemaining }
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Access code input with validation and status hook created</done>
</task>

<task type="auto">
  <name>Task 2: Create status view and message thread components</name>
  <files>
    apps/frontend/src/components/ethics/status-view.tsx
    apps/frontend/src/components/ethics/message-thread.tsx
    apps/frontend/src/components/ethics/status-badge.tsx
  </files>
  <action>
Create src/components/ethics/status-badge.tsx:
- Props: status (enum)
- Colored badge for each status:
  - RECEIVED: blue
  - UNDER_REVIEW: amber
  - ADDITIONAL_INFO_NEEDED: orange with pulse
  - CLOSED: gray
- Status label text

Create src/components/ethics/status-view.tsx:
- Props: reportStatus (ReportStatus)
- Minimal view per CONTEXT.md: "just current status and message thread"
- Reference number display
- StatusBadge for current status
- Status description (1-2 sentences explaining what this means)
- Last updated timestamp
- "You have new messages" indicator if hasUnreadMessages
- No internal process visibility (no stage, no investigator name, no timeline)

Create src/components/ethics/message-thread.tsx:
- Props: messages, hasUnreadMessages, onMarkRead
- Chronological message list (oldest first, newest at bottom)
- Message bubbles:
  - Inbound (from investigator): left-aligned, neutral color
  - Outbound (from reporter): right-aligned, primary color
- Each message shows: content, timestamp, read receipt (for outbound)
- Structured questions from investigator shown with form-like styling
- Unread messages highlighted with indicator
- Auto-scroll to newest message on load
- Mark messages as read on view (emit onMarkRead)

Message styling:
- Rich text support (markdown rendering)
- Attachment previews (thumbnail, download link)
- "New" badge on unread messages
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Status view and message thread components created</done>
</task>

<task type="auto">
  <name>Task 3: Create message composer and status page route</name>
  <files>
    apps/frontend/src/components/ethics/message-composer.tsx
    apps/frontend/src/app/ethics/[tenant]/status/page.tsx
    apps/frontend/src/app/ethics/[tenant]/status/[code]/page.tsx
  </files>
  <action>
Create src/components/ethics/message-composer.tsx:
- Props: onSend, disabled, placeholder
- Textarea for message content
- Attachment button (reuse AttachmentUpload component)
- Send button
- Character counter (optional max limit)
- "Sending..." state with spinner
- Success feedback (message appears in thread)
- Error handling with retry option
- Disabled state when canMessage = false (case closed)

Create src/app/ethics/[tenant]/status/page.tsx:
- Access code entry page
- TenantThemeProvider for branding
- LanguageSwitcher in header
- AccessCodeInput component
- "Check Status" button
- Rate limit warning display when locked
- Help text: "Enter the access code you received when you submitted your report"
- Link back to home page
- On valid code: redirect to /status/:code

Create src/app/ethics/[tenant]/status/[code]/page.tsx:
- Status detail page (code in URL)
- Load status via useReportStatus hook
- Render StatusView component
- Render MessageThread component
- Render MessageComposer (if canMessage = true)
- Poll for new messages every 30 seconds
- Show notification if new message arrives while viewing
- "Report a new issue" link in footer
- Handle invalid code: redirect back to entry page

Integration with Phase 6 Relay Service:
- POST /api/v1/public/access/:code/messages for sending (calls MessageRelayService.receiveFromReporter)
- GET /api/v1/public/access/:code/status for status (from 08-05 EthicsPortalController)
- GET /api/v1/public/access/:code/messages for message list (calls MessageRelayService.getMessagesForReporter)
- Note: Backend relay from Phase 6 (06-09) handles identity protection and PII detection
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Message composer and status page routes created</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=frontend` to verify compilation
2. Verify access code input handles paste and segment navigation
3. Verify status view shows minimal information (no internal details)
4. Verify message thread displays bi-directional communication
5. Verify rate limiting shows lockout message
</verification>

<success_criteria>
- Access code input is segmented with auto-advance
- Invalid codes show error, rate limiting shows lockout time
- Status view shows only: status, reference number, last updated
- Message thread shows two-way communication chronologically
- New messages are highlighted and marked read on view
- Composer disabled when case is closed
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-11-SUMMARY.md`
</output>
