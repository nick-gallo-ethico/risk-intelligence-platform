---
phase: 08-portals
plan: 08
type: execute
wave: 3
depends_on: ["08-05"]
files_modified:
  - apps/frontend/src/app/ethics/[tenant]/layout.tsx
  - apps/frontend/src/app/ethics/[tenant]/page.tsx
  - apps/frontend/src/lib/i18n.ts
  - apps/frontend/src/lib/ethics-offline-db.ts
  - apps/frontend/next.config.js
  - apps/frontend/public/manifest.json
autonomous: true

must_haves:
  truths:
    - "Ethics Portal is installable as PWA on mobile devices"
    - "Form drafts persist offline in encrypted IndexedDB"
    - "Language can be switched without losing form data"
    - "Service worker caches branding and translations"
  artifacts:
    - path: "apps/frontend/src/lib/i18n.ts"
      provides: "i18next configuration with language detection"
      exports: ["i18n", "useLanguage", "SUPPORTED_LANGUAGES"]
    - path: "apps/frontend/src/lib/ethics-offline-db.ts"
      provides: "Dexie database for encrypted offline drafts"
      exports: ["db", "useAutoSaveDraft"]
    - path: "apps/frontend/next.config.js"
      provides: "PWA configuration with @ducanh2912/next-pwa"
      contains: "withPWA"
  key_links:
    - from: "ethics/[tenant]/layout.tsx"
      to: "i18n.ts"
      via: "I18nextProvider"
      pattern: "I18nextProvider"
    - from: "useAutoSaveDraft"
      to: "db.drafts"
      via: "Dexie table"
      pattern: "db\\.drafts\\.(add|update)"
---

<objective>
Set up the Ethics Portal frontend infrastructure - PWA configuration, offline storage with Dexie, multi-language support with react-i18next, and the base layout.

Purpose: Ethics Portal needs PWA capabilities for mobile installation and offline support for privacy-conscious reporting.
Output: PWA setup, i18n configuration, offline database, and base layout component.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/08-portals/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install PWA dependencies and configure Next.js</name>
  <files>
    apps/frontend/package.json
    apps/frontend/next.config.js
    apps/frontend/public/manifest.json
    apps/frontend/src/app/~offline/page.tsx
  </files>
  <action>
Install dependencies:
```bash
cd apps/frontend && npm install @ducanh2912/next-pwa dexie dexie-encrypted react-i18next i18next i18next-browser-languagedetector i18next-http-backend
```

Update next.config.js with PWA configuration per RESEARCH.md:
- Import withPWA from @ducanh2912/next-pwa
- Configure dest: 'public', register: true, skipWaiting: true
- Set disable: process.env.NODE_ENV === 'development'
- Configure fallbacks: { document: '/~offline' }
- Add runtime caching rules for:
  - /api/branding/* (StaleWhileRevalidate, 1hr)
  - /locales/* (CacheFirst, 24hr)
  - /api/v1/public/submit (NetworkOnly with backgroundSync)
- Configure manifest options:
  - name: "Ethics Reporting Portal"
  - short_name: "Ethics Portal"
  - display: standalone
  - icons array with 192, 512, and maskable variants

Create public/manifest.json with PWA manifest.

Create src/app/~offline/page.tsx:
- Simple offline fallback page
- Message: "You're offline. Your draft has been saved locally."
- Button to retry connection
- Explain that submission will sync when back online
  </action>
  <verify>npm run build -- --filter=frontend (verify manifest.json copied to .next/static)</verify>
  <done>PWA configured with service worker, manifest, and offline page</done>
</task>

<task type="auto">
  <name>Task 2: Create i18n configuration and language utilities</name>
  <files>
    apps/frontend/src/lib/i18n.ts
    apps/frontend/src/components/ethics/language-switcher.tsx
    apps/frontend/public/locales/en/common.json
    apps/frontend/public/locales/en/report.json
    apps/frontend/public/locales/es/common.json
  </files>
  <action>
Create src/lib/i18n.ts per RESEARCH.md pattern:
- Configure i18next with HttpBackend, LanguageDetector, and initReactI18next
- Define SUPPORTED_LANGUAGES array (en, es, fr, de, pt, zh, ar, he with dir)
- Define NAMESPACES (common, report, status, resources, errors)
- Set fallbackLng: 'en'
- Configure detection: order ['localStorage', 'navigator', 'htmlTag']
- Set lookupLocalStorage: 'ethics-language'

Create useLanguage hook:
- changeLanguage function that also updates document.dir and document.lang
- currentLanguage getter from SUPPORTED_LANGUAGES

Create src/components/ethics/language-switcher.tsx:
- Select dropdown with flag icons or language names
- Calls useLanguage().changeLanguage on selection
- Persists to localStorage

Create initial translation files:
- public/locales/en/common.json: nav, buttons, accessibility labels
- public/locales/en/report.json: form labels, validation messages
- public/locales/es/common.json: Spanish translations for common

Note: RTL support (Arabic, Hebrew) requires dir="rtl" on document - handled in changeLanguage.
  </action>
  <verify>npm run build -- --filter=frontend (verify no i18n errors)</verify>
  <done>i18n configured with language detection and switching</done>
</task>

<task type="auto">
  <name>Task 3: Create Dexie offline database and auto-save hook</name>
  <files>
    apps/frontend/src/lib/ethics-offline-db.ts
    apps/frontend/src/hooks/useAutoSaveDraft.ts
  </files>
  <action>
Create src/lib/ethics-offline-db.ts per RESEARCH.md pattern:

Define EthicsPortalDB class extending Dexie:
- drafts table: ++id, localId, tenantSlug, expiresAt, syncStatus
- pendingSubmissions table: ++id, tenantSlug, createdAt

Apply encryption to:
- drafts.content and drafts.attachments
- pendingSubmissions.payload

Implement getOrCreateDeviceKey():
- Check localStorage for 'ethics-device-key'
- If not found, generate with crypto.getRandomValues(new Uint8Array(32))
- Store serialized in localStorage

Export db singleton.

Implement cleanupExpiredDrafts():
- Delete drafts where expiresAt < now
- Call on app init

Create src/hooks/useAutoSaveDraft.ts:
- useAutoSaveDraft(tenantSlug: string) hook
- debounced saveDraft function (1 second debounce)
- Checks for existing draft, updates or creates
- Returns: saveDraft, loadDraft, deleteDraft, lastSaved timestamp
- Uses useCallback for memoization

Add ReportDraft interface:
- id?: number
- localId: string (nanoid for cross-device code)
- tenantSlug: string
- category?: string
- content: Record<string, unknown>
- attachments: AttachmentRef[]
- createdAt: Date
- updatedAt: Date
- expiresAt: Date (7 days from creation)
- syncStatus: 'draft' | 'pending' | 'synced' | 'failed'
  </action>
  <verify>npm run build -- --filter=frontend (verify Dexie compiles)</verify>
  <done>Encrypted offline database with auto-save hook created</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=frontend` to verify compilation
2. Run production build and verify manifest.json in output
3. Verify service worker registers in browser dev tools
4. Test language switching updates document.dir
5. Test IndexedDB encryption in browser dev tools
</verification>

<success_criteria>
- PWA manifest and service worker are generated on build
- Offline page displays when network unavailable
- Language can be switched with persistence to localStorage
- Dexie database encrypts sensitive draft content
- Auto-save hook debounces and persists form data
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-08-SUMMARY.md`
</output>
