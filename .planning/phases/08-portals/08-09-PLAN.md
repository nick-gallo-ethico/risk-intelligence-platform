---
phase: 08-portals
plan: 09
type: execute
wave: 3
depends_on: ["08-07"]
files_modified:
  - apps/frontend/src/app/operator/layout.tsx
  - apps/frontend/src/components/operator/operator-console-layout.tsx
  - apps/frontend/src/components/operator/call-controls.tsx
  - apps/frontend/src/components/operator/context-tabs.tsx
  - apps/frontend/src/hooks/useClientProfile.ts
autonomous: true

must_haves:
  truths:
    - "Operator Console has split-screen layout with form on left and context on right"
    - "Call controls show timer, mute, hold, and transfer buttons"
    - "Context tabs switch between Script/Guide, HRIS, and History"
    - "Client profile loads on phone number lookup"
  artifacts:
    - path: "apps/frontend/src/components/operator/operator-console-layout.tsx"
      provides: "Main layout component with split-screen design"
      exports: ["OperatorConsoleLayout"]
    - path: "apps/frontend/src/components/operator/call-controls.tsx"
      provides: "Top bar with call management controls"
      exports: ["CallControls"]
    - path: "apps/frontend/src/hooks/useClientProfile.ts"
      provides: "Hook for loading and caching client profile"
      exports: ["useClientProfile"]
  key_links:
    - from: "OperatorConsoleLayout"
      to: "CallControls"
      via: "component composition"
      pattern: "<CallControls"
    - from: "useClientProfile"
      to: "/api/v1/operator/lookup/phone"
      via: "fetch call"
      pattern: "fetch.*lookup/phone"
---

<objective>
Create the Operator Console layout and base components - the HubSpot-inspired split-screen interface with call controls, context tabs, and client profile loading.

Purpose: Operators need an efficient interface for handling calls with instant access to client context.
Output: OperatorConsoleLayout with CallControls, context tabs, and client lookup hook.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/08-portals/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Operator Console layout and app structure</name>
  <files>
    apps/frontend/src/app/operator/layout.tsx
    apps/frontend/src/app/operator/page.tsx
    apps/frontend/src/components/operator/operator-console-layout.tsx
  </files>
  <action>
Create src/app/operator/layout.tsx:
- Require authentication with OPERATOR role
- Minimal layout (no sidebar - full screen for console)
- Import OperatorConsoleLayout

Create src/app/operator/page.tsx:
- Main operator console page
- Render OperatorConsoleLayout with initial state

Create src/components/operator/operator-console-layout.tsx per RESEARCH.md pattern:
- Full height flex container (h-screen flex flex-col)
- Top bar (h-14 border-b): Call controls section
- Main content (flex-1 flex overflow-hidden):
  - Left panel (w-3/5 border-r overflow-y-auto p-6): Intake form area
  - Right panel (w-2/5 overflow-hidden flex flex-col): Context tabs area

Props interface:
- clientProfile: ClientProfile | null
- callActive: boolean
- callDuration: number (seconds)
- onCallEnd: () => void
- onClientChange: (clientId: string) => void

State management:
- activeContextTab: 'script' | 'hris' | 'history'
- intakeInProgress: boolean

Children slots:
- intakeFormSlot: React.ReactNode (for IntakeForm component)
- Pass context tab via prop or render context components directly
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Operator layout with split-screen structure created</done>
</task>

<task type="auto">
  <name>Task 2: Create CallControls and context tabs components</name>
  <files>
    apps/frontend/src/components/operator/call-controls.tsx
    apps/frontend/src/components/operator/call-timer.tsx
    apps/frontend/src/components/operator/context-tabs.tsx
    apps/frontend/src/components/operator/directives-panel.tsx
    apps/frontend/src/components/operator/hris-lookup-panel.tsx
    apps/frontend/src/components/operator/caller-history-panel.tsx
  </files>
  <action>
Create src/components/operator/call-controls.tsx:
- Left section: Client name badge, hotline number badge
- Center section: Phone number input for manual lookup
- Right section (when call active):
  - CallTimer component (MM:SS format)
  - Mute button (MicOff icon)
  - Hold button (Pause icon)
  - Transfer button (ArrowRightLeft icon)
  - End Call button (red, destructive variant)

Create src/components/operator/call-timer.tsx:
- Props: duration (seconds), isActive (boolean)
- useEffect to increment timer every second when active
- Display as MM:SS format
- Visual indicator when call is on hold

Create src/components/operator/context-tabs.tsx:
- Tabs component with three options:
  - Script/Guide: DirectivesPanel
  - HRIS Lookup: HrisLookupPanel
  - History: CallerHistoryPanel
- Pass clientProfile as prop to all panels

Create src/components/operator/directives-panel.tsx:
- Render directives grouped by stage (opening, intake, closing)
- Highlight current stage based on intake progress
- Read-aloud prompts styled differently (with speaker icon)
- Expand/collapse for long scripts

Create src/components/operator/hris-lookup-panel.tsx:
- Search input for employee name/email/department
- Results list with name, title, department, manager
- Click to select as subject (emits event to intake form)
- Show org chart hierarchy on selection

Create src/components/operator/caller-history-panel.tsx:
- List of previous RIUs from same phone number
- Show: date, category, status, brief summary
- Click to view details (modal)
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>CallControls and all context tab panels created</done>
</task>

<task type="auto">
  <name>Task 3: Create useClientProfile hook with phone lookup</name>
  <files>
    apps/frontend/src/hooks/useClientProfile.ts
    apps/frontend/src/types/operator.types.ts
    apps/frontend/src/services/operator-api.ts
  </files>
  <action>
Create src/types/operator.types.ts:
- ClientProfile interface: id, name, slug, hotlineNumbers, qaConfig, categories, branding
- HotlineNumber interface: id, phoneNumber, displayName
- QaConfig interface: defaultMode, samplePercentage, highRiskCategories, keywordTriggers
- CallDirectives interface: opening, intake, categorySpecific, closing (arrays of Directive)
- Directive interface: id, title, content, isReadAloud, order

Create src/services/operator-api.ts:
- lookupByPhone(phoneNumber: string): Promise<ClientProfile | null>
- getClientProfile(clientId: string): Promise<ClientProfile>
- getDirectivesForCall(clientId: string, categoryId?: string): Promise<CallDirectives>
- searchHris(clientId: string, query: string): Promise<HrisResult[]>
- getCallerHistory(clientId: string, phoneNumber: string): Promise<CallerHistoryItem[]>

Create src/hooks/useClientProfile.ts:
- useClientProfile() hook using react-query
- State: clientProfile, isLoading, error
- Methods:
  - lookupByPhone(phone: string): Calls API, handles 404 gracefully
  - loadClient(clientId: string): Direct load by ID
  - clearClient(): Reset state
- Uses AbortController pattern to cancel stale requests (per RESEARCH.md pitfall)
- Caches result with 5-minute stale time
- Returns: { clientProfile, isLoading, lookupByPhone, loadClient, clearClient }
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>useClientProfile hook with phone lookup and abort handling created</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=frontend` to verify compilation
2. Verify split-screen layout renders correctly at different widths
3. Verify call timer increments when active
4. Test phone lookup with valid and invalid numbers
</verification>

<success_criteria>
- Split-screen layout shows form on left (60%) and context on right (40%)
- Call controls display timer and action buttons when call active
- Context tabs switch between Script, HRIS, and History
- Phone lookup loads client profile and handles not-found gracefully
- Stale lookup requests are cancelled when new lookup starts
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-09-SUMMARY.md`
</output>
