---
phase: 08-portals
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/branding/branding.service.ts
  - apps/backend/src/modules/branding/branding.controller.ts
  - apps/backend/src/modules/branding/branding.module.ts
  - apps/backend/src/modules/branding/dto/branding.dto.ts
  - apps/backend/src/app.module.ts
autonomous: true

must_haves:
  truths:
    - "Tenants can configure logo, primary color, and theme mode"
    - "Full white-label tenants can configure 12-token color palette and typography"
    - "CSS custom properties are generated from branding config"
    - "Branding config is cached with 1-hour TTL"
  artifacts:
    - path: "apps/backend/src/modules/branding/branding.service.ts"
      provides: "BrandingService with getCss(), getBranding(), update methods"
      exports: ["BrandingService"]
    - path: "apps/backend/src/modules/branding/branding.controller.ts"
      provides: "Public endpoint for CSS retrieval, admin endpoints for config"
      exports: ["BrandingController"]
    - path: "apps/backend/prisma/schema.prisma"
      provides: "TenantBranding model"
      contains: "model TenantBranding"
  key_links:
    - from: "BrandingService"
      to: "Redis cache"
      via: "CacheManager"
      pattern: "cacheManager\\.get|set"
    - from: "BrandingController"
      to: "BrandingService"
      via: "dependency injection"
      pattern: "constructor.*BrandingService"
---

<objective>
Create the white-label branding service that stores per-tenant configuration and generates CSS custom properties for theme customization.

Purpose: Enable each tenant's Ethics Portal to have unique branding (logo, colors, typography) without code changes.
Output: BrandingModule with database model, service, controller, and caching.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/08-portals/08-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TenantBranding Prisma model</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add TenantBranding model to schema.prisma with:
- id: String @id @default(uuid())
- organizationId: String @unique (FK to Organization)
- mode: BrandingMode enum (TEMPLATE, FULL_WHITE_LABEL)
- logoUrl: String? (URL to logo in blob storage)
- primaryColor: String? (HSL format, e.g., "221 83% 53%")
- theme: ThemeMode enum? (LIGHT, DARK, SYSTEM)
- colorPalette: Json? (12-token palette for full white-label)
- typography: Json? (fontFamily, headingFontFamily)
- customDomain: String? @unique
- footerText: String?
- welcomeVideoUrl: String?
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- organization: Organization relation

Add enums:
- BrandingMode: TEMPLATE, FULL_WHITE_LABEL
- ThemeMode: LIGHT, DARK, SYSTEM

Add RLS policy for tenant isolation.
  </action>
  <verify>npx prisma format && npx prisma validate</verify>
  <done>TenantBranding model exists in schema with all fields and proper relations</done>
</task>

<task type="auto">
  <name>Task 2: Create BrandingService with CSS generation</name>
  <files>
    apps/backend/src/modules/branding/branding.service.ts
    apps/backend/src/modules/branding/dto/branding.dto.ts
    apps/backend/src/modules/branding/types/branding.types.ts
  </files>
  <action>
Create BrandingService with methods:
1. getBranding(tenantSlug: string): Promise<TenantBranding>
   - Check cache first (key: branding:${organizationId})
   - Fall back to database lookup by organization slug
   - Cache for 1 hour
   - Return default branding if none configured

2. generateCss(branding: TenantBranding): string
   - For TEMPLATE mode: Apply primaryColor to --primary, derive foreground colors
   - For FULL_WHITE_LABEL mode: Map all 12 colorPalette tokens to CSS variables
   - Include typography if configured
   - Return CSS string with :root { ... }

3. update(organizationId: string, dto: UpdateBrandingDto): Promise<TenantBranding>
   - Validate colorPalette structure if mode is FULL_WHITE_LABEL
   - Invalidate cache on update
   - Emit branding.updated event

4. getDefaultBranding(): TenantBranding
   - Return sensible defaults (Ethico blue primary, light mode)

Create DTOs:
- UpdateBrandingDto with class-validator decorations
- ColorPaletteDto for nested validation

Create types:
- ColorPalette interface with 12 required HSL tokens
- BrandingConfig interface for service responses

Use dependency injection for PrismaService and CacheManager.
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>BrandingService compiles and exports all methods</done>
</task>

<task type="auto">
  <name>Task 3: Create BrandingController with public CSS endpoint</name>
  <files>
    apps/backend/src/modules/branding/branding.controller.ts
    apps/backend/src/modules/branding/branding.module.ts
    apps/backend/src/app.module.ts
  </files>
  <action>
Create BrandingController with endpoints:
1. GET /api/v1/public/branding/:tenantSlug/css
   - Public endpoint (no auth required)
   - Returns raw CSS string with Content-Type: text/css
   - Sets Cache-Control: public, max-age=3600

2. GET /api/v1/branding
   - Requires authentication
   - Returns current organization's branding config as JSON

3. PUT /api/v1/branding
   - Requires SYSTEM_ADMIN or COMPLIANCE_OFFICER role
   - Updates branding configuration
   - Validates mode-specific required fields

4. POST /api/v1/branding/preview-css
   - Requires authentication
   - Accepts branding config in body
   - Returns generated CSS without saving (for live preview)

Create BrandingModule:
- Import PrismaModule, CacheModule
- Provide BrandingService
- Export BrandingService (for Ethics Portal routes)

Update app.module.ts to import BrandingModule.

Use @Public() decorator on public endpoints.
Apply @Roles() guard on admin endpoints.
  </action>
  <verify>npm run build -- --filter=backend && curl http://localhost:3000/api/v1/public/branding/acme/css (after starting server)</verify>
  <done>BrandingController has all 4 endpoints, module registered in app</done>
</task>

</tasks>

<verification>
1. Run `npx prisma migrate dev --name add-tenant-branding` to create migration
2. Run `npm run build -- --filter=backend` to verify compilation
3. Run `npm test -- --testPathPattern=branding` to verify unit tests pass
4. Verify GET /api/v1/public/branding/:slug/css returns CSS string
5. Verify PUT /api/v1/branding requires authentication
</verification>

<success_criteria>
- TenantBranding model exists in Prisma schema with proper relations
- BrandingService generates valid CSS from both template and full white-label configs
- Public CSS endpoint returns themed CSS variables
- Branding config is cached for 1 hour with invalidation on update
- Admin endpoints enforce SYSTEM_ADMIN/COMPLIANCE_OFFICER roles
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-01-SUMMARY.md`
</output>
