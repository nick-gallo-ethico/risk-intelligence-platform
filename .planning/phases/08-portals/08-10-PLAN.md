---
phase: 08-portals
plan: 10
type: execute
wave: 4
depends_on: ["08-08"]
files_modified:
  - apps/frontend/src/app/ethics/[tenant]/report/page.tsx
  - apps/frontend/src/components/ethics/report-form.tsx
  - apps/frontend/src/components/ethics/category-selector.tsx
  - apps/frontend/src/components/ethics/anonymity-selector.tsx
  - apps/frontend/src/components/ethics/attachment-upload.tsx
  - apps/frontend/src/components/ethics/confirmation-page.tsx
autonomous: true

must_haves:
  truths:
    - "Reporter can select category and see category-specific fields"
    - "Reporter can choose anonymity tier with clear explanation of each"
    - "Reporter can attach files with sensitivity tagging"
    - "Submission returns access code on dedicated confirmation page"
  artifacts:
    - path: "apps/frontend/src/app/ethics/[tenant]/report/page.tsx"
      provides: "Report submission page route"
      exports: ["default"]
    - path: "apps/frontend/src/components/ethics/report-form.tsx"
      provides: "Multi-step report form with category-specific fields"
      exports: ["ReportForm"]
    - path: "apps/frontend/src/components/ethics/confirmation-page.tsx"
      provides: "Confirmation with access code display"
      exports: ["ConfirmationPage"]
  key_links:
    - from: "ReportForm"
      to: "useAutoSaveDraft"
      via: "hook call"
      pattern: "useAutoSaveDraft"
    - from: "ReportForm"
      to: "/api/v1/public/ethics"
      via: "fetch on submit"
      pattern: "fetch.*public/ethics.*reports"
---

<objective>
Create the Ethics Portal anonymous report submission UI - the multi-step form with category selection, anonymity options, attachments, and confirmation page.

Purpose: Enable anonymous reporters to submit reports with a privacy-focused, mobile-first interface.
Output: Report submission pages and components with auto-save and confirmation.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create category and anonymity selection components</name>
  <files>
    apps/frontend/src/components/ethics/category-selector.tsx
    apps/frontend/src/components/ethics/anonymity-selector.tsx
    apps/frontend/src/hooks/useTenantCategories.ts
  </files>
  <action>
Create src/hooks/useTenantCategories.ts:
- useTenantCategories(tenantSlug: string) hook
- Fetches categories from /api/v1/public/ethics/:tenant/categories
- Returns: categories (tree structure), isLoading, error
- Caches with 5-minute stale time

Create src/components/ethics/category-selector.tsx:
- Props: categories, selectedId, onSelect, disabled
- Render categories as expandable tree or flat list based on depth
- Show category icon, name, and description
- Highlight selected category
- Mobile-friendly: large touch targets (min 44px)
- Support keyboard navigation
- Show "Most common" badge on frequently selected categories (metadata from API)

Create src/components/ethics/anonymity-selector.tsx:
- Props: selected, onSelect, options (from tenant config)
- Three cards for ANONYMOUS, CONFIDENTIAL, OPEN
- Each card shows:
  - Title (Anonymous, Confidential, Open)
  - Icon (Shield, Lock, User)
  - Description of what it means
  - Benefits bullet points
- Per CONTEXT.md: "display 3 levels with clear pros/cons"
- Selected card has visual highlight (border, background)
- Mobile: stack vertically with full-width cards

Card content:
- ANONYMOUS: "Your identity is completely hidden. We cannot follow up with you."
- CONFIDENTIAL: "Your identity is protected. Only authorized investigators can see it."
- OPEN: "Your identity is visible to investigators. This allows for easier follow-up."
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Category tree selector and anonymity cards created</done>
</task>

<task type="auto">
  <name>Task 2: Create report form with auto-save and attachment upload</name>
  <files>
    apps/frontend/src/components/ethics/report-form.tsx
    apps/frontend/src/components/ethics/attachment-upload.tsx
    apps/frontend/src/components/ethics/smart-prompts.tsx
  </files>
  <action>
Create src/components/ethics/report-form.tsx:
- Multi-step form using react-hook-form
- Steps: 1) Category, 2) Details, 3) Attachments (optional), 4) Review
- Step 2 loads category-specific schema from /api/v1/public/ethics/:tenant/categories/:id/form
- Render JSON Schema fields using existing form engine patterns
- Integrate useAutoSaveDraft from 08-08:
  - Auto-save every 30 seconds when dirty
  - Manual "Save for Later" button generates resume code
  - Show "Draft saved" indicator
- Smart prompts (SmartPrompts component):
  - If description < 50 chars, gently suggest more detail
  - Category-specific prompts (e.g., "When did this happen?")
  - Never block submission - always show "Submit Anyway"
- Urgency flag toggle at review step
- Progress indicator at top

State management:
- formData: Record<string, unknown>
- currentStep: number
- isDirty: boolean
- autoSaveStatus: 'idle' | 'saving' | 'saved' | 'error'

Create src/components/ethics/attachment-upload.tsx:
- Props: attachments, onAdd, onRemove, onToggleSensitive
- Drag-drop zone with file input fallback
- Show uploaded files as cards with:
  - Filename, size, type icon
  - Remove button
  - "Mark as Sensitive" toggle with tooltip
- Max file size: 25MB (client-side validation)
- Allowed types: images, PDFs, Word docs, text files
- Upload to /api/v1/public/ethics/:tenant/attachments, get tempId
- Mobile: Camera button for direct photo capture

Create src/components/ethics/smart-prompts.tsx:
- Non-blocking hints that appear below text areas
- Based on: content length, selected category, missing common fields
- Gentle language: "You might also want to mention..."
- Always include dismiss option
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Report form with auto-save, attachments, and smart prompts created</done>
</task>

<task type="auto">
  <name>Task 3: Create confirmation page and report route</name>
  <files>
    apps/frontend/src/app/ethics/[tenant]/report/page.tsx
    apps/frontend/src/app/ethics/[tenant]/report/confirmation/page.tsx
    apps/frontend/src/components/ethics/confirmation-page.tsx
    apps/frontend/src/components/ethics/access-code-display.tsx
  </files>
  <action>
Create src/components/ethics/access-code-display.tsx:
- Props: accessCode, referenceNumber
- Large, prominent display of access code
- Segmented format: XXXX-XXXX-XXXX (with dashes)
- Copy to clipboard button
- Email to self option (optional email input)
- Print button (opens print dialog)
- Download PDF button
- Warning: "Save this code. You will need it to check status."

Create src/components/ethics/confirmation-page.tsx:
- Props: submissionResult (accessCode, referenceNumber, confirmationNumber)
- Success checkmark animation
- "Your report has been submitted" heading
- AccessCodeDisplay component
- Next steps section:
  - "What happens now" explanation
  - Link to status check page
  - Link to "Submit another report"
- Acknowledgment checkbox: "I have saved my access code"
- Only show "Done" button after acknowledgment
- Per CONTEXT.md: "full page (not modal)"

Create src/app/ethics/[tenant]/report/page.tsx:
- Load tenant config and categories
- Render TenantThemeProvider (from 08-01 branding)
- Render LanguageSwitcher in header
- Render ReportForm
- Handle form submission:
  - POST to /api/v1/public/ethics/:tenant/reports
  - On success, redirect to confirmation page

Create src/app/ethics/[tenant]/report/confirmation/page.tsx:
- Get submissionResult from URL params or session storage
- Render ConfirmationPage component
- Redirect to /report if no result (prevent direct access)
  </action>
  <verify>npm run build -- --filter=frontend</verify>
  <done>Report route with confirmation page and access code display created</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=frontend` to verify compilation
2. Verify category selection loads category-specific form fields
3. Verify auto-save persists to IndexedDB
4. Verify submission returns access code on confirmation page
5. Verify mobile layout with touch-friendly controls
</verification>

<success_criteria>
- Category selector shows hierarchical categories from API
- Anonymity selector displays three tiers with clear explanations
- Report form auto-saves drafts to encrypted IndexedDB
- Attachments can be uploaded with sensitivity tagging
- Confirmation page prominently displays access code with save options
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-10-SUMMARY.md`
</output>
