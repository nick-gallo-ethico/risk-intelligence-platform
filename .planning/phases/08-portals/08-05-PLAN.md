---
phase: 08-portals
plan: 05
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/backend/src/modules/portals/ethics/ethics-portal.service.ts
  - apps/backend/src/modules/portals/ethics/ethics-portal.controller.ts
  - apps/backend/src/modules/portals/ethics/dto/submit-report.dto.ts
  - apps/backend/src/modules/portals/ethics/ethics-portal.module.ts
autonomous: true

must_haves:
  truths:
    - "Anonymous reporters can submit reports without authentication"
    - "Report submission returns access code and confirmation details"
    - "Category-specific form schemas load dynamically"
    - "Attachments can be uploaded with sensitivity tagging"
    - "Reporters can check status and exchange messages using access code"
    - "New messages from investigators are available via access code lookup"
  artifacts:
    - path: "apps/backend/src/modules/portals/ethics/ethics-portal.service.ts"
      provides: "EthicsPortalService for public report submission"
      exports: ["EthicsPortalService"]
    - path: "apps/backend/src/modules/portals/ethics/ethics-portal.controller.ts"
      provides: "Public endpoints for report submission and form retrieval"
      exports: ["EthicsPortalController"]
  key_links:
    - from: "EthicsPortalService"
      to: "RiusService"
      via: "dependency injection"
      pattern: "riusService\\.create"
    - from: "EthicsPortalService"
      to: "RiuAccessService"
      via: "dependency injection"
      pattern: "riuAccessService\\.generateAccessCode"
    - from: "EthicsPortalController"
      to: "MessageRelayService"
      via: "dependency injection for access code messaging"
      pattern: "relayService\\.receiveFromReporter|getMessagesForReporter"
---

<objective>
Create the Ethics Portal API endpoints for anonymous report submission, category/form retrieval, and attachment handling.

Purpose: Enable anonymous reporters to submit reports through the Ethics Portal microsite.
Output: EthicsPortalService and public controller with submission and form endpoints.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
@.planning/phases/04-core-entities/04-06-SUMMARY.md
@.planning/phases/01-foundation-infrastructure/01-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EthicsPortalService for report submission</name>
  <files>
    apps/backend/src/modules/portals/ethics/ethics-portal.service.ts
    apps/backend/src/modules/portals/ethics/dto/submit-report.dto.ts
    apps/backend/src/modules/portals/ethics/types/ethics-portal.types.ts
  </files>
  <action>
Create EthicsPortalService with methods:

1. submitReport(tenantSlug: string, dto: SubmitReportDto): Promise<SubmissionResult>
   - Resolve tenantSlug to organizationId
   - Validate category exists for organization
   - Create RIU via RiusService with:
     - source: WEB_FORM
     - type: infer from category (REPORT, DISCLOSURE, REQUEST_FOR_INFO)
     - anonymityTier: from DTO (ANONYMOUS, CONFIDENTIAL, OPEN)
     - Reporter Person: create if CONFIDENTIAL/OPEN, use anonymous placeholder if ANONYMOUS
   - Generate access code via RiuAccessService.generateAccessCode()
   - Handle attachments via ModuleStorageService
   - Emit ethics_portal.report_submitted event
   - Return SubmissionResult with accessCode, reportId, confirmationNumber

2. getCategoriesForTenant(tenantSlug: string): Promise<CategoryInfo[]>
   - Return active categories for organization
   - Include: id, name, description, parentId, formSchemaId
   - Build tree structure for UI hierarchy

3. getFormSchema(tenantSlug: string, categoryId: string): Promise<FormSchema>
   - Return JSON Schema for category-specific form
   - Include conditional fields based on category
   - Return base schema if no category-specific schema

4. uploadAttachment(tenantSlug: string, file: Express.Multer.File, dto: AttachmentDto): Promise<AttachmentResult>
   - Upload to temporary storage (not yet linked to RIU)
   - Return temporary reference ID
   - Mark sensitivity if dto.isSensitive = true

5. getTenantConfig(tenantSlug: string): Promise<TenantEthicsConfig>
   - Return tenant-specific Ethics Portal config:
     - enabled categories
     - welcome message
     - anonymity options available
     - required demographics
   - Cache for 5 minutes

Create DTOs:
- SubmitReportDto: categoryId, content, anonymityTier, reporterContact?, attachmentIds[], demographics?, urgencyFlag?
- AttachmentDto: filename, isSensitive

Create types:
- SubmissionResult: accessCode, reportId, confirmationNumber, referenceNumber
- CategoryInfo: id, name, description, parentId, formSchemaId, icon?
- TenantEthicsConfig: categories, welcomeMessage, anonymityOptions, demographicFields
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>EthicsPortalService compiles with submission and configuration methods</done>
</task>

<task type="auto">
  <name>Task 2: Create EthicsPortalController with public endpoints</name>
  <files>
    apps/backend/src/modules/portals/ethics/ethics-portal.controller.ts
  </files>
  <action>
Create EthicsPortalController with public endpoints:

1. GET /api/v1/public/ethics/:tenantSlug/config
   - No auth required
   - Returns TenantEthicsConfig (categories, welcome, options)
   - Rate limit: 30/min

2. GET /api/v1/public/ethics/:tenantSlug/categories
   - No auth required
   - Returns CategoryInfo[] in tree structure
   - Rate limit: 30/min

3. GET /api/v1/public/ethics/:tenantSlug/categories/:categoryId/form
   - No auth required
   - Returns JSON Schema + UI Schema for category
   - Rate limit: 30/min

4. POST /api/v1/public/ethics/:tenantSlug/reports
   - No auth required
   - Body: SubmitReportDto
   - Returns SubmissionResult with accessCode
   - Rate limit: 5/min (prevent spam)

5. GET /api/v1/public/access/:code/status
   - No auth required
   - Validates access code (rate limited: 5 fails = 15min lockout)
   - Returns ReportStatus: referenceNumber, status, statusLabel, statusDescription, canMessage, hasUnreadMessages, lastUpdated
   - Status values: RECEIVED, UNDER_REVIEW, ADDITIONAL_INFO_NEEDED, CLOSED
   - Rate limit: 10/min

6. GET /api/v1/public/access/:code/messages
   - No auth required
   - Validates access code
   - Returns Message[]: id, direction ('inbound'|'outbound'), content, createdAt, readAt?, attachments?
   - Marks outbound (from investigator) messages as read on retrieval
   - Rate limit: 10/min

7. POST /api/v1/public/access/:code/messages
   - No auth required
   - Validates access code
   - Body: { content: string, attachmentIds?: string[] }
   - Creates inbound message from reporter
   - Emits event for investigator notification
   - Rate limit: 5/min

8. POST /api/v1/public/ethics/:tenantSlug/attachments
   - No auth required
   - Multipart form upload
   - Query param: isSensitive (boolean)
   - Returns AttachmentResult with tempId
   - Rate limit: 10/min, max file size 25MB

9. GET /api/v1/public/ethics/:tenantSlug/draft/:draftCode
   - No auth required
   - Returns saved draft content (for cross-device resume)
   - Rate limit: 10/min

10. POST /api/v1/public/ethics/:tenantSlug/draft
    - No auth required
    - Saves draft server-side with generated code
    - Returns draftCode for resume
    - Rate limit: 10/min

Use @Public() decorator on all endpoints.
Apply @Throttle() per endpoint.
Validate tenantSlug resolves to active organization.
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>EthicsPortalController has all 10 public endpoints with rate limiting (including access code status/messaging)</done>
</task>

<task type="auto">
  <name>Task 3: Create EthicsPortalModule and register</name>
  <files>
    apps/backend/src/modules/portals/ethics/ethics-portal.module.ts
    apps/backend/src/modules/portals/portals.module.ts
  </files>
  <action>
Create EthicsPortalModule:
- Import:
  - PrismaModule
  - RiusModule (for RiusService, RiuAccessService)
  - FormsModule (for FormSchemaService)
  - StorageModule (for ModuleStorageService)
  - BrandingModule (from 08-01)
  - CategoriesModule
- Provide EthicsPortalService
- Register EthicsPortalController
- Export EthicsPortalService

Update PortalsModule:
- Import EthicsPortalModule
- Export EthicsPortalModule

Ensure public endpoints are properly excluded from global auth guard.
Add route prefixes via @Controller decorator.
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>EthicsPortalModule registered and exported from PortalsModule</done>
</task>

</tasks>

<verification>
1. Run `npm run build -- --filter=backend` to verify compilation
2. Verify public endpoints don't require authentication
3. Test report submission creates RIU with access code
4. Verify rate limits applied per endpoint
</verification>

<success_criteria>
- Public report submission endpoint creates RIU and returns access code
- Category-specific forms retrieved without authentication
- Attachments can be uploaded before report submission
- Draft save/resume works with cross-device codes
- All endpoints are rate-limited appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-05-SUMMARY.md`
</output>
