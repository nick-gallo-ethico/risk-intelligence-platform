---
phase: 08-portals
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/prisma/schema.prisma
  - apps/backend/src/modules/portals/operator/directives.service.ts
  - apps/backend/src/modules/portals/operator/directives.controller.ts
  - apps/backend/src/modules/portals/operator/dto/directives.dto.ts
autonomous: true

must_haves:
  truths:
    - "Clients can configure opening and closing scripts per category"
    - "Directives can be marked as read-aloud prompts"
    - "Category-specific directives load when operator selects category"
    - "Directives support multiple call stages (opening, intake, closing)"
  artifacts:
    - path: "apps/backend/src/modules/portals/operator/directives.service.ts"
      provides: "DirectivesService for loading client-specific scripts"
      exports: ["DirectivesService"]
    - path: "apps/backend/prisma/schema.prisma"
      provides: "ClientDirective model"
      contains: "model ClientDirective"
  key_links:
    - from: "DirectivesService"
      to: "ClientDirective"
      via: "Prisma query"
      pattern: "prisma\\.clientDirective\\.(find|create)"
---

<objective>
Create the directives service that manages client-specific scripts operators read during hotline calls - opening statements, category-specific guidance, and closing scripts.

Purpose: Ensure operators follow client-specific legal/compliance requirements during calls.
Output: DirectivesService with CRUD operations and stage-based retrieval.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-portals/08-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClientDirective Prisma model</name>
  <files>apps/backend/prisma/schema.prisma</files>
  <action>
Add ClientDirective model to schema.prisma with:
- id: String @id @default(uuid())
- organizationId: String (FK to Organization - the client)
- stage: DirectiveStage enum (OPENING, INTAKE, CATEGORY_SPECIFIC, CLOSING)
- categoryId: String? (FK to Category, null for non-category-specific)
- title: String (e.g., "HIPAA Disclosure Warning")
- content: String (the script text, supports markdown)
- isReadAloud: Boolean @default(false) (true = must be read verbatim)
- order: Int @default(0) (for sorting multiple directives in same stage)
- isActive: Boolean @default(true)
- createdAt: DateTime @default(now())
- updatedAt: DateTime @updatedAt
- organization: Organization relation
- category: Category? relation

Add enum:
- DirectiveStage: OPENING, INTAKE, CATEGORY_SPECIFIC, CLOSING

Add indexes:
- @@index([organizationId, stage])
- @@index([organizationId, categoryId])

Add RLS policy for tenant isolation (directives are client-owned).
  </action>
  <verify>npx prisma format && npx prisma validate</verify>
  <done>ClientDirective model exists with stage enum and category relation</done>
</task>

<task type="auto">
  <name>Task 2: Create DirectivesService with stage-based retrieval</name>
  <files>
    apps/backend/src/modules/portals/operator/directives.service.ts
    apps/backend/src/modules/portals/operator/dto/directives.dto.ts
    apps/backend/src/modules/portals/operator/types/directives.types.ts
  </files>
  <action>
Create DirectivesService with methods:
1. getDirectivesForStage(organizationId: string, stage: DirectiveStage, categoryId?: string): Promise<ClientDirective[]>
   - Return active directives for the given stage, sorted by order
   - For CATEGORY_SPECIFIC stage, filter by categoryId
   - Include category relation for display

2. getDirectivesForCall(organizationId: string, categoryId?: string): Promise<CallDirectives>
   - Return all directives needed for a call in one query
   - Structure: { opening: [], intake: [], categorySpecific: [], closing: [] }
   - Category-specific only included if categoryId provided

3. create(organizationId: string, dto: CreateDirectiveDto): Promise<ClientDirective>
   - Validate categoryId is required when stage is CATEGORY_SPECIFIC
   - Auto-assign order as max(order) + 1 for stage

4. update(id: string, dto: UpdateDirectiveDto): Promise<ClientDirective>
   - Partial update
   - Clear categoryId if stage changed from CATEGORY_SPECIFIC

5. delete(id: string): Promise<void>
   - Soft delete (set isActive = false)

6. reorder(ids: string[]): Promise<void>
   - Update order field based on array position

Create DTOs:
- CreateDirectiveDto: stage, categoryId?, title, content, isReadAloud
- UpdateDirectiveDto: Partial<CreateDirectiveDto> + order?, isActive?

Create types:
- CallDirectives interface for grouped retrieval
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>DirectivesService compiles with all retrieval and CRUD methods</done>
</task>

<task type="auto">
  <name>Task 3: Create DirectivesController with admin endpoints</name>
  <files>
    apps/backend/src/modules/portals/operator/directives.controller.ts
    apps/backend/src/modules/portals/operator/operator-portal.module.ts
  </files>
  <action>
Create DirectivesController with endpoints:
1. GET /api/v1/operator/clients/:clientId/directives
   - Requires OPERATOR or SYSTEM_ADMIN role
   - Returns all active directives for client grouped by stage
   - Query param: categoryId (optional, for filtering category-specific)

2. GET /api/v1/operator/clients/:clientId/directives/call
   - Requires OPERATOR role
   - Returns CallDirectives structure for active call
   - Query param: categoryId (optional)

3. POST /api/v1/operator/clients/:clientId/directives
   - Requires SYSTEM_ADMIN role (clients configure their own, admins can help)
   - Creates new directive

4. PUT /api/v1/operator/clients/:clientId/directives/:id
   - Requires SYSTEM_ADMIN role
   - Updates directive

5. DELETE /api/v1/operator/clients/:clientId/directives/:id
   - Requires SYSTEM_ADMIN role
   - Soft deletes directive

6. POST /api/v1/operator/clients/:clientId/directives/reorder
   - Requires SYSTEM_ADMIN role
   - Body: { ids: string[] }

Create OperatorPortalModule (if not exists):
- Import necessary modules
- Provide DirectivesService
- Register DirectivesController
- Export DirectivesService

Note: Operator endpoints use :clientId param because operators work across multiple client organizations.
  </action>
  <verify>npm run build -- --filter=backend</verify>
  <done>DirectivesController has all 6 endpoints, module created</done>
</task>

</tasks>

<verification>
1. Run `npx prisma migrate dev --name add-client-directives` to create migration
2. Run `npm run build -- --filter=backend` to verify compilation
3. Verify DirectivesService.getDirectivesForCall returns grouped structure
4. Verify category-specific directives require categoryId
</verification>

<success_criteria>
- ClientDirective model exists with stage-based enum
- DirectivesService retrieves directives grouped by call stage
- Category-specific directives are filtered by categoryId
- Read-aloud prompts are flagged with isReadAloud boolean
- Admin endpoints enforce SYSTEM_ADMIN role
</success_criteria>

<output>
After completion, create `.planning/phases/08-portals/08-02-SUMMARY.md`
</output>
