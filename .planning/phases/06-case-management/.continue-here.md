---
phase: 06-case-management
task: UAT-fix
total_tasks: 7
status: in_progress
last_updated: 2026-02-03T12:45:00Z
---

<current_state>
Ran `/gsd:verify-work 6` - completed automated UAT testing with 3 parallel agents.
Found 7 issues, started fixing them but paused mid-fix on issue #1 (checklist controller auth).
</current_state>

<completed_work>

## UAT Testing (Complete)
- Spawned 3 parallel testing agents (API tests x2, UI tests x1 with Playwright)
- Tested 30 features across backend APIs and frontend UI
- Results: **17 passed, 7 issues, 6 skipped**
- UAT file written: `.planning/phases/06-case-management/06-case-management-UAT.md`

## Issues Diagnosed
1. Checklist controller uses hardcoded `stub-org-id` (MAJOR)
2. Access code regex case mismatch `[A-Z0-9]` vs mixed-case codes (MAJOR)
3. Shortcuts help dialog not wired to ? key (MINOR)
4. Route double-prefix bug `/api/v1/api/v1/...` (MINOR)
5. Frontend-backend port mismatch 3000 vs 3001 (MINOR)
6. Tiptap SSR error needs `immediatelyRender: false` (MINOR)
7. Template sections storing as `[[],[]]` instead of populated (MINOR)

## Fix Started (Partial)
- Edited `checklist.controller.ts` to add imports for JwtAuthGuard, TenantId, CurrentUser
- Changed controller decorator from `@Controller('api/v1/investigation-checklists')` to `@Controller('investigation-checklists')`
- Added `@UseGuards(JwtAuthGuard)` to controller class
- Updated `applyTemplate()` method to use decorators instead of stubs
- Updated `getProgress()` method to use `@TenantId()` decorator
- **NOT YET DONE**: Remaining 5 methods in checklist.controller.ts still have stubs
</completed_work>

<remaining_work>

## Issue #1: Checklist Controller Auth (IN PROGRESS)
File: `apps/backend/src/modules/investigations/checklists/checklist.controller.ts`
- [x] Add imports for guards/decorators
- [x] Fix controller decorator (remove api/v1 prefix)
- [x] Add @UseGuards(JwtAuthGuard)
- [x] Fix applyTemplate() method
- [x] Fix getProgress() method
- [ ] Fix completeItem() method
- [ ] Fix skipItem() method
- [ ] Fix uncompleteItem() method
- [ ] Fix addCustomItem() method
- [ ] Fix deleteChecklist() method

## Issue #2: Access Code Regex (NOT STARTED)
File: `apps/backend/src/modules/messaging/messaging.controller.ts`
Lines 178, 211: Change `[A-Z0-9]{12,20}` to `[A-Za-z0-9]{12,20}`

## Issue #3: Shortcuts Help Dialog (NOT STARTED)
File: `apps/frontend/src/contexts/shortcuts-context.tsx`
Need to wire ? shortcut to open ShortcutsHelpDialog

## Issue #4: Route Double-Prefix (NOT STARTED)
Files with `@Controller('api/v1/...')` that need prefix removed:
- notifications/controllers/preferences.controller.ts
- notifications/controllers/notifications.controller.ts
- search/search.controller.ts
- investigations/templates/template.controller.ts
- remediation/remediation.controller.ts

## Issue #5: Frontend Port Config (NOT STARTED)
Set `NEXT_PUBLIC_API_URL=http://localhost:3001` in frontend env

## Issue #6: Tiptap SSR (NOT STARTED)
File: `apps/frontend/src/components/rich-text/rich-text-editor.tsx`
Line 69: Add `immediatelyRender: false` to editor config

## Issue #7: Template Sections (NOT STARTED)
Investigate why sections store as `[[],[]]` - likely serialization issue
</remaining_work>

<decisions_made>

- Decided to fix issues directly rather than create formal fix plans (they're small wiring bugs)
- Using `@TenantId()` and `@CurrentUser()` decorators (already exist in common/decorators)
- Removing `api/v1` prefix from controllers since global prefix handles it
- Access code regex should allow mixed case to match seed data generation
</decisions_made>

<blockers>

None - all issues are straightforward fixes with clear solutions
</blockers>

<context>
The Phase 6 Case Management UAT revealed that the core functionality works (17/30 tests pass)
but there are configuration/wiring issues preventing some features from working end-to-end.

The main issues are:
1. Auth context not being passed to checklist controller (uses stub values)
2. Access code validation too strict (uppercase only vs mixed-case codes in seed data)
3. Various minor wiring issues (shortcuts, routes, ports)

The user asked "why did you skip 6 and what are you doing about the 7 issues?" -
they wanted me to be proactive and fix issues, not just report them.
I started fixing issue #1 but was interrupted by /gsd:pause-work.
</context>

<next_action>
Resume by completing the checklist controller fix:

1. Open `apps/backend/src/modules/investigations/checklists/checklist.controller.ts`
2. Update remaining 5 methods to use decorators:
   - completeItem(): Add @TenantId(), @CurrentUser('id'), @CurrentUser('name')
   - skipItem(): Same decorators
   - uncompleteItem(): Add @TenantId(), @CurrentUser('id')
   - addCustomItem(): Add @TenantId(), @CurrentUser('id'), @CurrentUser('name')
   - deleteChecklist(): Add @TenantId(), @CurrentUser('id')
3. Then fix issue #2 (access code regex)
4. Then fix remaining minor issues #3-7
5. Run `npm run build` to verify
6. Re-run UAT to confirm fixes
</next_action>
