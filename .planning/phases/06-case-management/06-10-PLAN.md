---
phase: 06-case-management
plan: 10
type: execute
wave: 3
depends_on: ["06-05"]
files_modified:
  - apps/backend/src/modules/search/unified-search.service.ts
  - apps/backend/src/modules/search/search.controller.ts
  - apps/backend/src/modules/search/search.module.ts
autonomous: true

must_haves:
  truths:
    - "Unified search queries Cases, RIUs, Investigations, Persons in one call"
    - "Custom properties included in Elasticsearch index"
    - "Results grouped by entity type with counts"
    - "Permission filters applied per entity type"
  artifacts:
    - path: "apps/backend/src/modules/search/unified-search.service.ts"
      provides: "Multi-entity search with ES"
      exports: ["UnifiedSearchService"]
  key_links:
    - from: "unified-search.service.ts"
      to: "search.service.ts"
      via: "DI injection"
      pattern: "SearchService"
---

<objective>
Create unified search service that queries across all entity types with custom property support and permission filtering.

Purpose: Users need to find information quickly without knowing which entity type contains it. Unified search reduces context switching.

Output: Unified search service, enhanced controller endpoint
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-case-management/06-05-SUMMARY.md
@apps/backend/src/modules/search/search.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnifiedSearchService</name>
  <files>apps/backend/src/modules/search/unified-search.service.ts</files>
  <action>
Create `unified-search.service.ts` that:
1. Accepts single query string
2. Searches across Cases, RIUs, Investigations, Persons indices
3. Applies role-based permission filters per entity type
4. Returns grouped results with entity type, count, and top hits
5. Supports filtering by entity types (optional)
6. Includes customFields in search query
7. Highlights matching terms in results
8. Limits to 10 results per entity type by default

Key method signatures:
```typescript
async search(
  organizationId: string,
  userId: string,
  userRole: UserRole,
  query: string,
  options?: {
    entityTypes?: ('cases' | 'rius' | 'investigations' | 'persons')[];
    limit?: number;
    includeCustomFields?: boolean;
  }
): Promise<UnifiedSearchResult>

interface UnifiedSearchResult {
  query: string;
  totalHits: number;
  results: {
    entityType: string;
    count: number;
    hits: SearchHit[];
  }[];
  took: number;
}
```
  </action>
  <verify>TypeScript compiles. Service queries multiple indices with permission filters.</verify>
  <done>UnifiedSearchService provides cross-entity search with custom field support.</done>
</task>

<task type="auto">
  <name>Task 2: Add Custom Fields to ES Index Mappings</name>
  <files>apps/backend/src/modules/search/search.service.ts</files>
  <action>
Update ES index creation/mapping in SearchService to:
1. Add `customFields` as nested object type with dynamic mapping
2. Include customFields in search query fields
3. Support filtering by specific custom field values
4. Re-index hook when custom fields change

Add method to update index mapping when new custom properties defined.
  </action>
  <verify>Custom fields indexed and searchable in ES queries.</verify>
  <done>ES indices include custom fields with dynamic mapping.</done>
</task>

<task type="auto">
  <name>Task 3: Add Unified Search Endpoint</name>
  <files>
    apps/backend/src/modules/search/search.controller.ts
    apps/backend/src/modules/search/search.module.ts
  </files>
  <action>
Add endpoint to search.controller.ts:
```typescript
@Get('unified')
async unifiedSearch(
  @CurrentUser() user: AuthUser,
  @Query('q') query: string,
  @Query('types') types?: string,  // Comma-separated entity types
  @Query('limit') limit?: number,
) {
  const entityTypes = types?.split(',') as any[];
  return this.unifiedSearchService.search(
    user.organizationId,
    user.id,
    user.role,
    query,
    { entityTypes, limit },
  );
}
```

Update module to register UnifiedSearchService.
  </action>
  <verify>GET /api/v1/search/unified?q=query returns grouped results from all entity types.</verify>
  <done>Unified search endpoint available with entity type filtering.</done>
</task>

</tasks>

<verification>
- [ ] `npm run build` in apps/backend succeeds
- [ ] Unified search queries all entity indices
- [ ] Results grouped by entity type with counts
- [ ] Custom fields included in search
- [ ] Permission filters applied correctly
</verification>

<success_criteria>
1. Single API call searches Cases, RIUs, Investigations, Persons
2. Custom property values searchable via Elasticsearch
3. Results grouped with hit counts per entity type
4. Role-based permissions filter results appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/06-case-management/06-10-SUMMARY.md`
</output>
