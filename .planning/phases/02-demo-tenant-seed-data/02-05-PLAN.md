---
phase: 02-demo-tenant-seed-data
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - apps/backend/prisma/seeders/case.seeder.ts
  - apps/backend/prisma/seeders/investigation.seeder.ts
  - apps/backend/prisma/seeders/patterns/repeat-subjects.ts
  - apps/backend/prisma/seeders/patterns/manager-hotspots.ts
  - apps/backend/prisma/seeders/patterns/retaliation.ts
  - apps/backend/prisma/seeders/patterns/flagship-cases.ts
  - apps/backend/prisma/seed.ts
autonomous: true

must_haves:
  truths:
    - "4500 Cases exist with realistic status distribution (10% open ~450, 90% closed ~4050)"
    - "Cases have linked RIUs via RiuCaseAssociation table"
    - "Closed cases have complete investigation timelines with findings and outcomes"
    - "Case duration: simple 2-4 days, complex 1-3 months, aggregate average under 20-22 days"
    - "Outcome distribution: ~60% substantiation rate"
    - "Priority distribution: pyramid (few critical, some high, many medium, most low)"
    - "5-10 flagship named cases exist for sales walkthroughs"
    - "Recent unread cases exist in triage with pending approvals"
    - "AI enrichment pre-populated (summaries, risk scores)"
  artifacts:
    - path: "apps/backend/prisma/seeders/case.seeder.ts"
      provides: "Case factory with RIU linkage, timeline generation, and pattern support"
      exports: ["seedCases"]
    - path: "apps/backend/prisma/seeders/investigation.seeder.ts"
      provides: "Investigation factory with progression timestamps and regulatory investigations"
      exports: ["seedInvestigations"]
    - path: "apps/backend/prisma/seeders/patterns/repeat-subjects.ts"
      provides: "Pattern generator for repeat subjects across multiple cases"
      exports: ["generateRepeatSubjects", "REPEAT_SUBJECT_POOL"]
    - path: "apps/backend/prisma/seeders/patterns/manager-hotspots.ts"
      provides: "Pattern generator for managers with high team case rates"
      exports: ["generateManagerHotspots", "HOTSPOT_MANAGERS"]
    - path: "apps/backend/prisma/seeders/patterns/retaliation.ts"
      provides: "Pattern generator for follow-up retaliation reports"
      exports: ["generateRetaliationPatterns"]
    - path: "apps/backend/prisma/seeders/patterns/flagship-cases.ts"
      provides: "Named memorable flagship cases for sales demos"
      exports: ["FLAGSHIP_CASES", "seedFlagshipCases"]
  key_links:
    - from: "apps/backend/prisma/seeders/case.seeder.ts"
      to: "prisma.riuCaseAssociation.createMany"
      via: "RIU to Case linking"
      pattern: "riuCaseAssociation"
    - from: "apps/backend/prisma/seeders/investigation.seeder.ts"
      to: "apps/backend/prisma/seeders/utils/temporal.ts"
      via: "generateCaseTimeline for investigation dates"
      pattern: "generateCaseTimeline"
    - from: "apps/backend/prisma/seeders/case.seeder.ts"
      to: "apps/backend/prisma/seeders/patterns/*.ts"
      via: "Pattern injection during case generation"
      pattern: "patternRegistry"
---

<objective>
Create Case and Investigation seeders to generate 4,500 Cases with realistic investigation progression from linked RIUs, including rich patterns for demo effectiveness.

Purpose: Cases are the work containers where investigations happen. This plan creates Cases linked to the RIUs from plan 04, with investigation timelines showing realistic progression through stages (assigned -> investigating -> findings -> closed). Includes pattern generators for repeat subjects, manager hotspots, retaliation, and flagship cases.

Output: 4,500 Cases (90% RIU-to-Case ratio), ~10% open (~450 active), with ~5,000 Investigations (most cases have 1, some require additional regulatory), flagship cases for demos, and AI enrichment pre-populated.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-demo-tenant-seed-data/02-RESEARCH.md
@.planning/phases/02-demo-tenant-seed-data/02-04-PLAN.md (RIUs)
@apps/backend/prisma/schema.prisma (Case, Investigation, RiuCaseAssociation models)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pattern generators for realistic data</name>
  <files>
    apps/backend/prisma/seeders/patterns/repeat-subjects.ts
    apps/backend/prisma/seeders/patterns/manager-hotspots.ts
    apps/backend/prisma/seeders/patterns/retaliation.ts
    apps/backend/prisma/seeders/patterns/flagship-cases.ts
  </files>
  <action>
Create pattern generators that inject realistic patterns into case data.

**1. repeat-subjects.ts - Repeat Subject Pattern:**
```typescript
// Pool of ~50 employee IDs who appear in multiple cases
export const REPEAT_SUBJECT_POOL: string[] = [...];

export function generateRepeatSubjects(
  employeeIds: string[],
  targetCount: number = 50,
): Map<string, number>  // employeeId -> case count (2-5 appearances)
```
- Same person appears as subject in 2-5 cases
- Enables "This person was involved in 3 cases" demo
- 10% of cases involve repeat subjects

**2. manager-hotspots.ts - Manager Hotspot Pattern:**
```typescript
export const HOTSPOT_MANAGERS: Array<{
  managerId: string;
  teamCaseRate: number;  // 2x-3x normal rate
  categories: string[];  // Common complaint types
}>;

export function generateManagerHotspots(
  managerIds: string[],
  targetCount: number = 15,
): HotspotManager[]
```
- ~15 managers with 2x-3x normal team case rates
- Concentrated in specific categories (harassment, discrimination)
- Enables "Department risk analysis" demo

**3. retaliation.ts - Retaliation Pattern:**
```typescript
export interface RetaliationChain {
  originalCaseId: string;
  followUpCaseId: string;
  daysAfterOriginal: number;  // 30-90 days typical
  retaliationType: string;  // 'performance_review', 'schedule_change', etc.
}

export function generateRetaliationPatterns(
  closedCaseIds: string[],
  targetCount: number = 50,
): RetaliationChain[]
```
- ~50 follow-up reports after initial report
- Linked via subject or reporter
- 30-90 days after original case closure

**4. flagship-cases.ts - Flagship Named Cases:**
```typescript
export const FLAGSHIP_CASES: Array<{
  name: string;           // "The Chicago Warehouse Incident"
  narrative: string;      // Detailed story for demo walkthrough
  category: string;
  severity: string;
  hasEscalation: boolean; // CCO involvement
  hasExternalParty: boolean; // Legal, law enforcement
  investigationCount: number;
  status: string;
  aiSummary: string;      // Pre-written AI summary
  aiRiskScore: number;
}>;
```
- 5-10 named, memorable cases
- Rich narratives for sales team walkthroughs
- Examples: "The Chicago Warehouse Incident", "Q3 Financial Irregularities", "Executive Expense Report"
  </action>
  <verify>
TypeScript check: `cd apps/backend && npx tsc --noEmit apps/backend/prisma/seeders/patterns/*.ts`
  </verify>
  <done>
Pattern generators provide repeat subjects, manager hotspots, retaliation chains, and flagship cases for realistic demo data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Case seeder with RIU linkage and patterns</name>
  <files>apps/backend/prisma/seeders/case.seeder.ts</files>
  <action>
Create case.seeder.ts that generates Cases from the seeded RIUs with pattern injection.

**Export function:**
```typescript
export async function seedCases(
  prisma: PrismaClient,
  organizationId: string,
  riuIds: string[],
  userIds: string[],
  employeeIds: string[],
  categoryIds: string[],
  patterns: {
    repeatSubjects: Map<string, number>;
    managerHotspots: HotspotManager[];
    retaliationChains: RetaliationChain[];
    flagshipCases: FlagshipCase[];
  },
): Promise<string[]>
```

**Implementation:**
- Use faker.seed(SEED_CONFIG.masterSeed + 3000)
- Target: 4,500 Cases (90% RIU-to-Case ratio from ~5,000 RIUs)
- Cases are created from RIUs (90% of RIUs create cases, some merge)

**Status distribution (updated from CONTEXT.md):**
- OPEN: 10% (~450 active cases)
- CLOSED: 90% (~4050 closed cases)

**Priority distribution (pyramid):**
- CRITICAL: 2% (~90 cases)
- HIGH: 8% (~360 cases)
- MEDIUM: 30% (~1350 cases)
- LOW: 60% (~2700 cases)

**Case duration for timeline generation:**
- Simple cases: 2-4 days (60% of cases)
- Medium cases: 1-3 weeks (30% of cases)
- Complex cases: 1-3 months (10% of cases)
- **Aggregate average: under 20-22 days**

**For each Case:**
- Pick a RIU from riuIds (use 4,500 RIUs, some merge)
- Get RIU data to inherit sourceChannel, categoryId, severity
- id: faker.string.uuid()
- referenceNumber: generateReferenceNumber('CASE', createdAt, index)
- organizationId
- status: weightedRandom (10% OPEN, 90% CLOSED)
- priority: weightedRandom pyramid
- sourceChannel: from linked RIU
- caseType: REPORT (90%) or RFI (10%)
- reporterType, reporterAnonymous: from RIU
- details: generate case narrative based on RIU
- summary: faker.lorem.sentence()
- severity: from RIU (can be corrected)
- primaryCategoryId: from RIU
- createdAt: slightly after RIU createdAt (1-4 hours later for released RIUs)
- createdById, updatedById: random user

**AI Enrichment (pre-populated):**
- aiSummary: Generated narrative summary
- aiRiskScore: 1-100 based on category + severity
- aiSummaryGeneratedAt: timestamp
- aiModelVersion: 'claude-3-opus'

**Pattern Injection:**
- Apply repeat subject assignments from pattern
- Apply manager hotspot case elevation
- Mark retaliation follow-up cases with linkedCaseId
- Insert flagship cases with curated content

**Create RiuCaseAssociation for each Case:**
```typescript
{
  riuId: riu.id,
  caseId: case.id,
  associationType: 'PRIMARY',
  createdById: userId,
  createdAt: case.createdAt,
}
```

**Linked RIUs (case consolidation):**
- 10% of cases have multiple RIUs linked (2-3 RIUs)
- Shows case consolidation feature

**Fresh items for demo:**
- ~50 recent cases (last 7 days) with status NEW/OPEN
- Unread flags set, pending approvals created
- Enables "live triage" demo scenario

Return array of case IDs.
  </action>
  <verify>
TypeScript check: `cd apps/backend && npx tsc --noEmit apps/backend/prisma/seeders/case.seeder.ts`
  </verify>
  <done>
Case seeder creates 4,500 Cases linked to RIUs with 10%/90% open/closed distribution, pyramid priority, AI enrichment, and pattern injection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Investigation seeder with realistic timelines and regulatory investigations</name>
  <files>apps/backend/prisma/seeders/investigation.seeder.ts</files>
  <action>
Create investigation.seeder.ts that generates Investigations for Cases.

**Export function:**
```typescript
export async function seedInvestigations(
  prisma: PrismaClient,
  organizationId: string,
  caseData: Array<{
    id: string;
    status: CaseStatus;
    createdAt: Date;
    categoryId: string;
    priority: string;
    hasEscalation: boolean;
    hasExternalParty: boolean;
  }>,
  userIds: string[],
): Promise<void>
```

**Investigation generation rules:**
- Every OPEN and CLOSED case gets at least one investigation
- Some cases require additional regulatory investigations (e.g., HIPAA for Healthcare)
- ~10% of Healthcare cases get REGULATORY investigation type
- Target: ~5,000 investigations (most cases 1, some 2+)

**Status progression based on Case status:**
- Case OPEN: Investigation status = ASSIGNED, INVESTIGATING, or PENDING_REVIEW
- Case CLOSED: Investigation status = CLOSED with findings

**Timeline generation (aligned to case duration targets):**
For closed cases:
1. createdAt: same as case creation
2. assignedAt: 1-3 days after creation
3. statusChangedAt: progresses through stages
4. closedAt: based on complexity:
   - Simple: 2-4 days (60%)
   - Medium: 7-21 days (30%)
   - Complex: 30-90 days (10%)
   - **Aggregate average under 20-22 days**

**For each Investigation:**
- id: faker.string.uuid()
- caseId, organizationId
- investigationNumber: 1 (or 2+ for additional investigations)
- investigationType: weightedRandom [FULL: 55, LIMITED: 30, INQUIRY: 10, REGULATORY: 5]
- department: weightedRandom [HR: 35, LEGAL: 25, COMPLIANCE: 20, SAFETY: 10, OTHER: 10]
- status: based on Case status
- primaryInvestigatorId: random from userIds
- assignedTo: array with primary + 0-2 additional investigators
- dueDate: 30-60 days from assignedAt

**Outcome distribution (updated - higher substantiation):**
- SUBSTANTIATED: 60%
- UNSUBSTANTIATED: 30%
- INCONCLUSIVE: 10%

**For CLOSED investigations:**
- outcome: weightedRandom per above distribution
- findingsSummary: faker.lorem.paragraph()
- findingsDetail: faker.lorem.paragraphs(2)
- rootCause: faker.lorem.sentence()
- closedById: random user
- closureNotes: faker.lorem.paragraph()

**Escalation Pattern:**
- CCO involvement on CRITICAL/HIGH severity cases
- Track escalatedToId, escalatedAt, escalationReason
- ~5% of cases show CCO escalation

**External Party Pattern:**
- Some cases involve legal counsel or law enforcement
- Track externalPartyType, externalPartyEngagedAt
- ~3% involve legal, ~1% involve law enforcement

**Case Reassignment Pattern:**
- ~10% of open/recent closed cases show mid-investigation reassignment
- Track previousInvestigatorId, reassignedAt, reassignmentReason

**Interview Records:**
- 1-3 interviews per investigation (subject, witnesses, reporter follow-up)
- Create Interview records linked to investigations

Use batch insertions with progress bar.
  </action>
  <verify>
TypeScript check: `cd apps/backend && npx tsc --noEmit apps/backend/prisma/seeders/investigation.seeder.ts`
  </verify>
  <done>
Investigation seeder creates ~5,000 investigations with 60% substantiation rate, regulatory investigations, escalations, external parties, and reassignments.
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate Case and Investigation seeders with pattern orchestration</name>
  <files>apps/backend/prisma/seed.ts</files>
  <action>
Update seed.ts to call Case and Investigation seeders with pattern generation.

**Modifications:**
1. Import seeders and patterns:
   ```typescript
   import { seedCases } from './seeders/case.seeder';
   import { seedInvestigations } from './seeders/investigation.seeder';
   import { generateRepeatSubjects } from './seeders/patterns/repeat-subjects';
   import { generateManagerHotspots } from './seeders/patterns/manager-hotspots';
   import { generateRetaliationPatterns } from './seeders/patterns/retaliation';
   import { FLAGSHIP_CASES } from './seeders/patterns/flagship-cases';
   ```

2. After RIU seeding, generate patterns:
   ```typescript
   // Generate patterns for realistic data
   console.log('Generating data patterns...');
   const repeatSubjects = generateRepeatSubjects(employeeIds, 50);
   const managerHotspots = generateManagerHotspots(managerIds, 15);

   // Seed Cases with patterns
   const caseIds = await seedCases(
     prisma,
     organization.id,
     riuIds,
     userIds,
     employeeIds,
     categoryIds,
     {
       repeatSubjects,
       managerHotspots,
       retaliationChains: [], // Generated after initial cases
       flagshipCases: FLAGSHIP_CASES,
     },
   );
   console.log(`Created ${caseIds.length} Cases (target: 4,500)`);

   // Generate retaliation patterns from closed cases
   const closedCaseIds = caseIds.filter(/* closed status */);
   const retaliationChains = generateRetaliationPatterns(closedCaseIds, 50);

   // Get case data for investigation seeding
   const cases = await prisma.case.findMany({
     where: { organizationId: organization.id },
     select: {
       id: true,
       status: true,
       createdAt: true,
       primaryCategoryId: true,
       priority: true,
       // Pattern flags
       hasEscalation: true,
       hasExternalParty: true,
     },
   });

   // Seed Investigations with enhanced data
   await seedInvestigations(
     prisma,
     organization.id,
     cases.map(c => ({
       id: c.id,
       status: c.status,
       createdAt: c.createdAt,
       categoryId: c.primaryCategoryId || '',
       priority: c.priority,
       hasEscalation: c.hasEscalation || false,
       hasExternalParty: c.hasExternalParty || false,
     })),
     userIds,
   );
   console.log(`Created ~5,000 Investigations`);
   ```

3. Add dashboard metrics summary:
   ```typescript
   // Log demo-ready metrics
   console.log('\n=== Demo Metrics Summary ===');
   console.log(`Open Cases: ${openCaseCount} (~10%)`);
   console.log(`Closed Cases: ${closedCaseCount} (~90%)`);
   console.log(`Avg Case Duration: ${avgDuration} days (target: <22)`);
   console.log(`Substantiation Rate: ${substRate}% (target: ~60%)`);
   console.log(`Repeat Subjects: ${repeatSubjects.size}`);
   console.log(`Manager Hotspots: ${managerHotspots.length}`);
   console.log(`Flagship Cases: ${FLAGSHIP_CASES.length}`);
   console.log(`Recent Unread Cases: ${recentUnreadCount}`);
   ```

Seed order is now:
1. Organization
2. Categories
3. Employees (with manager hierarchy)
4. Users
5. RIUs (~5,000)
6. Pattern Generation (repeat subjects, hotspots)
7. Cases (4,500 with RIU associations and patterns)
8. Retaliation Pattern Injection
9. Investigations (~5,000 with regulatory, escalations)
10. Metrics Validation
  </action>
  <verify>
TypeScript check: `cd apps/backend && npx tsc --noEmit apps/backend/prisma/seed.ts`
  </verify>
  <done>
seed.ts orchestrates Case and Investigation seeding with pattern generation and demo metrics validation.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/backend && npx tsc --noEmit`
2. Case count: 4,500 Cases created (90% RIU-to-Case ratio)
3. Status distribution: ~10% open (~450), ~90% closed (~4050)
4. Priority pyramid: 2% critical, 8% high, 30% medium, 60% low
5. Case duration average under 22 days
6. RiuCaseAssociation records created for all cases
7. Investigation count: ~5,000 (most cases 1, some require additional)
8. Investigation outcome: ~60% substantiation rate
9. Pattern injection verified:
   - Repeat subjects appear in multiple cases
   - Manager hotspots have elevated case rates
   - Retaliation chains linked correctly
   - Flagship cases have curated content
10. AI enrichment populated (summaries, risk scores)
11. Fresh items exist (recent unread cases, pending approvals)
12. Timeline dates consistent (investigation dates after case creation)
</verification>

<success_criteria>
- 4,500 Cases with 10% open, 90% closed distribution
- Priority pyramid: few critical (~90), some high (~360), many medium (~1350), most low (~2700)
- Each Case linked to at least one RIU via RiuCaseAssociation
- ~5,000 Investigations created (including regulatory investigations)
- 60% substantiation rate on closed investigations
- Case duration aggregate average under 20-22 days
- 5-10 flagship named cases with rich narratives
- ~50 repeat subjects appearing in 2-5 cases each
- ~15 manager hotspots with elevated team case rates
- ~50 retaliation follow-up cases linked to originals
- ~5% of cases show CCO escalation
- ~4% of cases involve external parties (legal, law enforcement)
- ~10% of cases show mid-investigation reassignment
- Recent unread cases and pending approvals exist
- AI summaries and risk scores pre-populated
- Dashboard shows mix of good and problem metrics
</success_criteria>

<output>
After completion, create `.planning/phases/02-demo-tenant-seed-data/02-05-SUMMARY.md`
</output>
