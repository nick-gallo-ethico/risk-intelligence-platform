---
phase: 16-ai-integration-fix
plan: 05
type: execute
wave: 3
depends_on: [16-02]
files_modified:
  - apps/frontend/src/hooks/useAiActions.ts
  - apps/frontend/src/components/ai/ai-action-preview.tsx
  - apps/frontend/src/components/layout/ai-panel.tsx
autonomous: true

must_haves:
  truths:
    - "useAiActions hook provides preview and execute functions for AI actions (change-status, add-note)"
    - "AI action preview component shows what the action will do before execution (preview-then-execute pattern)"
    - "AI panel integrates action execution — AI can suggest and execute actions through the chat"
    - "Actions called via POST /ai/actions/:actionId/preview and POST /ai/actions/:actionId/execute"
  artifacts:
    - path: "apps/frontend/src/hooks/useAiActions.ts"
      provides: "AI action preview and execution"
      contains: "/ai/actions/"
    - path: "apps/frontend/src/components/ai/ai-action-preview.tsx"
      provides: "Preview dialog for AI actions before execution"
      contains: "preview"
  key_links:
    - from: "useAiActions.ts"
      to: "POST /api/v1/ai/actions/:actionId/preview"
      via: "apiClient.post for preview step"
      pattern: "/ai/actions/"
    - from: "useAiActions.ts"
      to: "POST /api/v1/ai/actions/:actionId/execute"
      via: "apiClient.post for execution step"
      pattern: "/ai/actions/"
---

<objective>
Create frontend components for AI actions (change-status, add-note) with the preview-then-execute pattern. Integrate action suggestions into the AI panel chat so AI can offer to modify case data.

Purpose: The backend action system is fully built (action catalog, executor, undo support) but has zero frontend integration. Users need to see what an AI action will do before it executes.
Output: Working action preview/execute flow, integrated into AI panel.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/16-ai-integration-fix/16-RESEARCH.md

Key files to read:
@apps/backend/src/modules/ai/actions/action.catalog.ts (registered actions)
@apps/backend/src/modules/ai/actions/action-executor.service.ts (preview/execute/undo API)
@apps/backend/src/modules/ai/actions/action.types.ts (ActionDefinition interface)
@apps/backend/src/modules/ai/actions/actions/add-note.action.ts
@apps/backend/src/modules/ai/actions/actions/change-status.action.ts
@apps/backend/src/modules/ai/ai.controller.ts (action endpoints)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useAiActions hook</name>
  <files>apps/frontend/src/hooks/useAiActions.ts</files>
  <action>
Create a hook for the preview-then-execute AI action pattern:

```typescript
import { useState, useCallback } from 'react';
import { apiClient } from '@/lib/api-client'; // match existing import

interface ActionPreview {
  actionId: string;
  description: string;
  changes: Array<{
    field: string;
    currentValue: any;
    newValue: any;
  }>;
  undoCategory: 'QUICK' | 'STANDARD' | 'SIGNIFICANT' | 'EXTENDED';
  undoWindowMs: number;
  canExecute: boolean;
  reason?: string; // if canExecute is false
}

interface ActionResult {
  success: boolean;
  actionRecordId: string; // for undo
  undoExpiresAt: string;
  changes: any;
}

interface UseAiActionsReturn {
  preview: (actionId: string, params: Record<string, any>) => Promise<ActionPreview | null>;
  execute: (actionId: string, params: Record<string, any>) => Promise<ActionResult | null>;
  undo: (actionRecordId: string) => Promise<boolean>;
  listActions: (entityType?: string) => Promise<any[]>;
  isLoading: boolean;
  error: string | null;
  currentPreview: ActionPreview | null;
  clearPreview: () => void;
}

export function useAiActions(): UseAiActionsReturn {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [currentPreview, setCurrentPreview] = useState<ActionPreview | null>(null);

  const listActions = useCallback(async (entityType?: string) => {
    try {
      const params = entityType ? `?entityType=${entityType}` : '';
      const response = await apiClient.get(`/ai/actions${params}`);
      return response.data?.actions || [];
    } catch {
      return [];
    }
  }, []);

  const preview = useCallback(async (actionId: string, params: Record<string, any>) => {
    setIsLoading(true);
    setError(null);
    try {
      const response = await apiClient.post(`/ai/actions/${actionId}/preview`, params);
      const data = response.data;
      if (data.success !== false) {
        setCurrentPreview(data);
        return data;
      } else {
        setError(data.error || 'Preview failed');
        return null;
      }
    } catch (err: any) {
      setError(err?.response?.data?.message || 'Action preview failed');
      return null;
    } finally {
      setIsLoading(false);
    }
  }, []);

  const execute = useCallback(async (actionId: string, params: Record<string, any>) => {
    setIsLoading(true);
    setError(null);
    try {
      const response = await apiClient.post(`/ai/actions/${actionId}/execute`, params);
      const data = response.data;
      setCurrentPreview(null);
      if (data.success) {
        return data;
      } else {
        setError(data.error || 'Action execution failed');
        return null;
      }
    } catch (err: any) {
      setError(err?.response?.data?.message || 'Action execution failed');
      return null;
    } finally {
      setIsLoading(false);
    }
  }, []);

  const undo = useCallback(async (actionRecordId: string) => {
    try {
      const response = await apiClient.post(`/ai/actions/${actionRecordId}/undo`);
      return response.data?.success || false;
    } catch {
      return false;
    }
  }, []);

  const clearPreview = useCallback(() => {
    setCurrentPreview(null);
    setError(null);
  }, []);

  return {
    preview, execute, undo, listActions,
    isLoading, error, currentPreview, clearPreview,
  };
}
```

Read the backend action controller endpoints to verify exact routes and payload shapes.
  </action>
  <verify>
TypeScript compiles. Hook provides preview, execute, undo functions.
  </verify>
  <done>
useAiActions hook created with preview-then-execute pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AI action preview dialog</name>
  <files>apps/frontend/src/components/ai/ai-action-preview.tsx</files>
  <action>
Create a confirmation dialog showing what an AI action will do before executing:

```typescript
import React from 'react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from '@/components/ui/alert-dialog';
import { Badge } from '@/components/ui/badge';
import { ArrowRight, Undo2 } from 'lucide-react';

interface ActionPreview {
  actionId: string;
  description: string;
  changes: Array<{
    field: string;
    currentValue: any;
    newValue: any;
  }>;
  undoCategory: string;
  undoWindowMs: number;
  canExecute: boolean;
  reason?: string;
}

interface AiActionPreviewProps {
  preview: ActionPreview;
  isOpen: boolean;
  isLoading: boolean;
  onConfirm: () => void;
  onCancel: () => void;
}

export function AiActionPreview({
  preview,
  isOpen,
  isLoading,
  onConfirm,
  onCancel,
}: AiActionPreviewProps) {
  const undoMinutes = Math.round(preview.undoWindowMs / 60000);

  return (
    <AlertDialog open={isOpen} onOpenChange={(open) => !open && onCancel()}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle className="flex items-center gap-2">
            AI Action Preview
            <Badge variant="outline">{preview.actionId}</Badge>
          </AlertDialogTitle>
          <AlertDialogDescription>{preview.description}</AlertDialogDescription>
        </AlertDialogHeader>

        <div className="space-y-3 my-4">
          <p className="text-sm font-medium">Changes:</p>
          {preview.changes.map((change, i) => (
            <div key={i} className="flex items-center gap-2 text-sm bg-muted rounded p-2">
              <span className="font-medium">{change.field}:</span>
              <span className="text-muted-foreground line-through">
                {String(change.currentValue || 'empty')}
              </span>
              <ArrowRight className="h-3 w-3" />
              <span className="font-medium text-primary">
                {String(change.newValue)}
              </span>
            </div>
          ))}

          <div className="flex items-center gap-2 text-xs text-muted-foreground">
            <Undo2 className="h-3 w-3" />
            Undo available for {undoMinutes} minute{undoMinutes !== 1 ? 's' : ''}
          </div>
        </div>

        {!preview.canExecute && (
          <p className="text-sm text-destructive">{preview.reason}</p>
        )}

        <AlertDialogFooter>
          <AlertDialogCancel onClick={onCancel}>Cancel</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            disabled={!preview.canExecute || isLoading}
          >
            {isLoading ? 'Executing...' : 'Execute'}
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

Use existing shadcn/ui AlertDialog component. Check if it's installed; if not, the standard Dialog component works too.
  </action>
  <verify>
Component exists and TypeScript compiles.
  </verify>
  <done>
AiActionPreview dialog shows what AI will change before executing, with undo information.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate action capabilities into AI panel</name>
  <files>apps/frontend/src/components/layout/ai-panel.tsx</files>
  <action>
Enhance the AI panel to support action execution inline within chat:

1. **Import useAiActions** and AiActionPreview.

2. **Add action state** to the panel:
```typescript
const { preview: previewAction, execute: executeAction, isLoading: actionLoading, currentPreview, clearPreview } = useAiActions();
const [showActionPreview, setShowActionPreview] = useState(false);
```

3. **Add quick action buttons** below the chat input for common actions when entity context is available:
```tsx
{entityType === 'case' && entityId && (
  <div className="flex gap-2 px-4 py-2 border-t">
    <Button variant="ghost" size="xs" onClick={() => handleQuickAction('summarize')}>
      Summarize
    </Button>
    <Button variant="ghost" size="xs" onClick={() => handleQuickAction('risk-score')}>
      Risk Score
    </Button>
  </div>
)}
```

4. **Implement handleQuickAction** that sends a predefined message:
```typescript
const handleQuickAction = (action: string) => {
  switch (action) {
    case 'summarize':
      sendMessage('Generate a summary of this case');
      break;
    case 'risk-score':
      sendMessage('What is the risk score for this case?');
      break;
  }
};
```

5. **Render AiActionPreview** when a preview is active:
```tsx
{currentPreview && (
  <AiActionPreview
    preview={currentPreview}
    isOpen={showActionPreview}
    isLoading={actionLoading}
    onConfirm={async () => {
      await executeAction(currentPreview.actionId, { /* params */ });
      setShowActionPreview(false);
    }}
    onCancel={() => {
      clearPreview();
      setShowActionPreview(false);
    }}
  />
)}
```
  </action>
  <verify>
AI panel renders quick action buttons and action preview dialog. TypeScript compiles.
  </verify>
  <done>
AI panel integrates action preview/execute flow with quick action buttons for common operations.
  </done>
</task>

</tasks>

<verification>
1. useAiActions.ts provides preview/execute/undo
2. AiActionPreview shows changes with before/after values
3. AI panel has quick action buttons when viewing a case
4. TypeScript compiles: `cd apps/frontend && npx tsc --noEmit`
</verification>

<success_criteria>
- AI actions use preview-then-execute pattern (user confirms before changes)
- Action preview shows field changes (current → new)
- Undo window information displayed
- Quick action buttons available in AI panel on case pages
- Actions integrate with existing backend action catalog
</success_criteria>

<output>
After completion, create `.planning/phases/16-ai-integration-fix/16-05-SUMMARY.md`
</output>
