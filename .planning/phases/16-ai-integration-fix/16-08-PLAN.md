---
phase: 16-ai-integration-fix
plan: 08
type: execute
wave: 3
depends_on: [16-01, 16-04, 16-06]
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Claude API calls succeed from the backend (ANTHROPIC_API_KEY configured and working)"
    - "AI panel opens on case detail page and accepts user queries"
    - "AI responds to natural language questions about case data within 5 seconds"
    - "AI can execute actions: update case status, add notes to activity feed"
    - "WebSocket /ai namespace connects successfully from frontend"
    - "AI conversations are persisted and can be resumed"
    - "AI features degrade gracefully when API key is missing"
    - "Backend skill registry has all 5 skills registered (note-cleanup, summarize, category-suggest, risk-score, translate)"
  artifacts: []
  key_links: []
---

<objective>
End-to-end verification of all Phase 16 success criteria. This plan validates that the AI system works correctly by running automated tests and performing human verification of the full AI flow.

Purpose: Ensure all 10 Phase 16 success criteria are met before marking the phase complete.
Output: Verification report documenting pass/fail status for each criterion.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md (Phase 16 success criteria)
@.planning/phases/16-ai-integration-fix/16-EXECUTION-NOTES.md
@apps/frontend/src/components/cases/ai-chat-panel.tsx
@apps/backend/src/modules/ai/ai.controller.ts
@apps/backend/src/modules/ai/ai.gateway.ts
@apps/backend/src/modules/ai/skills/skill.registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify backend API connectivity</name>
  <files></files>
  <action>
Run automated verification of backend AI endpoints:

1. **Check ANTHROPIC_API_KEY is configured**:

```bash
# In apps/backend, check if AI client reports configured
cd apps/backend && npx ts-node -e "
const { AiClientService } = require('./dist/modules/ai/services/ai-client.service');
const client = new AiClientService();
console.log('AI Configured:', client.isConfigured());
"
```

If the above doesn't work due to DI, check `.env` directly:

```bash
grep ANTHROPIC_API_KEY apps/backend/.env
```

2. **Verify REST chat endpoint exists**:

```bash
grep -n "@Post('chat')" apps/backend/src/modules/ai/ai.controller.ts
```

3. **Verify health check endpoint exists** (from 16-06 Task 1):

```bash
grep -n "@Get('health')" apps/backend/src/modules/ai/ai.controller.ts
```

4. **Verify WebSocket gateway exists**:

```bash
grep -n "@WebSocketGateway.*ai" apps/backend/src/modules/ai/ai.gateway.ts
```

5. **TypeScript compilation check**:

```bash
cd apps/backend && npx tsc --noEmit
```

Document results for each check.
</action>
<verify>
All grep commands return matches. TypeScript compiles. ANTHROPIC_API_KEY is set (even if empty placeholder for now).
</verify>
<done>
Backend AI infrastructure verified: REST endpoint, WebSocket gateway, health check (if added), and TypeScript compilation all pass.
</done>
</task>

<task type="auto">
  <name>Task 2: Verify frontend AI panel integration</name>
  <files></files>
  <action>
Run automated verification of frontend AI integration:

1. **Verify ai-chat-panel.tsx exists and is complete**:

```bash
wc -l apps/frontend/src/components/cases/ai-chat-panel.tsx
# Should be ~600+ lines
```

2. **Verify socket.io-client is installed**:

```bash
grep "socket.io-client" apps/frontend/package.json
```

3. **Verify case detail page imports AiChatPanel**:

```bash
grep -n "AiChatPanel" apps/frontend/src/app/\(authenticated\)/cases/\[id\]/page.tsx
```

4. **Verify Sheet overlay is configured**:

```bash
grep -n "Sheet.*aiPanelOpen" apps/frontend/src/app/\(authenticated\)/cases/\[id\]/page.tsx
```

5. **Verify WebSocket events are handled**:

```bash
grep -E "on\(.*text_delta|message_complete|tool_use|action_executed" apps/frontend/src/components/cases/ai-chat-panel.tsx
```

6. **TypeScript compilation check**:

```bash
cd apps/frontend && npx tsc --noEmit
```

Document results for each check.
</action>
<verify>
All checks pass. ai-chat-panel.tsx is 600+ lines. socket.io-client installed. Case page imports component. TypeScript compiles.
</verify>
<done>
Frontend AI integration verified: component exists, socket installed, case page wired, events handled, TypeScript passes.
</done>
</task>

<task type="auto">
  <name>Task 3: Verify AI actions work (change-status, add-note)</name>
  <files></files>
  <action>
Verify the AI action infrastructure:

1. **Verify change-status action exists**:

```bash
grep -rn "change-status\|changeStatus" apps/backend/src/modules/ai/actions/
```

2. **Verify add-note action exists** (may be named add-case-note):

```bash
grep -rn "add.*note\|addNote\|add-case-note" apps/backend/src/modules/ai/actions/
```

3. **Verify ActionCatalog registers actions**:

```bash
grep -n "registerAction\|this.actions" apps/backend/src/modules/ai/actions/action.catalog.ts
```

4. **Verify action schemas use Zod 4.x compatible format** (from Phase 15 fix):

```bash
grep -n "zodToJsonSchema" apps/backend/src/modules/ai/actions/
```

5. **Verify action_executed event is emitted**:

```bash
grep -n "action_executed" apps/backend/src/modules/ai/ai.gateway.ts
```

Document results.
</action>
<verify>
Actions exist, are registered, use compatible schema format, and emit events.
</verify>
<done>
AI action infrastructure verified: change-status and add-note actions registered and functional.
</done>
</task>

<task type="auto">
  <name>Task 4: Verify conversation persistence</name>
  <files></files>
  <action>
Verify AI conversations are persisted:

1. **Verify AiConversation model exists in Prisma**:

```bash
grep -n "model AiConversation" apps/backend/prisma/schema.prisma
grep -n "model AiMessage" apps/backend/prisma/schema.prisma
```

2. **Verify ConversationService exists**:

```bash
ls apps/backend/src/modules/ai/services/conversation.service.ts
```

3. **Verify conversation history API exists**:

```bash
grep -n "GET.*conversations\|@Get.*conversation" apps/backend/src/modules/ai/ai.controller.ts
```

4. **Verify frontend loads conversation history**:

```bash
grep -n "conversations\|fetchHistory" apps/frontend/src/components/cases/ai-chat-panel.tsx
```

Document results.
</action>
<verify>
Prisma models exist, ConversationService exists, API endpoints exist, frontend loads history.
</verify>
<done>
Conversation persistence verified: models, service, API, and frontend loading all in place.
</done>
</task>

<task type="auto">
  <name>Task 5: Verify AI skill backend execution (note-cleanup, category-suggest, risk-score)</name>
  <files></files>
  <action>
Verify that all 5 skills are registered and the skill execution infrastructure works:

1. **Verify skill registry has all 5 skills**:

```bash
# Check skill imports in registry
grep -n "import.*Skill\|Skill(" apps/backend/src/modules/ai/skills/skill.registry.ts
```

2. **Verify each skill file exists and has execute method**:

```bash
# note-cleanup skill
grep -n "execute\|id:" apps/backend/src/modules/ai/skills/platform/note-cleanup.skill.ts

# summarize skill
grep -n "execute\|id:" apps/backend/src/modules/ai/skills/platform/summarize.skill.ts

# category-suggest skill
grep -n "execute\|id:" apps/backend/src/modules/ai/skills/platform/category-suggest.skill.ts

# risk-score skill
grep -n "execute\|id:" apps/backend/src/modules/ai/skills/platform/risk-score.skill.ts

# translate skill
grep -n "execute\|id:" apps/backend/src/modules/ai/skills/platform/translate.skill.ts
```

3. **Verify skill execution endpoint exists**:

```bash
grep -n "skills.*execute\|executeSkill" apps/backend/src/modules/ai/ai.controller.ts
```

4. **Count registered skills in onModuleInit**:

```bash
grep -c "registerSkill" apps/backend/src/modules/ai/skills/skill.registry.ts
# Expected: 5
```

5. **Verify skill registry logs registration count**:

```bash
grep -n "Registered.*skills" apps/backend/src/modules/ai/skills/skill.registry.ts
```

Document results. All 5 skills should be: note-cleanup, summarize, category-suggest, risk-score, translate.
</action>
<verify>
All 5 skill files exist with execute methods. Skill registry imports and registers all 5. Execution endpoint exists.
</verify>
<done>
AI skill backend verified: note-cleanup, summarize, category-suggest, risk-score, and translate skills are all registered and executable.
</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
AI integration has been verified programmatically. Now human verification is needed to confirm the full end-to-end flow works in the running application.
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Start the backend: `cd apps/backend && npm run start:dev`
2. Start the frontend: `cd apps/frontend && npm run dev`
3. Log in as a demo user (e.g., admin@acme.com / AcmeDemo123!)
4. Navigate to a case detail page (e.g., /cases/[any-case-id])

**Verification Steps:**

**1. AI Panel Opens (Success Criterion #2)**

- Click the "AI" button in the action row
- Expected: Sheet slides out from right with AI Assistant header
- Pass/Fail: \_\_\_\_

**2. WebSocket Connects (Success Criterion #8)**

- Check the connection status badge in the AI panel header
- Expected: Shows "Connected" (green badge) within 3 seconds
- Pass/Fail: \_\_\_\_

**3. AI Responds to Questions (Success Criterion #3)**

- Type: "What is this case about?"
- Expected: AI responds with case summary within 5 seconds, text streams in real-time
- Pass/Fail: \_\_\_\_

**4. AI Executes Actions (Success Criterion #4)**

- Type: "Add a note saying 'Test note from AI verification'"
- Expected: AI confirms note was added, activity feed updates
- Pass/Fail: \_\_\_\_

**5. Note Cleanup Works (Success Criterion #5)**

- Find a case note with bullet points or messy formatting, OR ask AI: "Clean up this text: '- item 1 - item 2 - item 3'"
- Expected: AI converts to narrative prose or returns cleaned version
- Pass/Fail: \_\_\_\_

**6. Category Suggestion Works (Success Criterion #6)**

- If AiCategorySuggest component is visible during RIU intake, enter text and trigger suggestion
- OR ask AI: "What category would you suggest for a case about harassment in the workplace?"
- Expected: AI provides category recommendation with confidence
- Pass/Fail: \_\_\_\_

**7. Risk Scoring Works (Success Criterion #7)**

- If AiRiskScore component is visible on case detail, click to generate risk score
- OR ask AI: "What is the risk level for this case?"
- Expected: AI provides risk assessment (low/medium/high/critical) with factors
- Pass/Fail: \_\_\_\_

**8. Conversation Persists (Success Criterion #9)**

- Close the AI panel (click outside or X)
- Reopen the AI panel
- Expected: Previous messages are still visible
- Pass/Fail: \_\_\_\_

**9. Graceful Degradation (Success Criterion #10)**
To test this (optional, if safe to modify):

- Temporarily rename ANTHROPIC_API_KEY in .env
- Restart backend
- Open AI panel
- Expected: Shows "AI unavailable" or similar error, does not crash
- Pass/Fail: \_\_\_\_

**Overall Status:** \_\_\_\_

**Notes/Issues Found:**
</how-to-verify>
<resume-signal>
Type "verified" with pass/fail results, or describe issues found.
</resume-signal>
</task>

</tasks>

<verification>
1. Tasks 1-5 automated checks all pass
2. Human verification confirms functional end-to-end flow
3. All 10 Phase 16 success criteria addressed
</verification>

<success_criteria>
Phase 16 Success Criteria Mapping:

| #   | Criterion                     | Verification Method                   |
| --- | ----------------------------- | ------------------------------------- |
| 1   | Claude API calls succeed      | Task 1 - ANTHROPIC_API_KEY configured |
| 2   | AI panel opens on case detail | Human verify step 1                   |
| 3   | AI responds within 5 seconds  | Human verify step 3                   |
| 4   | AI executes actions           | Human verify step 4                   |
| 5   | Note cleanup works            | Task 5 + Human verify step 5          |
| 6   | Category suggestion works     | Task 5 + Human verify step 6          |
| 7   | Risk scoring works            | Task 5 + Human verify step 7          |
| 8   | WebSocket connects            | Human verify step 2                   |
| 9   | Conversations persist         | Human verify step 8                   |
| 10  | Graceful degradation          | Human verify step 9                   |

</success_criteria>

<output>
After completion, create `.planning/phases/16-ai-integration-fix/16-08-SUMMARY.md` with verification results.
Mark Phase 16 complete in ROADMAP.md if all criteria pass.
</output>
