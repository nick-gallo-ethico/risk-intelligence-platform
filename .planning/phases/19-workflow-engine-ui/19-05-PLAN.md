---
phase: 19-workflow-engine-ui
plan: 05
type: execute
wave: 3
depends_on: ["19-03", "19-04"]
files_modified:
  - apps/frontend/src/components/workflows/builder/property-panel.tsx
  - apps/frontend/src/components/workflows/builder/stage-properties.tsx
  - apps/frontend/src/components/workflows/builder/transition-properties.tsx
  - apps/frontend/src/components/workflows/builder/step-editor.tsx
  - apps/frontend/src/components/workflows/builder/workflow-toolbar.tsx
  - apps/frontend/src/components/workflows/builder/workflow-builder.tsx
  - apps/frontend/src/app/(authenticated)/settings/workflows/new/page.tsx
  - apps/frontend/src/app/(authenticated)/settings/workflows/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking a stage node opens the property panel on the right showing stage name, description, color, SLA days, isTerminal, and a list of steps"
    - "Clicking a transition edge opens the property panel showing label, allowed roles, requiresReason toggle, and conditions list"
    - "User can add/remove/edit steps within a stage from the property panel"
    - "Toolbar shows workflow name (editable), entity type badge, version indicator, Save and Publish buttons"
    - "Save button serializes canvas state to WorkflowTemplate format and calls updateTemplate API"
    - "Publish button warns about version-on-publish if active instances exist, then saves with isActive: true"
    - "/settings/workflows/new loads an empty builder with query params for entityType and name"
    - "/settings/workflows/:id loads the template from API and populates the builder canvas"
  artifacts:
    - path: "apps/frontend/src/components/workflows/builder/property-panel.tsx"
      provides: "Right panel that switches between stage and transition properties"
    - path: "apps/frontend/src/components/workflows/builder/stage-properties.tsx"
      provides: "Stage editing form with steps list"
    - path: "apps/frontend/src/components/workflows/builder/transition-properties.tsx"
      provides: "Transition editing form with conditions"
    - path: "apps/frontend/src/components/workflows/builder/step-editor.tsx"
      provides: "Step add/edit form within stage properties"
    - path: "apps/frontend/src/components/workflows/builder/workflow-toolbar.tsx"
      provides: "Top toolbar with name, save, publish"
    - path: "apps/frontend/src/app/(authenticated)/settings/workflows/new/page.tsx"
      provides: "Create workflow page route"
    - path: "apps/frontend/src/app/(authenticated)/settings/workflows/[id]/page.tsx"
      provides: "Edit workflow page route"
  key_links:
    - from: "property-panel.tsx"
      to: "use-workflow-builder.ts"
      via: "reads selectedNode/selectedEdge, calls update functions"
      pattern: "selectedNode|selectedEdge"
    - from: "workflow-toolbar.tsx"
      to: "services/workflows.ts"
      via: "save calls updateTemplate or createTemplate API"
      pattern: "workflowsApi\\.(updateTemplate|createTemplate)"
    - from: "[id]/page.tsx"
      to: "hooks/use-workflows.ts"
      via: "useWorkflowTemplate(id) loads template data"
      pattern: "useWorkflowTemplate"
---

<objective>
Build the property panels, toolbar, and page routes that complete the workflow builder into a fully functional create/edit experience.

Purpose: The canvas (Plan 04) handles visual layout; this plan adds the ability to configure stage/transition details, save changes to the backend, and wire the builder into proper page routes. Together with Plan 04, this delivers the complete workflow builder.

Output: Working create and edit pages for workflows with property editing, save/publish, and data persistence.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-engine-ui/19-RESEARCH.md
@.planning/phases/19-workflow-engine-ui/19-03-SUMMARY.md
@.planning/phases/19-workflow-engine-ui/19-04-SUMMARY.md

@apps/frontend/src/types/workflow.ts
@apps/frontend/src/services/workflows.ts
@apps/frontend/src/hooks/use-workflows.ts
@apps/frontend/src/components/workflows/builder/use-workflow-builder.ts
@apps/frontend/src/components/workflows/builder/workflow-builder.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create property panels and step editor</name>
  <files>
    apps/frontend/src/components/workflows/builder/property-panel.tsx
    apps/frontend/src/components/workflows/builder/stage-properties.tsx
    apps/frontend/src/components/workflows/builder/transition-properties.tsx
    apps/frontend/src/components/workflows/builder/step-editor.tsx
  </files>
  <action>
1. Create `property-panel.tsx`:
   - Accepts selectedNode, selectedEdge, onUpdateNode, onUpdateEdge from builder hook
   - If selectedNode: render StageProperties
   - If selectedEdge: render TransitionProperties
   - If neither: render placeholder "Select a stage or transition to view properties"
   - Right sidebar styling: 320px width, border-left, overflow-y-auto, padding

2. Create `stage-properties.tsx`:
   - Form fields (all update node.data.stage in real-time via onUpdateNode callback):
     - Name (text input)
     - Description (textarea)
     - Color picker (preset palette of 8 colors: blue, green, amber, red, purple, cyan, gray, pink)
     - SLA Days (number input, optional)
     - Is Terminal (switch toggle)
   - Steps section:
     - Header "Steps" with "Add Step" button
     - List of existing steps with: name, type badge (manual/automatic/approval/notification), edit button, delete button
     - Clicking "Add Step" or edit opens StepEditor inline (accordion-style expand)
   - Gates section (simplified):
     - Header "Gates" with "Add Gate" button
     - List of existing gates: type badge, config summary, delete button
     - Add Gate shows Select with gate types (required_fields, approval, condition, time) and a config JSON textarea (gates are advanced, JSON config is appropriate)

3. Create `step-editor.tsx`:
   - Inline expandable editor for a single WorkflowStep:
     - Name (text input)
     - Type (Select: manual, automatic, approval, notification)
     - Description (textarea, optional)
     - Is Optional (switch)
     - Timeout Hours (number input, optional)
     - On Timeout (Select: pause, skip, escalate - only shown if timeoutHours is set)
     - Assignee Strategy (Select for strategy type: specific_user, round_robin, least_loaded, manager_of, team_queue, skill_based, geographic - with a text input for the associated ID/field)
   - Save/Cancel buttons at bottom

4. Create `transition-properties.tsx`:
   - Form fields (update edge.data.transition via onUpdateEdge):
     - Label (text input)
     - Requires Reason (switch toggle)
     - Allowed Roles (multi-select checkboxes: SYSTEM_ADMIN, COMPLIANCE_OFFICER, POLICY_AUTHOR, POLICY_REVIEWER, DEPARTMENT_ADMIN)
   - Conditions section (simplified):
     - List of conditions with type badge and delete button
     - "Add Condition" opens a form: type select (field, approval, time, expression), config JSON textarea
   - Actions section: - List of actions with type badge and delete button - "Add Action" opens a form: type select (notification, assignment, field_update, webhook), config JSON textarea
     </action>
     <verify>Run `cd apps/frontend && npx tsc --noEmit`.</verify>
     <done>Property panels render when stage/transition selected. All fields update the builder state. Steps can be added, edited, and removed within stages.</done>
     </task>

<task type="auto">
  <name>Task 2: Create toolbar, wire builder, and create page routes</name>
  <files>
    apps/frontend/src/components/workflows/builder/workflow-toolbar.tsx
    apps/frontend/src/components/workflows/builder/workflow-builder.tsx
    apps/frontend/src/app/(authenticated)/settings/workflows/new/page.tsx
    apps/frontend/src/app/(authenticated)/settings/workflows/[id]/page.tsx
  </files>
  <action>
1. Create `workflow-toolbar.tsx`:
   - Horizontal bar at top of builder:
     - Back arrow button (navigate to /settings/workflows)
     - Workflow name (editable text input, inline edit with pencil icon)
     - Entity type badge (read-only, colored per type)
     - Version indicator: "v{version}" badge
     - If template has active instances: amber warning badge "N active instances"
     - Spacer (flex-1)
     - Save button (outline variant): serializes canvas to template format, calls updateTemplate or createTemplate. Shows "Saving..." state. Resets isDirty. Shows toast "Workflow saved".
     - Publish button (primary variant): If template has active instances, show AlertDialog "Publishing will create a new version. {N} active instances will continue on the current version. Continue?" On confirm: save with isActive: true. Show toast "Workflow published (v{N})".
     - Unsaved changes indicator (dot next to Save if isDirty)
   - Serialization logic (in toolbar or hook):
     - nodesToStages: extract stage data from each node, preserve display positions (map node.position to stage.display.sortOrder)
     - edgesToTransitions: extract transition data from each edge
     - Build UpdateWorkflowTemplateDto: { name, description, stages, transitions, initialStage (first stage by sortOrder), isActive }

2. Update `workflow-builder.tsx`:
   - Accept template prop (WorkflowTemplate | null for new)
   - Three-section layout: toolbar (fixed top) | main content (palette + canvas + property panel)
   - Wire property panel: pass selectedNode, selectedEdge from hook, update callbacks that modify node/edge data
   - On mount with template: call loadTemplate to populate canvas
   - Unsaved changes warning: beforeunload event if isDirty

3. Create `settings/workflows/new/page.tsx`:
   - Read query params: entityType, name (from create dialog navigation)
   - Render WorkflowBuilder with template=null
   - Pass entityType and name as initial values
   - On first save, createTemplate is called, then URL updates to /settings/workflows/:newId

4. Create `settings/workflows/[id]/page.tsx`:
   - Read route param: id
   - Use useWorkflowTemplate(id) to fetch template
   - Loading skeleton while fetching
   - Error state if template not found
   - Render WorkflowBuilder with loaded template
   - On save, updateTemplate is called (version-on-publish handled by backend)
     </action>
     <verify>
     Navigate to /settings/workflows/new. Builder loads with empty canvas.
     Create a template from list page, navigate to /settings/workflows/:id. Builder loads with template data.
     Add stages, connect them, save. Verify API call succeeds and data persists.
     Run `cd apps/frontend && npx tsc --noEmit`.
     </verify>
     <done>Complete workflow builder: create page, edit page, toolbar with save/publish, property panels for stage/transition editing, data round-trips to backend API.</done>
     </task>

</tasks>

<verification>
- Selecting a stage opens property panel with editable fields
- Selecting a transition opens property panel with label, roles, conditions
- Steps can be added/edited/removed within stages
- Save serializes canvas to API format and persists
- Publish warns about active instances and creates new version
- /settings/workflows/new creates new template
- /settings/workflows/:id loads and edits existing template
- TypeScript compiles
</verification>

<success_criteria>

- Workflow builder is a complete create/edit experience
- Users can visually design workflows, configure properties, and save them
- Version-on-publish pattern is communicated to the user with warnings
- Data round-trips: load template -> edit on canvas -> save -> reload shows same state
  </success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-engine-ui/19-05-SUMMARY.md`
</output>
