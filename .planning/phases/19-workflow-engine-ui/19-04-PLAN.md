---
phase: 19-workflow-engine-ui
plan: 04
type: execute
wave: 2
depends_on: ["19-02"]
files_modified:
  - apps/frontend/src/components/workflows/builder/workflow-canvas.tsx
  - apps/frontend/src/components/workflows/builder/stage-node.tsx
  - apps/frontend/src/components/workflows/builder/transition-edge.tsx
  - apps/frontend/src/components/workflows/builder/stage-palette.tsx
  - apps/frontend/src/components/workflows/builder/workflow-builder.tsx
  - apps/frontend/src/components/workflows/builder/use-workflow-builder.ts
autonomous: true

must_haves:
  truths:
    - "React Flow canvas renders workflow stages as custom nodes positioned in a top-to-bottom layout"
    - "Each stage node displays stage name, step count, terminal badge, and color indicator"
    - "Transition edges between stages display label text and animate on hover"
    - "User can drag new stages from the palette onto the canvas"
    - "User can connect stages by dragging from source handle to target handle, creating transitions"
    - "User can select a node or edge to highlight it (selection state managed)"
    - "User can delete selected nodes/edges with Delete key or toolbar button"
    - "Canvas has minimap, zoom controls, and fit-to-view button"
  artifacts:
    - path: "apps/frontend/src/components/workflows/builder/workflow-canvas.tsx"
      provides: "React Flow canvas with custom node/edge types, minimap, controls"
    - path: "apps/frontend/src/components/workflows/builder/stage-node.tsx"
      provides: "Custom React Flow node rendering stage info"
    - path: "apps/frontend/src/components/workflows/builder/transition-edge.tsx"
      provides: "Custom React Flow edge rendering transition labels"
    - path: "apps/frontend/src/components/workflows/builder/stage-palette.tsx"
      provides: "Draggable stage type palette sidebar"
    - path: "apps/frontend/src/components/workflows/builder/workflow-builder.tsx"
      provides: "Main builder layout composing canvas + palette"
    - path: "apps/frontend/src/components/workflows/builder/use-workflow-builder.ts"
      provides: "State management hook for builder (nodes, edges, selection, dirty state)"
  key_links:
    - from: "workflow-canvas.tsx"
      to: "@xyflow/react"
      via: "ReactFlow component with custom nodeTypes and edgeTypes"
      pattern: "import.*@xyflow/react"
    - from: "stage-palette.tsx"
      to: "workflow-canvas.tsx"
      via: "onDrop handler creates new node"
      pattern: "onDrop|onDragOver"
---

<objective>
Build the visual workflow builder canvas using @xyflow/react with custom stage nodes, transition edges, drag-from-palette to add stages, and connect-by-drag to create transitions.

Purpose: This is the core of the workflow builder â€” the visual canvas where users design workflows by placing stages and connecting them with transitions. This plan focuses on the canvas interaction layer; property panels and save/load are in Plans 05.

Output: Working React Flow canvas with custom stage nodes, labeled transition edges, drag-to-add from palette, minimap and zoom controls.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-engine-ui/19-RESEARCH.md
@.planning/phases/19-workflow-engine-ui/19-02-SUMMARY.md

@apps/frontend/src/types/workflow.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create custom stage node and transition edge components</name>
  <files>
    apps/frontend/src/components/workflows/builder/stage-node.tsx
    apps/frontend/src/components/workflows/builder/transition-edge.tsx
  </files>
  <action>
1. Create `stage-node.tsx` - Custom React Flow node:
   - Import { Handle, Position, type NodeProps } from '@xyflow/react'
   - Node data type: { stage: WorkflowStage, isInitial: boolean }
   - Render as a card (rounded border, shadow, min-width 200px, max-width 280px):
     - Top color bar (4px) using stage.display?.color or default blue
     - Stage name (bold, truncate if long)
     - If isInitial: small "Start" badge (green)
     - If stage.isTerminal: small "End" badge (red)
     - Step count: "{N} steps" in muted text
     - If stage.gates?.length: small lock icon with "{N} gates"
     - If stage.slaDays: small clock icon with "{N}d SLA"
   - Source Handle at bottom center (Position.Bottom)
   - Target Handle at top center (Position.Top)
   - Styling: selected state with blue ring (react-flow selected class), hover with slight shadow increase
   - Use Tailwind classes. The node should look clean and professional.

2. Create `transition-edge.tsx` - Custom React Flow edge:
   - Import { BaseEdge, EdgeLabelRenderer, getBezierPath, type EdgeProps } from '@xyflow/react'
   - Edge data type: { transition: WorkflowTransition }
   - Render: BaseEdge with bezier path, stroke color #94a3b8 (slate-400), stroke-width 2
   - Label: If transition.label exists, render it in EdgeLabelRenderer positioned at the midpoint
     - Label style: small pill badge with white background, border, text-xs
     - If transition.conditions?.length > 0: small filter icon next to label
     - If transition.requiresReason: small message icon
   - Selected state: stroke color #3b82f6 (blue-500), stroke-width 3
   - Animated dashed line on hover
     </action>
     <verify>Run `cd apps/frontend && npx tsc --noEmit` to verify components compile.</verify>
     <done>Custom stage node renders stage info with handles. Custom edge renders transition labels. Both handle selected/hover states.</done>
     </task>

<task type="auto">
  <name>Task 2: Create canvas, palette, state hook, and builder layout</name>
  <files>
    apps/frontend/src/components/workflows/builder/use-workflow-builder.ts
    apps/frontend/src/components/workflows/builder/stage-palette.tsx
    apps/frontend/src/components/workflows/builder/workflow-canvas.tsx
    apps/frontend/src/components/workflows/builder/workflow-builder.tsx
  </files>
  <action>
1. Create `use-workflow-builder.ts` - state management hook:
   - Manages React Flow nodes (Node[]) and edges (Edge[]) arrays
   - `stagesToNodes(stages, initialStage)` - converts WorkflowStage[] to React Flow Node[]. Position nodes in a vertical layout: y = index * 150, x = 0 (centered). Set node.data = { stage, isInitial: stage.id === initialStage }.
   - `transitionsToEdges(transitions)` - converts WorkflowTransition[] to React Flow Edge[]. Edge id = `${from}-${to}`, source = from, target = to, data = { transition }.
   - `nodesToStages(nodes)` - extract stage data from nodes back to WorkflowStage[]
   - `edgesToTransitions(edges)` - extract transition data from edges back to WorkflowTransition[]
   - `loadTemplate(template: WorkflowTemplate)` - calls stagesToNodes and transitionsToEdges
   - `addStage(name, type)` - creates new node with unique id (nanoid or uuid), default position at bottom of canvas
   - `removeSelected()` - removes selected nodes and edges, also removes any edges connected to removed nodes
   - `selectedNode` and `selectedEdge` state derived from nodes/edges selection
   - `isDirty` flag - set to true on any change, reset on save
   - onNodesChange, onEdgesChange, onConnect handlers from useNodesState/useEdgesState (React Flow)

2. Create `stage-palette.tsx` - left sidebar:
   - A list of draggable stage types:
     - "Standard Stage" (blue) - default stage
     - "Approval Gate" (amber) - stage with approval gate pre-configured
     - "Terminal Stage" (red) - stage with isTerminal: true
     - "Notification Stage" (green) - stage with a notification step pre-configured
   - Each item: icon + label, draggable (HTML5 drag, set dataTransfer with stage type JSON)
   - Instructions text at bottom: "Drag a stage onto the canvas to add it"
   - Clean sidebar styling matching the app's design

3. Create `workflow-canvas.tsx`:
   - Import ReactFlow, MiniMap, Controls, Background from '@xyflow/react'
   - Import '@xyflow/react/dist/style.css'
   - Register custom nodeTypes: { stage: StageNode }
   - Register custom edgeTypes: { transition: TransitionEdge }
   - defaultEdgeOptions: type 'transition', animated: false
   - onDragOver: preventDefault, set dropEffect = 'move'
   - onDrop: parse dataTransfer JSON, create new stage node at drop position using reactFlowInstance.screenToFlowPosition
   - onConnect: create new edge with type 'transition' and data { transition: { from, to, label: '', conditions: [], actions: [] } }
   - Keyboard: Delete key removes selected (call removeSelected from hook)
   - fitView on initial load
   - Background with dots pattern
   - MiniMap at bottom-right
   - Controls at bottom-left (zoom in, zoom out, fit view)
   - Props: accepts the builder hook state and handlers

4. Create `workflow-builder.tsx` - main layout:
   - Three-column layout: palette (240px left) | canvas (flex-1 center) | empty right panel placeholder (for Plan 05)
   - Renders StagePalette on left
   - Renders WorkflowCanvas in center
   - Right panel: empty div with "Select a stage or transition to view properties" placeholder text
   - Full height (calc(100vh - header height))
     </action>
     <verify>
     Run `cd apps/frontend && npx tsc --noEmit`.
     Import WorkflowBuilder in a test page and verify React Flow renders with minimap and controls.
     </verify>
     <done>Canvas renders React Flow with custom nodes/edges. Stages can be dragged from palette onto canvas. Connections can be made by dragging handles. Delete key removes selected elements. Minimap and controls visible.</done>
     </task>

</tasks>

<verification>
- React Flow canvas renders with background, minimap, controls
- Custom stage nodes show name, step count, SLA, terminal badges
- Custom edges show labels and condition indicators
- Drag from palette creates new stage on canvas
- Drag between handles creates transition edge
- Delete key removes selected items
- TypeScript compiles
</verification>

<success_criteria>

- Visual workflow builder canvas is interactive and responsive
- Users can visually construct workflow graphs by dragging stages and connecting them
- The builder is a standalone component that can be embedded in create/edit pages
  </success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-engine-ui/19-04-SUMMARY.md`
</output>
