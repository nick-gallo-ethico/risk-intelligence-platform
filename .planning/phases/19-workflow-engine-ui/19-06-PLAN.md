---
phase: 19-workflow-engine-ui
plan: 06
type: execute
wave: 3
depends_on: ["19-01", "19-02"]
files_modified:
  - apps/frontend/src/app/(authenticated)/settings/workflows/[id]/instances/page.tsx
  - apps/frontend/src/components/workflows/instance-list-table.tsx
  - apps/frontend/src/components/workflows/instance-detail-dialog.tsx
  - apps/frontend/src/components/workflows/workflow-progress-indicator.tsx
autonomous: true

must_haves:
  truths:
    - "User navigates to /settings/workflows/:id/instances and sees a table of all instances for that template"
    - "Instance table shows: Entity link, Current Stage, Status badge, SLA Status badge, Started date, Due Date"
    - "User can filter instances by status (Active, Completed, Cancelled, Paused)"
    - "Clicking an instance row opens a detail dialog showing step states, transitions history"
    - "Bulk actions: Pause selected, Resume selected, Cancel selected (with confirmation)"
    - "WorkflowProgressIndicator component renders a horizontal stage pipeline showing current position"
  artifacts:
    - path: "apps/frontend/src/app/(authenticated)/settings/workflows/[id]/instances/page.tsx"
      provides: "Workflow instances list page"
    - path: "apps/frontend/src/components/workflows/instance-list-table.tsx"
      provides: "Instances table with filters and bulk actions"
    - path: "apps/frontend/src/components/workflows/instance-detail-dialog.tsx"
      provides: "Instance detail dialog showing step states"
    - path: "apps/frontend/src/components/workflows/workflow-progress-indicator.tsx"
      provides: "Reusable horizontal stage progress bar"
  key_links:
    - from: "instances/page.tsx"
      to: "hooks/use-workflows.ts"
      via: "useWorkflowInstances and useWorkflowTemplate"
      pattern: "useWorkflowInstances|useWorkflowTemplate"
    - from: "workflow-progress-indicator.tsx"
      to: "types/workflow.ts"
      via: "WorkflowStage[] and currentStage props"
      pattern: "WorkflowStage.*currentStage"
---

<objective>
Build the workflow instances page and a reusable workflow progress indicator component.

Purpose: Admins need to see running workflow instances, their current state, and SLA status. They need to manage instances (pause, resume, cancel) in bulk. The progress indicator will be reused on case/policy detail pages to show workflow progress (Plan 07).

Output: Instances list page with table, filters, bulk actions, detail dialog, and a reusable progress indicator component.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-engine-ui/19-RESEARCH.md
@.planning/phases/19-workflow-engine-ui/19-02-SUMMARY.md

@apps/frontend/src/types/workflow.ts
@apps/frontend/src/services/workflows.ts
@apps/frontend/src/hooks/use-workflows.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create instances list page with table and bulk actions</name>
  <files>
    apps/frontend/src/app/(authenticated)/settings/workflows/[id]/instances/page.tsx
    apps/frontend/src/components/workflows/instance-list-table.tsx
  </files>
  <action>
1. Create `instances/page.tsx`:
   - Route param: id (template ID)
   - Use useWorkflowTemplate(id) to get template name and stage definitions
   - Page header: "{Template Name} - Instances" with back link to /settings/workflows
   - Status filter: All, Active, Completed, Cancelled, Paused (tabs or toggle group)
   - Render InstanceListTable with templateId and status filter

2. Create `instance-list-table.tsx`:
   - Props: templateId, statusFilter?, stages (WorkflowStage[] from template for display)
   - Uses useWorkflowInstances({ templateId, status: statusFilter })
   - Columns:
     - Entity: entityType badge + entityId (truncated UUID). If we can't resolve entity name, show ID.
     - Current Stage: stage name with color dot (match stage.display.color from template stages)
     - Status: Badge with color per status (Active=green, Completed=blue, Cancelled=gray, Paused=amber)
     - SLA Status: Badge (ON_TRACK=green, WARNING=amber, OVERDUE=red). Only shown if dueDate exists.
     - Started: relative date (formatDistanceToNow)
     - Due Date: formatted date or "-" if none
   - Row selection with checkboxes (react-table row selection)
   - Bulk actions bar (shown when rows selected):
     - "Pause Selected" (only enabled if selected instances are ACTIVE)
     - "Resume Selected" (only enabled if selected instances are PAUSED)
     - "Cancel Selected" with AlertDialog confirmation
     - Each bulk action iterates over selected instance IDs and calls the respective API
   - Row click opens InstanceDetailDialog
   - Pagination (page/limit from API response)
   - Loading skeleton, empty state "No workflow instances found"
     </action>
     <verify>
     Navigate to /settings/workflows/:id/instances. Table renders with instance data (may be empty for new templates - that's expected).
     Run `cd apps/frontend && npx tsc --noEmit`.
     </verify>
     <done>Instances page shows table with all columns, status filters narrow results, bulk actions (pause/resume/cancel) work with confirmation, row click opens detail.</done>
     </task>

<task type="auto">
  <name>Task 2: Create instance detail dialog and progress indicator</name>
  <files>
    apps/frontend/src/components/workflows/instance-detail-dialog.tsx
    apps/frontend/src/components/workflows/workflow-progress-indicator.tsx
  </files>
  <action>
1. Create `instance-detail-dialog.tsx`:
   - Dialog (shadcn Dialog) showing full instance details:
     - Header: Entity type + Entity ID, Status badge
     - WorkflowProgressIndicator showing stages with current highlighted
     - Step states section: Table or list of all steps from stepStates JSON:
       - Step name (derived from template stages), Status badge (pending/in_progress/completed/skipped/failed), Completed At (date), Completed By (user ID)
     - Metadata: Template name, Template version, Started by, Started at, Due date, SLA status, Outcome (if completed)
     - Actions:
       - If ACTIVE: Pause button, Cancel button (with reason input)
       - If PAUSED: Resume button, Cancel button
       - Transition button: Show allowed transitions (from useAllowedTransitions hook if needed, or just display current stage info)
   - Close button

2. Create `workflow-progress-indicator.tsx` - REUSABLE component:
   - Props: stages: WorkflowStage[], currentStage: string, completedStages?: string[]
   - Renders a horizontal pipeline:
     - Each stage as a circle/node connected by lines
     - Completed stages: filled circle (green check)
     - Current stage: highlighted circle (blue, pulsing or outlined)
     - Future stages: empty circle (gray)
     - Stage names below circles (truncated)
     - Stage color from display.color
   - Responsive: scrollable horizontally if many stages
   - Terminal stages marked with special indicator
   - This component will be imported in Plan 07 for case/policy detail pages
   - Compact variant prop: if true, render smaller (for embedding in cards)
     </action>
     <verify>
     Open instance detail dialog from table row click. Verify all fields render.
     Import WorkflowProgressIndicator in isolation and verify it renders correctly with test data.
     Run `cd apps/frontend && npx tsc --noEmit`.
     </verify>
     <done>Instance detail dialog shows full instance state with step progress. WorkflowProgressIndicator renders horizontal stage pipeline. Both handle edge cases (no steps, no due date, terminal stages).</done>
     </task>

</tasks>

<verification>
- /settings/workflows/:id/instances page renders with table, filters, bulk actions
- Instance detail dialog shows complete instance information
- WorkflowProgressIndicator visually shows stage progression
- Bulk pause/resume/cancel work with proper state validation
- TypeScript compiles
</verification>

<success_criteria>

- Admins can monitor all running instances for a given workflow template
- Instance management actions (pause, resume, cancel) available in bulk and individually
- Progress indicator is a reusable component ready for embedding in entity detail pages
  </success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-engine-ui/19-06-SUMMARY.md`
</output>
