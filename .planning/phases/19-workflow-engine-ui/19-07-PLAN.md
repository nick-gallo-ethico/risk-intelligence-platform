---
phase: 19-workflow-engine-ui
plan: 07
type: execute
wave: 4
depends_on: ["19-05", "19-06"]
files_modified:
  - apps/frontend/src/components/workflows/workflow-status-card.tsx
  - apps/frontend/src/components/cases/case-workflow-panel.tsx
  - apps/frontend/src/components/policies/policy-workflow-panel.tsx
  - apps/backend/prisma/seeds/acme-phase-19.ts
  - apps/backend/prisma/seeds/index.ts
autonomous: true

must_haves:
  truths:
    - "Case detail page shows a workflow status card with current stage, progress indicator, and allowed transitions"
    - "Policy detail page shows approval workflow status with stage progress when in PENDING_APPROVAL"
    - "Transition buttons on workflow status card allow advancing the workflow (with reason if required)"
    - "Acme Co. demo data includes at least 3 workflow templates: Case Investigation Pipeline, Policy Approval, Disclosure Review"
    - "Demo templates have realistic stages and transitions that match the entity types"
    - "At least 5 workflow instances exist in various states (active, completed, paused)"
  artifacts:
    - path: "apps/frontend/src/components/workflows/workflow-status-card.tsx"
      provides: "Reusable workflow status card with progress and transition actions"
    - path: "apps/frontend/src/components/cases/case-workflow-panel.tsx"
      provides: "Case-specific workflow panel for case detail page"
    - path: "apps/frontend/src/components/policies/policy-workflow-panel.tsx"
      provides: "Policy-specific workflow panel for policy detail page"
    - path: "apps/backend/prisma/seeds/acme-phase-19.ts"
      provides: "Demo seed data for workflow templates and instances"
  key_links:
    - from: "workflow-status-card.tsx"
      to: "workflow-progress-indicator.tsx"
      via: "renders progress indicator with stages and current stage"
      pattern: "WorkflowProgressIndicator"
    - from: "case-workflow-panel.tsx"
      to: "services/workflows.ts"
      via: "getInstanceByEntity(CASE, caseId) to load instance"
      pattern: "getInstanceByEntity.*CASE"
    - from: "acme-phase-19.ts"
      to: "/api/v1/workflows/templates"
      via: "creates templates and instances via Prisma"
      pattern: "prisma\\.workflowTemplate\\.create"
---

<objective>
Integrate workflow status into entity detail pages and seed demo data for Acme Co.

Purpose: Users need to see workflow progress on the entities they care about (cases, policies). The workflow status card shows current stage, progress, and allows transitions. Demo seed data makes the workflow system visible and testable during sales demos.

Output: Workflow status cards on case and policy detail pages, plus Acme Co. seed data with realistic workflow templates and instances.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-engine-ui/19-RESEARCH.md
@.planning/phases/19-workflow-engine-ui/19-05-SUMMARY.md
@.planning/phases/19-workflow-engine-ui/19-06-SUMMARY.md

@apps/frontend/src/types/workflow.ts
@apps/frontend/src/services/workflows.ts
@apps/frontend/src/hooks/use-workflows.ts
@apps/frontend/src/components/workflows/workflow-progress-indicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow status card and entity detail integrations</name>
  <files>
    apps/frontend/src/components/workflows/workflow-status-card.tsx
    apps/frontend/src/components/cases/case-workflow-panel.tsx
    apps/frontend/src/components/policies/policy-workflow-panel.tsx
  </files>
  <action>
1. Create `workflow-status-card.tsx` - reusable card:
   - Props: entityType: WorkflowEntityType, entityId: string
   - Fetches workflow instance via workflowsApi.getInstanceByEntity(entityType, entityId)
   - If no instance: render nothing (or a subtle "No workflow assigned" note if in a context where one is expected)
   - If instance exists:
     - Card with border, padding:
       - Header: "Workflow" with template name (derived from templateId - may need a separate fetch or accept as prop)
       - WorkflowProgressIndicator with compact=true, stages from template, currentStage from instance
       - Current stage details: stage name, SLA status badge (if dueDate), "Started {relative time}"
       - Status badge (ACTIVE/PAUSED/etc.)
       - If ACTIVE: "Allowed Transitions" section with buttons for each allowed next stage. Each button:
         - Label from transition label or "Move to {stageName}"
         - If transition.requiresReason: clicking opens a small dialog with reason textarea before executing
         - On click: calls workflowsApi.transitionInstance(instanceId, { toStage, reason })
         - Shows loading state during transition
         - On success: invalidate queries, show toast "Moved to {stageName}"
       - If PAUSED: "Resume" button
       - If COMPLETED: "Completed" with outcome text
   - Fetch template alongside instance to get stage names/colors. Use useWorkflowTemplate(instance.templateId).

2. Create `case-workflow-panel.tsx`:
   - Props: caseId: string
   - Simply renders <WorkflowStatusCard entityType="CASE" entityId={caseId} />
   - Find the case detail page and add this panel. Look for the case detail page component (likely in src/app/(authenticated)/cases/[id]/page.tsx or similar).
   - Add CaseWorkflowPanel to the case detail page in an appropriate location â€” likely in the sidebar or as a card below case info. Check the existing layout and place it where it fits naturally (e.g., in the right column if three-column layout exists, or as a new tab, or in the overview section).
   - If the case detail page is complex and heavily structured, just create the component and add a comment about where to integrate it. Do NOT refactor the case detail page layout.

3. Create `policy-workflow-panel.tsx`:
   - Props: policyId: string
   - Simply renders <WorkflowStatusCard entityType="POLICY" entityId={policyId} />
   - Find the policy detail page and add this panel. Similar placement considerations as case.
   - The policy detail page already shows an approval status card (10-09 decision). Replace or augment it with the WorkflowStatusCard which provides richer information.
     </action>
     <verify>
     Navigate to a case detail page. If the case has a workflow instance, the workflow status card should appear.
     Navigate to a policy in PENDING_APPROVAL status. Workflow progress should be visible.
     Run `cd apps/frontend && npx tsc --noEmit`.
     </verify>
     <done>Workflow status card renders on case and policy detail pages, showing progress and transition actions. Transitions can be executed from the card.</done>
     </task>

<task type="auto">
  <name>Task 2: Seed Acme Co. workflow templates and instances</name>
  <files>
    apps/backend/prisma/seeds/acme-phase-19.ts
    apps/backend/prisma/seeds/index.ts
  </files>
  <action>
1. Create `acme-phase-19.ts`:
   - Find the Acme Co. organization ID (look at existing seed files for the pattern, likely a fixed UUID or looked up by name)
   - Find the system admin user ID for createdById

Create 3 workflow templates:

a. **Case Investigation Pipeline** (entityType: CASE, isDefault: true): - Stages: New (initial) -> Triage -> Investigation -> Review -> Closed (terminal) - New: { id: 'new', name: 'New', steps: [{ id: 'assign', name: 'Assign Investigator', type: 'manual' }], display: { color: '#3b82f6', sortOrder: 0 } } - Triage: { id: 'triage', name: 'Triage', steps: [{ id: 'review-riu', name: 'Review RIU Details', type: 'manual' }, { id: 'categorize', name: 'Confirm Category', type: 'manual' }], display: { color: '#f59e0b', sortOrder: 1 } } - Investigation: { id: 'investigation', name: 'Investigation', steps: [{ id: 'gather-evidence', name: 'Gather Evidence', type: 'manual' }, { id: 'interview', name: 'Conduct Interviews', type: 'manual' }, { id: 'document-findings', name: 'Document Findings', type: 'manual' }], slaDays: 30, display: { color: '#8b5cf6', sortOrder: 2 } } - Review: { id: 'review', name: 'Review', steps: [{ id: 'manager-review', name: 'Manager Review', type: 'approval' }], gates: [{ type: 'approval', config: { requiredApprovals: 1 } }], display: { color: '#06b6d4', sortOrder: 3 } } - Closed: { id: 'closed', name: 'Closed', isTerminal: true, steps: [], display: { color: '#6b7280', sortOrder: 4 } } - Transitions: new->triage (label: "Start Triage"), triage->investigation (label: "Begin Investigation"), investigation->review (label: "Submit for Review"), review->closed (label: "Close Case"), review->investigation (label: "Return to Investigation", requiresReason: true), \*->closed (label: "Close", allowedRoles: ['SYSTEM_ADMIN'])

b. **Policy Approval Workflow** (entityType: POLICY, isDefault: true): - Stages: Draft (initial) -> Under Review -> Approved (terminal) -> Rejected (terminal) - Draft: { id: 'draft', name: 'Draft', steps: [{ id: 'submit', name: 'Submit for Review', type: 'manual' }], display: { color: '#3b82f6', sortOrder: 0 } } - Under Review: { id: 'under-review', name: 'Under Review', steps: [{ id: 'legal-review', name: 'Legal Review', type: 'approval' }, { id: 'compliance-review', name: 'Compliance Review', type: 'approval' }], slaDays: 14, gates: [{ type: 'approval', config: { requiredApprovals: 2 } }], display: { color: '#f59e0b', sortOrder: 1 } } - Approved: { id: 'approved', name: 'Approved', isTerminal: true, steps: [{ id: 'notify-publish', name: 'Notify & Publish', type: 'notification' }], display: { color: '#22c55e', sortOrder: 2 } } - Rejected: { id: 'rejected', name: 'Rejected', isTerminal: true, steps: [], display: { color: '#ef4444', sortOrder: 3 } } - Transitions: draft->under-review (label: "Submit"), under-review->approved (label: "Approve"), under-review->rejected (label: "Reject", requiresReason: true), under-review->draft (label: "Return to Draft", requiresReason: true)

c. **Disclosure Review** (entityType: DISCLOSURE, isDefault: true): - Stages: Submitted (initial) -> Under Review -> Approved (terminal) -> Flagged - Submitted: { id: 'submitted', name: 'Submitted', steps: [], display: { color: '#3b82f6', sortOrder: 0 } } - Under Review: { id: 'under-review', name: 'Under Review', steps: [{ id: 'conflict-check', name: 'Conflict Check', type: 'automatic' }, { id: 'threshold-check', name: 'Threshold Check', type: 'automatic' }, { id: 'reviewer-approval', name: 'Reviewer Approval', type: 'approval' }], slaDays: 7, display: { color: '#f59e0b', sortOrder: 1 } } - Approved: { id: 'approved', name: 'Approved', isTerminal: true, steps: [], display: { color: '#22c55e', sortOrder: 2 } } - Flagged: { id: 'flagged', name: 'Flagged for Investigation', steps: [{ id: 'create-case', name: 'Create Case', type: 'automatic' }], display: { color: '#ef4444', sortOrder: 3 } } - Transitions: submitted->under-review (label: "Start Review"), under-review->approved (label: "Approve"), under-review->flagged (label: "Flag for Investigation", requiresReason: true), flagged->under-review (label: "Return to Review")

Create 5-8 workflow instances:

- 3 ACTIVE instances (1 case at Investigation stage, 1 policy at Under Review, 1 disclosure at Under Review)
- 2 COMPLETED instances (1 case closed, 1 policy approved)
- 1 PAUSED instance (case investigation paused)
- Use realistic entity IDs from existing Acme seed data (lookup cases and policies created in earlier seeds)

2. Update `prisma/seeds/index.ts`:
   - Import and add acme-phase-19 seed to the seed execution order (after existing seeds)
   - Follow the existing import/execution pattern in the file
     </action>
     <verify>
     Run `cd apps/backend && npx ts-node prisma/seeds/acme-phase-19.ts` or the appropriate seed command to verify templates and instances are created without errors.
     Run `cd apps/backend && npx tsc --noEmit`.
     </verify>
     <done>3 workflow templates seeded for Acme Co. (Case, Policy, Disclosure). 5-8 instances in various states. Seed script is idempotent and integrated into seed index.</done>
     </task>

</tasks>

<verification>
- Case detail page shows workflow status card with progress indicator
- Policy detail page shows workflow status card when in approval
- Transition buttons execute workflow transitions via API
- 3 demo workflow templates visible in /settings/workflows list
- Demo instances visible in /settings/workflows/:id/instances
- Seed script runs without errors
- TypeScript compiles on both frontend and backend
</verification>

<success_criteria>

- Workflow execution is visible on entity detail pages (cases, policies)
- Users can advance workflows directly from the entity they're working on
- Demo data makes the workflow system immediately demonstrable
- All Phase 19 success criteria from ROADMAP.md are met
  </success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-engine-ui/19-07-SUMMARY.md`
</output>
