---
phase: 19-workflow-engine-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/backend/src/modules/workflow/workflow.controller.ts
  - apps/backend/src/modules/workflow/workflow.service.ts
  - apps/backend/src/modules/workflow/dto/index.ts
  - apps/backend/src/modules/workflow/dto/list-instances.dto.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/workflows/instances returns paginated list filtered by templateId, status, entityType"
    - "POST /api/v1/workflows/templates/:id/clone creates a copy with '(Copy)' appended to name"
    - "GET /api/v1/workflows/templates/:id/versions returns all versions of a template ordered by version desc"
    - "GET /api/v1/workflows/templates list response includes _instanceCount for each template"
  artifacts:
    - path: "apps/backend/src/modules/workflow/workflow.controller.ts"
      provides: "New REST endpoints for instances list, clone, version history"
    - path: "apps/backend/src/modules/workflow/workflow.service.ts"
      provides: "clone(), findVersions(), findAllWithCounts(), listInstances() methods"
    - path: "apps/backend/src/modules/workflow/dto/list-instances.dto.ts"
      provides: "ListInstancesDto with optional filters"
  key_links:
    - from: "workflow.controller.ts"
      to: "workflow.service.ts"
      via: "method calls"
      pattern: "this\\.workflowService\\.(clone|findVersions|listInstances)"
---

<objective>
Add missing backend API endpoints required by the Workflow Engine UI.

Purpose: The existing workflow backend (Phase 1) covers template CRUD and instance lifecycle but lacks endpoints the UI needs: listing all instances with filters, cloning templates, viewing version history, and getting instance counts on the template list. These are minor additions to existing services.

Output: 4 new API endpoints on the existing WorkflowController, with corresponding service methods.
</objective>

<execution_context>
@C:\Users\cu0718\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\cu0718\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-workflow-engine-ui/19-RESEARCH.md

@apps/backend/src/modules/workflow/workflow.controller.ts
@apps/backend/src/modules/workflow/workflow.service.ts
@apps/backend/src/modules/workflow/dto/index.ts
@apps/backend/src/modules/workflow/types/workflow.types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add list instances, clone, and version history endpoints</name>
  <files>
    apps/backend/src/modules/workflow/dto/list-instances.dto.ts
    apps/backend/src/modules/workflow/dto/index.ts
    apps/backend/src/modules/workflow/workflow.service.ts
    apps/backend/src/modules/workflow/workflow.controller.ts
  </files>
  <action>
1. Create `list-instances.dto.ts` with optional query params: templateId (UUID), status (WorkflowInstanceStatus), entityType (WorkflowEntityType), page (number, default 1), limit (number, default 20). Export from dto/index.ts.

2. Add to WorkflowService:
   - `listInstances(orgId, filters)` - Query WorkflowInstance with optional where clause (templateId, status, entityType), paginated, ordered by createdAt desc. Return { data, total, page, limit }.
   - `clone(orgId, templateId, userId)` - Find template by ID, create new template with same data but name = `${original.name} (Copy)`, version = 1, isActive = false, isDefault = false, sourceTemplateId = original.id.
   - `findVersions(orgId, templateId)` - Find the template, then query all templates with same name and organizationId, ordered by version desc. This works because version-on-publish creates new rows with same name.
   - `findAllWithCounts(orgId, options?)` - Same as findAll but adds a count of ACTIVE WorkflowInstances per template. Use Prisma's `_count` or a groupBy. Return templates with an added `_instanceCount` property.

3. Add to WorkflowController:
   - `GET /instances` - calls listInstances with query params. Roles: any authenticated user.
   - `POST /templates/:id/clone` - calls clone. Roles: SYSTEM_ADMIN, COMPLIANCE_OFFICER.
   - `GET /templates/:id/versions` - calls findVersions. Roles: any authenticated user.
   - Update `GET /templates` (listTemplates) to call findAllWithCounts instead of findAll, so response includes instance counts.

IMPORTANT: Place `GET /instances` BEFORE `GET /instances/:id` in the controller to prevent route conflict (NestJS matches top-to-bottom). Similarly, place `GET /templates/:id/versions` BEFORE `GET /templates/:id`.
</action>
<verify>
Run `cd apps/backend && npx tsc --noEmit` to verify TypeScript compilation.
Run `cd apps/backend && npm test -- --testPathPattern="workflow"` to verify existing tests still pass.
</verify>
<done>
Four new endpoints functional: GET /instances (list), POST /templates/:id/clone, GET /templates/:id/versions, and GET /templates (enriched with \_instanceCount). TypeScript compiles, existing tests pass.
</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Existing workflow tests pass
- New endpoints follow existing controller patterns (guards, decorators, error handling)
</verification>

<success_criteria>

- Backend has all endpoints the UI needs: template CRUD (existing), template clone (new), version history (new), instance list (new), instance count enrichment (new)
- No breaking changes to existing API contracts
  </success_criteria>

<output>
After completion, create `.planning/phases/19-workflow-engine-ui/19-01-SUMMARY.md`
</output>
